<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24å°æ—¶è´Ÿè·æ›²çº¿ç”Ÿæˆå·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // ==================== è°ƒè¯•å·¥å…·é…ç½® ====================
        // è°ƒè¯•æ¨¡å¼å¼€å…³ï¼Œè®¾ç½®ä¸ºtrueå¯å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡º
        const DEBUG_MODE = true;
        
        // è­¦å‘Šçº§åˆ«é…ç½®
        const WARNING_LEVEL = {
            LOW: 1,      // ä½çº§åˆ«è­¦å‘Šï¼Œä»…è®°å½•
            MEDIUM: 2,   // ä¸­çº§åˆ«è­¦å‘Šï¼Œè®°å½•å¹¶æ˜¾ç¤º
            HIGH: 3      // é«˜çº§åˆ«è­¦å‘Šï¼Œè®°å½•ã€æ˜¾ç¤ºå¹¶å¯èƒ½ä¸­æ–­æ“ä½œ
        };
        
        // å½“å‰è­¦å‘Šçº§åˆ«é˜ˆå€¼ï¼Œé«˜äºæ­¤çº§åˆ«çš„è­¦å‘Šå°†è¢«æ˜¾ç¤º
        const CURRENT_WARNING_THRESHOLD = WARNING_LEVEL.MEDIUM;
        
        /**
         * è°ƒè¯•æ—¥å¿—å‡½æ•°
         * @param {string} message - æ—¥å¿—æ¶ˆæ¯
         * @param {string} type - æ—¥å¿—ç±»å‹ï¼ˆlog, info, warn, errorï¼‰
         * @param {any} data - é™„åŠ æ•°æ®
         */
        function debugLog(message, type = 'log', data = null) {
            if (!DEBUG_MODE) return;
            
            const timestamp = new Date().toISOString();
            const prefix = `[DEBUG ${timestamp}]`;
            
            switch(type) {
                case 'info':
                    console.info(`${prefix} ${message}`, data || '');
                    break;
                case 'warn':
                    console.warn(`${prefix} ${message}`, data || '');
                    break;
                case 'error':
                    console.error(`${prefix} ${message}`, data || '');
                    break;
                default:
                    console.log(`${prefix} ${message}`, data || '');
            }
        }
        
        /**
         * æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
         * @param {string} message - è­¦å‘Šæ¶ˆæ¯
         * @param {number} level - è­¦å‘Šçº§åˆ«
         * @param {boolean} showToast - æ˜¯å¦æ˜¾ç¤ºæç¤ºæ¡†
         */
        function showWarning(message, level = WARNING_LEVEL.MEDIUM, showToast = true) {
            // è®°å½•è­¦å‘Šæ—¥å¿—
            debugLog(`WARNING [Level ${level}]: ${message}`, 'warn');
            
            // å¦‚æœè­¦å‘Šçº§åˆ«ä½äºå½“å‰é˜ˆå€¼ï¼Œä¸æ˜¾ç¤ºæç¤º
            if (level < CURRENT_WARNING_THRESHOLD) return;
            
            // æ˜¾ç¤ºè­¦å‘Šæç¤º
            if (showToast) {
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all-300 ${
                    level >= WARNING_LEVEL.HIGH ? 'bg-red-100 border border-red-400 text-red-700' : 
                    level >= WARNING_LEVEL.MEDIUM ? 'bg-yellow-100 border border-yellow-400 text-yellow-700' : 
                    'bg-blue-100 border border-blue-400 text-blue-700'
                }`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa ${
                            level >= WARNING_LEVEL.HIGH ? 'fa-exclamation-circle' : 
                            level >= WARNING_LEVEL.MEDIUM ? 'fa-exclamation-triangle' : 
                            'fa-info-circle'
                        } mr-2"></i>
                        <span>${message}</span>
                        <button class="ml-4 text-lg" onclick="this.parentElement.parentElement.remove()" aria-label="å…³é—­é€šçŸ¥">Ã—</button>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // 5ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 5000);
            }
        }
        
        /**
         * æ€§èƒ½ç›‘æ§å‡½æ•°
         * @param {string} label - æ€§èƒ½ç›‘æ§æ ‡ç­¾
         * @param {Function} fn - è¦æ‰§è¡Œçš„å‡½æ•°
         * @returns {any} å‡½æ•°æ‰§è¡Œç»“æœ
         */
        function monitorPerformance(label, fn) {
            if (!DEBUG_MODE) return fn();
            
            const startTime = performance.now();
            debugLog(`å¼€å§‹æ€§èƒ½ç›‘æ§: ${label}`, 'info');
            
            try {
                const result = fn();
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                debugLog(`æ€§èƒ½ç›‘æ§å®Œæˆ: ${label}, è€—æ—¶: ${duration.toFixed(2)}ms`, 'info');
                
                // å¦‚æœæ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºè­¦å‘Š
                if (duration > 1000) {
                    showWarning(`æ“ä½œè€—æ—¶è¾ƒé•¿: ${label} (${duration.toFixed(2)}ms)`, WARNING_LEVEL.MEDIUM);
                }
                
                return result;
            } catch (error) {
                const endTime = performance.now();
                const duration = endTime - startTime;
                debugLog(`æ€§èƒ½ç›‘æ§å‡ºé”™: ${label}, è€—æ—¶: ${duration.toFixed(2)}ms, é”™è¯¯: ${error.message}`, 'error', error);
                throw error;
            }
        }
        
        // ==================== Tailwind CSS é…ç½® ====================
        // Tailwind CSS è‡ªå®šä¹‰é…ç½®
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ä¼ä¸šçº§ä¸“ä¸šé…è‰²æ–¹æ¡ˆ
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            DEFAULT: '#0ea5e9'
                        },
                        secondary: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                            DEFAULT: '#14b8a6'
                        },
                        accent: {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7c3aed',
                            800: '#6b21a8',
                            900: '#581c87',
                            DEFAULT: '#a855f7'
                        },
                        neutral: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            DEFAULT: '#64748b'
                        },
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        light: '#f8fafc',
                        dark: '#0f172a'
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'monospace']
                    },
                    fontSize: {
                        'xs': ['0.75rem', { lineHeight: '1rem' }],
                        'sm': ['0.875rem', { lineHeight: '1.25rem' }],
                        'base': ['1rem', { lineHeight: '1.5rem' }],
                        'lg': ['1.125rem', { lineHeight: '1.75rem' }],
                        'xl': ['1.25rem', { lineHeight: '1.75rem' }],
                        '2xl': ['1.5rem', { lineHeight: '2rem' }],
                        '3xl': ['1.875rem', { lineHeight: '2.25rem' }],
                        '4xl': ['2.25rem', { lineHeight: '2.5rem' }]
                    },
                    spacing: {
                        '18': '4.5rem',
                        '88': '22rem',
                        '128': '32rem'
                    },
                    borderRadius: {
                        'xl': '0.75rem',
                        '2xl': '1rem',
                        '3xl': '1.5rem'
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'strong': '0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
            };
        }
    </script>
    <style type="text/tailwindcss">
        /* ==================== ç°ä»£åŒ–ä¼ä¸šçº§æ ·å¼ç³»ç»Ÿ ==================== */
        
        @layer utilities {
            /* æ€§èƒ½ä¼˜åŒ–å·¥å…·ç±» */
            .content-auto {
                content-visibility: auto;
                contain-intrinsic-size: 0 500px;
            }
            
            .gpu-accelerated {
                transform: translateZ(0);
                will-change: transform;
            }
            
            /* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            .scrollbar-thin {
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 #f1f5f9;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 3px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            
            /* ç°ä»£åŒ–é˜´å½±ç³»ç»Ÿ */
            .shadow-soft {
                box-shadow: 0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04);
            }
            
            .shadow-medium {
                box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            .shadow-strong {
                box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.05);
            }
            
            /* æ¸å˜èƒŒæ™¯ */
            .bg-gradient-primary {
                background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            }
            
            .bg-gradient-secondary {
                background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            }
            
            .bg-gradient-accent {
                background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            }
            
            .bg-gradient-surface {
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            }
            
            /* åŠ¨ç”»ç³»ç»Ÿ */
            .transition-smooth {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .transition-fast {
                transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .transition-slow {
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            /* å›¾è¡¨ä¸“ç”¨åŠ¨ç”» */
            .animate-fade-in {
                animation: fadeIn 0.4s ease-out;
            }
            
            .animate-slide-up {
                animation: slideUp 0.5s ease-out;
            }
            
            .animate-scale-in {
                animation: scaleIn 0.3s ease-out;
            }
            
            .animate-chart-load {
                animation: chartLoad 0.8s ease-out;
            }
            
            .animate-pulse-soft {
                animation: pulseSoft 2s ease-in-out infinite;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            @keyframes scaleIn {
                from { transform: scale(0.9); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            @keyframes chartLoad {
                0% { transform: scale(0.8) rotateY(-5deg); opacity: 0; }
                50% { transform: scale(1.02) rotateY(2deg); }
                100% { transform: scale(1) rotateY(0deg); opacity: 1; }
            }
            
            @keyframes pulseSoft {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            /* æ‚¬åœæ•ˆæœ */
            .hover-lift {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
            }
            
            /* ç»ç’ƒæ€æ•ˆæœ */
            .glass {
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .glass-dark {
                background: rgba(15, 23, 42, 0.8);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
        
        /* ==================== ç°ä»£åŒ–å›¾è¡¨å®¹å™¨æ ·å¼ ==================== */
        
        #chartContainer, #barChartContainer {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #chartContainer:hover, #barChartContainer:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        #chartContainer.loading {
            animation: pulseSoft 2s ease-in-out infinite;
        }
        
        #chartContainer canvas, #barChartContainer canvas {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0.5rem;
        }
        
        /* å›¾è¡¨åŠ è½½çŠ¶æ€ */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 1rem;
            border: 2px dashed #cbd5e1;
        }
        
        .chart-loading::before {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== ç°ä»£åŒ–æ•°æ®è¡¨æ ¼æ ·å¼ ==================== */
        
        #dataPreview {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(226, 232, 240, 0.6);
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            position: relative;
        }
        
        #dataPreview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #10b981);
            border-radius: 1rem 1rem 0 0;
        }
        
        #dataPreview table {
            border-collapse: separate;
            border-spacing: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 100%;
            background: transparent;
        }
        
        #dataPreview th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 700;
            color: #1e293b;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            padding: 1.25rem 1rem;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        #dataPreview th:first-child {
            border-top-left-radius: 0.75rem;
        }
        
        #dataPreview th:last-child {
            border-top-right-radius: 0.75rem;
        }
        
        #dataPreview td {
            font-size: 0.875rem;
            line-height: 1.5rem;
            padding: 1rem;
            border-bottom: 1px solid rgba(241, 245, 249, 0.8);
            border-right: 1px solid rgba(241, 245, 249, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 500;
            position: relative;
        }
        
        #dataPreview td:last-child {
            border-right: none;
        }
        
        #dataPreview tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        #dataPreview tbody tr::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        
        #dataPreview tbody tr:hover::before {
            width: 4px;
        }
        
        #dataPreview tbody tr:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(6, 182, 212, 0.03) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.08);
        }
        
        #dataPreview tbody tr:hover td {
            color: #1e293b;
            font-weight: 600;
        }
        
        #dataPreview tbody tr:nth-child(even) {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.4) 0%, rgba(241, 245, 249, 0.2) 100%);
        }
        
        #dataPreview tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(6, 182, 212, 0.03) 100%);
        }
        
        #dataPreview .selected-row {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(6, 182, 212, 0.08) 100%) !important;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }
        
        #dataPreview .selected-row td {
            color: #1e40af;
            font-weight: 600;
        }
        
        /* æ•°æ®é¢„è§ˆè¡¨æ ¼å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 1024px) {
            #dataPreview {
                border-radius: 0.75rem;
            }
            
            #dataPreview th {
                font-size: 0.75rem;
                padding: 1rem 0.75rem;
                letter-spacing: 0.025em;
            }
            
            #dataPreview td {
                font-size: 0.8rem;
                padding: 0.875rem 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            #dataPreview {
                border-radius: 0.5rem;
                margin: 0 -0.5rem;
            }
            
            #dataPreview::before {
                height: 3px;
            }
            
            #dataPreview th {
                font-size: 0.7rem;
                padding: 0.875rem 0.5rem;
                letter-spacing: 0.02em;
            }
            
            #dataPreview td {
                font-size: 0.75rem;
                padding: 0.75rem 0.5rem;
            }
            
            #dataPreview tbody tr:hover {
                transform: none;
            }
        }
        
        @media (max-width: 480px) {
            #dataPreview th,
            #dataPreview td {
                padding: 0.625rem 0.375rem;
                font-size: 0.8rem;
            }
        }
        
        /* ==================== å¯æŠ˜å é¢æ¿æ ·å¼ ==================== */
        
        /**
         * å¯æŠ˜å é¢æ¿æ ·å¼
         * ç¦ç”¨æ–‡æœ¬é€‰æ‹©ï¼Œæä¾›æ›´å¥½çš„äº¤äº’ä½“éªŒ
         */
        .toggle-panel {
            user-select: none;
        }
        
        /**
         * å¯æŠ˜å é¢æ¿æ‚¬åœæ•ˆæœ
         */
        .toggle-panel:hover {
            background-color: #e5e7eb;
        }
        
        /**
         * é¢æ¿å†…å®¹è¿‡æ¸¡åŠ¨ç”»
         */
        .panel-content {
            transition: all 0.3s ease;
        }
        
        /* ==================== æ–‡å­—å±…ä¸­æ ·å¼ ==================== */
        
        /**
         * æ–‡å­—å±…ä¸­æ ·å¼
         * ä½¿ç”¨flexboxå®ç°æ°´å¹³å’Œå‚ç›´å±…ä¸­
         */
        .text-center-div {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ==================== è¡¨å¤´å†»ç»“æ ·å¼ ==================== */
        
        /**
         * è¡¨å¤´å†»ç»“æ ·å¼
         * åœ¨æ»šåŠ¨æ—¶ä¿æŒè¡¨å¤´å¯è§
         */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* ==================== å¡ç‰‡æ ‡é¢˜æ æ ·å¼ ==================== */
        
        /**
         * å¡ç‰‡æ ‡é¢˜æ æ ·å¼
         * æä¾›ç»Ÿä¸€çš„å¡ç‰‡æ ‡é¢˜å¤–è§‚å’Œäº¤äº’æ•ˆæœ
         */
        .card-header {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 16px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /**
         * å¡ç‰‡æ ‡é¢˜æ æ‚¬åœæ•ˆæœ
         */
        .card-header:hover {
            background-color: #f3f4f6;
        }
        
        /**
         * å¡ç‰‡å†…å®¹æ ·å¼
         */
        .card-content {
            padding: 20px;
        }
        
        /* ==================== ä¸‹æ‹‰ç®­å¤´åŠ¨ç”» ==================== */
        
        /**
         * ä¸‹æ‹‰ç®­å¤´åŠ¨ç”»
         * ä¸ºæŠ˜å é¢æ¿çš„ç®­å¤´å›¾æ ‡æä¾›å¹³æ»‘çš„æ—‹è½¬åŠ¨ç”»
         */
        .fa-chevron-down {
            transition: transform 0.2s ease;
        }
        
        /* ==================== å“åº”å¼å±…ä¸­æ ·å¼ ==================== */
        
        /**
         * å“åº”å¼å±…ä¸­
         * åœ¨å°å±å¹•è®¾å¤‡ä¸Šè°ƒæ•´æ–‡å­—å±…ä¸­æ–¹å¼
         */
        @media (max-width: 768px) {
            .text-center-div {
                text-align: center;
                display: block;
            }
        }
        
        /* ==================== ç°ä»£åŒ–å¡ç‰‡ç»„ä»¶æ ·å¼ ==================== */
        
        .card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 1rem;
            box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .card:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(59, 130, 246, 0.1);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-content {
            color: #64748b;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        
        /* ç‰¹æ®Šå¡ç‰‡å˜ä½“ */
        .card-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-elevated {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        /* ==================== ç°ä»£åŒ–æŒ‰é’®ç»„ä»¶æ ·å¼ ==================== */
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px -8px rgba(14, 165, 233, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #075985 100%);
            box-shadow: 0 15px 35px -5px rgba(14, 165, 233, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px -5px rgba(14, 165, 233, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #475569;
            border: 1px solid rgba(203, 213, 225, 0.8);
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: rgba(14, 165, 233, 0.3);
            box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.1);
            color: #334155;
        }
        
        .btn-secondary:hover::before {
            left: 100%;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 50%, #be123c 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px -8px rgba(244, 63, 94, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-danger::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e11d48 0%, #be123c 50%, #9f1239 100%);
            box-shadow: 0 15px 35px -5px rgba(244, 63, 94, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-danger:hover::before {
            left: 100%;
        }
        
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px -5px rgba(244, 63, 94, 0.4);
        }
        
        /* æŒ‰é’®å°ºå¯¸å˜ä½“ */
        .btn-sm {
            padding: 0.625rem 1.5rem;
            font-size: 0.8rem;
            border-radius: 0.5rem;
        }
        
        .btn-lg {
            padding: 1rem 2.5rem;
            font-size: 1rem;
            border-radius: 1rem;
        }
        
        /* æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<!-- 
    ==================== HTMLæ–‡æ¡£ä¸»ä½“ ====================
    è´Ÿè·æ›²çº¿ç”Ÿæˆå·¥å…·çš„ä¸»ç•Œé¢ï¼ŒåŒ…å«è®¿é—®éªŒè¯ã€å¯¼èˆªæ å’Œä¸»è¦å†…å®¹åŒºåŸŸ
-->
<body class="bg-gray-50 font-sans text-dark">
    <!-- 
        ==================== ä½œè€…ä¿¡æ¯å¼¹çª— ====================
        è¿›å…¥ç½‘é¡µæ—¶æ˜¾ç¤ºçš„ä½œè€…ä¿¡æ¯å’Œæ¬¢è¿æç¤º
    -->
    <div id="authorInfoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl animate-scale-in">
            <div class="text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-lock text-white text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">è´Ÿè·æ›²çº¿åˆ†æå·¥å…·</h2>
                <p class="text-lg text-gray-600 mb-6">ä¸“ä¸šç”µåŠ›æ•°æ®åˆ†æå¹³å°</p>
                
                <!-- å¯†ç éªŒè¯åŒºåŸŸ -->
                <div id="passwordSection" class="mb-6">
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-6 mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ” è®¿é—®éªŒè¯</h3>
                        <p class="text-sm text-gray-600 mb-4">è¯·è¾“å…¥è®¿é—®å¯†ç ä»¥ç»§ç»­ä½¿ç”¨</p>
                        
                        <div class="space-y-4">
                            <div>
                                <input type="password" 
                                       id="accessPassword" 
                                       placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç " 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-center text-lg font-mono tracking-wider"
                                       maxlength="20">
                            </div>
                            
                            <button id="verifyPasswordBtn" 
                                    class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg hover:from-green-600 hover:to-blue-600 transition-all-300 font-medium text-lg">
                                <i class="fa fa-key mr-2"></i>éªŒè¯å¯†ç 
                            </button>
                            
                            <div id="passwordError" class="text-red-500 text-sm hidden">
                                <i class="fa fa-exclamation-circle mr-1"></i>
                                å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ä½œè€…ä¿¡æ¯åŒºåŸŸï¼ˆéªŒè¯æˆåŠŸåæ˜¾ç¤ºï¼‰ -->
                <div id="authorSection" class="hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">ğŸ‘¨â€ğŸ’» ä½œè€…ä¿¡æ¯</h3>
                        <div class="space-y-2 text-left">
                            <p><i class="fa fa-user-circle text-primary mr-2"></i><strong>ä½œè€…ï¼š</strong>å†¯ä¼Ÿæ˜</p>
                            <p><i class="fa fa-phone text-secondary mr-2"></i><strong>å¾®ä¿¡ï¼š</strong>Call13345934750</p>
                            <p><i class="fa fa-comments text-green-500 mr-2"></i><strong>å…¬ä¼—å·ï¼š</strong>èƒ½æºå°é²¨é±¼</p>
                            <p><i class="fa fa-envelope text-accent mr-2"></i><strong>é‚®ç®±ï¼š</strong>1847461355@qq.com</p>
                        <p><i class="fa fa-calendar text-warning mr-2"></i><strong>ç‰ˆæœ¬ï¼š</strong>v1.0.0</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-6">
                        <h4 class="text-lg font-semibold text-yellow-800 mb-2">ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                        <ul class="text-sm text-yellow-700 space-y-1 text-left">
                            <li>â€¢ æ”¯æŒExcelæ–‡ä»¶å¯¼å…¥ï¼Œæ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼</li>
                            <li>â€¢ å¯ç”Ÿæˆ24å°æ—¶è´Ÿè·æ›²çº¿å›¾å’ŒæŸ±çŠ¶å›¾</li>
                            <li>â€¢ æ”¯æŒæ•°æ®å¯¼å‡ºä¸ºExcelæ ¼å¼</li>
                            <li>â€¢ å¦‚æœ‰é—®é¢˜è¯·è”ç³»ä½œè€…å¾®ä¿¡</li>
                        </ul>
                    </div>
                    
                    <button id="startUsingBtn" 
                            class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-lg hover:from-primary/90 hover:to-secondary/90 transition-all-300 font-medium text-lg">
                        <i class="fa fa-rocket mr-2"></i>å¼€å§‹ä½¿ç”¨
                    </button>
                    
                    <p class="text-xs text-gray-500 mt-4">
                        <i class="fa fa-heart text-red-500 mr-1"></i>
                        æ„Ÿè°¢æ‚¨çš„ä¿¡ä»»ä¸æ”¯æŒï¼
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 
        ==================== é¡¶éƒ¨å¯¼èˆªæ  ====================
        æä¾›å·¥å…·çš„ä¸»è¦å¯¼èˆªåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€å¸®åŠ©å’Œå…³äºæŒ‰é’®
        ä½¿ç”¨stickyå®šä½ç¡®ä¿åœ¨é¡µé¢æ»šåŠ¨æ—¶å§‹ç»ˆå¯è§
    -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-slate-400 to-slate-500 rounded-full blur-sm opacity-20"></div>
                    <div class="relative bg-gradient-to-r from-slate-500 to-slate-600 p-3 rounded-full shadow-md">
                        <i class="fa fa-line-chart text-white text-xl"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-slate-700 to-slate-800 bg-clip-text text-transparent leading-tight">
                        24å°æ—¶è´Ÿè·æ›²çº¿ç”Ÿæˆå·¥å…·
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">ä¸“ä¸šç”µåŠ›æ•°æ®åˆ†æå¹³å°</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="helpBtn" class="text-neutral hover:text-primary transition-all-300 flex items-center" aria-label="å¸®åŠ©" title="å¸®åŠ©">
                    <i class="fa fa-question-circle mr-1"></i>
                    <span class="hidden md:inline">å¸®åŠ©</span>
                </button>
                <button id="aboutBtn" class="text-neutral hover:text-primary transition-all-300 flex items-center" aria-label="å…³äº" title="å…³äº">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span class="hidden md:inline">å…³äº</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 
        ==================== ä½¿ç”¨è¯´æ˜é¢æ¿ ====================
        æä¾›å·¥å…·çš„è¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼ŒåŒ…æ‹¬å¿«é€Ÿå¼€å§‹æŒ‡å—å’Œå„åŠŸèƒ½æ¨¡å—ä»‹ç»
        é»˜è®¤éšè—ï¼Œé€šè¿‡ç‚¹å‡»å¯¼èˆªæ çš„"å¸®åŠ©"æŒ‰é’®æ˜¾ç¤º
    -->
    <div id="helpPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">ğŸ“š ä½¿ç”¨è¯´æ˜</h2>
                    <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700" aria-label="å…³é—­å¸®åŠ©" title="å…³é—­å¸®åŠ©">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- å¿«é€Ÿå¼€å§‹æŒ‡å— -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-900 mb-3">
                            <i class="fa fa-rocket mr-2"></i>å¿«é€Ÿå¼€å§‹
                        </h3>
                        <ol class="list-decimal list-inside space-y-2 text-blue-800">
                            <li>ç‚¹å‡»å·¦ä¾§<strong>ã€æ•°æ®å¯¼å…¥ã€‘</strong>ä¸Šä¼ Excelæ–‡ä»¶</li>
                            <li>åœ¨<strong>ã€å›¾è¡¨é…ç½®ã€‘</strong>ä¸­è®¾ç½®å‚æ•°</li>
                            <li>æŸ¥çœ‹ç”Ÿæˆçš„è´Ÿè·æ›²çº¿å›¾è¡¨</li>
                            <li>ç‚¹å‡»<strong>ã€å¯¼å‡ºæ•°æ®ã€‘</strong>ä¿å­˜ç»“æœ</li>
                        </ol>
                    </div>



                    <!-- 
                        ==================== åŠŸèƒ½è¯´æ˜ ====================
                        è¯¦ç»†ä»‹ç»å·¥å…·çš„ä¸»è¦åŠŸèƒ½æ¨¡å—ï¼ŒåŒ…æ‹¬å›¾è¡¨åŠŸèƒ½å’Œé…ç½®é€‰é¡¹
                        ä½¿ç”¨ç½‘æ ¼å¸ƒå±€å±•ç¤ºåŠŸèƒ½åˆ†ç±»ï¼Œæé«˜å¯è¯»æ€§
                    -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fa fa-cogs mr-2 text-purple-600"></i>åŠŸèƒ½è¯´æ˜
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">ğŸ“Š å›¾è¡¨åŠŸèƒ½</h4>
                                <ul class="text-sm space-y-1 text-gray-600">
                                    <li>â€¢ 24å°æ—¶è´Ÿè·æ›²çº¿å›¾</li>
                                    <li>â€¢ æŸ±çŠ¶å›¾å¯¹æ¯”æ˜¾ç¤º</li>
                                    <li>â€¢ é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ•°å€¼</li>
                                    <li>â€¢ è‡ªåŠ¨ç¼©æ”¾å’Œè‡ªé€‚åº”</li>
                                </ul>
                            </div>
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">âš™ï¸ é…ç½®é€‰é¡¹</h4>
                                <ul class="text-sm space-y-1 text-gray-600">
                                    <li>â€¢ å›¾è¡¨æ ‡é¢˜è‡ªå®šä¹‰</li>
                                    <li>â€¢ é¢œè‰²ä¸»é¢˜é€‰æ‹©</li>
                                    <li>â€¢ æ•°æ®æ ‡ç­¾æ˜¾ç¤º</li>
                                    <li>â€¢ ç½‘æ ¼çº¿å¼€å…³</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 
                        ==================== è¯¦ç»†æ“ä½œæ­¥éª¤ ====================
                        æä¾›å·¥å…·ä½¿ç”¨çš„è¯¦ç»†æ­¥éª¤è¯´æ˜ï¼ŒåŒ…æ‹¬æ•°æ®å¯¼å…¥ã€é¢„è§ˆã€é…ç½®å’Œå¯¼å‡º
                        ä½¿ç”¨å·¦ä¾§è¾¹æ¡†å’Œé¢œè‰²ç¼–ç åŒºåˆ†ä¸åŒæ­¥éª¤ï¼Œæé«˜è§†è§‰å¼•å¯¼
                    -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fa fa-list-ol mr-2 text-orange-600"></i>è¯¦ç»†æ“ä½œæ­¥éª¤
                        </h3>
                        <div class="space-y-4">
                            <div class="border-l-4 border-blue-500 pl-4">
                                <h4 class="font-semibold">1. æ•°æ®å¯¼å…¥</h4>
                                <p class="text-sm text-gray-600">ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®ï¼Œé€‰æ‹©ç¬¦åˆæ ¼å¼çš„Excelæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£ææ•°æ®å¹¶æ˜¾ç¤ºé¢„è§ˆã€‚</p>
                            </div>
                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="font-semibold">2. æ•°æ®é¢„è§ˆ</h4>
                                <p class="text-sm text-gray-600">åœ¨æ•°æ®é¢„è§ˆåŒºåŸŸç¡®è®¤æ•°æ®æ­£ç¡®æ€§ï¼Œå¯æŸ¥çœ‹å‰100æ¡è®°å½•ã€‚</p>
                            </div>
                            <div class="border-l-4 border-purple-500 pl-4">
                                <h4 class="font-semibold">3. å›¾è¡¨é…ç½®</h4>
                                <p class="text-sm text-gray-600">è®¾ç½®å›¾è¡¨æ ‡é¢˜ã€é€‰æ‹©æ˜¾ç¤ºç±»å‹ï¼ˆæ›²çº¿å›¾/æŸ±çŠ¶å›¾ï¼‰ã€è°ƒæ•´é¢œè‰²ä¸»é¢˜ã€‚</p>
                            </div>
                            <div class="border-l-4 border-red-500 pl-4">
                                <h4 class="font-semibold">4. ç»“æœå¯¼å‡º</h4>
                                <p class="text-sm text-gray-600">ç‚¹å‡»"å¯¼å‡ºæ•°æ®"æŒ‰é’®ï¼Œå¯ä¸‹è½½Excelæ ¼å¼çš„åˆ†æç»“æœå’Œå›¾è¡¨ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- 
                        ==================== å¸¸è§é—®é¢˜ ====================
                        æä¾›ç”¨æˆ·å¯èƒ½é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ
                        ä½¿ç”¨ä¸åŒèƒŒæ™¯è‰²åŒºåˆ†é—®é¢˜ç±»å‹ï¼Œä¾¿äºå¿«é€Ÿå®šä½
                    -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fa fa-question-circle mr-2 text-red-600"></i>å¸¸è§é—®é¢˜
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-red-50 border-l-4 border-red-400 p-3 rounded">
                                <h4 class="font-semibold text-red-800">Q: æ–‡ä»¶ä¸Šä¼ å¤±è´¥æ€ä¹ˆåŠï¼Ÿ</h4>
                                <p class="text-sm text-red-700">A: æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿Excelæ–‡ä»¶åŒ…å«æ‰€éœ€çš„åˆ—åã€‚</p>
                            </div>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                                <h4 class="font-semibold text-yellow-800">Q: å›¾è¡¨æ˜¾ç¤ºå¼‚å¸¸ï¼Ÿ</h4>
                                <p class="text-sm text-yellow-700">A: åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½ï¼Œæˆ–æ£€æŸ¥æ•°æ®æ˜¯å¦åŒ…å«ç©ºå€¼æˆ–å¼‚å¸¸å€¼ã€‚</p>
                            </div>
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
                                <h4 class="font-semibold text-blue-800">Q: å¦‚ä½•è”ç³»æŠ€æœ¯æ”¯æŒï¼Ÿ</h4>
                                <p class="text-sm text-blue-700">A: é€šè¿‡å¾®ä¿¡<strong>Call13345934750</strong>è”ç³»ä½œè€…å†¯ä¼Ÿæ˜ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- 
                        ==================== ç‰ˆæœ¬ä¿¡æ¯ ====================
                        æä¾›å·¥å…·çš„ç‰ˆæœ¬ä¿¡æ¯ã€æ›´æ–°æ—¶é—´å’Œè”ç³»æ–¹å¼
                        ä½¿ç”¨ç°è‰²èƒŒæ™¯çªå‡ºæ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
                    -->
                    <div class="bg-gray-100 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            <i class="fa fa-info-circle mr-2"></i>ç‰ˆæœ¬ä¿¡æ¯
                        </h3>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p><strong>å½“å‰ç‰ˆæœ¬ï¼š</strong>v1.0.0 (åˆå§‹ç‰ˆæœ¬)</p>
                            <p><strong>æ›´æ–°æ—¶é—´ï¼š</strong>2025å¹´9æœˆ</p>
                            <p><strong>åŠŸèƒ½çŠ¶æ€ï¼š</strong>åŸºç¡€åŠŸèƒ½å®Œæ•´ï¼Œå¯èƒ½å­˜åœ¨BUG</p>
                            <p><strong>æŠ€æœ¯æ”¯æŒï¼š</strong>å†¯ä¼Ÿæ˜ (å¾®ä¿¡: Call13345934750)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 
        ==================== ä¸»å†…å®¹åŒºåŸŸ ====================
        åŒ…å«å·¥å…·çš„ä¸»è¦åŠŸèƒ½åŒºåŸŸï¼Œä½¿ç”¨å“åº”å¼å¸ƒå±€ç¡®ä¿åœ¨ä¸åŒè®¾å¤‡ä¸Šçš„è‰¯å¥½æ˜¾ç¤º
        ä¸»è¦åŒ…æ‹¬ï¼šæ­¥éª¤æŒ‡ç¤ºå™¨ã€æ–‡ä»¶å¯¼å…¥ã€æ•°æ®é…ç½®ã€å¯è§†åŒ–å’Œå¯¼å‡ºç»“æœç­‰åŠŸèƒ½æ¨¡å—
    -->
    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 
            ==================== å…¨æ–°æ­¥éª¤å¯¼èˆª ====================
            ç°ä»£åŒ–çš„æ­¥éª¤å¯¼èˆªè®¾è®¡ï¼Œä½¿ç”¨å¡ç‰‡å¼å¸ƒå±€å’Œæ¸å˜è‰²å½©
            åŒ…å«è¿›åº¦æ¡ã€å›¾æ ‡ã€æ–‡å­—è¯´æ˜ï¼Œæ”¯æŒçŠ¶æ€åˆ‡æ¢å’ŒåŠ¨ç”»æ•ˆæœ
        -->
        <div class="mb-8 bg-gradient-to-r from-white to-gray-50 rounded-2xl p-6 shadow-xl border border-gray-200/50">
            
            <!-- å¯¼èˆªå›¾æ ‡ç»„ -->
            <div class="flex justify-center items-center gap-8">
                <!-- å¯¼èˆª1ï¼šå¯¼å…¥æ•°æ® -->
                <div id="stepCard1" class="nav-icon-card active" data-step="1" onclick="scrollToSection('importSection')" title="ç‚¹å‡»è·³è½¬åˆ°æ•°æ®å¯¼å…¥">
                    <div class="nav-icon active">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <span class="nav-label">å¯¼å…¥æ•°æ®</span>
                    <div class="click-hint">ç‚¹å‡»è·³è½¬</div>
                </div>

                <!-- å¯¼èˆª2ï¼šæ•°æ®é…ç½® -->
                <div id="stepCard2" class="nav-icon-card" data-step="2" onclick="scrollToSection('configSection')" title="ç‚¹å‡»è·³è½¬åˆ°æ•°æ®é…ç½®">
                    <div class="nav-icon">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <span class="nav-label">æ•°æ®é…ç½®</span>
                    <div class="click-hint">ç‚¹å‡»è·³è½¬</div>
                </div>

                <!-- å¯¼èˆª3ï¼šå¯è§†åŒ– -->
                <div id="stepCard3" class="nav-icon-card" data-step="3" onclick="scrollToSection('visualizationSection')" title="ç‚¹å‡»è·³è½¬åˆ°å¯è§†åŒ–">
                    <div class="nav-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span class="nav-label">å¯è§†åŒ–</span>
                    <div class="click-hint">ç‚¹å‡»è·³è½¬</div>
                </div>

                <!-- å¯¼èˆª4ï¼šå¯¼å‡ºç»“æœ -->
                <div id="stepCard4" class="nav-icon-card" data-step="4" onclick="scrollToSection('exportSection')" title="ç‚¹å‡»è·³è½¬åˆ°å¯¼å‡ºç»“æœ">
                    <div class="nav-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <span class="nav-label">å¯¼å‡ºç»“æœ</span>
                    <div class="click-hint">ç‚¹å‡»è·³è½¬</div>
                </div>
            </div>
        </div>

        <!-- å¯¼èˆªå›¾æ ‡æ ·å¼ -->
        <style>
            /* å¯¼èˆªå›¾æ ‡å¡ç‰‡æ ·å¼ */
            .nav-icon-card {
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                border-radius: 0.75rem;
            }
            
            .nav-icon-card:hover {
                transform: translateY(-2px);
            }
            
            .nav-icon-card:hover .click-hint {
                opacity: 1;
                transform: translateY(0);
            }
            
            .nav-icon-card.active .nav-icon {
                background: linear-gradient(to bottom right, #3b82f6, #2563eb);
                color: white;
                box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.6);
            }
            
            .nav-icon-card.completed .nav-icon {
                background: linear-gradient(to bottom right, #10b981, #059669);
                color: white;
                box-shadow: 0 8px 25px -8px rgba(16, 185, 129, 0.6);
            }
            
            /* å¯¼èˆªå›¾æ ‡æ ·å¼ */
            .nav-icon {
                width: 3rem;
                height: 3rem;
                border-radius: 50%;
                background-color: #f3f4f6;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 0.5rem;
                transition: all 0.3s ease;
                color: #6b7280;
            }
            
            .nav-icon:hover {
                background-color: #e5e7eb;
                transform: scale(1.1);
            }
            
            .nav-icon i {
                font-size: 1.25rem;
            }
            
            /* å¯¼èˆªæ ‡ç­¾æ ·å¼ */
            .nav-label {
                font-size: 0.875rem;
                font-weight: 600;
                color: #374151;
                text-align: center;
                margin-bottom: 0.25rem;
            }
            
            .nav-icon-card.active .nav-label {
                color: #1d4ed8;
            }
            
            .nav-icon-card.completed .nav-label {
                color: #059669;
            }
            
            /* ç‚¹å‡»æç¤ºæ ·å¼ */
            .click-hint {
                font-size: 0.75rem;
                color: #9ca3af;
                opacity: 0;
                transform: translateY(5px);
                transition: all 0.3s ease;
                text-align: center;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 0.375rem;
                position: absolute;
                bottom: -2rem;
                white-space: nowrap;
                z-index: 10;
            }
            
            .click-hint::before {
                content: '';
                position: absolute;
                top: -4px;
                left: 50%;
                transform: translateX(-50%);
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-bottom: 4px solid rgba(0, 0, 0, 0.8);
            }
            
            /* å“åº”å¼è®¾è®¡ */
            @media (max-width: 640px) {
                .nav-icon-card {
                    padding: 0.75rem;
                }
                
                .nav-icon {
                    width: 2.5rem;
                    height: 2.5rem;
                }
                
                .nav-icon i {
                    font-size: 1rem;
                }
                
                .nav-label {
                    font-size: 0.75rem;
                }
            }
        </style>

        <!-- 
            ==================== ç¬¬ä¸€éƒ¨åˆ†ï¼šæ–‡ä»¶å¯¼å…¥ ====================
            æä¾›æ•°æ®å¯¼å…¥åŠŸèƒ½ï¼Œæ”¯æŒExcelæ–‡ä»¶ä¸Šä¼ å’Œé¢„è§ˆ
            ä½¿ç”¨å¡ç‰‡å¼å¸ƒå±€ï¼ŒåŒ…å«æ ‡é¢˜ã€æè¿°å’Œæ–‡ä»¶ä¸Šä¼ æ§ä»¶
        -->
        <section id="importSection" class="mb-6">
            <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100/50 hover:shadow-xl transition-all-300">
                <!-- æ ‡é¢˜åŒºåŸŸ -->
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-lg mr-4">
                        <i class="fa fa-upload text-white text-base"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">æ•°æ®å¯¼å…¥</h2>
                        <p class="text-sm text-gray-600 mt-1">æ™ºèƒ½è¯†åˆ«Excelæ ¼å¼ï¼Œä¸€é”®å¯¼å…¥å¹¶è‡ªåŠ¨åˆ†æ</p>
                    </div>
                </div>

                <!-- ä¸»å†…å®¹åŒºåŸŸ - ç½‘æ ¼å¸ƒå±€ -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- å·¦ä¾§ï¼šæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="lg:col-span-2">
                        <div class="bg-gradient-to-br from-gray-50 to-blue-50/30 rounded-xl p-6 border border-gray-200/50 h-full flex flex-col">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fa fa-cloud-upload-alt text-primary mr-2"></i>
                                æ–‡ä»¶ä¸Šä¼ 
                            </h3>
                            
                            <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
                            <div id="dropArea" class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary hover:bg-white/50 transition-all-300 cursor-pointer group flex-1 flex flex-col justify-center">
                                <div class="absolute inset-0 bg-gradient-to-br from-primary/5 to-blue-500/5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="relative z-10">
                                    <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-primary/20 to-blue-100 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                        <i class="fa fa-file-upload text-4xl text-primary"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-700 mb-2">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h4>
                                    <p class="text-gray-500 mb-4">æˆ– <span class="text-primary font-semibold">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></p>
                                    <div class="flex items-center justify-center space-x-4 text-sm text-gray-400">
                                        <span class="flex items-center">
                                            <i class="fa fa-file-excel text-green-600 mr-1"></i>
                                            Excel (.xlsx, .xls)
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fa fa-file-csv text-blue-600 mr-1"></i>
                                            CSV (.csv)
                                        </span>
                                    </div>
                                    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv" multiple="" aria-label="é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶ä¸Šä¼ ">
                                </div>
                            </div>

                            <!-- ä¸Šä¼ è¿›åº¦ -->
                            <div id="uploadProgress" class="hidden mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">ä¸Šä¼ è¿›åº¦</span>
                                    <span id="progressText" class="text-sm text-gray-500">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="progressBar" class="bg-gradient-to-r from-primary to-blue-600 h-2 rounded-full transition-all-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šæ•°æ®æ¦‚è§ˆåŒºåŸŸ -->
                    <div class="flex flex-col space-y-3 h-full">
                        <!-- æ–‡ä»¶ç»Ÿè®¡ -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50/50 rounded-xl p-3 border border-gray-200/50">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fa fa-chart-bar text-green-600 mr-2"></i>
                                æ•°æ®æ¦‚è§ˆ
                            </h4>
                            <div id="dataStats" class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">æ–‡ä»¶æ•°é‡</span>
                                    <span id="fileCount" class="text-sm font-semibold text-gray-800">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">æ—¶é—´èŒƒå›´</span>
                                    <span id="timeRange" class="text-sm font-semibold text-gray-800">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">è®¡é‡ç‚¹</span>
                                    <span id="meteringPoints" class="text-sm font-semibold text-gray-800">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- æ–‡ä»¶åˆ—è¡¨ - å›ºå®šå±•å¼€ -->
                        <div id="fileList" class="block">
                            <div class="bg-white rounded-xl border border-gray-200/50 p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-700">å·²å¯¼å…¥æ–‡ä»¶</h4>
                                    <button id="removeAllFiles" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 hidden">
                                        <i class="fa fa-trash mr-1"></i>æ¸…ç©º
                                    </button>
                                </div>
                                <ul id="importedFiles" class="space-y-1 text-sm max-h-40 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"></ul>
                            </div>
                        </div>

                        <!-- å¯¼å…¥å†å² -->
                        <div class="bg-white rounded-xl border border-gray-200/50 flex flex-col flex-1">
                            <div class="p-3 flex-1 flex flex-col">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-700">å¯¼å…¥å†å²</h4>
                                    <span class="text-xs text-gray-500">
                                        <i class="fa fa-history mr-1"></i>æœ€è¿‘è®°å½•
                                    </span>
                                </div>
                                <div id="importHistory" class="text-xs text-gray-500 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 flex-1">
                                    <div id="historyList">
                                        <p class="text-center py-2">æš‚æ— å†å²è®°å½•</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œåŒºåŸŸ -->
                <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-100">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">çŠ¶æ€:</span>
                        <span id="importStatus" class="text-sm font-medium text-gray-700">ç­‰å¾…æ–‡ä»¶ä¸Šä¼ </span>
                    </div>

                </div>
            </div>
        </section>

        <!-- 
            ==================== ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®é…ç½® ====================
            æä¾›æ•°æ®ç±»å‹ã€ç»“æ„ã€æ—¥æœŸå’Œåˆ—çš„é…ç½®é€‰é¡¹
            ä½¿ç”¨å¯æŠ˜å é¢æ¿ç»„ç»‡é…ç½®é¡¹ï¼Œæé«˜ç•Œé¢æ•´æ´åº¦
        -->
        <section id="configSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-100 hover:shadow-xl transition-all-300">

                
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fa fa-cogs text-primary mr-3"></i>æ•°æ®é…ç½®
                </h2>
                
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                    <!-- å·¦ä¾§é…ç½® -->
                    <div class="space-y-6">
                        <!-- 
                            ==================== æ•°æ®ç±»å‹é…ç½® ====================
                            é€‰æ‹©æ•°æ®ç±»å‹ï¼ˆç¬æ—¶åŠŸç‡æˆ–ç´¯ç§¯ç”µèƒ½ï¼‰ï¼Œå½±å“åç»­åˆ†æè®¡ç®—æ–¹å¼
                            ä½¿ç”¨è“è‰²ä¸»é¢˜å’Œæ­¥éª¤æ ‡è®°ï¼Œæä¾›è¯¦ç»†è¯´æ˜å’Œæç¤º
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="dataType">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-database mr-2 text-primary"></i>æ•°æ®ç±»å‹
                                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">æ­¥éª¤1</span>
                                </h3>
                                <div class="flex items-center space-x-2">
                                    <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                                </div>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="dataType-panel">
                                <div class="bg-blue-50 p-2 rounded-lg">
                                    <p class="text-xs text-blue-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        é€‰æ‹©æ­£ç¡®çš„æ•°æ®ç±»å‹å°†å½±å“åç»­çš„åˆ†æè®¡ç®—æ–¹å¼
                                    </p>
                                </div>
                                <div>
                                    <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200">
                                        <input type="radio" name="dataType" value="instantPower" class="form-radio text-primary w-4 h-4" checked>
                                        <div class="ml-3">
                                            <span class="text-xs font-medium text-gray-700">ç¬æ—¶åŠŸç‡</span>
                                            <p class="text-xs text-gray-500 mt-1">å®æ—¶åŠŸç‡å€¼ï¼Œå¦‚P(t)è¡¨ç¤ºtæ—¶åˆ»çš„åŠŸç‡</p>
                                        </div>
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200">
                                        <input type="radio" name="dataType" value="cumulativeEnergy" class="form-radio text-primary w-4 h-4">
                                        <div class="ml-3">
                                            <span class="text-xs font-medium text-gray-700">ç´¯ç§¯ç”µèƒ½</span>
                                            <p class="text-xs text-gray-500 mt-1">ç´¯è®¡ç”¨ç”µé‡ï¼Œå¦‚E(t)è¡¨ç¤ºtæ—¶åˆ»çš„æ€»ç”µèƒ½</p>
                                        </div>
                                    </label>
                                </div>
                                <div class="bg-blue-50 p-2 rounded-lg">
                                    <p class="text-xs text-blue-700">
                                        <i class="fa fa-lightbulb mr-1"></i>
                                        ç³»ç»Ÿä¼šæ ¹æ®æ•°æ®ç±»å‹è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„å¤„ç†ç®—æ³•
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== æ•°æ®ç»“æ„é…ç½® ====================
                            é€‰æ‹©æ•°æ®ç»“æ„ï¼ˆåˆ—å¯¹è¡Œæˆ–åˆ—å¯¹åˆ—ï¼‰ï¼Œæ ¹æ®Excelæ–‡ä»¶æ ¼å¼ç¡®å®š
                            ä½¿ç”¨ç»¿è‰²ä¸»é¢˜å’Œæ­¥éª¤æ ‡è®°ï¼Œæä¾›è¯¦ç»†è¯´æ˜å’Œæç¤º
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="dataStructure">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-table mr-2 text-primary"></i>æ•°æ®ç»“æ„
                                    <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">æ­¥éª¤2</span>
                                </h3>
                                <div class="flex items-center space-x-2">
                                    <i class="fa fa-question-circle text-gray-400 hover:text-green-500 cursor-help text-xs" 
                                       title="åˆ—å¯¹è¡Œï¼šæ—¥æœŸåœ¨ä¸€åˆ—ï¼Œæ•°æ®åœ¨å¤šåˆ—ï¼ˆæ¯åˆ—ä»£è¡¨ä¸€ä¸ªæ—¶é—´ç‚¹ï¼‰&#10;åˆ—å¯¹åˆ—ï¼šæ—¥æœŸåœ¨ä¸€åˆ—ï¼Œæ•°æ®åœ¨å¦ä¸€åˆ—ï¼ˆæ¯è¡Œä»£è¡¨ä¸€ä¸ªæ—¶é—´ç‚¹ï¼‰"></i>
                                    <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                                </div>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="dataStructure-panel">
                                <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                                    <input type="radio" name="dataStructure" value="columnToRow" class="form-radio text-primary w-4 h-4" checked>
                                    <div class="ml-3">
                                        <span class="text-xs font-medium text-gray-700">åˆ—å¯¹è¡Œï¼ˆæ—¥æœŸåˆ—å¯¹å¤šæ•°æ®åˆ—ï¼‰</span>
                                        <p class="text-xs text-gray-500 mt-1">é€‚åˆï¼šæ—¥æœŸåˆ— + å¤šä¸ªæ—¶é—´ç‚¹æ•°æ®åˆ—</p>
                                    </div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                                    <input type="radio" name="dataStructure" value="columnToColumn" class="form-radio text-primary w-4 h-4">
                                    <div class="ml-3">
                                        <span class="text-xs font-medium text-gray-700">åˆ—å¯¹åˆ—ï¼ˆæ—¥æœŸåˆ—å¯¹å•æ•°æ®åˆ—ï¼‰</span>
                                        <p class="text-xs text-gray-500 mt-1">é€‚åˆï¼šæ—¥æœŸåˆ— + å•ä¸ªæ•°æ®åˆ—</p>
                                    </div>
                                </label>
                                <div class="p-2 bg-green-50 rounded-md">
                                    <p class="text-xs text-green-700">
                                        <i class="fa fa-lightbulb mr-1"></i>
                                        æ ¹æ®æ‚¨çš„Excelæ–‡ä»¶æ ¼å¼é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 
                            ==================== æ—¥æœŸé…ç½® ====================
                            é€‰æ‹©åŒ…å«æ—¥æœŸçš„åˆ—ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«æ—¥æœŸæ ¼å¼
                            ä½¿ç”¨ç´«è‰²ä¸»é¢˜å’Œæ­¥éª¤æ ‡è®°ï¼Œæä¾›è¯¦ç»†è¯´æ˜å’Œæç¤º
                        -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="date">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-calendar mr-2 text-primary"></i>æ—¥æœŸé…ç½®
                                    <span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">æ­¥éª¤3</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="date-panel">
                                <div class="bg-purple-50 p-2 rounded-lg">
                                    <p class="text-xs text-purple-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        é€‰æ‹©åŒ…å«æ—¥æœŸçš„åˆ—ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«æ—¥æœŸæ ¼å¼
                                    </p>
                                </div>
                                <div>
                                    <label for="dateColumn" class="block text-sm font-semibold text-gray-700 mb-2">
                                        æ—¥æœŸæ‰€åœ¨åˆ— 
                                        <span class="text-xs text-gray-500 ml-1">(é€šå¸¸ä¸ºAåˆ—æˆ–ç¬¬ä¸€åˆ—)</span>
                                    </label>
                                    <select id="dateColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="æ—¥æœŸåˆ—" title="é€‰æ‹©æ—¥æœŸåˆ—">
                                        <option value="">-- è¯·é€‰æ‹©æ—¥æœŸåˆ— --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== åˆ—é…ç½® ====================
                            é€‰æ‹©åŒ…å«å®é™…æ•°æ®çš„åˆ—èŒƒå›´ï¼Œç³»ç»Ÿå°†æå–è¿™äº›åˆ—çš„æ•°å€¼è¿›è¡Œåˆ†æ
                            ä½¿ç”¨æ©™è‰²ä¸»é¢˜å’Œæ­¥éª¤æ ‡è®°ï¼Œæä¾›è¯¦ç»†è¯´æ˜å’Œæç¤º
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="columns">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-columns mr-2 text-primary"></i>ç”¨ç”µé…ç½®
                                    <span class="ml-2 px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">æ­¥éª¤4</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="columns-panel">
                                <div class="bg-orange-50 p-2 rounded-lg">
                                    <p class="text-xs text-orange-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        é€‰æ‹©åŒ…å«å®é™…æ•°æ®çš„åˆ—èŒƒå›´ï¼Œç³»ç»Ÿå°†æå–è¿™äº›åˆ—çš„æ•°å€¼è¿›è¡Œåˆ†æ
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-800 mb-2">
                                        æ•°æ®èµ·å§‹åˆ—
                                        <span class="text-sm text-gray-600 ml-1">(æ•°æ®å¼€å§‹çš„ç¬¬ä¸€åˆ—)</span>
                                    </label>
                                    <select id="dataStartColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="æ•°æ®èµ·å§‹åˆ—" title="é€‰æ‹©æ•°æ®èµ·å§‹åˆ—">
                                        <option value="">-- è¯·é€‰æ‹©èµ·å§‹åˆ— --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-800 mb-2">
                                        æ•°æ®ç»“æŸåˆ—
                                        <span class="text-sm text-gray-600 ml-1">(æ•°æ®ç»“æŸçš„æœ€ååˆ—)</span>
                                    </label>
                                    <select id="dataEndColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="æ•°æ®ç»“æŸåˆ—" title="é€‰æ‹©æ•°æ®ç»“æŸåˆ—">
                                        <option value="">-- è¯·é€‰æ‹©ç»“æŸåˆ— --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fa fa-lightbulb mr-1"></i>
                                        ç³»ç»Ÿå°†æå–ä»èµ·å§‹åˆ—åˆ°ç»“æŸåˆ—çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ä¸­é—´çš„æ‰€æœ‰åˆ—
                                    </p>
                                </div>
                                
                                <!-- 
                                    ==================== å€ç‡è®¾ç½® ====================
                                    æä¾›å›ºå®šå€ç‡å’Œå€ç‡åˆ—ä¸¤ç§æ–¹å¼ï¼Œç”¨äºè°ƒæ•´æ•°æ®è®¡ç®—ç»“æœ
                                    ä½¿ç”¨å¤é€‰æ¡†åˆ‡æ¢ä¸¤ç§æ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒæ•°æ®æ ¼å¼éœ€æ±‚
                                -->
                                <div class="border-t pt-3">
                                    <label class="block text-sm font-bold text-gray-800 mb-2">å€ç‡è®¾ç½®</label>
                                    <div class="space-y-3">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" id="useMultiplierColumn" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                            <label for="useMultiplierColumn" class="text-base font-medium text-gray-700">ä½¿ç”¨å€ç‡åˆ—</label>
                                        </div>
                                        
                                        <!-- å›ºå®šå€ç‡é€‰é¡¹ -->
                                        <div id="multiplierOptions" class="space-y-2">
                                            <label class="block text-sm font-semibold text-gray-700">å›ºå®šå€ç‡å€¼</label>
                                            <input type="number" id="multiplier" value="1.0" step="0.01" min="0.01" 
                                                   class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-base" aria-label="å›ºå®šå€ç‡å€¼" title="è¾“å…¥å›ºå®šå€ç‡å€¼ï¼Œæ‰€æœ‰è®¡ç®—ç»“æœå°†ä¹˜ä»¥è¯¥å€ç‡åå±•ç¤º">
                                            <p class="text-xs text-gray-500">æ‰€æœ‰è®¡ç®—ç»“æœå°†ä¹˜ä»¥è¯¥å€ç‡åå±•ç¤º</p>
                                        </div>
                                        
                                        <!-- å€ç‡åˆ—é€‰é¡¹ -->
                                        <div id="multiplierColumnOption" class="hidden space-y-2">
                                            <label for="multiplierColumn" class="block text-base font-bold text-gray-800">å€ç‡åˆ—</label>
                                            <select id="multiplierColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="å€ç‡åˆ—" title="é€‰æ‹©å€ç‡åˆ—">
                                                <option value="">-- è¯·é€‰æ‹©å€ç‡åˆ— --</option>
                                            </select>
                                            <p class="text-xs text-gray-500">è®¡ç®—ç»“æœå°†ä¹˜ä»¥è¯¥åˆ—å¯¹åº”çš„æ•°å€¼</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== é«˜çº§è®¾ç½® ====================
                            æä¾›è·¨æ—¥æœŸç»“æ„æ•°æ®å’Œè¿½åŠ æ¨¡å¼ç­‰é«˜çº§é€‰é¡¹
                            ä½¿ç”¨é›è“è‰²ä¸»é¢˜å’Œæ­¥éª¤æ ‡è®°ï¼Œæ»¡è¶³ç‰¹æ®Šæ•°æ®å¤„ç†éœ€æ±‚
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="advanced">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-sliders mr-2 text-primary"></i>é«˜çº§è®¾ç½®
                                    <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">æ­¥éª¤5</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="advanced-panel">
                                <!-- è·¨æ—¥æœŸç»“æ„æ•°æ®é€‰é¡¹ -->
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="crossDateStructure" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="ml-1 text-sm font-medium text-gray-700">è·¨æ—¥æœŸç»“æ„æ•°æ®</span>
                                    </label>
                                    <p class="text-sm text-gray-500 mt-1">å¯ç”¨åï¼Œå°†æ ¹æ®æ—¥æœŸåˆ—ä¸­ç›¸åŒæ—¥æœŸå¯¹åº”çš„å•å…ƒæ ¼æ•°é‡åˆ¤æ–­æ—¶é—´é—´éš”</p>
                                </div>
                                
                                <!-- è¿½åŠ æ¨¡å¼é€‰é¡¹ -->
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="appendMode" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="ml-1 text-sm font-medium text-gray-700">è¿½åŠ æ¨¡å¼ï¼ˆä¿ç•™å·²å¯¼å…¥çš„æ•°æ®ï¼‰</span>
                                    </label>
                                    <p class="text-sm text-gray-500 mt-1">å¯ç”¨åï¼Œæ–°å¯¼å…¥çš„æ•°æ®å°†è¿½åŠ åˆ°ç°æœ‰æ•°æ®ä¸­ï¼Œä¸ä¼šæ¸…é™¤ä¹‹å‰çš„æ•°æ®</p>
                                </div>
                            </div>
                        </div>
                        

                        
                        
                        
                        <!-- 
                            ==================== ç­›é€‰é…ç½® ====================
                            æä¾›è®¡é‡ç‚¹ç¼–å·ç­›é€‰å’Œé«˜çº§ç­›é€‰é¡¹è®¾ç½®åŠŸèƒ½
                            ä½¿ç”¨çº¢è‰²ä¸»é¢˜å’Œæ­¥éª¤æ ‡è®°ï¼Œæ»¡è¶³æ•°æ®ç­›é€‰éœ€æ±‚
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="filter">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-filter mr-2 text-primary"></i>ç­›é€‰é…ç½®
                                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">æ­¥éª¤6</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="filter-panel">
                                <!-- ç­›é€‰é…ç½®è¯´æ˜ -->
                                <div class="bg-red-50 p-2 rounded-lg">
                                    <p class="text-xs text-red-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        å¯é€‰æ­¥éª¤ï¼šæ ¹æ®è®¡é‡ç‚¹ç¼–å·æˆ–å…¶ä»–æ¡ä»¶ç­›é€‰æ•°æ®ï¼Œå¦‚æœä¸éœ€è¦ç­›é€‰å¯è·³è¿‡
                                    </p>
                                </div>
                                
                                <!-- è®¡é‡ç‚¹ç¼–å·æ‰€åœ¨åˆ—é€‰æ‹© -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="meteringPointColumn" class="block text-sm font-semibold text-gray-800">
                                            è®¡é‡ç‚¹ç¼–å·æ‰€åœ¨åˆ—
                                            <span class="text-xs text-gray-600 ml-1">(å¯é€‰)</span>
                                        </label>
                                        <input type="button" id="clearMeteringPointColumn" value="Ã—" class="w-6 h-6 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all-300 cursor-pointer flex items-center justify-center" aria-label="æ¸…é™¤è®¡é‡ç‚¹åˆ—é€‰æ‹©" title="æ¸…é™¤è®¡é‡ç‚¹åˆ—é€‰æ‹©">
                                    </div>
                                    <select id="meteringPointColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="è®¡é‡ç‚¹åˆ—" title="é€‰æ‹©è®¡é‡ç‚¹åˆ—">
                                        <option value="">-- è¯·é€‰æ‹©è®¡é‡ç‚¹åˆ— --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">é€‰æ‹©åŒ…å«è®¡é‡ç‚¹ç¼–å·ä¿¡æ¯çš„åˆ—ï¼Œç”¨äºæŒ‰è®¡é‡ç‚¹ç­›é€‰æ•°æ®</p>
                                </div>
                                
                                <!-- è®¡é‡ç‚¹ç¼–å·ç­›é€‰ -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="meteringPointFilter" class="block text-sm font-semibold text-gray-800">
                                            è®¡é‡ç‚¹ç¼–å·ç­›é€‰
                                            <span class="text-xs text-gray-600 ml-1">(å¯é€‰)</span>
                                        </label>
                                        <input type="button" id="clearMeteringPointFilter" value="Ã—" class="w-6 h-6 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all-300 cursor-pointer flex items-center justify-center" aria-label="æ¸…é™¤è®¡é‡ç‚¹ç­›é€‰" title="æ¸…é™¤è®¡é‡ç‚¹ç­›é€‰">
                                    </div>
                                    <select id="meteringPointFilter" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="è®¡é‡ç‚¹ç­›é€‰" title="é€‰æ‹©è®¡é‡ç‚¹ç­›é€‰">
                                        <option value="">-- å…¨éƒ¨è®¡é‡ç‚¹ --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">é€‰æ‹©è¦å¤„ç†çš„è®¡é‡ç‚¹ç¼–å·ï¼Œä»…å¤„ç†ä¸æ‰€é€‰è®¡é‡ç‚¹ç¼–å·åŒ¹é…çš„æ•°æ®</p>
                                </div>
                                
                                <!-- é«˜çº§ç­›é€‰é¡¹è®¾ç½® -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-semibold text-gray-800">é«˜çº§ç­›é€‰é¡¹è®¾ç½®</label>
                                        <input type="button" id="clearAllFilters" value="Ã—" class="w-6 h-6 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all-300 cursor-pointer flex items-center justify-center" aria-label="æ¸…é™¤æ‰€æœ‰ç­›é€‰é¡¹" title="æ¸…é™¤æ‰€æœ‰ç­›é€‰é¡¹">
                                    </div>
                                    <div class="flex items-center space-x-2 mb-2">
                                        <label for="filterCount" class="text-xs font-medium text-gray-600">ç­›é€‰é¡¹æ•°é‡ï¼š</label>
                                        <input type="number" id="filterCount" value="1" min="1" max="5" class="w-16 px-3 py-2 border border-gray-200 rounded-lg text-xs bg-white" aria-label="ç­›é€‰é¡¹æ•°é‡" title="ç­›é€‰é¡¹æ•°é‡">
                                        <input type="button" id="applyFilterCount" value="âœ“" class="w-6 h-6 text-xs bg-primary text-white rounded-full hover:bg-primary/90 cursor-pointer flex items-center justify-center" aria-label="åº”ç”¨ç­›é€‰é¡¹æ•°é‡" title="åº”ç”¨ç­›é€‰é¡¹æ•°é‡">
                                    </div>
                                    <div id="filterOptionsContainer" class="space-y-2">
                                        <!-- ç­›é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                                
                                <!-- å®Œæˆæç¤º -->
                                <div class="bg-green-50 p-2 rounded-lg">
                                    <p class="text-xs text-green-700">
                                        <i class="fa fa-check-circle mr-1"></i>
                                        å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œç‚¹å‡»"ä¸‹ä¸€æ­¥ï¼šå¯è§†åŒ–"æŒ‰é’®å¼€å§‹æ•°æ®åˆ†æå’Œå¯è§†åŒ–
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== å³ä¾§é…ç½® ====================
                        åŒ…å«æ•°æ®ç´¢å¼•èŒƒå›´ã€å¤„ç†é…ç½®å’Œæ•°æ®é¢„è§ˆç­‰é…ç½®é€‰é¡¹
                        ä½¿ç”¨å¯æŠ˜å é¢æ¿ç»„ç»‡é…ç½®é¡¹ï¼Œæé«˜ç•Œé¢æ•´æ´åº¦
                    -->
                    <div>
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="settings">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-cog mr-2 text-primary"></i>å¤„ç†è®¾ç½®
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="settings-panel">

                                
                                <!-- 
                                    ==================== æ•°æ®ç´¢å¼•èŒƒå›´ ====================
                                    è®¾ç½®æ•°æ®çš„èµ·å§‹å’Œç»“æŸæ—¥æœŸï¼Œç”¨äºé™å®šåˆ†æèŒƒå›´
                                    ä½¿ç”¨è“è‰²æç¤ºæ¡†è¯´æ˜åŠŸèƒ½ï¼Œæä¾›æ¸…é™¤é€‰æ‹©æŒ‰é’®
                                -->
                                <div class="border-t pt-4">
                                    <div class="bg-white rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-all-300">
                                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="dataIndexRange">
                                            <h4 class="text-sm font-semibold text-gray-800 flex items-center">
                                            <i class="fa fa-calendar mr-2 text-teal-600"></i>æ•°æ®ç´¢å¼•èŒƒå›´
                                        </h4>
                                            <i class="fa fa-chevron-down text-gray-500 text-xs transform transition-transform duration-200"></i>
                                        </div>
                                        <div class="p-4 space-y-3 panel-content" id="dataIndexRange-panel">
                                            <div class="grid grid-cols-2 gap-3">
                                                <!-- èµ·å§‹æ—¥æœŸé€‰æ‹© -->
                                                <div>
                                                    <label for="dataStartDate" class="block text-sm font-semibold text-gray-700 mb-1">
                                                        èµ·å§‹æ—¥æœŸ
                                                        <span class="text-sm text-gray-600 ml-1">(ä»å“ªå¤©å¼€å§‹)</span>
                                                    </label>
                                                    <select id="dataStartDate" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm bg-white" aria-label="æ•°æ®å¼€å§‹æ—¥æœŸ" title="é€‰æ‹©æ•°æ®å¼€å§‹æ—¥æœŸ">
                                                        <option value="">-- è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸ --</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">é€‰æ‹©æ•°æ®çš„èµ·å§‹æ—¥æœŸ</p>
                                                </div>
                                                
                                                <!-- ç»“æŸæ—¥æœŸé€‰æ‹© -->
                                                <div>
                                                    <label for="dataEndDate" class="block text-sm font-semibold text-gray-700 mb-1">
                                                        ç»“æŸæ—¥æœŸ
                                                        <span class="text-sm text-gray-600 ml-1">(åˆ°å“ªå¤©ç»“æŸ)</span>
                                                    </label>
                                                    <select id="dataEndDate" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm bg-white" aria-label="æ•°æ®ç»“æŸæ—¥æœŸ" title="é€‰æ‹©æ•°æ®ç»“æŸæ—¥æœŸ">
                                                        <option value="">-- è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ --</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">é€‰æ‹©æ•°æ®çš„ç»“æŸæ—¥æœŸ</p>
                                                </div>
                                            </div>
                                            
                                            <!-- åŠŸèƒ½æç¤º -->
                                            <div class="bg-blue-50 p-2 rounded-lg">
                                                <p class="text-xs text-blue-700">
                                                    <i class="fa fa-lightbulb mr-1"></i>
                                                    æç¤ºï¼šé€‰æ‹©èµ·å§‹å’Œç»“æŸæ—¥æœŸåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ¹æ®è¿™ä¸¤ä¸ªæ—¥æœŸæ‰€ç¡®å®šçš„è¡ŒèŒƒå›´è¿›è¡Œç´¢å¼•å®šä½ã€‚å¦‚æœé€‰æ‹©ä¸ºç©ºï¼Œå°†åˆ†ææ‰€æœ‰æ•°æ®
                                                </p>
                                            </div>
                                            
                                            <!-- æ¸…é™¤é€‰æ‹©æŒ‰é’® -->
                                            <button id="clearDateSelection" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300 transition-all-300 mt-2" aria-label="æ¸…é™¤æ—¥æœŸé€‰æ‹©" title="æ¸…é™¤æ—¥æœŸé€‰æ‹©">
                                                <i class="fa fa-times mr-1"></i>æ¸…é™¤é€‰æ‹©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                        
                        <!-- 
                            ==================== å¤„ç†é…ç½® ====================
                            è®¾ç½®æ— æ•ˆæ•°æ®å¤„ç†æ–¹å¼å’Œæ—¶é—´é—´éš”å‚æ•°
                            ä½¿ç”¨ç°è‰²èƒŒæ™¯é¢æ¿åŒºåˆ†äºå…¶ä»–é…ç½®é¡¹
                        -->
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="config">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-cogs mr-2 text-primary"></i>å¤„ç†é…ç½®
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="config-panel">
                                <!-- æ— æ•ˆæ•°æ®å¤„ç†æ–¹å¼ -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">æ— æ•ˆæ•°æ®å¤„ç†æ–¹å¼</label>
                                    <select id="invalidDataHandling" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="æ— æ•ˆæ•°æ®å¤„ç†æ–¹å¼" title="é€‰æ‹©æ— æ•ˆæ•°æ®å¤„ç†æ–¹å¼">
                                        <option value="ignore">å¿½ç•¥è¯¥ç‚¹</option>
                                        <option value="fill">ç”¨ç›¸é‚»æœ‰æ•ˆæ•°æ®å¡«å……</option>
                                    </select>
                                </div>
                                
                                <!-- æ—¶é—´é—´éš”è®¾ç½® -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">æ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                                    <select id="timeInterval" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="æ—¶é—´é—´éš”" title="é€‰æ‹©æ—¶é—´é—´éš”">
                                        <option value="1">1åˆ†é’Ÿ</option>
                                        <option value="5">5åˆ†é’Ÿ</option>
                                        <option value="15" selected="">15åˆ†é’Ÿ</option>
                                        <option value="30">30åˆ†é’Ÿ</option>
                                        <option value="60">60åˆ†é’Ÿ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== æ•°æ®é¢„è§ˆ ====================
                            æ˜¾ç¤ºé…ç½®åçš„æ•°æ®é¢„è§ˆå’Œè®¡ç®—è¿‡ç¨‹é¢„è§ˆ
                            æä¾›ç¬¬ä¸€ä¸ªå°æ—¶å’Œç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹é¢„è§ˆæŒ‰é’®
                        -->
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-eye mr-2 text-primary"></i>æ•°æ®é¢„è§ˆ
                                </h3>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="preview-panel">
                                <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
                                <div id="dataPreview" class="border border-gray-200 rounded-lg shadow-sm bg-white min-h-32 overflow-hidden">
                                    <p class="text-gray-500 text-center py-12 text-sm">è¯·å…ˆå®Œæˆæ•°æ®é…ç½®ï¼Œå°†æ˜¾ç¤ºæ•°æ®é¢„è§ˆ</p>
                                </div>
                                
                                <!-- è®¡ç®—è¿‡ç¨‹é¢„è§ˆæŒ‰é’® -->
                                <div class="space-y-2">
                                    <button id="previewFirstHourCalculation" class="w-full bg-secondary text-white px-4 py-2.5 rounded-lg hover:bg-secondary/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled aria-label="é¢„è§ˆç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹" title="é¢„è§ˆç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹">
                                        <i class="fa fa-calculator mr-2"></i>é¢„è§ˆç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹
                                    </button>
                                    <button id="previewFirstDayCalculation" class="w-full bg-accent text-white px-4 py-2.5 rounded-lg hover:bg-accent/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled aria-label="é¢„è§ˆç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹" title="é¢„è§ˆç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹">
                                        <i class="fa fa-calendar-day mr-2"></i>é¢„è§ˆç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                




            </div>
        </section>

        <!-- 
            ==================== ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¯è§†åŒ– ====================
            æä¾›è´Ÿè·æ›²çº¿å¯è§†åŒ–åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ—¥æœŸèŒƒå›´ç­›é€‰å’Œæ—¶æ®µèšç„¦
            ä½¿ç”¨å“åº”å¼ç½‘æ ¼å¸ƒå±€ï¼Œé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
        -->
        <section id="visualizationSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-6 md:p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all-300">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fa fa-bar-chart text-primary mr-3 text-2xl"></i>è´Ÿè·æ›²çº¿å¯è§†åŒ–
                </h2>
                
                <!-- 
                    ==================== ç°ä»£åŒ–è®¾ç½®é¢æ¿åŒºåŸŸ ====================
                    é‡æ–°è®¾è®¡çš„è®¾ç½®é¢æ¿ï¼Œä½¿ç”¨æ¸å˜è‰²ä¸»é¢˜å’Œç°ä»£åŒ–UI
                    æä¾›æ—¥æœŸèŒƒå›´ç­›é€‰ã€æ—¶æ®µèšç„¦ã€æ›²çº¿æ ·å¼è®¾ç½®ã€è®¡é‡ç‚¹ç¼–å·ç­›é€‰
                -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- 
                        ==================== æ—¥æœŸèŒƒå›´ç­›é€‰ ====================
                        è“è‰²ä¸»é¢˜çš„æ—¥æœŸèŒƒå›´ç­›é€‰é¢æ¿ï¼Œç°ä»£åŒ–è®¾è®¡
                    -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl shadow-xl border border-blue-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-calendar-alt text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-blue-900">æ—¥æœŸèŒƒå›´ç­›é€‰</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="startDate" class="block text-sm font-semibold text-blue-800 mb-2">å¼€å§‹æ—¥æœŸ</label>
                                <select id="startDate" 
                                        class="w-full px-4 py-3 border border-blue-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="å¼€å§‹æ—¥æœŸ" title="é€‰æ‹©å¼€å§‹æ—¥æœŸ">
                                    <option value="">-- è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸ --</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="endDate" class="block text-sm font-semibold text-blue-800 mb-2">ç»“æŸæ—¥æœŸ</label>
                                <select id="endDate" 
                                        class="w-full px-4 py-3 border border-blue-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="ç»“æŸæ—¥æœŸ" title="é€‰æ‹©ç»“æŸæ—¥æœŸ">
                                    <option value="">-- è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ --</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="applyDateFilter" 
                                        class="bg-blue-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="åº”ç”¨æ—¥æœŸç­›é€‰" title="åº”ç”¨æ—¥æœŸç­›é€‰">
                                    <i class="fas fa-check"></i>
                                    <span class="text-sm font-medium">åº”ç”¨</span>
                                </button>
                                <button id="selectAllDates" 
                                        class="bg-gray-500 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-gray-600 active:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="å…¨é€‰æ—¥æœŸ" title="å…¨é€‰æ—¥æœŸ">
                                    <i class="fas fa-check-square"></i>
                                    <span class="text-sm font-medium">å…¨é€‰</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== æ—¶æ®µèšç„¦ ====================
                        ç´«è‰²ä¸»é¢˜çš„æ—¶æ®µèšç„¦é¢æ¿ï¼Œç°ä»£åŒ–è®¾è®¡
                    -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl shadow-xl border border-purple-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-clock text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-purple-900">æ—¶æ®µèšç„¦</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="focusStartTime" class="block text-sm font-semibold text-purple-800 mb-2">å¼€å§‹æ—¶é—´</label>
                                <select id="focusStartTime" 
                                        class="w-full px-4 py-3 border border-purple-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="å¼€å§‹æ—¶é—´" title="é€‰æ‹©å¼€å§‹æ—¶é—´">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6">06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="focusEndTime" class="block text-sm font-semibold text-purple-800 mb-2">ç»“æŸæ—¶é—´</label>
                                <select id="focusEndTime" 
                                        class="w-full px-4 py-3 border border-purple-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="ç»“æŸæ—¶é—´" title="é€‰æ‹©ç»“æŸæ—¶é—´">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6">06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23" selected="">23:00</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button id="applyTimeFocus" 
                                        class="bg-purple-600 text-white font-bold py-2.5 px-3 rounded-xl hover:bg-purple-700 active:bg-purple-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-1" 
                                        aria-label="åº”ç”¨æ—¶é—´æ®µ" title="åº”ç”¨æ—¶é—´æ®µ">
                                    <i class="fas fa-check"></i>
                                    <span class="text-xs">åº”ç”¨</span>
                                </button>
                                <button id="resetTimeFocus" 
                                        class="bg-gray-500 text-white font-bold py-2.5 px-3 rounded-xl hover:bg-gray-600 active:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-1" 
                                        aria-label="é‡ç½®ä¸ºå…¨å¤©" title="é‡ç½®ä¸ºå…¨å¤©">
                                    <i class="fas fa-refresh"></i>
                                    <span class="text-xs">å…¨å¤©</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== æ›²çº¿æ ·å¼è®¾ç½® ====================
                        ç»¿è‰²ä¸»é¢˜çš„æ›²çº¿æ ·å¼è®¾ç½®é¢æ¿ï¼Œç°ä»£åŒ–è®¾è®¡
                    -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-xl border border-green-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-palette text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-green-900">æ›²çº¿æ ·å¼è®¾ç½®</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="lineStyle" class="block text-xs font-semibold text-green-800 mb-1">çº¿æ¡æ ·å¼</label>
                                    <select id="lineStyle" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="çº¿æ¡æ ·å¼" title="é€‰æ‹©çº¿æ¡æ ·å¼">
                                        <option value="solid">å®çº¿</option>
                                        <option value="dashed">è™šçº¿</option>
                                        <option value="dotted">ç‚¹çº¿</option>
                                        <option value="dashdot">ç‚¹åˆ’çº¿</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="showPoints" class="block text-xs font-semibold text-green-800 mb-1">æ•°æ®ç‚¹</label>
                                    <select id="showPoints" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="æ˜¾ç¤ºæ•°æ®ç‚¹" title="é€‰æ‹©æ˜¯å¦æ˜¾ç¤ºæ•°æ®ç‚¹">
                                        <option value="true">æ˜¾ç¤º</option>
                                        <option value="false">éšè—</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="smoothCurve" class="block text-xs font-semibold text-green-800 mb-1">å¹³æ»‘æ›²çº¿</label>
                                    <select id="smoothCurve" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="å¹³æ»‘æ›²çº¿" title="é€‰æ‹©æ˜¯å¦å¹³æ»‘æ›²çº¿">
                                        <option value="false">å…³é—­</option>
                                        <option value="true" selected>å¼€å¯</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="curveTension" class="block text-xs font-semibold text-green-800 mb-1">å¹³æ»‘åº¦</label>
                                    <select id="curveTension" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="æ›²çº¿å¼ åŠ›" title="é€‰æ‹©æ›²çº¿å¼ åŠ›">
                                        <option value="0.1">ä½</option>
                                        <option value="0.2" selected>ä¸­</option>
                                        <option value="0.4">é«˜</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-green-200/50 rounded-xl p-3">
                                <label for="secondaryAxis" class="inline-flex items-center text-xs font-semibold text-green-800 cursor-pointer">
                                    <input type="checkbox" id="secondaryAxis" 
                                           class="form-checkbox text-green-600 rounded-lg w-4 h-4 focus:ring-2 focus:ring-green-500 mr-2 transition-all duration-200">
                                    <span>è¾…åŠ©Yè½´(kW)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== è®¡é‡ç‚¹ç¼–å·ç­›é€‰ ====================
                        æ©™è‰²ä¸»é¢˜çš„è®¡é‡ç‚¹ç­›é€‰é¢æ¿ï¼Œç°ä»£åŒ–è®¾è®¡
                    -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl shadow-xl border border-orange-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-filter text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-orange-900">è®¡é‡ç‚¹ç¼–å·ç­›é€‰</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="visualizationMeteringPointFilter" class="block text-sm font-semibold text-orange-800 mb-2">é€‰æ‹©è®¡é‡ç‚¹</label>
                                <select id="visualizationMeteringPointFilter" 
                                        class="w-full px-4 py-3 border border-orange-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="è®¡é‡ç‚¹ç­›é€‰" title="é€‰æ‹©è®¡é‡ç‚¹ç­›é€‰">
                                    <option value="">-- å…¨éƒ¨è®¡é‡ç‚¹ --</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="applyMeteringPointFilter" 
                                        class="bg-orange-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-orange-700 active:bg-orange-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="åº”ç”¨è®¡é‡ç‚¹ç­›é€‰" title="åº”ç”¨è®¡é‡ç‚¹ç­›é€‰">
                                    <i class="fas fa-check"></i>
                                    <span class="font-medium">åº”ç”¨</span>
                                </button>
                                <button id="selectAllMeteringPoints" 
                                        class="bg-gray-500 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-gray-600 active:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="å…¨é€‰è®¡é‡ç‚¹" title="å…¨é€‰è®¡é‡ç‚¹">
                                    <i class="fas fa-check-square"></i>
                                    <span class="font-medium">å…¨é€‰</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-chart-line text-primary mr-3"></i>
                            24å°æ—¶è´Ÿè·æ›²çº¿
                        </h3>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center text-sm font-medium text-gray-700">
                                <input type="checkbox" id="toggleCurveLegend" class="form-checkbox text-blue-600 mr-2 rounded">
                                æ˜¾ç¤ºå›¾ä¾‹
                            </label>

                            <button id="toggleSummaryMode" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 active:bg-indigo-800 transition-all">
                                æ±‡æ€»æ›²çº¿
                            </button>
                        </div>
                    </div>
                    
                    <!-- é‡æ–°è®¾è®¡çš„24å°æ—¶è´Ÿè·æ›²çº¿å›¾è¡¨å®¹å™¨ -->
                    <div class="relative h-[500px] md:h-[600px] lg:h-[700px] bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden" id="chartContainer">
                        <canvas id="loadCurveChart" class="w-full h-full rounded-2xl cursor-crosshair"></canvas>
                        
                        <!-- å›¾ä¾‹å®¹å™¨ -->
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm rounded-lg p-3 shadow-lg border border-gray-200" id="curveLegendContainer" style="display: none;">
                        </div>
                        
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div id="chartLoading" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-circle-notch fa-spin text-4xl text-primary mb-4"></i>
                                <p class="text-gray-600 font-medium">æ­£åœ¨ç”Ÿæˆ24å°æ—¶è´Ÿè·æ›²çº¿...</p>
                            </div>
                        </div>
                        
                        <!-- æ— æ•°æ®æç¤º -->
                        <div id="noDataMessage" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-chart-line text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600 font-medium">æš‚æ— 24å°æ—¶è´Ÿè·æ•°æ®</p>
                                <p class="text-sm text-gray-500 mt-2">è¯·æ£€æŸ¥æ•°æ®å¯¼å…¥å’Œç­›é€‰æ¡ä»¶</p>
                            </div>
                        </div>
                        
                        <!-- 24å°æ—¶æ•°æ®æç¤ºæ¡† -->
                        <div id="chartTooltip" class="absolute bg-gray-900/95 backdrop-blur-sm text-white px-5 py-4 rounded-xl shadow-2xl text-sm hidden z-20 pointer-events-none border border-gray-600 max-w-xs">
                            <div class="font-bold text-lg mb-2" id="tooltipTitle"></div>
                            <div class="text-sm text-gray-200" id="tooltipValue"></div>
                            <div class="text-xs text-blue-300 mt-2" id="tooltipTime"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¥æœŸæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾åŒºåŸŸ -->
                <div class="mb-8" id="dailyTotalBarChartSection">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-bar text-primary mr-3"></i>
                        æ—¥æœŸæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾
                        <div class="ml-4 flex items-center space-x-2" id="barChartAggregationControls">
                            <button id="barChartAggregationDailyBtn" class="px-3 py-1.5 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 transition">æŒ‰æ—¥</button>
                            <button id="barChartAggregationMonthlyBtn" class="px-3 py-1.5 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400 transition">æŒ‰æœˆ</button>
                        </div>
                    </h3>
                    
                    <div class="relative h-[400px] md:h-[500px] lg:h-[500px] bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden" id="dailyTotalBarChartContainer">
                        <canvas id="dailyTotalBarChart" class="w-full h-full rounded-2xl cursor-pointer"></canvas>
                        
                        <div id="barChartLoading" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-circle-notch fa-spin text-4xl text-primary mb-4"></i>
                                <p class="text-gray-600 font-medium">æ­£åœ¨ç”ŸæˆæŸ±çŠ¶å›¾...</p>
                            </div>
                        </div>
                        
                        <div id="barChartNoDataMessage" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-chart-bar text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600 font-medium">æš‚æ— æ•°æ®æ˜¾ç¤º</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-line text-primary mr-3"></i>
                        ç»Ÿè®¡ä¿¡æ¯
                    </h3>
                    
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <div class="mb-4">
                            <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                <i class="fas fa-chart-bar text-primary mr-2"></i>
                                æ•°æ®ç»Ÿè®¡åˆ†æ
                            </h4>
                        </div>
                        
                        <!-- ç»Ÿä¸€ç»Ÿè®¡å†…å®¹åŒºåŸŸ -->
                        <div id="unifiedStats" class="bg-gray-50 rounded-lg p-4">
                            <div class="text-center py-8">
                                <i class="fas fa-chart-bar text-3xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600">è¯·å…ˆç”Ÿæˆå›¾è¡¨ä»¥æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯</p>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </section>

        <!-- 
            ==================== ç¬¬å››éƒ¨åˆ†ï¼šå¯¼å‡º ====================
            æä¾›æ•°æ®å¤„ç†ç»“æœçš„å¯¼å‡ºåŠŸèƒ½
            ä½¿ç”¨ç™½è‰²èƒŒæ™¯å¡ç‰‡å’Œé˜´å½±æ•ˆæœå¢å¼ºè§†è§‰ä½“éªŒ
        -->
        <section id="exportSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-download text-primary mr-3"></i>
                    ç»“æœå¯¼å‡º
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-image text-primary mr-2"></i>
                            å›¾è¡¨å¯¼å‡º
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <button id="exportPNG" class="flex-1 bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="å¯¼å‡ºä¸ºPNG" title="å¯¼å‡ºä¸ºPNG">
                                    <i class="fas fa-file-image mr-2"></i>å¯¼å‡ºä¸ºPNG
                                </button>
                                <select id="pngQuality" class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-28 bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="PNGè´¨é‡" title="é€‰æ‹©PNGè´¨é‡">
                                    <option value="0.7">è´¨é‡: 70%</option>
                                    <option value="0.8">è´¨é‡: 80%</option>
                                    <option value="0.9" selected="">è´¨é‡: 90%</option>
                                    <option value="1.0">è´¨é‡: 100%</option>
                                </select>
                            </div>
                            <button id="exportJPG" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="å¯¼å‡ºä¸ºJPG" title="å¯¼å‡ºä¸ºJPG">
                                <i class="fas fa-file-image mr-2"></i>å¯¼å‡ºä¸ºJPG
                            </button>
                            <button id="exportSVG" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="å¯¼å‡ºä¸ºSVG" title="å¯¼å‡ºä¸ºSVG">
                                <i class="fas fa-file-image mr-2"></i>å¯¼å‡ºä¸ºSVG
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-table text-primary mr-2"></i>
                            æ•°æ®å¯¼å‡º
                        </h3>
                        <div class="space-y-4">
                            <button id="exportHourlyData" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="å¯¼å‡º24å°æ—¶ç”µèƒ½æ˜ç»†" title="å¯¼å‡º24å°æ—¶ç”µèƒ½æ˜ç»†">
                                <i class="fas fa-file-excel mr-2"></i>å¯¼å‡º24å°æ—¶ç”µèƒ½æ˜ç»†
                            </button>
                            <button id="exportDailyStats" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="å¯¼å‡ºæ—¥ç»Ÿè®¡æ•°æ®" title="å¯¼å‡ºæ—¥ç»Ÿè®¡æ•°æ®">
                                <i class="fas fa-file-excel mr-2"></i>å¯¼å‡ºæ—¥ç»Ÿè®¡æ•°æ®
                            </button>
                            <button id="exportPVsystData" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-600/90 transition-all-300 flex items-center justify-center font-medium" aria-label="å¯¼å‡ºPVsystæœˆåº¦é‡æ’æ•°æ®" title="å¯¼å‡ºPVsystæœˆåº¦é‡æ’æ•°æ®">
                        <i class="fas fa-solar-panel mr-2"></i>å¯¼å‡ºPVsystæœˆåº¦é‡æ’æ•°æ®
                    </button>
                    <div class="text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded">
                        <i class="fa fa-info-circle mr-1"></i>
                        PVsystæœˆåº¦é‡æ’8760å°æ—¶æ•°æ®ï¼šCSVæ–‡ä»¶ï¼ŒæŒ‰æœˆä»½ä»1æœˆåˆ°12æœˆé‡æ–°æ’åˆ—ï¼Œå»é™¤å¹´ä»½å½±å“ï¼Œç¼ºå¤±æ•°æ®è‡ªåŠ¨è¡¥å…¨ï¼Œæ ¼å¼DD/MM/YY hh:mm
                    </div>
                            <div class="mt-2">
                                <label for="exportFormat" class="block text-sm font-semibold text-gray-700 mb-2">å¯¼å‡ºæ ¼å¼</label>
                                <select id="exportFormat" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="å¯¼å‡ºæ ¼å¼" title="é€‰æ‹©å¯¼å‡ºæ ¼å¼">
                                    <option value="xlsx">Excel (.xlsx)</option>
                                    <option value="csv">CSV (.csv)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-8 mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-cog text-primary mr-2"></i>
                        å¯¼å‡ºè®¾ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="exportFileName" class="block text-sm font-semibold text-gray-700 mb-2">æ–‡ä»¶åå‰ç¼€</label>
                            <input type="text" id="exportFileName" value="è´Ÿè·æ›²çº¿æ•°æ®" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="å¯¼å‡ºæ–‡ä»¶å" title="å¯¼å‡ºæ–‡ä»¶å" placeholder="è¯·è¾“å…¥å¯¼å‡ºæ–‡ä»¶å">
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="includeTimestamp" class="inline-flex items-center text-sm">
                                <input type="checkbox" id="includeTimestamp" class="form-checkbox text-primary rounded" checked="">
                                <span class="ml-2 font-medium text-gray-700">æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³</span>
                            </label>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="includeFiltersInName" class="inline-flex items-center text-sm">
                                <input type="checkbox" id="includeFiltersInName" class="form-checkbox text-primary rounded">
                                <span class="ml-2 font-medium text-gray-700">åŒ…å«ç­›é€‰æ¡ä»¶</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ -->
                    <div class="mt-6 bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-calendar-range text-primary mr-2"></i>
                            24å°æ—¶æ•°æ®å¯¼å‡ºæ—¥æœŸèŒƒå›´
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="exportStartDate" class="block text-sm font-semibold text-gray-700 mb-2">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="exportStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="å¯¼å‡ºå¼€å§‹æ—¥æœŸ" title="å¯¼å‡ºå¼€å§‹æ—¥æœŸ">
                            </div>
                            <div>
                                <label for="exportEndDate" class="block text-sm font-semibold text-gray-700 mb-2">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="exportEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="å¯¼å‡ºç»“æŸæ—¥æœŸ" title="å¯¼å‡ºç»“æŸæ—¥æœŸ">
                            </div>
                            <div>
                                <label for="exportAllDates" class="inline-flex items-center text-sm mt-8">
                                    <input type="checkbox" id="exportAllDates" class="form-checkbox text-primary rounded" checked="">
                                    <span class="ml-2 font-medium text-gray-700">å¯¼å‡ºæ‰€æœ‰æ—¥æœŸ</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </section>
    </main>

    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all-300 flex items-center max-w-sm hidden">
        <i id="notificationIcon" class="mr-2 text-xl"></i>
        <div>
            <h3 id="notificationTitle" class="font-medium"></h3>
            <p id="notificationMessage" class="text-sm text-gray-600"></p>
        </div>
        <button id="closeNotification" class="ml-4 text-gray-400 hover:text-gray-600" aria-label="å…³é—­é€šçŸ¥" title="å…³é—­é€šçŸ¥">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div id="modal" class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-semibold"></h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600" aria-label="å…³é—­æ¨¡æ€æ¡†" title="å…³é—­æ¨¡æ€æ¡†">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="p-5">
                <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JSå¡«å…… -->
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="firstHourCalculationModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">ç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹é¢„è§ˆ</h3>
                <button id="closeFirstHourCalculationModal" class="text-gray-400 hover:text-gray-600" aria-label="å…³é—­ç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—é¢„è§ˆ" title="å…³é—­ç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—é¢„è§ˆ">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-neutral">æ—¥æœŸï¼š</span>
                            <span id="previewDate" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">æ—¶é—´é—´éš”ï¼š</span>
                            <span id="previewInterval" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">æ•°æ®ç±»å‹ï¼š</span>
                            <span id="previewDataType" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">å€ç‡ï¼š</span>
                            <span id="previewMultiplier" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">åŸå§‹æ•°æ®ï¼ˆç¬¬ä¸€ä¸ªå°æ—¶ï¼‰</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewRawData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">æ¸…æ´—åæ•°æ®</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewCleanedData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">è®¡ç®—è¿‡ç¨‹</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50">
                        <div id="previewCalculationProcess" class="text-sm">-</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">è®¡ç®—ç»“æœ</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border border-gray-200 rounded p-3 bg-primary/5">
                            <div class="text-neutral text-sm">ç¬¬ä¸€ä¸ªå°æ—¶ç”µèƒ½å€¼</div>
                            <div id="previewResult" class="text-xl font-bold text-primary">-</div>
                        </div>
                        <div class="border border-gray-200 rounded p-3 bg-secondary/5">
                            <div class="text-neutral text-sm">è®¡ç®—å…¬å¼</div>
                            <div id="previewFormula" class="text-sm font-medium text-secondary">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="firstDayCalculationModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">ç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹é¢„è§ˆ</h3>
                <button id="closeFirstDayCalculationModal" class="text-gray-400 hover:text-gray-600" aria-label="å…³é—­ç¬¬ä¸€å¤©è®¡ç®—é¢„è§ˆ" title="å…³é—­ç¬¬ä¸€å¤©è®¡ç®—é¢„è§ˆ">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-neutral">æ—¥æœŸï¼š</span>
                            <span id="previewFirstDayDate" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">æ—¶é—´é—´éš”ï¼š</span>
                            <span id="previewFirstDayInterval" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">æ•°æ®ç±»å‹ï¼š</span>
                            <span id="previewFirstDayDataType" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">å€ç‡ï¼š</span>
                            <span id="previewFirstDayMultiplier" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">åŸå§‹æ•°æ®ï¼ˆç¬¬ä¸€å¤©ï¼‰</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewFirstDayRawData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">æ¸…æ´—åæ•°æ®</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewFirstDayCleanedData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">è®¡ç®—è¿‡ç¨‹</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50">
                        <div id="previewFirstDayCalculationProcess" class="text-sm">-</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">è®¡ç®—ç»“æœ</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border border-gray-200 rounded p-3 bg-primary/5">
                            <div class="text-neutral text-sm">ç¬¬ä¸€å¤©æ€»ç”µèƒ½å€¼</div>
                            <div id="previewFirstDayResult" class="text-xl font-bold text-primary">-</div>
                        </div>
                        <div class="border border-gray-200 rounded p-3 bg-secondary/5">
                            <div class="text-neutral text-sm">è®¡ç®—å…¬å¼</div>
                            <div id="previewFirstDayFormula" class="text-sm font-medium text-secondary">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="historyDetailModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">å¯¼å…¥å†å²è¯¦æƒ…</h3>
                <button id="closeHistoryDetailModal" class="text-gray-400 hover:text-gray-600" aria-label="å…³é—­å¯¼å…¥å†å²è¯¦æƒ…" title="å…³é—­å¯¼å…¥å†å²è¯¦æƒ…">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="historyDetailContent" class="p-5">
                <!-- å†å²è®°å½•è¯¦æƒ…å°†é€šè¿‡JSå¡«å…… -->
            </div>
        </div>
    </div>

    <!-- æ—¶æ®µç»Ÿè®¡å¯¹æ¯”è¡¨æ ¼ - å›ºå®šUIå¤§å°ç‰ˆæœ¬ -->
    <div id="timeSlotComparisonWindow" class="hidden">
        <div class="bg-white rounded-lg shadow-xl border border-gray-200 w-full max-w-4xl mx-auto">
            <!-- æ ‡é¢˜æ  -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 rounded-t-lg flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">æ—¶æ®µç»Ÿè®¡å¯¹æ¯”</h3>
                <button id="closeTimeSlotComparison" class="text-gray-500 hover:text-gray-700" title="å…³é—­" aria-label="å…³é—­æ—¶é—´æ®µæ¯”è¾ƒ">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div id="timeSlotComparisonContent" class="p-6">
                <!-- æ—¶æ®µé€‰æ‹© -->
                <div class="mb-6 grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¶æ®µ</label>
                        <select id="timeSlotStart" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="å¼€å§‹æ—¶æ®µ">
                            <option value="0">00:00</option>
                            <option value="1">01:00</option>
                            <option value="2">02:00</option>
                            <option value="3">03:00</option>
                            <option value="4">04:00</option>
                            <option value="5">05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23">23:00</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¶æ®µ</label>
                        <select id="timeSlotEnd" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="ç»“æŸæ—¶æ®µ">
                            <option value="0">00:00</option>
                            <option value="1">01:00</option>
                            <option value="2">02:00</option>
                            <option value="3">03:00</option>
                            <option value="4">04:00</option>
                            <option value="5">05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23" selected>23:00</option>
                        </select>
                    </div>
                </div>

                <!-- ç»Ÿè®¡è¡¨æ ¼ -->
                <div class="bg-gray-50 rounded-lg p-4 max-h-80 overflow-y-auto text-sm">
                    <table class="w-full border-collapse whitespace-nowrap text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 p-2 text-center font-medium">æ—¥æœŸ</th>
                                <th class="border border-gray-200 p-2 text-center font-medium">æ—¶æ®µç”¨ç”µé‡ (kWh)</th>
                                <th class="border border-gray-200 p-2 text-center font-medium">å…¨å¤©ç™¾åˆ†æ¯”</th>
                                <th class="border border-gray-200 p-2 text-center font-medium">å¯¹æ¯”</th>
                            </tr>
                        </thead>
                        <tbody id="timeSlotComparisonTableBody">
                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>

                <!-- ç»Ÿè®¡æ±‡æ€» -->
                <div id="timeSlotSummary" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="text-base font-semibold text-blue-900 mb-4">ğŸ“Š æ—¶æ®µç»Ÿè®¡æ±‡æ€»</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-blue-700 font-medium text-xs uppercase tracking-wide">å¹³å‡ç”¨ç”µé‡</div>
                            <div id="timeSlotAvg" class="text-xl font-bold text-blue-900 mt-1">-</div>
                        </div>
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-green-700 font-medium text-xs uppercase tracking-wide">æœ€å¤§ç”¨ç”µé‡</div>
                            <div id="timeSlotMax" class="text-xl font-bold text-green-900 mt-1">-</div>
                        </div>
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-orange-700 font-medium text-xs uppercase tracking-wide">æœ€å°ç”¨ç”µé‡</div>
                            <div id="timeSlotMin" class="text-xl font-bold text-orange-900 mt-1">-</div>
                        </div>
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-purple-700 font-medium text-xs uppercase tracking-wide">æ€»ç”¨ç”µé‡</div>
                            <div id="timeSlotTotal" class="text-xl font-bold text-purple-900 mt-1">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        const appData = {
            files: [],
            worksheets: [],
            parsedData: [],
            processedData: [],
            config: {
                dataType: 'instantPower',
                multiplier: 1.0,
                useMultiplierColumn: false,
                multiplierColumn: '',
                dateColumn: '',
                useDateRange: false,
                dataStartColumn: '',
                dataEndColumn: '',
                dataStartIndex: 0,
                dataEndIndex: -1,
                meteringPointColumn: '',
                meteringPointFilter: '',
                dateFormat: 'YYYY-MM-DD',
                invalidDataHandling: 'ignore',
                timeInterval: 15,
                filterCount: 1,
                additionalFilters: []
            },
            visualization: {
        selectedDates: [],
        selectedMeteringPoints: [],
        focusStartTime: 0,
        focusEndTime: 23,
        lineStyle: 'solid',
        showPoints: false,
        secondaryAxis: false,
        smoothCurve: true,
        curveTension: 0.2,
        showDailyTotalBarChart: true,
        barChartAggregation: 'daily' // 'daily' or 'monthly'
    },
            // æ—¥æœŸé€‰æ‹©ç›¸å…³
            dateSelectionMode: null, // 'start', 'end', or null
            selectedStartDate: null, // YYYY-MM-DDæ ¼å¼
            selectedEndDate: null,   // YYYY-MM-DDæ ¼å¼
            chart: null,
            dailyTotalBarChart: null, // å­˜å‚¨æ—¥æœŸæ€»ç”¨ç”µé‡å›¾è¡¨å¼•ç”¨
            meteringPoints: [], // å­˜å‚¨æ‰€æœ‰è®¡é‡ç‚¹ç¼–å·
            importHistory: [], // å­˜å‚¨å¯¼å…¥å†å²è®°å½•
            // å†…å­˜ç®¡ç†é…ç½®
            memoryManagement: {
                maxDataRows: 100000, // å•ä¸ªæ–‡ä»¶æœ€å¤§è¡Œæ•°é™åˆ¶
                maxTotalMemoryMB: 200, // æ€»å†…å­˜ä½¿ç”¨é™åˆ¶ï¼ˆMBï¼‰
                currentMemoryUsageMB: 0, // å½“å‰å†…å­˜ä½¿ç”¨é‡ä¼°ç®—
                enableGarbageCollection: true // æ˜¯å¦å¯ç”¨åƒåœ¾å›æ”¶ä¼˜åŒ–
            }
        };

        // DOM å…ƒç´ 
        const elements = {
            // æ­¥éª¤æŒ‡ç¤ºå™¨

            
            // å¯¼å…¥éƒ¨åˆ†
            dropArea: document.getElementById('dropArea'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            importedFiles: document.getElementById('importedFiles'),
            removeAllFiles: document.getElementById('removeAllFiles'),

            uploadProgress: document.getElementById('uploadProgress'),
            uploadProgressBar: document.getElementById('progressBar'),
        uploadProgressText: document.getElementById('progressText'),
            importStatus: document.getElementById('importStatus'),
            fileListContent: document.getElementById('fileListContent'),
            historyList: document.getElementById('historyList'),
            
            // é…ç½®éƒ¨åˆ†
            dataTypeRadios: document.querySelectorAll('input[name="dataType"]'),
            multiplierInput: document.getElementById('multiplier'),
            useMultiplierColumnCheckbox: document.getElementById('useMultiplierColumn'),
            multiplierOptions: document.getElementById('multiplierOptions'),
            multiplierColumnOption: document.getElementById('multiplierColumnOption'),
            multiplierColumnSelect: document.getElementById('multiplierColumn'),

            dataStartDate: document.getElementById('dataStartDate'),
            dataEndDate: document.getElementById('dataEndDate'),
            clearDateSelectionBtn: document.getElementById('clearDateSelection'),
            dateColumnSelect: document.getElementById('dateColumn'),
            dataStartColumnSelect: document.getElementById('dataStartColumn'),
            dataEndColumnSelect: document.getElementById('dataEndColumn'),
            meteringPointColumnSelect: document.getElementById('meteringPointColumn'),
            meteringPointFilterSelect: document.getElementById('meteringPointFilter'),

            invalidDataHandlingSelect: document.getElementById('invalidDataHandling'),
            timeIntervalSelect: document.getElementById('timeInterval'),
            dataPreview: document.getElementById('dataPreview'),
            previewFirstHourCalculationBtn: document.getElementById('previewFirstHourCalculation'),
            firstHourCalculationModal: document.getElementById('firstHourCalculationModal'),
            closeFirstHourCalculationModalBtn: document.getElementById('closeFirstHourCalculationModal'),
            previewFirstDayCalculationBtn: document.getElementById('previewFirstDayCalculation'),
            previewDate: document.getElementById('previewDate'),
            previewInterval: document.getElementById('previewInterval'),
            previewDataType: document.getElementById('previewDataType'),
            previewMultiplier: document.getElementById('previewMultiplier'),
            previewRawData: document.getElementById('previewRawData'),
            previewCleanedData: document.getElementById('previewCleanedData'),
            previewCalculationProcess: document.getElementById('previewCalculationProcess'),
            previewResult: document.getElementById('previewResult'),
            previewFormula: document.getElementById('previewFormula'),
            
            // ç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹ç›¸å…³
            firstDayCalculationModal: document.getElementById('firstDayCalculationModal'),
            closeFirstDayCalculationModalBtn: document.getElementById('closeFirstDayCalculationModal'),
            previewFirstDayDate: document.getElementById('previewFirstDayDate'),
            previewFirstDayInterval: document.getElementById('previewFirstDayInterval'),
            previewFirstDayDataType: document.getElementById('previewFirstDayDataType'),
            previewFirstDayMultiplier: document.getElementById('previewFirstDayMultiplier'),
            previewFirstDayRawData: document.getElementById('previewFirstDayRawData'),
            previewFirstDayCleanedData: document.getElementById('previewFirstDayCleanedData'),
            previewFirstDayCalculationProcess: document.getElementById('previewFirstDayCalculationProcess'),
            previewFirstDayResult: document.getElementById('previewFirstDayResult'),
            previewFirstDayFormula: document.getElementById('previewFirstDayFormula'),

            
            // å¯è§†åŒ–éƒ¨åˆ†
            startDateInput: document.getElementById('startDate'),
            endDateInput: document.getElementById('endDate'),
            applyDateFilterBtn: document.getElementById('applyDateFilter'),
            selectAllDatesBtn: document.getElementById('selectAllDates'),

            focusStartTimeSelect: document.getElementById('focusStartTime'),
            focusEndTimeSelect: document.getElementById('focusEndTime'),
            applyTimeFocusBtn: document.getElementById('applyTimeFocus'),
            resetTimeFocusBtn: document.getElementById('resetTimeFocus'),
            visualizationMeteringPointFilterSelect: document.getElementById('visualizationMeteringPointFilter'),
            applyMeteringPointFilterBtn: document.getElementById('applyMeteringPointFilter'),
            selectAllMeteringPointsBtn: document.getElementById('selectAllMeteringPoints'),
            lineStyleSelect: document.getElementById('lineStyle'),
            showPointsSelect: document.getElementById('showPoints'),
            smoothCurveSelect: document.getElementById('smoothCurve'),
            curveTensionSelect: document.getElementById('curveTension'),
            secondaryAxisCheckbox: document.getElementById('secondaryAxis'),
            loadCurveChart: document.getElementById('loadCurveChart'),
            chartLoading: document.getElementById('chartLoading'),
            noDataMessage: document.getElementById('noDataMessage'),
            dailyStats: document.getElementById('dailyStats'),
            periodStats: document.getElementById('periodStats'),

            // èšåˆåˆ‡æ¢æŒ‰é’®
            barChartAggregationDailyBtn: document.getElementById('barChartAggregationDailyBtn'),
            barChartAggregationMonthlyBtn: document.getElementById('barChartAggregationMonthlyBtn'),
            
            // å¯¼å‡ºéƒ¨åˆ†
            exportPNGBtn: document.getElementById('exportPNG'),
            pngQualitySelect: document.getElementById('pngQuality'),
            exportJPGBtn: document.getElementById('exportJPG'),
            exportSVGBtn: document.getElementById('exportSVG'),
            exportHourlyDataBtn: document.getElementById('exportHourlyData'),
            exportDailyStatsBtn: document.getElementById('exportDailyStats'),
            exportFormatSelect: document.getElementById('exportFormat'),
            exportFileNameInput: document.getElementById('exportFileName'),
            includeTimestampCheckbox: document.getElementById('includeTimestamp'),
            includeFiltersInNameCheckbox: document.getElementById('includeFiltersInName'),

            startOverBtn: document.getElementById('startOverBtn'),
            
            // é€šçŸ¥å’Œæ¨¡æ€æ¡†
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notificationIcon'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            closeNotificationBtn: document.getElementById('closeNotification'),
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModalBtn: document.getElementById('closeModal'),
            helpBtn: document.getElementById('helpBtn'),
            aboutBtn: document.getElementById('aboutBtn'),
            
            //  sections
            importSection: document.getElementById('importSection'),
            configSection: document.getElementById('configSection'),
            visualizationSection: document.getElementById('visualizationSection'),
            exportSection: document.getElementById('exportSection'),
            
            // å†å²è®°å½•ç›¸å…³
            importHistory: document.getElementById('importHistory'),
            historyDetailModal: document.getElementById('historyDetailModal'),
            closeHistoryDetailModalBtn: document.getElementById('closeHistoryDetailModal'),
            historyDetailContent: document.getElementById('historyDetailContent'),
            filterCountInput: document.getElementById('filterCount'),
        applyFilterCountBtn: document.getElementById('applyFilterCount'),
        filterOptionsContainer: document.getElementById('filterOptionsContainer'),
        

        };

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // å¯¼å…¥éƒ¨åˆ†
            elements.dropArea.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelection);
            elements.dropArea.addEventListener('dragover', handleDragOver);
            elements.dropArea.addEventListener('dragleave', handleDragLeave);
            elements.dropArea.addEventListener('drop', handleDrop);
            elements.removeAllFiles.addEventListener('click', removeAllFiles);

            
            // é…ç½®éƒ¨åˆ†
            elements.dataTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    appData.config.dataType = e.target.value;
                    if (appData.originalData) {
                        reprocessDataWithConfig();
                    } else {
                        updateDataPreview();
                    }
                });
            });
            
            elements.multiplierInput.addEventListener('change', (e) => {
                appData.config.multiplier = parseFloat(e.target.value) || 1.0;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            console.log('Chartå®ä¾‹åˆ›å»ºå®Œæˆ:', !!appData.dailyTotalBarChart);
            console.log('=== åˆå§‹åŒ–æŸ±çŠ¶å›¾ç»“æŸ ===');
            
            elements.useMultiplierColumnCheckbox.addEventListener('change', (e) => {
                appData.config.useMultiplierColumn = e.target.checked;
                if (e.target.checked) {
                    if (elements.multiplierOptions && elements.multiplierOptions.parentNode) {
                        elements.multiplierOptions.classList.add('hidden');
                    }
                    if (elements.multiplierColumnOption && elements.multiplierColumnOption.parentNode) {
                        elements.multiplierColumnOption.classList.remove('hidden');
                    }
                } else {
                    if (elements.multiplierOptions && elements.multiplierOptions.parentNode) {
                        elements.multiplierOptions.classList.remove('hidden');
                    }
                    if (elements.multiplierColumnOption && elements.multiplierColumnOption.parentNode) {
                        elements.multiplierColumnOption.classList.add('hidden');
                    }
                }
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            // æŸ±çŠ¶å›¾èšåˆåˆ‡æ¢
            if (elements.barChartAggregationDailyBtn && elements.barChartAggregationMonthlyBtn) {
                const applyAggregationActive = () => {
                    const isMonthly = appData?.visualization?.barChartAggregation === 'monthly';
                    elements.barChartAggregationDailyBtn.classList.toggle('bg-blue-600', !isMonthly);
                    elements.barChartAggregationDailyBtn.classList.toggle('text-white', !isMonthly);
                    elements.barChartAggregationDailyBtn.classList.toggle('bg-gray-200', isMonthly);
                    elements.barChartAggregationDailyBtn.classList.toggle('text-gray-700', isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('bg-blue-600', isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('text-white', isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('bg-gray-200', !isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('text-gray-700', !isMonthly);
                };
                applyAggregationActive();
                
                elements.barChartAggregationDailyBtn.addEventListener('click', () => {
                    if (appData.visualization.barChartAggregation !== 'daily') {
                        appData.visualization.barChartAggregation = 'daily';
                        applyAggregationActive();
                        updateDailyTotalBarChart(getFilteredData());
                        showNotification('æ˜¾ç¤ºæ¨¡å¼', 'æŸ±çŠ¶å›¾å·²åˆ‡æ¢ä¸ºæŒ‰æ—¥èšåˆ', 'success');
                    }
                });
                elements.barChartAggregationMonthlyBtn.addEventListener('click', () => {
                    if (appData.visualization.barChartAggregation !== 'monthly') {
                        appData.visualization.barChartAggregation = 'monthly';
                        applyAggregationActive();
                        updateDailyTotalBarChart(getFilteredData());
                        showNotification('æ˜¾ç¤ºæ¨¡å¼', 'æŸ±çŠ¶å›¾å·²åˆ‡æ¢ä¸ºæŒ‰æœˆèšåˆ', 'success');
                    }
                });
            }

            elements.multiplierColumnSelect.addEventListener('change', (e) => {
                appData.config.multiplierColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            elements.dateColumnSelect.addEventListener('change', (e) => {
                appData.config.dateColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
                checkConfigValidity();
            });
            
            elements.dataStartColumnSelect.addEventListener('change', (e) => {
                appData.config.dataStartColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
                checkConfigValidity();
            });
            
            elements.dataEndColumnSelect.addEventListener('change', (e) => {
                appData.config.dataEndColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
                checkConfigValidity();
            });
            
            elements.meteringPointColumnSelect.addEventListener('change', (e) => {
                appData.config.meteringPointColumn = e.target.value;
                updateMeteringPointFilterOptions();
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            elements.meteringPointFilterSelect.addEventListener('change', (e) => {
                appData.config.meteringPointFilter = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            

            
            elements.invalidDataHandlingSelect.addEventListener('change', (e) => {
                appData.config.invalidDataHandling = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                }
            });
            
            elements.timeIntervalSelect.addEventListener('change', (e) => {
        appData.config.timeInterval = parseInt(e.target.value);
        if (appData.originalData) {
            reprocessDataWithConfig();
        } else {
            updateDataPreview();
        }
        checkConfigValidity();
    });
    

    // æ•°æ®ç´¢å¼•èŒƒå›´æ—¥æœŸé€‰æ‹©
    elements.dataStartDate.addEventListener('change', function() {
        appData.selectedStartDate = this.value;
        if (appData.selectedStartDate && appData.selectedEndDate) {
            // ç¡®ä¿å¼€å§‹æ—¥æœŸä¸æ™šäºç»“æŸæ—¥æœŸ
            if (new Date(appData.selectedStartDate) > new Date(appData.selectedEndDate)) {
                showNotification('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ', 'warning');
                this.value = appData.selectedStartDate;
                return;
            }
            // é‡æ–°å¤„ç†æ•°æ®ä»¥åæ˜ æ—¥æœŸèŒƒå›´é€‰æ‹©
            if (appData.originalData) {
                reprocessDataWithConfig();
            } else {
                updateDataPreview();
            }
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('ä¿¡æ¯', `å·²é€‰æ‹©æ—¥æœŸèŒƒå›´: ${appData.selectedStartDate} è‡³ ${appData.selectedEndDate}`, 'success');
        }
    });

    elements.dataEndDate.addEventListener('change', function() {
        appData.selectedEndDate = this.value;
        if (appData.selectedStartDate && appData.selectedEndDate) {
            // ç¡®ä¿å¼€å§‹æ—¥æœŸä¸æ™šäºç»“æŸæ—¥æœŸ
            if (new Date(appData.selectedStartDate) > new Date(appData.selectedEndDate)) {
                showNotification('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ', 'warning');
                this.value = appData.selectedEndDate;
                return;
            }
            // é‡æ–°å¤„ç†æ•°æ®ä»¥åæ˜ æ—¥æœŸèŒƒå›´é€‰æ‹©
            if (appData.originalData) {
                reprocessDataWithConfig();
            } else {
                updateDataPreview();
            }
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('ä¿¡æ¯', `å·²é€‰æ‹©æ—¥æœŸèŒƒå›´: ${appData.selectedStartDate} è‡³ ${appData.selectedEndDate}`, 'success');
        }
    });

            elements.clearDateSelectionBtn.addEventListener('click', function() {
                appData.selectedStartDate = null;
                appData.selectedEndDate = null;
                elements.dataStartDate.value = '';
                elements.dataEndDate.value = '';
                
                // æ¸…é™¤æ•°æ®è¡Œç´¢å¼•èŒƒå›´
                const dataStartIndexInput = document.getElementById('dataStartIndex');
                const dataEndIndexInput = document.getElementById('dataEndIndex');
                if (dataStartIndexInput) dataStartIndexInput.value = 0;
                if (dataEndIndexInput) dataEndIndexInput.value = -1;
                appData.config.dataStartIndex = 0;
                appData.config.dataEndIndex = -1;
                
                // æ›´æ–°æ•°æ®é¢„è§ˆä»¥æ¸…é™¤é€‰æ‹©èŒƒå›´çš„é«˜äº®
                updateDataPreview();
                
                showNotification('å·²æ¸…é™¤æ—¥æœŸé€‰æ‹©', 'success');
            });
            

            
            // ç»‘å®šæ•°æ®è¡Œç´¢å¼•èŒƒå›´äº‹ä»¶ç›‘å¬å™¨
            
            
            // å¯è§†åŒ–éƒ¨åˆ†
            elements.applyDateFilterBtn.addEventListener('click', applyDateFilter);
            elements.selectAllDatesBtn.addEventListener('click', selectAllDates);

            elements.applyMeteringPointFilterBtn.addEventListener('click', applyMeteringPointFilter);
            elements.selectAllMeteringPointsBtn.addEventListener('click', selectAllMeteringPoints);
            elements.applyTimeFocusBtn.addEventListener('click', applyTimeFocus);
            elements.resetTimeFocusBtn.addEventListener('click', resetTimeFocus);
            // æ—¶æ®µèšç„¦æ”¹ä¸ºæ‰‹åŠ¨åº”ç”¨æ¨¡å¼ï¼Œé¿å…é¢‘ç¹åˆ·æ–°
            elements.focusStartTimeSelect.addEventListener('change', (e) => {
                appData.visualization.focusStartTime = parseInt(e.target.value);
                // æ·»åŠ è§†è§‰åé¦ˆå¹¶æ›´æ–°å›¾è¡¨å’Œç»Ÿè®¡
                e.target.style.borderColor = '#a855f7';
                setTimeout(() => {
                    e.target.style.borderColor = '';
                }, 1000);
                updateChart();
            });
            elements.focusEndTimeSelect.addEventListener('change', (e) => {
                appData.visualization.focusEndTime = parseInt(e.target.value);
                // æ·»åŠ è§†è§‰åé¦ˆå¹¶æ›´æ–°å›¾è¡¨å’Œç»Ÿè®¡
                e.target.style.borderColor = '#a855f7';
                setTimeout(() => {
                    e.target.style.borderColor = '';
                }, 1000);
                updateChart();
            });
            elements.lineStyleSelect.addEventListener('change', (e) => {
                appData.visualization.lineStyle = e.target.value;
                // æ·»åŠ è§†è§‰åé¦ˆ
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('æ ·å¼æ›´æ–°', `çº¿æ¡æ ·å¼å·²æ›´æ”¹ä¸º${e.target.options[e.target.selectedIndex].text}`, 'success');
            });
            
            elements.showPointsSelect.addEventListener('change', (e) => {
                appData.visualization.showPoints = e.target.value === 'true';
                // æ·»åŠ è§†è§‰åé¦ˆ
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('æ ·å¼æ›´æ–°', `æ•°æ®ç‚¹æ˜¾ç¤ºå·²${e.target.value === 'true' ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
            });
            
            elements.smoothCurveSelect.addEventListener('change', (e) => {
                appData.visualization.smoothCurve = e.target.value === 'true';
                // æ·»åŠ è§†è§‰åé¦ˆ
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('æ ·å¼æ›´æ–°', `æ›²çº¿å¹³æ»‘å·²${e.target.value === 'true' ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
            });
            
            elements.curveTensionSelect.addEventListener('change', (e) => {
                appData.visualization.curveTension = parseFloat(e.target.value);
                // æ·»åŠ è§†è§‰åé¦ˆ
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('æ ·å¼æ›´æ–°', `æ›²çº¿å¹³æ»‘åº¦å·²è®¾ç½®ä¸º${e.target.options[e.target.selectedIndex].text}`, 'success');
            });
            
            elements.secondaryAxisCheckbox.addEventListener('change', (e) => {
                appData.visualization.secondaryAxis = e.target.checked;
                // æ·»åŠ è§†è§‰åé¦ˆ
                e.target.parentElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.parentElement.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('æ ·å¼æ›´æ–°', `è¾…åŠ©Yè½´å·²${e.target.checked ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
            });
            
            // æ›²çº¿å›¾å›¾ä¾‹æ˜¾ç¤ºå¼€å…³äº‹ä»¶
            document.getElementById('toggleCurveLegend').addEventListener('change', (e) => {
                const isVisible = e.target.checked;
                const legendContainer = document.getElementById('curveLegendContainer');
                
                // æ›´æ–°å›¾ä¾‹å®¹å™¨æ˜¾ç¤ºçŠ¶æ€
                if (legendContainer) {
                    legendContainer.style.display = isVisible ? 'block' : 'none';
                }
                
                // æ›´æ–°å›¾è¡¨å›¾ä¾‹æ˜¾ç¤ºçŠ¶æ€
                if (appData.chart) {
                    appData.chart.options.plugins.legend.display = isVisible;
                    appData.chart.update();
                }
                
                // æ·»åŠ è§†è§‰åé¦ˆ
                e.target.parentElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.parentElement.style.transform = 'scale(1)';
                }, 200);
                
                showNotification('æ ·å¼æ›´æ–°', `æ›²çº¿å›¾ä¾‹å·²${isVisible ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
            });
            
            // æ–°å¢ï¼šæ±‡æ€»æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            const summaryBtn = document.getElementById('toggleSummaryMode');
            if (summaryBtn) {
                summaryBtn.addEventListener('click', () => {
                    appData.visualization.summaryMode = !appData.visualization.summaryMode;
                    // æ›´æ–°æŒ‰é’®æ–‡æ¡ˆ/æ ·å¼
                    summaryBtn.textContent = appData.visualization.summaryMode ? 'è¿”å›æ˜ç»†' : 'æ±‡æ€»æ›²çº¿';
                    summaryBtn.classList.toggle('bg-indigo-600', !appData.visualization.summaryMode);
                    summaryBtn.classList.toggle('bg-gray-600', appData.visualization.summaryMode);
                    // åˆ·æ–°å›¾è¡¨
                    updateChart();
                    // æ±‡æ€»æ¨¡å¼ä¸‹éšè—åˆ†é¡µæ§ä»¶
                    if (appData.visualization.summaryMode) {
                        hidePaginationControls();
                    }
                });
            }

            // æŸ±çŠ¶å›¾å§‹ç»ˆæ˜¾ç¤ºï¼Œæ— éœ€äº‹ä»¶å¤„ç†

            

            
            // å¯¼å‡ºéƒ¨åˆ†
            elements.exportPNGBtn.addEventListener('click', exportAsPNG);
            elements.exportJPGBtn.addEventListener('click', exportAsJPG);
            elements.exportSVGBtn.addEventListener('click', exportAsSVG);
            elements.exportHourlyDataBtn.addEventListener('click', exportHourlyData);
            elements.exportDailyStatsBtn.addEventListener('click', exportDailyStats);
            document.getElementById('exportPVsystData').addEventListener('click', exportPVsystData);
            
            // å¯¼å‡ºæ—¥æœŸèŒƒå›´é€‰æ‹©å™¨äº‹ä»¶å¤„ç†
            document.getElementById('exportAllDates').addEventListener('change', function() {
                const startDate = document.getElementById('exportStartDate');
                const endDate = document.getElementById('exportEndDate');
                
                if (this.checked) {
                    startDate.disabled = true;
                    endDate.disabled = true;
                } else {
                    startDate.disabled = false;
                    endDate.disabled = false;
                }
            });
            
            // åˆå§‹åŒ–æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨çŠ¶æ€
              document.getElementById('exportAllDates').dispatchEvent(new Event('change'));

            if (elements.startOverBtn) {
                elements.startOverBtn.addEventListener('click', startOver);
            }
            
            // é€šçŸ¥å’Œæ¨¡æ€æ¡†
            elements.closeNotificationBtn.addEventListener('click', hideNotification);
            elements.closeModalBtn.addEventListener('click', closeModal);
            elements.modalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.modalOverlay) closeModal();
            });
            

            elements.aboutBtn.addEventListener('click', showAboutModal);
            
            elements.filterCountInput.addEventListener('change', (e) => {
                appData.config.filterCount = parseInt(e.target.value) || 1;
            });
        
        // å¯¼å…¥å†å²ç°åœ¨å›ºå®šå±•å¼€ï¼Œæ— éœ€åˆ‡æ¢åŠŸèƒ½
        
            console.log('Chartå®ä¾‹åˆ›å»ºå®Œæˆ:', !!appData.dailyTotalBarChart);
            console.log('=== åˆå§‹åŒ–æŸ±çŠ¶å›¾ç»“æŸ ===');
        
        // äº‹ä»¶ç›‘å¬å™¨ç»‘å®š
        if (elements.closeHistoryDetailModalBtn) {
            elements.closeHistoryDetailModalBtn.addEventListener('click', closeHistoryDetailModal);
        }
        
        if (elements.applyFilterCountBtn) {
            elements.applyFilterCountBtn.addEventListener('click', generateFilterOptions);
        }
        
        // ç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹é¢„è§ˆ
        if (elements.previewFirstHourCalculationBtn) {
            elements.previewFirstHourCalculationBtn.addEventListener('click', previewFirstHourCalculation);
        }
        if (elements.closeFirstHourCalculationModalBtn) {
            elements.closeFirstHourCalculationModalBtn.addEventListener('click', closeFirstHourCalculationModal);
        }
        
        // ç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹é¢„è§ˆ
        if (elements.previewFirstDayCalculationBtn) {
            elements.previewFirstDayCalculationBtn.addEventListener('click', previewFirstDayCalculation);
        }
        if (elements.closeFirstDayCalculationModalBtn) {
            elements.closeFirstDayCalculationModalBtn.addEventListener('click', closeFirstDayCalculationModal);
        }
        
        // æ·»åŠ æ•°æ®ç»“æ„ç±»å‹å˜æ›´äº‹ä»¶å¤„ç†
        document.querySelectorAll('input[name="dataStructure"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const dataStructure = this.value;
                
                // æ ¹æ®æ•°æ®ç»“æ„ç±»å‹æ˜¾ç¤º/éšè—ç›¸å…³é€‰é¡¹
        if (dataStructure === 'columnToRow') {
            // æ˜¾ç¤ºæ•°æ®ç»“æŸåˆ—é€‰é¡¹
            document.getElementById('dataEndColumn').parentElement.style.display = 'block';
            
            // æ˜¾ç¤ºæ—¶é—´é—´éš”è‡ªåŠ¨æ£€æµ‹æç¤º
            const timeIntervalLabel = document.querySelector('label[for="timeInterval"]');
            if (timeIntervalLabel) {
                timeIntervalLabel.textContent = 'æ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿï¼Œåˆ—å¯¹è¡Œç»“æ„å¯è‡ªåŠ¨æ£€æµ‹ï¼‰';
            }
            
            // éšè—è·¨æ—¥æœŸç»“æ„æ•°æ®é€‰é¡¹
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'none';
            }
                } else {
            // éšè—æ•°æ®ç»“æŸåˆ—é€‰é¡¹
            document.getElementById('dataEndColumn').parentElement.style.display = 'none';
            
            // æ›´æ–°æ—¶é—´é—´éš”æ ‡ç­¾
            const timeIntervalLabel = document.querySelector('label[for="timeInterval"]');
            if (timeIntervalLabel) {
                timeIntervalLabel.textContent = 'æ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿï¼‰';
            }
            
            // æ˜¾ç¤ºè·¨æ—¥æœŸç»“æ„æ•°æ®é€‰é¡¹
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'block';
            }
                }
                
                // æ›´æ–°æ•°æ®é¢„è§ˆ
                updateDataPreview();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                checkConfigValidity();
            });
        });
        
        // åˆå§‹åŒ–æ•°æ®ç»“æ„ç±»å‹UI
        const initialDataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
        if (initialDataStructure === 'columnToColumn') {
            // éšè—æ•°æ®ç»“æŸåˆ—é€‰é¡¹
            document.getElementById('dataEndColumn').parentElement.style.display = 'none';
            
            // æ˜¾ç¤ºè·¨æ—¥æœŸç»“æ„æ•°æ®é€‰é¡¹
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'block';
            }
        } else {
            // éšè—è·¨æ—¥æœŸç»“æ„æ•°æ®é€‰é¡¹
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'none';
            }
        }

        // æ¸…é™¤æŒ‰é’®äº‹ä»¶å¤„ç†
        // æ¸…é™¤è®¡é‡ç‚¹ç¼–å·æ‰€åœ¨åˆ—é€‰æ‹©
        document.getElementById('clearMeteringPointColumn').addEventListener('click', function() {
            elements.meteringPointColumnSelect.value = '';
            appData.config.meteringPointColumn = '';
            updateMeteringPointFilterOptions();
            updateDataPreview();
            showNotification('å·²æ¸…é™¤', 'è®¡é‡ç‚¹ç¼–å·æ‰€åœ¨åˆ—é€‰æ‹©å·²æ¸…é™¤', 'success');
        });

        // æ¸…é™¤è®¡é‡ç‚¹ç¼–å·ç­›é€‰
        document.getElementById('clearMeteringPointFilter').addEventListener('click', function() {
            elements.meteringPointFilterSelect.value = '';
            appData.config.meteringPointFilter = '';
            updateDataPreview();
            showNotification('å·²æ¸…é™¤', 'è®¡é‡ç‚¹ç¼–å·ç­›é€‰å·²æ¸…é™¤', 'success');
        });

        // æ¸…é™¤å…¨éƒ¨ç­›é€‰é¡¹
        document.getElementById('clearAllFilters').addEventListener('click', function() {
            // æ¸…é™¤additionalFiltersæ•°ç»„
            appData.config.additionalFilters = [];
            
            // é‡æ–°ç”Ÿæˆç­›é€‰é¡¹ï¼ˆä¼šæ¸…ç©ºæ‰€æœ‰é€‰æ‹©ï¼‰
            generateFilterOptions();
            
            // æ›´æ–°æ•°æ®é¢„è§ˆ
            updateDataPreview();
            showNotification('å·²æ¸…é™¤', 'æ‰€æœ‰ç­›é€‰é¡¹å·²æ¸…é™¤', 'success');
        });

        // æ¸…é™¤å•ä¸ªç­›é€‰é¡¹ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('clear-single-filter')) {
                e.preventDefault();
                const index = parseInt(e.target.dataset.index);
                
                if (!isNaN(index)) {
                    // æ¸…é™¤è¯¥ç­›é€‰é¡¹çš„é€‰æ‹©
                    const columnSelect = document.getElementById(`filterColumn${index}`);
                    const valueSelect = document.getElementById(`filterValue${index}`);
                    
                    if (columnSelect && valueSelect) {
                        columnSelect.value = '';
                        valueSelect.innerHTML = '<option value="">-- å…¨éƒ¨ --</option>';
                        
                        // æ›´æ–°é…ç½®
                        if (appData.config.additionalFilters[index]) {
                            appData.config.additionalFilters[index].column = '';
                            appData.config.additionalFilters[index].value = '';
                        }
                        
                        updateDataPreview();
                        showNotification('å·²æ¸…é™¤', `ç­›é€‰é¡¹ ${index + 1} å·²æ¸…é™¤`, 'success');
                    }
                }
            }
        });
        }

        // æ–‡ä»¶å¤„ç†è¾…åŠ©å‡½æ•°
        function estimateMemoryUsage(jsonData) {
            // ä¼°ç®—æ•°æ®çš„å†…å­˜ä½¿ç”¨é‡ï¼ˆMBï¼‰
            const rowCount = jsonData.length;
            const avgColumnsPerRow = jsonData[0] ? jsonData[0].length : 0;
            const avgBytesPerCell = 20; // ä¼°ç®—æ¯ä¸ªå•å…ƒæ ¼å¹³å‡å­—èŠ‚æ•°
            const estimatedBytes = rowCount * avgColumnsPerRow * avgBytesPerCell;
            return estimatedBytes / (1024 * 1024); // è½¬æ¢ä¸ºMB
        }
        
        function checkMemoryLimits(file, jsonData) {
            const rowCount = jsonData.length;
            const estimatedMB = estimateMemoryUsage(jsonData);
            
            // æ£€æŸ¥å•ä¸ªæ–‡ä»¶è¡Œæ•°é™åˆ¶
            if (rowCount > appData.memoryManagement.maxDataRows) {
                const proceed = confirm(
                    `æ–‡ä»¶ "${file.name}" åŒ…å« ${rowCount} è¡Œæ•°æ®ï¼Œè¶…è¿‡å»ºè®®çš„ ${appData.memoryManagement.maxDataRows} è¡Œé™åˆ¶ã€‚\n\n` +
                    `å¤§é‡æ•°æ®å¯èƒ½å¯¼è‡´æµè§ˆå™¨å“åº”ç¼“æ…¢æˆ–å´©æºƒã€‚\n\næ˜¯å¦ä»è¦ç»§ç»­å¤„ç†ï¼Ÿ`
                );
                if (!proceed) {
                    return false;
                }
            }
            
            // æ£€æŸ¥æ€»å†…å­˜ä½¿ç”¨é™åˆ¶
            const newTotalMemory = appData.memoryManagement.currentMemoryUsageMB + estimatedMB;
            if (newTotalMemory > appData.memoryManagement.maxTotalMemoryMB) {
                const proceed = confirm(
                    `æ·»åŠ æ­¤æ–‡ä»¶å°†ä½¿æ€»å†…å­˜ä½¿ç”¨é‡è¾¾åˆ°çº¦ ${newTotalMemory.toFixed(1)}MBï¼Œè¶…è¿‡ ${appData.memoryManagement.maxTotalMemoryMB}MB é™åˆ¶ã€‚\n\n` +
                    `å»ºè®®å…ˆæ¸…ç†ç°æœ‰æ•°æ®æˆ–å‡å°‘æ•°æ®é‡ã€‚\n\næ˜¯å¦ä»è¦ç»§ç»­ï¼Ÿ`
                );
                if (!proceed) {
                    return false;
                }
            }
            
            // æ›´æ–°å†…å­˜ä½¿ç”¨é‡
            appData.memoryManagement.currentMemoryUsageMB += estimatedMB;
            return true;
        }
        
        function optimizeMemoryUsage() {
            if (appData.memoryManagement.enableGarbageCollection) {
                // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæµè§ˆå™¨æ”¯æŒï¼‰
                if (window.gc && typeof window.gc === 'function') {
                    try {
                        window.gc();
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯ï¼ŒæŸäº›æµè§ˆå™¨ä¸æ”¯æŒæ‰‹åŠ¨GC
                    }
                }
                
                // æ¸…ç†ä¸å¿…è¦çš„å¼•ç”¨
                setTimeout(() => {
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šè¿›è¡Œåƒåœ¾å›æ”¶
                    if (appData.memoryManagement.currentMemoryUsageMB > appData.memoryManagement.maxTotalMemoryMB * 0.8) {
                        showNotification('æç¤º', 'å†…å­˜ä½¿ç”¨é‡è¾ƒé«˜ï¼Œå»ºè®®æ¸…ç†éƒ¨åˆ†æ•°æ®ä»¥æå‡æ€§èƒ½', 'warning');
                    }
                }, 1000);
            }
        }
        
        function completeFileProcessing(file, jsonData, processedCount, totalFiles) {
            // è®°å½•æˆåŠŸçš„å†å²è®°å½•
            const historyRecord = {
                importTime: new Date().toISOString(),
                fileName: file.name,
                fileSize: file.size,
                filePath: file.path || '',
                status: 'success',
                recordCount: jsonData.length - 1,
                validRecordCount: 0,
                invalidRecordCount: 0,
                timeInterval: null,
                config: null
            };
            
            appData.importHistory.push(historyRecord);
            saveImportHistory();
            renderImportHistory();
            
            processedCount++;
            updateUploadProgress(processedCount, totalFiles);
            
            showNotification('æˆåŠŸ', `æ–‡ä»¶ "${file.name}" å¯¼å…¥æˆåŠŸ`, 'success');
            
            // æ›´æ–°çŠ¶æ€
            const importStatusElement = document.getElementById('importStatus');
            if (importStatusElement && importStatusElement.parentNode) {
                importStatusElement.textContent = 'æ–‡ä»¶å¯¼å…¥å®Œæˆ';
            }

            // å¯¼å…¥å®Œæˆåè‡ªåŠ¨åˆ·æ–°æ•°æ®é¢„è§ˆï¼ˆæ— éœ€æ‰‹åŠ¨ä¸‹æ‹‰é€‰æ‹©ï¼‰
            setTimeout(() => {
                try {
                    updateDataPreview();
                } catch (err) {
                    console.error('è‡ªåŠ¨åˆ·æ–°æ•°æ®é¢„è§ˆå¤±è´¥:', err);
                }
            }, 0);
        }
        
        function handleFileProcessingError(file, error, processedCount, totalFiles) {
            console.error('Error processing file:', error);
            showNotification('é”™è¯¯', `å¤„ç†æ–‡ä»¶ "${file.name}" æ—¶å‡ºé”™: ${error.message}`, 'error');
            
            // è®°å½•å¤±è´¥çš„å†å²è®°å½•
            const historyRecord = {
                importTime: new Date().toISOString(),
                fileName: file.name,
                fileSize: file.size,
                filePath: file.path || '',
                status: 'failure',
                errorMessage: error.message,
                recordCount: 0,
                validRecordCount: 0,
                invalidRecordCount: 0
            };
            
            appData.importHistory.push(historyRecord);
            saveImportHistory();
            renderImportHistory();
            
            processedCount++;
            updateUploadProgress(processedCount, totalFiles);
        }

        // æ–‡ä»¶å¤„ç†å‡½æ•°
        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (elements.dropArea && elements.dropArea.parentNode) {
                if (elements.dropArea && elements.dropArea.parentNode) {
                elements.dropArea.classList.add('border-primary');
                elements.dropArea.classList.add('bg-primary/5');
            }
            }
        }

        function handleDragLeave() {
            if (elements.dropArea && elements.dropArea.parentNode) {
                if (elements.dropArea && elements.dropArea.parentNode) {
                if (elements.dropArea && elements.dropArea.parentNode) {
                elements.dropArea.classList.remove('border-primary');
                elements.dropArea.classList.remove('bg-primary/5');
            }
            }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            if (elements.dropArea && elements.dropArea.parentNode) {
                elements.dropArea.classList.remove('border-primary');
                elements.dropArea.classList.remove('bg-primary/5');
            }
            
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function processFiles(files) {
            if (files.length === 0) return;
            
            // åœ¨éè¿½åŠ æ¨¡å¼ä¸‹ï¼Œå¯¼å…¥æ–°æ–‡ä»¶å‰å…ˆæ¸…ç©ºç°æœ‰æ•°æ®ä¸é…ç½®
            const appendModeAtImport = document.getElementById('appendMode')?.checked || false;
            if (!appendModeAtImport) {
                removeAllFiles();
            }
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            if (elements.uploadProgress && elements.uploadProgress.parentNode) {
                if (elements.uploadProgress && elements.uploadProgress.parentNode) {
                elements.uploadProgress.classList.remove('hidden');
            }
            }
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            files.forEach((file, index) => {
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å¯¼å…¥
                const isDuplicate = appData.files.some(f => 
                    f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
                );
                
                if (isDuplicate) {
                    showNotification('è­¦å‘Š', `æ–‡ä»¶ "${file.name}" å·²å¯¼å…¥ï¼Œè·³è¿‡é‡å¤æ–‡ä»¶`, 'warning');
                    processedCount++;
                    updateUploadProgress(processedCount, totalFiles);
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ50MBï¼‰
                const maxFileSize = 50 * 1024 * 1024; // 50MB in bytes
                if (file.size > maxFileSize) {
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    showNotification('è­¦å‘Š', `æ–‡ä»¶ "${file.name}" è¿‡å¤§ (${fileSizeMB}MB)ï¼Œå»ºè®®æ–‡ä»¶å¤§å°ä¸è¶…è¿‡50MBã€‚å¤§æ–‡ä»¶å¯èƒ½å¯¼è‡´æµè§ˆå™¨å“åº”ç¼“æ…¢æˆ–å´©æºƒã€‚`, 'warning');
                    
                    // è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­å¤„ç†
                    if (!confirm(`æ–‡ä»¶ "${file.name}" å¤§å°ä¸º ${fileSizeMB}MBï¼Œè¶…è¿‡å»ºè®®çš„50MBé™åˆ¶ã€‚\n\nç»§ç»­å¤„ç†å¯èƒ½å¯¼è‡´æµè§ˆå™¨å“åº”ç¼“æ…¢æˆ–å´©æºƒã€‚\n\næ˜¯å¦ä»è¦ç»§ç»­å¯¼å…¥æ­¤æ–‡ä»¶ï¼Ÿ`)) {
                        // è®°å½•ç”¨æˆ·å–æ¶ˆçš„å†å²è®°å½•
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '',
                            status: 'cancelled',
                            errorMessage: `ç”¨æˆ·å–æ¶ˆå¯¼å…¥å¤§æ–‡ä»¶ (${fileSizeMB}MB)`,
                            recordCount: 0,
                            validRecordCount: 0,
                            invalidRecordCount: 0
                        };
                        
                        appData.importHistory.push(historyRecord);
                        saveImportHistory();
                        renderImportHistory();
                        processedCount++;
                        updateUploadProgress(processedCount, totalFiles);
                        return;
                    }
                }
                
                if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    showNotification('é”™è¯¯', `æ–‡ä»¶ "${file.name}" æ ¼å¼ä¸æ”¯æŒï¼Œè¯·ä¸Šä¼ Excelæˆ–CSVæ–‡ä»¶`, 'error');
                    
                    // è®°å½•å¤±è´¥çš„å†å²è®°å½•
                    const historyRecord = {
                        importTime: new Date().toISOString(),
                        fileName: file.name,
                        fileSize: file.size,
                        filePath: file.path || '',
                        status: 'failure',
                        errorMessage: 'æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œè¯·ä¸Šä¼ Excelæˆ–CSVæ–‡ä»¶',
                        recordCount: 0,
                        validRecordCount: 0,
                        invalidRecordCount: 0
                    };
                    
                    appData.importHistory.push(historyRecord);
                    saveImportHistory();
                    renderImportHistory();
                    processedCount++;
                    updateUploadProgress(processedCount, totalFiles);
                    return;
                }
                
                appData.files.push(file);
                addFileToUI(file);
                
                const reader = new FileReader();
                
                // æ·»åŠ æ–‡ä»¶è¯»å–é”™è¯¯å¤„ç†
                reader.onerror = function(e) {
                    console.error('FileReader error:', e);
                    const errorMessage = e.target.error ? e.target.error.message : 'æ–‡ä»¶è¯»å–å¤±è´¥';
                    showNotification('é”™è¯¯', `è¯»å–æ–‡ä»¶ "${file.name}" æ—¶å‡ºé”™: ${errorMessage}`, 'error');
                    
                    // è®°å½•å¤±è´¥çš„å†å²è®°å½•
                    const historyRecord = {
                        importTime: new Date().toISOString(),
                        fileName: file.name,
                        fileSize: file.size,
                        filePath: file.path || '',
                        status: 'failure',
                        errorMessage: `æ–‡ä»¶è¯»å–å¤±è´¥: ${errorMessage}`,
                        recordCount: 0,
                        validRecordCount: 0,
                        invalidRecordCount: 0
                    };
                    
                    appData.importHistory.push(historyRecord);
                    saveImportHistory();
                    renderImportHistory();
                    
                    processedCount++;
                    updateUploadProgress(processedCount, totalFiles);
                };
                
                reader.onload = function(e) {
                    try {
                        // æ˜¾ç¤ºå¤„ç†è¿›åº¦ï¼ˆå¯¹äºå¤§æ–‡ä»¶ï¼‰
                        const fileSizeMB = file.size / (1024 * 1024);
                        if (fileSizeMB > 10) { // å¯¹äºè¶…è¿‡10MBçš„æ–‡ä»¶æ˜¾ç¤ºå¤„ç†æç¤º
                            showNotification('ä¿¡æ¯', `æ­£åœ¨å¤„ç†å¤§æ–‡ä»¶ "${file.name}" (${fileSizeMB.toFixed(2)}MB)ï¼Œè¯·ç¨å€™...`, 'info');
                        }
                        
                        let jsonData;
                        let firstSheetName;
                        
                        if (file.name.endsWith('.csv')) {
                            // CSVæ–‡ä»¶å¤„ç†
                            const csvData = e.target.result;
                            const workbook = XLSX.read(csvData, { type: 'string' });
                            firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        } else {
                            // Excelæ–‡ä»¶å¤„ç† - å¯¹å¤§æ–‡ä»¶ä½¿ç”¨æ›´ä¿å®ˆçš„é€‰é¡¹
                            const data = new Uint8Array(e.target.result);
                            const readOptions = fileSizeMB > 20 ? 
                                { type: 'array', cellDates: false, cellNF: false, cellStyles: false } : 
                                { type: 'array' };
                            const workbook = XLSX.read(data, readOptions);
                            firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        }
                        
                        // æ£€æŸ¥å†…å­˜é™åˆ¶
                        if (!checkMemoryLimits(file, jsonData)) {
                            // ç”¨æˆ·å–æ¶ˆå¤„ç†å¤§æ•°æ®æ–‡ä»¶
                            const historyRecord = {
                                importTime: new Date().toISOString(),
                                fileName: file.name,
                                fileSize: file.size,
                                filePath: file.path || '',
                                status: 'cancelled',
                                errorMessage: 'ç”¨æˆ·å–æ¶ˆå¤„ç†å¤§æ•°æ®æ–‡ä»¶ï¼ˆå†…å­˜é™åˆ¶ï¼‰',
                                recordCount: jsonData.length - 1,
                                validRecordCount: 0,
                                invalidRecordCount: 0
                            };
                            
                            appData.importHistory.push(historyRecord);
                            saveImportHistory();
                            renderImportHistory();
                            processedCount++;
                            updateUploadProgress(processedCount, totalFiles);
                            return;
                        }
                        
                        // å¯¹äºå¤§æ•°æ®é›†ï¼Œåˆ†æ‰¹å¤„ç†ä»¥é¿å…UIé˜»å¡
                        if (jsonData.length > 10000) {
                            showNotification('ä¿¡æ¯', `æ–‡ä»¶åŒ…å« ${jsonData.length} è¡Œæ•°æ®ï¼Œæ­£åœ¨ä¼˜åŒ–å¤„ç†...`, 'info');
                            
                            // ä½¿ç”¨setTimeoutåˆ†æ‰¹å¤„ç†ï¼Œé¿å…é˜»å¡UI
                            setTimeout(() => {
                                try {
                                    appData.worksheets.push({
                                        file: file,
                                        sheetName: firstSheetName,
                                        data: jsonData
                                    });
                                    
                                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                                    updateDataStats();
                                    
                                    // éè¿½åŠ æ¨¡å¼æˆ–é¦–ä¸ªæ–‡ä»¶æ—¶ï¼Œè‡ªåŠ¨å¡«å……åˆ—é€‰æ‹©å¹¶è¯†åˆ«æ•°æ®ç»“æ„
                                    const appendModeDetect1 = document.getElementById('appendMode')?.checked || false;
                                    if (!appendModeDetect1 || appData.worksheets.length === 1) {
                                        populateColumnSelects(jsonData[0] || [], jsonData);
                                        autoDetectDataStructure(jsonData);
                                        // è‡ªåŠ¨è¯†åˆ«å®Œæˆåï¼Œå°è¯•åˆ·æ–°é¢„è§ˆï¼ˆè‹¥é…ç½®å·²å……åˆ†ï¼‰
                                        setTimeout(() => { try { updateDataPreview(); } catch(e){} }, 0);
                                    }
                                    
                                    completeFileProcessing(file, jsonData, processedCount, totalFiles);
                                    
                                    // ä¼˜åŒ–å†…å­˜ä½¿ç”¨
                                    optimizeMemoryUsage();
                                } catch (error) {
                                    handleFileProcessingError(file, error, processedCount, totalFiles);
                                }
                            }, 100);
                        } else {
                            appData.worksheets.push({
                                file: file,
                                sheetName: firstSheetName,
                                data: jsonData
                            });
                            
                            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                            updateDataStats();
                            
                            // éè¿½åŠ æ¨¡å¼æˆ–é¦–ä¸ªæ–‡ä»¶æ—¶ï¼Œè‡ªåŠ¨å¡«å……åˆ—é€‰æ‹©å¹¶è¯†åˆ«æ•°æ®ç»“æ„ï¼ˆä¸å¤§æ•°æ®åˆ†æ”¯ä¸€è‡´ï¼‰
                            const appendModeDetect2 = document.getElementById('appendMode')?.checked || false;
                            if (!appendModeDetect2 || appData.worksheets.length === 1) {
                                populateColumnSelects(jsonData[0] || [], jsonData);
                                autoDetectDataStructure(jsonData);
                                // è‡ªåŠ¨è¯†åˆ«å®Œæˆåï¼Œå°è¯•åˆ·æ–°é¢„è§ˆï¼ˆè‹¥é…ç½®å·²å……åˆ†ï¼‰
                                setTimeout(() => { try { updateDataPreview(); } catch(e){} }, 0);
                            }
                            
                            completeFileProcessing(file, jsonData, processedCount, totalFiles);
                            
                            // ä¼˜åŒ–å†…å­˜ä½¿ç”¨
                            optimizeMemoryUsage();
                        }
                        
                        // è®°å½•æˆåŠŸçš„å†å²è®°å½•
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '',
                            status: 'success',
                            recordCount: jsonData.length - 1,
                            validRecordCount: 0,
                            invalidRecordCount: 0,
                            timeInterval: null,
                            config: null
                        };
                        
                        appData.importHistory.push(historyRecord);
                        saveImportHistory();
                        renderImportHistory();
                        
                        processedCount++;
                        updateUploadProgress(processedCount, totalFiles);
                        
                        showNotification('æˆåŠŸ', `æ–‡ä»¶ "${file.name}" å¯¼å…¥æˆåŠŸ`, 'success');
                        
                        // æ›´æ–°çŠ¶æ€
                        const importStatusElement = document.getElementById('importStatus');
                        if (importStatusElement && importStatusElement.parentNode) {
                            importStatusElement.textContent = 'æ–‡ä»¶å¯¼å…¥å®Œæˆ';
                        }
                        
                    } catch (error) {
                        handleFileProcessingError(file, error, processedCount, totalFiles);
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
            
            // æ›´æ–°çŠ¶æ€
            const importStatusElement = document.getElementById('importStatus');
            if (importStatusElement && importStatusElement.parentNode) {
                importStatusElement.textContent = 'æ­£åœ¨å¤„ç†æ–‡ä»¶...';
            }
            
            // æ–‡ä»¶åˆ—è¡¨ç°åœ¨å›ºå®šå±•å¼€ï¼Œæ— éœ€æ§åˆ¶æ˜¾ç¤º/éšè—
            if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                elements.removeAllFiles.classList.remove('hidden');
            }
            
        }

        function addFileToUI(file) {
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
            li.innerHTML = `
                <div class="flex items-center">
                    <i class="fa fa-file-excel-o text-success mr-2"></i>
                    <div>
                        <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                        <p class="text-xs text-neutral">${fileSize} MB</p>
                    </div>
                </div>
                <button class="text-danger hover:text-danger/80 remove-file" data-name="${file.name}" aria-label="åˆ é™¤æ–‡ä»¶ ${file.name}" title="åˆ é™¤æ–‡ä»¶ ${file.name}">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            elements.importedFiles.appendChild(li);
            
            // æ·»åŠ åˆ é™¤å•ä¸ªæ–‡ä»¶çš„äº‹ä»¶
            li.querySelector('.remove-file').addEventListener('click', function(e) {
                const fileName = e.target.closest('.remove-file').dataset.name;
                removeFile(fileName);
            });
        }

        function removeFile(fileName) {
            // ä»æ•°æ®ä¸­ç§»é™¤
            appData.files = appData.files.filter(file => file.name !== fileName);
            appData.worksheets = appData.worksheets.filter(ws => ws.file.name !== fileName);
            
            // ä»UIä¸­ç§»é™¤
            const fileElement = Array.from(elements.importedFiles.children).find(li => 
                li.querySelector('.font-medium').textContent === fileName
            );
            
            if (fileElement) {
                fileElement.remove();
            }
            
            // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œä¿æŒåˆ—è¡¨å±•å¼€ä½†éšè—æ¸…ç©ºæŒ‰é’®
            if (appData.files.length === 0) {
                // æ–‡ä»¶åˆ—è¡¨ç°åœ¨å›ºå®šå±•å¼€ï¼Œæ— éœ€éšè—
                if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                    elements.removeAllFiles.classList.add('hidden');
                }

                const appendMode = document.getElementById('appendMode')?.checked || false;
                if (!appendMode) {
                    // éè¿½åŠ æ¨¡å¼ï¼šå½»åº•é‡ç½®æ•°æ®ä¸é…ç½®
                    appData.worksheets = [];
                    appData.parsedData = [];
                    appData.processedData = [];

                    appData.config = appData.config || {};
                    appData.config.dateColumn = '';
                    appData.config.dataStartColumn = '';
                    appData.config.dataEndColumn = '';
                    appData.config.meteringPointColumn = '';
                    appData.config.multiplierColumn = '';
                    appData.config.dataStructure = '';

                    // æ¸…ç©ºåˆ—é€‰æ‹©ï¼ˆå«è®¡é‡ç‚¹ã€å¤šå€ç‡åˆ—ï¼‰
                    elements.dateColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    elements.dataStartColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    elements.dataEndColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    elements.meteringPointColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                    elements.multiplierColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                } else {
                    // è¿½åŠ æ¨¡å¼ï¼šä¿ç•™æ•°æ®ä¸é…ç½®ï¼Œä¸æ¸…ç©ºåˆ—é€‰æ‹©
                }
            } else if (appData.worksheets.length > 0) {
                // é‡æ–°å¡«å……åˆ—é€‰æ‹©
                populateColumnSelects(appData.worksheets[0].data[0] || [], appData.worksheets[0].data);
            }
            
            showNotification('ä¿¡æ¯', `æ–‡ä»¶ "${fileName}" å·²ç§»é™¤`, 'info');
        }

        function removeAllFiles() {
            if (appData.files.length === 0) return;
            
            // æ¸…ç©ºæ•°æ® - è¿½åŠ æ¨¡å¼ä¸‹ä¸æ¸…é™¤æ•°æ®
            const appendMode = document.getElementById('appendMode')?.checked || false;
            if (!appendMode) {
                appData.files = [];
                appData.worksheets = [];
                appData.parsedData = [];
                appData.processedData = [];
                
                // åŒæ­¥é‡ç½®é…ç½®
                appData.config = appData.config || {};
                appData.config.dateColumn = '';
                appData.config.dataStartColumn = '';
                appData.config.dataEndColumn = '';
                appData.config.meteringPointColumn = '';
                appData.config.multiplierColumn = '';
                appData.config.dataStructure = '';
            } else {
                // è¿½åŠ æ¨¡å¼ä¸‹åªæ¸…ç©ºæ–‡ä»¶åˆ—è¡¨ï¼Œä¿ç•™æ•°æ®
                appData.files = [];
                // ä¸æ¸…é™¤worksheets, parsedData, processedData, config
            }
            
            // æ¸…ç©ºUI
            elements.importedFiles.innerHTML = '';
            // æ–‡ä»¶åˆ—è¡¨ç°åœ¨å›ºå®šå±•å¼€ï¼Œæ— éœ€éšè—
            if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                elements.removeAllFiles.classList.add('hidden');
            }

            // æ¸…ç©ºåˆ—é€‰æ‹©ï¼ˆå«è®¡é‡ç‚¹ã€å¤šå€ç‡åˆ—ï¼‰
            elements.dateColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            
            // é‡ç½®ç­›é€‰ã€é¢„è§ˆä¸æ¦‚è§ˆ
            if (!appendMode) {
                updateDataStats();
                updateDataOverview();
                updateDataPreview();
            }
            
            showNotification('ä¿¡æ¯', 'æ‰€æœ‰æ–‡ä»¶å·²ç§»é™¤', 'info');
        }

        function populateColumnSelects(headerRow, data) {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            elements.dateColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            
            // æ·»åŠ æ–°é€‰é¡¹ (æ”¯æŒæ‰€æœ‰åˆ—ï¼Œä¸å†é™åˆ¶50åˆ—)
            for (let i = 0; i < headerRow.length; i++) {
                // ç”Ÿæˆåˆ—å­—æ¯ï¼Œæ”¯æŒè¶…è¿‡26åˆ—çš„æƒ…å†µï¼ˆå¦‚AA, ABç­‰ï¼‰
                let columnLetter = "";
                let columnNum = i;
                while (columnNum >= 0) {
                    columnLetter = String.fromCharCode(65 + (columnNum % 26)) + columnLetter;
                    columnNum = Math.floor(columnNum / 26) - 1;
                    if (columnNum < 0) break;
                }
                
                const headerText = headerRow[i] ? String(headerRow[i]).substring(0, 20) : `åˆ— ${columnLetter}`;
                
                const dateOption = document.createElement('option');
                dateOption.value = i;
                dateOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dateColumnSelect.appendChild(dateOption);
                
                const startOption = document.createElement('option');
                startOption.value = i;
                startOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dataStartColumnSelect.appendChild(startOption);
                
                const endOption = document.createElement('option');
                endOption.value = i;
                endOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dataEndColumnSelect.appendChild(endOption);
                
                const meteringPointOption = document.createElement('option');
                meteringPointOption.value = i;
                meteringPointOption.textContent = `${columnLetter}: ${headerText}`;
                elements.meteringPointColumnSelect.appendChild(meteringPointOption);
                
                const multiplierColumnOption = document.createElement('option');
        multiplierColumnOption.value = i;
        multiplierColumnOption.textContent = `${columnLetter}: ${headerText}`;
        elements.multiplierColumnSelect.appendChild(multiplierColumnOption);
    }
    
    // è‡ªåŠ¨è¯†åˆ«åˆ—
    if (data && data.length > 1) {
        autoDetectColumns(headerRow, data);
    }
    
    // ç”Ÿæˆç­›é€‰é¡¹
    generateFilterOptions();
}

        // è‡ªåŠ¨è¯†åˆ«æ•°æ®ç»“æ„ç±»å‹å‡½æ•°
        function autoDetectDataStructure(jsonData) {
            if (!jsonData || jsonData.length < 2) return; // éœ€è¦è‡³å°‘æœ‰è¡¨å¤´å’Œä¸€è¡Œæ•°æ®
            
            const headerRow = jsonData[0];
            const dataRows = jsonData.slice(1, Math.min(11, jsonData.length)); // å–å‰10è¡Œæ•°æ®è¿›è¡Œåˆ†æ
            
            // åˆ†æç‰¹å¾1ï¼šåˆ—æ•°
            const columnCount = headerRow.length;
            
            // åˆ†æç‰¹å¾2ï¼šæ—¥æœŸåˆ—çš„ç‰¹å¾
            let dateColumnIndex = -1;
            const dateKeywords = ['æ—¥æœŸ', 'æ—¶é—´', 'date', 'time', 'datetime'];
            
            for (let i = 0; i < headerRow.length; i++) {
                const headerText = String(headerRow[i]).toLowerCase();
                if (dateKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    dateColumnIndex = i;
                    break;
                }
            }
            
            if (dateColumnIndex === -1) return; // æ²¡æœ‰æ‰¾åˆ°æ—¥æœŸåˆ—ï¼Œæ— æ³•åˆ¤æ–­
            
            // åˆ†æç‰¹å¾3ï¼šæ•°æ®åˆ—çš„ç‰¹å¾
            let dataColumnIndices = [];
            const dataKeywords = ['æ•°æ®', 'æ•°å€¼', 'å€¼', 'data', 'value', 'åŠŸç‡', 'ç”µèƒ½', 'è´Ÿè·'];
            
            for (let i = 0; i < headerRow.length; i++) {
                if (i === dateColumnIndex) continue; // è·³è¿‡æ—¥æœŸåˆ—
                
                const headerText = String(headerRow[i]).toLowerCase();
                if (dataKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    dataColumnIndices.push(i);
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„æ•°æ®åˆ—ï¼Œå°è¯•é€šè¿‡æ•°æ®å†…å®¹åˆ¤æ–­
            if (dataColumnIndices.length === 0) {
                for (let i = 0; i < headerRow.length; i++) {
                    if (i === dateColumnIndex) continue; // è·³è¿‡æ—¥æœŸåˆ—
                    
                    // æ£€æŸ¥è¯¥åˆ—æ˜¯å¦åŒ…å«å¤§é‡æ•°å­—
                    let numericCount = 0;
                    for (let j = 0; j < dataRows.length; j++) {
                        if (dataRows[j] && dataRows[j][i] !== undefined && !isNaN(parseFloat(dataRows[j][i]))) {
                            numericCount++;
                        }
                    }
                    
                    // å¦‚æœè¶…è¿‡70%çš„è¡ŒåŒ…å«æ•°å­—ï¼Œè®¤ä¸ºæ˜¯æ•°æ®åˆ—
                    if (numericCount / dataRows.length > 0.7) {
                        dataColumnIndices.push(i);
                    }
                }
            }
            
            // åˆ†æç‰¹å¾4ï¼šæ—¶é—´åºåˆ—æ¨¡å¼
            let timeSeriesScore = 0;
            let columnSeriesScore = 0;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ—¶é—´åºåˆ—æ¨¡å¼ï¼ˆå¦‚0:00, 1:00ç­‰ï¼‰
            for (let i = 0; i < headerRow.length; i++) {
                if (i === dateColumnIndex) continue;
                
                const headerText = String(headerRow[i]);
                if (/\d{1,2}:\d{2}/.test(headerText)) {
                    timeSeriesScore += 5; // å‘ç°æ—¶é—´åºåˆ—æ¨¡å¼
                }
            }
            
            // æ£€æŸ¥æ•°æ®åˆ—æ•°é‡
            if (dataColumnIndices.length >= 24) {
                timeSeriesScore += 3; // å¤šåˆ—æ•°æ®æ›´å¯èƒ½æ˜¯æ—¶é—´åºåˆ—ï¼ˆåˆ—å¯¹è¡Œï¼‰
            }
            
            if (dataColumnIndices.length <= 5) {
                columnSeriesScore += 3; // å°‘åˆ—æ•°æ®æ›´å¯èƒ½æ˜¯åˆ—å¯¹åˆ—
            }
            
            // åˆ†æç‰¹å¾5ï¼šæ—¥æœŸé‡å¤æƒ…å†µ
            const dateCount = {};
            for (let i = 0; i < dataRows.length; i++) {
                if (dataRows[i] && dataRows[i][dateColumnIndex]) {
                    const dateValue = String(dataRows[i][dateColumnIndex]);
                    dateCount[dateValue] = (dateCount[dateValue] || 0) + 1;
                }
            }
            
            // è®¡ç®—æ—¥æœŸé‡å¤ç‡
            const uniqueDates = Object.keys(dateCount).length;
            const totalRows = dataRows.length;
            const dateDuplicationRate = (totalRows - uniqueDates) / totalRows;
            
            if (dateDuplicationRate > 0.5) {
                columnSeriesScore += 5; // é«˜é‡å¤ç‡æ›´å¯èƒ½æ˜¯åˆ—å¯¹åˆ—ç»“æ„
            } else {
                timeSeriesScore += 3; // ä½é‡å¤ç‡æ›´å¯èƒ½æ˜¯åˆ—å¯¹è¡Œç»“æ„
            }
            
            // ç»¼åˆè¯„åˆ†ï¼Œå†³å®šæ•°æ®ç»“æ„ç±»å‹
            const totalScore = timeSeriesScore + columnSeriesScore;
            
            let detectedStructure;
            let confidence;
            
            if (totalScore === 0) {
                // æ²¡æœ‰æ˜ç¡®çš„ç‰¹å¾ï¼Œä½¿ç”¨é»˜è®¤å€¼
                detectedStructure = 'columnToRow';
                confidence = 'low';
            } else {
                const timeSeriesRatio = timeSeriesScore / totalScore;
                
                if (timeSeriesRatio > 0.6) {
                    detectedStructure = 'columnToRow';
                    confidence = timeSeriesRatio > 0.8 ? 'high' : 'medium';
                } else {
                    detectedStructure = 'columnToColumn';
                    confidence = timeSeriesRatio < 0.4 ? 'high' : 'medium';
                }
            }
            
            // è®¾ç½®æ£€æµ‹åˆ°çš„æ•°æ®ç»“æ„ç±»å‹
            const radioToCheck = document.querySelector(`input[name="dataStructure"][value="${detectedStructure}"]`);
            if (radioToCheck) {
                radioToCheck.checked = true;
                
                // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°UI
                const event = new Event('change', { bubbles: true });
                radioToCheck.dispatchEvent(event);
                
                // æ˜¾ç¤ºæ£€æµ‹ç»“æœé€šçŸ¥
                let confidenceText = '';
                if (confidence === 'high') {
                    confidenceText = 'é«˜ç½®ä¿¡åº¦';
                } else if (confidence === 'medium') {
                    confidenceText = 'ä¸­ç­‰ç½®ä¿¡åº¦';
                } else {
                    confidenceText = 'ä½ç½®ä¿¡åº¦ï¼Œä½¿ç”¨é»˜è®¤å€¼';
                }
                
                const structureText = detectedStructure === 'columnToRow' ? 'åˆ—å¯¹è¡Œï¼ˆæ—¥æœŸåˆ—å¯¹å¤šæ•°æ®åˆ—ï¼‰' : 'åˆ—å¯¹åˆ—ï¼ˆæ—¥æœŸåˆ—å¯¹å•æ•°æ®åˆ—ï¼‰';
                showNotification('ä¿¡æ¯', `å·²è‡ªåŠ¨è¯†åˆ«æ•°æ®ç»“æ„ç±»å‹ï¼š${structureText}ï¼ˆ${confidenceText}ï¼‰`, 'info');
            }
        }

        // è‡ªåŠ¨è¯†åˆ«åˆ—å‡½æ•°
        function autoDetectColumns(headerRow, data) {
            let dateColumnIndex = -1;
            let dataStartColumnIndex = -1;
            let dataEndColumnIndex = -1;
            let meteringPointColumnIndex = -1;
            let multiplierColumnIndex = -1;
            
            // è¯†åˆ«æ—¥æœŸåˆ— - æŸ¥æ‰¾åŒ…å«æ—¥æœŸç›¸å…³å…³é”®è¯çš„åˆ—
            const dateKeywords = ['æ—¥æœŸ', 'æ—¶é—´', 'date', 'time', 'datetime', 'æ—¶é—´ç‚¹', 'è®°å½•æ—¶é—´', 'æ—¥', 'æœˆ', 'å¹´', 'æ—¶', 'åˆ†', 'ç§’'];
            const datePatterns = [/\d{4}[\-\/]\d{1,2}[\-\/]\d{1,2}/, /\d{1,2}[\-\/]\d{1,2}[\-\/]\d{4}/, /\d{4}\d{2}\d{2}/];
            
            // ä¸ºæ¯åˆ—è®¡ç®—ç½®ä¿¡åº¦åˆ†æ•°
            const columnScores = headerRow.map((header, index) => {
                const headerText = String(header).toLowerCase();
                let score = 0;
                
                // æ—¥æœŸåˆ—è¯„åˆ†
                if (dateKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    score += 10; // å…³é”®è¯åŒ¹é…é«˜åˆ†
                }
                
                // æ£€æŸ¥æ—¥æœŸæ ¼å¼æ¨¡å¼
                if (datePatterns.some(pattern => pattern.test(headerText))) {
                    score += 8; // æ—¥æœŸæ ¼å¼åŒ¹é…è¾ƒé«˜åˆ†
                }
                
                // æ£€æŸ¥åˆ—ä½ç½® - æ—¥æœŸåˆ—é€šå¸¸åœ¨å‰å‡ åˆ—
                if (index < 3) {
                    score += 3; // ä½ç½®åŠ åˆ†
                }
                
                return {
                    index,
                    dateScore: score,
                    dataScore: 0,
                    meteringPointScore: 0,
                    multiplierScore: 0
                };
            });
            
            // å¢å¼ºçš„æ•°æ®èµ·å§‹åˆ—è¯†åˆ« - æ™ºèƒ½è¯†åˆ«åŠŸç‡å’Œç”µèƒ½åˆ—
            const powerKeywords = ['åŠŸç‡', 'power', 'p', 'kw', 'æœ‰åŠŸ', 'æ— åŠŸ', 'è§†åœ¨', 'ç¬æ—¶', 'å®æ—¶'];
            const energyKeywords = ['ç”µèƒ½', 'ç”µé‡', 'energy', 'kwh', 'ç´¯ç§¯', 'æ€»é‡', 'ç”¨ç”µé‡', 'è€—ç”µé‡'];
            const generalDataKeywords = ['æ•°æ®', 'æ•°å€¼', 'å€¼', 'data', 'value', 'è´Ÿè·', 'è¯»æ•°', 'å¼€å§‹', 'ç”µæµ', 'ç”µå‹'];
            
            // å¢å¼ºçš„æ•°æ®æ ¼å¼æ¨¡å¼
            const powerPatterns = [/kw(?!h)/i, /åŠŸç‡/i, /\bp\b/i, /æœ‰åŠŸ|æ— åŠŸ|è§†åœ¨/i];
            const energyPatterns = [/kwh/i, /ç”µèƒ½|ç”µé‡/i, /ç´¯ç§¯|æ€»é‡/i, /ç”¨ç”µé‡|è€—ç”µé‡/i];
            const numericPatterns = [/\d+\.?\d*/, /\d{1,2}:\d{2}/, /[0-9]+/];
            const unitPatterns = [/kw|kva|kvar|a|v|kwh/i];
            
            // ä¸ºæ¯åˆ—è®¡ç®—å¢å¼ºçš„æ•°æ®åˆ—ç½®ä¿¡åº¦åˆ†æ•°
            columnScores.forEach(scoreObj => {
                const headerText = String(headerRow[scoreObj.index]).toLowerCase().trim();
                const originalText = String(headerRow[scoreObj.index]).trim();
                
                // åŠŸç‡åˆ—ä¸“é¡¹è¯†åˆ«ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                let powerScore = 0;
                powerKeywords.forEach(keyword => {
                    if (headerText.includes(keyword.toLowerCase())) {
                        powerScore += keyword === 'kw' ? 15 : 12; // kWå•ä½æœ€é«˜åˆ†
                    }
                });
                
                // ç”µèƒ½åˆ—ä¸“é¡¹è¯†åˆ«ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                let energyScore = 0;
                energyKeywords.forEach(keyword => {
                    if (headerText.includes(keyword.toLowerCase())) {
                        energyScore += keyword === 'kwh' ? 15 : 12; // kWhå•ä½æœ€é«˜åˆ†
                    }
                });
                
                // é€šç”¨æ•°æ®åˆ—è¯†åˆ«
                let generalScore = 0;
                generalDataKeywords.forEach(keyword => {
                    if (headerText.includes(keyword.toLowerCase())) {
                        generalScore += 8;
                    }
                });
                
                // æ¨¡å¼åŒ¹é…åŠ åˆ†
                if (powerPatterns.some(pattern => pattern.test(originalText))) {
                    powerScore += 10;
                }
                if (energyPatterns.some(pattern => pattern.test(originalText))) {
                    energyScore += 10;
                }
                if (numericPatterns.some(pattern => pattern.test(headerText))) {
                    generalScore += 6;
                }
                if (unitPatterns.some(pattern => pattern.test(headerText))) {
                    generalScore += 8;
                }
                
                // æ—¶é—´åºåˆ—æ¨¡å¼è¯†åˆ«ï¼ˆå¦‚0:00, 1:00ç­‰ï¼‰
                if (/\d{1,2}:\d{2}/.test(headerText)) {
                    generalScore += 7;
                }
                
                // ä½ç½®æƒé‡ - æ•°æ®åˆ—é€šå¸¸åœ¨æ—¥æœŸåˆ—ä¹‹å
                let positionBonus = 0;
                if (scoreObj.index > 0 && scoreObj.index < headerRow.length - 2) {
                    positionBonus = 2;
                }
                
                // è®¡ç®—æœ€ç»ˆæ•°æ®åˆ—åˆ†æ•°ï¼ˆå–æœ€é«˜åˆ†ç±»å‹ï¼‰
                const maxTypeScore = Math.max(powerScore, energyScore, generalScore);
                scoreObj.dataScore += maxTypeScore + positionBonus;
                
                // è®°å½•åˆ—ç±»å‹ä¿¡æ¯ç”¨äºåç»­å¤„ç†
                scoreObj.columnType = powerScore > energyScore && powerScore > generalScore ? 'power' :
                                    energyScore > powerScore && energyScore > generalScore ? 'energy' : 'general';
                scoreObj.typeScore = maxTypeScore;
            });
            
            // æ ¹æ®ç½®ä¿¡åº¦åˆ†æ•°é€‰æ‹©æ—¥æœŸåˆ—
            const dateCandidates = columnScores
                .filter(scoreObj => scoreObj.dateScore > 0)
                .sort((a, b) => b.dateScore - a.dateScore);
            
            if (dateCandidates.length > 0) {
                dateColumnIndex = dateCandidates[0].index;
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ—¥æœŸåˆ—ï¼Œå°è¯•ä½¿ç”¨å¯å‘å¼æ–¹æ³•æŸ¥æ‰¾
            if (dateColumnIndex === -1) {
                console.log('æœªæ‰¾åˆ°æ—¥æœŸåˆ—ï¼Œä½¿ç”¨å¯å‘å¼æ–¹æ³•æ£€æµ‹...');
                
                // æ£€æŸ¥æ¯åˆ—çš„å®é™…æ•°æ®å†…å®¹
                for (let col = 0; col < headerRow.length; col++) {
                    let dateCount = 0;
                    let totalCount = 0;
                    
                    // æ£€æŸ¥è¯¥åˆ—çš„æ•°æ®
                    for (let row = 1; row < Math.min(20, data.length); row++) {
                        const cellValue = data[row] && data[row][col];
                        if (cellValue) {
                            totalCount++;
                            if (isDateLike(String(cellValue))) {
                                dateCount++;
                            }
                        }
                    }
                    
                    // å¦‚æœè¯¥åˆ—ä¸­è¶…è¿‡70%çš„æ•°æ®æ˜¯æ—¥æœŸæ ¼å¼
                    if (totalCount > 0 && dateCount / totalCount > 0.7) {
                        dateColumnIndex = col;
                        console.log(`å¯å‘å¼æ–¹æ³•æ‰¾åˆ°æ—¥æœŸåˆ—: åˆ—${col}, æ—¥æœŸæ¯”ä¾‹: ${dateCount}/${totalCount}`);
                        break;
                    }
                }
            }
            
            // æ™ºèƒ½é€‰æ‹©æ•°æ®èµ·å§‹åˆ— - ä¼˜å…ˆåŠŸç‡/ç”µèƒ½åˆ—
            const dataStartCandidates = columnScores
                .filter(scoreObj => scoreObj.dataScore > 0 && scoreObj.index !== dateColumnIndex)
                .sort((a, b) => {
                    // ä¼˜å…ˆçº§æ’åºï¼šåŠŸç‡åˆ— > ç”µèƒ½åˆ— > é€šç”¨æ•°æ®åˆ—
                    const aPriority = a.columnType === 'power' ? 3 : a.columnType === 'energy' ? 2 : 1;
                    const bPriority = b.columnType === 'power' ? 3 : b.columnType === 'energy' ? 2 : 1;
                    
                    if (aPriority !== bPriority) {
                        return bPriority - aPriority; // ä¼˜å…ˆçº§é«˜çš„åœ¨å‰
                    }
                    return b.dataScore - a.dataScore; // åŒä¼˜å…ˆçº§æŒ‰åˆ†æ•°æ’åº
                });
            
            if (dataStartCandidates.length > 0) {
                dataStartColumnIndex = dataStartCandidates[0].index;
                console.log(`æ™ºèƒ½è¯†åˆ«æ•°æ®èµ·å§‹åˆ—: åˆ—${dataStartColumnIndex}, ç±»å‹: ${dataStartCandidates[0].columnType}, åˆ†æ•°: ${dataStartCandidates[0].dataScore}`);
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ•°æ®èµ·å§‹åˆ—ï¼Œå°è¯•æŸ¥æ‰¾åŒ…å«æ•°å­—çš„åˆ—
                for (let i = 0; i < headerRow.length; i++) {
                    // è·³è¿‡å·²ç»è¯†åˆ«ä¸ºæ—¥æœŸçš„åˆ—
                    if (i === dateColumnIndex) continue;
                    
                    const headerText = String(headerRow[i]);
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­—
                    if (/\d+/.test(headerText)) {
                        dataStartColumnIndex = i;
                        console.log(`å¤‡ç”¨æ–¹æ³•æ‰¾åˆ°æ•°æ®èµ·å§‹åˆ—: åˆ—${i}`);
                        break;
                    }
                }
            }
            
            // æ™ºèƒ½è¯†åˆ«æ•°æ®ç»“æŸåˆ— - åŸºäºå¢å¼ºçš„åˆ—ç±»å‹è¯†åˆ«
            if (dataStartColumnIndex !== -1) {
                // è·å–æ‰€æœ‰æœ‰æ•ˆçš„æ•°æ®åˆ—ï¼ˆåŠŸç‡ã€ç”µèƒ½ã€é€šç”¨æ•°æ®åˆ—ï¼‰
                const validDataColumns = columnScores
                    .filter(scoreObj => scoreObj.dataScore > 0 && 
                                      scoreObj.index !== dateColumnIndex &&
                                      scoreObj.index >= dataStartColumnIndex)
                    .sort((a, b) => a.index - b.index); // æŒ‰åˆ—ç´¢å¼•æ’åº
                
                if (validDataColumns.length > 0) {
                    // æ‰¾åˆ°æœ€åä¸€ä¸ªè¿ç»­çš„æ•°æ®åˆ—
                    let lastConsecutiveIndex = dataStartColumnIndex;
                    
                    for (let i = 0; i < validDataColumns.length; i++) {
                        const currentCol = validDataColumns[i];
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸å‰ä¸€åˆ—è¿ç»­ï¼ˆå…è®¸è·³è¿‡1-2åˆ—çš„é—´éš”ï¼‰
                        if (i === 0 || currentCol.index - validDataColumns[i-1].index <= 3) {
                            lastConsecutiveIndex = currentCol.index;
                        } else {
                            break; // é‡åˆ°è¾ƒå¤§é—´éš”ï¼Œåœæ­¢
                        }
                    }
                    
                    dataEndColumnIndex = lastConsecutiveIndex;
                    console.log(`æ™ºèƒ½è¯†åˆ«æ•°æ®ç»“æŸåˆ—: åˆ—${dataEndColumnIndex}, æ•°æ®åˆ—èŒƒå›´: ${dataStartColumnIndex}-${dataEndColumnIndex}`);
                } else {
                    // å¤‡ç”¨æ–¹æ³•ï¼šæŸ¥æ‰¾è¿ç»­çš„æ•°å­—åˆ—
                    let consecutiveDataColumns = 0;
                    let maxConsecutive = 0;
                    let bestEndIndex = dataStartColumnIndex;
                    
                    for (let i = dataStartColumnIndex; i < headerRow.length; i++) {
                        if (i === dateColumnIndex) continue;
                        
                        const headerText = String(headerRow[i]).toLowerCase();
                        const isDataColumn = /\d+/.test(headerText) || 
                                           powerKeywords.some(kw => headerText.includes(kw)) ||
                                           energyKeywords.some(kw => headerText.includes(kw)) ||
                                           generalDataKeywords.some(kw => headerText.includes(kw));
                        
                        if (isDataColumn) {
                            consecutiveDataColumns++;
                            if (consecutiveDataColumns > maxConsecutive) {
                                maxConsecutive = consecutiveDataColumns;
                                bestEndIndex = i;
                            }
                        } else {
                            consecutiveDataColumns = 0;
                        }
                    }
                    
                    dataEndColumnIndex = bestEndIndex;
                    console.log(`å¤‡ç”¨æ–¹æ³•è¯†åˆ«æ•°æ®ç»“æŸåˆ—: åˆ—${dataEndColumnIndex}`);
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ•°æ®èµ·å§‹åˆ—ï¼Œé»˜è®¤æœ€åä¸€åˆ—ä¸ºæ•°æ®ç»“æŸåˆ—
                dataEndColumnIndex = headerRow.length - 1;
                console.log(`é»˜è®¤æ•°æ®ç»“æŸåˆ—: åˆ—${dataEndColumnIndex}`);
            }
            
            // è¯†åˆ«è®¡é‡ç‚¹ç¼–å·åˆ—
            const meteringPointKeywords = ['ç¼–å·', 'id', 'æ ‡è¯†', 'ä»£ç ', 'è®¾å¤‡å·', 'è®¾å¤‡ç¼–å·', 'è®¡é‡ç‚¹', 'æµ‹ç‚¹', 'ç‚¹ä½', 'åºå·', 'no'];
            const meteringPointPatterns = [/^\d+$/, /^[A-Za-z]\d+$/, /^\d{4,}$/]; // çº¯æ•°å­—ã€å­—æ¯+æ•°å­—ã€é•¿æ•°å­—
            
            // ä¸ºæ¯åˆ—è®¡ç®—è®¡é‡ç‚¹ç¼–å·åˆ—ç½®ä¿¡åº¦åˆ†æ•°
            columnScores.forEach(scoreObj => {
                const headerText = String(headerRow[scoreObj.index]).toLowerCase();
                
                // è®¡é‡ç‚¹ç¼–å·åˆ—è¯„åˆ†
                if (meteringPointKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    scoreObj.meteringPointScore += 10; // å…³é”®è¯åŒ¹é…é«˜åˆ†
                }
                
                // æ£€æŸ¥è®¡é‡ç‚¹ç¼–å·æ ¼å¼æ¨¡å¼
                if (meteringPointPatterns.some(pattern => pattern.test(headerText))) {
                    scoreObj.meteringPointScore += 8; // æ ¼å¼åŒ¹é…è¾ƒé«˜åˆ†
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«IDç›¸å…³ç¼©å†™
                if (headerText.includes('id') || headerText.includes('no') || headerText.includes('num')) {
                    scoreObj.meteringPointScore += 7; // IDç›¸å…³ç¼©å†™åŒ¹é…
                }
                
                // æ£€æŸ¥åˆ—ä½ç½® - è®¡é‡ç‚¹ç¼–å·åˆ—é€šå¸¸åœ¨å‰å‡ åˆ—ï¼Œä½†å¯èƒ½åœ¨æ—¥æœŸåˆ—ä¹‹å
                if (scoreObj.index > 0 && scoreObj.index < 5) {
                    scoreObj.meteringPointScore += 2; // ä½ç½®åŠ åˆ†
                }
            });
            
            // æ ¹æ®ç½®ä¿¡åº¦åˆ†æ•°é€‰æ‹©è®¡é‡ç‚¹ç¼–å·åˆ—
            const meteringPointCandidates = columnScores
                .filter(scoreObj => scoreObj.meteringPointScore > 0 && 
                                 scoreObj.index !== dateColumnIndex && 
                                 scoreObj.index !== dataStartColumnIndex &&
                                 scoreObj.index !== dataEndColumnIndex)
                .sort((a, b) => b.meteringPointScore - a.meteringPointScore);
            
            if (meteringPointCandidates.length > 0) {
                meteringPointColumnIndex = meteringPointCandidates[0].index;
            }
            
            // å¦‚æœè¯†åˆ«åˆ°äº†åˆ—ï¼Œè®¾ç½®é»˜è®¤å€¼
            if (dateColumnIndex !== -1) {
                elements.dateColumnSelect.value = dateColumnIndex;
                appData.config.dateColumn = dateColumnIndex;
            }
            
            if (dataStartColumnIndex !== -1) {
                elements.dataStartColumnSelect.value = dataStartColumnIndex;
                appData.config.dataStartColumn = dataStartColumnIndex;
            }
            
            if (dataEndColumnIndex !== -1) {
                elements.dataEndColumnSelect.value = dataEndColumnIndex;
                appData.config.dataEndColumn = dataEndColumnIndex;
            }
            
            if (meteringPointColumnIndex !== -1) {
                elements.meteringPointColumnSelect.value = meteringPointColumnIndex;
                appData.config.meteringPointColumn = meteringPointColumnIndex;
            }
            
            // å¦‚æœè¯†åˆ«åˆ°äº†ä»»ä½•åˆ—ï¼Œè§¦å‘æ•°æ®é¢„è§ˆ
            if (dateColumnIndex !== -1 && dataStartColumnIndex !== -1) {
                updateDataPreview();
                checkConfigValidity();
                
                // æ˜¾ç¤ºè¯¦ç»†è¯†åˆ«ç»“æœ
                console.log('=== æ™ºèƒ½åˆ—è¯†åˆ«ç»“æœ ===');
                console.log(`æ—¥æœŸåˆ—ç´¢å¼•: ${dateColumnIndex}`);
                console.log(`æ—¥æœŸåˆ—æ ‡é¢˜: ${headerRow[dateColumnIndex] || 'æ— æ ‡é¢˜'}`);
                
                // æ˜¾ç¤ºæ•°æ®åˆ—è¯†åˆ«è¯¦æƒ…
                const selectedDataColumn = columnScores.find(score => score.index === dataStartColumnIndex);
                if (selectedDataColumn) {
                    console.log(`æ•°æ®èµ·å§‹åˆ—ç´¢å¼•: ${dataStartColumnIndex}`);
                    console.log(`æ•°æ®èµ·å§‹åˆ—æ ‡é¢˜: ${headerRow[dataStartColumnIndex] || 'æ— æ ‡é¢˜'}`);
                    console.log(`è¯†åˆ«ç±»å‹: ${selectedDataColumn.columnType} (åŠŸç‡/ç”µèƒ½/é€šç”¨)`);
                    console.log(`ç½®ä¿¡åº¦åˆ†æ•°: ${selectedDataColumn.dataScore}`);
                }
                
                // æ˜¾ç¤ºæ‰€æœ‰å€™é€‰æ•°æ®åˆ—çš„è¯¦ç»†ä¿¡æ¯
                const allDataCandidates = columnScores
                    .filter(score => score.dataScore > 0 && score.index !== dateColumnIndex)
                    .sort((a, b) => b.dataScore - a.dataScore);
                
                if (allDataCandidates.length > 1) {
                    console.log('=== å…¶ä»–æ•°æ®åˆ—å€™é€‰ ===');
                    allDataCandidates.slice(1, 4).forEach((candidate, index) => {
                        console.log(`å€™é€‰${index + 1}: åˆ—${candidate.index} "${headerRow[candidate.index]}" (${candidate.columnType}, åˆ†æ•°:${candidate.dataScore})`);
                    });
                }
                console.log(`æ•°æ®èµ·å§‹åˆ—: ${dataStartColumnIndex}`);
                console.log(`æ•°æ®ç»“æŸåˆ—: ${dataEndColumnIndex}`);
                console.log(`è®¡é‡ç‚¹åˆ—: ${meteringPointColumnIndex}`);
                
                // æ˜¾ç¤ºå‰å‡ ä¸ªæ—¥æœŸçš„è§£æç¤ºä¾‹
                if (data.length > 1) {
                    console.log('=== æ—¥æœŸè§£æç¤ºä¾‹ ===');
                    for (let i = 1; i < Math.min(6, data.length); i++) {
                        if (data[i] && data[i][dateColumnIndex]) {
                            const dateValue = String(data[i][dateColumnIndex]).trim();
                            const parsedDate = parseDate(dateValue, appData.config.dateFormat);
                            console.log(`ç¬¬${i}è¡Œ: "${dateValue}" -> ${parsedDate ? formatDateForInput(parsedDate) : 'è§£æå¤±è´¥'}`);
                        }
                    }
                }
            } else {
                console.log('=== åˆ—è¯†åˆ«å¤±è´¥ ===');
                console.log('è¯·æ£€æŸ¥æ•°æ®æ ¼å¼æˆ–æ‰‹åŠ¨é€‰æ‹©åˆ—');
                
                // æ˜¾ç¤ºåˆ—ä¿¡æ¯ä¾›è°ƒè¯•
                console.log('=== æ‰€æœ‰åˆ—æ ‡é¢˜ ===');
                headerRow.forEach((header, index) => {
                    console.log(`åˆ—${index}: "${header}"`);
                });
            }
        }

        // é…ç½®éƒ¨åˆ†å‡½æ•°
        function updateDateSelects() {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            elements.dataStartDate.innerHTML = '<option value="">-- è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸ --</option>';
            elements.dataEndDate.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ --</option>';
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¥æœŸåˆ—ï¼Œåˆ™è¿”å›ï¼ˆæ³¨æ„ï¼šåˆ—ç´¢å¼•0ä¹Ÿæ˜¯æœ‰æ•ˆçš„ï¼‰
            if (appData.config.dateColumn === undefined || appData.config.dateColumn === null || appData.config.dateColumn === '') return;
            
            const dateCol = parseInt(appData.config.dateColumn);
            const dateSet = new Set();
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„æ—¥æœŸ
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // è·³è¿‡è¡¨å¤´è¡Œï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹æ•°æ®èµ·å§‹è¡Œ
                let startRow = 0;
                let dateFoundCount = 0;
                
                for (let i = 0; i < Math.min(15, data.length); i++) {
                    if (data[i] && data[i][dateCol]) {
                        const cellValue = String(data[i][dateCol]).trim();
                        console.log(`æ£€æŸ¥ç¬¬${i+1}è¡Œæ—¥æœŸåˆ—: "${cellValue}"`);
                        
                        if (isDateLike(cellValue)) {
                            const parsedDate = parseDate(cellValue, appData.config.dateFormat);
                            console.log(`æ—¥æœŸè§£æç»“æœ:`, parsedDate);
                            
                            if (parsedDate) {
                                startRow = i;
                                dateFoundCount++;
                                break;
                            }
                        }
                    }
                }
                
                console.log(`ç¡®å®šæ•°æ®èµ·å§‹è¡Œ: ${startRow + 1}, æ‰¾åˆ°æœ‰æ•ˆæ—¥æœŸ: ${dateFoundCount}ä¸ª`);
                
                // æ”¶é›†æ—¥æœŸ
                let validDatesFound = 0;
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[dateCol]) continue;
                    
                    const dateStr = String(row[dateCol]).trim();
                    if (!dateStr) continue;
                    
                    // è§£ææ—¥æœŸ
                    const date = parseDate(dateStr, appData.config.dateFormat);
                    if (date) {
                        const dateKey = formatDateForInput(date);
                        dateSet.add(dateKey);
                        validDatesFound++;
                        
                        // è®°å½•å‰5ä¸ªè§£ææˆåŠŸçš„æ—¥æœŸç”¨äºè°ƒè¯•
                        if (validDatesFound <= 5) {
                            console.log(`æˆåŠŸè§£ææ—¥æœŸ ${validDatesFound}: "${dateStr}" -> "${dateKey}"`);
                        }
                    } else {
                        // è®°å½•è§£æå¤±è´¥çš„æ—¥æœŸ
                        if (validDatesFound <= 5) {
                            console.log(`æ—¥æœŸè§£æå¤±è´¥: "${dateStr}"`);
                        }
                    }
                }
                
                console.log(`å·¥ä½œè¡¨ä¸­æ‰¾åˆ°çš„æœ‰æ•ˆæ—¥æœŸæ€»æ•°: ${validDatesFound}`);
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const dates = Array.from(dateSet).sort();
            
            console.log(`æ”¶é›†åˆ°çš„å”¯ä¸€æ—¥æœŸæ•°é‡: ${dates.length}`);
            console.log(`æ‰€æœ‰æ”¶é›†åˆ°çš„æ—¥æœŸ:`, dates);
            
            // å¦‚æœæ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•æ—¥æœŸï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (dates.length === 0) {
                // æ·»åŠ ä¸€ä¸ªæç¤ºé€‰é¡¹
                const option1 = document.createElement('option');
                option1.value = "";
                option1.textContent = "-- æœªæ‰¾åˆ°æœ‰æ•ˆæ—¥æœŸ --";
                option1.disabled = true;
                elements.dataStartDate.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = "";
                option2.textContent = "-- æœªæ‰¾åˆ°æœ‰æ•ˆæ—¥æœŸ --";
                option2.disabled = true;
                elements.dataEndDate.appendChild(option2);
                
                // æ˜¾ç¤ºé€šçŸ¥
                showNotification('æç¤º', 'æœªåœ¨æ•°æ®ä¸­æ‰¾åˆ°æœ‰æ•ˆæ—¥æœŸï¼Œè¯·æ£€æŸ¥æ—¥æœŸåˆ—é€‰æ‹©å’Œæ—¥æœŸæ ¼å¼è®¾ç½®', 'warning');
                return;
            }
            
            // æ·»åŠ åˆ°ä¸‹æ‹‰èœå•
            dates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.dataStartDate.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.dataEndDate.appendChild(option2);
            });
            
            // å¦‚æœä¹‹å‰æœ‰é€‰æ‹©çš„æ—¥æœŸï¼Œæ¢å¤é€‰æ‹©
            if (appData.selectedStartDate) {
                elements.dataStartDate.value = appData.selectedStartDate;
            }
            
            if (appData.selectedEndDate) {
                elements.dataEndDate.value = appData.selectedEndDate;
            }
        }

        // é‡æ–°è®¾è®¡çš„æ•°æ®é¢„è§ˆå‡½æ•°
        function updateDataPreview() {
            console.log('=== å¼€å§‹æ•°æ®é¢„è§ˆæ›´æ–° ===');
            
            // é˜²æŠ–/é˜²é‡å…¥ï¼šé¿å…å¤§æ•°æ®ä¸‹å¤šæ¬¡è§¦å‘å¯¼è‡´é˜»å¡
            if (appData.__isUpdatingPreview) {
                console.log('æ•°æ®é¢„è§ˆæ›´æ–°è¿›è¡Œä¸­ï¼Œæœ¬æ¬¡è°ƒç”¨å·²å¿½ç•¥');
                return;
            }
            
            // æ£€æŸ¥åŸºç¡€é…ç½®
            if (!validateDataConfiguration()) {
                renderWaitingState();
                return;
            }
            
            // å…ˆå±•ç¤ºåŠ è½½æç¤ºï¼Œé¿å…é•¿æ—¶é—´ç©ºç™½
            if (elements.dataPreview && elements.dataPreview.parentNode) {
                elements.dataPreview.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 px-6">
                        <div class="w-12 h-12 mb-3 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                        <div class="text-sm text-slate-600">æ­£åœ¨ç”Ÿæˆæ•°æ®é¢„è§ˆï¼Œè¯·ç¨å€™...</div>
                    </div>`;
            }
            
            // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
            updateDateSelects();
            
            // å¼‚æ­¥è°ƒåº¦é‡å‹è§£æä¸æ¸²æŸ“ï¼Œé‡Šæ”¾UIçº¿ç¨‹
            appData.__isUpdatingPreview = true;
            setTimeout(() => {
                try {
                    // è§£æå·¥ä½œè¡¨æ•°æ®
                    parseWorksheetData();
                    
                    // æ£€æŸ¥è§£æåçš„æ•°æ®
                    if (appData.processedData.length === 0) {
                        renderNoDataState();
                        return;
                    }
                    
                    // æ¸²æŸ“æ•°æ®é¢„è§ˆç•Œé¢
                    renderDataPreview();
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updatePreviewButtons();
                    
                    console.log('=== æ•°æ®é¢„è§ˆæ›´æ–°å®Œæˆ ===');
                } finally {
                    appData.__isUpdatingPreview = false;
                }
            }, 0);
        }
        
        // éªŒè¯æ•°æ®é…ç½®
        function validateDataConfiguration() {
            const hasWorksheets = Array.isArray(appData.worksheets) && appData.worksheets.length > 0;
            const hasDateColumn = appData.config.dateColumn !== undefined && appData.config.dateColumn !== null && appData.config.dateColumn !== '';
            const hasDataStartColumn = appData.config.dataStartColumn !== undefined && appData.config.dataStartColumn !== null && appData.config.dataStartColumn !== '';
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked')?.value;
            
            // å¯¹äºåˆ—å¯¹è¡Œç»“æ„ï¼Œéœ€è¦æ•°æ®ç»“æŸåˆ—ï¼›å¯¹äºåˆ—å¯¹åˆ—ç»“æ„ï¼Œä¸éœ€è¦
            let hasRequiredColumns = true;
            if (dataStructure === 'columnToRow') {
                hasRequiredColumns = (appData.config.dataEndColumn !== undefined && appData.config.dataEndColumn !== null && appData.config.dataEndColumn !== '');
            }
            
            console.log('éªŒè¯é…ç½®çŠ¶æ€:');
            console.log('- å·¥ä½œè¡¨:', hasWorksheets);
            console.log('- æ—¥æœŸåˆ—:', hasDateColumn);
            console.log('- æ•°æ®å¼€å§‹åˆ—:', hasDataStartColumn);
            console.log('- æ•°æ®ç»“æ„:', dataStructure);
            console.log('- å¿…éœ€åˆ—é…ç½®:', hasRequiredColumns);
            
            return hasWorksheets && hasDateColumn && hasDataStartColumn && hasRequiredColumns;
        }
        
        // æ¸²æŸ“ç­‰å¾…é…ç½®çŠ¶æ€
        function renderWaitingState() {
            elements.dataPreview.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-8">
                    <div class="w-20 h-20 mb-6 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl flex items-center justify-center shadow-lg">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3">ç­‰å¾…æ•°æ®é…ç½®</h3>
                    <p class="text-sm text-slate-600 text-center max-w-lg leading-relaxed mb-6">
                        è¯·å®Œæˆä»¥ä¸‹æ­¥éª¤ä»¥å¼€å§‹æ•°æ®é¢„è§ˆï¼š<br>
                        1. å¯¼å…¥Excelæ–‡ä»¶<br>
                        2. é…ç½®æ—¥æœŸåˆ—å’Œæ•°æ®å¼€å§‹åˆ—<br>
                        3. å¦‚é€‰æ‹©"åˆ—å¯¹è¡Œ"ç»“æ„ï¼Œè¿˜éœ€é…ç½®æ•°æ®ç»“æŸåˆ—
                    </p>
                    <div class="flex space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-3 h-3 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“æ— æ•°æ®çŠ¶æ€
        function renderNoDataState() {
            elements.dataPreview.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-8">
                    <div class="w-20 h-20 mb-6 bg-gradient-to-br from-amber-100 to-orange-100 rounded-2xl flex items-center justify-center shadow-lg">
                        <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3">æš‚æ— æœ‰æ•ˆæ•°æ®</h3>
                    <p class="text-sm text-slate-600 text-center max-w-lg leading-relaxed">
                        å½“å‰é…ç½®ä¸‹æ²¡æœ‰æ‰¾åˆ°å¯é¢„è§ˆçš„æ•°æ®ã€‚<br>
                        è¯·æ£€æŸ¥æ•°æ®æºæ–‡ä»¶æˆ–è°ƒæ•´é…ç½®å‚æ•°ã€‚
                    </p>
                </div>
            `;
        }
        
        // æ¸²æŸ“æ•°æ®é¢„è§ˆç•Œé¢
        function renderDataPreview() {
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // æ„å»ºé¢„è§ˆHTML
            let previewHtml = buildDataSummaryHeader();
            previewHtml += buildDataTable(dataStructure);
            previewHtml += buildDataStatistics();
            
            elements.dataPreview.innerHTML = previewHtml;
            
            // æ·»åŠ äº¤äº’åŠŸèƒ½
            attachDataPreviewEvents();
        }
        
        // æ„å»ºæ•°æ®æ±‡æ€»å¤´éƒ¨
        function buildDataSummaryHeader() {
            const totalRecords = appData.processedData.length;
            const dateRange = getDataDateRange();
            
            let headerHtml = `
                <div class="bg-gradient-to-r from-emerald-50 via-blue-50 to-purple-50 p-6 mb-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-slate-800">æ•°æ®é¢„è§ˆ</h3>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-slate-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>æ€»è®¡ <span class="font-bold text-blue-600">${totalRecords}</span> æ¡è®°å½•</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white/70 backdrop-blur-sm p-4 rounded-xl border border-slate-200">
                            <div class="text-sm text-slate-600 mb-1">æ•°æ®èŒƒå›´</div>
                            <div class="font-semibold text-slate-800">${dateRange}</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm p-4 rounded-xl border border-slate-200">
                            <div class="text-sm text-slate-600 mb-1">æ•°æ®ç»“æ„</div>
                            <div class="font-semibold text-slate-800">${getDataStructureLabel()}</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm p-4 rounded-xl border border-slate-200">
                            <div class="text-sm text-slate-600 mb-1">ç­›é€‰çŠ¶æ€</div>
                            <div class="font-semibold text-slate-800">${getFilterStatus()}</div>
                        </div>
                    </div>`;
            
            // æ·»åŠ æ¸…é™¤ç­›é€‰æŒ‰é’®
            if (appData.selectedStartDate || appData.selectedEndDate) {
                headerHtml += `
                    <div class="mt-4 flex justify-end">
                        <button onclick="clearDateRange()" class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-sm font-medium rounded-xl hover:from-red-600 hover:to-pink-600 transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>æ¸…é™¤æ—¥æœŸç­›é€‰</span>
                        </button>
                    </div>`;
            }
            
            headerHtml += `</div>`;
            return headerHtml;
        }
        
        // æ„å»ºæ•°æ®è¡¨æ ¼
         function buildDataTable(dataStructure) {
             let tableHtml = `<div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden mb-6">`;
             tableHtml += `<div class="max-h-96 overflow-auto">`;
             
             if (dataStructure === 'columnToRow') {
                 tableHtml += buildHourlyDataTable();
             } else {
                 tableHtml += buildSummaryDataTable();
             }
             
             tableHtml += `</div></div>`;
             return tableHtml;
         }
         
         // æ„å»º24å°æ—¶æ•°æ®è¡¨æ ¼
         function buildHourlyDataTable() {
             let tableHtml = `<div class="grid" style="grid-template-columns: 120px repeat(24, 80px) 120px; min-width: fit-content;">`;
             
             // è¡¨å¤´
             tableHtml += `<div class=\"bg-slate-100 border-b border-r border-slate-200 px-3 py-3 text-center font-semibold text-slate-800 sticky top-0 z-10 text-sm shadow-sm\">æ—¥æœŸ</div>`;
             for (let hour = 0; hour < 24; hour++) {
                tableHtml += `<div class=\"bg-slate-100 border-b border-r border-slate-200 px-2 py-3 text-center font-semibold text-slate-800 sticky top-0 z-10 text-sm shadow-sm\">${hour}:00</div>`;
            }
             tableHtml += `<div class=\"bg-slate-100 border-b border-r border-slate-200 px-3 py-3 text-center font-semibold text-slate-800 sticky top-0 z-10 text-sm shadow-sm\">æ—¥æ€»ç”µèƒ½ (kWh)</div>`;
             
             // ä»…é¢„è§ˆå‰100æ¡ï¼Œé¿å…å¤§æ•°æ®æ¸²æŸ“é˜»å¡
             const previewLimit = 100;
             const rows = appData.processedData.slice(0, previewLimit);
             
             // æ•°æ®è¡Œ
             rows.forEach((row, index) => {
                 const isSelected = appData.selectedStartDate && appData.selectedEndDate && 
                                   row.date >= appData.selectedStartDate && 
                                   row.date <= appData.selectedEndDate;
                 const rowBgClass = isSelected ? 'bg-blue-50' : (index % 2 === 0 ? 'bg-white' : 'bg-slate-50');
                 
                 // æ—¥æœŸåˆ—
                 tableHtml += `<div class=\"${rowBgClass} border-b border-r border-slate-200 px-3 py-3 text-center font-medium hover:bg-slate-100 transition-colors cursor-pointer\" data-date=\"${row.date}\">${row.date}</div>`;
                 
                 // 24å°æ—¶æ•°æ®åˆ—
                 let dayTotal = 0;
                 for (let hour = 0; hour < 24; hour++) {
                     const value = row.hourlyData[hour];
                     const displayValue = (value !== null && value !== undefined) ? value.toFixed(2) : '-';
                     const textClass = (value !== null && value !== undefined) ? 'text-slate-900' : 'text-slate-400';
                     const bgClass = (value !== null && value !== undefined) ? 
                         (value > 0 ? 'hover:bg-green-50' : 'hover:bg-slate-100') : 'hover:bg-slate-100';
                     tableHtml += `<div class=\"${rowBgClass} border-b border-r border-slate-200 px-2 py-3 text-center ${textClass} ${bgClass} transition-colors text-sm\">${displayValue}</div>`;
                     if (value !== null && value !== undefined) {
                         dayTotal += value;
                     }
                 }
                 
                 // æ—¥æ€»ç”µèƒ½åˆ—
                 tableHtml += `<div class=\"${rowBgClass} border-b border-r border-slate-200 px-3 py-3 text-center font-semibold text-blue-600 hover:bg-blue-50 transition-colors text-sm\">${dayTotal.toFixed(2)}</div>`;
             });
             
             tableHtml += `</div>`;
             
             // å¤§æ•°æ®æç¤º
             if (appData.processedData.length > previewLimit) {
                tableHtml += `<div class=\"px-4 py-2 text-xs text-slate-500 bg-slate-50 border border-t-0 border-slate-200 rounded-b-2xl\">ä¸ºä¿è¯æ€§èƒ½ï¼Œé¢„è§ˆä»…æ˜¾ç¤ºå‰ ${previewLimit} æ¡è®°å½•ï¼ˆå®é™…å…± ${appData.processedData.length} æ¡ï¼‰ã€‚</div>`;
             }
             return tableHtml;
         }
         
         // æ„å»ºæ±‡æ€»æ•°æ®è¡¨æ ¼
         function buildSummaryDataTable() {
             // ç»Ÿä¸€ä½¿ç”¨24å°æ—¶è¯¦ç»†æ•°æ®è¡¨æ ¼ï¼Œè€Œä¸æ˜¯æ±‡æ€»è¡¨æ ¼
             return buildHourlyDataTable();
         }
         
         // æ„å»ºæ•°æ®ç»Ÿè®¡ä¿¡æ¯
          function buildDataStatistics() {
              if (appData.processedData.length === 0) return '';
              
              const totalRecords = appData.processedData.length;
              const validDataCount = appData.processedData.reduce((sum, row) => {
                  return sum + row.hourlyData.filter(v => v !== null && v !== undefined).length;
              }, 0);
              const totalEnergy = appData.processedData.reduce((sum, row) => sum + (row.dailyTotal || 0), 0);
              const avgDailyEnergy = totalEnergy / totalRecords;
              
              return `
                  <div class="bg-gradient-to-r from-slate-50 to-gray-50 p-6 rounded-2xl border border-slate-200 shadow-sm">
                      <div class="flex items-center justify-center mb-4">
                          <svg class="w-5 h-5 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                          </svg>
                          <h4 class="text-lg font-bold text-slate-800">æ•°æ®ç»Ÿè®¡</h4>
                      </div>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div class="text-center">
                              <div class="text-2xl font-bold text-blue-600">${totalRecords}</div>
                              <div class="text-sm text-slate-600">æ€»å¤©æ•°</div>
                          </div>
                          <div class="text-center">
                              <div class="text-2xl font-bold text-green-600">${validDataCount}</div>
                              <div class="text-sm text-slate-600">æœ‰æ•ˆæ•°æ®ç‚¹</div>
                          </div>
                          <div class="text-center">
                              <div class="text-2xl font-bold text-purple-600">${totalEnergy.toFixed(1)}</div>
                              <div class="text-sm text-slate-600">æ€»ç”µèƒ½ (kWh)</div>
                          </div>
                          <div class="text-center">
                              <div class="text-2xl font-bold text-orange-600">${avgDailyEnergy.toFixed(1)}</div>
                              <div class="text-sm text-slate-600">æ—¥å‡ç”µèƒ½ (kWh)</div>
                          </div>
                      </div>
                  </div>
              `;
          }
          
          // è·å–æ•°æ®æ—¥æœŸèŒƒå›´
          function getDataDateRange() {
              if (appData.processedData.length === 0) return 'æ— æ•°æ®';
              const firstDate = appData.processedData[0].date;
              const lastDate = appData.processedData[appData.processedData.length - 1].date;
              return firstDate === lastDate ? firstDate : `${firstDate} ~ ${lastDate}`;
          }
          
          // è·å–æ•°æ®ç»“æ„æ ‡ç­¾
          function getDataStructureLabel() {
              const dataStructure = document.querySelector('input[name="dataStructure"]:checked')?.value;
              return dataStructure === 'columnToRow' ? 'åˆ—å¯¹è¡Œ (24å°æ—¶)' : 'åˆ—å¯¹åˆ— (æ±‡æ€»)';
          }
          
          // è·å–ç­›é€‰çŠ¶æ€
          function getFilterStatus() {
              if (appData.selectedStartDate && appData.selectedEndDate) {
                  return `å·²ç­›é€‰ (${appData.selectedStartDate} ~ ${appData.selectedEndDate})`;
              } else if (appData.selectedStartDate) {
                  return `èµ·å§‹æ—¥æœŸ: ${appData.selectedStartDate}`;
              } else if (appData.selectedEndDate) {
                  return `ç»“æŸæ—¥æœŸ: ${appData.selectedEndDate}`;
              }
              return 'æ— ç­›é€‰';
          }
          
          // æ·»åŠ æ•°æ®é¢„è§ˆäº¤äº’äº‹ä»¶
          function attachDataPreviewEvents() {
              // æ—¥æœŸç‚¹å‡»äº‹ä»¶ - å¯ä»¥æ‰©å±•ä¸ºé€‰æ‹©æ—¥æœŸèŒƒå›´
              const dateCells = document.querySelectorAll('[data-date]');
              dateCells.forEach(cell => {
                  cell.addEventListener('click', function() {
                      const date = this.getAttribute('data-date');
                      console.log('ç‚¹å‡»æ—¥æœŸ:', date);
                      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ—¥æœŸé€‰æ‹©é€»è¾‘
                  });
              });
          }
          
          // æ¸…é™¤æ—¥æœŸèŒƒå›´ç­›é€‰
          window.clearDateRange = function() {
              appData.selectedStartDate = null;
              appData.selectedEndDate = null;
              elements.dataStartDate.value = '';
              elements.dataEndDate.value = '';
              updateDataPreview();
              showNotification('ä¿¡æ¯', 'å·²æ¸…é™¤æ—¥æœŸç­›é€‰ï¼Œæ˜¾ç¤ºå…¨éƒ¨æ•°æ®', 'info');
          };
          
          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          function updatePreviewButtons() {
              if (appData.parsedData.length > 0) {
                  elements.previewFirstHourCalculationBtn.disabled = false;
                  elements.previewFirstDayCalculationBtn.disabled = false;
              } else {
                  elements.previewFirstHourCalculationBtn.disabled = true;
                  elements.previewFirstDayCalculationBtn.disabled = true;
              }
          }
        
          // æ›´æ–°æ•°æ®çŠ¶æ€æ˜¾ç¤º
          updateDataOverview();

      function parseWorksheetData() {
    // åªåœ¨éè¿½åŠ æ¨¡å¼ä¸‹æ¸…é™¤æ•°æ®
    const appendMode = document.getElementById('appendMode')?.checked || false;
    if (!appendMode) {
        appData.parsedData = [];
        appData.processedData = [];
    } else {
        // è¿½åŠ æ¨¡å¼ä¸‹ä¸æ¸…é™¤ç°æœ‰æ•°æ®ï¼Œä½†ç¡®ä¿æ•°ç»„å­˜åœ¨
        appData.parsedData = appData.parsedData || [];
        appData.processedData = appData.processedData || [];
    }
    
    // è·å–æ•°æ®ç»“æ„ç±»å‹
    const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
    
    appData.worksheets.forEach(worksheet => {
        const { data } = worksheet;
        const dateCol = parseInt(appData.config.dateColumn);
        const startCol = parseInt(appData.config.dataStartColumn);
        const endCol = parseInt(appData.config.dataEndColumn);
        
        // è§£æç”¨æˆ·é€‰æ‹©çš„ç´¢å¼•èŒƒå›´ï¼Œä¼˜å…ˆçº§ï¼šæ•°æ®è¡Œç´¢å¼• > æ—¥æœŸèŒƒå›´ > å…¨éƒ¨æ•°æ®
        let startIndex = 0;
        let endIndex = data.length - 1;
        
        console.log(`å·¥ä½œè¡¨ ${worksheet.name || 'æœªå‘½å'}:`);
        console.log(`- åŸå§‹æ•°æ®æ€»è¡Œæ•°: ${data.length}`);
        console.log(`- é€‰æ‹©çš„æ—¥æœŸèŒƒå›´: ${appData.selectedStartDate || 'æœªé€‰æ‹©'} åˆ° ${appData.selectedEndDate || 'æœªé€‰æ‹©'}`);
        console.log(`- æ•°æ®è¡Œç´¢å¼•èŒƒå›´: ${appData.config.dataStartIndex || 0} åˆ° ${appData.config.dataEndIndex || -1}`);
        
        // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†éé»˜è®¤çš„æ•°æ®è¡Œç´¢å¼•èŒƒå›´ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        const userStartIndex = parseInt(appData.config.dataStartIndex) || 0;
        const userEndIndex = appData.config.dataEndIndex === -1 ? data.length - 1 : parseInt(appData.config.dataEndIndex);
        
        // å¦‚æœç”¨æˆ·è®¾ç½®äº†éé»˜è®¤çš„ç´¢å¼•èŒƒå›´ï¼Œä¼˜å…ˆä½¿ç”¨
        const isUsingCustomIndexRange = userStartIndex !== 0 || (appData.config.dataEndIndex !== -1 && userEndIndex !== (data.length - 1));
        
        if (isUsingCustomIndexRange) {
            startIndex = Math.max(0, Math.min(userStartIndex, data.length - 1));
            endIndex = Math.max(startIndex, Math.min(userEndIndex, data.length - 1));
            console.log(`- ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è¡Œç´¢å¼•èŒƒå›´: ${startIndex} åˆ° ${endIndex}`);
            
            // å¦‚æœç´¢å¼•èŒƒå›´æ— æ•ˆï¼Œç»™å‡ºè­¦å‘Š
            if (startIndex >= data.length || endIndex < 0 || startIndex > endIndex) {
                showNotification('è­¦å‘Š', 'æŒ‡å®šçš„è¡Œç´¢å¼•èŒƒå›´æ— æ•ˆï¼Œå°†ä½¿ç”¨å…¨éƒ¨æ•°æ®', 'warning');
                startIndex = 0;
                endIndex = data.length - 1;
            }
        } else if (appData.selectedStartDate && appData.selectedEndDate) {
            // å¦‚æœç”¨æˆ·è®¾ç½®äº†æ—¥æœŸèŒƒå›´ï¼Œä½¿ç”¨æ—¥æœŸç­›é€‰
            let startFound = false;
            let endFound = false;
            
            // å°†é€‰æ‹©çš„æ—¥æœŸèŒƒå›´è½¬æ¢ä¸ºæ—¥æœŸå¯¹è±¡ï¼ˆç¡®ä¿åŒ…å«è¾¹ç•Œï¼‰
            const selectedStart = new Date(appData.selectedStartDate);
            const selectedEnd = new Date(appData.selectedEndDate);
            
            // è®¾ç½®æ—¶é—´ä¸º0æ—¶0åˆ†0ç§’ï¼Œç¡®ä¿åŒ…å«æ•´å¤©
            selectedStart.setHours(0, 0, 0, 0);
            selectedEnd.setHours(23, 59, 59, 999);
            
            // æ”¶é›†æ‰€æœ‰åœ¨æ—¥æœŸèŒƒå›´å†…çš„è¡Œç´¢å¼•
            const dateRangeIndices = [];
            
            console.log(`- æ­£åœ¨ç­›é€‰æ—¥æœŸèŒƒå›´: ${selectedStart.toISOString()} åˆ° ${selectedEnd.toISOString()}`);
            console.log(`- æ—¥æœŸæ ¼å¼: ${appData.config.dateFormat}`);
            
            // é¦–å…ˆæ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„æ—¥æœŸå’Œè¡Œç´¢å¼•
            const allValidDates = [];
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // è§£ææ—¥æœŸ
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) {
                    console.log(`- ç¬¬${i}è¡Œæ—¥æœŸè§£æå¤±è´¥: "${dateStr}"`);
                    continue;
                }
                
                // æ ‡å‡†åŒ–æ—¥æœŸï¼ˆå»é™¤æ—¶é—´éƒ¨åˆ†ï¼Œåªä¿ç•™å¹´æœˆæ—¥ï¼‰
                const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                normalizedDate.setHours(0, 0, 0, 0); // ç¡®ä¿æ—¶é—´éƒ¨åˆ†ä¸º0
                
                // ä¿å­˜æœ‰æ•ˆæ—¥æœŸä¿¡æ¯
                allValidDates.push({
                    index: i,
                    dateStr: dateStr,
                    date: normalizedDate,
                    formattedDate: formatDateForInput(normalizedDate)
                });
                
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦åœ¨é€‰æ‹©çš„èŒƒå›´å†…ï¼ˆåŒ…å«è¾¹ç•Œï¼‰
                if (normalizedDate >= selectedStart && normalizedDate <= selectedEnd) {
                    dateRangeIndices.push(i);
                }
            }
            
            console.log(`- æ‰¾åˆ° ${allValidDates.length} æ¡æœ‰æ•ˆæ—¥æœŸè®°å½•`);
            console.log(`- æ‰¾åˆ° ${dateRangeIndices.length} æ¡åŒ¹é…çš„è®°å½•`);
            
            // å¦‚æœåœ¨èŒƒå›´å†…æ‰¾åˆ°æ•°æ®ï¼Œè®¾ç½®èµ·å§‹å’Œç»“æŸç´¢å¼•
            if (dateRangeIndices.length > 0) {
                startIndex = Math.min(...dateRangeIndices);
                endIndex = Math.max(...dateRangeIndices);
                startFound = true;
                endFound = true;
            }
            
            // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
            startIndex = Math.max(0, Math.min(startIndex, data.length - 1));
            endIndex = Math.max(startIndex, Math.min(endIndex, data.length - 1));
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŒ¹é…çš„è®°å½•ï¼Œæ£€æŸ¥å¯èƒ½çš„åŸå› 
            if (dateRangeIndices.length === 0) {
                // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„æ—¥æœŸæ ·æœ¬ç”¨äºè°ƒè¯•
                const dateSamples = allValidDates.slice(0, 10).map(item => item.dateStr);
                const formattedSamples = allValidDates.slice(0, 10).map(item => item.formattedDate);
                
                console.log(`- å‰10è¡Œçš„æ—¥æœŸæ ·æœ¬:`, dateSamples);
                console.log(`- å‰10è¡Œçš„æ ¼å¼åŒ–æ—¥æœŸæ ·æœ¬:`, formattedSamples);
                console.log(`- é€‰æ‹©çš„æ—¥æœŸèŒƒå›´: ${appData.selectedStartDate} åˆ° ${appData.selectedEndDate}`);
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ—¥æœŸéƒ½åœ¨é€‰æ‹©èŒƒå›´ä¹‹å¤–
                const allBeforeRange = allValidDates.every(item => item.date < selectedStart);
                const allAfterRange = allValidDates.every(item => item.date > selectedEnd);
                
                if (allBeforeRange) {
                    showNotification('è­¦å‘Š', 'æ‰€æœ‰æ•°æ®éƒ½åœ¨é€‰æ‹©çš„æ—¥æœŸèŒƒå›´ä¹‹å‰ï¼Œå°†ä½¿ç”¨å…¨éƒ¨æ•°æ®', 'warning');
                } else if (allAfterRange) {
                    showNotification('è­¦å‘Š', 'æ‰€æœ‰æ•°æ®éƒ½åœ¨é€‰æ‹©çš„æ—¥æœŸèŒƒå›´ä¹‹åï¼Œå°†ä½¿ç”¨å…¨éƒ¨æ•°æ®', 'warning');
                } else {
                    showNotification('è­¦å‘Š', 'æœªæ‰¾åˆ°é€‰æ‹©çš„æ—¥æœŸèŒƒå›´ï¼Œå°†ä½¿ç”¨å…¨éƒ¨æ•°æ®', 'warning');
                }
                
                startIndex = 0;
                endIndex = data.length - 1;
            }
            
            console.log(`- æ—¥æœŸèŒƒå›´ç­›é€‰ç»“æœ: æ‰¾åˆ° ${dateRangeIndices.length} æ¡è®°å½•`);
            console.log(`- ä½¿ç”¨çš„è¡Œç´¢å¼•èŒƒå›´: ${startIndex} åˆ° ${endIndex}`);
        } else {
            // é»˜è®¤ä½¿ç”¨å…¨éƒ¨æ•°æ®
            startIndex = 0;
            endIndex = data.length - 1;
            console.log(`- ä½¿ç”¨é»˜è®¤è¡Œç´¢å¼•èŒƒå›´: ${startIndex} åˆ° ${endIndex}`);
        }
        const meteringPointCol = appData.config.meteringPointColumn ? parseInt(appData.config.meteringPointColumn) : null;
        const multiplierCol = appData.config.useMultiplierColumn && appData.config.multiplierColumn ? parseInt(appData.config.multiplierColumn) : null;
        const selectedMeteringPoint = appData.config.meteringPointFilter;
        
        if (dataStructure === 'columnToRow') {
            // åŸæœ‰çš„åˆ—å¯¹è¡Œæ•°æ®å¤„ç†é€»è¾‘
            const dataColumnCount = endCol - startCol + 1;
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è·¨æ—¥æœŸç»“æ„æ•°æ®é€‰é¡¹
            const isCrossDateStructure = document.getElementById('crossDateStructure') && document.getElementById('crossDateStructure').checked;
            
            // å¢å¼ºçš„æ™ºèƒ½æ—¶é—´é—´éš”æ£€æµ‹
            const detectionResult = detectTimeIntervalIntelligently(data, startIndex, endIndex, dateCol, meteringPointCol, selectedMeteringPoint, isCrossDateStructure, dataColumnCount);
            
            let autoDetectedInterval = detectionResult.interval;
            let intervalDescription = detectionResult.description;
            
            // æ˜¾ç¤ºå¢å¼ºçš„æ£€æµ‹ç»“æœé€šçŸ¥
            showEnhancedIntervalNotification(detectionResult);
            
            // å¦‚æœæœ‰å€™é€‰é—´éš”ï¼Œæ˜¾ç¤ºå€™é€‰ä¿¡æ¯
            if (detectionResult.candidates && detectionResult.candidates.length > 0) {
                const candidateInfo = detectionResult.candidates
                    .map(c => `${c.description}(${Math.round(c.confidence * 100)}%)`)
                    .join('ã€');
                setTimeout(() => {
                    showNotification('ğŸ” å…¶ä»–å€™é€‰é—´éš”', `æ£€æµ‹åˆ°çš„å…¶ä»–å¯èƒ½é—´éš”ï¼š${candidateInfo}\nå¦‚æœä¸»è¦æ£€æµ‹ç»“æœä¸å‡†ç¡®ï¼Œå¯æ‰‹åŠ¨é€‰æ‹©è¿™äº›å€™é€‰é—´éš”`, 'info');
                }, 2500);
            }
            
            // æ›´æ–°æ—¶é—´é—´éš”é…ç½®
            appData.config.timeInterval = autoDetectedInterval;
            elements.timeIntervalSelect.value = autoDetectedInterval;
            
            // è·³è¿‡è¡¨å¤´è¡Œï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹æ•°æ®èµ·å§‹è¡Œ
            let startRow = startIndex;
            for (let i = startIndex; i < Math.min(startIndex + 10, data.length); i++) {
                if (data[i] && data[i][dateCol] && isDateLike(data[i][dateCol])) {
                    startRow = i;
                    break;
                }
            }
            
            // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
            for (let i = startRow; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // æ£€æŸ¥è®¡é‡ç‚¹ç¼–å·ç­›é€‰
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) {
                        continue; // è·³è¿‡ä¸åŒ¹é…çš„è¡Œ
                    }
                }
                
                // æ£€æŸ¥é™„åŠ ç­›é€‰é¡¹
                let skipRow = false;
                appData.config.additionalFilters.forEach(filter => {
                    if (filter.column && filter.value) {
                        const col = parseInt(filter.column);
                        const rowValue = String(row[col]).trim();
                        if (rowValue !== filter.value) {
                            skipRow = true;
                        }
                    }
                });
                
                if (skipRow) {
                    continue; // è·³è¿‡ä¸åŒ¹é…çš„è¡Œ
                }
                
                // è§£ææ—¥æœŸ
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) continue;
                

                // è·å–å€ç‡å€¼
                let multiplier = appData.config.multiplier;
                if (multiplierCol !== null && row[multiplierCol] !== undefined) {
                    const parsedMultiplier = parseNumber(row[multiplierCol]);
                    if (parsedMultiplier !== null) {
                        multiplier = parsedMultiplier;
                    }
                }
                
                // æå–æ•°æ®åˆ—
                const dataValues = [];
                for (let j = startCol; j <= endCol && j < row.length; j++) {
                    const value = parseNumber(row[j]);
                    dataValues.push(value);
                }
                
                // éªŒè¯æ•°æ®ç‚¹æ•°é‡
                const expectedPoints = dataColumnCount; // ä½¿ç”¨è®¡ç®—å‡ºçš„æ•°æ®åˆ—æ•°é‡
                if (dataValues.length < expectedPoints * 0.8) { // å…è®¸20%çš„æ•°æ®ç¼ºå¤±
                    console.warn(`æ•°æ®ç‚¹ä¸è¶³ï¼Œæ—¥æœŸ: ${dateStr}, å®é™…: ${dataValues.length}, é¢„æœŸ: ${expectedPoints}`);
                    continue;
                }
                
                // æ·»åŠ åˆ°è§£ææ•°æ®
                appData.parsedData.push({
                    date: date,
                    dateStr: dateStr,
                    rawData: dataValues,
                    multiplier: multiplier,
                    sourceFile: worksheet.file.name,
                    meteringPoint: meteringPointCol !== null ? String(row[meteringPointCol]).trim() : null,
                    timeInterval: autoDetectedInterval, // ä¿å­˜è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ—¶é—´é—´éš”
                    dataStructure: 'columnToRow' // æ ‡è®°æ•°æ®ç»“æ„ç±»å‹
                });
            }
        } else {
            // æ–°çš„åˆ—å¯¹åˆ—æ•°æ®å¤„ç†é€»è¾‘
            // å¯¹äºåˆ—å¯¹åˆ—ç»“æ„ï¼Œæ—¥æœŸåœ¨æŸä¸€åˆ—ï¼Œæ•°æ®åœ¨å¦ä¸€åˆ—
            const dataCol = parseInt(appData.config.dataStartColumn); // åªä½¿ç”¨èµ·å§‹åˆ—ä½œä¸ºæ•°æ®åˆ—
            
            // è·³è¿‡è¡¨å¤´è¡Œï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹æ•°æ®èµ·å§‹è¡Œ
            let startRow = startIndex;
            for (let i = startIndex; i < Math.min(startIndex + 10, data.length); i++) {
                if (data[i] && data[i][dateCol] && isDateLike(data[i][dateCol])) {
                    startRow = i;
                    break;
                }
            }
            
            // å¯¹äºåˆ—å¯¹åˆ—ç»“æ„ï¼Œä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´é—´éš”è€Œä¸æ˜¯è‡ªåŠ¨æ£€æµ‹
            const timeInterval = parseInt(appData.config.timeInterval);
            
            // æŒ‰æ—¥æœŸåˆ†ç»„å¤„ç†æ•°æ®
            const dateGroups = {};
            
            // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
            for (let i = startRow; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // æ£€æŸ¥è®¡é‡ç‚¹ç¼–å·ç­›é€‰
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) {
                        continue; // è·³è¿‡ä¸åŒ¹é…çš„è¡Œ
                    }
                }
                
                // æ£€æŸ¥é™„åŠ ç­›é€‰é¡¹
                let skipRow = false;
                appData.config.additionalFilters.forEach(filter => {
                    if (filter.column && filter.value) {
                        const col = parseInt(filter.column);
                        const rowValue = String(row[col]).trim();
                        if (rowValue !== filter.value) {
                            skipRow = true;
                        }
                    }
                });
                
                if (skipRow) {
                    continue; // è·³è¿‡ä¸åŒ¹é…çš„è¡Œ
                }
                
                // è§£ææ—¥æœŸå’Œæ—¶é—´
                const dateTimeStr = String(row[dateCol]).trim();
                const dateTime = parseDateTime(dateTimeStr, appData.config.dateFormat);
                if (!dateTime) continue;
                
                // æå–æ—¥æœŸéƒ¨åˆ†ä½œä¸ºåˆ†ç»„é”®
                const dateKey = formatDateKey(dateTime);
                
                // è·å–å€ç‡å€¼
                let multiplier = appData.config.multiplier;
                if (multiplierCol !== null && row[multiplierCol] !== undefined) {
                    const parsedMultiplier = parseNumber(row[multiplierCol]);
                    if (parsedMultiplier !== null) {
                        multiplier = parsedMultiplier;
                    }
                }
                
                // æå–æ•°æ®å€¼
                const value = parseNumber(row[dataCol]);
                if (value === null) continue;
                
                // åˆå§‹åŒ–æ—¥æœŸåˆ†ç»„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = {
                        date: new Date(dateTime),
                        dateStr: dateKey,
                        dataPoints: [],
                        multiplier: multiplier,
                        sourceFile: worksheet.file.name,
                        meteringPoint: meteringPointCol !== null ? String(row[meteringPointCol]).trim() : null,
                        timeInterval: timeInterval, // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´é—´éš”
                        dataStructure: 'columnToColumn' // æ ‡è®°æ•°æ®ç»“æ„ç±»å‹
                    };
                }
                
                // æ·»åŠ æ•°æ®ç‚¹åˆ°æ—¥æœŸåˆ†ç»„
                dateGroups[dateKey].dataPoints.push({
                    time: dateTime,
                    value: value
                });
            }
            
            // å°†åˆ†ç»„æ•°æ®è½¬æ¢ä¸ºè§£ææ•°æ®æ ¼å¼
            Object.values(dateGroups).forEach(group => {
                // æŒ‰æ—¶é—´æ’åºæ•°æ®ç‚¹
                group.dataPoints.sort((a, b) => a.time - b.time);
                
                // æ·»åŠ åˆ°è§£ææ•°æ®
                appData.parsedData.push({
                    date: group.date,
                    dateStr: group.dateStr,
                    rawData: group.dataPoints.map(p => p.value),
                    multiplier: group.multiplier,
                    sourceFile: group.sourceFile,
                    meteringPoint: group.meteringPoint,
                    timeInterval: group.timeInterval,
                    dataStructure: 'columnToColumn', // æ ‡è®°æ•°æ®ç»“æ„ç±»å‹
                    dataPoints: group.dataPoints // ä¿å­˜åŸå§‹æ•°æ®ç‚¹ï¼ŒåŒ…å«æ—¶é—´ä¿¡æ¯
                });
            });
        }
    });
    
    // æŒ‰æ—¥æœŸæ’åº
    appData.parsedData.sort((a, b) => a.date - b.date);
    
    // å¤„ç†æ•°æ®ç”Ÿæˆå°æ—¶çº§æ•°æ®
    processParsedData();
}

        function processParsedData() {
    appData.processedData = [];
    
    appData.parsedData.forEach(parsedRow => {
        const dataStructure = parsedRow.dataStructure || 'columnToRow'; // é»˜è®¤ä¸ºåˆ—å¯¹è¡Œç»“æ„
        const interval = parsedRow.timeInterval || appData.config.timeInterval;
        
        if (dataStructure === 'columnToRow') {
            // åŸæœ‰çš„åˆ—å¯¹è¡Œæ•°æ®å¤„ç†é€»è¾‘
            let pointsPerHour;
            
            // æ ¹æ®æ—¶é—´é—´éš”è®¡ç®—æ¯å°æ—¶æ•°æ®ç‚¹æ•°
            if (interval === 1) {
                pointsPerHour = 60; // æ¯å°æ—¶60ä¸ªæ•°æ®ç‚¹ï¼ˆæ¯åˆ†é’Ÿä¸€ä¸ªï¼‰
            } else if (interval === 5) {
                pointsPerHour = 12; // æ¯å°æ—¶12ä¸ªæ•°æ®ç‚¹ï¼ˆæ¯5åˆ†é’Ÿä¸€ä¸ªï¼‰
            } else if (interval === 15) {
                pointsPerHour = 4; // æ¯å°æ—¶4ä¸ªæ•°æ®ç‚¹ï¼ˆæ¯15åˆ†é’Ÿä¸€ä¸ªï¼‰
            } else if (interval === 30) {
                pointsPerHour = 2; // æ¯å°æ—¶2ä¸ªæ•°æ®ç‚¹ï¼ˆæ¯30åˆ†é’Ÿä¸€ä¸ªï¼‰
            } else if (interval === 60) {
                pointsPerHour = 1; // æ¯å°æ—¶1ä¸ªæ•°æ®ç‚¹ï¼ˆæ¯60åˆ†é’Ÿä¸€ä¸ªï¼‰
            } else {
                pointsPerHour = Math.floor(60 / interval); // è®¡ç®—æ¯å°æ—¶æ•°æ®ç‚¹æ•°
            }
            
            const hourlyData = [];
            let processedRawData = parsedRow.rawData;
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè·¨æ—¥æœŸç»“æ„æ•°æ®
            const isCrossDateStructure = document.getElementById('crossDateStructure') && document.getElementById('crossDateStructure').checked;
            
            // å¦‚æœæ˜¯è·¨æ—¥æœŸç»“æ„æ•°æ®ï¼Œéœ€è¦ç¡®ä¿æ—¶é—´åºåˆ—çš„é€»è¾‘æ­£ç¡®æ€§
            if (isCrossDateStructure && interval === 15) {
                // å¯¹äº15åˆ†é’Ÿé—´éš”çš„è·¨æ—¥æœŸç»“æ„æ•°æ®ï¼Œæ¯4ä¸ªå•å…ƒæ ¼ç»„åˆä¸º1å°æ—¶æ•°æ®ç»„
                // éœ€è¦ç¡®ä¿æ•°æ®çš„æ—¶é—´é¡ºåºæ­£ç¡®ï¼Œé¿å…æ—¶é—´é¡ºåºé¢ å€’
                
                // å°†æ•°æ®æŒ‰å°æ—¶åˆ†ç»„ï¼ˆæ¯4ä¸ªæ•°æ®ç‚¹ä¸ºä¸€å°æ—¶ï¼‰
                const totalHours = Math.floor(processedRawData.length / pointsPerHour);
                
                for (let hour = 0; hour < totalHours; hour++) {
                    const startIdx = hour * pointsPerHour;
                    const endIdx = startIdx + pointsPerHour;
                    const hourData = processedRawData.slice(startIdx, endIdx);
                    
                    // å¤„ç†æ— æ•ˆæ•°æ®
                    const fillMethod = appData.config.invalidDataHandling === 'ignore' ? 'ignore' : 'interpolate';
                    const cleanedData = DataUtils.cleanData(hourData, { fillMethod });
                    
                    // æ ¹æ®æ•°æ®ç±»å‹è®¡ç®—å°æ—¶ç”µèƒ½
                    let hourlyValue;
                    
                    if (appData.config.dataType === 'instantPower') {
                        // ç¬æ—¶åŠŸç‡æ•°æ® (kW)
                        const validData = cleanedData.filter(v => v !== null);
                        if (validData.length === 0) {
                            hourlyValue = null; // æ ‡è®°ä¸ºæ— æ•ˆ
                        } else {
                            const sum = validData.reduce((a, b) => a + b, 0);
                            const avgPower = sum / validData.length; // è®¡ç®—å¹³å‡åŠŸç‡
                            hourlyValue = avgPower * 1 * parsedRow.multiplier; // å¹³å‡åŠŸç‡Ã—1å°æ—¶Ã—å€ç‡
                        }
                    } else {
                        // ç´¯ç§¯ç”µèƒ½æ•°æ® (kWh)
                        if (cleanedData.length < 2) {
                            hourlyValue = null; // æ•°æ®ä¸è¶³
                        } else {
                            const startValue = cleanedData[0];
                            const endValue = cleanedData[cleanedData.length - 1];
                            
                            if (startValue === null || endValue === null) {
                                hourlyValue = null; // èµ·å§‹æˆ–ç»“æŸå€¼æ— æ•ˆ
                            } else if (endValue < startValue) {
                                // ç´¯ç§¯å€¼å›é€€ï¼Œæ ‡è®°ä¸ºå¼‚å¸¸
                                console.warn(`ç´¯ç§¯å€¼å¼‚å¸¸ï¼Œæ—¥æœŸ: ${parsedRow.dateStr}, å°æ—¶: ${hour}`);
                                hourlyValue = null;
                            } else {
                                hourlyValue = (endValue - startValue) * parsedRow.multiplier;
                            }
                        }
                    }
                    
                    hourlyData.push(hourlyValue);
                }
                
                // å¦‚æœæ•°æ®ä¸è¶³24å°æ—¶ï¼Œç”¨nullå¡«å……å‰©ä½™å°æ—¶
                while (hourlyData.length < 24) {
                    hourlyData.push(null);
                }
            } else {
                // éè·¨æ—¥æœŸç»“æ„æ•°æ®æˆ–å…¶ä»–æ—¶é—´é—´éš”çš„å¸¸è§„å¤„ç†
                // å¤„ç†æ¯å°æ—¶æ•°æ®
                for (let hour = 0; hour < 24; hour++) {
                    const startIdx = hour * pointsPerHour;
                    const endIdx = startIdx + pointsPerHour;
                    const hourData = processedRawData.slice(startIdx, endIdx);
                    
                    // å¤„ç†æ— æ•ˆæ•°æ®
                    const fillMethod = appData.config.invalidDataHandling === 'ignore' ? 'ignore' : 'interpolate';
                    const cleanedData = DataUtils.cleanData(hourData, { fillMethod });
                    
                    // æ ¹æ®æ•°æ®ç±»å‹è®¡ç®—å°æ—¶ç”µèƒ½
                    let hourlyValue;
                    
                    if (appData.config.dataType === 'instantPower') {
                        // ç¬æ—¶åŠŸç‡æ•°æ® (kW)
                        if (interval === 1) {
                            // 1åˆ†é’Ÿé—´éš”ç‰¹æ®Šå¤„ç†ï¼šè·å–ç¬¬ä¸€ä¸ªå°æ—¶æ‰€æœ‰æ•°æ®ç‚¹ï¼Œè¿‡æ»¤æ— æ•ˆæ•°æ®åè®¡ç®—æ€»å’Œï¼Œé€šè¿‡æ€»å’Œé™¤ä»¥æœ‰æ•ˆæ•°æ®ç‚¹æ•°å¾—åˆ°å¹³å‡åŠŸç‡ï¼Œå†ä¹˜ä»¥1å°æ—¶å’Œå€ç‡
                            const validData = cleanedData.filter(v => v !== null);
                            if (validData.length === 0) {
                                hourlyValue = null; // æ ‡è®°ä¸ºæ— æ•ˆ
                            } else {
                                const sum = validData.reduce((a, b) => a + b, 0);
                                const avgPower = sum / validData.length; // è®¡ç®—å¹³å‡åŠŸç‡
                                hourlyValue = avgPower * 1 * parsedRow.multiplier; // å¹³å‡åŠŸç‡Ã—1å°æ—¶Ã—å€ç‡
                            }
                        } else {
                            // å…¶ä»–é—´éš”ï¼šè®¡ç®—(æ±‚å’Œç»“æœ Ã· æ•°æ®ç‚¹æ•°) Ã— 1å°æ—¶ Ã— å€ç‡ â†’ kWh
                            const validData = cleanedData.filter(v => v !== null);
                            if (validData.length === 0) {
                                hourlyValue = null; // æ ‡è®°ä¸ºæ— æ•ˆ
                            } else {
                                const sum = validData.reduce((a, b) => a + b, 0);
                                const avgPower = sum / validData.length;
                                hourlyValue = avgPower * 1 * parsedRow.multiplier; // å¹³å‡åŠŸç‡Ã—1å°æ—¶Ã—å€ç‡
                            }
                        }
                    } else {
                        // ç´¯ç§¯ç”µèƒ½æ•°æ® (kWh)
                        if (interval === 1) {
                            // 1åˆ†é’Ÿé—´éš”ç‰¹æ®Šå¤„ç†ï¼šå°†æ¯å°æ—¶å†…ç¬¬46-60ä¸ªå•å…ƒæ ¼æ•°æ®ä¹‹å’Œå‡å»ç¬¬1-15ä¸ªå•å…ƒæ ¼æ•°æ®ä¹‹å’Œï¼Œä½œä¸º1å°æ—¶ä¸€ç»„çš„æ•°æ®
                            if (cleanedData.length < 60) {
                                hourlyValue = null; // æ•°æ®ä¸è¶³
                            } else {
                                // ç¬¬ä¸€ç»„ï¼š1-15åˆ†é’Ÿ
                                const firstQuarter = cleanedData.slice(0, 15).filter(v => v !== null);
                                // ç¬¬äºŒç»„ï¼š46-60åˆ†é’Ÿ
                                const lastQuarter = cleanedData.slice(45, 60).filter(v => v !== null);
                                
                                if (firstQuarter.length === 0 || lastQuarter.length === 0) {
                                    hourlyValue = null; // æ•°æ®ä¸è¶³
                                } else {
                                    const firstSum = firstQuarter.reduce((a, b) => a + b, 0);
                                    const lastSum = lastQuarter.reduce((a, b) => a + b, 0);
                                    hourlyValue = (lastSum - firstSum) * parsedRow.multiplier;
                                }
                            }
                        } else {
                            // å…¶ä»–é—´éš”ï¼šè®¡ç®—(å½“å‰å°æ—¶æœ« - å½“å‰å°æ—¶åˆ) Ã— å€ç‡ â†’ kWh
                            if (cleanedData.length < 2) {
                                hourlyValue = null; // æ•°æ®ä¸è¶³
                            } else {
                                const startValue = cleanedData[0];
                                const endValue = cleanedData[cleanedData.length - 1];
                                
                                if (startValue === null || endValue === null) {
                                    hourlyValue = null; // èµ·å§‹æˆ–ç»“æŸå€¼æ— æ•ˆ
                                } else if (endValue < startValue) {
                                    // ç´¯ç§¯å€¼å›é€€ï¼Œæ ‡è®°ä¸ºå¼‚å¸¸
                                    console.warn(`ç´¯ç§¯å€¼å¼‚å¸¸ï¼Œæ—¥æœŸ: ${parsedRow.dateStr}, å°æ—¶: ${hour}`);
                                    hourlyValue = null;
                                } else {
                                    hourlyValue = (endValue - startValue) * parsedRow.multiplier;
                                }
                            }
                        }
                    }
                    
                    hourlyData.push(hourlyValue);
                }
            }
            
            // è®¡ç®—æ—¥æ€»ç”µèƒ½
            const validHourlyData = hourlyData.filter(v => v !== null);
            const dailyTotal = validHourlyData.reduce((a, b) => a + b, 0);
            
            console.log(`=== æ—¥æ€»ç”µèƒ½è®¡ç®—è°ƒè¯• (${parsedRow.dateStr}) ===`);
            console.log('æœ‰æ•ˆå°æ—¶æ•°æ®ç‚¹æ•°:', validHourlyData.length);
            console.log('æœ‰æ•ˆå°æ—¶æ•°æ®æ ·æœ¬:', validHourlyData.slice(0, 5));
            console.log('è®¡ç®—å¾—åˆ°çš„dailyTotal:', dailyTotal);
            
            // ç¡®ä¿æ—¥æœŸæ ¼å¼ç»Ÿä¸€ä¸º YYYY-MM-DD
            let formattedDate = parsedRow.dateStr;
            if (typeof parsedRow.dateStr === 'string') {
                const dateStr = parsedRow.dateStr;
                if (dateStr.length === 8 && !dateStr.includes('-')) {
                    // æ ¼å¼ï¼š20240901 -> 2024-09-01
                    formattedDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                } else if (dateStr.length === 10 && dateStr.includes('/')) {
                    // æ ¼å¼ï¼š2024/09/01 -> 2024-09-01
                    formattedDate = dateStr.replace(/\//g, '-');
                } else {
                    formattedDate = dateStr;
                }
            }
            
            appData.processedData.push({
                date: formattedDate,
                dateObj: parsedRow.date,
                hourlyData: hourlyData,
                dailyTotal: dailyTotal,
                sourceFile: parsedRow.sourceFile,
                meteringPoint: (parsedRow.meteringPoint === undefined || parsedRow.meteringPoint === null || String(parsedRow.meteringPoint).trim() === '') ? 'é»˜è®¤è®¡é‡ç‚¹' : String(parsedRow.meteringPoint).trim(),
                timeInterval: interval, // ä¿å­˜æ—¶é—´é—´éš”ä¿¡æ¯
                dataStructure: 'columnToRow' // æ ‡è®°æ•°æ®ç»“æ„ç±»å‹
            });
        } else {
            // æŒ‰ç…§ç²¾ç¡®è®¡ç®—è§„åˆ™é‡æ„åˆ—å¯¹åˆ—æ•°æ®å¤„ç†
            const hourlyData = new Array(24).fill(null);
            
            // æ ¹æ®æ—¶é—´é—´éš”è®¡ç®—æ¯å°æ—¶æ•°æ®ç‚¹æ•°
            let pointsPerHour;
            if (interval === 1) {
                pointsPerHour = 60; // 1åˆ†é’Ÿé—´éš”ï¼šæ¯å°æ—¶60ä¸ªæ•°æ®ç‚¹
            } else if (interval === 5) {
                pointsPerHour = 12; // 5åˆ†é’Ÿé—´éš”ï¼šæ¯å°æ—¶12ä¸ªæ•°æ®ç‚¹
            } else if (interval === 15) {
                pointsPerHour = 4; // 15åˆ†é’Ÿé—´éš”ï¼šæ¯å°æ—¶4ä¸ªæ•°æ®ç‚¹
            } else if (interval === 30) {
                pointsPerHour = 2; // 30åˆ†é’Ÿé—´éš”ï¼šæ¯å°æ—¶2ä¸ªæ•°æ®ç‚¹
            } else if (interval === 60) {
                pointsPerHour = 1; // 60åˆ†é’Ÿé—´éš”ï¼šæ¯å°æ—¶1ä¸ªæ•°æ®ç‚¹
            } else {
                pointsPerHour = Math.floor(60 / interval);
            }
            
            // ç¡®ä¿æ•°æ®ç‚¹æ€»æ•°æ­£ç¡®ï¼ˆ1440ä¸ªä¸º1åˆ†é’Ÿé—´éš”ï¼Œ96ä¸ªä¸º15åˆ†é’Ÿé—´éš”ç­‰ï¼‰
            const expectedTotalPoints = 24 * pointsPerHour;
            
            // å¤„ç†æ¯ä¸ªæ•°æ®ç‚¹
            if (parsedRow.dataPoints && parsedRow.dataPoints.length >= expectedTotalPoints) {
                const allPoints = parsedRow.dataPoints;
                
                if (appData.config.dataType === 'instantPower') {
                    // ç¬æ—¶åŠŸç‡æ•°æ®å¤„ç†
                    for (let hour = 0; hour < 24; hour++) {
                        // è®¡ç®—å½“å‰å°æ—¶çš„æ•°æ®ç‚¹èŒƒå›´
                        const startIndex = hour * pointsPerHour;
                        const endIndex = startIndex + pointsPerHour;
                        
                        // è·å–å½“å‰å°æ—¶çš„è¿ç»­æ•°æ®ç‚¹
                        const hourPoints = allPoints.slice(startIndex, endIndex)
                            .map(p => p.value)
                            .filter(v => v !== null && !isNaN(v));
                        
                        if (hourPoints.length > 0) {
                            // è®¡ç®—æœ‰æ•ˆæ•°æ®çš„å¹³å‡å€¼
                            const sum = hourPoints.reduce((a, b) => a + b, 0);
                            const avgValue = sum / hourPoints.length;
                            
                            // è®¡ç®—å°æ—¶ç”¨ç”µé‡ï¼šå¹³å‡å€¼ Ã— 1å°æ—¶ Ã— å€ç‡
                            hourlyData[hour] = avgValue * 1 * parsedRow.multiplier;
                        }
                    }
                } else {
                    // ç´¯ç§¯ç”µèƒ½æ•°æ®å¤„ç†
                    for (let hour = 0; hour < 24; hour++) {
                        // è®¡ç®—å½“å‰å°æ—¶çš„æ•°æ®ç‚¹èŒƒå›´
                        const startIndex = hour * pointsPerHour;
                        const endIndex = startIndex + pointsPerHour;
                        
                        // è·å–å½“å‰å°æ—¶çš„è¿ç»­æ•°æ®ç‚¹
                        const hourPoints = allPoints.slice(startIndex, endIndex)
                            .map(p => p.value)
                            .filter(v => v !== null && !isNaN(v));
                        
                        if (hourPoints.length > 0) {
                            // è·å–å½“å‰å°æ—¶å†…æŒ‰æ—¶é—´é¡ºåºçš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹
                            // æ³¨æ„ï¼šè¿™é‡Œä¸åº”è¯¥æŒ‰æ•°å€¼å¤§å°æ’åºï¼Œè€Œåº”è¯¥æŒ‰æ—¶é—´é¡ºåº
                            const hourPointsWithTime = allPoints.slice(startIndex, endIndex)
                                .filter(p => p.value !== null && !isNaN(p.value));
                            
                            if (hourPointsWithTime.length >= 2) {
                                // æŒ‰æ—¶é—´æ’åºï¼ˆç¡®ä¿æ—¶é—´é¡ºåºæ­£ç¡®ï¼‰
                                hourPointsWithTime.sort((a, b) => a.time - b.time);
                                
                                const firstValue = hourPointsWithTime[0].value;
                                const lastValue = hourPointsWithTime[hourPointsWithTime.length - 1].value;
                                
                                if (lastValue >= firstValue) {
                                    // è®¡ç®—ç”µèƒ½å˜åŒ–é‡ï¼šæœ€åä¸€ä¸ªå€¼ - ç¬¬ä¸€ä¸ªå€¼ï¼Œå†ä¹˜ä»¥å€ç‡
                                    hourlyData[hour] = (lastValue - firstValue) * parsedRow.multiplier;
                                } else {
                                    // ç´¯ç§¯å€¼å›é€€ï¼Œæ ‡è®°ä¸ºå¼‚å¸¸
                                    console.warn(`ç´¯ç§¯å€¼å¼‚å¸¸ï¼Œæ—¥æœŸ: ${parsedRow.dateStr}, å°æ—¶: ${hour}`);
                                    hourlyData[hour] = null;
                                }
                            } else if (hourPointsWithTime.length === 1) {
                                // åªæœ‰ä¸€ä¸ªæ•°æ®ç‚¹ï¼Œæ— æ³•è®¡ç®—å·®å€¼
                                hourlyData[hour] = null;
                            }
                        }
                    }
                }
            } else {
                console.warn(`æ•°æ®ç‚¹æ•°é‡ä¸è¶³ï¼ŒæœŸæœ›${expectedTotalPoints}ä¸ªï¼Œå®é™…${parsedRow.dataPoints ? parsedRow.dataPoints.length : 0}ä¸ª`);
            }
            
            // è®¡ç®—æ—¥æ€»ç”µèƒ½
            const validHourlyData = hourlyData.filter(v => v !== null);
            const dailyTotal = validHourlyData.reduce((a, b) => a + b, 0);
            
            console.log(`=== æ—¥æ€»ç”µèƒ½è®¡ç®—è°ƒè¯• (${parsedRow.dateStr}) ===`);
            console.log('æœ‰æ•ˆå°æ—¶æ•°æ®ç‚¹æ•°:', validHourlyData.length);
            console.log('æœ‰æ•ˆå°æ—¶æ•°æ®æ ·æœ¬:', validHourlyData.slice(0, 5));
            console.log('è®¡ç®—å¾—åˆ°çš„dailyTotal:', dailyTotal);
            
            // ç¡®ä¿æ—¥æœŸæ ¼å¼ç»Ÿä¸€ä¸º YYYY-MM-DD
            let formattedDate = parsedRow.dateStr;
            if (typeof parsedRow.dateStr === 'string') {
                const dateStr = parsedRow.dateStr;
                if (dateStr.length === 8 && !dateStr.includes('-')) {
                    // æ ¼å¼ï¼š20240901 -> 2024-09-01
                    formattedDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                } else if (dateStr.length === 10 && dateStr.includes('/')) {
                    // æ ¼å¼ï¼š2024/09/01 -> 2024-09-01
                    formattedDate = dateStr.replace(/\//g, '-');
                } else {
                    formattedDate = dateStr;
                }
            }
            
            appData.processedData.push({
                date: formattedDate,
                dateObj: parsedRow.date,
                hourlyData: hourlyData,
                dailyTotal: dailyTotal,
                sourceFile: parsedRow.sourceFile,
                meteringPoint: (parsedRow.meteringPoint === undefined || parsedRow.meteringPoint === null || String(parsedRow.meteringPoint).trim() === '') ? 'é»˜è®¤è®¡é‡ç‚¹' : String(parsedRow.meteringPoint).trim(),
                timeInterval: interval, // ä¿å­˜æ—¶é—´é—´éš”ä¿¡æ¯
                dataStructure: 'columnToColumn' // æ ‡è®°æ•°æ®ç»“æ„ç±»å‹
            });
        }
    });
    
    // è¿‡æ»¤æ‰æ‰€æœ‰æ•°æ®éƒ½ä¸ºç©ºçš„æ—¥æœŸ
    appData.processedData = appData.processedData.filter(row => {
        return row.hourlyData.some(value => value !== null);
    });
    
    // åœ¨æ•°æ®å¤„ç†å®Œæˆåï¼Œæ›´æ–°å†å²è®°å½•
    if (appData.importHistory.length > 0) {
        // è·å–æœ€è¿‘ä¸€æ¬¡å¯¼å…¥çš„è®°å½•
        const latestRecord = appData.importHistory[appData.importHistory.length - 1];
        
        // æ›´æ–°å¤„ç†ç»“æœ
        latestRecord.validRecordCount = appData.parsedData.length;
        latestRecord.invalidRecordCount = appData.worksheets[0].data.length - 1 - appData.parsedData.length; // æ€»è¡Œæ•°å‡å»è¡¨å¤´å’Œæœ‰æ•ˆè¡Œæ•°
        latestRecord.timeInterval = appData.config.timeInterval;
        latestRecord.config = {
            dataType: appData.config.dataType,
            multiplier: appData.config.multiplier,
            dateColumn: appData.config.dateColumn,
            dataStartColumn: appData.config.dataStartColumn,
            dataEndColumn: appData.config.dataEndColumn,
            dataStructure: document.querySelector('input[name="dataStructure"]:checked').value // ä¿å­˜æ•°æ®ç»“æ„ç±»å‹
        };
        
        // ä¿å­˜æ›´æ–°åçš„å†å²è®°å½•
        saveImportHistory();
        renderImportHistory();
    }
    
    // æ›´æ–°æ•°æ®æ¦‚è§ˆç»Ÿè®¡ä¿¡æ¯
    updateDataOverview();
    
    // åˆå§‹åŒ–å¯è§†åŒ–ç•Œé¢
    initializeVisualization();
}

        /**
         * ä½¿ç”¨æ–°çš„é…ç½®é‡æ–°å¤„ç†åŸå§‹æ•°æ®
         * è¿™ä¸ªå‡½æ•°ä¼šåœ¨ç¬¬äºŒæ­¥é…ç½®å‘ç”Ÿå˜åŒ–æ—¶è°ƒç”¨ï¼Œç¡®ä¿ç¬¬ä¸‰æ­¥å¯è§†åŒ–ä½¿ç”¨æœ€æ–°çš„é…ç½®
         */
        function reprocessDataWithConfig() {
            console.log('ä½¿ç”¨æ–°é…ç½®é‡æ–°å¤„ç†æ•°æ®...');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŸå§‹æ•°æ®
            if (!appData.worksheets || appData.worksheets.length === 0) {
                console.warn('æ²¡æœ‰åŸå§‹æ•°æ®å¯ä¾›é‡æ–°å¤„ç†');
                return;
            }
            
            try {
                // æ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æ–°é…ç½®
                if (CacheManager && typeof CacheManager.clear === 'function') {
                    CacheManager.clear();
                }
                
                // é‡æ–°è§£æå·¥ä½œè¡¨æ•°æ®ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰
                parseWorksheetData();
                
                // é‡æ–°å¤„ç†è§£æåçš„æ•°æ®
                processParsedData();
                
                // æ›´æ–°è®¡é‡ç‚¹ç­›é€‰é€‰é¡¹
                updateMeteringPointFilterOptions();
                
                // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
                updateVisualizationDateSelects();
                
                // é‡ç½®å¯è§†åŒ–ç­›é€‰ä¸ºæ–°æ•°æ®çš„å…¨é€‰ï¼Œé¿å…æ—§é€‰æ‹©ä¸æ–°æ•°æ®ä¸åŒ¹é…å¯¼è‡´æ— æ•°æ®
                appData.visualization.selectedDates = appData.processedData.map(d => d.date);
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                if (elements.visualizationMeteringPointFilterSelect) {
                    Array.from(elements.visualizationMeteringPointFilterSelect.options).forEach(opt => opt.selected = true);
                }
                
                console.log('æ•°æ®é‡æ–°å¤„ç†å®Œæˆï¼Œå…±å¤„ç†æ•°æ®ç‚¹:', appData.processedData.length);
                
                // æ›´æ–°æ•°æ®æ¦‚è§ˆç»Ÿè®¡ä¿¡æ¯
                updateDataOverview();
                
                // å¦‚æœå½“å‰åœ¨å¯è§†åŒ–æ­¥éª¤ï¼Œè‡ªåŠ¨åˆ·æ–°å›¾è¡¨
                if (!elements.visualizationSection.classList.contains('hidden')) {
                    setTimeout(() => {
                        updateChart();
                        const filteredData = getFilteredData();
                        if (appData.dailyTotalBarChart) {
                            updateDailyTotalBarChart(filteredData);
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('é‡æ–°å¤„ç†æ•°æ®æ—¶å‡ºé”™:', error);
                showNotification('é”™è¯¯', 'é‡æ–°å¤„ç†æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function checkConfigValidity() {
            // è·å–æ•°æ®ç»“æ„ç±»å‹
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // æ ¹æ®æ•°æ®ç»“æ„ç±»å‹éªŒè¯é…ç½®
            let isValid = appData.config.dateColumn !== '' && 
                          appData.config.dataStartColumn !== '';
            
            // å¦‚æœæ˜¯åˆ—å¯¹è¡Œç»“æ„ï¼Œè¿˜éœ€è¦éªŒè¯ç»“æŸåˆ—
            if (dataStructure === 'columnToRow') {
                isValid = isValid && appData.config.dataEndColumn !== '';
            }
            
            // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºé…ç½®å€¼
            console.log('checkConfigValidity è°ƒè¯•ä¿¡æ¯:');
            console.log('æ•°æ®ç»“æ„ç±»å‹:', dataStructure);
            console.log('dateColumn:', appData.config.dateColumn);
            console.log('dataStartColumn:', appData.config.dataStartColumn);
            console.log('dataEndColumn:', appData.config.dataEndColumn);
            console.log('isValid (åŸºæœ¬æ¡ä»¶):', isValid);
            
            // æ™ºèƒ½æ£€æµ‹å’Œä¿®æ­£é…ç½®
            if (appData.worksheets && appData.worksheets.length > 0) {
                const worksheet = appData.worksheets[0];
                const detectedStructure = smartDetectDataStructure(worksheet.data);
                
                console.log('æ™ºèƒ½æ£€æµ‹åˆ°çš„æ•°æ®ç»“æ„:', detectedStructure);
                console.log('å½“å‰é€‰æ‹©çš„æ•°æ®ç»“æ„:', dataStructure);
                
                // å¦‚æœæ£€æµ‹åˆ°çš„ç»“æ„ä¸é€‰æ‹©çš„ä¸åŒï¼Œç»™å‡ºæç¤º
                if (detectedStructure !== dataStructure) {
                    console.warn(`æ•°æ®ç»“æ„å¯èƒ½ä¸åŒ¹é…ï¼æ£€æµ‹åˆ°: ${detectedStructure}, å½“å‰é€‰æ‹©: ${dataStructure}`);
                    showNotification('æç¤º', `æ£€æµ‹åˆ°æ•°æ®å¯èƒ½æ˜¯${detectedStructure === 'columnToColumn' ? 'åˆ—å¯¹åˆ—' : 'åˆ—å¯¹è¡Œ'}ç»“æ„ï¼Œè¯·æ£€æŸ¥é…ç½®`, 'warning');
                }
                
                // è‡ªåŠ¨ä¿®æ­£é…ç½®ï¼ˆé’ˆå¯¹columnToColumnç»“æ„çš„CSVæ–‡ä»¶ï¼‰
                if (detectedStructure === 'columnToColumn' && dataStructure === 'columnToRow') {
                    console.log('è‡ªåŠ¨åˆ‡æ¢åˆ°columnToColumnç»“æ„');
                    document.querySelector('input[name="dataStructure"][value="columnToColumn"]').checked = true;
                    // è§¦å‘é…ç½®æ›´æ–°
                    setTimeout(() => {
                        checkConfigValidity();
                    }, 100);
                    return false;
                }
            }
            
            // ç¡®ä¿ç»“æŸåˆ—ä¸å°äºèµ·å§‹åˆ—ï¼ˆä»…å¯¹åˆ—å¯¹è¡Œç»“æ„ï¼‰
            if (isValid && dataStructure === 'columnToRow') {
                const startCol = parseInt(appData.config.dataStartColumn);
                const endCol = parseInt(appData.config.dataEndColumn);
                
                console.log('startCol (æ•°å­—):', startCol);
                console.log('endCol (æ•°å­—):', endCol);
                console.log('endCol < startCol:', endCol < startCol);
                
                if (endCol < startCol) {
                    showNotification('è­¦å‘Š', 'ç»“æŸåˆ—ä¸èƒ½å°äºèµ·å§‹åˆ—', 'warning');
                    console.log('æŒ‰é’®è¢«ç¦ç”¨ï¼šç»“æŸåˆ—å°äºèµ·å§‹åˆ—');
                    return false;
                }
            }
            
            console.log('æœ€ç»ˆæŒ‰é’®çŠ¶æ€:', !isValid ? 'ç¦ç”¨' : 'å¯ç”¨');

            return isValid;
        }
        
        // æ™ºèƒ½æ£€æµ‹æ•°æ®ç»“æ„
        function smartDetectDataStructure(data) {
            if (!data || data.length < 2) return 'columnToColumn';
            
            // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦åŒ…å«æ—¶é—´åˆ—æ ‡é¢˜
            const firstRow = data[0] || [];
            let timeColumnCount = 0;
            
            for (let col = 0; col < Math.min(firstRow.length, 30); col++) {
                const cellValue = firstRow[col];
                if (cellValue) {
                    const headerValue = cellValue.toString().toLowerCase();
                    if (headerValue.includes('æ—¶é—´') || headerValue.includes('time') || 
                        headerValue.includes('hour') || headerValue.includes('å°æ—¶') ||
                        /^\d{1,2}[:ï¼š]\d{2}/.test(headerValue) || /^\d{1,2}[ç‚¹æ—¶]/.test(headerValue) ||
                        /^[0-9]{1,2}$/.test(headerValue.trim()) || // çº¯æ•°å­—å°æ—¶
                        headerValue.match(/^(0?[0-9]|1[0-9]|2[0-3])$/)) { // 0-23å°æ—¶æ ¼å¼
                        timeColumnCount++;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥æœŸåˆ—
            let dateColumnFound = false;
            for (let col = 0; col < Math.min(5, firstRow.length); col++) {
                let dateCount = 0;
                const sampleSize = Math.min(10, data.length - 1);
                
                for (let row = 1; row <= sampleSize; row++) {
                    if (data[row] && data[row][col]) {
                        const cellValue = data[row][col].toString();
                        if (isValidDateString(cellValue)) {
                            dateCount++;
                        }
                    }
                }
                
                if (dateCount >= sampleSize * 0.7) {
                    dateColumnFound = true;
                    break;
                }
            }
            
            // å†³ç­–é€»è¾‘
            if (dateColumnFound) {
                return 'columnToColumn'; // æœ‰æ—¥æœŸåˆ—ï¼Œé€šå¸¸æ˜¯columnToColumn
            } else if (timeColumnCount >= 12) {
                return 'columnToRow'; // æœ‰å¤§é‡æ—¶é—´åˆ—ï¼Œé€šå¸¸æ˜¯columnToRow
            }
            
            return 'columnToColumn'; // é»˜è®¤
        }
        
        // éªŒè¯æ—¥æœŸå­—ç¬¦ä¸²
        function isValidDateString(dateStr) {
            if (!dateStr) return false;
            
            const str = dateStr.toString().trim();
            
            // æ£€æŸ¥å„ç§æ—¥æœŸæ ¼å¼
            const datePatterns = [
                /^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/, // YYYY-MM-DD æˆ– YYYY/MM/DD
                /^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/, // MM-DD-YYYY æˆ– MM/DD/YYYY
                /^\d{4}\d{2}\d{2}$/, // YYYYMMDD
                /^\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥?$/, // ä¸­æ–‡æ—¥æœŸæ ¼å¼
                /^\d{1,2}æœˆ\d{1,2}æ—¥$/ // ç®€åŒ–ä¸­æ–‡æ—¥æœŸ
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•æ—¥æœŸæ¨¡å¼
            for (const pattern of datePatterns) {
                if (pattern.test(str)) {
                    // å°è¯•è§£æä¸ºæ—¥æœŸå¯¹è±¡éªŒè¯æœ‰æ•ˆæ€§
                    const date = new Date(str);
                    if (!isNaN(date.getTime())) {
                        return true;
                    }
                }
            }
            
            // å°è¯•ç›´æ¥è§£æ
            const date = new Date(str);
            return !isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100;
        }

        function updateMeteringPointFilterOptions() {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            elements.meteringPointFilterSelect.innerHTML = '<option value="">-- å…¨éƒ¨è®¡é‡ç‚¹ --</option>';
            elements.visualizationMeteringPointFilterSelect.innerHTML = '<option value="">-- å…¨éƒ¨è®¡é‡ç‚¹ --</option>';
            
            // é‡ç½®è®¡é‡ç‚¹åˆ—è¡¨
            appData.meteringPoints = [];
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©è®¡é‡ç‚¹ç¼–å·åˆ—ï¼Œåˆ™è¿”å›
            if (!appData.config.meteringPointColumn) return;
            
            const meteringPointCol = parseInt(appData.config.meteringPointColumn);
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„è®¡é‡ç‚¹ç¼–å·
            const meteringPointSet = new Set();
            
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // è·³è¿‡è¡¨å¤´è¡Œï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹æ•°æ®èµ·å§‹è¡Œ
                let startRow = 0;
                for (let i = 0; i < Math.min(10, data.length); i++) {
                    if (data[i] && data[i][meteringPointCol] && !isDateLike(data[i][meteringPointCol])) {
                        startRow = i;
                        break;
                    }
                }
                
                // æ”¶é›†è®¡é‡ç‚¹ç¼–å·
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[meteringPointCol]) continue;
                    
                    const meteringPoint = String(row[meteringPointCol]).trim();
                    if (meteringPoint) {
                        meteringPointSet.add(meteringPoint);
                    }
                }
            });
            
            // å¦‚æœæ•°æ®ä¸­å­˜åœ¨ç©º/ç¼ºå¤±è®¡é‡ç‚¹ï¼Œä¸ºå…¶æ·»åŠ ç»Ÿä¸€å ä½ã€é»˜è®¤è®¡é‡ç‚¹ã€
            if ([...meteringPointSet].some(v => v === undefined || v === null || String(v).trim() === '')) {
                meteringPointSet.add('é»˜è®¤è®¡é‡ç‚¹');
            }
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            appData.meteringPoints = Array.from(meteringPointSet).sort();
            
            // æ·»åŠ åˆ°ä¸‹æ‹‰èœå•
            appData.meteringPoints.forEach(point => {
                const option1 = document.createElement('option');
                option1.value = point;
                option1.textContent = point;
                elements.meteringPointFilterSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = point;
                option2.textContent = point;
                elements.visualizationMeteringPointFilterSelect.appendChild(option2);
            });
            
            // é»˜è®¤é€‰æ‹©å…¨éƒ¨è®¡é‡ç‚¹
            appData.config.meteringPointFilter = '';
            appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
        }

        // å¯è§†åŒ–éƒ¨åˆ†å‡½æ•°
        function initializeVisualization() {
            // å¡«å……æ—¥æœŸä¸‹æ‹‰é€‰æ‹©æ¡†
            updateVisualizationDateSelects();
            
            // é»˜è®¤é€‰æ‹©æ‰€æœ‰æ—¥æœŸ
            appData.visualization.selectedDates = appData.processedData.map(d => d.date);
            console.log('åˆå§‹åŒ–é€‰æ‹©æ‰€æœ‰æ—¥æœŸ:', appData.visualization.selectedDates.length, 'ä¸ªæ—¥æœŸ');
            
            // é»˜è®¤é€‰æ‹©æ‰€æœ‰è®¡é‡ç‚¹
            if (appData.meteringPoints.length > 0) {
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                console.log('åˆå§‹åŒ–é€‰æ‹©æ‰€æœ‰è®¡é‡ç‚¹:', appData.visualization.selectedMeteringPoints.length, 'ä¸ªè®¡é‡ç‚¹');
            } else {
                console.log('æ²¡æœ‰æ‰¾åˆ°è®¡é‡ç‚¹ï¼Œè‡ªåŠ¨æ”¶é›†æ‰€æœ‰è®¡é‡ç‚¹');
                // å¦‚æœæ²¡æœ‰é¢„è®¾çš„è®¡é‡ç‚¹ï¼Œä»æ•°æ®ä¸­æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„è®¡é‡ç‚¹
                const allMeteringPoints = [...new Set(appData.processedData.map(d => {
                    const raw = d.meteringPoint;
                    const v = (raw === undefined || raw === null || String(raw).trim() === '') ? 'é»˜è®¤è®¡é‡ç‚¹' : String(raw).trim();
                    return v;
                }))];
                appData.visualization.selectedMeteringPoints = allMeteringPoints;
                appData.meteringPoints = allMeteringPoints;
                console.log('è‡ªåŠ¨æ”¶é›†è®¡é‡ç‚¹:', allMeteringPoints);
            }
                
                // åˆå§‹åŒ–å›¾è¡¨åŒºåŸŸç‚¹å‡»äº‹ä»¶å¤„ç†
                document.getElementById('chartContainer').addEventListener('click', function(e) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢å›¾å½¢æ¶ˆå¤±
                    e.stopPropagation();
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯canvaså…ƒç´ ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œ
                    if (e.target.tagName === 'CANVAS') {
                        return;
                    }
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åŠ è½½çŠ¶æ€æˆ–æ— æ•°æ®æ¶ˆæ¯åŒºåŸŸï¼Œä¹Ÿä¸è¿›è¡Œä»»ä½•æ“ä½œ
                    if (e.target.id === 'chartLoading' || e.target.id === 'noDataMessage' || 
                        e.target.closest('#chartLoading') || e.target.closest('#noDataMessage')) {
                        return;
                    }
                });
                
                // æ³¨ï¼štoggleLegendå…ƒç´ å·²åˆ é™¤ï¼Œå›¾ä¾‹æ˜¾ç¤ºæ§åˆ¶å·²é›†æˆåˆ°å›¾è¡¨é…ç½®ä¸­
                
                // åˆå§‹åŒ–æŸ±çŠ¶å›¾åŒºåŸŸç‚¹å‡»äº‹ä»¶å¤„ç†
                document.getElementById('dailyTotalBarChartContainer').addEventListener('click', function(e) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢å›¾å½¢æ¶ˆå¤±
                    e.stopPropagation();
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯canvaså…ƒç´ ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œ
                    if (e.target.tagName === 'CANVAS') {
                        return;
                    }
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åŠ è½½çŠ¶æ€æˆ–æ— æ•°æ®æ¶ˆæ¯åŒºåŸŸï¼Œä¹Ÿä¸è¿›è¡Œä»»ä½•æ“ä½œ
                    if (e.target.id === 'barChartLoading' || e.target.id === 'barChartNoDataMessage' || 
                        e.target.closest('#barChartLoading') || e.target.closest('#barChartNoDataMessage')) {
                        return;
                    }
                });
                
                // æ³¨ï¼štoggleBarLegendå…ƒç´ å·²åˆ é™¤ï¼ŒæŸ±çŠ¶å›¾å›¾ä¾‹æ˜¾ç¤ºæ§åˆ¶å·²é›†æˆåˆ°å›¾è¡¨é…ç½®ä¸­
                
                // åˆå§‹åŒ–å›¾è¡¨
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å›¾è¡¨å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆé”€æ¯
                if (appData.chart) {
                    appData.chart.destroy();
                    appData.chart = null;
                }
                

                
                const ctx = elements.loadCurveChart.getContext('2d');
                appData.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 15,
                                bottom: 10,
                                left: 15
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutCubic',
                            delay: (context) => {
                                let delay = 0;
                                if (context.type === 'data' && context.mode === 'default') {
                                    delay = context.dataIndex * 30;
                                }
                                return delay;
                            }
                        },
                        plugins: {
                            title: {
                                display: false,
                                text: '24å°æ—¶è´Ÿè·æ›²çº¿',
                                font: {
                                    size: 18,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 15
                                },
                                color: '#1F2937'
                            },
                            legend: {
                                display: false,
                                position: 'top',
                                align: 'center',
                                labels: {
                                    usePointStyle: true,
                                    padding: 8,
                                    font: {
                                        size: 11,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    boxWidth: 12,
                                    boxHeight: 12,
                                    // è‡ªåŠ¨è°ƒæ•´å›¾ä¾‹å¸ƒå±€ä»¥é€‚åº”å®¹å™¨å®½åº¦
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                        
                                        // æ ¹æ®æ•°æ®é›†æ•°é‡è°ƒæ•´å›¾ä¾‹æ˜¾ç¤º
                                        if (datasets.length > 20) {
                                            // æ•°æ®é›†è¾ƒå¤šæ—¶ï¼Œå‡å°å­—ä½“å’Œé—´è·
                                            originalLabels.forEach(label => {
                                                label.font = {
                                                    size: 10,
                                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                                    weight: '500'
                                                };
                                                label.padding = 6;
                                                label.boxWidth = 6;
                                                label.boxHeight = 6;
                                            });
                                        }
                                        
                                        return originalLabels;
                                    }
                                },
                                // ä½¿ç”¨é»˜è®¤çš„legendç‚¹å‡»è¡Œä¸º(ä»…æ˜¾ç¤º/éšè—dataset)
                                onClick: Chart.defaults.plugins.legend.onClick
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#1F2937',
                                titleFont: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                bodyColor: '#4B5563',
                                bodyFont: {
                                    size: 13,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif'
                                },
                                borderColor: 'rgba(0, 0, 0, 0.1)',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true,
                                boxWidth: 10,
                                boxHeight: 10,
                                boxPadding: 4,
                                usePointStyle: true,
                                caretSize: 8,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return 'æ—¶é—´: ' + tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // æ ¹æ®æ•°æ®é›†ä½¿ç”¨çš„Yè½´æ˜¾ç¤ºä¸åŒçš„å•ä½
                                            const unit = context.dataset.yAxisID === 'y1' ? 'kW' : 'kWh';
                                            label += context.parsed.y.toFixed(2) + ' ' + unit;
                                        }
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    maxRotation: 0,
                                    autoSkip: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'ç”¨ç”µé‡ (kWh)',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            },
                            y1: {
                                display: appData.visualization.secondaryAxis,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'åŠŸç‡ (kW)',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false, // ä¸åœ¨å›¾è¡¨åŒºåŸŸç»˜åˆ¶ç½‘æ ¼çº¿
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const datasetIndex = element.datasetIndex;
                                const index = element.index;
                                const dataset = appData.chart.data.datasets[datasetIndex];
                                const value = dataset.data[index];
                                const label = appData.chart.data.labels[index];
                                
                                showNotification(
                                    'æ•°æ®ç‚¹è¯¦æƒ…', 
                                    `${dataset.label} åœ¨ ${label} çš„${dataset.yAxisID === 'y1' ? 'åŠŸç‡' : 'ç”¨ç”µé‡'}ä¸º ${value ? value.toFixed(2) : 'æ— æ•°æ®'} ${dataset.yAxisID === 'y1' ? 'kW' : 'kWh'}`,
                                    'info'
                                );
                            }
                        },
                        onHover: (event, elements) => {
                            event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            
                            // æ·»åŠ canvasåŒºåŸŸçš„äº’åŠ¨åé¦ˆ
                            const canvas = event.native.target;
                            if (elements.length > 0) {
                                canvas.style.filter = 'brightness(1.05)';
                            } else {
                                canvas.style.filter = 'brightness(1)';
                            }
                        }
                    }
                });
                
                // ç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæ•°æ®
                setTimeout(() => {
                    updateChart();
                }, 100);
            }

        // æ›´æ–°å¯è§†åŒ–éƒ¨åˆ†çš„æ—¥æœŸä¸‹æ‹‰é€‰æ‹©æ¡†
        function updateVisualizationDateSelects() {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            elements.startDateInput.innerHTML = '<option value="">-- è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸ --</option>';
            elements.endDateInput.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ --</option>';
            
            // å¦‚æœæ²¡æœ‰å¤„ç†è¿‡çš„æ•°æ®ï¼Œåˆ™è¿”å›
            if (appData.processedData.length === 0) return;
            
            const dateSet = new Set();
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„æ—¥æœŸ
            appData.processedData.forEach(row => {
                dateSet.add(row.date);
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const dates = Array.from(dateSet).sort();
            
            // æ·»åŠ åˆ°ä¸‹æ‹‰èœå•
            dates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.startDateInput.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.endDateInput.appendChild(option2);
            });
            
            // è®¾ç½®é»˜è®¤å€¼ä¸ºæœ€æ—©å’Œæœ€æ™šæ—¥æœŸ
            if (dates.length > 0) {
                elements.startDateInput.value = dates[0];
                elements.endDateInput.value = dates[dates.length - 1];
            }
        }

        function applyDateFilter() {
            const startDate = elements.startDateInput.value;
            const endDate = elements.endDateInput.value;
            
            if (!startDate || !endDate) {
                showNotification('è­¦å‘Š', 'è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´', 'warning');
                return;
            }
            
            // ç­›é€‰æ—¥æœŸ
            appData.visualization.selectedDates = appData.processedData
                .filter(d => {
                    return d.date >= startDate && d.date <= endDate;
                })
                .map(d => d.date);
            
            updateChart();
        }

        function selectAllDates() {
    appData.visualization.selectedDates = appData.processedData.map(d => d.date);
    
    // æ›´æ–°å›¾è¡¨æ ‡é¢˜ä»¥åæ˜ æ—¥æœŸé€‰æ‹©çŠ¶æ€
    if (appData.chart) {
        const selectedCount = appData.visualization.selectedDates.length;
        const totalCount = appData.processedData.length;
        appData.chart.options.plugins.title.text = `${appData.visualization.focusStartTime}:00 - ${appData.visualization.focusEndTime}:00 è´Ÿè·æ›²çº¿ (å·²é€‰æ‹© ${selectedCount}/${totalCount} ä¸ªæ—¥æœŸ)`;
    }
    
    updateChart();
}



        function applyMeteringPointFilter() {
            const selectedOptions = Array.from(elements.visualizationMeteringPointFilterSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showNotification('è­¦å‘Š', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®¡é‡ç‚¹ç¼–å·', 'warning');
                return;
            }
            
            // ç­›é€‰è®¡é‡ç‚¹ç¼–å·
            appData.visualization.selectedMeteringPoints = selectedOptions.map(option => option.value);
            
            updateChart();
        }
        
        function selectAllMeteringPoints() {
            appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
            
            // æ›´æ–°UIé€‰æ‹©çŠ¶æ€
            Array.from(elements.visualizationMeteringPointFilterSelect.options).forEach(option => {
                option.selected = true;
            });
            
            updateChart();
        }
        
        function applyTimeFocus() {
            const startHour = parseInt(elements.focusStartTimeSelect.value);
            const endHour = parseInt(elements.focusEndTimeSelect.value);
            
            if (startHour > endHour) {
                showNotification('è­¦å‘Š', 'å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´', 'warning');
                return;
            }
            
            appData.visualization.focusStartTime = startHour;
            appData.visualization.focusEndTime = endHour;
            
            // æ·»åŠ è§†è§‰åé¦ˆ
            elements.applyTimeFocusBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.applyTimeFocusBtn.style.transform = 'scale(1)';
            }, 200);
            
            // æ›´æ–°å›¾è¡¨å’Œç»Ÿè®¡ä¿¡æ¯
            updateChart();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('æ—¶é—´ç„¦æ®µæ›´æ–°', `å·²è®¾ç½®æ—¶é—´ç„¦æ®µä¸º ${startHour}:00 - ${endHour}:00`, 'success');
        }

        function resetTimeFocus() {
            elements.focusStartTimeSelect.value = '0';
            elements.focusEndTimeSelect.value = '23';
            appData.visualization.focusStartTime = 0;
            appData.visualization.focusEndTime = 23;
            
            // æ·»åŠ è§†è§‰åé¦ˆ
            elements.resetTimeFocusBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.resetTimeFocusBtn.style.transform = 'scale(1)';
            }, 200);
            
            // æ›´æ–°å›¾è¡¨å’Œç»Ÿè®¡ä¿¡æ¯
            updateChart();
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('æ—¶é—´ç„¦æ®µé‡ç½®', 'å·²é‡ç½®æ—¶é—´ç„¦æ®µä¸ºå…¨å¤© (0:00 - 23:00)', 'success');
        }

        // å›¾è¡¨æ€§èƒ½ä¼˜åŒ–é…ç½®
        const CHART_PERFORMANCE = {
            maxDataPoints: 500,       // æœ€å¤§æ˜¾ç¤ºæ•°æ®ç‚¹æ•°ï¼ˆæ”¯æŒæ˜¾ç¤ºæ›´å¤šæ›²çº¿ï¼‰
            pageSize: 100,           // æ¯é¡µæ•°æ®é‡ï¼ˆå¢åŠ æ¯é¡µæ˜¾ç¤ºæ•°é‡ï¼‰
            animationDuration: 300,   // åŠ¨ç”»æŒç»­æ—¶é—´
            enableVirtualization: true // å¯ç”¨è™šæ‹ŸåŒ–
        };
        
        // æ•°æ®åˆ†é¡µç®¡ç†
        const chartPagination = {
            currentPage: 0,
            totalPages: 0,
            pageSize: CHART_PERFORMANCE.pageSize,
            totalItems: 0
        };
        
        // é‡æ–°è®¾è®¡çš„24å°æ—¶è´Ÿè·æ•°æ®æ›´æ–°å‡½æ•°
        function updateChart() {
            console.log('=== å¼€å§‹æ›´æ–°24å°æ—¶è´Ÿè·æ•°æ® ===');
            
            // æ£€æŸ¥å›¾è¡¨å®ä¾‹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é‡æ–°åˆå§‹åŒ–
            if (!appData.chart) {
                initializeVisualization();
                return;
            }
            
            // å¦‚æœå›¾è¡¨Canvaså·²è¢«æ›¿æ¢æˆ–ä¸åœ¨æ–‡æ¡£ä¸­ï¼Œé‡æ–°åˆå§‹åŒ–
            if (!appData.chart.canvas || !document.body.contains(appData.chart.canvas)) {
                try { appData.chart.destroy(); } catch (e) {}
                appData.chart = null;
                initializeVisualization();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const chartLoadingElement = document.getElementById('chartLoading');
            const noDataMessageElement = document.getElementById('noDataMessage');
            if (chartLoadingElement && chartLoadingElement.parentNode) {
                chartLoadingElement.classList.remove('hidden');
            }
            if (noDataMessageElement && noDataMessageElement.parentNode) {
                noDataMessageElement.classList.add('hidden');
            }
            
            // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
            requestAnimationFrame(() => {
                try {
                    // è·å–ç­›é€‰åçš„æ•°æ®
                    let filteredData = getFilteredData();
                    console.log('ç­›é€‰åçš„æ•°æ®æ¡æ•°:', filteredData.length);
                    
                    if (filteredData.length === 0) {
                        console.warn('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®');
                        const chartLoadingEl = document.getElementById('chartLoading');
                        const noDataMessageEl = document.getElementById('noDataMessage');
                        if (chartLoadingEl && chartLoadingEl.parentNode) {
                            chartLoadingEl.classList.add('hidden');
                        }
                        if (noDataMessageEl && noDataMessageEl.parentNode) {
                            noDataMessageEl.classList.remove('hidden');
                        }
                        return;
                    }

                    // æ›´æ–°åˆ†é¡µä¿¡æ¯å¹¶åˆ‡ç‰‡ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
                    chartPagination.totalItems = filteredData.length;
                    chartPagination.totalPages = Math.ceil(filteredData.length / chartPagination.pageSize);
                    if (filteredData.length > CHART_PERFORMANCE.maxDataPoints) {
                        const startIndex = chartPagination.currentPage * chartPagination.pageSize;
                        const endIndex = Math.min(startIndex + chartPagination.pageSize, filteredData.length);
                        filteredData = filteredData.slice(startIndex, endIndex);
                        showPaginationControls();
                    } else {
                        hidePaginationControls();
                    }
                    
                    // æŒ‰æ—¥æœŸå’Œè®¡é‡ç‚¹åˆ†ç»„æ•°æ®
                    const groupedData = groupDataByDateAndMeteringPoint(filteredData);
                    console.log('æŒ‰æ—¥æœŸåˆ†ç»„çš„æ•°æ®:', Object.keys(groupedData).length, 'ä¸ªæ—¥æœŸ');
                    
                    // æ ¹æ®æ—¶é—´ç„¦æ®µè®¾ç½®å‡†å¤‡å›¾è¡¨æ•°æ®
                    const startHour = appData.visualization.focusStartTime;
                    const endHour = appData.visualization.focusEndTime;
                    const hourCount = endHour - startHour + 1;
                    const labels = Array.from({ length: hourCount }, (_, i) => `${startHour + i}:00`);
                    
                    // åˆ›å»ºæ•°æ®é›†ï¼ˆæ ¹æ®æ¨¡å¼ä¸æ—¶æ®µèšç„¦è¿‡æ»¤æ•°æ®ï¼‰
                    const datasets = appData.visualization.summaryMode
                        ? createSummaryDatasets(filteredData, startHour, endHour)
                        : createOptimizedDatasets(filteredData, startHour, endHour);
                    
                    // æ›´æ–°å›¾è¡¨æ•°æ®å’Œé€‰é¡¹
                    updateChartDataAndOptions(labels, datasets, filteredData, startHour, endHour);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    const displayData = Object.values(groupedData).map(data => ({
                        date: data.date,
                        meteringPoint: data.meteringPoint,
                        hourlyData: data.hourlyData,
                        dailyTotal: data.hourlyData.reduce((sum, val) => sum + (val || 0), 0)
                    }));
                    updateStatistics(displayData, startHour, endHour);
                    
                    console.log('=== 24å°æ—¶è´Ÿè·æ•°æ®æ›´æ–°å®Œæˆ ===');
                } catch (error) {
                    console.error('24å°æ—¶è´Ÿè·æ›²çº¿æ›´æ–°é”™è¯¯:', error);
                    handleChartError(error);
                }
            });
        }
        
        function updateChartWithPagination() {
            // è·å–ç­›é€‰åçš„æ•°æ®
            let filteredData = getFilteredData();
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            chartPagination.totalItems = filteredData.length;
            chartPagination.totalPages = Math.ceil(filteredData.length / chartPagination.pageSize);
            
            // å¦‚æœæ•°æ®é‡è¶…è¿‡æœ€å¤§æ˜¾ç¤ºé™åˆ¶ï¼Œå¯ç”¨åˆ†é¡µ
            if (filteredData.length > CHART_PERFORMANCE.maxDataPoints) {
                const startIndex = chartPagination.currentPage * chartPagination.pageSize;
                const endIndex = Math.min(startIndex + chartPagination.pageSize, filteredData.length);
                filteredData = filteredData.slice(startIndex, endIndex);
                
                // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
                showPaginationControls();
            } else {
                // éšè—åˆ†é¡µæ§ä»¶
                hidePaginationControls();
            }
            
            // æ ¹æ®æ—¶é—´ç„¦æ®µè®¾ç½®å‡†å¤‡å›¾è¡¨æ•°æ®
            const startHour = appData.visualization.focusStartTime;
            const endHour = appData.visualization.focusEndTime;
            const hourCount = endHour - startHour + 1;
            const labels = Array.from({ length: hourCount }, (_, i) => `${startHour + i}:00`);
            
            // åˆ›å»ºæ•°æ®é›†
            const datasets = appData.visualization.summaryMode
                ? createSummaryDatasets(filteredData, startHour, endHour)
                : createOptimizedDatasets(filteredData, startHour, endHour);
            
            // æ›´æ–°å›¾è¡¨æ•°æ®å’Œé€‰é¡¹
            updateChartDataAndOptions(labels, datasets, filteredData, startHour, endHour);
        }
        
        // ä¼˜åŒ–çš„æ•°æ®é›†åˆ›å»ºå‡½æ•°
        function createOptimizedDatasets(filteredData, startHour, endHour) {
            console.log('=== createOptimizedDatasets è°ƒè¯•ä¿¡æ¯ ===');
            console.log('è¾“å…¥æ•°æ®æ€»æ•°:', filteredData.length);
            
            const datasets = [];
            
            // ä½¿ç”¨ DataUtils æŒ‰æ—¥æœŸåˆ†ç»„æ•°æ®
            const dateGroupsMap = DataUtils.groupBy(filteredData, row => row.date);
            console.log('åˆ†ç»„åçš„æ—¥æœŸæ•°é‡:', dateGroupsMap.size);
            console.log('åˆ†ç»„çš„æ—¥æœŸ:', Array.from(dateGroupsMap.keys()));
             
            // ä¸ºæ¯ä¸ªæ—¥æœŸåˆ›å»ºæ•°æ®é›†ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
            let colorIndex = 0;
            const sortedDates = Array.from(dateGroupsMap.keys()).sort();
            
            sortedDates.forEach(dateKey => {
                const rows = dateGroupsMap.get(dateKey);
                
                // åˆå¹¶åŒä¸€æ—¥æœŸçš„æ‰€æœ‰è¡Œæ•°æ®
                const mergedHourlyData = new Array(24).fill(null);
                
                rows.forEach(row => {
                    for (let hour = 0; hour < 24; hour++) {
                        if (row.hourlyData[hour] !== null) {
                            if (mergedHourlyData[hour] !== null) {
                                // å¦‚æœå·²æœ‰æ•°æ®ï¼Œå–æ€»å’Œ
                                mergedHourlyData[hour] = mergedHourlyData[hour] + row.hourlyData[hour];
                            } else {
                                mergedHourlyData[hour] = row.hourlyData[hour];
                            }
                        }
                    }
                });
                
                // æ ¹æ®æ—¶é—´ç„¦æ®µè®¾ç½®è¿‡æ»¤æ•°æ®
                const filteredHourlyData = mergedHourlyData.slice(startHour, endHour + 1);
                
                // ä¸ºæ¯ä¸ªæ—¥æœŸç”Ÿæˆä¸åŒçš„é¢œè‰²
                const color = getColor(colorIndex % getColorCount());
                colorIndex++;
                
                // æ ¹æ®ç”¨æˆ·è®¾ç½®ç¡®å®šçº¿æ¡æ ·å¼
                let borderDash = [];
                if (appData.visualization.lineStyle === 'dashed') {
                    borderDash = [5, 5];
                } else if (appData.visualization.lineStyle === 'dotted') {
                    borderDash = [2, 2];
                }
                
                // æ ¹æ®ç”¨æˆ·è®¾ç½®ç¡®å®šæ˜¯å¦æ˜¾ç¤ºæ•°æ®ç‚¹
                const pointRadius = appData.visualization.showPoints ? 4 : 0;
                const pointHoverRadius = 6;
                
                // æ ¹æ®ç”¨æˆ·è®¾ç½®ç¡®å®šæ›²çº¿å¹³æ»‘åº¦
                const tension = appData.visualization.smoothCurve ? appData.visualization.curveTension : 0;
                
                // åˆ›å»ºæ¸å˜èƒŒæ™¯
                const gradient = appData.chart.ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color.replace('rgb', 'rgba').replace(')', ', 0.4)'));
                gradient.addColorStop(1, color.replace('rgb', 'rgba').replace(')', ', 0.05)'));
                
                // åˆ›å»ºä¼˜åŒ–çš„æ•°æ®é›†é…ç½®
                const datasetConfig = createDatasetConfig(dateKey, filteredHourlyData, color, borderDash, pointRadius, pointHoverRadius, tension);
                datasets.push(datasetConfig);
            });
             
            return datasets;
        }
        
        // æ–°å¢ï¼šæ±‡æ€»æ¨¡å¼æ•°æ®é›†ï¼ˆæœ€é«˜/æœ€ä½ + å››å­£åº¦å¹³å‡ + 1~12æœˆæœˆå¹³å‡ï¼‰
        function createSummaryDatasets(filteredData, startHour, endHour) {
            // æŒ‰â€œå¤©â€èšåˆï¼ŒåŒæ—¶è®°å½•æ¯å°æ—¶æ˜¯å¦æœ‰æ•°æ®ï¼ˆä½œä¸ºæ˜¯å¦è®¡å…¥è¯¥å°æ—¶åˆ†æ¯çš„ä¾æ®ï¼‰
            const dayMap = new Map();
            for (const row of filteredData) {
                const dateObj = row.dateObj || parseDate(row.date, appData.config.dateFormat);
                if (!dateObj || isNaN(dateObj)) continue;
                const dateKey = formatDateForInput(dateObj);
                if (!dayMap.has(dateKey)) {
                    dayMap.set(dateKey, {
                        dateObj,
                        hourly: Array(24).fill(0),  // å½“å¤©æ¯å°æ—¶æ€»é‡ï¼ˆè‹¥åŒä¸€æ—¥æœŸæœ‰å¤šæ¡è®°å½•åˆ™ç´¯åŠ ï¼‰
                        hrCount: Array(24).fill(0), // å½“å¤©æ¯å°æ—¶æ˜¯å¦æœ‰æ•°æ®ï¼š>0 è¡¨ç¤ºè¯¥å¤©è¯¥å°æ—¶æœ‰æ•°æ®
                        dailyTotal: 0
                    });
                }
                const agg = dayMap.get(dateKey);
                for (let h = 0; h < 24; h++) {
                    const v = row.hourlyData[h];
                    if (v != null && !isNaN(v)) {
                        agg.hourly[h] += v;
                        agg.hrCount[h] += 1; // æ ‡è®°è¯¥å¤©è¯¥å°æ—¶æœ‰æ•°æ®
                        agg.dailyTotal += v;
                    }
                }
            }
            if (dayMap.size === 0) return [];
            const days = Array.from(dayMap.values());

            // æœ€é«˜/æœ€ä½ç”¨ç”µæ—¥ï¼ˆä»¥å½“å¤©24å°æ—¶æ€»é‡ä¸ºåˆ¤å®šï¼‰
            let maxDay = days[0];
            let minDay = days[0];
            for (const d of days) {
                if (d.dailyTotal > maxDay.dailyTotal) maxDay = d;
                if (d.dailyTotal < minDay.dailyTotal) minDay = d;
            }
            const maxDaySeries = maxDay.hourly.slice(startHour, endHour + 1);
            const minDaySeries = minDay.hourly.slice(startHour, endHour + 1);

            // å­£åº¦ä¸æœˆä»½åˆ†æ¡¶ï¼ˆæŒ‰â€œå¤©â€ä½œä¸ºå•ä½ï¼‰
            const quarterBuckets = [[], [], [], []]; // æ¯ä¸ªå…ƒç´ æ˜¯ day å¯¹è±¡
            const monthBuckets = Array.from({ length: 12 }, () => []);
            for (const d of days) {
                const m = d.dateObj.getMonth() + 1; // 1~12
                const q = m <= 3 ? 0 : m <= 6 ? 1 : m <= 9 ? 2 : 3;
                quarterBuckets[q].push(d);
                monthBuckets[m - 1].push(d);
            }

            // å¹³å‡å‡½æ•°ï¼šä»¥â€œæœ‰æ•°æ®çš„å¤©æ•°â€ä¸ºåˆ†æ¯ï¼ˆhrCount[h] > 0 è§†ä¸ºè¯¥å¤©è¯¥å°æ—¶æœ‰æ•°æ®ï¼‰
            function avgSeries(dayList) {
                const len = endHour - startHour + 1;
                if (dayList.length === 0) return Array(len).fill(null);
                const sum = Array(24).fill(0);
                const cntDays = Array(24).fill(0);
                for (const d of dayList) {
                    for (let h = 0; h < 24; h++) {
                        if (d.hrCount[h] > 0) { // è¯¥å¤©è¯¥å°æ—¶æœ‰æ•°æ®
                            sum[h] += d.hourly[h];
                            cntDays[h] += 1; // åˆ†æ¯æŒ‰â€œå¤©æ•°â€è®¡æ•°
                        }
                    }
                }
                const avg = sum.map((v, i) => (cntDays[i] > 0 ? v / cntDays[i] : null));
                return avg.slice(startHour, endHour + 1);
            }

            // å››å­£åº¦å¹³å‡
            const q1Series = avgSeries(quarterBuckets[0]);
            const q2Series = avgSeries(quarterBuckets[1]);
            const q3Series = avgSeries(quarterBuckets[2]);
            const q4Series = avgSeries(quarterBuckets[3]);

            // 1~12æœˆå¹³å‡
            const monthSeries = monthBuckets.map(list => avgSeries(list));

            function makeDataset(label, data, color, dash = []) {
                // è®©æ±‡æ€»æ›²çº¿è”åŠ¨æ ·å¼è®¾ç½®ï¼šçº¿å‹ä¸æ•°æ®ç‚¹
                let computedDash = [];
                if (appData.visualization.lineStyle === 'dashed') {
                    computedDash = [5, 5];
                } else if (appData.visualization.lineStyle === 'dotted') {
                    computedDash = [2, 2];
                } else {
                    // UI é€‰æ‹© solid æ—¶ï¼Œä¿ç•™ä¼ å…¥çš„ dashï¼ˆå¦‚å­£åº¦/æœˆä»½å¹³å‡ä½¿ç”¨è™šçº¿çš„é»˜è®¤æ ·å¼ï¼‰
                    computedDash = dash;
                }
                const showPoints = !!appData.visualization.showPoints;
                const pr = showPoints ? 4 : 0;
                return {
                    label,
                    data,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    borderDash: computedDash,
                    pointRadius: pr,
                    pointHoverRadius: 6,
                    pointStyle: 'circle',
                    pointBackgroundColor: color,
                    pointBorderColor: color,
                    pointBorderWidth: 2,
                    tension: appData.visualization.smoothCurve ? appData.visualization.curveTension : 0,
                    fill: false,
                    yAxisID: 'y',
                    spanGaps: true
                };
            }

            // è°ƒè‰²æ¿ï¼ˆ12ä¸ªæœˆä»½ + å­£åº¦ï¼‰
            const monthColors = [
                'rgb(244, 63, 94)',   // 1æœˆ
                'rgb(249, 115, 22)',  // 2æœˆ
                'rgb(234, 179, 8)',   // 3æœˆ
                'rgb(132, 204, 22)',  // 4æœˆ
                'rgb(16, 185, 129)',  // 5æœˆ
                'rgb(14, 165, 233)',  // 6æœˆ
                'rgb(59, 130, 246)',  // 7æœˆ
                'rgb(99, 102, 241)',  // 8æœˆ
                'rgb(168, 85, 247)',  // 9æœˆ
                'rgb(236, 72, 153)',  // 10æœˆ
                'rgb(125, 211, 252)', // 11æœˆ
                'rgb(107, 114, 128)'  // 12æœˆ
            ];

            const datasets = [];
            // æœ€é«˜/æœ€ä½ç”¨ç”µæ—¥
            datasets.push(makeDataset(`æœ€é«˜ç”¨ç”µæ—¥ (${formatDateForInput(maxDay.dateObj)})`, maxDaySeries, 'rgb(220, 38, 38)'));
            datasets.push(makeDataset(`æœ€ä½ç”¨ç”µæ—¥ (${formatDateForInput(minDay.dateObj)})`, minDaySeries, 'rgb(37, 99, 235)'));
            // å­£åº¦å¹³å‡
            datasets.push(makeDataset('Q1å¹³å‡(1-3æœˆ)', q1Series, 'rgb(16, 185, 129)', [6, 4]));
            datasets.push(makeDataset('Q2å¹³å‡(4-6æœˆ)', q2Series, 'rgb(234, 179, 8)', [6, 4]));
            datasets.push(makeDataset('Q3å¹³å‡(7-9æœˆ)', q3Series, 'rgb(168, 85, 247)', [6, 4]));
            datasets.push(makeDataset('Q4å¹³å‡(10-12æœˆ)', q4Series, 'rgb(79, 70, 229)', [6, 4]));
            // æœˆå¹³å‡ï¼ˆ1~12æœˆï¼‰ï¼Œé»˜è®¤ç”¨æ›´çŸ­çš„è™šçº¿ä»¥ä¾¿ä¸å­£åº¦åŒºåˆ†
            for (let m = 1; m <= 12; m++) {
                datasets.push(
                    makeDataset(`${m}æœˆå¹³å‡`, monthSeries[m - 1], monthColors[m - 1], [4, 2])
                );
            }
            return datasets;
        }
        
        // åˆ›å»ºæ•°æ®é›†é…ç½®
        function createDatasetConfig(dateKey, filteredHourlyData, color, borderDash, pointRadius, pointHoverRadius, tension) {
            return {
                label: dateKey,
                data: filteredHourlyData,
                borderColor: color,
                backgroundColor: 'transparent',
                borderWidth: 3,
                borderDash: borderDash,
                borderCapStyle: 'round',
                borderJoinStyle: 'round',
                segment: {
                    borderColor: ctx => {
                        return ctx.p0.parsed.y !== null && ctx.p1.parsed.y !== null ? color : 'rgba(0,0,0,0)';
                    },
                    borderDash: ctx => {
                        return ctx.p0.parsed.y !== null && ctx.p1.parsed.y !== null ? borderDash : [];
                    }
                },
                pointRadius: pointRadius,
                pointHoverRadius: pointHoverRadius,
                pointStyle: 'circle',
                pointBorderWidth: 2,
                pointBackgroundColor: color,
                pointBorderColor: color,
                pointHoverBackgroundColor: color,
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 0,
                tension: tension,
                fill: false,
                yAxisID: 'y',
                spanGaps: true
            };
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®å’Œé€‰é¡¹
        function updateChartDataAndOptions(labels, datasets, filteredData, startHour, endHour) {
            // æ›´æ–°å›¾è¡¨æ•°æ®
            appData.chart.data.labels = labels;
            appData.chart.data.datasets = datasets;
            

            
            // æ›´æ–°å›¾è¡¨é€‰é¡¹
            // æ›´æ–°å›¾è¡¨æ ‡é¢˜ä»¥åæ˜ æ—¶é—´ç„¦æ®µå’Œæ—¥æœŸé€‰æ‹©çŠ¶æ€
            const selectedCount = appData.visualization.selectedDates.length;
            const totalCount = appData.processedData.length;
            if (appData.visualization.summaryMode) {
                appData.chart.options.plugins.title.text = `${startHour}:00 - ${endHour}:00 æ±‡æ€»æ›²çº¿ï¼ˆæœ€é«˜/æœ€ä½ + å­£åº¦å¹³å‡ + æœˆå¹³å‡ï¼‰`;
            } else {
                appData.chart.options.plugins.title.text = `${startHour}:00 - ${endHour}:00 è´Ÿè·æ›²çº¿ (å·²é€‰æ‹© ${selectedCount}/${totalCount} ä¸ªæ—¥æœŸ)`;
            }
            
            // æŠ˜çº¿å›¾æ¨¡å¼ä¸‹çš„é€‰é¡¹
            appData.chart.options.scales.x.stacked = false;
            appData.chart.options.scales.y.stacked = false;
            appData.chart.options.plugins.tooltip.mode = 'index';
            appData.chart.options.plugins.tooltip.intersect = false;
            
            // æ›´æ–°è¾…åŠ©Yè½´
            appData.chart.options.scales.y1 = {
                display: appData.visualization.secondaryAxis,
                position: 'right',
                title: {
                    display: true,
                    text: 'åŠŸç‡ (kW)',
                    font: {
                        size: 14
                    }
                },
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false // ä¸åœ¨å›¾è¡¨åŒºåŸŸç»˜åˆ¶ç½‘æ ¼çº¿
                }
            };
            
            // ä½¿ç”¨ä¼˜åŒ–çš„æ›´æ–°æ–¹å¼
            updateChartWithAnimation();
            
            // æ±‡æ€»æ¨¡å¼ä¸‹éšè—åˆ†é¡µæ§ä»¶
            if (appData.visualization.summaryMode) {
                hidePaginationControls();
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ - ä½¿ç”¨æ­£ç¡®çš„æ•°æ®æ ¼å¼
            updateStatistics(filteredData, startHour, endHour);
            

            
            // éšè—åŠ è½½çŠ¶æ€
            const chartLoadingFinalElement = document.getElementById('chartLoading');
            if (chartLoadingFinalElement && chartLoadingFinalElement.parentNode) {
                chartLoadingFinalElement.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºæ•°æ®çŠ¶æ€
            updateDataStatus(datasets.length);
        }
        
        // ä¼˜åŒ–çš„å›¾è¡¨æ›´æ–°å‡½æ•°
        function updateChartWithAnimation() {
            try {
                if (appData.chart && typeof appData.chart.update === 'function') {
                    // ä½¿ç”¨å¹³æ»‘åŠ¨ç”»æ›´æ–°
                    appData.chart.update({
                        duration: CHART_PERFORMANCE.animationDuration,
                        easing: 'easeInOutQuart'
                    });
                }
            } catch (error) {
                console.error('å›¾è¡¨æ›´æ–°é”™è¯¯:', error);
                handleChartError(error);
            }
        }
        
        // å›¾è¡¨é”™è¯¯å¤„ç†
        function handleChartError(error) {
            try {
                if (appData.chart) {
                    appData.chart.destroy();
                    appData.chart = null;
                }
                initializeVisualization();
            } catch (secondError) {
                console.error('å›¾è¡¨é‡æ–°åˆå§‹åŒ–å¤±è´¥:', secondError);
                showNotification('é”™è¯¯', 'å›¾è¡¨æ›´æ–°å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }
        
        // åˆ†é¡µæ§ä»¶ç®¡ç†
        function showPaginationControls() {
            let paginationContainer = document.getElementById('chartPagination');
            if (!paginationContainer) {
                paginationContainer = createPaginationContainer();
            }
            
            updatePaginationControls();
            if (paginationContainer && paginationContainer.parentNode) {
                paginationContainer.classList.remove('hidden');
            }
        }
        
        function hidePaginationControls() {
            const paginationContainer = document.getElementById('chartPagination');
            if (paginationContainer && paginationContainer.parentNode) {
                paginationContainer.classList.add('hidden');
            }
        }
        
        function createPaginationContainer() {
            const container = document.createElement('div');
            container.id = 'chartPagination';
            container.className = 'flex items-center justify-between mt-4 p-4 bg-gray-50 rounded-lg';
            
            container.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">æ˜¾ç¤ºç¬¬ <span id="currentPageInfo">1</span> é¡µï¼Œå…± <span id="totalPagesInfo">1</span> é¡µ</span>
                    <span class="text-sm text-gray-500">ï¼ˆå…± <span id="totalItemsInfo">0</span> æ¡æ•°æ®ï¼‰</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="prevPageBtn" class="btn-secondary btn-sm" onclick="changePage(-1)">
                        <i class="fa fa-chevron-left"></i> ä¸Šä¸€é¡µ
                    </button>
                    <button id="nextPageBtn" class="btn-secondary btn-sm" onclick="changePage(1)">
                        ä¸‹ä¸€é¡µ <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            `;
            
            // æ’å…¥åˆ°å›¾è¡¨å®¹å™¨åé¢
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.parentNode.insertBefore(container, chartContainer.nextSibling);
            }
            
            return container;
        }
        
        function updatePaginationControls() {
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…nullé”™è¯¯
            const currentPageInfo = document.getElementById('currentPageInfo');
            const totalPagesInfo = document.getElementById('totalPagesInfo');
            const totalItemsInfo = document.getElementById('totalItemsInfo');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            
            if (currentPageInfo && currentPageInfo.parentNode) currentPageInfo.textContent = chartPagination.currentPage + 1;
            if (totalPagesInfo && totalPagesInfo.parentNode) totalPagesInfo.textContent = chartPagination.totalPages;
            if (totalItemsInfo && totalItemsInfo.parentNode) totalItemsInfo.textContent = chartPagination.totalItems;
            
            if (prevPageBtn) prevPageBtn.disabled = chartPagination.currentPage === 0;
            if (nextPageBtn) nextPageBtn.disabled = chartPagination.currentPage >= chartPagination.totalPages - 1;
        }
        
        // åˆ†é¡µåˆ‡æ¢å‡½æ•°ï¼ˆæ”¯æŒç›¸å¯¹/ç»å¯¹è·³è½¬ï¼‰
        function changePage(directionOrPage, isAbsolute = false) {
            let newPage;
            if (isAbsolute) {
                newPage = directionOrPage;
            } else {
                newPage = chartPagination.currentPage + directionOrPage;
            }
            if (newPage >= 0 && newPage < chartPagination.totalPages) {
                chartPagination.currentPage = newPage;
                updateChart();
            }
        }
        
        // æ•°æ®çŠ¶æ€æ›´æ–°
        function updateDataStatus(datasetCount) {
            // æŸ±çŠ¶å›¾å§‹ç»ˆæ˜¾ç¤ºï¼ˆå¢åŠ ç©ºå€¼ä¿æŠ¤ï¼‰
            const barCanvas = document.getElementById('dailyTotalBarChart');
            if (barCanvas && barCanvas.parentElement && barCanvas.parentElement.parentElement) {
                const barChartContainer = barCanvas.parentElement.parentElement;
                barChartContainer.style.display = 'block';
            }
            updateDailyTotalBarChart(getFilteredData());
            
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯ï¼Œå¦åˆ™éšè—
            const noDataMsgElement = document.getElementById('noDataMessage');
            if (datasetCount === 0) {
                if (noDataMsgElement && noDataMsgElement.parentNode) {
                    noDataMsgElement.classList.remove('hidden');
                }
            } else {
                if (noDataMsgElement && noDataMsgElement.parentNode) {
                    noDataMsgElement.classList.add('hidden');
                }
            }
        }

        function updateStatistics(displayData, startHour, endHour) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥æ—¶é—´ç„¦æ®µè®¾ç½®ï¼Œä½¿ç”¨appDataä¸­çš„è®¾ç½®ï¼ˆæ³¨æ„0å€¼æ˜¯æœ‰æ•ˆçš„ï¼‰
            if (typeof startHour !== 'number' || typeof endHour !== 'number') {
                startHour = appData.visualization.focusStartTime;
                endHour = appData.visualization.focusEndTime;
            }
            

            
            // è®¡ç®—æ—¶æ®µç»Ÿè®¡
            function generatePeriodStats() {
                let html = '<div class="max-h-96 overflow-y-auto">';
                
                // æ—¶æ®µåˆ†ææ±‡æ€»
                let totalPeriodAll = 0;
                let totalDailyAll = 0;
                let periodHours = endHour - startHour + 1;

                // æ–°å¢ï¼šè·Ÿè¸ªæ—¶æ®µç”¨ç”µé‡çš„æœ€å¤§/æœ€å°æ—¥
                let maxPeriodTotal = -Infinity;
                let maxPeriodDate = '';
                let minPeriodTotal = Infinity;
                let minPeriodDate = '';
                
                displayData.forEach(dateData => {
                    let periodTotal = 0;
                    for (let hour = startHour; hour <= endHour; hour++) {
                        if (dateData.hourlyData[hour] !== null) {
                            periodTotal += dateData.hourlyData[hour];
                        }
                    }
                    totalPeriodAll += periodTotal;
                    totalDailyAll += dateData.dailyTotal;

                    // è®°å½•æœ€å¤§/æœ€å°æ—¥
                    if (periodTotal > maxPeriodTotal) {
                        maxPeriodTotal = periodTotal;
                        maxPeriodDate = dateData.date;
                    }
                    if (periodTotal < minPeriodTotal) {
                        minPeriodTotal = periodTotal;
                        minPeriodDate = dateData.date;
                    }
                });
                
                const overallPeriodPercentage = totalDailyAll > 0 ? (totalPeriodAll / totalDailyAll) * 100 : 0;
                const denom = displayData.length * periodHours;
                const avgHourlyInPeriod = denom > 0 ? (totalPeriodAll / denom) : 0;
                
                // æ—¶æ®µåˆ†æå¡ç‰‡
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
                html += '<div class="bg-blue-50 p-3 rounded-lg border border-blue-200">';
                html += '<div class="text-blue-700 text-sm font-medium">æ—¶æ®µæ€»ç”¨ç”µ</div>';
                html += `<div class="text-blue-900 text-lg font-bold">${totalPeriodAll.toFixed(2)} kWh</div>`;
                html += '</div>';
                
                html += '<div class="bg-green-50 p-3 rounded-lg border border-green-200">';
                html += '<div class="text-green-700 text-sm font-medium">å å…¨å¤©æ¯”ä¾‹</div>';
                html += `<div class="text-green-900 text-lg font-bold">${overallPeriodPercentage.toFixed(1)}%</div>`;
                html += '</div>';
                
                html += '<div class="bg-purple-50 p-3 rounded-lg border border-purple-200">';
                html += '<div class="text-purple-700 text-sm font-medium">æ—¶æ®µå¹³å‡å°æ—¶ç”¨ç”µ</div>';
                html += `<div class="text-purple-900 text-lg font-bold">${avgHourlyInPeriod.toFixed(2)} kWh</div>`;
                html += '</div>';
                
                html += '<div class="bg-orange-50 p-3 rounded-lg border border-orange-200">';
                html += '<div class="text-orange-700 text-sm font-medium">ç”¨ç”µé‡æœ€å¤§æ—¥</div>';
                html += `<div class="text-orange-900 text-lg font-bold">${maxPeriodDate || '-'}ï¼š${isFinite(maxPeriodTotal) ? maxPeriodTotal.toFixed(2) : '0.00'} kWh</div>`;
                html += '</div>';

                html += '<div class="bg-amber-50 p-3 rounded-lg border border-amber-200">';
                html += '<div class="text-amber-700 text-sm font-medium">ç”¨ç”µé‡æœ€å°æ—¥</div>';
                html += `<div class="text-amber-900 text-lg font-bold">${minPeriodDate || '-'}ï¼š${isFinite(minPeriodTotal) ? minPeriodTotal.toFixed(2) : '0.00'} kWh</div>`;
                html += '</div>';
                html += '</div>';
                
                // è¯¦ç»†æ—¶æ®µç»Ÿè®¡è¡¨æ ¼
                html += '<table class="w-full border-collapse whitespace-nowrap">';
                html += '<thead>';
                html += '<tr class="bg-gray-50">';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">æ—¥æœŸ</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">æ—¶æ®µç”¨ç”µé‡ (kWh)</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">å å…¨å¤©æ¯”ä¾‹</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">æ—¶æ®µå¹³å‡å°æ—¶ (kWh)</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">æ—¥æ€»ç”¨ç”µé‡ (kWh)</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';
                
                displayData.forEach((dateData, index) => {
                    let periodTotal = 0;
                    let validHours = 0;
                    
                    for (let hour = startHour; hour <= endHour; hour++) {
                        if (dateData.hourlyData[hour] !== null && dateData.hourlyData[hour] !== undefined) {
                            periodTotal += dateData.hourlyData[hour];
                            validHours++;
                        }
                    }
                    
                    const dailyPercentage = dateData.dailyTotal > 0 ? (periodTotal / dateData.dailyTotal) * 100 : 0;
                    const hourlyAverage = validHours > 0 ? periodTotal / validHours : 0;
                    
                    const color = getColorForIndex(index);
                    
                    html += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}">`;
                    html += `<td class="border border-gray-200 p-2 text-center" style="color: ${color}">${dateData.date}</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center font-medium">${periodTotal.toFixed(2)}</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center">`;
                    html += `<span class="${dailyPercentage > 50 ? 'text-red-600 font-bold' : dailyPercentage > 30 ? 'text-orange-600' : 'text-green-600'}">${dailyPercentage.toFixed(1)}%</span>`;
                    html += `</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center">${hourlyAverage.toFixed(2)}</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center">${dateData.dailyTotal.toFixed(2)}</td>`;
                    html += '</tr>';
                });
                
                html += '<tr class="bg-blue-50 font-medium">';
                html += '<td class="border border-gray-200 p-2 text-center">æ€»è®¡/å¹³å‡</td>';
                html += `<td class="border border-gray-200 p-2 text-center">${totalPeriodAll.toFixed(2)}</td>`;
                html += `<td class="border border-gray-200 p-2 text-center">${overallPeriodPercentage.toFixed(1)}%</td>`;
                html += `<td class="border border-gray-200 p-2 text-center">${avgHourlyInPeriod.toFixed(2)}</td>`;
                html += `<td class="border border-gray-200 p-2 text-center">${totalDailyAll.toFixed(2)}</td>`;
                html += '</tr>';
                html += '</tbody>';
                html += '</table>';
                
                // æ—¶æ®µåˆ†æè¯´æ˜
                html += '<div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-700">';
                html += '<div class="font-medium mb-2">ğŸ“Š æ—¶æ®µåˆ†æè¯´æ˜ï¼š</div>';
                html += '<ul class="list-disc list-inside space-y-1">';
                html += `<li>åˆ†ææ—¶æ®µï¼š${startHour}:00 - ${endHour}:00ï¼ˆå…±${periodHours}å°æ—¶ï¼‰</li>`;
                html += `<li>æ•°æ®å¤©æ•°ï¼š${displayData.length}å¤©</li>`;
                html += `<li>æ—¶æ®µæ€»ç”¨ç”µï¼š${totalPeriodAll.toFixed(2)} kWhï¼Œå å…¨å¤©${overallPeriodPercentage.toFixed(1)}%</li>`;
                html += `<li>ç”¨ç”µé‡æœ€å¤§æ—¥ï¼š${maxPeriodDate || '-'}ï¼ˆ${isFinite(maxPeriodTotal) ? maxPeriodTotal.toFixed(2) : '0.00'} kWhï¼‰</li>`;
                html += `<li>ç”¨ç”µé‡æœ€å°æ—¥ï¼š${minPeriodDate || '-'}ï¼ˆ${isFinite(minPeriodTotal) ? minPeriodTotal.toFixed(2) : '0.00'} kWhï¼‰</li>`;
                html += '</ul>';
                html += '</div>';
                
                html += '</div>';
                return html;
            }
            
            // ç›´æ¥æ˜¾ç¤ºæ—¶æ®µç»Ÿè®¡ï¼ˆåŒ…å«æ—¥æœŸå’Œæ—¶æ®µåˆ†æï¼‰
            const unifiedHtml = generatePeriodStats();
            
            const unifiedStats = document.getElementById('unifiedStats');
            if (unifiedStats) {
                unifiedStats.innerHTML = unifiedHtml;
            }
        }

        // å¯¼å‡ºéƒ¨åˆ†å‡½æ•°
        function exportAsPNG() {
            if (!appData.chart) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾è¡¨', 'error');
                return;
            }
            
            const quality = parseFloat(elements.pngQualitySelect.value);
            elements.loadCurveChart.toBlob(blob => {
                saveAs(blob, getExportFileName('å›¾è¡¨', 'png'));
                showNotification('æˆåŠŸ', 'å›¾è¡¨å·²å¯¼å‡ºä¸ºPNG', 'success');
            }, 'image/png', quality);
        }

        function exportAsJPG() {
            if (!appData.chart) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾è¡¨', 'error');
                return;
            }
            
            elements.loadCurveChart.toBlob(blob => {
                saveAs(blob, getExportFileName('å›¾è¡¨', 'jpg'));
                showNotification('æˆåŠŸ', 'å›¾è¡¨å·²å¯¼å‡ºä¸ºJPG', 'success');
            }, 'image/jpeg', 0.9);
        }

        function exportAsSVG() {
            if (!appData.chart) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾è¡¨', 'error');
                return;
            }
            
            // ç”ŸæˆSVG
            const svg = chartToSVG(appData.chart);
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            saveAs(blob, getExportFileName('å›¾è¡¨', 'svg'));
            showNotification('æˆåŠŸ', 'å›¾è¡¨å·²å¯¼å‡ºä¸ºSVG', 'success');
        }

        function exportHourlyData() {
            if (appData.processedData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }
            
            // è·å–æ—¥æœŸèŒƒå›´è®¾ç½®
            const exportAllDates = document.getElementById('exportAllDates').checked;
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            // ç­›é€‰è¦å¯¼å‡ºçš„æ•°æ®
            let exportData = appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date)
            );
            
            // å¦‚æœä¸æ˜¯å¯¼å‡ºæ‰€æœ‰æ—¥æœŸï¼Œåˆ™åº”ç”¨æ—¥æœŸèŒƒå›´ç­›é€‰
            if (!exportAllDates && startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                exportData = exportData.filter(d => {
                    const currentDate = new Date(d.date);
                    return currentDate >= start && currentDate <= end;
                });
            }
            
            if (exportData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }
            
            // å‡†å¤‡å¯¼å‡ºæ•°æ® - æ¯ä¸ªæ—¥æœŸ24å°æ—¶æ•°æ®æ‰“åŒ…åœ¨ä¸€ä¸ªè¡¨æ ¼
            const header = ['æ—¥æœŸ'];
            for (let hour = 0; hour < 24; hour++) {
                header.push(`${hour}:00`);
            }
            header.push('æ—¥æ€»ç”µèƒ½ (kWh)');
            
            const rows = [header];
            
            exportData.forEach(dateData => {
                const rowData = [dateData.date];
                let dailyTotal = 0;
                
                // æ·»åŠ 24å°æ—¶æ•°æ®
                for (let hour = 0; hour < 24; hour++) {
                    const value = dateData.hourlyData[hour] !== null 
                        ? dateData.hourlyData[hour] 
                        : 0;
                    
                    rowData.push(value);
                    dailyTotal += value;
                }
                
                // æ·»åŠ æ—¥æ€»ç”µèƒ½
                rowData.push(dailyTotal);
                
                rows.push(rowData);
            });
            
            // å¯¼å‡º
            exportDataToFile(rows, '24å°æ—¶ç”µèƒ½æ˜ç»†');
        }

        function exportDailyStats() {
            if (appData.processedData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }
            
            // ç­›é€‰è¦å¯¼å‡ºçš„æ•°æ®
            const exportData = appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date)
            );
            
            if (exportData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }
            
            // å‡†å¤‡å¯¼å‡ºæ•°æ®
            const header = ['æ—¥æœŸ', 'æ—¥æ€»ç”¨ç”µé‡ (kWh)', 'å¹³å‡å°æ—¶ç”¨ç”µé‡ (kWh)', 'å³°è°·å·®å€¼ (kWh)'];
            const rows = [header];
            
            exportData.forEach(dateData => {
                // è®¡ç®—ç»Ÿè®¡å€¼
                const validHours = dateData.hourlyData.filter(v => v !== null);
                const hourlyAverage = validHours.length > 0 ? validHours.reduce((a, b) => a + b, 0) / validHours.length : 0;
                const peak = validHours.length > 0 ? Math.max(...validHours) : 0;
                const valley = validHours.length > 0 ? Math.min(...validHours) : 0;
                const peakValleyDiff = peak - valley;
                
                rows.push([
                    dateData.date,
                    dateData.dailyTotal.toFixed(2),
                    hourlyAverage.toFixed(2),
                    peakValleyDiff.toFixed(2)
                ]);
            });
            
            // å¯¼å‡º
            exportDataToFile(rows, 'æ—¥ç»Ÿè®¡æ•°æ®');
        }

        function exportPVsystData() {
            if (appData.processedData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            // å§‹ç»ˆä½¿ç”¨æ‰€æœ‰å¤„ç†åçš„æ•°æ®
            let exportData = [...appData.processedData];
            console.log('=== PVSystæ•°æ®å¯¼å‡ºï¼ˆæŒ‰æœˆä»½é‡æ–°æ’åˆ—ï¼‰===');
            console.log('åŸå§‹æ•°æ®æ¡æ•°:', exportData.length);

            // æ£€æŸ¥æ‰€æœ‰æ—¥æœŸçš„æœ‰æ•ˆæ€§
            console.log('æ£€æŸ¥æ‰€æœ‰æ—¥æœŸçš„æœ‰æ•ˆæ€§...');
            let validDataCount = 0;
            
            exportData.forEach((row, index) => {
                let dateObj = null;
                
                // å°è¯•å¤šç§æ–¹å¼è·å–æœ‰æ•ˆæ—¥æœŸ
                if (row.dateObj && !isNaN(row.dateObj.getTime())) {
                    dateObj = row.dateObj;
                } else if (row.date) {
                    // å¢å¼ºçš„æ—¥æœŸè§£æ
                    dateObj = parseDate(row.date, appData.config.dateFormat);
                    if (!dateObj) {
                        // å°è¯•è‡ªåŠ¨æ£€æµ‹æ ¼å¼
                        dateObj = parseDate(row.date, 'auto');
                    }
                }
                
                if (!dateObj || isNaN(dateObj.getTime())) {
                    console.error(`æ— æ•ˆæ—¥æœŸåœ¨ç¬¬${index}è¡Œ: "${row.date}"`);
                    // æ ‡è®°ä¸ºæ— æ•ˆ
                    row._invalidDate = true;
                } else {
                    console.log(`æœ‰æ•ˆæ—¥æœŸåœ¨ç¬¬${index}è¡Œ: "${row.date}" -> ${dateObj.toISOString()}`);
                    // ç¡®ä¿dateObjå­˜åœ¨
                    row.dateObj = dateObj;
                    validDataCount++;
                }
            });
            
            console.log(`æœ‰æ•ˆæ•°æ®: ${validDataCount}/${exportData.length}`);

            if (exportData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }

            // åˆ›å»ºåŸºäºçœŸå®æ—¥æœŸçš„æ•°æ®æ˜ å°„
            const realDateDataMap = new Map();
            
            if (exportData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                return;
            }
            
            // è¿‡æ»¤æ‰æ— æ•ˆæ—¥æœŸçš„æ•°æ®
            const validExportData = exportData.filter(dateData => !dateData._invalidDate);

            if (validExportData.length === 0) {
                showNotification('é”™è¯¯', 'æ‰€æœ‰æ•°æ®çš„æ—¥æœŸæ ¼å¼éƒ½æ— æ•ˆï¼Œæ— æ³•å¯¼å‡º', 'error');
                return;
            }
            
            const sortedExportData = [...validExportData].sort((a, b) => {
                return a.dateObj - b.dateObj;
            });

            // æ„å»ºçœŸå®æ—¥æœŸçš„æ•°æ®æ˜ å°„
            sortedExportData.forEach(dateData => {
                // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼ï¼Œé¿å…UTCåç§»
                const dateKey = formatDateForInput(dateData.dateObj); // YYYY-MM-DDæ ¼å¼
                
                if (dateData.hourlyData && Array.isArray(dateData.hourlyData) && dateData.hourlyData.length === 24) {
                    realDateDataMap.set(dateKey, dateData.hourlyData);
                } else {
                    realDateDataMap.set(dateKey, Array(24).fill(0));
                }
            });

            // ç¡®å®šæ•°æ®çš„å®é™…å¹´ä»½èŒƒå›´
            const allRealDates = [...realDateDataMap.keys()].sort();
            let startRealDate, endRealDate;
            
            if (allRealDates.length > 0) {
                startRealDate = new Date(allRealDates[0]);
                endRealDate = new Date(allRealDates[allRealDates.length - 1]);
                console.log('å®é™…æ•°æ®æ—¥æœŸèŒƒå›´:', formatDateForInput(startRealDate), 'åˆ°', formatDateForInput(endRealDate));
            } else {
                console.log('è­¦å‘Šï¼šæ²¡æœ‰å¯ç”¨çš„å®é™…æ•°æ®');
                showNotification('è­¦å‘Š', 'æ²¡æœ‰å¯ç”¨çš„å®é™…æ•°æ®ï¼Œå°†ä½¿ç”¨é›¶å€¼å¡«å……', 'warning');
            }
            console.log('å®é™…æ•°æ®å¤©æ•°:', realDateDataMap.size);

            // åˆ›å»ºæœˆä»½é¡ºåºçš„æ—¥æœŸæ˜ å°„ï¼ˆ1æœˆ1æ—¥åˆ°12æœˆ31æ—¥ï¼‰
            const monthOrderDateMap = new Map();
            
            // å¦‚æœæ²¡æœ‰å®é™…æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é›¶å€¼æ•°æ®é›†
            if (realDateDataMap.size === 0) {
                console.log('åˆ›å»ºé»˜è®¤é›¶å€¼æ•°æ®é›†');
                for (let targetMonth = 1; targetMonth <= 12; targetMonth++) {
                    const daysInMonth = new Date(2000, targetMonth, 0).getDate();
                    for (let targetDay = 1; targetDay <= daysInMonth; targetDay++) {
                        const monthDayKey = `${String(targetMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;
                        monthOrderDateMap.set(monthDayKey, {
                            data: Array(24).fill(0),
                            source: 'é›¶å€¼å¡«å……'
                        });
                    }
                }
            } else {
                // æŒ‰æœˆä»½ä»1æœˆåˆ°12æœˆçš„é¡ºåºå¤„ç†
                for (let targetMonth = 1; targetMonth <= 12; targetMonth++) {
                    const daysInMonth = new Date(2000, targetMonth, 0).getDate();
                    
                    for (let targetDay = 1; targetDay <= daysInMonth; targetDay++) {
                        const monthDayKey = `${String(targetMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;
                        
                        // æŸ¥æ‰¾å¯¹åº”çš„çœŸå®æ•°æ®
                        let matchedData = null;
                        let dataSource = '';
                        
                        // ä¼˜å…ˆæŸ¥æ‰¾åŒæœˆåŒæ—¥çš„æ•°æ®
                        for (const [realDate, data] of realDateDataMap) {
                            const realDateObj = new Date(realDate);
                            if (isNaN(realDateObj.getTime())) continue;
                            
                            if (realDateObj.getMonth() + 1 === targetMonth && realDateObj.getDate() === targetDay) {
                                matchedData = [...data];
                                dataSource = `å®é™…æ•°æ®-${realDate}`;
                                break;
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„ï¼Œä½¿ç”¨æœ€æ¥è¿‘çš„æ•°æ®
                        if (!matchedData) {
                            // æŸ¥æ‰¾ç›¸é‚»å¹´ä»½çš„åŒæœˆåŒæ—¥æ•°æ®
                            const nearbyData = findNearestMonthDayData(targetMonth, targetDay, realDateDataMap);
                            if (nearbyData) {
                                matchedData = [...nearbyData.data];
                                dataSource = nearbyData.source;
                            } else {
                                // ä½¿ç”¨å‰ä¸€å¤©çš„æ•°æ®ï¼Œæˆ–æŸ¥æ‰¾ç›¸è¿‘æœˆä»½çš„æ•°æ®
                                const fallbackData = findFallbackData(targetMonth, targetDay, monthOrderDateMap, realDateDataMap);
                                matchedData = [...fallbackData.data];
                                dataSource = fallbackData.source;
                            }
                        }
                        
                        monthOrderDateMap.set(monthDayKey, {
                            data: matchedData,
                            source: dataSource
                        });
                    }
                }
            }

            // ç”ŸæˆCSVå†…å®¹
            let csvContent = '';
            csvContent += '# è‡ªå®šä¹‰è´Ÿè½½æ›²çº¿ - æŒ‰æœˆä»½é‡æ–°æ’åˆ—\n';
            csvContent += '# ç”Ÿæˆæ—¶é—´: ' + new Date().toISOString() + '\n';
            csvContent += '# æ•°æ®æ¥æº: è´Ÿè·æ•°æ®å¤„ç†å·¥å…·\n';
            csvContent += '# è¯´æ˜: æŒ‰æœˆä»½ä»ä½åˆ°é«˜æ’åˆ—ï¼Œå»é™¤å¹´ä»½å½±å“\n';
            csvContent += '# è§„åˆ™: æŒ‰æœˆä»½å’Œæ—¥åŒ¹é…ï¼Œç¼ºå¤±æ•°æ®ç”¨æœ€è¿‘æœ‰æ•ˆæ•°æ®è¡¥å…¨\n';
            csvContent += '# æ ¼å¼: DD/MM/YY hh:mmï¼Œå¹´ä»½å›ºå®šä¸º99\n';
            csvContent += '\n';
            csvContent += 'Date;P Load\n';
            csvContent += ';kW\n';

            // æŒ‰æœˆä»½é¡ºåºç”Ÿæˆ8760å°æ—¶æ•°æ®
            let dataUsageStats = {
                actual: 0,
                fallback: 0,
                details: []
            };

            for (let month = 1; month <= 12; month++) {
                const daysInMonth = new Date(2000, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const monthDayKey = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = monthOrderDateMap.get(monthDayKey);
                    
                    if (dayData.source.startsWith('å®é™…æ•°æ®')) {
                        dataUsageStats.actual++;
                    } else {
                        dataUsageStats.fallback++;
                    }
                    
                    dataUsageStats.details.push({
                        monthDay: monthDayKey,
                        source: dayData.source,
                        total: dayData.data.reduce((a, b) => a + b, 0)
                    });

                    // ä¸ºæ¯ä¸ªå°æ—¶ç”Ÿæˆæ•°æ®è¡Œ
                    for (let hour = 0; hour < 24; hour++) {
                        const value = dayData.data[hour] || 0;
                        const dayStr = String(day).padStart(2, '0');
                        const monthStr = String(month).padStart(2, '0');
                        const hourStr = String(hour).padStart(2, '0');
                        const dateTimeStr = `${dayStr}/${monthStr}/99 ${hourStr}:00`;
                        
                        csvContent += `${dateTimeStr};${value.toFixed(3)}\n`;
                    }
                }
            }

            // è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
            console.log('=== æ•°æ®é‡æ–°æ’åˆ—å®Œæˆ ===');
            console.log('å®é™…ä½¿ç”¨æ•°æ®å¤©æ•°:', dataUsageStats.actual);
            console.log('è¡¥å…¨æ•°æ®å¤©æ•°:', dataUsageStats.fallback);
            console.log('æ€»å¤©æ•°:', dataUsageStats.actual + dataUsageStats.fallback);
            console.log('æ•°æ®è¦†ç›–ç‡:', ((dataUsageStats.actual / (dataUsageStats.actual + dataUsageStats.fallback)) * 100).toFixed(1) + '%');

            // å¯¼å‡ºCSVæ–‡ä»¶
            const fileName = getExportFileName('PVsystæœˆåº¦é‡æ’8760å°æ—¶æ•°æ®', 'csv');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, fileName);

            showNotification('æˆåŠŸ', 'PVsystæœˆåº¦é‡æ’8760å°æ—¶æ•°æ®å·²å¯¼å‡º', 'success');
        }


        function exportDataToFile(data, baseName) {
            const format = elements.exportFormatSelect.value;
            const fileName = getExportFileName(baseName, format);
            
            // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, baseName);
            
            // å¯¼å‡ºæ–‡ä»¶
            if (format === 'csv') {
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, fileName);
            } else {
                // å¯¼å‡ºä¸ºExcel
                XLSX.writeFile(wb, fileName);
            }
            
            showNotification('æˆåŠŸ', `${baseName}å·²å¯¼å‡ºä¸º${format.toUpperCase()}`, 'success');
        }

        function getExportFileName(baseName, extension) {
            let fileName = `${elements.exportFileNameInput.value}_${baseName}`;
            
            // æ·»åŠ ç­›é€‰æ¡ä»¶
            if (elements.includeFiltersInNameCheckbox.checked) {
                const startDate = elements.startDateInput.value || 'å¼€å§‹æ—¥æœŸ';
                const endDate = elements.endDateInput.value || 'ç»“æŸæ—¥æœŸ';
                fileName += `_${startDate}_to_${endDate}`;
            }
            
            // æ·»åŠ æ—¶é—´æˆ³
            if (elements.includeTimestampCheckbox.checked) {
                const timestamp = new Date().toISOString().replace(/:/g, '-').slice(0, 19);
                fileName += `_${timestamp}`;
            }
            
            return `${fileName}.${extension}`;
        }

        function findNearbyData(month, day, dataMap) {
    // å¯»æ‰¾ç›¸è¿‘æœˆä»½çš„æ•°æ®
    const searchOrder = [
        [month, day],       // å½“å‰æœˆä»½
        [month-1, day],     // å‰ä¸€ä¸ªæœˆ
        [month+1, day],     // åä¸€ä¸ªæœˆ
        [month, day-1],     // å‰ä¸€å¤©
        [month, day+1],     // åä¸€å¤©
        [month-2, day],     // å‰ä¸¤ä¸ªæœˆ
        [month+2, day]      // åä¸¤ä¸ªæœˆ
    ];
    
    for (const [m, d] of searchOrder) {
        if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
            const key = `${m}-${d}`;
            if (dataMap.has(key)) {
                return key;
            }
        }
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°ç›¸è¿‘æ—¥æœŸï¼Œå°è¯•åŸºäºå­£èŠ‚æŸ¥æ‰¾æ•°æ®
    // æ ¹æ®æœˆä»½ç¡®å®šå­£èŠ‚
    let season;
    if (month >= 3 && month <= 5) {
        season = 'spring'; // æ˜¥å­£
    } else if (month >= 6 && month <= 8) {
        season = 'summer'; // å¤å­£
    } else if (month >= 9 && month <= 11) {
        season = 'autumn'; // ç§‹å­£
    } else {
        season = 'winter'; // å†¬å­£
    }
    
    // æ ¹æ®å­£èŠ‚æŸ¥æ‰¾å¯¹åº”æœˆä»½çš„æ•°æ®
    let seasonMonths = [];
    switch(season) {
        case 'spring':
            seasonMonths = [3, 4, 5];
            break;
        case 'summer':
            seasonMonths = [6, 7, 8];
            break;
        case 'autumn':
            seasonMonths = [9, 10, 11];
            break;
        case 'winter':
            seasonMonths = [12, 1, 2];
            break;
    }
    
    // åœ¨åŒå­£èŠ‚ä¸­æŸ¥æ‰¾æ•°æ®
    for (const m of seasonMonths) {
        // ä¼˜å…ˆæŸ¥æ‰¾æœˆä¸­æ•°æ®ï¼ˆ15å·å·¦å³ï¼‰
        for (const d of [15, 14, 16, 13, 17, 12, 18, 11, 19, 10, 20]) {
            if (d <= new Date(2000, m, 0).getDate()) { // ç¡®ä¿æ—¥æœŸæœ‰æ•ˆ
                const key = `${m}-${d}`;
                if (dataMap.has(key)) {
                    return key;
                }
            }
        }
    }
    
    // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼ŒæŸ¥æ‰¾ä»»ä½•å¯ç”¨çš„æ•°æ®
    const allKeys = [...dataMap.keys()];
    if (allKeys.length > 0) {
        // ä¼˜å…ˆé€‰æ‹©åŒå­£èŠ‚çš„æ•°æ®
        const seasonKeys = allKeys.filter(key => {
            const keyMonth = parseInt(key.split('-')[0]);
            return seasonMonths.includes(keyMonth);
        });
        
        if (seasonKeys.length > 0) {
            // éšæœºé€‰æ‹©ä¸€ä¸ªåŒå­£èŠ‚çš„æ•°æ®ï¼Œé¿å…æ€»æ˜¯ä½¿ç”¨åŒä¸€ä¸ª
            const randomIndex = Math.floor(Math.random() * seasonKeys.length);
            return seasonKeys[randomIndex];
        } else {
            // å¦‚æœæ²¡æœ‰åŒå­£èŠ‚çš„æ•°æ®ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨æ•°æ®
            const randomIndex = Math.floor(Math.random() * allKeys.length);
            return allKeys[randomIndex];
        }
    }
    
    return null;
}

        function findNearestMonthDayData(targetMonth, targetDay, realDateDataMap) {
            // æŸ¥æ‰¾æœ€æ¥è¿‘çš„æœˆæ—¥æ•°æ®
            if (!realDateDataMap || realDateDataMap.size === 0) {
                return null;
            }
            
            let bestMatch = null;
            let minDistance = Infinity;
            
            for (const [realDate, data] of realDateDataMap) {
                const realDateObj = new Date(realDate);
                if (isNaN(realDateObj.getTime())) {
                    console.warn('æ— æ•ˆçš„æ—¥æœŸåœ¨findNearestMonthDayDataä¸­:', realDate);
                    continue;
                }
                
                const realMonth = realDateObj.getMonth() + 1;
                const realDay = realDateObj.getDate();
                
                // è®¡ç®—æœˆæ—¥å·®å¼‚
                const monthDiff = Math.abs(realMonth - targetMonth);
                const dayDiff = Math.abs(realDay - targetDay);
                
                // è€ƒè™‘æœˆä»½å¾ªç¯ï¼ˆ12æœˆåˆ°1æœˆåªç®—1ä¸ªæœˆå·®å¼‚ï¼‰
                const adjustedMonthDiff = Math.min(monthDiff, 12 - monthDiff);
                
                // è®¡ç®—ç»¼åˆè·ç¦»
                const distance = adjustedMonthDiff * 31 + dayDiff;
                
                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatch = { data, source: `æœ€è¿‘åŒ¹é…-${realDate}` };
                }
            }
            
            return bestMatch;
        }

        function findFallbackData(targetMonth, targetDay, monthOrderDateMap, realDateDataMap) {
            // æŸ¥æ‰¾å›é€€æ•°æ®
            
            // 1. å°è¯•ä½¿ç”¨å‰ä¸€å¤©çš„æ•°æ®
            if (targetDay > 1) {
                const prevDayKey = `${String(targetMonth).padStart(2, '0')}-${String(targetDay - 1).padStart(2, '0')}`;
                const prevData = monthOrderDateMap.get(prevDayKey);
                if (prevData) {
                    return {
                        data: [...prevData.data],
                        source: `å‰ä¸€å¤©æ•°æ®-${prevDayKey}`
                    };
                }
            }
            
            // 2. å°è¯•ä½¿ç”¨åŒæœˆçš„å…¶ä»–æ—¥æ•°æ®
            if (realDateDataMap && realDateDataMap.size > 0) {
                const nearestMonthDay = findNearestMonthDayData(targetMonth, targetDay, realDateDataMap);
                if (nearestMonthDay) {
                    return nearestMonthDay;
                }
            }
            
            // 3. ä½¿ç”¨ä»»æ„å¯ç”¨æ•°æ®
            if (realDateDataMap && realDateDataMap.size > 0) {
                const anyData = [...realDateDataMap.values()][0];
                if (anyData) {
                    return {
                        data: [...anyData],
                        source: 'é»˜è®¤æ•°æ®'
                    };
                }
            }
            
            // 4. è¿”å›é›¶å€¼
            return {
                data: Array(24).fill(0),
                source: 'é›¶å€¼å¡«å……'
            };
        }

        function updateDataOverview() {
            const dataStatus = document.getElementById('dataStatus');
            const currentDataCount = document.getElementById('currentDataCount');
            const currentDateRange = document.getElementById('currentDateRange');
            const currentMeteringPointCount = document.getElementById('currentMeteringPointCount');
            
            if (appData.parsedData && appData.parsedData.length > 0) {
                if (dataStatus && dataStatus.parentNode) {
                    dataStatus.classList.remove('hidden');
                }
                
                // æ˜¾ç¤ºå½“å‰æ•°æ®é‡
                if (currentDataCount && currentDataCount.parentNode) {
                    currentDataCount.textContent = appData.parsedData.length.toLocaleString();
                }
                
                // è®¡ç®—æ—¥æœŸèŒƒå›´
                const dates = [...new Set(appData.parsedData.map(item => item.date))].sort();
                if (dates.length > 0) {
                    const startDate = dates[0];
                    const endDate = dates[dates.length - 1];
                    // ä½¿ç”¨formatDateRangeDisplayå‡½æ•°æ ¼å¼åŒ–æ—¥æœŸèŒƒå›´
                    const formattedStartDate = formatDateRangeDisplay(startDate);
                    const formattedEndDate = formatDateRangeDisplay(endDate);
                    if (currentDateRange && currentDateRange.parentNode) {
                        currentDateRange.textContent = `${formattedStartDate} ~ ${formattedEndDate}`;
                    }
                } else {
                    if (currentDateRange && currentDateRange.parentNode) {
                        currentDateRange.textContent = '-';
                    }
                }
                
                // è®¡ç®—è®¡é‡ç‚¹æ•°é‡
                const uniqueMeteringPoints = [...new Set(appData.parsedData.map(item => item.meteringPoint))];
                if (currentMeteringPointCount && currentMeteringPointCount.parentNode) {
                    currentMeteringPointCount.textContent = uniqueMeteringPoints.length;
                }
            } else {
                if (dataStatus && dataStatus.parentNode) {
                    dataStatus.classList.add('hidden');
                }
            }
        }
        
        function startOver() {
            // é‡ç½®åº”ç”¨æ•°æ®
            appData.files = [];
            appData.worksheets = [];
            appData.parsedData = [];
            appData.processedData = [];
            appData.config = {
                dataType: 'instantPower',
                multiplier: 1.0,
                useMultiplierColumn: false,
                multiplierColumn: '',
                dateColumn: '',

                dataStartColumn: '',
                dataEndColumn: '',
                dataStartIndex: 0,
                dataEndIndex: -1,
                meteringPointColumn: '',
                meteringPointFilter: '',
                dateFormat: 'YYYY-MM-DD',
                invalidDataHandling: 'ignore',
                timeInterval: 15,
                filterCount: 1,
                additionalFilters: []
            };
            appData.visualization = {
                selectedDates: [],
                selectedMeteringPoints: [],
                focusStartTime: 0,
                focusEndTime: 23,
                lineStyle: 'solid',
                showPoints: false,
                smoothCurve: true,
                curveTension: 0.4,
                secondaryAxis: false,
                showDailyTotalBarChart: true,
                // æ–°å¢ï¼šæ±‡æ€»æ¨¡å¼ï¼ˆæœ€é«˜/æœ€ä½ + å­£åº¦å¹³å‡ï¼‰
                summaryMode: false
            };
            appData.meteringPoints = [];
            
            // é‡ç½®UI
            elements.fileInput.value = '';
            elements.importedFiles.innerHTML = '';
            // æ–‡ä»¶åˆ—è¡¨ç°åœ¨å›ºå®šå±•å¼€ï¼Œæ— éœ€éšè—
            if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                elements.removeAllFiles.classList.add('hidden');
            }

            
            // é‡ç½®é…ç½®è¡¨å•
            elements.dataTypeRadios[0].checked = true;
            elements.multiplierInput.value = '1.0';
            elements.useMultiplierColumnCheckbox.checked = false;
            if (elements.multiplierOptions && elements.multiplierOptions.parentNode) {
                elements.multiplierOptions.classList.remove('hidden');
            }
            if (elements.multiplierColumnOption && elements.multiplierColumnOption.parentNode) {
                elements.multiplierColumnOption.classList.add('hidden');
            }
            elements.dateColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            elements.meteringPointFilterSelect.innerHTML = '<option value="">-- å…¨éƒ¨è®¡é‡ç‚¹ --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

            elements.invalidDataHandlingSelect.value = 'ignore';
            elements.timeIntervalSelect.value = '15';
            elements.dataPreview.innerHTML = 'è¯·å…ˆå®Œæˆæ•°æ®é…ç½®ï¼Œå°†æ˜¾ç¤ºæ•°æ®é¢„è§ˆ';
            
            // é‡ç½®ç­›é€‰é¡¹è®¾ç½®
            elements.filterCountInput.value = '1';
            elements.filterOptionsContainer.innerHTML = '';
            
            // é‡ç½®å¯è§†åŒ–è¡¨å•
            elements.startDateInput.innerHTML = '<option value="">-- è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸ --</option>';
            elements.endDateInput.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ --</option>';
            elements.focusStartTimeSelect.value = '0';
            elements.focusEndTimeSelect.value = '23';
            elements.lineStyleSelect.value = 'solid';
            elements.showPointsSelect.value = 'false';
            elements.smoothCurveSelect.value = 'true';
            elements.curveTensionSelect.value = '0.4';
            elements.secondaryAxisCheckbox.checked = false;
            elements.visualizationMeteringPointFilterSelect.innerHTML = '<option value="">-- å…¨éƒ¨è®¡é‡ç‚¹ --</option>';
            elements.dailyStats.innerHTML = '<p class="text-neutral">è¯·å…ˆç”Ÿæˆå›¾è¡¨ä»¥æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</p>';
            elements.periodStats.innerHTML = '<p class="text-neutral">è¯·å…ˆç”Ÿæˆå›¾è¡¨ä»¥æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</p>';
            
            // é‡ç½®æ—¥æœŸé€‰æ‹©
            appData.visualization.selectedDates = [];
            if (appData.chart) {
                appData.chart.destroy();
                appData.chart = null;
            }
            
            // è¿”å›åˆ°å¯¼å…¥éƒ¨åˆ†
            goToImportSection();
            
            showNotification('ä¿¡æ¯', 'å·²é‡ç½®æ‰€æœ‰æ•°æ®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹', 'info');
        }

        // å¯¼èˆªå‡½æ•°
        function goToImportSection() {
            if (elements.importSection && elements.importSection.parentNode) {
                elements.importSection.classList.remove('hidden');
            }
            if (elements.configSection && elements.configSection.parentNode) {
                elements.configSection.classList.add('hidden');
            }
            if (elements.visualizationSection && elements.visualizationSection.parentNode) {
                elements.visualizationSection.classList.add('hidden');
            }
            if (elements.exportSection && elements.exportSection.parentNode) {
                elements.exportSection.classList.add('hidden');
            }
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨ï¼ˆæ·»åŠ å®‰å…¨æ£€æŸ¥ï¼‰
            if (elements.step2Indicator) {
                elements.step2Indicator.className = 'w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:bg-gray-400';
            }
            if (elements.step2Line) {
                elements.step2Line.className = 'w-8 h-0.5 bg-gray-300 rounded-full';
            }
            if (elements.step3Indicator) {
                elements.step3Indicator.className = 'w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:bg-gray-400';
            }
            if (elements.step3Line) {
                elements.step3Line.className = 'w-8 h-0.5 bg-gray-300 rounded-full';
            }
            if (elements.step4Indicator) {
                elements.step4Indicator.className = 'w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:bg-gray-400';
            }
        }

        function goToConfigSection() {
            if (elements.importSection && elements.importSection.parentNode) {
                elements.importSection.classList.add('hidden');
            }
            if (elements.configSection && elements.configSection.parentNode) {
                elements.configSection.classList.remove('hidden');
            }
            if (elements.visualizationSection && elements.visualizationSection.parentNode) {
                elements.visualizationSection.classList.add('hidden');
            }
            if (elements.exportSection && elements.exportSection.parentNode) {
                elements.exportSection.classList.add('hidden');
            }
            
            // æ›´æ–°æ­¥éª¤å¯¼èˆªçŠ¶æ€
            updateStepNavigation('configSection');
            
            // æ ‡è®°ç¬¬ä¸€æ­¥ä¸ºå·²å®Œæˆ
            completeStep(1);
            
            // è‡ªåŠ¨è§¦å‘æ•°æ®è§£æå’Œé¢„è§ˆæ›´æ–°
            console.log('è¿›å…¥é…ç½®æ­¥éª¤ï¼Œè‡ªåŠ¨è§¦å‘æ•°æ®è§£æ...');
            setTimeout(() => {
                if (appData.worksheets && appData.worksheets.length > 0) {
                    try {
                        // è§£æå·¥ä½œè¡¨æ•°æ®
                        parseWorksheetData();
                        
                        // å¤„ç†è§£æåçš„æ•°æ®
                        processParsedData();
                        
                        // æ›´æ–°è®¡é‡ç‚¹ç­›é€‰é€‰é¡¹
                        updateMeteringPointFilterOptions();
                        
                        // æ›´æ–°æ•°æ®é¢„è§ˆ
                        updateDataPreview();
                        
                        console.log('æ•°æ®è§£æå’Œé¢„è§ˆæ›´æ–°å®Œæˆï¼Œå…±å¤„ç†æ•°æ®ç‚¹:', appData.processedData.length);
                        
                        // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                        if (appData.processedData.length > 0) {
                            showNotification('æˆåŠŸ', `æ•°æ®è§£æå®Œæˆï¼Œå…±å¤„ç† ${appData.processedData.length} æ¡è®°å½•`, 'success');
                        } else {
                            showNotification('ä¿¡æ¯', 'æ•°æ®è§£æå®Œæˆï¼Œä½†æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®', 'warning');
                        }
                        
                    } catch (error) {
                        console.error('æ•°æ®è§£æå‡ºé”™:', error);
                        showNotification('é”™è¯¯', 'æ•°æ®è§£æå¤±è´¥: ' + error.message, 'error');
                    }
                } else {
                    console.log('æ²¡æœ‰å·¥ä½œè¡¨æ•°æ®å¯ä¾›è§£æ');
                }
            }, 100);
        }

        function goToVisualizationSection() {
    console.log('è¿›å…¥å¯è§†åŒ–æ­¥éª¤ï¼Œä½¿ç”¨æœ€æ–°é…ç½®é‡æ–°å¤„ç†æ•°æ®...');
    
    // ä½¿ç”¨æœ€æ–°é…ç½®é‡æ–°å¤„ç†æ•°æ®ï¼Œç¡®ä¿ç¬¬ä¸‰æ­¥å¯è§†åŒ–ä½¿ç”¨ç¬¬äºŒæ­¥çš„æœ€æ–°é…ç½®
    reprocessDataWithConfig();
    
    // æ›´æ–°è®¡é‡ç‚¹ç¼–å·ç­›é€‰é€‰é¡¹ï¼ˆreprocessDataWithConfigå·²è°ƒç”¨ï¼Œä½†å†è°ƒç”¨ä¸€æ¬¡ç¡®ä¿æœ€æ–°ï¼‰
    updateMeteringPointFilterOptions();
    
    // æ›´æ–°æ­¥éª¤å¯¼èˆªçŠ¶æ€
    updateStepNavigation('visualizationSection');
    
    // æ ‡è®°ç¬¬äºŒæ­¥ä¸ºå·²å®Œæˆ
    completeStep(2);
    
    // åˆ‡æ¢æ˜¾ç¤ºéƒ¨åˆ†
    if (elements.configSection && elements.configSection.parentNode) {
        elements.configSection.classList.add('hidden');
    }
    if (elements.visualizationSection && elements.visualizationSection.parentNode) {
        elements.visualizationSection.classList.remove('hidden');
    }
    if (elements.exportSection && elements.exportSection.parentNode) {
        elements.exportSection.classList.add('hidden');
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å›¾è¡¨å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆé”€æ¯
    if (appData.chart) {
        appData.chart.destroy();
        appData.chart = null;
    }
    
    // åˆå§‹åŒ–å¯è§†åŒ–
            initializeVisualization();
            
            // åˆå§‹åŒ–æ—¥æœŸæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾
            initDailyTotalBarChart();
            
            // ç¡®ä¿å›¾è¡¨æ˜¾ç¤ºæ•°æ®ï¼ˆreprocessDataWithConfigå·²åŒ…å«æ­¤é€»è¾‘ï¼Œä½†å†è°ƒç”¨ä¸€æ¬¡ç¡®ä¿ï¼‰
            setTimeout(() => {
                updateChart();
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯æ£€æŸ¥æ•°æ®çŠ¶æ€
                console.log('=== é¡µé¢åˆå§‹åŒ–å®Œæˆåçš„æ•°æ®çŠ¶æ€ ===');
                console.log('processedDataé•¿åº¦:', appData.processedData.length);
                console.log('æŸ±çŠ¶å›¾å®ä¾‹å­˜åœ¨:', !!appData.dailyTotalBarChart);
                
                if (appData.processedData.length > 0) {
                    console.log('ç¬¬ä¸€æ¡æ•°æ®:', appData.processedData[0]);
                    console.log('ç¬¬ä¸€æ¡æ•°æ®dailyTotal:', appData.processedData[0].dailyTotal);
                    console.log('ç¬¬ä¸€æ¡æ•°æ®ç±»å‹:', typeof appData.processedData[0].dailyTotal);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼å¹¶å‡†å¤‡æŸ±çŠ¶å›¾æ•°æ®
                    const chartData = appData.processedData.map(item => ({
                        date: String(item.date || '').replace(/-/g, ''),
                        dailyTotal: Number(item.dailyTotal) || 0,
                        hourlyData: item.hourlyData || []
                    })).filter(item => item.dailyTotal > 0);
                    
                    console.log('æ ¼å¼åŒ–åçš„å›¾è¡¨æ•°æ®:', chartData);
                    
                    if (chartData.length > 0 && appData.dailyTotalBarChart) {
                        console.log('ä½¿ç”¨å®é™…æ•°æ®æ›´æ–°æŸ±çŠ¶å›¾...');
                        updateDailyTotalBarChart(chartData);
                    } else {
                        console.log('æ•°æ®æ ¼å¼æœ‰é—®é¢˜æˆ–æŸ±çŠ¶å›¾æœªåˆå§‹åŒ–');
                    }
                } else {
                    console.log('æ²¡æœ‰æ•°æ®ï¼Œåˆ›å»ºæµ‹è¯•æ•°æ®æ¥éªŒè¯æŸ±çŠ¶å›¾åŠŸèƒ½...');
                    // åˆ›å»ºæµ‹è¯•æ•°æ®
                    const testData = [
                        { date: '2024-09-01', dailyTotal: 2354.28, hourlyData: Array(24).fill(0).map((_, i) => 98) },
                        { date: '2024-09-02', dailyTotal: 2213.70, hourlyData: Array(24).fill(0).map((_, i) => 92) },
                        { date: '2024-09-03', dailyTotal: 2079.54, hourlyData: Array(24).fill(0).map((_, i) => 87) },
                        { date: '2024-09-04', dailyTotal: 2171.19, hourlyData: Array(24).fill(0).map((_, i) => 90) },
                        { date: '2024-09-05', dailyTotal: 2188.41, hourlyData: Array(24).fill(0).map((_, i) => 91) }
                    ];
                    console.log('æµ‹è¯•æ•°æ®:', testData);
                    
                    // æµ‹è¯•æŸ±çŠ¶å›¾æ›´æ–°
                    if (appData.dailyTotalBarChart) {
                        console.log('ä½¿ç”¨æµ‹è¯•æ•°æ®æ›´æ–°æŸ±çŠ¶å›¾...');
                        updateDailyTotalBarChart(testData);
                    }
                }
                console.log('===============================');
            }, 500);
            
}

        function goToExportSection() {
            if (elements.importSection && elements.importSection.parentNode) {
                elements.importSection.classList.add('hidden');
            }
            if (elements.configSection && elements.configSection.parentNode) {
                elements.configSection.classList.add('hidden');
            }
            if (elements.visualizationSection && elements.visualizationSection.parentNode) {
                elements.visualizationSection.classList.add('hidden');
            }
            if (elements.exportSection && elements.exportSection.parentNode) {
                elements.exportSection.classList.remove('hidden');
            }
            
            // æ›´æ–°æ­¥éª¤å¯¼èˆªçŠ¶æ€
            updateStepNavigation('exportSection');
            
            // æ ‡è®°ç¬¬ä¸‰æ­¥ä¸ºå·²å®Œæˆ
            completeStep(3);
        }

        // é€šçŸ¥å’Œæ¨¡æ€æ¡†å‡½æ•°
        function showNotification(title, message, type = 'info') {
            const iconMap = {
                success: 'fa-check-circle text-success',
                error: 'fa-times-circle text-danger',
                warning: 'fa-exclamation-triangle text-warning',
                info: 'fa-info-circle text-primary'
            };
            
            // é˜²å¾¡æ€§æ£€æŸ¥æ‰€æœ‰é€šçŸ¥ç›¸å…³å…ƒç´ 
            if (!elements.notification || !elements.notificationTitle || !elements.notificationMessage || !elements.notificationIcon) {
                console.warn('é€šçŸ¥å…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•æ˜¾ç¤ºé€šçŸ¥:', title, message);
                return;
            }
            
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notificationIcon.className = `fa ${iconMap[type] || iconMap.info}`;
            
            if (elements.notification && elements.notification.parentNode) {
                elements.notification.classList.remove('hidden', 'bg-success/10', 'bg-danger/10', 'bg-warning/10', 'bg-primary/10');
                elements.notification.classList.add(`bg-${type === 'info' ? 'primary' : type}/10`);
            }
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                if (elements.notification && elements.notification.parentNode) {
                    elements.notification.classList.remove('translate-y-20', 'opacity-0');
                }
            }, 10);
            
            // è‡ªåŠ¨éšè—
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            if (!elements.notification || !elements.notification.parentNode) {
                return;
            }
            
            elements.notification.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => {
                if (elements.notification && elements.notification.parentNode) {
                    elements.notification.classList.add('hidden');
                }
            }, 300);
        }
        
        // å¢å¼ºçš„æ—¶é—´é—´éš”æ£€æµ‹ç»“æœé€šçŸ¥æ˜¾ç¤º
        function showEnhancedIntervalNotification(detectionResult) {
            const confidence = Math.round(detectionResult.confidence * 100);
            let title, message, type;
            
            // æ ¹æ®ç½®ä¿¡åº¦å’Œæ£€æµ‹æ–¹æ³•ç¡®å®šé€šçŸ¥ç±»å‹å’Œå†…å®¹
            if (detectionResult.confidence >= 0.9) {
                title = 'ğŸ¯ é«˜ç²¾åº¦æ£€æµ‹';
                type = 'success';
                message = `${detectionResult.message}\næ£€æµ‹æ–¹æ³•ï¼š${detectionResult.method}\nç½®ä¿¡åº¦ï¼š${confidence}%ï¼ˆéå¸¸å¯é ï¼‰`;
            } else if (detectionResult.confidence >= 0.8) {
                title = 'âœ… æ£€æµ‹æˆåŠŸ';
                type = 'success';
                message = `${detectionResult.message}\næ£€æµ‹æ–¹æ³•ï¼š${detectionResult.method}\nç½®ä¿¡åº¦ï¼š${confidence}%ï¼ˆå¯é ï¼‰`;
            } else if (detectionResult.confidence >= 0.6) {
                title = 'âš ï¸ æ£€æµ‹ç»“æœ';
                type = 'warning';
                message = `${detectionResult.message}\næ£€æµ‹æ–¹æ³•ï¼š${detectionResult.method}\nç½®ä¿¡åº¦ï¼š${confidence}%ï¼ˆå»ºè®®æ‰‹åŠ¨ç¡®è®¤ï¼‰`;
            } else if (detectionResult.confidence >= 0.4) {
                title = 'â“ ä½ç½®ä¿¡åº¦æ£€æµ‹';
                type = 'warning';
                message = `${detectionResult.message}\næ£€æµ‹æ–¹æ³•ï¼š${detectionResult.method}\nç½®ä¿¡åº¦ï¼š${confidence}%ï¼ˆå»ºè®®æ‰‹åŠ¨è®¾ç½®ï¼‰`;
            } else {
                title = 'ğŸ”§ ä½¿ç”¨é»˜è®¤å€¼';
                type = 'info';
                message = `${detectionResult.message}\næ£€æµ‹æ–¹æ³•ï¼š${detectionResult.method}\nç½®ä¿¡åº¦ï¼š${confidence}%ï¼ˆè¯·æ‰‹åŠ¨è®¾ç½®æ­£ç¡®çš„æ—¶é—´é—´éš”ï¼‰`;
            }
            
            // æ·»åŠ è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if (detectionResult.details) {
                message += `\nè¯¦ç»†ä¿¡æ¯ï¼š${detectionResult.details}`;
            }
            
            showNotification(title, message, type);
        }

        function showModal(title, content) {
            if (elements.modalTitle) {
                elements.modalTitle.textContent = title;
            }
            if (elements.modalContent) {
                elements.modalContent.innerHTML = content;
            }
            
            if (elements.modalOverlay && elements.modalOverlay.parentNode) {
                elements.modalOverlay.classList.remove('hidden');
            }
            setTimeout(() => {
                if (elements.modal && elements.modal.parentNode) {
                    elements.modal.classList.remove('scale-95', 'opacity-0');
                    elements.modal.classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        function closeModal() {
            if (elements.modal && elements.modal.parentNode) {
                elements.modal.classList.remove('scale-100', 'opacity-100');
                elements.modal.classList.add('scale-95', 'opacity-0');
            }
            setTimeout(() => {
                if (elements.modalOverlay && elements.modalOverlay.parentNode) {
                    elements.modalOverlay.classList.add('hidden');
                }
            }, 300);
        }

        function showHelpModal() {
            const helpContent = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-primary mb-2">å¦‚ä½•ä½¿ç”¨æœ¬å·¥å…·ï¼Ÿ</h4>
                        <p class="text-sm">æœ¬å·¥å…·åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼šå¯¼å…¥æ•°æ® â†’ æ•°æ®é…ç½® â†’ å¯è§†åŒ– â†’ å¯¼å‡ºç»“æœã€‚è¯·æŒ‰ç…§æ­¥éª¤å®Œæˆæ“ä½œã€‚</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">æ”¯æŒçš„æ•°æ®æ ¼å¼</h4>
                        <p class="text-sm">æ”¯æŒExcel (.xlsx, .xls) å’ŒCSV (.csv) æ ¼å¼çš„ç”¨ç”µæ•°æ®è¡¨æ ¼ã€‚</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">æ•°æ®ç±»å‹è¯´æ˜</h4>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            <li><strong>15åˆ†é’Ÿç¬æ—¶åŠŸç‡</strong>ï¼šæ¯15åˆ†é’Ÿä¸€ä¸ªåŠŸç‡å€¼(kW)ï¼Œå·¥å…·ä¼šè®¡ç®—æ¯å°æ—¶çš„ç”µèƒ½</li>
                            <li><strong>15åˆ†é’Ÿç´¯ç§¯ç”µèƒ½</strong>ï¼šæ¯15åˆ†é’Ÿä¸€ä¸ªç´¯ç§¯ç”µèƒ½å€¼(kWh)ï¼Œå·¥å…·ä¼šè®¡ç®—æ¯å°æ—¶çš„ç”µèƒ½å·®å€¼</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">å¸¸è§é—®é¢˜</h4>
                        <div class="space-y-2 text-sm">
                            <p><strong>Q: ä¸ºä»€ä¹ˆå¯¼å…¥æ–‡ä»¶åæ²¡æœ‰æ•°æ®ï¼Ÿ</strong></p>
                            <p>A: è¯·æ£€æŸ¥æ•°æ®é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯æ—¥æœŸåˆ—å’Œæ•°æ®åˆ—çš„é€‰æ‹©æ˜¯å¦å‡†ç¡®ã€‚</p>
                            
                            <p><strong>Q: å¦‚ä½•å¤„ç†æ— æ•ˆæ•°æ®ï¼Ÿ</strong></p>
                            <p>A: å·¥å…·æä¾›ä¸¤ç§å¤„ç†æ–¹å¼ï¼šå¿½ç•¥æ— æ•ˆæ•°æ®æˆ–ç”¨ç›¸é‚»æœ‰æ•ˆæ•°æ®å¡«å……ã€‚</p>
                            
                            <p><strong>Q: å¯ä»¥åŒæ—¶å¯¼å…¥å¤šä¸ªæ–‡ä»¶å—ï¼Ÿ</strong></p>
                            <p>A: å¯ä»¥ï¼Œå·¥å…·æ”¯æŒå¤šæ–‡ä»¶å¯¼å…¥å¹¶åˆå¹¶å¤„ç†æ•°æ®ã€‚</p>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('ä½¿ç”¨å¸®åŠ©', helpContent);
        }

        function showAboutModal() {
            const aboutContent = `
                <div class="space-y-4">
                    <div class="text-center">
                        <i class="fa fa-line-chart text-4xl text-primary mb-2"></i>
                        <h4 class="text-xl font-bold text-primary">24å°æ—¶è´Ÿè·æ›²çº¿ç”Ÿæˆå·¥å…·</h4>
                        <p class="text-neutral">ç‰ˆæœ¬ 1.0.0</p>
                    </div>
                    
                    <div>
                        <p class="text-sm">æœ¬å·¥å…·ç”¨äºå¤„ç†ç”¨ç”µæ•°æ®è¡¨æ ¼ï¼Œç”Ÿæˆ24å°æ—¶è´Ÿè·æ›²çº¿å›¾è¡¨ï¼Œæ”¯æŒæŒ‰æ—¥æœŸåŒºåˆ†æ›²çº¿ç±»åˆ«ï¼Œé€‚é…ä¸åŒæ ¼å¼çš„åŸå§‹æ•°æ®ã€‚</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">ä¸»è¦åŠŸèƒ½</h4>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            <li>æ”¯æŒå¤šæ–‡ä»¶å¯¼å…¥å¤„ç†æ±‡æ€»</li>
                            <li>å¤„ç†15åˆ†é’Ÿç¬æ—¶åŠŸç‡å’Œç´¯ç§¯ç”µèƒ½æ•°æ®</li>
                            <li>æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰æ˜¾ç¤ºæ›²çº¿</li>
                            <li>è‡ªå®šä¹‰æ˜¾ç¤ºæ—¶æ®µï¼Œèšç„¦ç”¨ç”µé«˜å³°</li>
                            <li>è®¡ç®—å¹¶å±•ç¤ºæ—¥æ€»ç”¨ç”µé‡ç­‰ç»Ÿè®¡ä¿¡æ¯</li>
                            <li>å¯¼å‡ºå›¾è¡¨ä¸ºPNG/JPG/SVGï¼Œå¯¼å‡ºæ•°æ®ä¸ºExcel/CSV</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showModal('å…³äºå·¥å…·', aboutContent);
        }

        // å·¥å…·å‡½æ•°
        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return null;
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ— æ•ˆæ•°æ®æ ‡è®°
            const strValue = String(value).trim().toLowerCase();
            if (strValue === 'æœªé‡‡é›†' || strValue === 'æ•…éšœ' || strValue === 'æ— æ•°æ®' || strValue === 'n/a' || strValue === 'null') {
                return null;
            }
            
            // å¤„ç†åƒåˆ†ä½åˆ†éš”ç¬¦ï¼ˆå¦‚1,234.56æˆ–1.234,56ï¼‰
            let processedStr = strValue;
            
            // æ£€æµ‹å¹¶å¤„ç†åƒåˆ†ä½åˆ†éš”ç¬¦
            // æƒ…å†µ1ï¼š1,234.56ï¼ˆé€—å·ä¸ºåƒåˆ†ä½ï¼Œç‚¹å·ä¸ºå°æ•°ç‚¹ï¼‰
            if (processedStr.includes(',') && processedStr.includes('.')) {
                // å¦‚æœé€—å·åœ¨ç‚¹å·å‰é¢ï¼Œä¸”é€—å·åä¸æ˜¯3ä½æ•°å­—ï¼Œåˆ™å¯èƒ½æ˜¯æ¬§æ´²æ ¼å¼ï¼ˆ1.234,56ï¼‰
                const commaPos = processedStr.indexOf(',');
                const dotPos = processedStr.indexOf('.');
                
                if (commaPos < dotPos && (dotPos - commaPos) !== 4) {
                    // å¯èƒ½æ˜¯æ¬§æ´²æ ¼å¼ï¼Œå°†ç‚¹å·æ›¿æ¢ä¸ºç©ºï¼Œé€—å·æ›¿æ¢ä¸ºç‚¹å·
                    processedStr = processedStr.replace(/\./g, '').replace(',', '.');
                } else {
                    // æ ‡å‡†æ ¼å¼ï¼Œç§»é™¤é€—å·
                    processedStr = processedStr.replace(/,/g, '');
                }
            } 
            // æƒ…å†µ2ï¼š1.234,56ï¼ˆç‚¹å·ä¸ºåƒåˆ†ä½ï¼Œé€—å·ä¸ºå°æ•°ç‚¹ï¼‰
            else if (processedStr.includes(',') && processedStr.lastIndexOf(',') > processedStr.length - 4) {
                // é€—å·åœ¨æœ€å3ä½ä¹‹å‰ï¼Œå¯èƒ½æ˜¯æ¬§æ´²æ ¼å¼çš„å°æ•°ç‚¹
                processedStr = processedStr.replace(/\./g, '').replace(',', '.');
            }
            // æƒ…å†µ3ï¼šåªæœ‰é€—å·ï¼Œå¯èƒ½æ˜¯åƒåˆ†ä½æˆ–å°æ•°ç‚¹
            else if (processedStr.includes(',')) {
                const commaPos = processedStr.indexOf(',');
                const afterComma = processedStr.substring(commaPos + 1);
                
                if (afterComma.length === 3 && commaPos > 0) {
                    // å¯èƒ½æ˜¯åƒåˆ†ä½åˆ†éš”ç¬¦
                    processedStr = processedStr.replace(/,/g, '');
                } else {
                    // å¯èƒ½æ˜¯å°æ•°ç‚¹
                    processedStr = processedStr.replace(',', '.');
                }
            }
            
            // å¤„ç†ç™¾åˆ†æ¯”ï¼ˆå¦‚12.34%æˆ–12,34%ï¼‰
            if (processedStr.includes('%')) {
                processedStr = processedStr.replace('%', '');
                const num = parseFloat(processedStr);
                return isNaN(num) ? null : num / 100;
            }
            
            // å¤„ç†ç§‘å­¦è®¡æ•°æ³•ï¼ˆå¦‚1.23e+4æˆ–1.23E-4ï¼‰
            if (/[eE][+-]?\d+$/.test(processedStr)) {
                const num = parseFloat(processedStr);
                return isNaN(num) ? null : num;
            }
            
            // å¤„ç†è´§å¸ç¬¦å·ï¼ˆå¦‚$123.45æˆ–Â¥123.45ï¼‰
            processedStr = processedStr.replace(/[$ï¿¥â‚¬Â£Â¥]/g, '');
            
            // å¤„ç†å•ä½ï¼ˆå¦‚123.45kWæˆ–123.45kWhï¼‰
            const unitMatch = processedStr.match(/^([\d.]+)([a-zA-Z]+)$/);
            if (unitMatch) {
                const numStr = unitMatch[1];
                const unit = unitMatch[2].toLowerCase();
                
                const num = parseFloat(numStr);
                if (isNaN(num)) return null;
                
                // å¤„ç†å¸¸è§å•ä½
                switch (unit) {
                    case 'k':
                        return num * 1000;
                    case 'm':
                        return num * 1000000;
                    case 'g':
                        return num * 1000000000;
                    case 't':
                        return num * 1000;
                    default:
                        // å…¶ä»–å•ä½ä¸è½¬æ¢ï¼Œåªè¿”å›æ•°å­—éƒ¨åˆ†
                        return num;
                }
            }
            
            // å°è¯•è§£æä¸ºæ•°å­—
            const num = parseFloat(processedStr);
            return isNaN(num) ? null : num;
        }

        function isDateLike(value) {
            if (!value) return false;
            
            const strValue = String(value).trim();
            if (!strValue) return false;
            
            // æ‰©å±•çš„æ—¥æœŸæ ¼å¼æ£€æµ‹æ¨¡å¼
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/, // YYYY-MM-DD æˆ– YYYY-M-D
                /^\d{4}\/\d{1,2}\/\d{1,2}$/, // YYYY/MM/DD æˆ– YYYY/M/D
                /^\d{1,2}\/\d{1,2}\/\d{4}$/, // MM/DD/YYYY æˆ– DD/MM/YYYY
                /^\d{1,2}\/\d{1,2}\/\d{2}$/, // MM/DD/YY æˆ– M/D/YY
                /^\d{1,2}-\d{1,2}-\d{4}$/, // DD-MM-YYYY æˆ– D-M-YYYY
                /^\d{1,2}-\d{1,2}-\d{2}$/, // DD-MM-YY æˆ– D-M-YY
                /^\d{8}$/, // YYYYMMDD
                /^\d{2}\d{2}\d{4}$/, // DDMMYYYY
                /^\d{4}\.\d{1,2}\.\d{1,2}$/, // YYYY.MM.DD
                /^\d{1,2}\.\d{1,2}\.\d{4}$/, // DD.MM.YYYY
                /^\d{1,2}\.\d{1,2}\.\d{2}$/, // DD.MM.YY
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/, // MM/DD/YYYY HH:MM
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}/, // YYYY-MM-DD HH:MM
                /^\d{1,2}\/\d{1,2}\/\d{2}\s+\d{1,2}:\d{2}/, // MM/DD/YY HH:MM
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}:\d{2}/, // YYYY-MM-DD HH:MM:SS
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}/, // MM/DD/YYYY HH:MM:SS
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}:\d{2}\.\d{3}/, // YYYY-MM-DD HH:MM:SS.mmm
                /^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{2}:\d{2}/, // ISOæ ¼å¼ YYYY-MM-DDTHH:MM:SS
                /^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{2}:\d{2}\.\d{3}/, // ISOæ ¼å¼ YYYY-MM-DDTHH:MM:SS.mmm
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}\s+[AP]M/, // MM/DD/YYYY HH:MM AM/PM
                /^\d{1,2}-\d{1,2}-\d{4}\s+\d{1,2}:\d{2}\s+[AP]M/ // DD-MM-YYYY HH:MM AM/PM
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•æ—¥æœŸæ ¼å¼
            for (let pattern of datePatterns) {
                if (pattern.test(strValue)) {
                    return true;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºExcelæ—¥æœŸåºåˆ—å·ï¼ˆçº¯æ•°å­—ï¼‰
            if (/^\d+$/.test(strValue) && parseInt(strValue) > 0) {
                return true;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸå¯¹è±¡å¯è§£æçš„æ ¼å¼
            const testDate = new Date(strValue);
            if (!isNaN(testDate.getTime()) && strValue.length > 5) {
                return true;
            }
            
            return false;
        }

        function parseDate(dateStr, format) {
            try {
                let year, month, day, hour = 0, minute = 0, second = 0;
                
                dateStr = String(dateStr).trim();
                if (!dateStr) return null;
                
                // æ¸…ç†æ—¥æœŸå­—ç¬¦ä¸²ï¼Œç§»é™¤å¤šä½™çš„ç©ºæ ¼
                dateStr = dateStr.replace(/\s+/g, ' ').trim();
                
                // å¤„ç†å¸¦æ—¶é—´çš„æ—¥æœŸæ ¼å¼
                let datePart = dateStr;
                let timePart = null;
                
                // åˆ†ç¦»æ—¥æœŸå’Œæ—¶é—´éƒ¨åˆ†
                const timeMatch = dateStr.match(/(\d{1,2}:\d{2}(?::\d{2})?(?:\.\d{3})?\s*(?:[AP]M)?)$/i);
                if (timeMatch) {
                    timePart = timeMatch[1];
                    datePart = dateStr.substring(0, timeMatch.index).trim();
                }
                
                // è§£ææ—¶é—´éƒ¨åˆ†
                if (timePart) {
                    const timeStr = timePart.trim();
                    let timeHour, timeMinute, timeSecond = 0;
                    
                    // å¤„ç†AM/PMæ ¼å¼
                    const ampmMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
                    if (ampmMatch) {
                        timeHour = parseInt(ampmMatch[1]);
                        timeMinute = parseInt(ampmMatch[2]);
                        const ampm = ampmMatch[3].toUpperCase();
                        
                        if (ampm === 'PM' && timeHour < 12) timeHour += 12;
                        if (ampm === 'AM' && timeHour === 12) timeHour = 0;
                    } else {
                        // å¤„ç†24å°æ—¶æ ¼å¼
                        const timeParts = timeStr.split(':');
                        timeHour = parseInt(timeParts[0]) || 0;
                        timeMinute = parseInt(timeParts[1]) || 0;
                        if (timeParts[2]) {
                            const secondPart = timeParts[2].replace(/\.\d{3}$/, '');
                            timeSecond = parseInt(secondPart) || 0;
                        }
                    }
                    
                    hour = timeHour;
                    minute = timeMinute;
                    second = timeSecond;
                }
                
                // æ ¹æ®æŒ‡å®šæ ¼å¼è§£ææ—¥æœŸ
                if (format === 'YYYY-MM-DD') {
                    const parts = datePart.split('-');
                    if (parts.length >= 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        day = parseInt(parts[2]);
                    }
                } else if (format === 'YYYY/MM/DD') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        day = parseInt(parts[2]);
                    }
                } else if (format === 'MM/DD/YYYY') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        month = parseInt(parts[0]) - 1;
                        day = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                    }
                } else if (format === 'DD/MM/YYYY') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        year = parseInt(parts[2]);
                    }
                }
                
                // å¦‚æœæŒ‡å®šæ ¼å¼æœªæˆåŠŸè§£æï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹æ ¼å¼
                if (!year || month === undefined || !day) {
                    // å¤„ç†YYYY-MM-DDæ ¼å¼
                    const ymdMatch = datePart.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                    if (ymdMatch) {
                        year = parseInt(ymdMatch[1]);
                        month = parseInt(ymdMatch[2]) - 1;
                        day = parseInt(ymdMatch[3]);
                    } else {
                        // å¤„ç†YYYY/MM/DDæ ¼å¼
                        const ymdSlashMatch = datePart.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
                        if (ymdSlashMatch) {
                            year = parseInt(ymdSlashMatch[1]);
                            month = parseInt(ymdSlashMatch[2]) - 1;
                            day = parseInt(ymdSlashMatch[3]);
                        } else {
                            // å¤„ç†MM/DD/YYYYæ ¼å¼
                            const mdyMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                            if (mdyMatch) {
                                month = parseInt(mdyMatch[1]) - 1;
                                day = parseInt(mdyMatch[2]);
                                year = parseInt(mdyMatch[3]);
                            } else {
                                // å¤„ç†DD/MM/YYYYæ ¼å¼
                                const dmyMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                                if (dmyMatch) {
                                    day = parseInt(dmyMatch[1]);
                                    month = parseInt(dmyMatch[2]) - 1;
                                    year = parseInt(dmyMatch[3]);
                                } else {
                                    // å¤„ç†YYYYMMDDæ ¼å¼
                                    const yyyymmddMatch = datePart.match(/^(\d{4})(\d{2})(\d{2})$/);
                                    if (yyyymmddMatch) {
                                        year = parseInt(yyyymmddMatch[1]);
                                        month = parseInt(yyyymmddMatch[2]) - 1;
                                        day = parseInt(yyyymmddMatch[3]);
                                    } else {
                                        // å¤„ç†DDMMYYYYæ ¼å¼
                                        const ddmmyyyyMatch = datePart.match(/^(\d{2})(\d{2})(\d{4})$/);
                                        if (ddmmyyyyMatch) {
                                            day = parseInt(ddmmyyyyMatch[1]);
                                            month = parseInt(ddmmyyyyMatch[2]) - 1;
                                            year = parseInt(ddmmyyyyMatch[3]);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ—¥æœŸ
                if (year && month !== undefined && day) {
                    // éªŒè¯æœˆä»½å’Œæ—¥æœŸèŒƒå›´
                    if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                        const date = new Date(year, month, day, hour, minute, second);
                        
                        // éªŒè¯æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                        if (date.getFullYear() === year && 
                            date.getMonth() === month && 
                            date.getDate() === day) {
                            return date;
                        }
                    }
                }
                
                // å°è¯•è®©Dateå¯¹è±¡è‡ªåŠ¨è§£æï¼ˆå¤„ç†æ›´å¤šæ ¼å¼ï¼‰
                try {
                    const autoDate = new Date(dateStr);
                    if (!isNaN(autoDate.getTime())) {
                        if (timePart) {
                            autoDate.setHours(hour, minute, second);
                        }
                        return autoDate;
                    }
                } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
                
                // å°è¯•å¤„ç†Excelæ—¥æœŸåºåˆ—å·ï¼ˆæ•°å­—æ ¼å¼ï¼‰
                if (/^\d+$/.test(dateStr) && !isNaN(parseInt(dateStr))) {
                    const excelDate = parseInt(dateStr);
                    // Excelæ—¥æœŸåºåˆ—å·ä»1900-01-01å¼€å§‹ï¼Œä½†éœ€è¦è€ƒè™‘é—°å¹´bug
                    if (excelDate >= 1 && excelDate <= 2958465) { // Excelæœ‰æ•ˆæ—¥æœŸèŒƒå›´
                        const baseDate = new Date(1900, 0, 1);
                        baseDate.setDate(baseDate.getDate() + excelDate - 1);
                        if (timePart) {
                            baseDate.setHours(hour, minute, second);
                        }
                        return baseDate;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error parsing date:', error);
                return null;
            }
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸèŒƒå›´æ˜¾ç¤º
        function formatDateRangeDisplay(dateString) {
            if (!dateString) return '';
            
            // ç›´æ¥ä½¿ç”¨Dateå¯¹è±¡è§£ææ—¥æœŸå­—ç¬¦ä¸²
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                // å¦‚æœç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨parseDateå‡½æ•°
                const parsedDate = parseDate(dateString);
                if (!parsedDate) return dateString;
                return formatDateForInput(parsedDate);
            }
            
            // ä½¿ç”¨formatDateForInputå‡½æ•°æ ¼å¼åŒ–æ—¥æœŸ
            return formatDateForInput(date);
        }

        function getColorForIndex(index) {
            // ä¼˜åŒ–çš„ä¸“ä¸šé…è‰²æ–¹æ¡ˆ - åŸºäºTailwind CSSè‰²å½©ç³»ç»Ÿ
            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                '#06B6D4', '#F97316', '#84CC16', '#EC4899', '#6366F1',
                '#14B8A6', '#F43F5E', '#A855F7', '#0EA5E9', '#EAB308',
                '#22C55E', '#D946EF', '#F87171', '#34D399', '#60A5FA',
                '#FBBF24', '#A78BFA', '#FB923C', '#67E8F9', '#FDA4AF'
            ];
            
            return colors[index % colors.length];
        }

        function getLineDash(style) {
            switch (style) {
                case 'solid':
                    return [];
                case 'dashed':
                    return [5, 5];
                case 'dotted':
                    return [2, 2];
                case 'dashdot':
                    return [5, 2, 2, 2];
                default:
                    return [];
            }
        }

        function chartToSVG(chart) {
            // å°†Chart.jså›¾è¡¨è½¬æ¢ä¸ºSVG
            const canvas = chart.canvas;
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
            
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('width', canvas.width);
            image.setAttribute('height', canvas.height);
            image.setAttribute('href', canvas.toDataURL('image/png'));
            
            svg.appendChild(image);
            
            return new XMLSerializer().serializeToString(svg);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†é—´éš”å››èˆäº”å…¥åˆ°æœ€æ¥è¿‘çš„æ ‡å‡†å€¼
        function roundToNearestStandardInterval(interval) {
            const standardIntervals = [1, 5, 15, 30, 60];
            
            // æ‰¾åˆ°æœ€æ¥è¿‘çš„æ ‡å‡†é—´éš”
            let closestInterval = standardIntervals[0];
            let minDiff = Math.abs(interval - closestInterval);
            
            for (let i = 1; i < standardIntervals.length; i++) {
                const diff = Math.abs(interval - standardIntervals[i]);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestInterval = standardIntervals[i];
                }
            }
            
            return closestInterval;
        }
        
        // æ—¶é—´æˆ³é—´éš”åˆ†æå‡½æ•°
        function analyzeTimestampIntervals(timestamps, dateKey) {
            if (!timestamps || timestamps.length < 3) return null;
            
            // æ’åºæ—¶é—´æˆ³
            const sortedTimestamps = [...timestamps].sort((a, b) => a - b);
            const intervals = [];
            const intervalCounts = {};
            
            // è®¡ç®—æ‰€æœ‰ç›¸é‚»æ—¶é—´æˆ³çš„é—´éš”
            for (let i = 1; i < sortedTimestamps.length; i++) {
                const intervalMs = sortedTimestamps[i] - sortedTimestamps[i-1];
                const intervalMinutes = intervalMs / (1000 * 60);
                
                // è¿‡æ»¤åˆç†çš„é—´éš”ï¼ˆ1åˆ†é’Ÿåˆ°2å°æ—¶ï¼‰
                if (intervalMinutes >= 1 && intervalMinutes <= 120) {
                    intervals.push(intervalMinutes);
                    
                    // ç»Ÿè®¡é—´éš”é¢‘æ¬¡ï¼ˆå››èˆäº”å…¥åˆ°æœ€è¿‘çš„æ•´æ•°ï¼‰
                    const roundedInterval = Math.round(intervalMinutes);
                    intervalCounts[roundedInterval] = (intervalCounts[roundedInterval] || 0) + 1;
                }
            }
            
            if (intervals.length === 0) return null;
            
            // æ‰¾åˆ°æœ€é¢‘ç¹çš„é—´éš”
            let mostFrequentInterval = null;
            let maxCount = 0;
            for (const [interval, count] of Object.entries(intervalCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    mostFrequentInterval = parseInt(interval);
                }
            }
            
            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const medianInterval = intervals.sort((a, b) => a - b)[Math.floor(intervals.length / 2)];
            const stdDev = Math.sqrt(intervals.reduce((sum, val) => sum + Math.pow(val - avgInterval, 2), 0) / intervals.length);
            
            // è®¡ç®—ä¸€è‡´æ€§åˆ†æ•°
            const consistencyScore = maxCount / intervals.length;
            const variabilityScore = 1 - Math.min(stdDev / avgInterval, 1);
            
            // é€‰æ‹©æœ€ä½³é—´éš”ï¼ˆä¼˜å…ˆè€ƒè™‘æœ€é¢‘ç¹çš„ï¼Œç„¶åæ˜¯ä¸­ä½æ•°ï¼‰
            let detectedInterval = mostFrequentInterval;
            if (consistencyScore < 0.6) {
                detectedInterval = Math.round(medianInterval);
            }
            
            const closestStandard = roundToNearestStandardInterval(detectedInterval);
            
            // è®¡ç®—ç½®ä¿¡åº¦
            let confidence = 0.5;
            if (consistencyScore >= 0.8 && variabilityScore >= 0.8) {
                confidence = 0.95;
            } else if (consistencyScore >= 0.6 && variabilityScore >= 0.6) {
                confidence = 0.85;
            } else if (consistencyScore >= 0.4 || variabilityScore >= 0.4) {
                confidence = 0.7;
            }
            
            // å¦‚æœæ£€æµ‹åˆ°çš„é—´éš”ä¸æ ‡å‡†é—´éš”å®Œå…¨åŒ¹é…ï¼Œæé«˜ç½®ä¿¡åº¦
            if (detectedInterval === closestStandard) {
                confidence = Math.min(0.98, confidence + 0.1);
            }
            
            return {
                interval: closestStandard,
                description: `${closestStandard}åˆ†é’Ÿ`,
                confidence: confidence,
                method: 'æ—¶é—´æˆ³é—´éš”åˆ†æ',
                details: `${dateKey}æ—¥æœŸåˆ†æ${intervals.length}ä¸ªé—´éš”ï¼Œå¹³å‡${avgInterval.toFixed(1)}åˆ†é’Ÿï¼Œæœ€é¢‘ç¹${mostFrequentInterval}åˆ†é’Ÿï¼ˆ${maxCount}æ¬¡ï¼‰ï¼Œä¸€è‡´æ€§${(consistencyScore*100).toFixed(1)}%`
            };
        }
        
        // è·¨æ—¥æœŸæ—¶é—´æˆ³æ¨¡å¼åˆ†æå‡½æ•°
        function analyzeCrossDateTimestampPattern(timeStampAnalysis) {
            const dateKeys = Object.keys(timeStampAnalysis);
            if (dateKeys.length < 2) return null;
            
            const allIntervalResults = [];
            const intervalFrequency = {};
            
            // åˆ†ææ¯ä¸ªæ—¥æœŸçš„æ—¶é—´æˆ³æ¨¡å¼
            for (const dateKey of dateKeys) {
                const timestamps = timeStampAnalysis[dateKey];
                if (timestamps.length < 3) continue;
                
                const result = analyzeTimestampIntervals(timestamps, dateKey);
                if (result && result.confidence >= 0.6) {
                    allIntervalResults.push(result);
                    intervalFrequency[result.interval] = (intervalFrequency[result.interval] || 0) + 1;
                }
            }
            
            if (allIntervalResults.length === 0) return null;
            
            // æ‰¾åˆ°æœ€ä¸€è‡´çš„é—´éš”
            let mostConsistentInterval = null;
            let maxFrequency = 0;
            for (const [interval, frequency] of Object.entries(intervalFrequency)) {
                if (frequency > maxFrequency) {
                    maxFrequency = frequency;
                    mostConsistentInterval = parseInt(interval);
                }
            }
            
            // è®¡ç®—è·¨æ—¥æœŸä¸€è‡´æ€§
            const consistencyRatio = maxFrequency / allIntervalResults.length;
            const avgConfidence = allIntervalResults
                .filter(r => r.interval === mostConsistentInterval)
                .reduce((sum, r) => sum + r.confidence, 0) / maxFrequency;
            
            // è®¡ç®—æœ€ç»ˆç½®ä¿¡åº¦
            let finalConfidence = avgConfidence * consistencyRatio;
            if (consistencyRatio >= 0.8) {
                finalConfidence = Math.min(0.95, finalConfidence + 0.1);
            }
            
            return {
                interval: mostConsistentInterval,
                description: `${mostConsistentInterval}åˆ†é’Ÿ`,
                confidence: finalConfidence,
                method: 'è·¨æ—¥æœŸæ¨¡å¼åˆ†æ',
                details: `åˆ†æ${dateKeys.length}ä¸ªæ—¥æœŸï¼Œ${maxFrequency}ä¸ªæ—¥æœŸæ£€æµ‹åˆ°${mostConsistentInterval}åˆ†é’Ÿé—´éš”ï¼Œä¸€è‡´æ€§${(consistencyRatio*100).toFixed(1)}%`
            };
        }
        
        // å¢å¼ºçš„æ™ºèƒ½æ—¶é—´é—´éš”æ£€æµ‹å‡½æ•° - å¤šç»´åº¦ç»¼åˆåˆ†æ
        function detectTimeIntervalIntelligently(data, startIndex, endIndex, dateCol, meteringPointCol, selectedMeteringPoint, isCrossDateStructure, dataColumnCount) {
            const standardIntervals = [
                { interval: 1, points: 1440, description: '1åˆ†é’Ÿ', tolerance: 0.01, weight: 1.0 },
                { interval: 5, points: 288, description: '5åˆ†é’Ÿ', tolerance: 0.02, weight: 1.0 },
                { interval: 15, points: 96, description: '15åˆ†é’Ÿ', tolerance: 0.01, weight: 1.0 }, // 96è¡Œæ•°æ®ç²¾ç¡®åŒ¹é…15åˆ†é’Ÿ
                { interval: 30, points: 48, description: '30åˆ†é’Ÿ', tolerance: 0.02, weight: 0.8 },
                { interval: 60, points: 24, description: '60åˆ†é’Ÿ', tolerance: 0.05, weight: 1.0 }
            ];
            
            let detectionResults = [];
            let analysisLog = [];
            
            // æ•°æ®é¢„å¤„ç†
            const processedData = [];
            const dateCellCounts = {};
            const timestamps = [];
            
            for (let i = startIndex; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // æ£€æŸ¥è®¡é‡ç‚¹ç¼–å·ç­›é€‰
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) continue;
                }
                
                // è§£ææ—¥æœŸ
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) continue;
                
                const dateKey = formatDateKey(date);
                const timestamp = date.getTime();
                
                processedData.push({
                    date: dateKey,
                    timestamp: timestamp,
                    rawData: row
                });
                
                dateCellCounts[dateKey] = (dateCellCounts[dateKey] || 0) + 1;
                timestamps.push(timestamp);
            }
            
            // 96è¡Œæ•°æ®ç‰¹æ®Šå¤„ç† - ç›´æ¥è¯†åˆ«ä¸º15åˆ†é’Ÿé—´éš”
            const totalRows = processedData.length;
            const uniqueDates = Object.keys(dateCellCounts).length;
            const avgPerDay = totalRows / Math.max(1, uniqueDates);
            
            if (Math.abs(avgPerDay - 96) <= 1) {
                return {
                    interval: 15,
                    description: '15åˆ†é’Ÿï¼ˆ96è¡Œæ•°æ®ç²¾ç¡®åŒ¹é…ï¼‰',
                    confidence: 0.98,
                    method: '96è¡Œæ•°æ®ç²¾ç¡®åŒ¹é…',
                    message: 'æ£€æµ‹åˆ°96è¡Œæ•°æ®ï¼Œç²¾ç¡®è¯†åˆ«ä¸º15åˆ†é’Ÿé—´éš”'
                };
            }
            
            if (processedData.length === 0) {
                return {
                    interval: 15,
                    description: '15åˆ†é’Ÿï¼ˆé»˜è®¤ï¼‰',
                    confidence: 0.3,
                    method: 'é»˜è®¤å€¼',
                    message: 'æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤15åˆ†é’Ÿé—´éš”'
                };
            }
            
            // æ–¹æ³•1: åŸºäºå•å…ƒæ ¼æ•°é‡çš„åˆ†æï¼ˆè·¨æ—¥æœŸç»“æ„ï¼‰
            if (isCrossDateStructure) {
                const counts = Object.values(dateCellCounts);
                const uniqueDates = Object.keys(dateCellCounts).length;
                
                if (counts.length > 0) {
                    const stats = calculateEnhancedStatistics(counts);
                    
                    standardIntervals.forEach(standard => {
                        const scores = calculateEnhancedCellCountScores(stats, standard, uniqueDates);
                        if (scores.totalScore > 0.5) {
                            detectionResults.push({
                                interval: standard.interval,
                                description: standard.description,
                                confidence: scores.totalScore,
                                method: 'å•å…ƒæ ¼æ•°é‡åˆ†æ',
                                details: `å¹³å‡${stats.mean.toFixed(1)}ä¸ª/å¤©ï¼Œ${uniqueDates}ä¸ªæ—¥æœŸ`
                            });
                        }
                    });
                }
                
                // æ–¹æ³•2: åŸºäºæ—¶é—´æˆ³é—´éš”åˆ†æ
                if (timestamps.length >= 3) {
                    const sortedTimestamps = [...timestamps].sort((a, b) => a - b);
                    const intervals = [];
                    
                    for (let i = 1; i < sortedTimestamps.length; i++) {
                        const interval = (sortedTimestamps[i] - sortedTimestamps[i-1]) / (1000 * 60);
                        if (interval >= 0.5 && interval <= 120) {
                            intervals.push(interval);
                        }
                    }
                    
                    if (intervals.length > 0) {
                        const stats = calculateEnhancedStatistics(intervals);
                        const filtered = filterOutliers(intervals);
                        
                        standardIntervals.forEach(standard => {
                            const scores = calculateEnhancedTimestampScores(stats, filtered, standard);
                            if (scores.totalScore > 0.5) {
                                detectionResults.push({
                                    interval: standard.interval,
                                    description: standard.description,
                                    confidence: scores.totalScore,
                                    method: 'æ—¶é—´æˆ³é—´éš”åˆ†æ',
                                    details: `å¹³å‡${stats.mean.toFixed(1)}åˆ†é’Ÿï¼Œå˜å¼‚ç³»æ•°${stats.cv.toFixed(3)}`
                                });
                            }
                        });
                    }
                }
                
            } else {
                // éè·¨æ—¥æœŸç»“æ„ï¼šåŸºäºæ•°æ®åˆ—æ•°é‡çš„æ£€æµ‹
                if (dataColumnCount > 0) {
                    standardIntervals.forEach(standard => {
                        const tolerance = Math.max(1, Math.floor(standard.points * 0.05));
                        const diff = Math.abs(dataColumnCount - standard.points);
                        
                        if (diff <= tolerance) {
                            const score = 1.0 - (diff / standard.points);
                            detectionResults.push({
                                interval: standard.interval,
                                description: standard.description,
                                confidence: Math.max(0.6, score),
                                method: 'æ•°æ®åˆ—æ•°é‡åˆ†æ',
                                details: `æ£€æµ‹åˆ°${dataColumnCount}ä¸ªæ•°æ®åˆ—`
                            });
                        }
                    });
                }
            }
            
            // æ–¹æ³•3: åŸºäºç»Ÿè®¡ä¸€è‡´æ€§çš„åˆ†æ
            const consistencyResult = analyzeStatisticalConsistency(processedData, standardIntervals);
            if (consistencyResult) {
                detectionResults.push(consistencyResult);
            }
            
            // ç»¼åˆè¯„ä¼°å’Œé€‰æ‹©
            return synthesizeEnhancedResults(detectionResults);
        }
        
        // å¢å¼ºç»Ÿè®¡è®¡ç®—å‡½æ•°
        function calculateEnhancedStatistics(arr) {
            if (!arr || arr.length === 0) return null;
            
            const sorted = [...arr].sort((a, b) => a - b);
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const median = sorted.length % 2 === 0 ? 
                (sorted[Math.floor(sorted.length/2) - 1] + sorted[Math.floor(sorted.length/2)]) / 2 : 
                sorted[Math.floor(sorted.length/2)];
            
            const counts = {};
            arr.forEach(val => {
                const key = Math.round(val);
                counts[key] = (counts[key] || 0) + 1;
            });
            
            const mode = parseInt(Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b));
            const stdDev = Math.sqrt(arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length);
            const cv = stdDev / mean;
            
            return { mean, median, mode, stdDev, cv, min: sorted[0], max: sorted[sorted.length - 1] };
        }
        
        // è®¡ç®—å•å…ƒæ ¼æ•°é‡è¯„åˆ†
        function calculateEnhancedCellCountScores(stats, standard, uniqueDates) {
            const tolerance = Math.max(1, Math.floor(standard.points * standard.tolerance));
            const exactScore = stats.mean === standard.points ? 1.0 : 0;
            const closeScore = Math.max(0, 1 - Math.abs(stats.mean - standard.points) / standard.points);
            const consistencyScore = Math.max(0, 1 - stats.cv);
            const dateFactor = Math.min(1, uniqueDates / 3); // è‡³å°‘3å¤©æ•°æ®
            
            return {
                exact: exactScore,
                close: closeScore,
                consistency: consistencyScore,
                dateFactor: dateFactor,
                totalScore: (exactScore * 0.3 + closeScore * 0.4 + consistencyScore * 0.2 + dateFactor * 0.1)
            };
        }
        
        // è®¡ç®—æ—¶é—´æˆ³è¯„åˆ†
        function calculateEnhancedTimestampScores(stats, filtered, standard) {
            const tolerance = standard.interval * standard.tolerance;
            const modeScore = Math.max(0, 1 - Math.abs(stats.mode - standard.interval) / standard.interval);
            const meanScore = Math.max(0, 1 - Math.abs(stats.mean - standard.interval) / standard.interval);
            const consistencyScore = Math.max(0, 1 - stats.cv);
            const outlierFactor = filtered.length / (filtered.length + 1); // è€ƒè™‘å¼‚å¸¸å€¼è¿‡æ»¤
            
            return {
                mode: modeScore,
                mean: meanScore,
                consistency: consistencyScore,
                outlier: outlierFactor,
                totalScore: (modeScore * 0.4 + meanScore * 0.3 + consistencyScore * 0.2 + outlierFactor * 0.1)
            };
        }
        
        // å¼‚å¸¸å€¼è¿‡æ»¤
        function filterOutliers(arr) {
            if (!arr || arr.length < 4) return arr;
            
            const sorted = [...arr].sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            
            return sorted.filter(val => val >= lowerBound && val <= upperBound);
        }
        
        // ç»Ÿè®¡ä¸€è‡´æ€§åˆ†æ
        function analyzeStatisticalConsistency(data, standardIntervals) {
            if (!data || data.length < 10) return null;
            
            const timestamps = data.map(d => d.timestamp).sort((a, b) => a - b);
            const intervals = [];
            
            for (let i = 1; i < timestamps.length; i++) {
                const interval = (timestamps[i] - timestamps[i-1]) / (1000 * 60);
                intervals.push(interval);
            }
            
            if (intervals.length === 0) return null;
            
            const stats = calculateEnhancedStatistics(intervals);
            const standardIntervalsList = standardIntervals.map(s => s.interval);
            
            // è®¡ç®—ä¸æ ‡å‡†é—´éš”çš„åŒ¹é…åº¦
            let bestMatch = null;
            let bestScore = 0;
            
            standardIntervals.forEach(standard => {
                const matches = intervals.filter(i => Math.abs(i - standard.interval) <= standard.interval * 0.1);
                const matchRate = matches.length / intervals.length;
                
                if (matchRate > 0.6) { // 60%ä»¥ä¸ŠåŒ¹é…
                    const score = matchRate * (1 - stats.cv);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = {
                            interval: standard.interval,
                            description: standard.description,
                            confidence: score,
                            method: 'ç»Ÿè®¡ä¸€è‡´æ€§åˆ†æ',
                            details: `åŒ¹é…ç‡${(matchRate*100).toFixed(1)}%ï¼Œä¸€è‡´æ€§${((1-stats.cv)*100).toFixed(1)}%`
                        };
                    }
                }
            });
            
            return bestMatch;
        }
        
        // ç»¼åˆç»“æœè¯„ä¼°
        function synthesizeEnhancedResults(results) {
            if (!results || results.length === 0) {
                return {
                    interval: 15,
                    description: '15åˆ†é’Ÿï¼ˆé»˜è®¤ï¼‰',
                    confidence: 0.3,
                    method: 'é»˜è®¤å€¼',
                    message: 'æœªèƒ½æ£€æµ‹åˆ°æ˜ç¡®çš„æ—¶é—´é—´éš”æ¨¡å¼ï¼Œä½¿ç”¨é»˜è®¤15åˆ†é’Ÿé—´éš”'
                };
            }
            
            // æŒ‰ç½®ä¿¡åº¦æ’åº
            results.sort((a, b) => b.confidence - a.confidence);
            
            // æ£€æŸ¥ä¸€è‡´æ€§
            const intervals = results.map(r => r.interval);
            const uniqueIntervals = [...new Set(intervals)];
            
            let bestResult = results[0];
            
            // å¦‚æœå¤šä¸ªæ–¹æ³•æŒ‡å‘åŒä¸€é—´éš”ï¼Œæé«˜ç½®ä¿¡åº¦
            const supportingMethods = results.filter(r => r.interval === bestResult.interval);
            if (supportingMethods.length > 1) {
                const avgConfidence = supportingMethods.reduce((sum, r) => sum + r.confidence, 0) / supportingMethods.length;
                bestResult.confidence = Math.min(0.99, avgConfidence + 0.1);
                bestResult.message = `é€šè¿‡${supportingMethods.length}ç§æ–¹æ³•ä¸€è‡´æ£€æµ‹åˆ°ï¼š${bestResult.description}`;
            } else {
                bestResult.message = `${bestResult.method}æ£€æµ‹åˆ°ï¼š${bestResult.description}ï¼Œ${bestResult.details}`;
            }
            
            // ç”Ÿæˆå€™é€‰æ–¹æ¡ˆ
            const candidates = results
                .filter(r => r.interval !== bestResult.interval && r.confidence >= 0.4)
                .slice(0, 3)
                .map(r => ({
                    interval: r.interval,
                    confidence: r.confidence,
                    method: r.method
                }));
            
            bestResult.candidates = candidates;
            
            return bestResult;
        }

        // åˆå§‹åŒ–æ—¥æœŸæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾
        function initDailyTotalBarChart() {
            console.log('=== åˆ›å»ºæ¯æ—¥æ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾ ===');
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsåº“æœªåŠ è½½ï¼ç­‰å¾…500msåé‡è¯•...');
                setTimeout(initDailyTotalBarChart, 500);
                return;
            }
            
            const canvasElement = document.getElementById('dailyTotalBarChart');
            if (!canvasElement) {
                console.error('æ‰¾ä¸åˆ°dailyTotalBarChart canvaså…ƒç´ ');
                return;
            }
            
            // ç¡®ä¿canvaså…ƒç´ å¯è§ä¸”æœ‰å°ºå¯¸ï¼ˆè‹¥ä¸º0åˆ™å¼ºåˆ¶è®¾ç½®å®¹å™¨å°ºå¯¸å¹¶ç»§ç»­ï¼‰
            if (canvasElement.offsetWidth === 0 || canvasElement.offsetHeight === 0) {
                console.warn('Canvaså…ƒç´ å°ºå¯¸ä¸º0ï¼Œå°è¯•å¼ºåˆ¶è®¾ç½®å®¹å™¨å°ºå¯¸å¹¶ç»§ç»­åˆå§‹åŒ–...');
                const barChartContainer = document.getElementById('dailyTotalBarChartContainer');
                if (barChartContainer) {
                    barChartContainer.style.display = 'block';
                    if (!barChartContainer.style.height) {
                        barChartContainer.style.height = '500px';
                    }
                }
                if (!canvasElement.style.height) {
                    canvasElement.style.height = '400px';
                }
                // ä¸å†ç›´æ¥returnï¼Œç»§ç»­åˆ›å»ºå›¾è¡¨ï¼Œç”±Chart.jsè‡ªé€‚åº”
            }
            
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                console.error('æ— æ³•è·å–canvas 2Dä¸Šä¸‹æ–‡');
                return;
            }
            
            // å¦‚æœå·²å­˜åœ¨å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯å®ƒ
            if (appData.dailyTotalBarChart) {
                console.log('é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹');
                try {
                    appData.dailyTotalBarChart.destroy();
                } catch (e) {
                    console.warn('é”€æ¯å›¾è¡¨å®ä¾‹æ—¶å‡ºé”™:', e);
                }
                appData.dailyTotalBarChart = null;
            }
            
            // åˆ›å»ºæ¸å˜è‰²
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradient.addColorStop(1, 'rgba(147, 197, 253, 0.4)');
            
            // åˆ›å»ºæŸ±çŠ¶å›¾
            appData.dailyTotalBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ—¥æ€»ç”¨ç”µé‡',
                        data: [],
                        backgroundColor: gradient,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                        hoverBackgroundColor: 'rgba(59, 130, 246, 0.9)',
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            right: 30,
                            bottom: 20,
                            left: 20
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ¯æ—¥æ€»ç”¨ç”µé‡ç»Ÿè®¡',
                            font: {
                                size: 22,
                                family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                weight: '600'
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            },
                            color: '#1F2937'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            titleColor: '#1F2937',
                            titleFont: {
                                size: 16,
                                weight: '600'
                            },
                            bodyColor: '#4B5563',
                            bodyFont: {
                                size: 14,
                                family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif'
                            },
                            borderColor: 'rgba(0, 0, 0, 0.15)',
                            borderWidth: 1,
                            padding: 15,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return 'æ—¥æœŸ: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `æ€»ç”¨ç”µé‡: ${value.toFixed(2)} kWh`;
                                },
                                afterLabel: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                                    return `å æ¯”: ${percentage}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ',
                                font: {
                                    size: 16,
                                    weight: '500'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 13
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æ€»ç”¨ç”µé‡ (kWh)',
                                font: {
                                    size: 16,
                                    weight: '500'
                                }
                            },
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 13
                                },
                                callback: function(value) {
                                    return value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            console.log('æ¯æ—¥æ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾åˆ›å»ºå®Œæˆ');
        } // ç»“æŸ initEventListeners å‡½æ•°
        
        // æ›´æ–°æ—¥æœŸæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾ï¼ˆæ”¯æŒæŒ‰æ—¥/æŒ‰æœˆèšåˆï¼‰
        function updateDailyTotalBarChart(filteredData) {
            console.log('=== æ›´æ–°æ¯æ—¥/æ¯æœˆæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾ ===', {
                æ¥æ”¶æ•°æ®é‡: filteredData ? filteredData.length : 0,
                æ•°æ®æ ·æœ¬: filteredData ? filteredData.slice(0, 2) : 'æ— æ•°æ®',
                æŸ±çŠ¶å›¾å®ä¾‹: !!appData.dailyTotalBarChart,
                èšåˆæ–¹å¼: appData?.visualization?.barChartAggregation || 'daily'
            });
            
            if (!appData.dailyTotalBarChart) {
                console.error('æŸ±çŠ¶å›¾å®ä¾‹ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–...');
                initDailyTotalBarChart();
                
                // å»¶è¿Ÿé‡è¯•ï¼Œæœ€å¤šé‡è¯•3æ¬¡
                let retryCount = 0;
                const retryInit = () => {
                    retryCount++;
                    if (retryCount <= 3 && !appData.dailyTotalBarChart) {
                        console.log(`é‡è¯•åˆå§‹åŒ–æŸ±çŠ¶å›¾ï¼Œç¬¬${retryCount}æ¬¡...`);
                        initDailyTotalBarChart();
                        setTimeout(retryInit, 200);
                    } else if (appData.dailyTotalBarChart) {
                        updateDailyTotalBarChart(filteredData);
                    } else {
                        console.error('æŸ±çŠ¶å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥Chart.jså’Œcanvaså…ƒç´ ');
                    }
                };
                setTimeout(retryInit, 100);
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingEl = document.getElementById('barChartLoading');
            const noDataEl = document.getElementById('barChartNoDataMessage');
            
            if (loadingEl && loadingEl.parentNode) loadingEl.classList.remove('hidden');
            if (noDataEl && noDataEl.parentNode) noDataEl.classList.add('hidden');
            
            try {
                // æ•°æ®éªŒè¯å’Œè¿‡æ»¤
                if (!filteredData || !Array.isArray(filteredData)) {
                    console.warn('æ•°æ®æ ¼å¼æ— æ•ˆ:', typeof filteredData);
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (filteredData.length === 0) {
                    console.warn('æ— æ•°æ®å¯æ˜¾ç¤º');
                    appData.dailyTotalBarChart.data.labels = [];
                    appData.dailyTotalBarChart.data.datasets[0].data = [];
                    appData.dailyTotalBarChart.update('none');
                    if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
                    return;
                }
                
                // éªŒè¯å¹¶æ¸…ç†æ•°æ®
                const validData = filteredData.filter(row => 
                    row && 
                    typeof row === 'object' && 
                    row.date && 
                    typeof row.dailyTotal === 'number' && 
                    !isNaN(row.dailyTotal) && 
                    row.dailyTotal >= 0
                );
                
                console.log('æ•°æ®éªŒè¯ç»“æœ:', {
                    åŸå§‹æ•°æ®é‡: filteredData.length,
                    æœ‰æ•ˆæ•°æ®é‡: validData.length,
                    æ ·æœ¬æ•°æ®: validData.slice(0, 3)
                });
                
                if (validData.length === 0) {
                    console.warn('æ— æœ‰æ•ˆæ•°æ®å¯æ˜¾ç¤º');
                    appData.dailyTotalBarChart.data.labels = [];
                    appData.dailyTotalBarChart.data.datasets[0].data = [];
                    appData.dailyTotalBarChart.update('none');
                    if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
                    return;
                }
                
                // è¯»å–èšåˆæ–¹å¼ï¼šdaily æˆ– monthly
                const aggregation = (appData?.visualization?.barChartAggregation === 'monthly') ? 'monthly' : 'daily';
                
                // æŒ‰èšåˆæ–¹å¼åˆ†ç»„å¹¶ç´¯åŠ æ€»ç”¨ç”µé‡
                const groupMap = new Map();
                validData.forEach(row => {
                    if (!row.date || typeof row.dailyTotal !== 'number') return;
                    let dateStr = String(row.date);
                    // æ ‡å‡†åŒ–ä¸º YYYY-MM-DD
                    if (dateStr.length === 8 && !dateStr.includes('-')) {
                        dateStr = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                    }
                    let key;
                    if (aggregation === 'monthly') {
                        // æå– YYYY-MM ä½œä¸ºæœˆä»½é”®
                        if (dateStr.length >= 7 && dateStr.includes('-')) {
                            key = dateStr.slice(0, 7);
                        } else {
                            // å›é€€ï¼šå°è¯•ç”¨ Date è§£æå¹¶æ ¼å¼åŒ–
                            const d = new Date(dateStr);
                            if (!isNaN(d.getTime())) {
                                const y = d.getFullYear();
                                const m = String(d.getMonth() + 1).padStart(2, '0');
                                key = `${y}-${m}`;
                            } else {
                                // æ— æ³•è§£æåˆ™åŸæ ·ä½¿ç”¨ï¼ˆå¯èƒ½ä¼šå¯¼è‡´æ’åºä»¥å­—ç¬¦ä¸²æ¯”è¾ƒï¼‰
                                key = dateStr;
                            }
                        }
                    } else {
                        // æ¯æ—¥
                        key = dateStr;
                    }
                    const cur = groupMap.get(key) || 0;
                    groupMap.set(key, cur + row.dailyTotal);
                });
                
                // æ’åºï¼ˆå°½é‡æŒ‰æ—¶é—´é¡ºåºï¼‰
                const sortedEntries = Array.from(groupMap.entries()).sort((a, b) => {
                    try {
                        const keyA = a[0];
                        const keyB = b[0];
                        // å¯¹äºæœˆä»½ï¼Œè¡¥å…¨ä¸ºè¯¥æœˆç¬¬ä¸€å¤©ä»¥ä¾¿æ¯”è¾ƒ
                        const dateA = new Date(aggregation === 'monthly' ? `${keyA}-01` : keyA);
                        const dateB = new Date(aggregation === 'monthly' ? `${keyB}-01` : keyB);
                        if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
                            return keyA.localeCompare(keyB);
                        }
                        return dateA - dateB;
                    } catch (e) {
                        return a[0].localeCompare(b[0]);
                    }
                });
                
                const labels = sortedEntries.map(([k]) => k);
                const data = sortedEntries.map(([, v]) => v);
                
                console.log('å›¾è¡¨æ•°æ®å‡†å¤‡å®Œæˆ:', {
                    ç»´åº¦: aggregation === 'monthly' ? 'æœˆä»½' : 'æ—¥æœŸ',
                    ç»´åº¦æ•°é‡: labels.length,
                    èŒƒå›´: labels.length > 0 ? `${labels[0]} è‡³ ${labels[labels.length-1]}` : 'æ— ',
                    æ•°æ®æ ·æœ¬: data.slice(0, 5),
                    æ•°æ®æ€»å’Œ: data.reduce((a, b) => a + b, 0)
                });
                
                if (labels.length === 0) {
                    console.warn('æ— æœ‰æ•ˆæ•°æ®');
                    if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
                    return;
                }
                
                // æ›´æ–°å›¾è¡¨æ ‡é¢˜/åæ ‡è½´/æç¤ºæ¡†
                const rangeText = labels.length > 0 ? `${labels[0]} è‡³ ${labels[labels.length - 1]}` : 'æ— ';
                const titlePrefix = aggregation === 'monthly' ? 'æ¯æœˆæ€»ç”¨ç”µé‡' : 'æ¯æ—¥æ€»ç”¨ç”µé‡';
                appData.dailyTotalBarChart.options.plugins.title.text = `${titlePrefix} (${rangeText})`;
                // Xè½´æ ‡é¢˜
                if (appData.dailyTotalBarChart.options.scales && appData.dailyTotalBarChart.options.scales.x && appData.dailyTotalBarChart.options.scales.x.title) {
                    appData.dailyTotalBarChart.options.scales.x.title.text = aggregation === 'monthly' ? 'æœˆä»½' : 'æ—¥æœŸ';
                }
                // Tooltip æ ‡é¢˜
                if (appData.dailyTotalBarChart.options.plugins && appData.dailyTotalBarChart.options.plugins.tooltip && appData.dailyTotalBarChart.options.plugins.tooltip.callbacks) {
                    appData.dailyTotalBarChart.options.plugins.tooltip.callbacks.title = function(tooltipItems) {
                        const dim = aggregation === 'monthly' ? 'æœˆä»½' : 'æ—¥æœŸ';
                        return `${dim}: ${tooltipItems[0].label}`;
                    };
                }
                
                // æ›´æ–°å›¾è¡¨æ•°æ®
                appData.dailyTotalBarChart.data.labels = labels;
                appData.dailyTotalBarChart.data.datasets[0].data = data;
                
                // ä½¿ç”¨åŠ¨ç”»æ›´æ–°
                appData.dailyTotalBarChart.update('normal');
                
            } catch (error) {
                console.error('æ›´æ–°æŸ±çŠ¶å›¾æ—¶å‡ºé”™:', error);
                if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
            } finally {
                if (loadingEl && loadingEl.parentNode) loadingEl.classList.add('hidden');
            }
        }

        // åˆå§‹åŒ–æœˆä»½æ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾





        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initEventListeners();
            loadImportHistory(); // åŠ è½½å¯¼å…¥å†å²è®°å½•
            
            // åˆå§‹åŒ–å¯¼å‡ºæŒ‰é’®çŠ¶æ€ä¸ºç¦ç”¨

            
            // åˆå§‹åŒ–æ­¥éª¤å¯¼èˆª
            initializeStepNavigation();
            
            // åˆå§‹åŒ–æ—¥æœŸæ€»ç”¨ç”µé‡æŸ±çŠ¶å›¾
            initDailyTotalBarChart();
            
            // åˆå§‹åŒ–24å°æ—¶è´Ÿè·æ›²çº¿å›¾è¡¨ï¼ˆå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿæ˜¾ç¤ºXYè½´ï¼‰
            initEmptyChart();
        }
        
        // åˆå§‹åŒ–ç©ºå›¾è¡¨ï¼Œæ˜¾ç¤ºXYè½´
        function initEmptyChart() {
            if (appData.chart) {
                appData.chart.destroy();
            }
            
            const ctx = elements.loadCurveChart.getContext('2d');
            appData.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'ç¤ºä¾‹æ•°æ®',
                        data: [],
                        borderColor: 'rgba(59, 130, 246, 0.3)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 15,
                            bottom: 10,
                            left: 15
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '24å°æ—¶è´Ÿè·æ›²çº¿',
                            font: {
                                size: 18,
                                family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                weight: '600'
                            },
                            padding: {
                                top: 10,
                                bottom: 15
                            },
                            color: '#1F2937'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¶é—´',
                                font: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1,
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '500'
                                },
                                padding: 8,
                                maxRotation: 0,
                                autoSkip: false
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ç”¨ç”µé‡ (kWh)',
                                font: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1,
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '500'
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });
            
            // éšè—åŠ è½½çŠ¶æ€
            const chartLoadingElement = document.getElementById('chartLoading');
            if (chartLoadingElement && chartLoadingElement.parentNode) {
                chartLoadingElement.classList.add('hidden');
            }
        }

        // åˆå§‹åŒ–æ­¥éª¤å¯¼èˆª
        function initializeStepNavigation() {
            // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªæ­¥éª¤
            updateStepNavigation('importSection');
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ ¹æ®å½“å‰è§†å›¾åŒºåŸŸæ›´æ–°æ­¥éª¤çŠ¶æ€
            window.addEventListener('scroll', debounce(() => {
                updateActiveStepBasedOnScroll();
            }, 100));
        }

        // æ ¹æ®æ»šåŠ¨ä½ç½®æ›´æ–°æ¿€æ´»æ­¥éª¤
        function updateActiveStepBasedOnScroll() {
            const sections = [
                { id: 'importSection', threshold: 0.5 },
                { id: 'configSection', threshold: 0.5 },
                { id: 'visualizationSection', threshold: 0.5 },
                { id: 'exportSection', threshold: 0.5 }
            ];
            
            const scrollPosition = window.scrollY + window.innerHeight / 2;
            
            for (let section of sections) {
                const element = document.getElementById(section.id);
                if (element) {
                    const rect = element.getBoundingClientRect();
                    const elementTop = rect.top + window.scrollY;
                    const elementBottom = elementTop + rect.height;
                    
                    if (scrollPosition >= elementTop && scrollPosition <= elementBottom) {
                        updateStepNavigation(section.id);
                        break;
                    }
                }
            }
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ç”Ÿæˆç­›é€‰é¡¹
        function generateFilterOptions() {
            const count = appData.config.filterCount;
            const container = elements.filterOptionsContainer;
            
            // æ¸…ç©ºç°æœ‰ç­›é€‰é¡¹
            container.innerHTML = '';
            
            // é‡ç½®additionalFiltersæ•°ç»„
            appData.config.additionalFilters = [];
            
            // ç”Ÿæˆæ–°çš„ç­›é€‰é¡¹
            for (let i = 0; i < count; i++) {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'border border-gray-200 rounded p-3';
                
                filterDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">ç­›é€‰é¡¹ ${i + 1}</label>
                        <button class="clear-single-filter text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300 transition-all-300" data-index="${i}">
                            <i class="fa fa-times mr-1"></i>æ¸…é™¤
                        </button>
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs font-medium mb-1 text-gray-600">åˆ—</label>
                        <select id="filterColumn${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm" aria-label="ç­›é€‰åˆ—" title="é€‰æ‹©ç­›é€‰åˆ—">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1 text-gray-600">å€¼</label>
                        <select id="filterValue${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm" aria-label="ç­›é€‰å€¼" title="é€‰æ‹©ç­›é€‰å€¼">
                            <option value="">-- å…¨éƒ¨ --</option>
                        </select>
                    </div>
                `;
                
                container.appendChild(filterDiv);
                
                // æ·»åŠ åˆ°additionalFiltersæ•°ç»„
                appData.config.additionalFilters.push({
                    column: '',
                    value: ''
                });
                
                // æ·»åŠ åˆ—é€‰æ‹©äº‹ä»¶
                const columnSelect = document.getElementById(`filterColumn${i}`);
                columnSelect.addEventListener('change', (e) => {
                    appData.config.additionalFilters[i].column = e.target.value;
                    populateFilterValueOptions(i, e.target.value);
                    updateDataPreview();
                });
                
                // æ·»åŠ å€¼é€‰æ‹©äº‹ä»¶
                const valueSelect = document.getElementById(`filterValue${i}`);
                valueSelect.addEventListener('change', (e) => {
                    appData.config.additionalFilters[i].value = e.target.value;
                    updateDataPreview();
                });
                
                // å¡«å……åˆ—é€‰æ‹©å™¨
                populateFilterColumnSelect(i);
            }
        }
        function populateFilterColumnSelect(index) {
            const select = document.getElementById(`filterColumn${index}`);
            
            // å¦‚æœæ²¡æœ‰å·¥ä½œè¡¨æ•°æ®ï¼Œåˆ™è¿”å›
            if (appData.worksheets.length === 0) return;
            
            // è·å–ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
            const headerRow = appData.worksheets[0].data[0] || [];
            
            // æ·»åŠ æ–°é€‰é¡¹
            for (let i = 0; i < headerRow.length; i++) {
                // ç”Ÿæˆåˆ—å­—æ¯ï¼Œæ”¯æŒè¶…è¿‡26åˆ—çš„æƒ…å†µï¼ˆå¦‚AA, ABç­‰ï¼‰
                let columnLetter = "";
                let columnNum = i;
                while (columnNum >= 0) {
                    columnLetter = String.fromCharCode(65 + (columnNum % 26)) + columnLetter;
                    columnNum = Math.floor(columnNum / 26) - 1;
                    if (columnNum < 0) break;
                }
                
                const headerText = headerRow[i] ? String(headerRow[i]).substring(0, 20) : `åˆ— ${columnLetter}`;
                
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${columnLetter}: ${headerText}`;
                select.appendChild(option);
            }
        }
        
        function populateFilterValueOptions(index, columnIndex) {
            const valueSelect = document.getElementById(`filterValue${index}`);
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            valueSelect.innerHTML = '<option value="">-- å…¨éƒ¨ --</option>';
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©åˆ—ï¼Œåˆ™è¿”å›
            if (!columnIndex) return;
            
            const col = parseInt(columnIndex);
            
            // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„å€¼
            const valueSet = new Set();
            
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // è·³è¿‡è¡¨å¤´è¡Œ
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[col]) continue;
                    
                    const value = String(row[col]).trim();
                    if (value) {
                        valueSet.add(value);
                    }
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const values = Array.from(valueSet).sort();
            
            // æ·»åŠ åˆ°ä¸‹æ‹‰èœå•
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                valueSelect.appendChild(option);
            });
        }
        
        // æ›´æ–°é™„åŠ ç­›é€‰å™¨é…ç½®
        function updateAdditionalFilters() {
            appData.config.additionalFilters = [];
            
            const filterDivs = elements.filterOptionsContainer.querySelectorAll('.border');
            filterDivs.forEach(div => {
                const columnSelect = div.querySelector('.filter-column');
                const valueInput = div.querySelector('.filter-value');
                
                if (columnSelect.value && valueInput.value.trim()) {
                    appData.config.additionalFilters.push({
                        column: parseInt(columnSelect.value),
                        value: valueInput.value.trim()
                    });
                }
            });
            
            // æ›´æ–°æ•°æ®é¢„è§ˆ
            updateDataPreview();
        }

        // é¢„è§ˆç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹
        function previewFirstHourCalculation() {
            if (appData.parsedData.length === 0) {
                showNotification('è­¦å‘Š', 'æ²¡æœ‰å¯é¢„è§ˆçš„æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥å¹¶é…ç½®æ•°æ®', 'warning');
                return;
            }
            
            // è·å–ç¬¬ä¸€è¡Œè§£æåçš„æ•°æ®
            const firstParsedData = appData.parsedData[0];
            const interval = firstParsedData.timeInterval || appData.config.timeInterval;
            
            // è®¡ç®—æ¯å°æ—¶æ•°æ®ç‚¹æ•°
            let pointsPerHour;
            if (interval === 1) {
                pointsPerHour = 60;
            } else if (interval === 5) {
                pointsPerHour = 12;
            } else if (interval === 15) {
                pointsPerHour = 4;
            } else if (interval === 30) {
                pointsPerHour = 2;
            } else if (interval === 60) {
                pointsPerHour = 1;
            } else {
                pointsPerHour = Math.floor(60 / interval);
            }
            
            // è·å–ç¬¬ä¸€ä¸ªå°æ—¶çš„åŸå§‹æ•°æ®
            const startIdx = 0;
            const endIdx = pointsPerHour;
            const hourData = firstParsedData.rawData.slice(startIdx, endIdx);
            
            // å¤„ç†æ— æ•ˆæ•°æ®
            const fillMethod = appData.config.invalidDataHandling === 'ignore' ? 'ignore' : 'interpolate';
            const cleanedData = DataUtils.cleanData(hourData, { fillMethod });
            
            // è®¡ç®—ç¬¬ä¸€ä¸ªå°æ—¶çš„ç”µèƒ½å€¼
            let hourlyValue;
            let calculationProcess = '';
            let formula = '';
            
            if (appData.config.dataType === 'instantPower') {
                // ç¬æ—¶åŠŸç‡æ•°æ® (kW)
                // ä½¿ç”¨ç»Ÿä¸€çš„è®¡ç®—å‡½æ•°
                hourlyValue = calculateHourlyPower(cleanedData, firstParsedData.multiplier, false);
                
                if (hourlyValue === null) {
                    calculationProcess = 'æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•è®¡ç®—';
                    formula = 'æ— æ•ˆæ•°æ®';
                } else {
                    const validData = cleanedData.filter(v => v !== null);
                    const sum = validData.reduce((a, b) => a + b, 0);
                    const avgPower = sum / validData.length;
                    
                    calculationProcess = `1. è·å–ç¬¬ä¸€ä¸ªå°æ—¶çš„æ‰€æœ‰æ•°æ®ç‚¹ï¼ˆ${interval === 1 ? '60' : pointsPerHour}ä¸ªï¼‰\n` +
                                      `2. è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼Œå‰©ä½™ ${validData.length} ä¸ªæœ‰æ•ˆæ•°æ®ç‚¹\n` +
                                      `3. è®¡ç®—æ•°æ®ç‚¹æ€»å’Œï¼š${sum.toFixed(2)} kW\n` +
                                      `4. è®¡ç®—å¹³å‡åŠŸç‡ï¼š${sum.toFixed(2)} Ã· ${validData.length} = ${avgPower.toFixed(2)} kW\n` +
                                      `5. åº”ç”¨å…¬å¼ï¼šå¹³å‡åŠŸç‡ Ã— 1 Ã— å€ç‡\n` +
                                      `6. è®¡ç®—ç»“æœï¼š${avgPower.toFixed(2)} Ã— 1 Ã— ${firstParsedData.multiplier} = ${hourlyValue.toFixed(2)} kWh`;
                    formula = 'å¹³å‡åŠŸç‡ Ã— 1 Ã— å€ç‡';
                }
            } else {
                // ç´¯ç§¯ç”µèƒ½æ•°æ® (kWh)
                if (interval === 1) {
                    // 1åˆ†é’Ÿé—´éš”ç‰¹æ®Šå¤„ç†
                    if (cleanedData.length < 60) {
                        hourlyValue = null;
                        calculationProcess = 'æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—';
                        formula = 'æ•°æ®ä¸è¶³';
                    } else {
                        // ç¬¬ä¸€ç»„ï¼š1-15åˆ†é’Ÿ
                        const firstQuarter = cleanedData.slice(0, 15).filter(v => v !== null);
                        // ç¬¬äºŒç»„ï¼š46-60åˆ†é’Ÿ
                        const lastQuarter = cleanedData.slice(45, 60).filter(v => v !== null);
                        
                        if (firstQuarter.length === 0 || lastQuarter.length === 0) {
                            hourlyValue = null;
                            calculationProcess = 'æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—';
                            formula = 'æ•°æ®ä¸è¶³';
                        } else {
                            const firstSum = firstQuarter.reduce((a, b) => a + b, 0);
                            const lastSum = lastQuarter.reduce((a, b) => a + b, 0);
                            hourlyValue = lastSum - firstSum;
                            calculationProcess = `1. è·å–ç¬¬ä¸€ä¸ªå°æ—¶çš„æ‰€æœ‰æ•°æ®ç‚¹ï¼ˆ60ä¸ªï¼‰\n` +
                                              `2. åˆ†ä¸ºä¸¤ç»„æ•°æ®ï¼š1-15åˆ†é’Ÿå’Œ46-60åˆ†é’Ÿ\n` +
                                              `3. ç¬¬ä¸€ç»„æ•°æ®ç‚¹æ•°é‡ï¼š${firstQuarter.length}ï¼Œæ€»å’Œï¼š${firstSum.toFixed(2)} kWh\n` +
                                              `4. ç¬¬äºŒç»„æ•°æ®ç‚¹æ•°é‡ï¼š${lastQuarter.length}ï¼Œæ€»å’Œï¼š${lastSum.toFixed(2)} kWh\n` +
                                              `5. åº”ç”¨å…¬å¼ï¼šç¬¬äºŒç»„æ€»å’Œ - ç¬¬ä¸€ç»„æ€»å’Œ\n` +
                                      `6. è®¡ç®—ç»“æœï¼š${lastSum.toFixed(2)} - ${firstSum.toFixed(2)} = ${hourlyValue.toFixed(2)} kWh`;
                            formula = 'ç¬¬äºŒç»„æ€»å’Œ - ç¬¬ä¸€ç»„æ€»å’Œ';
                        }
                    }
                } else {
                    // å…¶ä»–é—´éš”
                    if (cleanedData.length < 2) {
                        hourlyValue = null;
                        calculationProcess = 'æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—';
                        formula = 'æ•°æ®ä¸è¶³';
                    } else {
                        const startValue = cleanedData[0];
                        const endValue = cleanedData[cleanedData.length - 1];
                        
                        if (startValue === null || endValue === null) {
                            hourlyValue = null;
                            calculationProcess = 'èµ·å§‹æˆ–ç»“æŸå€¼æ— æ•ˆï¼Œæ— æ³•è®¡ç®—';
                            formula = 'èµ·å§‹æˆ–ç»“æŸå€¼æ— æ•ˆ';
                        } else if (endValue < startValue) {
                            hourlyValue = null;
                            calculationProcess = 'ç´¯ç§¯å€¼å¼‚å¸¸ï¼ˆç»“æŸå€¼å°äºèµ·å§‹å€¼ï¼‰ï¼Œæ— æ³•è®¡ç®—';
                            formula = 'ç´¯ç§¯å€¼å¼‚å¸¸';
                        } else {
                            hourlyValue = endValue - startValue;
                            calculationProcess = `1. è·å–ç¬¬ä¸€ä¸ªå°æ—¶çš„æ‰€æœ‰æ•°æ®ç‚¹ï¼ˆ${pointsPerHour}ä¸ªï¼‰\n` +
                                              `2. èµ·å§‹å€¼ï¼š${startValue.toFixed(2)} kWh\n` +
                                              `3. ç»“æŸå€¼ï¼š${endValue.toFixed(2)} kWh\n` +
                                              `4. åº”ç”¨å…¬å¼ï¼šç»“æŸå€¼ - èµ·å§‹å€¼\n` +
                                              `5. è®¡ç®—ç»“æœï¼š${endValue.toFixed(2)} - ${startValue.toFixed(2)} = ${hourlyValue.toFixed(2)} kWh`;
                            formula = 'ç»“æŸå€¼ - èµ·å§‹å€¼';
                        }
                    }
                }
            }
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            if (elements.previewDate && elements.previewDate.parentNode) {
                elements.previewDate.textContent = firstParsedData.dateStr;
            }
            if (elements.previewInterval && elements.previewInterval.parentNode) {
                elements.previewInterval.textContent = `${interval} åˆ†é’Ÿ`;
            }
            if (elements.previewDataType && elements.previewDataType.parentNode) {
                elements.previewDataType.textContent = appData.config.dataType === 'instantPower' ? 'ç¬æ—¶åŠŸç‡' : 'ç´¯ç§¯ç”µèƒ½';
            }
            if (elements.previewMultiplier && elements.previewMultiplier.parentNode) {
                elements.previewMultiplier.textContent = firstParsedData.multiplier;
            }
            
            // æ˜¾ç¤ºåŸå§‹æ•°æ®
            const rawDataText = hourData.map((val, idx) => {
                return `æ•°æ®ç‚¹ ${idx + 1}: ${val !== null ? val.toFixed(2) : 'æ— æ•ˆæ•°æ®'}`;
            }).join('\n');
            if (elements.previewRawData && elements.previewRawData.parentNode) {
                elements.previewRawData.textContent = rawDataText;
            }
            
            // æ˜¾ç¤ºæ¸…æ´—åæ•°æ®
            const cleanedDataText = cleanedData.map((val, idx) => {
                return `æ•°æ®ç‚¹ ${idx + 1}: ${val !== null ? val.toFixed(2) : 'æ— æ•ˆæ•°æ®'}`;
            }).join('\n');
            if (elements.previewCleanedData && elements.previewCleanedData.parentNode) {
                elements.previewCleanedData.textContent = cleanedDataText;
            }
            
            // æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹
            elements.previewCalculationProcess.innerHTML = calculationProcess.replace(/\n/g, '<br>');
            
            // æ˜¾ç¤ºè®¡ç®—ç»“æœ
            if (elements.previewResult && elements.previewResult.parentNode) {
                elements.previewResult.textContent = hourlyValue !== null ? `${hourlyValue.toFixed(2)} kWh` : 'æ— æ³•è®¡ç®—';
            }
            if (elements.previewFormula && elements.previewFormula.parentNode) {
                elements.previewFormula.textContent = formula;
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            if (elements.firstHourCalculationModal && elements.firstHourCalculationModal.parentNode) {
                elements.firstHourCalculationModal.classList.remove('hidden');
            }
            setTimeout(() => {
                if (elements.firstHourCalculationModal && elements.firstHourCalculationModal.parentNode) {
                    const modalContent = elements.firstHourCalculationModal.querySelector('.bg-white');
                    if (modalContent) {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }
                }
            }, 10);
        }
        
        // å…³é—­ç¬¬ä¸€ä¸ªå°æ—¶è®¡ç®—è¿‡ç¨‹é¢„è§ˆæ¨¡æ€æ¡†
        function closeFirstHourCalculationModal() {
            if (elements.firstHourCalculationModal && elements.firstHourCalculationModal.parentNode) {
                const modalContent = elements.firstHourCalculationModal.querySelector('.bg-white');
                if (modalContent) {
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                
                setTimeout(() => {
                    elements.firstHourCalculationModal.classList.add('hidden');
                }, 300);
            }
        }
        
        // é¢„è§ˆç¬¬ä¸€å¤©çš„è®¡ç®—è¿‡ç¨‹
        function previewFirstDayCalculation() {
            if (!appData.processedData || appData.processedData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰å¯ç”¨çš„æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥å¹¶å¤„ç†æ•°æ®', 'error');
                return;
            }
            
            // è·å–ç¬¬ä¸€å¤©çš„æ•°æ® - å¯¹äºåˆ—å¯¹åˆ—ç»“æ„ï¼Œåªå–ç¬¬ä¸€ä¸ªå…ƒç´ 
            let firstDayData;
            if (appData.processedData[0].dataStructure === 'columnToColumn') {
                // åˆ—å¯¹åˆ—ç»“æ„ï¼šæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªå®Œæ•´æ—¥æœŸçš„æ•°æ®ï¼Œåªå–ç¬¬ä¸€ä¸ª
                firstDayData = [appData.processedData[0]];
            } else {
                // åˆ—å¯¹è¡Œç»“æ„ï¼šæŒ‰æ—¥æœŸç­›é€‰
                const firstDate = appData.processedData[0].dateObj || parseDate(appData.processedData[0].date);
                firstDayData = appData.processedData.filter(item => {
                    const itemDate = item.dateObj || parseDate(item.date);
                    return itemDate && firstDate && itemDate.toDateString() === firstDate.toDateString();
                });
            }
            
            if (firstDayData.length === 0) {
                showNotification('é”™è¯¯', 'æ²¡æœ‰æ‰¾åˆ°ç¬¬ä¸€å¤©çš„æ•°æ®', 'error');
                return;
            }
            
            // è·å–é…ç½®ä¿¡æ¯
            const interval = appData.config.timeInterval;
            const dataType = appData.config.dataType;
            const multiplier = appData.config.multiplier;
            
            // è®¡ç®—ç¬¬ä¸€å¤©çš„æ€»æ•°æ®ç‚¹
            const totalPoints = firstDayData.reduce((sum, item) => {
                return sum + (item.hourlyData ? item.hourlyData.filter(v => v !== null).length : 0);
            }, 0);
            
            // è®¡ç®—ç¬¬ä¸€å¤©çš„æ€»ç”¨ç”µé‡
            let dailyValue = null;
            let calculationProcess = '';
            let formula = '';
            
            if (dataType === 'instantPower') {
                // ç¬æ—¶åŠŸç‡æ•°æ®
                const hourlyValues = []; // å­˜å‚¨æ¯ä¸ªå°æ—¶çš„ç”¨ç”µé‡
                const hourlyDataCounts = new Array(24).fill(0); // è®°å½•æ¯ä¸ªå°æ—¶çš„æ•°æ®ç‚¹æ•°é‡
                
                // æ”¶é›†ç¬¬ä¸€å¤©çš„24å°æ—¶æœ‰æ•ˆæ•°æ®
                if (firstDayData[0].hourlyData && firstDayData[0].hourlyData.length > 0) {
                    firstDayData[0].hourlyData.forEach((value, hourIndex) => {
                        if (value !== null && !isNaN(value)) {
                            hourlyValues[hourIndex] = value;
                            if (hourIndex < 24) {
                                hourlyDataCounts[hourIndex]++;
                            }
                        }
                    });
                }
                
                // è¿‡æ»¤æ‰æ— æ•ˆçš„å°æ—¶å€¼
                const validHourlyValues = hourlyValues.filter(v => v !== null && !isNaN(v));
                
                if (validHourlyValues.length === 0) {
                    dailyValue = null;
                    calculationProcess = 'æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—';
                    formula = 'æ•°æ®ä¸è¶³';
                } else {
                    // è®¡ç®—ç¬¬ä¸€å¤©çš„æ€»ç”¨ç”µé‡ï¼ˆ24å°æ—¶ç”¨ç”µé‡ä¾æ¬¡ç´¯åŠ ï¼‰
                    dailyValue = validHourlyValues.reduce((a, b) => a + b, 0);
                    
                    // ç»Ÿè®¡æœ‰æ•°æ®çš„å°æ—¶æ•°
                    const hoursWithData = hourlyDataCounts.filter(count => count > 0).length;
                    
                    const formattedValues = validHourlyValues.map(v => parseFloat(v).toFixed(2));
                    const sumExpression = formattedValues.join(' + ');
                    
                    calculationProcess = `1. è·å–ç¬¬ä¸€å¤©çš„æ‰€æœ‰24å°æ—¶æ•°æ®\n` +
                                      `2. è¿‡æ»¤æ— æ•ˆæ•°æ®åå‰©ä½™æœ‰æ•ˆå°æ—¶æ•°ï¼š${hoursWithData}/24å°æ—¶\n` +
                                      `3. å„å°æ—¶ç”¨ç”µé‡ï¼š${formattedValues.join(', ')} kWh\n` +
                                      `4. è®¡ç®—ä¸€å¤©ç”¨ç”µæ€»é‡ï¼š${sumExpression} = ${dailyValue.toFixed(2)} kWh`;
                    formula = '1å°æ—¶ç”¨ç”µ + 2å°æ—¶ç”¨ç”µ + â€¦ + 24å°æ—¶ç”¨ç”µ';
                }
            } else {
                // ç´¯ç§¯ç”µèƒ½æ•°æ®
                if (firstDayData.length === 0) {
                    dailyValue = null;
                    calculationProcess = 'æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—';
                    formula = 'æ•°æ®ä¸è¶³';
                } else {
                    // æ”¶é›†æ‰€æœ‰24å°æ—¶çš„æœ‰æ•ˆæ•°æ®
                    const hourlyValues = []; // å­˜å‚¨æ¯ä¸ªå°æ—¶çš„ç”¨ç”µé‡
                    const hourlyDataCounts = new Array(24).fill(0); // è®°å½•æ¯ä¸ªå°æ—¶çš„æ•°æ®ç‚¹æ•°é‡
                    
                    firstDayData.forEach(dayData => {
                        if (dayData.hourlyData && dayData.hourlyData.length > 0) {
                            dayData.hourlyData.forEach((value, hourIndex) => {
                                if (value !== null && !isNaN(value)) {
                                    hourlyValues[hourIndex] = value;
                                    if (hourIndex < 24) {
                                        hourlyDataCounts[hourIndex]++;
                                    }
                                }
                            });
                        }
                    });
                    
                    // è¿‡æ»¤æ‰æ— æ•ˆçš„å°æ—¶å€¼
                    const validHourlyValues = hourlyValues.filter(v => v !== null && !isNaN(v));
                    
                    if (validHourlyValues.length === 0) {
                        dailyValue = null;
                        calculationProcess = 'æ²¡æœ‰æœ‰æ•ˆçš„å°æ—¶æ•°æ®ï¼Œæ— æ³•è®¡ç®—';
                        formula = 'æ²¡æœ‰æœ‰æ•ˆçš„å°æ—¶æ•°æ®';
                    } else {
                        // è®¡ç®—ç¬¬ä¸€å¤©çš„æ€»ç”¨ç”µé‡ï¼ˆ24å°æ—¶ç”¨ç”µé‡ä¾æ¬¡ç´¯åŠ ï¼‰
                        dailyValue = validHourlyValues.reduce((a, b) => a + b, 0);
                        
                        // ç»Ÿè®¡æœ‰æ•°æ®çš„å°æ—¶æ•°
                        const hoursWithData = hourlyDataCounts.filter(count => count > 0).length;
                        
                        const formattedValues = validHourlyValues.map(v => parseFloat(v).toFixed(2));
                    const sumExpression = formattedValues.join(' + ');
                    
                    calculationProcess = `1. è·å–ç¬¬ä¸€å¤©çš„æ‰€æœ‰24å°æ—¶æ•°æ®\n` +
                                        `2. è¿‡æ»¤æ— æ•ˆæ•°æ®åå‰©ä½™æœ‰æ•ˆå°æ—¶æ•°ï¼š${hoursWithData}/24å°æ—¶\n` +
                                        `3. å„å°æ—¶ç”¨ç”µé‡ï¼š${formattedValues.join(', ')} kWh\n` +
                                        `4. è®¡ç®—ä¸€å¤©ç”¨ç”µæ€»é‡ï¼š${sumExpression} = ${dailyValue.toFixed(2)} kWh`;
                        formula = '1å°æ—¶ç”¨ç”µ + 2å°æ—¶ç”¨ç”µ + â€¦ + 24å°æ—¶ç”¨ç”µ';
                    }
                }
            }
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            if (elements.previewFirstDayDate && elements.previewFirstDayDate.parentNode) {
                elements.previewFirstDayDate.textContent = firstDayData[0] && firstDayData[0].date ? firstDayData[0].date.split(' ')[0] : 'æœªçŸ¥æ—¥æœŸ';
            }
            if (elements.previewFirstDayInterval && elements.previewFirstDayInterval.parentNode) {
                elements.previewFirstDayInterval.textContent = `${interval} åˆ†é’Ÿ`;
            }
            if (elements.previewFirstDayDataType && elements.previewFirstDayDataType.parentNode) {
                elements.previewFirstDayDataType.textContent = dataType === 'instantPower' ? 'ç¬æ—¶åŠŸç‡' : 'ç´¯ç§¯ç”µèƒ½';
            }
            if (elements.previewFirstDayMultiplier && elements.previewFirstDayMultiplier.parentNode) {
                elements.previewFirstDayMultiplier.textContent = multiplier;
            }
            
            // æ˜¾ç¤ºåŸå§‹æ•°æ®
            const rawDataText = firstDayData[0].hourlyData ? 
                `ç¬¬1å¤©å°æ—¶æ•°æ®: [${firstDayData[0].hourlyData.map((val, idx) => 
                    val !== null ? val.toFixed(2) : 'æ— æ•ˆæ•°æ®').join(', ')}]` : 
                `ç¬¬1å¤©å°æ—¶æ•°æ®: æ— æ•°æ®`;
            if (elements.previewFirstDayRawData && elements.previewFirstDayRawData.parentNode) {
                elements.previewFirstDayRawData.textContent = rawDataText;
            }
            
            // æ˜¾ç¤ºæ¸…æ´—åæ•°æ®
            let cleanedDataText;
            if (!firstDayData[0].hourlyData) {
                cleanedDataText = `ç¬¬1å¤©å°æ—¶æ•°æ®: æ— æ•°æ®`;
            } else {
                const validData = firstDayData[0].hourlyData.filter(val => val !== null && !isNaN(val));
                cleanedDataText = `ç¬¬1å¤©å°æ—¶æ•°æ®: [${validData.map(val => val.toFixed(2)).join(', ')}]`;
            }
            if (elements.previewFirstDayCleanedData && elements.previewFirstDayCleanedData.parentNode) {
                elements.previewFirstDayCleanedData.textContent = cleanedDataText;
            }
            
            // æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹
            if (elements.previewFirstDayCalculationProcess && elements.previewFirstDayCalculationProcess.parentNode) {
                elements.previewFirstDayCalculationProcess.innerHTML = calculationProcess.replace(/\n/g, '<br>');
            }
            
            // æ˜¾ç¤ºè®¡ç®—ç»“æœ
            if (elements.previewFirstDayResult && elements.previewFirstDayResult.parentNode) {
                elements.previewFirstDayResult.textContent = dailyValue !== null ? `${dailyValue.toFixed(2)} kWh` : 'æ— æ³•è®¡ç®—';
            }
            if (elements.previewFirstDayFormula && elements.previewFirstDayFormula.parentNode) {
                elements.previewFirstDayFormula.textContent = formula;
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            if (elements.firstDayCalculationModal && elements.firstDayCalculationModal.parentNode) {
                elements.firstDayCalculationModal.classList.remove('hidden');
            }
            setTimeout(() => {
                if (elements.firstDayCalculationModal && elements.firstDayCalculationModal.parentNode) {
                    const modalContent = elements.firstDayCalculationModal.querySelector('.bg-white');
                    if (modalContent) {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }
                }
            }, 10);
        }
        
        // å…³é—­ç¬¬ä¸€å¤©è®¡ç®—è¿‡ç¨‹é¢„è§ˆæ¨¡æ€æ¡†
        function closeFirstDayCalculationModal() {
            if (elements.firstDayCalculationModal && elements.firstDayCalculationModal.parentNode) {
                const modalContent = elements.firstDayCalculationModal.querySelector('.bg-white');
                if (modalContent) {
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                
                setTimeout(() => {
                    elements.firstDayCalculationModal.classList.add('hidden');
                }, 300);
            }
        }
        // æ·»åŠ ä¿å­˜å’ŒåŠ è½½å†å²è®°å½•çš„å‡½æ•°
        function saveImportHistory() {
            try {
                localStorage.setItem('loadDataAnalyzerImportHistory', JSON.stringify(appData.importHistory));
            } catch (error) {
                console.error('ä¿å­˜å¯¼å…¥å†å²å¤±è´¥:', error);
            }
        }

        function loadImportHistory() {
            try {
                const savedHistory = localStorage.getItem('loadDataAnalyzerImportHistory');
                if (savedHistory) {
                    appData.importHistory = JSON.parse(savedHistory);
                    renderImportHistory();
                }
            } catch (error) {
                console.error('åŠ è½½å¯¼å…¥å†å²å¤±è´¥:', error);
                appData.importHistory = [];
            }
        }

        // æ·»åŠ æ¸…ç©ºå†å²è®°å½•å‡½æ•°
        function clearImportHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¼å…¥å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                appData.importHistory = [];
                saveImportHistory();
                renderImportHistory();
                showNotification('æˆåŠŸ', 'å¯¼å…¥å†å²è®°å½•å·²æ¸…ç©º', 'success');
            }
        }

        // æ·»åŠ æ¸²æŸ“å†å²è®°å½•å‡½æ•°
        function updateDataStats() {
            const totalFiles = appData.files.length;
            const totalRecords = appData.worksheets.reduce((sum, ws) => sum + (ws.data.length - 1), 0);
            
            const totalFilesElement = document.getElementById('totalFiles');
            const totalRecordsElement = document.getElementById('totalRecords');
            if (totalFilesElement && totalFilesElement.parentNode) {
                totalFilesElement.textContent = totalFiles;
            }
            if (totalRecordsElement && totalRecordsElement.parentNode) {
                totalRecordsElement.textContent = totalRecords;
            }
            
            // æ›´æ–°æ•°æ®æ¦‚è§ˆç»Ÿè®¡ä¿¡æ¯
            updateDataOverview();
            
            // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
            renderFileList();
        }
        
        // æ›´æ–°æ•°æ®æ¦‚è§ˆdivä¸­çš„ç»Ÿè®¡ä¿¡æ¯
        function updateDataOverview() {
            const fileCountElement = document.getElementById('fileCount');
            const timeRangeElement = document.getElementById('timeRange');
            const meteringPointsElement = document.getElementById('meteringPoints');
            
            // æ›´æ–°æ–‡ä»¶æ•°é‡
            if (fileCountElement && fileCountElement.parentNode) {
                fileCountElement.textContent = appData.files.length;
            }
            
            // æ›´æ–°æ—¶é—´èŒƒå›´
            if (timeRangeElement && timeRangeElement.parentNode) {
                if (appData.processedData.length > 0) {
                    const dates = appData.processedData.map(d => d.date).sort();
                    const startDate = dates[0];
                    const endDate = dates[dates.length - 1];
                    if (startDate === endDate) {
                        timeRangeElement.textContent = startDate;
                    } else {
                        timeRangeElement.textContent = `${startDate} è‡³ ${endDate}`;
                    }
                } else {
                    timeRangeElement.textContent = '-';
                }
            }
            
            // æ›´æ–°è®¡é‡ç‚¹æ•°é‡
            if (meteringPointsElement && meteringPointsElement.parentNode) {
                const uniqueMeteringPoints = new Set(appData.processedData.map(d => d.meteringPoint || 'é»˜è®¤è®¡é‡ç‚¹'));
                meteringPointsElement.textContent = uniqueMeteringPoints.size;
            }
        }
        
        function renderFileList() {
            const fileListElement = document.getElementById('fileListContent');
            if (!fileListElement) return;
            
            fileListElement.innerHTML = '';
            
            if (appData.files.length === 0) {
                fileListElement.innerHTML = '<div class="text-center py-4 text-gray-500">æš‚æ— å¯¼å…¥çš„æ–‡ä»¶</div>';
                return;
            }
            
            appData.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2';
                
                const worksheet = appData.worksheets.find(ws => ws.file === file);
                const recordCount = worksheet ? worksheet.data.length - 1 : 0;
                
                fileItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${file.name}</div>
                            <div class="text-xs text-gray-500">${recordCount} æ¡è®°å½•</div>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        åˆ é™¤
                    </button>
                `;
                
                fileListElement.appendChild(fileItem);
            });
        }
        
        function updateUploadProgress(processed, total) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // ç¡®ä¿è¿›åº¦ä¸è¶…è¿‡100%
            const actualProcessed = Math.min(processed, total);
            const percentage = Math.round((actualProcessed / total) * 100);
            
            if (progressBar && progressBar.parentNode) {
                progressBar.style.width = `${percentage}%`;
            }
            if (progressText && progressText.parentNode) {
                progressText.textContent = `${percentage}% (${actualProcessed}/${total})`;
            }
            
            if (processed >= total) {
                setTimeout(() => {
                    if (elements.uploadProgress && elements.uploadProgress.parentNode) {
                        elements.uploadProgress.classList.add('hidden');
                    }
                }, 1000);
            }
        }
        
        function renderImportHistory() {
            const historyList = document.getElementById('historyList');
            
            if (!historyList) return;
            
            historyList.innerHTML = '';
            
            if (appData.importHistory.length === 0) {
                historyList.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">æš‚æ— å¯¼å…¥å†å²è®°å½•</div>';
                // å¯¼å…¥å†å²ç°åœ¨å›ºå®šå±•å¼€ï¼Œæ— éœ€éšè—
                return;
            }
            
            // å¯¼å…¥å†å²å›ºå®šå±•å¼€ï¼Œç›´æ¥æ˜¾ç¤ºè®°å½•
            
            const sortedHistory = [...appData.importHistory].sort((a, b) => new Date(b.importTime) - new Date(a.importTime));
            const displayHistory = sortedHistory.slice(0, 2); // åªæ˜¾ç¤ºæœ€è¿‘çš„ä¸¤æ¡è®°å½•
            
            displayHistory.forEach((record, index) => {
                const date = new Date(record.importTime);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2';
                
                const statusClass = record.status === 'success' ? 'text-green-600' : 'text-red-600';
                const statusIcon = record.status === 'success' ? 'âœ“' : 'âœ—';
                
                historyItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-xs font-bold ${statusClass}">${statusIcon}</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${record.fileName}</div>
                            <div class="text-xs text-gray-500">${formattedDate}</div>
                            ${record.status === 'success' ? 
                                `<div class="text-xs text-green-600">${record.recordCount} æ¡è®°å½•</div>` : 
                                `<div class="text-xs text-red-600">${record.errorMessage}</div>`
                            }
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        // æ·»åŠ é‡æ–°å¯¼å…¥å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤å‡½æ•°
        function reimportAndGoToConfig(index) {
            const record = appData.importHistory[index];
            if (!record || record.status !== 'success') {
                showNotification('é”™è¯¯', 'æ— æ³•é‡æ–°å¯¼å…¥æ­¤è®°å½•', 'error');
                return;
            }
            
            // æ¸…ç©ºå½“å‰æ•°æ®
            removeAllFiles();
            
            // å°è¯•ä½¿ç”¨å†å²è®°å½•ä¸­çš„æ–‡ä»¶è·¯å¾„é‡æ–°å¯¼å…¥
            if (record.filePath) {
                // ä½¿ç”¨fetch APIè·å–æ–‡ä»¶
                fetch(record.filePath)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('æ— æ³•è®¿é—®æ–‡ä»¶ï¼š' + record.filePath);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // åˆ›å»ºFileå¯¹è±¡
                        const file = new File([blob], record.fileName, { type: blob.type });
                        
                        // å¤„ç†æ–‡ä»¶
                        processFiles([file]);
                        
                        // ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆååº”ç”¨å†å²é…ç½®å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤
                        setTimeout(() => {
                            if (appData.worksheets.length > 0 && record.config) {
                                // åº”ç”¨å†å²é…ç½®
                                appData.config.dataType = record.config.dataType;
                                appData.config.multiplier = record.config.multiplier;
                                appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                                appData.config.multiplierColumn = record.config.multiplierColumn || '';
                                appData.config.dateColumn = record.config.dateColumn;
                                appData.config.dataStartColumn = record.config.dataStartColumn;
                                appData.config.dataEndColumn = record.config.dataEndColumn;
                                appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                                appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                                appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                                appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                                appData.config.timeInterval = record.config.timeInterval || 15;
                                
                                // æ›´æ–°UI
                                document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                                elements.multiplierInput.value = record.config.multiplier;
                                elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                                elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                                elements.dateColumnSelect.value = record.config.dateColumn;
                                elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                                elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                                elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                                elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';

                                elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                                elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                                
                                // æ›´æ–°å€ç‡é€‰é¡¹æ˜¾ç¤º
                                if (record.config.useMultiplierColumn) {
                                    elements.multiplierOptions.classList.add('hidden');
                                    elements.multiplierColumnOption.classList.remove('hidden');
                                } else {
                                    elements.multiplierOptions.classList.remove('hidden');
                                    elements.multiplierColumnOption.classList.add('hidden');
                                }
                                
                                // æ›´æ–°æ•°æ®é¢„è§ˆ
                                updateDataPreview();
                                
                                // è·³è½¬åˆ°é…ç½®æ­¥éª¤
                                goToConfigSection();
                                
                                showNotification('æˆåŠŸ', 'å·²ç›´æ¥ä»åŸå§‹ä½ç½®é‡æ–°å¯¼å…¥æ–‡ä»¶å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤', 'success');
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error('ç›´æ¥è®¿é—®æ–‡ä»¶å¤±è´¥:', error);
                        showNotification('è­¦å‘Š', 'æ— æ³•ç›´æ¥è®¿é—®åŸå§‹æ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶', 'warning');
                        
                        // å¦‚æœæ— æ³•ç›´æ¥è®¿é—®æ–‡ä»¶ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.xlsx,.xls,.csv';
                        fileInput.multiple = false;
                        
                        fileInput.onchange = function(e) {
                            const files = Array.from(e.target.files);
                            if (files.length === 0) return;
                            
                            const file = files[0];
                            
                            // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ¹é…
                            if (file.name !== record.fileName) {
                                if (!confirm(`é€‰æ‹©çš„æ–‡ä»¶ "${file.name}" ä¸å†å²è®°å½•ä¸­çš„æ–‡ä»¶ "${record.fileName}" ä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                                    return;
                                }
                            }
                            
                            // æ¸…ç©ºå½“å‰æ•°æ®
                            removeAllFiles();
                            
                            // å¤„ç†æ–‡ä»¶
                            processFiles([file]);
                            
                            // ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆååº”ç”¨å†å²é…ç½®å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤
                            setTimeout(() => {
                                if (appData.worksheets.length > 0 && record.config) {
                                    // åº”ç”¨å†å²é…ç½®
                                    appData.config.dataType = record.config.dataType;
                                    appData.config.multiplier = record.config.multiplier;
                                    appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                                    appData.config.multiplierColumn = record.config.multiplierColumn || '';
                                    appData.config.dateColumn = record.config.dateColumn;
                                    appData.config.dataStartColumn = record.config.dataStartColumn;
                                    appData.config.dataEndColumn = record.config.dataEndColumn;
                                    appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                                    appData.config.meteringPointFilter = record.config.meteringPointFilter || '';

                                    appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                                    appData.config.timeInterval = record.config.timeInterval || 15;
                                    
                                    // æ›´æ–°UI
                                    document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                                    elements.multiplierInput.value = record.config.multiplier;
                                    elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                                    elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                                    elements.dateColumnSelect.value = record.config.dateColumn;
                                    elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                                    elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                                    elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                                    elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
    
                                    elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                                    elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                                    
                                    // æ›´æ–°å€ç‡é€‰é¡¹æ˜¾ç¤º
                                    if (record.config.useMultiplierColumn) {
                                        elements.multiplierOptions.classList.add('hidden');
                                        elements.multiplierColumnOption.classList.remove('hidden');
                                    } else {
                                        elements.multiplierOptions.classList.remove('hidden');
                                        elements.multiplierColumnOption.classList.add('hidden');
                                    }
                                    
                                    // æ›´æ–°æ•°æ®é¢„è§ˆ
                                    updateDataPreview();
                                    
                                    // è·³è½¬åˆ°é…ç½®æ­¥éª¤
                                    goToConfigSection();
                                    
                                    showNotification('æˆåŠŸ', 'å·²é‡æ–°å¯¼å…¥æ–‡ä»¶å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤', 'success');
                                }
                            }, 500);
                        };
                        
                        // è§¦å‘æ–‡ä»¶é€‰æ‹©
                        fileInput.click();
                    });
            } else {
                // å¦‚æœæ²¡æœ‰æ–‡ä»¶è·¯å¾„ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
                showNotification('æç¤º', 'å†å²è®°å½•ä¸­æ²¡æœ‰æ–‡ä»¶è·¯å¾„ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶', 'warning');
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.multiple = false;
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    const file = files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ¹é…
                    if (file.name !== record.fileName) {
                        if (!confirm(`é€‰æ‹©çš„æ–‡ä»¶ "${file.name}" ä¸å†å²è®°å½•ä¸­çš„æ–‡ä»¶ "${record.fileName}" ä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                            return;
                        }
                    }
                    
                    // æ¸…ç©ºå½“å‰æ•°æ®
                    removeAllFiles();
                    
                    // å¤„ç†æ–‡ä»¶
                    processFiles([file]);
                    
                    // ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆååº”ç”¨å†å²é…ç½®å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤
                    setTimeout(() => {
                        if (appData.worksheets.length > 0 && record.config) {
                            // åº”ç”¨å†å²é…ç½®
                            appData.config.dataType = record.config.dataType;
                            appData.config.multiplier = record.config.multiplier;
                            appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                            appData.config.multiplierColumn = record.config.multiplierColumn || '';
                            appData.config.dateColumn = record.config.dateColumn;
                            appData.config.dataStartColumn = record.config.dataStartColumn;
                            appData.config.dataEndColumn = record.config.dataEndColumn;
                            appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                            appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                            appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                            appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                            appData.config.timeInterval = record.config.timeInterval || 15;
                            
                            // æ›´æ–°UI
                            document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                            elements.multiplierInput.value = record.config.multiplier;
                            elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                            elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                            elements.dateColumnSelect.value = record.config.dateColumn;
                            elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                            elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                            elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                            elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                            
                            elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                            elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                            
                            // æ›´æ–°å€ç‡é€‰é¡¹æ˜¾ç¤º
                            if (record.config.useMultiplierColumn) {
                                elements.multiplierOptions.classList.add('hidden');
                                elements.multiplierColumnOption.classList.remove('hidden');
                            } else {
                                elements.multiplierOptions.classList.remove('hidden');
                                elements.multiplierColumnOption.classList.add('hidden');
                            }
                            
                            // æ›´æ–°æ•°æ®é¢„è§ˆ
                            updateDataPreview();
                            
                            // è·³è½¬åˆ°é…ç½®æ­¥éª¤
                            goToConfigSection();
                            
                            showNotification('æˆåŠŸ', 'å·²é‡æ–°å¯¼å…¥æ–‡ä»¶å¹¶è·³è½¬åˆ°é…ç½®æ­¥éª¤', 'success');
                        }
                    }, 500);
                };
                
                // è§¦å‘æ–‡ä»¶é€‰æ‹©
                fileInput.click();
            }
        }

        // æ·»åŠ æ˜¾ç¤ºå†å²è®°å½•è¯¦æƒ…å‡½æ•°
        function showHistoryDetail(index) {
            const record = appData.importHistory[index];
            if (!record) return;
            
            const date = new Date(record.importTime);
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
            
            let detailHtml = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-neutral">æ–‡ä»¶åï¼š</span>
                                <span class="font-medium">${record.fileName}</span>
                            </div>
                            <div>
                                <span class="text-neutral">å¯¼å…¥æ—¶é—´ï¼š</span>
                                <span class="font-medium">${formattedDate}</span>
                            </div>
                            <div>
                                <span class="text-neutral">æ–‡ä»¶å¤§å°ï¼š</span>
                                <span class="font-medium">${(record.fileSize / (1024 * 1024)).toFixed(2)} MB</span>
                            </div>
                            <div>
                                <span class="text-neutral">çŠ¶æ€ï¼š</span>
                                <span class="font-medium ${record.status === 'success' ? 'text-success' : 'text-danger'}">
                                    ${record.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">æ•°æ®å¤„ç†ç»“æœ</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-neutral">æ€»è®°å½•æ•°ï¼š</span>
                                <span class="font-medium">${record.recordCount}</span>
                            </div>
                            <div>
                                <span class="text-neutral">æœ‰æ•ˆè®°å½•æ•°ï¼š</span>
                                <span class="font-medium">${record.validRecordCount || 0}</span>
                            </div>
                            <div>
                                <span class="text-neutral">æ— æ•ˆè®°å½•æ•°ï¼š</span>
                                <span class="font-medium">${record.invalidRecordCount || 0}</span>
                            </div>
                            <div>
                                <span class="text-neutral">æ—¶é—´é—´éš”ï¼š</span>
                                <span class="font-medium">${record.timeInterval || 'æœªçŸ¥'} åˆ†é’Ÿ</span>
                            </div>
                        </div>
                    </div>
            `;
            
            if (record.status === 'failure' && record.errorMessage) {
                detailHtml += `
                    <div>
                        <h4 class="font-medium mb-2">é”™è¯¯ä¿¡æ¯</h4>
                        <div class="bg-danger/5 border border-danger/20 rounded p-3 text-sm">
                            <p class="text-danger">${record.errorMessage}</p>
                        </div>
                    </div>
                `;
            }
            
            if (record.config) {
                detailHtml += `
                    <div>
                        <h4 class="font-medium mb-2">ä½¿ç”¨çš„é…ç½®</h4>
                        <div class="bg-gray-50 rounded p-3 text-sm">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <span class="text-neutral">æ•°æ®ç±»å‹ï¼š</span>
                                    <span class="font-medium">${record.config.dataType === 'instantPower' ? 'ç¬æ—¶åŠŸç‡' : 'ç´¯ç§¯ç”µèƒ½'}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">å€ç‡ï¼š</span>
                                    <span class="font-medium">${record.config.multiplier}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">æ—¥æœŸåˆ—ï¼š</span>
                                    <span class="font-medium">${record.config.dateColumn !== '' ? record.config.dateColumn : 'æœªè®¾ç½®'}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">æ•°æ®åˆ—èŒƒå›´ï¼š</span>
                                    <span class="font-medium">${record.config.dataStartColumn !== '' && record.config.dataEndColumn !== '' ? 
                                        `${record.config.dataStartColumn} - ${record.config.dataEndColumn}` : 'æœªè®¾ç½®'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // æ·»åŠ é‡æ–°å¯¼å…¥æŒ‰é’®
    if (record.status === 'success') {
        detailHtml += `
            <div class="flex justify-end pt-2 border-t border-gray-200">
                <button id="reimportBtn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 transition-all-300" data-index="${index}">
                    <i class="fa fa-refresh mr-1"></i> é‡æ–°å¯¼å…¥
                </button>
            </div>
        `;
    }
    
    detailHtml += '</div>';
    elements.historyDetailContent.innerHTML = detailHtml;
    
    // æ·»åŠ é‡æ–°å¯¼å…¥æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
    const reimportBtn = document.getElementById('reimportBtn');
    if (reimportBtn) {
        reimportBtn.addEventListener('click', function() {
            const recordIndex = parseInt(this.dataset.index);
            reimportFromHistory(recordIndex);
            closeHistoryDetailModal();
        });
    }
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    if (elements.historyDetailModal && elements.historyDetailModal.parentNode) {
        elements.historyDetailModal.classList.remove('hidden');
    }
    setTimeout(() => {
        if (elements.historyDetailModal && elements.historyDetailModal.parentNode) {
            const modalContent = elements.historyDetailModal.querySelector('.bg-white');
            if (modalContent) {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }
        }
    }, 10);
        }
        
        // æ·»åŠ å…³é—­å†å²è®°å½•è¯¦æƒ…æ¨¡æ€æ¡†å‡½æ•°
function closeHistoryDetailModal() {
    if (elements.historyDetailModal && elements.historyDetailModal.parentNode) {
        const modalContent = elements.historyDetailModal.querySelector('.bg-white');
        if (modalContent) {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
        }
    
        setTimeout(() => {
            elements.historyDetailModal.classList.add('hidden');
        }, 300);
    }
}

// æ·»åŠ ä»å†å²è®°å½•é‡æ–°å¯¼å…¥å‡½æ•°
function reimportFromHistory(index) {
    const record = appData.importHistory[index];
    if (!record || record.status !== 'success') {
        showNotification('é”™è¯¯', 'æ— æ³•é‡æ–°å¯¼å…¥æ­¤è®°å½•', 'error');
        return;
    }
    
    // æ¸…ç©ºå½“å‰æ•°æ®
    removeAllFiles();
    
    // å°è¯•ä½¿ç”¨å†å²è®°å½•ä¸­çš„æ–‡ä»¶è·¯å¾„é‡æ–°å¯¼å…¥
    if (record.filePath) {
        // ä½¿ç”¨fetch APIè·å–æ–‡ä»¶
        fetch(record.filePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error('æ— æ³•è®¿é—®æ–‡ä»¶ï¼š' + record.filePath);
                }
                return response.blob();
            })
            .then(blob => {
                // åˆ›å»ºFileå¯¹è±¡
                const file = new File([blob], record.fileName, { type: blob.type });
                
                // å¤„ç†æ–‡ä»¶
                processFiles([file]);
                
                // ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆååº”ç”¨å†å²é…ç½®
                setTimeout(() => {
                    if (appData.worksheets.length > 0 && record.config) {
                        // åº”ç”¨å†å²é…ç½®
                        appData.config.dataType = record.config.dataType;
                        appData.config.multiplier = record.config.multiplier;
                        appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                        appData.config.multiplierColumn = record.config.multiplierColumn || '';
                        appData.config.dateColumn = record.config.dateColumn;
                        appData.config.dataStartColumn = record.config.dataStartColumn;
                        appData.config.dataEndColumn = record.config.dataEndColumn;
                        appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                        appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                        appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                        appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                        appData.config.timeInterval = record.config.timeInterval || 15;
                        
                        // æ›´æ–°UI
                        document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                        elements.multiplierInput.value = record.config.multiplier;
                        elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                        elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                        elements.dateColumnSelect.value = record.config.dateColumn;
                        elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                        elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                        elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                        elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                        
                        elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                        elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                        
                        // æ›´æ–°å€ç‡é€‰é¡¹æ˜¾ç¤º
                        if (record.config.useMultiplierColumn) {
                            elements.multiplierOptions.classList.add('hidden');
                            elements.multiplierColumnOption.classList.remove('hidden');
                        } else {
                            elements.multiplierOptions.classList.remove('hidden');
                            elements.multiplierColumnOption.classList.add('hidden');
                        }
                        
                        // æ›´æ–°æ•°æ®é¢„è§ˆ
                        updateDataPreview();
                        
                        showNotification('æˆåŠŸ', 'å·²ç›´æ¥ä»åŸå§‹ä½ç½®é‡æ–°å¯¼å…¥æ–‡ä»¶å¹¶åº”ç”¨å†å²é…ç½®', 'success');
                    }
                }, 500);
            })
            .catch(error => {
                console.error('ç›´æ¥è®¿é—®æ–‡ä»¶å¤±è´¥:', error);
                showNotification('è­¦å‘Š', 'æ— æ³•ç›´æ¥è®¿é—®åŸå§‹æ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶', 'warning');
                
                // å¦‚æœæ— æ³•ç›´æ¥è®¿é—®æ–‡ä»¶ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.multiple = false;
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    const file = files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ¹é…
                    if (file.name !== record.fileName) {
                        if (!confirm(`é€‰æ‹©çš„æ–‡ä»¶ "${file.name}" ä¸å†å²è®°å½•ä¸­çš„æ–‡ä»¶ "${record.fileName}" ä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                            return;
                        }
                    }
                    
                    // æ¸…ç©ºå½“å‰æ•°æ®
                    removeAllFiles();
                    
                    // å¤„ç†æ–‡ä»¶
                    processFiles([file]);
                    
                    // ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆååº”ç”¨å†å²é…ç½®
                    setTimeout(() => {
                        if (appData.worksheets.length > 0 && record.config) {
                            // åº”ç”¨å†å²é…ç½®
                            appData.config.dataType = record.config.dataType;
                            appData.config.multiplier = record.config.multiplier;
                            appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                            appData.config.multiplierColumn = record.config.multiplierColumn || '';
                            appData.config.dateColumn = record.config.dateColumn;
                            appData.config.dataStartColumn = record.config.dataStartColumn;
                            appData.config.dataEndColumn = record.config.dataEndColumn;
                            appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                            appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                            appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                            appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                            appData.config.timeInterval = record.config.timeInterval || 15;
                            
                            // æ›´æ–°UI
                            document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                            elements.multiplierInput.value = record.config.multiplier;
                            elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                            elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                            elements.dateColumnSelect.value = record.config.dateColumn;
                            elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                            elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                            elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                            elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';

                            elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                            elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                            
                            // æ›´æ–°å€ç‡é€‰é¡¹æ˜¾ç¤º
                            if (record.config.useMultiplierColumn) {
                                elements.multiplierOptions.classList.add('hidden');
                                elements.multiplierColumnOption.classList.remove('hidden');
                            } else {
                                elements.multiplierOptions.classList.remove('hidden');
                                elements.multiplierColumnOption.classList.add('hidden');
                            }
                            
                            // æ›´æ–°æ•°æ®é¢„è§ˆ
                            updateDataPreview();
                            
                            showNotification('æˆåŠŸ', 'å·²é‡æ–°å¯¼å…¥æ–‡ä»¶å¹¶åº”ç”¨å†å²é…ç½®', 'success');
                        }
                    }, 500);
                };
                
                // è§¦å‘æ–‡ä»¶é€‰æ‹©
                fileInput.click();
            });
    } else {
        // å¦‚æœæ²¡æœ‰æ–‡ä»¶è·¯å¾„ï¼Œåˆ™æç¤ºç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
        showNotification('æç¤º', 'å†å²è®°å½•ä¸­æ²¡æœ‰æ–‡ä»¶è·¯å¾„ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡ä»¶', 'warning');
        
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx,.xls,.csv';
        fileInput.multiple = false;
        
        fileInput.onchange = function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            const file = files[0];
            
            // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ¹é…
            if (file.name !== record.fileName) {
                if (!confirm(`é€‰æ‹©çš„æ–‡ä»¶ "${file.name}" ä¸å†å²è®°å½•ä¸­çš„æ–‡ä»¶ "${record.fileName}" ä¸åŒ¹é…ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }
            
            // æ¸…ç©ºå½“å‰æ•°æ®
            removeAllFiles();
            
            // å¤„ç†æ–‡ä»¶
            processFiles([file]);
            
            // ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆååº”ç”¨å†å²é…ç½®
            setTimeout(() => {
                if (appData.worksheets.length > 0 && record.config) {
                    // åº”ç”¨å†å²é…ç½®
                    appData.config.dataType = record.config.dataType;
                    appData.config.multiplier = record.config.multiplier;
                    appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                    appData.config.multiplierColumn = record.config.multiplierColumn || '';
                    appData.config.dateColumn = record.config.dateColumn;
                    appData.config.dataStartColumn = record.config.dataStartColumn;
                    appData.config.dataEndColumn = record.config.dataEndColumn;
                    appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                    appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                    appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                    appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                    appData.config.timeInterval = record.config.timeInterval || 15;
                    
                    // æ›´æ–°UI
                    document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                    elements.multiplierInput.value = record.config.multiplier;
                    elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                    elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                    elements.dateColumnSelect.value = record.config.dateColumn;
                    elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                    elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                    elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                    elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                    
                    elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                    elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                    
                    // æ›´æ–°å€ç‡é€‰é¡¹æ˜¾ç¤º
                    if (record.config.useMultiplierColumn) {
                        elements.multiplierOptions.classList.add('hidden');
                        elements.multiplierColumnOption.classList.remove('hidden');
                    } else {
                        elements.multiplierOptions.classList.remove('hidden');
                        elements.multiplierColumnOption.classList.add('hidden');
                    }
                    
                    // æ›´æ–°æ•°æ®é¢„è§ˆ
                    updateDataPreview();
                    
                    showNotification('æˆåŠŸ', 'å·²é‡æ–°å¯¼å…¥æ–‡ä»¶å¹¶åº”ç”¨å†å²é…ç½®', 'success');
                }
            }, 500);
        };
        
        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        fileInput.click();
    }
}

        // è¾…åŠ©å‡½æ•°ï¼šè§£ææ—¥æœŸæ—¶é—´
function parseDateTime(dateTimeStr, format) {
    if (!dateTimeStr || typeof dateTimeStr !== 'string') {
        return null;
    }
    
    // å°è¯•å¤šç§æ—¥æœŸæ—¶é—´æ ¼å¼
    const formats = [
        { regex: /\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-ss' }, // YYYY-MM-DD HH:MM:SS
        { regex: /\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm' },     // YYYY/MM/DD HH:MM
        { regex: /\d{4}\d{2}\d{2}\d{2}\d{2}\d{2}/, id: 'yyyymmddhhmmss' },     // YYYYMMDDHHMMSS
        { regex: /\d{4}\/\d{2}\/\d{2}\/\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-slash' },    // YYYY/MM/DD/HH:MM
        { regex: /\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm' },     // MM/DD/YYYY HH:MM
        { regex: /\d{2}-\d{2}-\d{4} \d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm-dash' },      // MM-DD-YYYY HH:MM
        { regex: /\d{4}-\d{2}-\d{2} \d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-dash' },      // YYYY-MM-DD HH:MM
        { regex: /\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-ss-slash' }, // YYYY/MM/DD HH:MM:SS
        { regex: /\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm-ss' }  // MM/DD/YYYY HH:MM:SS
    ];
    
    for (const fmt of formats) {
        if (fmt.regex.test(dateTimeStr)) {
            let parts;
            let date;
            
            // æ ¹æ®åŒ¹é…çš„æ ¼å¼è§£ææ—¥æœŸæ—¶é—´
            if (fmt.id === 'yyyy-mm-dd-hh-mm-ss') {
                parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyymmddhhmmss') {
                if (dateTimeStr.length >= 14) {
                    const year = parseInt(dateTimeStr.substring(0, 4));
                    const month = parseInt(dateTimeStr.substring(4, 6)) - 1;
                    const day = parseInt(dateTimeStr.substring(6, 8));
                    const hour = parseInt(dateTimeStr.substring(8, 10));
                    const minute = parseInt(dateTimeStr.substring(10, 12));
                    const second = parseInt(dateTimeStr.substring(12, 14));
                    date = new Date(year, month, day, hour, minute, second);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-slash') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2})\/(\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm') {
                parts = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm-dash') {
                parts = dateTimeStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-dash') {
                parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-ss-slash') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm-ss') {
                parts = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            }
        }
    }
    
    // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ ¼å¼ï¼Œå°è¯•ä½¿ç”¨Dateå¯¹è±¡è§£æ
    const date = new Date(dateTimeStr);
    return isNaN(date.getTime()) ? null : date;
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸé”®
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // ç»Ÿä¸€è®¡ç®—å°æ—¶åŠŸç‡çš„å‡½æ•°
        function calculateHourlyPower(dataPoints, multiplier, timeInterval = 15, isDebug = false) {
            // è¿‡æ»¤æ— æ•ˆæ•°æ®
            const validData = dataPoints.filter(v => v !== null);
            
            if (validData.length === 0) {
                if (isDebug) {
                    console.log('è®¡ç®—å°æ—¶åŠŸç‡è°ƒè¯•ä¿¡æ¯ï¼š');
                    console.log('- åŸå§‹æ•°æ®ç‚¹æ•°é‡:', dataPoints.length);
                    console.log('- æœ‰æ•ˆæ•°æ®ç‚¹æ•°é‡: 0');
                    console.log('- è®¡ç®—ç»“æœ: null (æ— æœ‰æ•ˆæ•°æ®)');
                }
                return null;
            }
            
            // æ ¹æ®æ—¶é—´é—´éš”è®¡ç®—æ¯å°æ—¶åº”æœ‰çš„æ•°æ®ç‚¹æ•°é‡
            const expectedPointsPerHour = 60 / timeInterval;
            
            // è®¡ç®—æ€»å’Œ
            const sum = validData.reduce((a, b) => a + b, 0);
            
            // è®¡ç®—å¹³å‡åŠŸç‡
            const avgPower = sum / validData.length;
            
            // è®¡ç®—å°æ—¶å€¼ï¼šå¹³å‡åŠŸç‡ Ã— 1 Ã— å€ç‡
            const hourlyValue = avgPower * 1 * multiplier;
            
            // æ£€æŸ¥æ•°æ®ç‚¹æ•°é‡æ˜¯å¦åŒ¹é…é¢„æœŸ
            const isPointsCountValid = Math.abs(validData.length - expectedPointsPerHour) / expectedPointsPerHour <= 0.2; // å…è®¸20%çš„è¯¯å·®
            
            if (isDebug) {
                console.log('è®¡ç®—å°æ—¶åŠŸç‡è°ƒè¯•ä¿¡æ¯ï¼š');
                console.log('- åŸå§‹æ•°æ®ç‚¹æ•°é‡:', dataPoints.length);
                console.log('- æœ‰æ•ˆæ•°æ®ç‚¹æ•°é‡:', validData.length);
                console.log('- æ—¶é—´é—´éš”:', timeInterval, 'åˆ†é’Ÿ');
                console.log('- é¢„æœŸæ¯å°æ—¶æ•°æ®ç‚¹æ•°é‡:', expectedPointsPerHour);
                console.log('- æ•°æ®ç‚¹æ•°é‡æ˜¯å¦åŒ¹é…:', isPointsCountValid ? 'æ˜¯' : 'å¦');
                console.log('- æ•°æ®ç‚¹æ€»å’Œ:', sum.toFixed(2), 'kW');
                console.log('- å¹³å‡åŠŸç‡:', avgPower.toFixed(2), 'kW');
                console.log('- å€ç‡:', multiplier);
                console.log('- è®¡ç®—ç»“æœ:', hourlyValue.toFixed(2), 'kWh');
            }
            
            return hourlyValue;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–ç­›é€‰åçš„æ•°æ®
        function getFilteredData() {
            console.log('=== getFilteredData è°ƒè¯•ä¿¡æ¯ ===');
            console.log('åŸå§‹æ•°æ®æ€»æ•°:', appData.processedData.length);
            console.log('é€‰ä¸­æ—¥æœŸ:', appData.visualization.selectedDates);
            console.log('é€‰ä¸­è®¡é‡ç‚¹:', appData.visualization.selectedMeteringPoints);
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•æ—¥æœŸï¼Œé»˜è®¤é€‰æ‹©æ‰€æœ‰æ—¥æœŸ
            if (appData.visualization.selectedDates.length === 0 && appData.processedData.length > 0) {
                appData.visualization.selectedDates = appData.processedData.map(d => d.date);
                console.log('è‡ªåŠ¨é€‰æ‹©æ‰€æœ‰æ—¥æœŸ:', appData.visualization.selectedDates);
            }
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•è®¡é‡ç‚¹ï¼Œé»˜è®¤é€‰æ‹©æ‰€æœ‰è®¡é‡ç‚¹
            if (appData.visualization.selectedMeteringPoints.length === 0 && appData.meteringPoints.length > 0) {
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                console.log('è‡ªåŠ¨é€‰æ‹©æ‰€æœ‰è®¡é‡ç‚¹:', appData.visualization.selectedMeteringPoints);
            }
            
            // å½“å·²é€‰æ‹©é›†åˆä¸æ–°æ•°æ®å¯ç”¨é›†åˆæ— äº¤é›†æ—¶ï¼Œè‡ªåŠ¨å›é€€ä¸ºå…¨é€‰
            const availableDateSet = new Set(appData.processedData.map(d => d.date));
            if (appData.visualization.selectedDates.length > 0) {
                const hasDateOverlap = appData.visualization.selectedDates.some(d => availableDateSet.has(d));
                if (!hasDateOverlap && appData.processedData.length > 0) {
                    appData.visualization.selectedDates = appData.processedData.map(d => d.date);
                    console.log('æ£€æµ‹åˆ°é€‰æ‹©çš„æ—¥æœŸä¸æ–°æ•°æ®ä¸é‡å ï¼Œå·²è‡ªåŠ¨é‡ç½®ä¸ºå…¨é€‰æ—¥æœŸ');
                }
            }
            const availableMPSet = new Set(appData.meteringPoints);
            if (appData.visualization.selectedMeteringPoints.length > 0) {
                const hasMPOverlap = appData.visualization.selectedMeteringPoints.some(mp => availableMPSet.has(mp));
                if (!hasMPOverlap && appData.meteringPoints.length > 0) {
                    appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                    console.log('æ£€æµ‹åˆ°é€‰æ‹©çš„è®¡é‡ç‚¹ä¸æ–°æ•°æ®ä¸é‡å ï¼Œå·²è‡ªåŠ¨é‡ç½®ä¸ºå…¨éƒ¨è®¡é‡ç‚¹');
                }
            }
            
            const filteredData = DataUtils.filterData(appData.processedData, {
                dates: appData.visualization.selectedDates,
                meteringPoints: appData.visualization.selectedMeteringPoints.length > 0 ? 
                    appData.visualization.selectedMeteringPoints : null
            });
            
            console.log('ç­›é€‰åæ•°æ®æ€»æ•°:', filteredData.length);
            console.log('ç­›é€‰åæ•°æ®æ—¥æœŸ:', filteredData.map(d => d.date));
            console.log('ç­›é€‰åæ•°æ®è®¡é‡ç‚¹:', [...new Set(filteredData.map(d => d.meteringPoint))]);
            if (filteredData.length > 0) {
                console.log('ç¬¬ä¸€æ¡æ•°æ®ç»“æ„:', Object.keys(filteredData[0]));
                console.log('ç¬¬ä¸€æ¡æ•°æ®çš„dailyTotal:', filteredData[0].dailyTotal);
            }
            console.log('===============================');
            
            return filteredData;
        }
        
        // æ€§èƒ½ä¼˜åŒ–é…ç½®
        const PERFORMANCE_CONFIG = {
            BATCH_SIZE: 1000,           // æ‰¹å¤„ç†å¤§å°
            CACHE_ENABLED: true,        // å¯ç”¨ç¼“å­˜
            WORKER_ENABLED: false,      // Web Workeræ”¯æŒï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
            DEBOUNCE_DELAY: 300         // é˜²æŠ–å»¶è¿Ÿ
        };
        
        // ç¼“å­˜ç®¡ç†å™¨
        const CacheManager = {
            cache: new Map(),
            
            get: function(key) {
                return this.cache.get(key);
            },
            
            set: function(key, value, ttl = 300000) { // é»˜è®¤5åˆ†é’ŸTTL
                const item = {
                    value,
                    timestamp: Date.now(),
                    ttl
                };
                this.cache.set(key, item);
                
                // æ¸…ç†è¿‡æœŸç¼“å­˜
                this.cleanup();
            },
            
            has: function(key) {
                const item = this.cache.get(key);
                if (!item) return false;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return false;
                }
                return true;
            },
            
            cleanup: function() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now - item.timestamp > item.ttl) {
                        this.cache.delete(key);
                    }
                }
            },
            
            clear: function() {
                this.cache.clear();
            }
        };
        
        // æ•°æ®å¤„ç†å·¥å…·ç±»
        const DataUtils = {
            // é€šç”¨æ•°æ®è¿‡æ»¤å™¨
            filterData: function(data, filters = {}) {
                return data.filter(item => {
                    // æ—¥æœŸè¿‡æ»¤
                    if (filters.dates && filters.dates.length > 0) {
                        if (!filters.dates.includes(item.date)) return false;
                    }
                    
                    // è®¡é‡ç‚¹è¿‡æ»¤
                    if (filters.meteringPoints && filters.meteringPoints.length > 0) {
                        // ä¸ä¸‹æ‹‰é€‰é¡¹å’Œåˆ†ç»„é€»è¾‘ä¿æŒä¸€è‡´ï¼šå°†ç©ºå€¼ç»Ÿä¸€æ˜ å°„ä¸ºã€é»˜è®¤è®¡é‡ç‚¹ã€
                        const rawMp = item.meteringPoint;
                        const mpValue = (rawMp === undefined || rawMp === null || String(rawMp).trim() === '')
                            ? 'é»˜è®¤è®¡é‡ç‚¹'
                            : String(rawMp).trim();
                        if (!filters.meteringPoints.includes(mpValue)) return false;
                    }
                    
                    // è‡ªå®šä¹‰è¿‡æ»¤å™¨
                    if (filters.custom && typeof filters.custom === 'function') {
                        if (!filters.custom(item)) return false;
                    }
                    
                    return true;
                });
            },
            
            // æ•°æ®åˆ†ç»„å·¥å…·
            groupBy: function(data, keyFn) {
                const groups = new Map();
                data.forEach(item => {
                    const key = keyFn(item);
                    if (!groups.has(key)) {
                        groups.set(key, []);
                    }
                    groups.get(key).push(item);
                });
                return groups;
            },
            
            // æ•°æ®èšåˆå·¥å…·
            aggregate: function(data, aggregateFn) {
                if (!data || data.length === 0) return null;
                return aggregateFn(data);
            },
            
            // æ•°æ®æ¸…æ´—å·¥å…·
            cleanData: function(data, options = {}) {
                const { fillMethod = 'ignore' } = options;
                
                return data.map((value, index, array) => {
                    if (value === null || value === undefined || value === '' || isNaN(value)) {
                        if (fillMethod === 'ignore') {
                            return null;
                        } else if (fillMethod === 'interpolate') {
                            // ç”¨ç›¸é‚»æ•°æ®å¡«å……
                            let prevValue = null;
                            for (let i = index - 1; i >= 0; i--) {
                                if (array[i] !== null && !isNaN(array[i])) {
                                    prevValue = parseFloat(array[i]);
                                    break;
                                }
                            }
                            
                            let nextValue = null;
                            for (let i = index + 1; i < array.length; i++) {
                                if (array[i] !== null && !isNaN(array[i])) {
                                    nextValue = parseFloat(array[i]);
                                    break;
                                }
                            }
                            
                            if (prevValue !== null && nextValue !== null) {
                                return (prevValue + nextValue) / 2;
                            } else if (prevValue !== null) {
                                return prevValue;
                            } else if (nextValue !== null) {
                                return nextValue;
                            } else {
                                return null;
                            }
                        }
                        return null;
                    }
                    return parseFloat(value);
                });
            },
            
            // æ•°æ®éªŒè¯å·¥å…·
            validateData: function(data, rules = {}) {
                const errors = [];
                
                if (rules.required && (!data || data.length === 0)) {
                    errors.push('æ•°æ®ä¸èƒ½ä¸ºç©º');
                }
                
                if (rules.minLength && data.length < rules.minLength) {
                    errors.push(`æ•°æ®é•¿åº¦ä¸èƒ½å°‘äº${rules.minLength}`);
                }
                
                if (rules.maxLength && data.length > rules.maxLength) {
                    errors.push(`æ•°æ®é•¿åº¦ä¸èƒ½è¶…è¿‡${rules.maxLength}`);
                }
                
                return { isValid: errors.length === 0, errors };
            },
            
            // æ‰¹å¤„ç†å·¥å…·
            processBatch: function(data, processFn, batchSize = PERFORMANCE_CONFIG.BATCH_SIZE) {
                const results = [];
                
                for (let i = 0; i < data.length; i += batchSize) {
                    const batch = data.slice(i, i + batchSize);
                    const batchResult = processFn(batch);
                    
                    if (Array.isArray(batchResult)) {
                        results.push(...batchResult);
                    } else {
                        results.push(batchResult);
                    }
                    
                    // è®©å‡ºæ§åˆ¶æƒï¼Œé¿å…é˜»å¡UI
                    if (i + batchSize < data.length) {
                        setTimeout(() => {}, 0);
                    }
                }
                
                return results;
            },
            
            // ç¼“å­˜è£…é¥°å™¨
            withCache: function(fn, keyGenerator) {
                return function(...args) {
                    if (!PERFORMANCE_CONFIG.CACHE_ENABLED) {
                        return fn.apply(this, args);
                    }
                    
                    const cacheKey = keyGenerator ? keyGenerator(...args) : JSON.stringify(args);
                    
                    if (CacheManager.has(cacheKey)) {
                        return CacheManager.get(cacheKey).value;
                    }
                    
                    const result = fn.apply(this, args);
                    CacheManager.set(cacheKey, result);
                    
                    return result;
                };
            },
            
            // é˜²æŠ–å·¥å…·
            debounce: function(fn, delay = PERFORMANCE_CONFIG.DEBOUNCE_DELAY) {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => fn.apply(this, args), delay);
                };
            },
            
            // ä¼˜åŒ–çš„forEachï¼ˆæ”¯æŒæ—©æœŸé€€å‡ºï¼‰
            fastForEach: function(array, callback, breakCondition) {
                for (let i = 0; i < array.length; i++) {
                    const result = callback(array[i], i, array);
                    if (breakCondition && breakCondition(result, i)) {
                        break;
                    }
                }
            },
            
            // å†…å­˜å‹å¥½çš„å¤§æ•°ç»„å¤„ç†
            processLargeArray: function(array, processFn, options = {}) {
                const { 
                    batchSize = PERFORMANCE_CONFIG.BATCH_SIZE,
                    onProgress = null,
                    onComplete = null 
                } = options;
                
                let processedCount = 0;
                const totalCount = array.length;
                const results = [];
                
                const processBatch = (startIndex) => {
                    const endIndex = Math.min(startIndex + batchSize, totalCount);
                    const batch = array.slice(startIndex, endIndex);
                    
                    const batchResults = batch.map(processFn);
                    results.push(...batchResults);
                    
                    processedCount += batch.length;
                    
                    if (onProgress) {
                        onProgress(processedCount, totalCount);
                    }
                    
                    if (endIndex < totalCount) {
                        // ä½¿ç”¨ requestAnimationFrame æˆ– setTimeout æ¥é¿å…é˜»å¡
                        if (window.requestAnimationFrame) {
                            requestAnimationFrame(() => processBatch(endIndex));
                        } else {
                            setTimeout(() => processBatch(endIndex), 0);
                        }
                    } else if (onComplete) {
                        onComplete(results);
                    }
                };
                
                processBatch(0);
                return results;
            }
        };
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–é¢œè‰²
        function getColor(index) {
            const colors = [
                '#6366F1',   // ç°ä»£é›è“è‰²
                '#8B5CF6',   // ç°ä»£ç´«ç½—å…°è‰²
                '#EC4899',   // ç°ä»£ç²‰çº¢è‰²
                '#10B981',   // ç°ä»£ç¿ ç»¿è‰²
                '#F59E0B',   // ç°ä»£ç¥ç€è‰²
                '#EF4444',   // ç°ä»£çº¢è‰²
                '#06B6D4',   // ç°ä»£é’è‰²
                '#F97316',   // ç°ä»£æ©™è‰²
                '#84CC16',   // ç°ä»£é…¸æ©™ç»¿
                '#A855F7'    // ç°ä»£ç´«è‰²
            ];
            
            return colors[index % colors.length];
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–é¢œè‰²æ•°é‡
        function getColorCount() {
            return 10; // é¢œè‰²æ•°ç»„ä¸­çš„é¢œè‰²æ•°é‡
        }



// å¯åŠ¨åº”ç”¨
document.addEventListener('DOMContentLoaded', initApp);

// å¯æŠ˜å é¢æ¿åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const togglePanels = document.querySelectorAll('.toggle-panel');
    
    togglePanels.forEach(panel => {
        panel.addEventListener('click', function() {
            const panelId = this.getAttribute('data-panel');
            if (panelId === 'preview') return; // é¢„è§ˆå¡ç‰‡å›ºå®šæ˜¾ç¤ºï¼Œå¿½ç•¥æŠ˜å 
            const contentPanel = document.getElementById(`${panelId}-panel`);
            const icon = this.querySelector('.fa-chevron-down');
            
            if (contentPanel.style.display === 'none') {
                contentPanel.style.display = 'block';
                if (icon) icon.style.transform = 'rotate(0deg)';
            } else {
                contentPanel.style.display = 'none';
                if (icon) icon.style.transform = 'rotate(-90deg)';
            }
        });
    });
    
    // æ ¹æ®æŒ‡å®šè¦æ±‚è®¾ç½®å¡ç‰‡é»˜è®¤çŠ¶æ€
    togglePanels.forEach(panel => {
        const panelId = panel.getAttribute('data-panel');
        const contentPanel = document.getElementById(`${panelId}-panel`);
        const icon = panel.querySelector('.fa-chevron-down');
        
        // è®¾ç½®é¢æ¿é»˜è®¤çŠ¶æ€ - ä»…é¢„è§ˆå¡ç‰‡é»˜è®¤æ‰“å¼€
                    const openPanels = ['preview'];
                    const closePanels = ['dataType', 'dataStructure', 'date', 'columns', 'advanced', 'filter', 'settings', 'config'];
        
        if (openPanels.includes(panelId)) {
            contentPanel.style.display = 'block';
            if (panelId !== 'preview' && icon) icon.style.transform = 'rotate(0deg)';
        } else {
            contentPanel.style.display = 'none';
            if (icon) icon.style.transform = 'rotate(-90deg)';
        }
    });
});

        // æ—¶æ®µç»Ÿè®¡å¯¹æ¯”çª—å£åŠŸèƒ½
        let timeSlotComparisonDragging = false;
        let timeSlotComparisonDragOffset = { x: 0, y: 0 };
        let timeSlotComparisonMinimized = false;

        // æ˜¾ç¤ºæ—¶æ®µç»Ÿè®¡å¯¹æ¯”çª—å£
        window.showTimeSlotComparison = function() {
            const window = document.getElementById('timeSlotComparisonWindow');
            if (window && window.parentNode) {
                window.classList.remove('hidden');
            }
            updateTimeSlotComparison();
            
            // æ·»åŠ æ‹–åŠ¨äº‹ä»¶ç›‘å¬
            setupTimeSlotComparisonDrag();
        }

        // å…³é—­æ—¶æ®µç»Ÿè®¡å¯¹æ¯”çª—å£
        window.closeTimeSlotComparison = function() {
            const window = document.getElementById('timeSlotComparisonWindow');
            if (window && window.parentNode) {
                window.classList.add('hidden');
            }
        }

        // æœ€å°åŒ–/æ¢å¤æ—¶æ®µç»Ÿè®¡å¯¹æ¯”çª—å£
        window.toggleTimeSlotComparisonMinimize = function() {
            const content = document.getElementById('timeSlotComparisonContent');
            const minimizeBtn = document.getElementById('minimizeTimeSlotComparison');
            
            if (timeSlotComparisonMinimized) {
                content.style.display = 'block';
                minimizeBtn.innerHTML = '<i class="fa fa-window-minimize"></i>';
                timeSlotComparisonMinimized = false;
            } else {
                content.style.display = 'none';
                minimizeBtn.innerHTML = '<i class="fa fa-window-maximize"></i>';
                timeSlotComparisonMinimized = true;
            }
        }

        // è®¾ç½®æ‹–åŠ¨åŠŸèƒ½
        function setupTimeSlotComparisonDrag() {
            const header = document.getElementById('timeSlotComparisonHeader');
            const window = document.getElementById('timeSlotComparisonWindow');

            header.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                
                timeSlotComparisonDragging = true;
                const rect = window.getBoundingClientRect();
                timeSlotComparisonDragOffset.x = e.clientX - rect.left;
                timeSlotComparisonDragOffset.y = e.clientY - rect.top;
                
                document.addEventListener('mousemove', timeSlotComparisonMouseMove);
                document.addEventListener('mouseup', timeSlotComparisonMouseUp);
            });
        }

        function timeSlotComparisonMouseMove(e) {
            if (!timeSlotComparisonDragging) return;
            
            const window = document.getElementById('timeSlotComparisonWindow');
            const newX = e.clientX - timeSlotComparisonDragOffset.x;
            const newY = e.clientY - timeSlotComparisonDragOffset.y;
            
            // ç¡®ä¿çª—å£ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
            const maxX = window.innerWidth - window.offsetWidth;
            const maxY = window.innerHeight - window.offsetHeight;
            
            window.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            window.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function timeSlotComparisonMouseUp() {
            timeSlotComparisonDragging = false;
            document.removeEventListener('mousemove', timeSlotComparisonMouseMove);
            document.removeEventListener('mouseup', timeSlotComparisonMouseUp);
        }

        // æ›´æ–°æ—¶æ®µç»Ÿè®¡å¯¹æ¯”æ•°æ®
        window.updateTimeSlotComparison = function() {
            const startHour = parseInt(document.getElementById('timeSlotStart').value);
            const endHour = parseInt(document.getElementById('timeSlotEnd').value);
            
            if (startHour > endHour) {
                showNotification('æç¤º', 'å¼€å§‹æ—¶æ®µä¸èƒ½å¤§äºç»“æŸæ—¶æ®µ', 'warning');
                return;
            }

            const filteredData = getFilteredData();
            if (filteredData.length === 0) {
                document.getElementById('timeSlotComparisonTableBody').innerHTML = '<tr><td colspan="6" class="border border-gray-200 p-2 text-center text-gray-500 text-sm">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            // å®šä¹‰é¢œè‰²æ•°ç»„
            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4', '#F97316', '#84CC16',
                '#EC4899', '#6366F1', '#14B8A6', '#F43F5E', '#A855F7', '#0EA5E9', '#EAB308', '#22C55E',
                '#D946EF', '#F87171', '#34D399', '#60A5FA', '#FBBF24', '#A78BFA', '#FB923C', '#67E8F9', '#FDA4AF'
            ];

            let totalPeriodEnergy = 0;
            let maxEnergy = 0;
            let minEnergy = Infinity;
            const periodData = [];
            let periodHours = endHour - startHour + 1;

            // è®¡ç®—æ¯ä¸ªæ—¥æœŸåœ¨æŒ‡å®šæ—¶æ®µçš„ç”¨ç”µé‡
            filteredData.forEach(row => {
                let periodEnergy = 0;
                let validHours = 0;
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (row.hourlyData[hour] !== null && row.hourlyData[hour] !== undefined) {
                        periodEnergy += row.hourlyData[hour];
                        validHours++;
                    }
                }
                
                if (validHours > 0) {
                    periodData.push({
                        date: row.date,
                        energy: periodEnergy,
                        totalEnergy: row.dailyTotal || 0,
                        hourlyAverage: validHours > 0 ? periodEnergy / validHours : 0
                    });
                    
                    totalPeriodEnergy += periodEnergy;
                    maxEnergy = Math.max(maxEnergy, periodEnergy);
                    minEnergy = Math.min(minEnergy, periodEnergy);
                }
            });

            // è®¡ç®—æ±‡æ€»ç»Ÿè®¡
            const avgEnergy = periodData.length > 0 ? totalPeriodEnergy / periodData.length : 0;
            const totalDailyEnergy = periodData.reduce((sum, item) => sum + item.totalEnergy, 0);
            const overallPercentage = totalDailyEnergy > 0 ? (totalPeriodEnergy / totalDailyEnergy) * 100 : 0;
            const avgHourlyOverall = totalDailyEnergy > 0 ? totalDailyEnergy / (periodData.length * 24) : 0;
            const avgHourlyInPeriod = totalPeriodEnergy > 0 ? totalPeriodEnergy / (periodData.length * periodHours) : 0;

            // æ›´æ–°æ±‡æ€»å¡ç‰‡
            document.getElementById('timeSlotTotal').textContent = totalPeriodEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotAvg').textContent = avgEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotMax').textContent = maxEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotMin').textContent = minEnergy === Infinity ? '0.00 kWh' : minEnergy.toFixed(2) + ' kWh';

            // æ·»åŠ æ–°çš„æ±‡æ€»ä¿¡æ¯
            const summaryHtml = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <div class="text-green-700 text-sm font-medium">å å…¨å¤©æ¯”ä¾‹</div>
                        <div class="text-green-900 text-lg font-bold">${overallPercentage.toFixed(1)}%</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <div class="text-purple-700 text-sm font-medium">æ—¶æ®µå¹³å‡å°æ—¶</div>
                        <div class="text-purple-900 text-lg font-bold">${avgHourlyInPeriod.toFixed(2)} kWh</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
                        <div class="text-orange-700 text-sm font-medium">ç”¨ç”µé‡æœ€å¤§æ—¥</div>
                        <div class="text-orange-900 text-lg font-bold">${(periodData.sort((a,b)=>b.energy-a.energy)[0]?.date) || '-'}ï¼š${(periodData.length?Math.max(...periodData.map(p=>p.energy)).toFixed(2):'0.00')} kWh</div>
                    </div>
                    <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                        <div class="text-amber-700 text-sm font-medium">ç”¨ç”µé‡æœ€å°æ—¥</div>
                        <div class="text-amber-900 text-lg font-bold">${(periodData.sort((a,b)=>a.energy-b.energy)[0]?.date) || '-'}ï¼š${(periodData.length?Math.min(...periodData.map(p=>p.energy)).toFixed(2):'0.00')} kWh</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <div class="text-blue-700 text-sm font-medium">åˆ†æå¤©æ•°</div>
                        <div class="text-blue-900 text-lg font-bold">${periodData.length}å¤©</div>
                    </div>
                </div>
            `;
            
            const timeSlotSummary = document.getElementById('timeSlotSummary');
            const existingSummary = timeSlotSummary.querySelector('.grid');
            if (existingSummary) existingSummary.remove();
            timeSlotSummary.insertAdjacentHTML('beforeend', summaryHtml);

            // æ›´æ–°è¡¨æ ¼ - æ·»åŠ æ›´å¤šåˆ—
            const tbody = document.getElementById('timeSlotComparisonTableBody');
            tbody.innerHTML = '';

            periodData.forEach((item, index) => {
                const dailyPercentage = item.totalEnergy > 0 ? ((item.energy / item.totalEnergy) * 100).toFixed(1) : 0;
                const comparison = index > 0 ? 
                    ((item.energy - periodData[0].energy) / periodData[0].energy * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-200 p-2 text-center" style="color: ${colors[index % colors.length]}">${item.date}</td>
                    <td class="border border-gray-200 p-2 text-center">${item.energy.toFixed(2)}</td>
                    <td class="border border-gray-200 p-2 text-center">${dailyPercentage}%</td>
                    <td class="border border-gray-200 p-2 text-center">${item.hourlyAverage.toFixed(2)}</td>
                    <td class="border border-gray-200 p-2 text-center">${item.totalEnergy.toFixed(2)}</td>
                    <td class="border border-gray-200 p-2 text-center font-semibold ${comparison >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${comparison >= 0 ? '+' : ''}${comparison}%
                    </td>
                `;
                tbody.appendChild(row);
            });

            // æ›´æ–°è¡¨æ ¼æ ‡é¢˜
            const thead = document.querySelector('#timeSlotComparisonTable thead tr');
            if (thead) {
                thead.innerHTML = `
                    <th class="border border-gray-200 p-2 text-center font-medium">æ—¥æœŸ</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">æ—¶æ®µç”¨ç”µé‡ (kWh)</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">å å…¨å¤©æ¯”ä¾‹</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">æ—¶æ®µå¹³å‡å°æ—¶ (kWh)</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">æ—¥æ€»ç”¨ç”µé‡ (kWh)</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">å¯¹æ¯”é¦–æ—¥ (%)</th>
                `;
            }
        }

        // æ·»åŠ æ—¶æ®µç»Ÿè®¡å¯¹æ¯”æŒ‰é’®åˆ°ç•Œé¢
        setTimeout(() => {
            const controlPanel = document.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200');
            if (controlPanel) {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.innerHTML = '<i class="fa fa-clock mr-1"></i> æ—¶æ®µç»Ÿè®¡';
                timeSlotBtn.className = 'bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary/90 ml-2';
                timeSlotBtn.onclick = showTimeSlotComparison;
                controlPanel.appendChild(timeSlotBtn);
            }

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            document.getElementById('closeTimeSlotComparison').addEventListener('click', closeTimeSlotComparison);
            document.getElementById('timeSlotStart').addEventListener('change', updateTimeSlotComparison);
            document.getElementById('timeSlotEnd').addEventListener('change', updateTimeSlotComparison);
        }, 1000);

        // ä½œè€…ä¿¡æ¯å¼¹çª—åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const authorModal = document.getElementById('authorInfoModal');
            const startBtn = document.getElementById('startUsingBtn');
            const passwordSection = document.getElementById('passwordSection');
            const authorSection = document.getElementById('authorSection');
            const passwordInput = document.getElementById('accessPassword');
            const verifyBtn = document.getElementById('verifyPasswordBtn');
            const passwordError = document.getElementById('passwordError');
            
            // éªŒè¯ç³»ç»Ÿï¼ˆå¤šé‡åŠ å¯†ä¿æŠ¤ï¼‰
            const _0x1a2b = ['102', '119', '109', '49', '57', '57', '57'];
            const _0x3c4d = _0x1a2b.map(x => String.fromCharCode(parseInt(x)));
            const _0x5e6f = btoa(_0x3c4d.join(''));
            const _0x7g8h = _0x5e6f.split('').reverse().join('');
            const ACCESS_PASSWORD = atob(_0x7g8h.split('').reverse().join(''));
            
            // æ£€æŸ¥æ˜¯å¦å·²éªŒè¯å¯†ç 
            const isPasswordVerified = sessionStorage.getItem('passwordVerified');
            const hasVisited = sessionStorage.getItem('hasVisited');
            
            if (!hasVisited || !isPasswordVerified) {
                // é¦–æ¬¡è®¿é—®æˆ–æœªéªŒè¯å¯†ç ï¼Œæ˜¾ç¤ºä½œè€…ä¿¡æ¯å¼¹çª—
                setTimeout(() => {
                    authorModal.style.display = 'flex';
                    // å¦‚æœå·²éªŒè¯å¯†ç ï¼Œç›´æ¥æ˜¾ç¤ºä½œè€…ä¿¡æ¯
                    if (isPasswordVerified) {
                        showAuthorInfo();
                    }
                }, 500);
            } else {
                // å·²è®¿é—®è¿‡ä¸”å·²éªŒè¯ï¼Œç›´æ¥éšè—å¼¹çª—
                authorModal.style.display = 'none';
            }
            
            // å¯†ç éªŒè¯å‡½æ•°
            function verifyPassword() {
                const inputPassword = passwordInput.value.trim();
                
                if (inputPassword === ACCESS_PASSWORD) {
                    // å¯†ç æ­£ç¡®
                    sessionStorage.setItem('passwordVerified', 'true');
                    passwordError.classList.add('hidden');
                    showAuthorInfo();
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showNotification('éªŒè¯æˆåŠŸ', 'å¯†ç éªŒè¯æˆåŠŸï¼Œæ¬¢è¿ä½¿ç”¨ï¼', 'success');
                } else {
                    // å¯†ç é”™è¯¯
                    passwordError.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                    
                    // æ·»åŠ é”™è¯¯åŠ¨ç”»
                    passwordInput.classList.add('animate-pulse');
                    setTimeout(() => {
                        passwordInput.classList.remove('animate-pulse');
                    }, 1000);
                }
            }
            
            // æ˜¾ç¤ºä½œè€…ä¿¡æ¯
            function showAuthorInfo() {
                passwordSection.classList.add('hidden');
                authorSection.classList.remove('hidden');
                
                // æ›´æ–°å›¾æ ‡
                const icon = authorModal.querySelector('.fa-lock');
                if (icon) {
                    icon.className = 'fa fa-user text-white text-3xl';
                }
            }
            
            // å¯†ç éªŒè¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            verifyBtn.addEventListener('click', verifyPassword);
            
            // å¯†ç è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
            
            // ç‚¹å‡»å¼€å§‹ä½¿ç”¨æŒ‰é’®
            startBtn.addEventListener('click', function() {
                // æ ‡è®°ä¸ºå·²è®¿é—®
                sessionStorage.setItem('hasVisited', 'true');
                
                // éšè—å¼¹çª—åŠ¨ç”»
                authorModal.style.transition = 'opacity 0.3s ease';
                authorModal.style.opacity = '0';
                setTimeout(() => {
                    authorModal.style.display = 'none';
                }, 300);
                
                // æ˜¾ç¤ºæ¬¢è¿é€šçŸ¥
                showNotification('æ¬¢è¿ä½¿ç”¨', 'æ¬¢è¿ä½¿ç”¨è´Ÿè·æ›²çº¿åˆ†æå·¥å…·ï¼', 'success');
            });
            
            // ESCé”®å…³é—­å¼¹çª—ï¼ˆä»…åœ¨å·²éªŒè¯å¯†ç åç”Ÿæ•ˆï¼‰
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && authorModal.style.display === 'flex' && !authorSection.classList.contains('hidden')) {
                    sessionStorage.setItem('hasVisited', 'true');
                    authorModal.style.display = 'none';
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—ï¼ˆä»…åœ¨å·²éªŒè¯å¯†ç åç”Ÿæ•ˆï¼‰
            authorModal.addEventListener('click', function(e) {
                if (e.target === authorModal && !authorSection.classList.contains('hidden')) {
                    sessionStorage.setItem('hasVisited', 'true');
                    authorModal.style.display = 'none';
                }
            });
        });

        // ç§»é™¤æ¸…é™¤éªŒè¯ç¼“å­˜çš„åŠŸèƒ½ï¼Œå› ä¸ºä¸å†éœ€è¦
        // æ³¨é‡Šæ‰åŸæœ‰çš„æ¸…é™¤ç¼“å­˜åŠŸèƒ½
        /*
        function clearAccessCache() {
            localStorage.removeItem('invitationCode');
            location.reload();
        }

        // æ·»åŠ ä¸€ä¸ªéšè—çš„ç®¡ç†åŠŸèƒ½ï¼ˆæŒ‰Ctrl+Shift+Aï¼‰
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                clearAccessCache();
            }
        });
        */
    </script>
    


    <!-- ä½¿ç”¨è¯´æ˜é¢æ¿äº¤äº’ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const helpBtn = document.getElementById('helpBtn');
            const helpPanel = document.getElementById('helpPanel');
            const closeHelpBtn = document.getElementById('closeHelpBtn');
            const aboutBtn = document.getElementById('aboutBtn');

            // æ‰“å¼€ä½¿ç”¨è¯´æ˜é¢æ¿
            helpBtn.addEventListener('click', function() {
                if (helpPanel && helpPanel.parentNode) {
                    helpPanel.classList.remove('hidden');
                }
                document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            });

            // å…³é—­ä½¿ç”¨è¯´æ˜é¢æ¿
            function closeHelpPanel() {
                if (helpPanel && helpPanel.parentNode) {
                    helpPanel.classList.add('hidden');
                }
                document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            }

            closeHelpBtn.addEventListener('click', closeHelpPanel);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­é¢æ¿
            helpPanel.addEventListener('click', function(e) {
                if (e.target === helpPanel) {
                    closeHelpPanel();
                }
            });

            // ESCé”®å…³é—­é¢æ¿
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !helpPanel.classList.contains('hidden')) {
                    closeHelpPanel();
                }
            });

            // å…³äºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            aboutBtn.addEventListener('click', function() {
                showAboutModal();
            });

            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+H æ‰“å¼€å¸®åŠ©
                if (e.ctrlKey && e.shiftKey && e.key === 'H') {
                    e.preventDefault();
                    if (helpPanel && helpPanel.parentNode) {
                        helpPanel.classList.remove('hidden');
                    }
                    document.body.style.overflow = 'hidden';
                }
            });

            // æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœ
            const helpContent = helpPanel.querySelector('.max-h-screen');
            if (helpContent) {
                helpContent.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                });
            }
        });
    </script>
    
    <!-- ä½œè€…ä¿¡æ¯ -->
    <footer class="bg-white border-t border-gray-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">å…³äºæœ¬å·¥å…·</h3>
                    <p class="text-gray-600 text-sm">
                        <i class="fa fa-user mr-1"></i>
                        <strong>ä½œè€…ï¼šå†¯ä¼Ÿæ˜</strong>
                    </p>
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fa fa-weixin mr-1 text-green-500"></i>
                        å¾®ä¿¡è”ç³»æ–¹å¼ï¼š<strong>Call13345934750</strong>
                    </p>
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fa fa-comments mr-1 text-green-500"></i>
                        <strong>å…¬ä¼—å·ï¼š</strong>èƒ½æºå°é²¨é±¼
                    </p>
                </div>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-md max-w-md mx-auto">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>é‡è¦æé†’ï¼š</strong>è¯¥ç‰ˆæœ¬ä¸ºåˆå§‹ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨BUGï¼Œæœ‰é—®é¢˜è¯·è”ç³»æˆ‘
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-xs text-gray-500">
                    <p>Â© 2025 è´Ÿè·æ›²çº¿åˆ†æå·¥å…· - ä¸“ä¸ºç”µåŠ›æ•°æ®åˆ†æè®¾è®¡</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- åŸå§‹æ•°æ®ä¸PVsystæ•°æ®å¯¹æ¯”é¢„è§ˆåŠŸèƒ½ -->
    <script>
        // å¹³æ»‘æ»šåŠ¨è·³è½¬å‡½æ•°
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                // å…ˆæ˜¾ç¤ºç›®æ ‡sectionï¼Œéšè—å…¶ä»–section
                const allSections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
                allSections.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) {
                        if (id === sectionId) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    }
                });
                
                // å¦‚æœè·³è½¬åˆ°å¯è§†åŒ–åŒºåŸŸï¼Œè§¦å‘å›¾è¡¨æ›´æ–°
                if (sectionId === 'visualizationSection') {
                    // å»¶è¿Ÿæ‰§è¡Œå›¾è¡¨æ›´æ–°ï¼Œç¡®ä¿DOMå·²å®Œå…¨æ¸²æŸ“
                    setTimeout(() => {
                        console.log('è·³è½¬åˆ°å¯è§†åŒ–åŒºåŸŸï¼Œè§¦å‘å›¾è¡¨æ›´æ–°');
                        
                        // ç¡®ä¿æœ‰æ•°æ®æ—¶å†æ›´æ–°å›¾è¡¨
                        if (appData.processedData && appData.processedData.length > 0) {
                            // æ›´æ–°æŠ˜çº¿å›¾
                            if (typeof updateChart === 'function') {
                                updateChart();
                            }
                            
                            // æ›´æ–°æŸ±çŠ¶å›¾
                            if (typeof updateDailyTotalBarChart === 'function') {
                                updateDailyTotalBarChart(getFilteredData());
                            }
                            
                            // ç¡®ä¿æŸ±çŠ¶å›¾å®¹å™¨å¯è§
                            const barChartContainer = document.getElementById('dailyTotalBarChartContainer');
                            if (barChartContainer) {
                                barChartContainer.style.display = 'block';
                            }
                        } else {
                            console.warn('æ²¡æœ‰å¯æ˜¾ç¤ºçš„æ•°æ®');
                        }
                    }, 200);
                }
                
                // ç­‰å¾…DOMæ›´æ–°åå†è®¡ç®—ä½ç½®
                setTimeout(() => {
                    // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼Œè€ƒè™‘å›ºå®šå¯¼èˆªæ çš„åç§»
                    const offset = 80; // å¯¼èˆªæ é«˜åº¦ + ä¸€äº›é—´è·
                    const elementPosition = element.offsetTop - offset;
                    
                    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
                    window.scrollTo({
                        top: elementPosition,
                        behavior: 'smooth'
                    });
                    
                    // æ·»åŠ é«˜äº®æ•ˆæœ
                    element.style.transition = 'all 0.3s ease';
                    element.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.5)';
                    element.style.transform = 'scale(1.02)';
                    
                    // 2ç§’åç§»é™¤é«˜äº®æ•ˆæœ
                    setTimeout(() => {
                        element.style.boxShadow = '';
                        element.style.transform = 'scale(1)';
                    }, 2000);
                }, 50);
            }
            
            // æ›´æ–°æ­¥éª¤å¯¼èˆªçŠ¶æ€ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ä¸æ»šåŠ¨ç›‘å¬å†²çªï¼‰
            setTimeout(() => {
                updateStepNavigation(sectionId);
            }, 150);
        }

        // æ›´æ–°æ­¥éª¤å¯¼èˆªçŠ¶æ€
        function updateStepNavigation(activeSection) {
            const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
            const currentIndex = sections.indexOf(activeSection);
            
            // æ›´æ–°æ‰€æœ‰æ­¥éª¤å¡ç‰‡çŠ¶æ€
            sections.forEach((section, index) => {
                const card = document.getElementById(`stepCard${index + 1}`);
                if (!card) return; // å¦‚æœå¡ç‰‡ä¸å­˜åœ¨ï¼Œè·³è¿‡
                
                const icon = card.querySelector('.nav-icon');
                const label = card.querySelector('.nav-label');
                
                if (!icon || !label) return; // å¦‚æœå­å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡
                
                if (index === currentIndex) {
                    // å½“å‰æ¿€æ´»æ­¥éª¤
                    card.className = 'nav-icon-card active';
                    icon.className = 'nav-icon active';
                } else {
                    // å…¶ä»–æ‰€æœ‰æ­¥éª¤éƒ½ä¿æŒé»˜è®¤çŠ¶æ€
                    card.className = 'nav-icon-card';
                    icon.className = 'nav-icon';
                }
            });
        }

        // æ ‡è®°æ­¥éª¤ä¸ºå®Œæˆ
        function completeStep(stepNumber) {
            const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
            if (stepNumber > 0 && stepNumber <= sections.length) {
                updateStepNavigation(sections[stepNumber - 1]);
            }
        }

        // åŸå§‹æ•°æ®ä¸PVsystæ•°æ®å¯¹æ¯”é¢„è§ˆå‡½æ•°
        function updateComparisonPreview() {
            if (appData.processedData.length === 0) {
                elements.dataPreview.innerHTML = '<p class="text-neutral text-center py-4">æ²¡æœ‰å¯å¯¹æ¯”çš„æ•°æ®ï¼Œè¯·å…ˆå®Œæˆæ•°æ®é…ç½®</p>';
                return;
            }
            
            // è§£ææ•°æ®
            parseWorksheetData();
            
            if (appData.processedData.length === 0) {
                elements.dataPreview.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 px-8">
                <div class="w-16 h-16 mb-6 bg-gradient-to-br from-amber-100 to-orange-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">æš‚æ— æ•°æ®</h3>
                <p class="text-sm text-slate-500 text-center max-w-md leading-relaxed">å½“å‰é…ç½®ä¸‹æ²¡æœ‰æ‰¾åˆ°å¯é¢„è§ˆçš„æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æºæˆ–è°ƒæ•´é…ç½®å‚æ•°</p>
            </div>
        `;
                return;
            }
            
            // è·å–æ•°æ®ç»“æ„ç±»å‹
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // åˆ›å»ºåŸºäºæœˆå’Œæ—¥çš„æ•°æ®æ˜ å°„ï¼ˆå¿½ç•¥å¹´ä»½ï¼Œå¹´ä»½å›ºå®šä¸º99ï¼‰
            const dateDataMap = new Map();
            
            // æŒ‰æ—¥æœŸæ’åºï¼Œç¡®ä¿æ•°æ®æŒ‰æ—¶é—´é¡ºåºå¤„ç†
            const sortedExportData = [...appData.processedData].sort((a, b) => {
                const dateA = a.dateObj || parseDate(a.date);
                const dateB = b.dateObj || parseDate(b.date);
                return (dateA ? dateA.getTime() : 0) - (dateB ? dateB.getTime() : 0);
            });
            
            // ä½¿ç”¨æ’åºåçš„æ•°æ®æ„å»ºæ˜ å°„ï¼Œç¡®ä¿æŒ‰æ—¶é—´é¡ºåºå¤„ç†
            sortedExportData.forEach(dateData => {
                const date = dateData.dateObj || parseDate(dateData.date);
                if (!date) return;
                const monthDayKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // ç¡®ä¿hourlyDataæ˜¯24ä¸ªå…ƒç´ çš„æ•°ç»„
                if (dateData.hourlyData && Array.isArray(dateData.hourlyData) && dateData.hourlyData.length === 24) {
                    dateDataMap.set(monthDayKey, dateData.hourlyData);
                } else {
                    dateDataMap.set(monthDayKey, Array(24).fill(0));
                }
            });
            
            // ç”Ÿæˆå¯¹æ¯”é¢„è§ˆè¡¨æ ¼
            let previewHtml = `<div class="bg-purple-50 p-3 mb-3 text-sm font-medium rounded-lg shadow-sm">åŸå§‹æ•°æ®ä¸PVsystæ•°æ®å¯¹æ¯”é¢„è§ˆ</div>`;
            
            // åˆ›å»ºç»Ÿä¸€çš„è¡¨æ ¼æ ·å¼ï¼Œæ”¯æŒå®Œæ•´æ•°æ®å±•ç¤º
            previewHtml += '<div class="overflow-x-auto border border-gray-200 rounded-xl shadow-sm max-h-96 overflow-y-auto bg-white">';
            previewHtml += '<table class="w-full text-sm table-fixed" style="font-family: system-ui, -apple-system, sans-serif;">';
            previewHtml += '<thead><tr class="bg-gray-100 text-gray-800">';
            previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold" style="width: 120px;">æ—¥æœŸ</th>';
            previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">æ•°æ®ç±»å‹</th>';
            
            // ç»Ÿä¸€æ˜¾ç¤º24å°æ—¶æ•°æ®ï¼ˆåˆ—å¯¹è¡Œå’Œåˆ—å¯¹åˆ—ç»“æ„éƒ½æ˜¾ç¤º24å°æ—¶ï¼‰
            for (let hour = 0; hour < 24; hour++) {
                previewHtml += `<th class="border border-gray-300 px-3 py-2 text-center font-semibold">${hour}:00</th>`;
            }
            previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">æ—¥æ€»ç”µèƒ½ (kWh)</th>';
            previewHtml += '</tr></thead><tbody class="divide-y divide-gray-200">';
            
            // æ·»åŠ æ•°æ®è¡Œ - æ˜¾ç¤ºåŸå§‹æ•°æ®å’ŒPVsystæ•°æ®çš„å¯¹æ¯”
            const displayRows = Math.min(appData.processedData.length, 5); // é™åˆ¶æ˜¾ç¤º5å¤©çš„æ•°æ®å¯¹æ¯”
            
            for (let i = 0; i < displayRows; i++) {
                const row = appData.processedData[i];
                const date = row.dateObj || parseDate(row.date);
                if (!date) return;
                const monthDayKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // åŸå§‹æ•°æ®è¡Œ
                previewHtml += `<tr class="bg-white hover:bg-gray-100 transition-colors">`;
                previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium" rowspan="2">${row.date}</td>`;
                previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium text-blue-600">åŸå§‹æ•°æ®</td>`;
                
                let originalDayTotal = 0;
                for (let hour = 0; hour < 24; hour++) {
                        const value = row.hourlyData[hour];
                        if (value !== null && value !== undefined) {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                            originalDayTotal += value;
                        } else {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                        }
                    }
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-semibold text-blue-600">${originalDayTotal.toFixed(2)}</td>`;
                    previewHtml += '</tr>';
                    
                    // PVsystæ•°æ®è¡Œ
                    previewHtml += `<tr class="bg-gray-50 hover:bg-gray-100 transition-colors">`;
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium text-purple-600">PVsystæ•°æ®</td>`;
                    
                    // è·å–PVsystæ•°æ®
                    if (dateDataMap.has(monthDayKey)) {
                        pvsystData = [...dateDataMap.get(monthDayKey)];
                    } else {
                        // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ•°æ®ï¼Œä½¿ç”¨findNearbyDataå‡½æ•°æŸ¥æ‰¾ç›¸è¿‘æ•°æ®
                        const nearbyKey = findNearbyData(date.getMonth() + 1, date.getDate(), dateDataMap);
                        if (nearbyKey && dateDataMap.has(nearbyKey)) {
                            const originalData = dateDataMap.get(nearbyKey);
                            const variationFactor = 0.05; // 5%çš„å˜åŒ–èŒƒå›´
                            pvsystData = originalData.map(value => {
                                // æ·»åŠ éšæœºå˜åŒ–ï¼Œä½†ä¿æŒæ•°æ®çš„åŸºæœ¬æ¨¡å¼
                                const variation = 1 + (Math.random() - 0.5) * 2 * variationFactor;
                                return value * variation;
                            });
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°ç›¸è¿‘æ•°æ®ï¼Œä½¿ç”¨åŸå§‹æ•°æ®
                            pvsystData = [...row.hourlyData];
                        }
                    }
                    
                    let pvsystDayTotal = 0;
                    for (let hour = 0; hour < 24; hour++) {
                        const value = pvsystData[hour];
                        if (value !== null && value !== undefined) {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                            pvsystDayTotal += value;
                        } else {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                        }
                    }
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-semibold text-purple-600">${pvsystDayTotal.toFixed(2)}</td>`;
                    previewHtml += '</tr>';
                    
                    // PVsystæ•°æ®è¡Œ
                    previewHtml += `<tr class="bg-gray-50 hover:bg-gray-100 transition-colors">`;
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium text-purple-600">PVsystæ•°æ®</td>`;
                    
                    // è·å–PVsystæ•°æ®
                    let pvsystData;
                    if (dateDataMap.has(monthDayKey)) {
                        pvsystData = [...dateDataMap.get(monthDayKey)];
                    } else {
                        // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ•°æ®ï¼Œä½¿ç”¨findNearbyDataå‡½æ•°æŸ¥æ‰¾ç›¸è¿‘æ•°æ®
                        const nearbyKey = findNearbyData(date.getMonth() + 1, date.getDate(), dateDataMap);
                        if (nearbyKey && dateDataMap.has(nearbyKey)) {
                            const originalData = dateDataMap.get(nearbyKey);
                            const variationFactor = 0.05; // 5%çš„å˜åŒ–èŒƒå›´
                            pvsystData = originalData.map(value => {
                                // æ·»åŠ éšæœºå˜åŒ–ï¼Œä½†ä¿æŒæ•°æ®çš„åŸºæœ¬æ¨¡å¼
                                const variation = 1 + (Math.random() - 0.5) * 2 * variationFactor;
                                return value * variation;
                            });
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°ç›¸è¿‘æ•°æ®ï¼Œä½¿ç”¨åŸå§‹æ•°æ®
                            pvsystData = [...row.hourlyData];
                        }
                    }
                    
                    for (let hour = 0; hour < 24; hour++) {
                        const value = pvsystData[hour];
                        if (value !== null && value !== undefined) {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                        } else {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                        }
                    }
                    
                    previewHtml += '</tr>';
                }
            
            previewHtml += '</tbody></table></div>';
            
            // æ·»åŠ æ•°æ®ç»Ÿè®¡ä¿¡æ¯
            previewHtml += `<div class="mt-2 text-sm text-gray-600 text-center bg-gray-50 p-2 rounded">
                æ˜¾ç¤ºå‰ ${Math.min(appData.processedData.length, 5)} å¤©çš„åŸå§‹æ•°æ®ä¸PVsystæ•°æ®å¯¹æ¯”
            </div>`;
            
            elements.dataPreview.innerHTML = previewHtml;
        }
        
        // 24å°æ—¶æ•°æ®å¤„ç†å‡½æ•°
        // æŒ‰æ—¥æœŸå’Œè®¡é‡ç‚¹åˆ†ç»„æ•°æ®
        function groupDataByDateAndMeteringPoint(data) {
            const groups = {};
            
            data.forEach(row => {
                const date = row.date;
                const meteringPoint = (row.meteringPoint === undefined || row.meteringPoint === null || String(row.meteringPoint).trim() === '') ? 'é»˜è®¤è®¡é‡ç‚¹' : String(row.meteringPoint).trim();
                const key = `${date}_${meteringPoint}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        date: date,
                        meteringPoint: meteringPoint,
                        hourlyData: new Array(24).fill(null),
                        totalEnergy: 0
                    };
                }
                
                // åˆå¹¶è¯¥æ—¥æœŸè¯¥è®¡é‡ç‚¹çš„24å°æ—¶æ•°æ®
                for (let hour = 0; hour < 24; hour++) {
                    if (row.hourlyData[hour] !== null && row.hourlyData[hour] !== undefined) {
                        if (groups[key].hourlyData[hour] === null) {
                            groups[key].hourlyData[hour] = 0;
                        }
                        groups[key].hourlyData[hour] += row.hourlyData[hour];
                        groups[key].totalEnergy += row.hourlyData[hour];
                    }
                }
            });
            
            return groups;
        }
        
        // åˆ›å»º24å°æ—¶å®Œæ•´æ•°æ®é›†
        function create24HourDatasets(groupedData) {
            const datasets = [];
            let colorIndex = 0;
            
            // æŒ‰æ—¥æœŸæ’åº
            const sortedKeys = Object.keys(groupedData).sort();
            
            sortedKeys.forEach(key => {
                const data = groupedData[key];
                const color = getColor(colorIndex % getColorCount());
                colorIndex++;
                
                // ç¡®ä¿24å°æ—¶æ•°æ®å®Œæ•´
                const complete24HourData = [];
                for (let hour = 0; hour < 24; hour++) {
                    complete24HourData.push(data.hourlyData[hour] || 0);
                }
                
                const dataset = {
                    label: `${data.date} (${data.meteringPoint})`,
                    data: complete24HourData,
                    borderColor: color,
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    borderWidth: appData.visualization.lineStyle === 'thick' ? 3 : appData.visualization.lineStyle === 'thin' ? 1 : 2,
                    borderDash: appData.visualization.lineStyle === 'dashed' ? [10, 5] : 
                               appData.visualization.lineStyle === 'dotted' ? [2, 2] : 
                               appData.visualization.lineStyle === 'dashdot' ? [10, 5, 2, 5] : [],
                    pointRadius: appData.visualization.showPoints ? 3 : 0,
                    pointHoverRadius: appData.visualization.showPoints ? 5 : 0,
                    tension: appData.visualization.smoothCurve ? appData.visualization.curveTension : 0,
                    fill: false,
                    spanGaps: true
                };
                
                datasets.push(dataset);
            });
            
            return datasets;
        }
        
        // ä½¿ç”¨24å°æ—¶æ•°æ®é›†æ›´æ–°å›¾è¡¨
        function updateChartWith24HourDatasets(datasets) {
            if (!appData.chart) {
                // å¦‚æœå›¾è¡¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å›¾è¡¨
                initEmptyChart();
            }
            
            // 24å°æ—¶æ—¶é—´æ ‡ç­¾
            const hourLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            appData.chart.data.labels = hourLabels;
            appData.chart.data.datasets = datasets;
            
            // æ›´æ–°å›¾è¡¨æ ‡é¢˜
            const selectedDates = appData.visualization.selectedDates;
            const selectedMeteringPoints = appData.visualization.selectedMeteringPoints;
            appData.chart.options.plugins.title.text = 
                `24å°æ—¶è´Ÿè·æ›²çº¿ - ${selectedDates.length}ä¸ªæ—¥æœŸ Ã— ${selectedMeteringPoints.length}ä¸ªè®¡é‡ç‚¹`;
            
            // æ›´æ–°å›¾è¡¨é…ç½® - ç¡®ä¿XYè½´å§‹ç»ˆæ˜¾ç¤º
            appData.chart.options.scales.x.display = true;
            appData.chart.options.scales.y.display = true;
            appData.chart.options.scales.x.title = {
                display: true,
                text: 'æ—¶é—´ (å°æ—¶)',
                font: { size: 14, weight: 'bold' }
            };
            appData.chart.options.scales.y.title = {
                display: true,
                text: 'ç”¨ç”µé‡ (kWh)',
                font: { size: 14, weight: 'bold' }
            };
            
            // ä½¿ç”¨åŠ¨ç”»æ›´æ–°å›¾è¡¨
            updateChartWithAnimation();
            
            // éšè—åŠ è½½çŠ¶æ€
            const chartLoadingElement = document.getElementById('chartLoading');
            if (chartLoadingElement && chartLoadingElement.parentNode) {
                chartLoadingElement.classList.add('hidden');
            }
        }

        // æ·»åŠ é¡µé¢çŠ¶æ€ç›‘å¬åŠŸèƒ½
        function initPageStateListener() {
            function checkCurrentSection() {
                const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
                let currentSection = null;
                
                // æ£€æŸ¥å“ªä¸ªsectionå½“å‰æ˜¾ç¤ºï¼ˆæ²¡æœ‰hiddenç±»ï¼‰
                for (const sectionId of sections) {
                    const section = document.getElementById(sectionId);
                    if (section && !section.classList.contains('hidden')) {
                        currentSection = sectionId;
                        break;
                    }
                }
                
                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                if (currentSection) {
                    updateStepNavigation(currentSection);
                }
            }
            
            // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        // å½“classå±æ€§å˜åŒ–æ—¶ï¼Œæ£€æŸ¥å½“å‰æ˜¾ç¤ºçš„section
                        checkCurrentSection();
                    }
                });
            });
            
            // ç›‘å¬æ‰€æœ‰sectionçš„classå˜åŒ–
            const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    observer.observe(section, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }
            });
            
            // åˆå§‹æ£€æŸ¥
            checkCurrentSection();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é¡µé¢çŠ¶æ€ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            initPageStateListener();
            

        });

    </script>
</body></html>
