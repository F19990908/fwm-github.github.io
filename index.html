<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24小时负荷曲线生成工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        neutral: '#86909C',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#F5222D',
                        light: '#F2F3F5',
                        dark: '#1D2129'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
        }
        
        /* 确保canvas填充整个容器 */
        #chartContainer canvas, #barChartContainer canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* 数据预览表格样式优化 */
        #dataPreview table {
            border-collapse: collapse;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #dataPreview th {
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            font-weight: 600;
            color: #1e293b;
            font-size: 0.875rem;
            letter-spacing: 0.025em;
        }
        
        #dataPreview td {
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: background-color 150ms ease-in-out;
        }
        
        #dataPreview tr:hover {
            background-color: #f8fafc;
            transition: background-color 150ms ease-in-out;
        }
        
        #dataPreview tr:nth-child(even) {
            background-color: #fafbfc;
        }
        
        #dataPreview tr:nth-child(even):hover {
            background-color: #f1f5f9;
        }
        
        #dataPreview .selected-row {
            background-color: #dbeafe !important;
            border-left: 3px solid #3b82f6;
        }
        
        /* 可折叠面板样式 */
        .toggle-panel {
            user-select: none;
        }
        
        .toggle-panel:hover {
            background-color: #e5e7eb;
        }
        
        .panel-content {
            transition: all 0.3s ease;
        }
        
        /* 文字居中样式 */
        .text-center-div {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 表头冻结样式 */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* 卡片标题栏样式 */
        .card-header {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 16px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-header:hover {
            background-color: #f3f4f6;
        }
        
        .card-content {
            padding: 20px;
        }
        
        /* 下拉箭头动画 */
        .fa-chevron-down {
            transition: transform 0.2s ease;
        }
        
        /* 响应式居中 */
        @media (max-width: 768px) {
            .text-center-div {
                text-align: center;
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <!-- 访问验证遮罩层 -->
    <div id="accessProtectionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full bg-primary flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-lock text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">访问验证</h2>
                <p class="text-gray-600">请输入邀请码以访问负荷曲线分析工具</p>
            </div>
            
            <form id="accessForm" class="space-y-4">
                <div>
                    <label for="invitationCode" class="block text-sm font-medium text-gray-700 mb-2">邀请码</label>
                    <input type="password" 
                           id="invitationCode" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-center text-lg tracking-wider"
                           placeholder="请输入邀请码"
                           maxlength="8"
                           autocomplete="off">
                    <p id="errorMessage" class="text-red-500 text-sm mt-1 hidden">邀请码错误，请重试</p>
                </div>
                
                <button type="submit" 
                        class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-all-300 font-medium">
                    <i class="fa fa-unlock mr-2"></i>验证并访问
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    <i class="fa fa-info-circle mr-1"></i>
                    没有邀请码？请联系管理员获取访问权限
                </p>
            </div>
        </div>
    </div>
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa fa-line-chart text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">24小时负荷曲线生成工具</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="helpBtn" class="text-neutral hover:text-primary transition-all-300 flex items-center">
                    <i class="fa fa-question-circle mr-1"></i>
                    <span class="hidden md:inline">帮助</span>
                </button>
                <button id="aboutBtn" class="text-neutral hover:text-primary transition-all-300 flex items-center">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span class="hidden md:inline">关于</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 步骤指示器 -->
        <div class="flex flex-wrap justify-between items-center mb-10 bg-white rounded-xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-lg shadow-md">1</div>
                    <div class="w-16 h-1 bg-primary ml-3"></div>
                </div>
                <div class="flex items-center">
                    <div id="step2Indicator" class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-lg shadow-md">2</div>
                    <div id="step2Line" class="w-16 h-1 bg-gray-200 ml-3"></div>
                </div>
                <div class="flex items-center">
                    <div id="step3Indicator" class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-lg shadow-md">3</div>
                    <div id="step3Line" class="w-16 h-1 bg-gray-200 ml-3"></div>
                </div>
                <div class="flex items-center">
                    <div id="step4Indicator" class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-lg shadow-md">4</div>
                </div>
            </div>
            <div class="flex items-center text-sm font-medium text-gray-600 space-x-8">
                <span class="flex items-center"><i class="fa fa-upload text-primary mr-2"></i>导入数据</span>
                <span class="flex items-center"><i class="fa fa-cogs text-gray-400 mr-2"></i>数据配置</span>
                <span class="flex items-center"><i class="fa fa-chart-line text-gray-400 mr-2"></i>可视化</span>
                <span class="flex items-center"><i class="fa fa-download text-gray-400 mr-2"></i>导出结果</span>
            </div>
        </div>

        <!-- 第一部分：文件导入 -->
        <section id="importSection" class="mb-8">
            <div class="bg-white rounded-xl p-8 shadow-lg border border-gray-100 hover:shadow-xl transition-all-300">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-upload text-primary mr-2"></i>数据导入
                </h2>
                
                <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center mb-8 hover:border-primary hover:bg-primary/5 transition-all-300 cursor-pointer bg-gray-50/50">
                    <div class="flex flex-col items-center">
                        <div class="w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mb-4">
                            <i class="fa fa-file-excel-o text-4xl text-primary"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">上传数据文件</h3>
                        <p class="text-gray-500 mb-4">拖放文件到此处，或点击选择文件</p>
                        <button class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/90 transition-all-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 active:scale-95">
                        <i class="fa fa-folder-open mr-2"></i>选择文件
                    </button>
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv" multiple="">
                        <p class="text-xs text-gray-400 mt-4">支持 Excel (.xlsx, .xls) 和 CSV 格式文件</p>
                    </div>
                </div>
                
                <div id="fileList" class="hidden">
                    <h3 class="font-medium mb-2">已导入文件：</h3>
                    <ul id="importedFiles" class="space-y-2 max-h-40 overflow-y-auto scrollbar-hide"></ul>
                    <button id="removeAllFiles" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded hover:bg-gray-300 transition-all-300 hidden">
                    <i class="fa fa-trash mr-1"></i>删除全部文件
                </button>
                    
                    <!-- 数据状态显示 -->
                    <div id="dataStatus" class="mt-3 p-2 bg-gray-50 rounded text-sm hidden">
                        <div class="flex justify-between">
                            <span>当前数据量：</span>
                            <span id="currentDataCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>日期范围：</span>
                            <span id="currentDateRange">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>计量点数量：</span>
                            <span id="currentMeteringPointCount">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 导入历史记录部分 -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium">导入历史记录</h3>
                        <button id="clearHistoryBtn" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded hover:bg-gray-300 transition-all-300">
                            <i class="fa fa-trash-o mr-1"></i>清空历史
                        </button>
                    </div>
                    <div id="importHistory" class="border border-gray-200 rounded-lg p-3 max-h-40 overflow-y-auto scrollbar-hide">
                        <p class="text-neutral text-sm text-center py-4">暂无导入历史记录</p>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button id="nextToConfigBtn" class="bg-primary text-white px-6 py-2 rounded hover:bg-primary/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled="">
                        下一步：数据配置 <i class="fa fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 第二部分：数据配置 -->
        <section id="configSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-100 hover:shadow-xl transition-all-300">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fa fa-cogs text-primary mr-3"></i>数据配置
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- 左侧配置 -->
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-xl p-5">
                            <h3 class="text-base font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fa fa-database mr-2 text-primary"></i>数据类型
                            </h3>
                            <div class="flex space-x-6">
                                <label class="inline-flex items-center cursor-pointer group">
            <input type="radio" name="dataType" value="instantPower" class="form-radio text-primary w-4 h-4" checked="">
            <span class="ml-3 text-sm font-medium text-gray-700 group-hover:text-primary">瞬时功率 (kW)</span>
        </label>
        <label class="inline-flex items-center cursor-pointer group">
            <input type="radio" name="dataType" value="cumulativeEnergy" class="form-radio text-primary w-4 h-4">
            <span class="ml-3 text-sm font-medium text-gray-700 group-hover:text-primary">累积电能 (kWh)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-5">
                            <h3 class="text-base font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fa fa-table mr-2 text-primary"></i>数据结构
                            </h3>
                            <div class="space-y-3">
                                <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-gray-100 transition-colors">
                                    <input type="radio" name="dataStructure" value="columnToRow" class="form-radio text-primary w-4 h-4" checked>
                                    <span class="ml-3 text-sm font-medium text-gray-700">列对行（日期列对多数据列）</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-gray-100 transition-colors">
                                    <input type="radio" name="dataStructure" value="columnToColumn" class="form-radio text-primary w-4 h-4">
                                    <span class="ml-3 text-sm font-medium text-gray-700">列对列（日期列对单数据列）</span>
                                </label>
                            </div>
                        </div>
                        

                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="advanced">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-sliders mr-2 text-primary"></i>高级设置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="advanced-panel">
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="crossDateStructure" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="ml-2 text-sm font-medium text-gray-700">跨日期结构数据</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">启用后，将根据日期列中相同日期对应的单元格数量判断时间间隔</p>
                                </div>
                                
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="appendMode" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="ml-2 text-sm font-medium text-gray-700">追加模式（保留已导入的数据）</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">启用后，新导入的数据将追加到现有数据中，不会清除之前的数据</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-3">倍率设置</label>
                                    <div class="space-y-3">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" id="useMultiplierColumn" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                            <label for="useMultiplierColumn" class="text-sm font-medium text-gray-700">使用倍率列</label>
                                        </div>
                                        <div id="multiplierOptions" class="space-y-3">
                                            <input type="number" id="multiplier" value="1.0" step="0.01" min="0.01" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                            <p class="text-xs text-gray-500">所有计算结果将乘以该倍率后展示</p>
                                        </div>
                                        <div id="multiplierColumnOption" class="hidden space-y-2">
                                            <label for="multiplierColumn" class="block text-sm font-medium text-gray-700">倍率列</label>
                                            <select id="multiplierColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                                <option value="">-- 请选择 --</option>
                                            </select>
                                            <p class="text-xs text-gray-500">计算结果将乘以该列对应的数值</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="date">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-calendar-alt mr-2 text-primary"></i>日期配置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="date-panel">
                                <div>
                                    <label for="dateColumn" class="block text-sm font-semibold text-gray-700 mb-2">日期所在列</label>
                                    <select id="dateColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="">-- 请选择 --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="columns">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-columns mr-2 text-primary"></i>列配置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="columns-panel">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">数据起始列</label>
                                    <select id="dataStartColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="">-- 请选择 --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">数据结束列</label>
                                    <select id="dataEndColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="">-- 请选择 --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">将从起始列到结束列的所有列作为数据</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="index">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-calendar mr-2 text-primary"></i>数据索引范围
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="index-panel">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label for="dataStartDate" class="block text-xs font-medium text-gray-600 mb-1">起始日期</label>
                                        <select id="dataStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                            <option value="">-- 请选择起始日期 --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dataEndDate" class="block text-xs font-medium text-gray-600 mb-1">结束日期</label>
                                        <select id="dataEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                            <option value="">-- 请选择结束日期 --</option>
                                        </select>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500">选择起始和结束日期，系统将根据这两个日期所确定的行范围进行索引定位</p>
                                <button id="clearDateSelection" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300 transition-all-300">
                                    <i class="fa fa-times mr-1"></i>清除选择
                                </button>
                            </div>
                        </div>
                        
                        
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="filter">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-filter mr-2 text-primary"></i>筛选配置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="filter-panel">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="meteringPointColumn" class="block text-sm font-semibold text-gray-700">计量点编号所在列</label>
                                        <button id="clearMeteringPointColumn" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300 transition-all-300">
                                            <i class="fa fa-times mr-1"></i>清除
                                        </button>
                                    </div>
                                    <select id="meteringPointColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="">-- 请选择 --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label for="meteringPointFilter" class="block text-sm font-semibold text-gray-700">计量点编号筛选</label>
                                        <button id="clearMeteringPointFilter" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300 transition-all-300">
                                            <i class="fa fa-times mr-1"></i>清除
                                        </button>
                                    </div>
                                    <select id="meteringPointFilter" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="">-- 全部计量点 --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">选择要处理的计量点编号，仅处理与所选计量点编号匹配的数据</p>
                                </div>
                                
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700">筛选项设置</label>
                                        <button id="clearAllFilters" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300 transition-all-300">
                                            <i class="fa fa-times mr-1"></i>清除全部
                                        </button>
                                    </div>
                                    <div class="flex items-center space-x-3 mb-2">
                                        <label for="filterCount" class="text-sm font-medium text-gray-600">筛选项数量：</label>
                                        <input type="number" id="filterCount" value="1" min="1" max="5" class="w-16 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                                        <button id="applyFilterCount" class="text-sm bg-primary text-white px-3 py-2 rounded-lg hover:bg-primary/90">
                                            应用
                                        </button>
                                    </div>
                                    <div id="filterOptionsContainer" class="space-y-3">
                                        <!-- 筛选项将动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧配置 -->
                    <div>
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="settings">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-cog mr-2 text-primary"></i>处理设置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="settings-panel">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">日期格式</label>
                                    <select id="dateFormat" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="YYYY-MM-DD">YYYY-MM-DD (例: 2024-10-01)</option>
                                        <option value="YYYY/MM/DD">YYYY/MM/DD (例: 2024/10/01)</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY (例: 10/01/2024)</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY (例: 01/10/2024)</option>
                                    </select>
                                </div>
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="config">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-cogs mr-2 text-primary"></i>处理配置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="config-panel">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">无效数据处理方式</label>
                                    <select id="invalidDataHandling" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="ignore">忽略该点</option>
                                        <option value="fill">用相邻有效数据填充</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">时间间隔（分钟）</label>
                                    <select id="timeInterval" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm">
                                        <option value="1">1分钟</option>
                                        <option value="5">5分钟</option>
                                        <option value="15" selected="">15分钟</option>
                                        <option value="30">30分钟</option>
                                        <option value="60">60分钟</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="preview">
                                <h3 class="text-base font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-eye mr-2 text-primary"></i>数据预览
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="preview-panel">
                                <div id="dataPreview" class="border border-gray-200 rounded-lg shadow-sm bg-white min-h-32 overflow-hidden">
                                    <p class="text-gray-500 text-center py-12 text-sm">请先完成数据配置，将显示数据预览</p>
                                </div>
                                <div class="space-y-2">
                                    <button id="previewFirstHourCalculation" class="w-full bg-secondary text-white px-4 py-2.5 rounded-lg hover:bg-secondary/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled>
                                        <i class="fa fa-calculator mr-2"></i>预览第一个小时计算过程
                                    </button>
                                    <button id="previewFirstDayCalculation" class="w-full bg-accent text-white px-4 py-2.5 rounded-lg hover:bg-accent/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled>
                                        <i class="fa fa-calendar-day mr-2"></i>预览第一天计算过程
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button id="backToImportBtn" class="border border-gray-300 text-gray-700 px-6 py-2 rounded hover:bg-gray-50 transition-all-300">
                        <i class="fa fa-arrow-left mr-1"></i> 上一步
                    </button>
                    <button id="nextToVisualizationBtn" class="bg-primary text-white px-6 py-2 rounded hover:bg-primary/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled="">
                        下一步：可视化 <i class="fa fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 第三部分：可视化 -->
        <section id="visualizationSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-6 md:p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all-300">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fa fa-bar-chart text-primary mr-3 text-2xl"></i>负荷曲线可视化
                </h2>
                
                <!-- 筛选和控制区域 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <label class="block text-sm font-semibold mb-3 text-gray-700">日期范围筛选</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="startDate" class="block text-xs font-medium text-gray-600 mb-1">起始日期</label>
                                <select id="startDate" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="">-- 请选择起始日期 --</option>
                                </select>
                            </div>
                            <div>
                                <label for="endDate" class="block text-xs font-medium text-gray-600 mb-1">结束日期</label>
                                <select id="endDate" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="">-- 请选择结束日期 --</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-3">
                            <button id="applyDateFilter" class="text-xs bg-primary text-white px-3 py-2 rounded-lg hover:bg-primary/90 transition-all-300 font-medium">
                                应用筛选
                            </button>
                            <button id="selectAllDates" class="text-xs bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-all-300 font-medium">
                                <i class="fa fa-check-square mr-1"></i>全选
                            </button>
                            <button id="deselectAllDates" class="text-xs bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-all-300 font-medium">
                                <i class="fa fa-square-o mr-1"></i>取消全选
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <label class="block text-sm font-semibold mb-3 text-gray-700">时段聚焦</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="focusStartTime" class="block text-xs font-medium text-gray-600 mb-1">开始时间</label>
                                <select id="focusStartTime" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="0">0:00</option>
                                    <option value="1">1:00</option>
                                    <option value="2">2:00</option>
                                    <option value="3">3:00</option>
                                    <option value="4">4:00</option>
                                    <option value="5">5:00</option>
                                    <option value="6">6:00</option>
                                    <option value="7">7:00</option>
                                    <option value="8">8:00</option>
                                    <option value="9">9:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                            </div>
                            <div>
                                <label for="focusEndTime" class="block text-xs font-medium text-gray-600 mb-1">结束时间</label>
                                <select id="focusEndTime" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="0">0:00</option>
                                    <option value="1">1:00</option>
                                    <option value="2">2:00</option>
                                    <option value="3">3:00</option>
                                    <option value="4">4:00</option>
                                    <option value="5">5:00</option>
                                    <option value="6">6:00</option>
                                    <option value="7">7:00</option>
                                    <option value="8">8:00</option>
                                    <option value="9">9:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23" selected="">23:00</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-3">
                            <button id="applyTimeFocus" class="text-xs bg-primary text-white px-3 py-2 rounded-lg hover:bg-primary/90 transition-all-300 font-medium">
                                应用时段
                            </button>
                            <button id="resetTimeFocus" class="text-xs bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-all-300 font-medium">
                                <i class="fa fa-refresh mr-1"></i>重置为全天
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <label class="block text-sm font-semibold mb-3 text-gray-700">曲线样式设置</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="lineStyle" class="block text-xs font-medium text-gray-600 mb-1">线条样式</label>
                                <select id="lineStyle" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="solid">实线</option>
                                    <option value="dashed">虚线</option>
                                    <option value="dotted">点线</option>
                                    <option value="dashdot">点划线</option>
                                </select>
                            </div>
                            <div>
                                <label for="showPoints" class="block text-xs font-medium text-gray-600 mb-1">显示数据点</label>
                                <select id="showPoints" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="true">是</option>
                                    <option value="false">否</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div>
                                <label for="smoothCurve" class="block text-xs font-medium text-gray-600 mb-1">平滑曲线</label>
                                <select id="smoothCurve" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="false">否</option>
                                    <option value="true">是</option>
                                </select>
                            </div>
                            <div>
                                <label for="curveTension" class="block text-xs font-medium text-gray-600 mb-1">曲线平滑度</label>
                                <select id="curveTension" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                                    <option value="0.1">低</option>
                                    <option value="0.2" selected>中</option>
                                    <option value="0.4">高</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="secondaryAxis" class="inline-flex items-center text-sm font-medium text-gray-700">
                                <input type="checkbox" id="secondaryAxis" class="form-checkbox text-primary rounded">
                                <span class="ml-2">显示辅助Y轴（功率 kW）</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <label class="block text-sm font-semibold mb-3 text-gray-700">计量点编号筛选</label>
                        <select id="visualizationMeteringPointFilter" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm mb-3 focus:ring-2 focus:ring-primary/20 focus:border-primary bg-white">
                            <option value="">-- 全部计量点 --</option>
                        </select>
                        <div class="flex space-x-2">
                            <button id="applyMeteringPointFilter" class="text-xs bg-primary text-white px-3 py-2 rounded-lg hover:bg-primary/90 transition-all-300 font-medium">
                                应用筛选
                            </button>
                            <button id="selectAllMeteringPoints" class="text-xs bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-all-300 font-medium">
                                <i class="fa fa-check-square mr-1"></i>全选
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4 bg-gradient-to-r from-blue-50 to-indigo-100 rounded-xl p-4 border border-blue-200 shadow-sm">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-chart-line text-blue-600 mr-3"></i>
                            24小时负荷曲线
                        </h3>
                        <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="toggleCurveLegend" class="form-checkbox text-blue-600 mr-2 rounded" checked>
                            <label for="toggleCurveLegend" class="text-sm font-medium text-gray-700">显示图例</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="enableAnimation" class="form-checkbox text-blue-600 mr-2 rounded" checked>
                            <label for="enableAnimation" class="text-sm font-medium text-gray-700">动画效果</label>
                        </div>
                    </div>
                    </div>
                    <div class="relative h-[450px] md:h-[550px] lg:h-[650px] bg-white rounded-2xl border border-gray-200 shadow-xl overflow-hidden" id="chartContainer">
                        <canvas id="loadCurveChart" class="w-full h-full rounded-2xl cursor-crosshair" style="background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);"></canvas>
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm rounded-lg p-3 shadow-lg border border-gray-200" id="curveLegendContainer" style="display: none;">
                            <div class="flex items-center mb-2">
                                <div class="w-4 h-0.5 bg-blue-600 mr-2 rounded"></div>
                                <span class="text-sm font-medium text-gray-700">负荷曲线</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-0.5 bg-green-500 mr-2 rounded" style="display: none;"></div>
                                <span class="text-sm font-medium text-gray-700" style="display: none;">辅助Y轴</span>
                            </div>
                        </div>
                        <div id="chartLoading" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center bg-white p-8 rounded-xl shadow-2xl">
                                <i class="fas fa-circle-notch fa-spin text-5xl text-blue-600 mb-4"></i>
                                <p class="text-gray-700 font-semibold text-lg">正在生成图表...</p>
                                <p class="text-sm text-gray-500 mt-2">正在处理数据，请稍候...</p>
                            </div>
                        </div>
                        <div id="noDataMessage" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center p-8">
                                <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-600 font-semibold text-xl mb-2">暂无数据</p>
                                <p class="text-gray-500">请检查筛选条件或重新加载数据</p>
                            </div>
                        </div>
                        <div id="chartTooltip" class="absolute bg-gray-900/90 backdrop-blur-sm text-white px-4 py-3 rounded-xl shadow-2xl text-sm hidden z-20 pointer-events-none border border-gray-700">
                            <div class="font-semibold text-base mb-1" id="tooltipTitle"></div>
                            <div class="text-xs text-gray-300" id="tooltipValue"></div>
                            <div class="text-xs text-blue-400 mt-1" id="tooltipTime"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 日期总用电量柱状图 -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4 bg-gradient-to-r from-green-50 to-emerald-100 rounded-xl p-4 border border-green-200 shadow-sm">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-chart-bar text-green-600 mr-3"></i>
                            日期总用电量柱状图
                        </h3>
                        <div class="flex items-center">
                            <div class="flex items-center">
                                <input type="checkbox" id="enableBarAnimation" class="form-checkbox text-green-600 mr-2 rounded" checked>
                                <label for="enableBarAnimation" class="text-sm font-medium text-gray-700">动画效果</label>
                            </div>
                        </div>
                    </div>
                    <div class="relative h-[400px] md:h-[500px] lg:h-[500px] bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden" id="barChartContainer">
                        <canvas id="dailyTotalBarChart" class="w-full h-full rounded-2xl cursor-crosshair"></canvas>
                        <div id="barChartLoading" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center bg-white p-8 rounded-xl shadow-2xl">
                                <i class="fas fa-circle-notch fa-spin text-5xl text-primary mb-4"></i>
                                <p class="text-gray-700 font-semibold text-lg">正在生成图表...</p>
                                <p class="text-sm text-gray-500 mt-2">正在处理数据，请稍候...</p>
                            </div>
                        </div>
                        <div id="barChartNoDataMessage" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center p-8">
                                <i class="fas fa-chart-bar text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-600 font-semibold text-xl mb-2">暂无数据</p>
                                <p class="text-gray-500">请检查筛选条件或重新加载数据</p>
                            </div>
                        </div>
                        <div id="barChartTooltip" class="absolute bg-gray-900 text-white px-3 py-2 rounded-lg shadow-xl text-sm hidden z-10 pointer-events-none">
                            <div class="font-medium" id="barTooltipTitle"></div>
                            <div class="text-xs text-gray-300" id="barTooltipValue"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-line text-primary mr-3"></i>
                        统计信息
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-all-300">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fas fa-calendar-alt text-primary mr-2"></i>
                                日期统计详情
                            </h4>
                            <div id="dailyStats" class="bg-gray-50 rounded-lg border border-gray-200 max-h-60 overflow-y-auto p-4 text-sm">
                                <div class="text-center py-8">
                                    <i class="fas fa-chart-bar text-4xl text-gray-300 mb-3"></i>
                                    <p class="text-gray-600 font-medium">请先生成图表以查看统计信息</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-all-300">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fas fa-clock text-primary mr-2"></i>
                                时段统计对比
                            </h4>
                            <div id="periodStats" class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                                <div class="overflow-x-auto">
                                    <table class="w-full border-collapse">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-sm text-gray-700">日期</th>
                                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-sm text-gray-700">用电量</th>
                                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-sm text-gray-700">全天百分比</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                                <div class="text-center py-6">
                                    <i class="fas fa-table text-3xl text-gray-300 mb-2"></i>
                                    <p class="text-gray-600 font-medium">请先生成图表以查看统计信息</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button id="backToConfigBtn" class="border border-gray-300 text-gray-700 px-8 py-3 rounded-lg hover:bg-gray-50 transition-all-300 font-medium text-base">
                        <i class="fa fa-arrow-left mr-2"></i> 上一步
                    </button>
                    <button id="nextToExportBtn" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed font-medium text-base" disabled="">
                        下一步：导出结果 <i class="fa fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 第四部分：导出 -->
        <section id="exportSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-download text-primary mr-3"></i>
                    结果导出
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-image text-primary mr-2"></i>
                            图表导出
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <button id="exportPNG" class="flex-1 bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium">
                                    <i class="fas fa-file-image mr-2"></i>导出为PNG
                                </button>
                                <select id="pngQuality" class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-28 bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                    <option value="0.7">质量: 70%</option>
                                    <option value="0.8">质量: 80%</option>
                                    <option value="0.9" selected="">质量: 90%</option>
                                    <option value="1.0">质量: 100%</option>
                                </select>
                            </div>
                            <button id="exportJPG" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium">
                                <i class="fas fa-file-image mr-2"></i>导出为JPG
                            </button>
                            <button id="exportSVG" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium">
                                <i class="fas fa-file-image mr-2"></i>导出为SVG
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-table text-primary mr-2"></i>
                            数据导出
                        </h3>
                        <div class="space-y-4">
                            <button id="exportHourlyData" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium">
                                <i class="fas fa-file-excel mr-2"></i>导出24小时电能明细
                            </button>
                            <button id="exportDailyStats" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium">
                                <i class="fas fa-file-excel mr-2"></i>导出日统计数据
                            </button>
                            <div class="mt-2">
                                <label for="exportFormat" class="block text-sm font-semibold text-gray-700 mb-2">导出格式</label>
                                <select id="exportFormat" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary">
                                    <option value="xlsx">Excel (.xlsx)</option>
                                    <option value="csv">CSV (.csv)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-8 mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-cog text-primary mr-2"></i>
                        导出设置
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="exportFileName" class="block text-sm font-semibold text-gray-700 mb-2">文件名前缀</label>
                            <input type="text" id="exportFileName" value="负荷曲线数据" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary">
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="includeTimestamp" class="inline-flex items-center text-sm">
                                <input type="checkbox" id="includeTimestamp" class="form-checkbox text-primary rounded" checked="">
                                <span class="ml-2 font-medium text-gray-700">文件名包含时间戳</span>
                            </label>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="includeFiltersInName" class="inline-flex items-center text-sm">
                                <input type="checkbox" id="includeFiltersInName" class="form-checkbox text-primary rounded">
                                <span class="ml-2 font-medium text-gray-700">包含筛选条件</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 日期范围选择器 -->
                    <div class="mt-6 bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-calendar-range text-primary mr-2"></i>
                            24小时数据导出日期范围
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="exportStartDate" class="block text-sm font-semibold text-gray-700 mb-2">开始日期</label>
                                <input type="date" id="exportStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary">
                            </div>
                            <div>
                                <label for="exportEndDate" class="block text-sm font-semibold text-gray-700 mb-2">结束日期</label>
                                <input type="date" id="exportEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary">
                            </div>
                            <div>
                                <label for="exportAllDates" class="inline-flex items-center text-sm mt-8">
                                    <input type="checkbox" id="exportAllDates" class="form-checkbox text-primary rounded" checked="">
                                    <span class="ml-2 font-medium text-gray-700">导出所有日期</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-8">
                    <button id="backToVisualizationBtn" class="border border-gray-300 text-gray-700 px-8 py-3 rounded-lg hover:bg-gray-50 transition-all-300 font-medium text-base">
                        <i class="fas fa-arrow-left mr-2"></i> 上一步
                    </button>
                    <button id="startOverBtn" class="bg-accent text-white px-8 py-3 rounded-lg hover:bg-accent/90 transition-all-300 font-medium text-base">
                        重新开始 <i class="fas fa-refresh ml-2"></i>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- 通知组件 -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all-300 flex items-center max-w-sm hidden">
        <i id="notificationIcon" class="mr-2 text-xl"></i>
        <div>
            <h3 id="notificationTitle" class="font-medium"></h3>
            <p id="notificationMessage" class="text-sm text-gray-600"></p>
        </div>
        <button id="closeNotification" class="ml-4 text-gray-400 hover:text-gray-600">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- 模态框 -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div id="modal" class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-semibold"></h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="p-5">
                <!-- 模态框内容将通过JS填充 -->
            </div>
        </div>
    </div>

    <!-- 第一个小时计算过程预览模态框 -->
    <div id="firstHourCalculationModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">第一个小时计算过程预览</h3>
                <button id="closeFirstHourCalculationModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">基本信息</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-neutral">日期：</span>
                            <span id="previewDate" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">时间间隔：</span>
                            <span id="previewInterval" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">数据类型：</span>
                            <span id="previewDataType" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">倍率：</span>
                            <span id="previewMultiplier" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">原始数据（第一个小时）</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewRawData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">清洗后数据</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewCleanedData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">计算过程</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50">
                        <div id="previewCalculationProcess" class="text-sm">-</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">计算结果</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border border-gray-200 rounded p-3 bg-primary/5">
                            <div class="text-neutral text-sm">第一个小时电能值</div>
                            <div id="previewResult" class="text-xl font-bold text-primary">-</div>
                        </div>
                        <div class="border border-gray-200 rounded p-3 bg-secondary/5">
                            <div class="text-neutral text-sm">计算公式</div>
                            <div id="previewFormula" class="text-sm font-medium text-secondary">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第一天计算过程预览模态框 -->
    <div id="firstDayCalculationModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">第一天计算过程预览</h3>
                <button id="closeFirstDayCalculationModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">基本信息</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-neutral">日期：</span>
                            <span id="previewFirstDayDate" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">时间间隔：</span>
                            <span id="previewFirstDayInterval" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">数据类型：</span>
                            <span id="previewFirstDayDataType" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">倍率：</span>
                            <span id="previewFirstDayMultiplier" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">原始数据（第一天）</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewFirstDayRawData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">清洗后数据</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewFirstDayCleanedData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">计算过程</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50">
                        <div id="previewFirstDayCalculationProcess" class="text-sm">-</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">计算结果</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border border-gray-200 rounded p-3 bg-primary/5">
                            <div class="text-neutral text-sm">第一天总电能值</div>
                            <div id="previewFirstDayResult" class="text-xl font-bold text-primary">-</div>
                        </div>
                        <div class="border border-gray-200 rounded p-3 bg-secondary/5">
                            <div class="text-neutral text-sm">计算公式</div>
                            <div id="previewFirstDayFormula" class="text-sm font-medium text-secondary">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史记录详情模态框 -->
    <div id="historyDetailModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">导入历史详情</h3>
                <button id="closeHistoryDetailModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="historyDetailContent" class="p-5">
                <!-- 历史记录详情将通过JS填充 -->
            </div>
        </div>
    </div>

    <!-- 时段统计对比表格窗口 - 可拖动版本 -->
    <div id="timeSlotComparisonWindow" class="fixed z-50 hidden" style="top: 100px; left: 100px; min-width: 600px;">
        <div class="bg-white rounded-lg shadow-2xl border border-gray-200">
            <!-- 标题栏 - 拖动区域 -->
            <div id="timeSlotComparisonHeader" class="px-4 py-3 bg-gray-100 border-b border-gray-200 rounded-t-lg cursor-move flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">时段统计对比</h3>
                <div class="flex items-center space-x-2">
                    <button id="minimizeTimeSlotComparison" class="text-gray-500 hover:text-gray-700" title="最小化">
                        <i class="fa fa-window-minimize"></i>
                    </button>
                    <button id="closeTimeSlotComparison" class="text-gray-500 hover:text-gray-700" title="关闭">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- 内容区域 -->
            <div id="timeSlotComparisonContent" class="p-4 max-h-96 overflow-y-auto">
                <!-- 时段选择 -->
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">开始时段</label>
                        <select id="timeSlotStart" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="0">00:00</option>
                            <option value="1">01:00</option>
                            <option value="2">02:00</option>
                            <option value="3">03:00</option>
                            <option value="4">04:00</option>
                            <option value="5">05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23">23:00</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">结束时段</label>
                        <select id="timeSlotEnd" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="0">00:00</option>
                            <option value="1">01:00</option>
                            <option value="2">02:00</option>
                            <option value="3">03:00</option>
                            <option value="4">04:00</option>
                            <option value="5">05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23" selected>23:00</option>
                        </select>
                    </div>
                </div>

                <!-- 统计表格 -->
                <div class="overflow-x-auto">
                    <table id="timeSlotComparisonTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时段用电量</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">对比</th>
                            </tr>
                        </thead>
                        <tbody id="timeSlotComparisonTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>

                <!-- 统计汇总 -->
                <div id="timeSlotSummary" class="mt-4 p-3 bg-gray-50 rounded-md">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">时段统计汇总</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">平均用电量：</span>
                            <span id="timeSlotAvg" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">最大用电量：</span>
                            <span id="timeSlotMax" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">最小用电量：</span>
                            <span id="timeSlotMin" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">总用电量：</span>
                            <span id="timeSlotTotal" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局数据存储
        const appData = {
            files: [],
            worksheets: [],
            parsedData: [],
            processedData: [],
            config: {
                dataType: 'instantPower',
                multiplier: 1.0,
                useMultiplierColumn: false,
                multiplierColumn: '',
                dateColumn: '',
                useDateRange: false,
                dataStartColumn: '',
                dataEndColumn: '',
                dataStartIndex: 0,
                dataEndIndex: -1,
                meteringPointColumn: '',
                meteringPointFilter: '',
                dateFormat: 'YYYY-MM-DD',
                invalidDataHandling: 'ignore',
                timeInterval: 15,
                filterCount: 1,
                additionalFilters: []
            },
            visualization: {
        selectedDates: [],
        selectedMeteringPoints: [],
        focusStartTime: 0,
        focusEndTime: 23,
        lineStyle: 'solid',
        showPoints: true,
        secondaryAxis: false,
        smoothCurve: false,
        curveTension: 0.2,
        showDailyTotalBarChart: true
    },
            // 日期选择相关
            dateSelectionMode: null, // 'start', 'end', or null
            selectedStartDate: null, // YYYY-MM-DD格式
            selectedEndDate: null,   // YYYY-MM-DD格式
            chart: null,
            dailyTotalChart: null, // 存储日期总用电量图表引用
            meteringPoints: [], // 存储所有计量点编号
            importHistory: [] // 存储导入历史记录
        };

        // DOM 元素
        const elements = {
            // 步骤指示器
            step2Indicator: document.getElementById('step2Indicator'),
            step2Line: document.getElementById('step2Line'),
            step3Indicator: document.getElementById('step3Indicator'),
            step3Line: document.getElementById('step3Line'),
            step4Indicator: document.getElementById('step4Indicator'),
            
            // 导入部分
            dropArea: document.getElementById('dropArea'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            importedFiles: document.getElementById('importedFiles'),
            removeAllFiles: document.getElementById('removeAllFiles'),
            nextToConfigBtn: document.getElementById('nextToConfigBtn'),
            
            // 配置部分
            dataTypeRadios: document.querySelectorAll('input[name="dataType"]'),
            multiplierInput: document.getElementById('multiplier'),
            useMultiplierColumnCheckbox: document.getElementById('useMultiplierColumn'),
            multiplierOptions: document.getElementById('multiplierOptions'),
            multiplierColumnOption: document.getElementById('multiplierColumnOption'),
            multiplierColumnSelect: document.getElementById('multiplierColumn'),

            dataStartDate: document.getElementById('dataStartDate'),
            dataEndDate: document.getElementById('dataEndDate'),
            clearDateSelectionBtn: document.getElementById('clearDateSelection'),
            useMultiplierColumnCheckbox: document.getElementById('useMultiplierColumn'),
            multiplierColumnSelect: document.getElementById('multiplierColumn'),
            multiplierOptions: document.getElementById('multiplierOptions'),
            multiplierColumnOption: document.getElementById('multiplierColumnOption'),
            dateColumnSelect: document.getElementById('dateColumn'),
            dataStartColumnSelect: document.getElementById('dataStartColumn'),
            dataEndColumnSelect: document.getElementById('dataEndColumn'),
            meteringPointColumnSelect: document.getElementById('meteringPointColumn'),
            meteringPointFilterSelect: document.getElementById('meteringPointFilter'),
            dateFormatSelect: document.getElementById('dateFormat'),
            invalidDataHandlingSelect: document.getElementById('invalidDataHandling'),
            timeIntervalSelect: document.getElementById('timeInterval'),
            dataPreview: document.getElementById('dataPreview'),
            previewFirstHourCalculationBtn: document.getElementById('previewFirstHourCalculation'),
            firstHourCalculationModal: document.getElementById('firstHourCalculationModal'),
            closeFirstHourCalculationModalBtn: document.getElementById('closeFirstHourCalculationModal'),
            previewDate: document.getElementById('previewDate'),
            previewInterval: document.getElementById('previewInterval'),
            previewDataType: document.getElementById('previewDataType'),
            previewMultiplier: document.getElementById('previewMultiplier'),
            previewRawData: document.getElementById('previewRawData'),
            previewCleanedData: document.getElementById('previewCleanedData'),
            previewCalculationProcess: document.getElementById('previewCalculationProcess'),
            previewResult: document.getElementById('previewResult'),
            previewFormula: document.getElementById('previewFormula'),
            
            // 第一天计算过程相关
            firstDayCalculationModal: document.getElementById('firstDayCalculationModal'),
            closeFirstDayCalculationModalBtn: document.getElementById('closeFirstDayCalculationModal'),
            previewFirstDayDate: document.getElementById('previewFirstDayDate'),
            previewFirstDayInterval: document.getElementById('previewFirstDayInterval'),
            previewFirstDayDataType: document.getElementById('previewFirstDayDataType'),
            previewFirstDayMultiplier: document.getElementById('previewFirstDayMultiplier'),
            previewFirstDayRawData: document.getElementById('previewFirstDayRawData'),
            previewFirstDayCleanedData: document.getElementById('previewFirstDayCleanedData'),
            previewFirstDayCalculationProcess: document.getElementById('previewFirstDayCalculationProcess'),
            previewFirstDayResult: document.getElementById('previewFirstDayResult'),
            previewFirstDayFormula: document.getElementById('previewFirstDayFormula'),
            backToImportBtn: document.getElementById('backToImportBtn'),
            nextToVisualizationBtn: document.getElementById('nextToVisualizationBtn'),
            
            // 可视化部分
            startDateInput: document.getElementById('startDate'),
            endDateInput: document.getElementById('endDate'),
            applyDateFilterBtn: document.getElementById('applyDateFilter'),
            selectAllDatesBtn: document.getElementById('selectAllDates'),
            deselectAllDatesBtn: document.getElementById('deselectAllDates'),
            focusStartTimeSelect: document.getElementById('focusStartTime'),
            focusEndTimeSelect: document.getElementById('focusEndTime'),
            applyTimeFocusBtn: document.getElementById('applyTimeFocus'),
            resetTimeFocusBtn: document.getElementById('resetTimeFocus'),
            visualizationMeteringPointFilterSelect: document.getElementById('visualizationMeteringPointFilter'),
            applyMeteringPointFilterBtn: document.getElementById('applyMeteringPointFilter'),
            selectAllMeteringPointsBtn: document.getElementById('selectAllMeteringPoints'),
            lineStyleSelect: document.getElementById('lineStyle'),
            showPointsSelect: document.getElementById('showPoints'),
            smoothCurveSelect: document.getElementById('smoothCurve'),
            curveTensionSelect: document.getElementById('curveTension'),
            secondaryAxisCheckbox: document.getElementById('secondaryAxis'),
            loadCurveChart: document.getElementById('loadCurveChart'),
            chartLoading: document.getElementById('chartLoading'),
            noDataMessage: document.getElementById('noDataMessage'),
            dailyStats: document.getElementById('dailyStats'),
            periodStats: document.getElementById('periodStats'),
            backToConfigBtn: document.getElementById('backToConfigBtn'),
            nextToExportBtn: document.getElementById('nextToExportBtn'),
            
            // 导出部分
            exportPNGBtn: document.getElementById('exportPNG'),
            pngQualitySelect: document.getElementById('pngQuality'),
            exportJPGBtn: document.getElementById('exportJPG'),
            exportSVGBtn: document.getElementById('exportSVG'),
            exportHourlyDataBtn: document.getElementById('exportHourlyData'),
            exportDailyStatsBtn: document.getElementById('exportDailyStats'),
            exportFormatSelect: document.getElementById('exportFormat'),
            exportFileNameInput: document.getElementById('exportFileName'),
            includeTimestampCheckbox: document.getElementById('includeTimestamp'),
            includeFiltersInNameCheckbox: document.getElementById('includeFiltersInName'),
            backToVisualizationBtn: document.getElementById('backToVisualizationBtn'),
            startOverBtn: document.getElementById('startOverBtn'),
            
            // 通知和模态框
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notificationIcon'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            closeNotificationBtn: document.getElementById('closeNotification'),
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModalBtn: document.getElementById('closeModal'),
            helpBtn: document.getElementById('helpBtn'),
            aboutBtn: document.getElementById('aboutBtn'),
            
            //  sections
            importSection: document.getElementById('importSection'),
            configSection: document.getElementById('configSection'),
            visualizationSection: document.getElementById('visualizationSection'),
            exportSection: document.getElementById('exportSection'),
            
            // 历史记录相关
            importHistory: document.getElementById('importHistory'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            historyDetailModal: document.getElementById('historyDetailModal'),
            closeHistoryDetailModalBtn: document.getElementById('closeHistoryDetailModal'),
            historyDetailContent: document.getElementById('historyDetailContent'),
            filterCountInput: document.getElementById('filterCount'),
        applyFilterCountBtn: document.getElementById('applyFilterCount'),
        filterOptionsContainer: document.getElementById('filterOptionsContainer'),
        previewDate: document.getElementById('previewDate'),
        previewInterval: document.getElementById('previewInterval'),
        previewDataType: document.getElementById('previewDataType'),
        previewMultiplier: document.getElementById('previewMultiplier'),
        previewRawData: document.getElementById('previewRawData'),
        previewCleanedData: document.getElementById('previewCleanedData'),
        previewCalculationProcess: document.getElementById('previewCalculationProcess'),
        previewResult: document.getElementById('previewResult'),
        previewFormula: document.getElementById('previewFormula'),
        previewFirstHourCalculationBtn: document.getElementById('previewFirstHourCalculation'),
        closeFirstHourCalculationModalBtn: document.getElementById('closeFirstHourCalculationModal'),
        previewFirstDayCalculationBtn: document.getElementById('previewFirstDayCalculation'),
        closeFirstDayCalculationModalBtn: document.getElementById('closeFirstDayCalculationModal')
        };

        // 初始化事件监听
        function initEventListeners() {
            // 导入部分
            elements.dropArea.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelection);
            elements.dropArea.addEventListener('dragover', handleDragOver);
            elements.dropArea.addEventListener('dragleave', handleDragLeave);
            elements.dropArea.addEventListener('drop', handleDrop);
            elements.removeAllFiles.addEventListener('click', removeAllFiles);
            elements.nextToConfigBtn.addEventListener('click', goToConfigSection);
            
            // 配置部分
            elements.dataTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    appData.config.dataType = e.target.value;
                    updateDataPreview();
                });
            });
            
            elements.multiplierInput.addEventListener('change', (e) => {
                appData.config.multiplier = parseFloat(e.target.value) || 1.0;
                updateDataPreview();
            });
            
            elements.useMultiplierColumnCheckbox.addEventListener('change', (e) => {
                appData.config.useMultiplierColumn = e.target.checked;
                if (e.target.checked) {
                    elements.multiplierOptions.classList.add('hidden');
                    elements.multiplierColumnOption.classList.remove('hidden');
                } else {
                    elements.multiplierOptions.classList.remove('hidden');
                    elements.multiplierColumnOption.classList.add('hidden');
                }
                updateDataPreview();
            });
            
            elements.multiplierColumnSelect.addEventListener('change', (e) => {
                appData.config.multiplierColumn = e.target.value;
                updateDataPreview();
            });
            
            elements.dateColumnSelect.addEventListener('change', (e) => {
                appData.config.dateColumn = e.target.value;
                updateDataPreview();
                checkConfigValidity();
            });
            
            elements.dataStartColumnSelect.addEventListener('change', (e) => {
                appData.config.dataStartColumn = e.target.value;
                updateDataPreview();
                checkConfigValidity();
            });
            
            elements.dataEndColumnSelect.addEventListener('change', (e) => {
                appData.config.dataEndColumn = e.target.value;
                updateDataPreview();
                checkConfigValidity();
            });
            
            elements.meteringPointColumnSelect.addEventListener('change', (e) => {
                appData.config.meteringPointColumn = e.target.value;
                updateMeteringPointFilterOptions();
                updateDataPreview();
            });
            
            elements.meteringPointFilterSelect.addEventListener('change', (e) => {
                appData.config.meteringPointFilter = e.target.value;
                updateDataPreview();
            });
            
            elements.dateFormatSelect.addEventListener('change', (e) => {
                appData.config.dateFormat = e.target.value;
            });
            
            elements.invalidDataHandlingSelect.addEventListener('change', (e) => {
                appData.config.invalidDataHandling = e.target.value;
            });
            
            elements.timeIntervalSelect.addEventListener('change', (e) => {
        appData.config.timeInterval = parseInt(e.target.value);
        updateDataPreview();
        checkConfigValidity();
    });
    

    // 数据索引范围日期选择
    elements.dataStartDate.addEventListener('change', function() {
        appData.selectedStartDate = this.value;
        if (appData.selectedStartDate && appData.selectedEndDate) {
            // 确保开始日期不晚于结束日期
            if (new Date(appData.selectedStartDate) > new Date(appData.selectedEndDate)) {
                showNotification('开始日期不能晚于结束日期', 'warning');
                this.value = appData.selectedStartDate;
                return;
            }
            // 更新数据预览以反映日期范围选择
            updateDataPreview();
            // 显示通知
            showNotification('信息', `已选择日期范围: ${appData.selectedStartDate} 至 ${appData.selectedEndDate}`, 'success');
        }
    });

    elements.dataEndDate.addEventListener('change', function() {
        appData.selectedEndDate = this.value;
        if (appData.selectedStartDate && appData.selectedEndDate) {
            // 确保开始日期不晚于结束日期
            if (new Date(appData.selectedStartDate) > new Date(appData.selectedEndDate)) {
                showNotification('结束日期不能早于开始日期', 'warning');
                this.value = appData.selectedEndDate;
                return;
            }
            // 更新数据预览以反映日期范围选择
            updateDataPreview();
            // 显示通知
            showNotification('信息', `已选择日期范围: ${appData.selectedStartDate} 至 ${appData.selectedEndDate}`, 'success');
        }
    });

    elements.clearDateSelectionBtn.addEventListener('click', function() {
        appData.selectedStartDate = null;
        appData.selectedEndDate = null;
        elements.dataStartDate.value = '';
        elements.dataEndDate.value = '';
        
        // 清除数据行索引范围
        const dataStartIndexInput = document.getElementById('dataStartIndex');
        const dataEndIndexInput = document.getElementById('dataEndIndex');
        if (dataStartIndexInput) dataStartIndexInput.value = 0;
        if (dataEndIndexInput) dataEndIndexInput.value = -1;
        appData.config.dataStartIndex = 0;
        appData.config.dataEndIndex = -1;
        
        // 更新数据预览以清除选择范围的高亮
        updateDataPreview();
        
        showNotification('已清除日期选择', 'success');
    });
    
    elements.backToImportBtn.addEventListener('click', goToImportSection);
            elements.nextToVisualizationBtn.addEventListener('click', goToVisualizationSection);
            
            // 绑定数据行索引范围事件监听器
            
            
            // 可视化部分
            elements.applyDateFilterBtn.addEventListener('click', applyDateFilter);
            elements.selectAllDatesBtn.addEventListener('click', selectAllDates);
            elements.deselectAllDatesBtn.addEventListener('click', deselectAllDates);
            elements.applyMeteringPointFilterBtn.addEventListener('click', applyMeteringPointFilter);
            elements.selectAllMeteringPointsBtn.addEventListener('click', selectAllMeteringPoints);
            elements.applyTimeFocusBtn.addEventListener('click', applyTimeFocus);
            elements.resetTimeFocusBtn.addEventListener('click', resetTimeFocus);
            elements.lineStyleSelect.addEventListener('change', (e) => {
                appData.visualization.lineStyle = e.target.value;
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `线条样式已更改为${e.target.options[e.target.selectedIndex].text}`, 'success');
            });
            
            elements.showPointsSelect.addEventListener('change', (e) => {
                appData.visualization.showPoints = e.target.value === 'true';
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `数据点显示已${e.target.value === 'true' ? '开启' : '关闭'}`, 'success');
            });
            
            elements.smoothCurveSelect.addEventListener('change', (e) => {
                appData.visualization.smoothCurve = e.target.value === 'true';
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `曲线平滑已${e.target.value === 'true' ? '开启' : '关闭'}`, 'success');
            });
            
            elements.curveTensionSelect.addEventListener('change', (e) => {
                appData.visualization.curveTension = parseFloat(e.target.value);
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `曲线平滑度已设置为${e.target.options[e.target.selectedIndex].text}`, 'success');
            });
            
            elements.secondaryAxisCheckbox.addEventListener('change', (e) => {
                appData.visualization.secondaryAxis = e.target.checked;
                // 添加视觉反馈
                e.target.parentElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.parentElement.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `辅助Y轴已${e.target.checked ? '开启' : '关闭'}`, 'success');
            });
            
            // 曲线图图例显示开关事件
            document.getElementById('toggleCurveLegend').addEventListener('change', (e) => {
                const isVisible = e.target.checked;
                const legendContainer = document.getElementById('curveLegendContainer');
                
                // 更新图例容器显示状态
                if (legendContainer) {
                    legendContainer.style.display = isVisible ? 'block' : 'none';
                }
                
                // 更新图表图例显示状态
                if (appData.chart) {
                    appData.chart.options.plugins.legend.display = isVisible;
                    appData.chart.update();
                }
                
                // 添加视觉反馈
                e.target.parentElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.parentElement.style.transform = 'scale(1)';
                }, 200);
                
                showNotification('样式更新', `曲线图例已${isVisible ? '开启' : '关闭'}`, 'success');
            });
            
            // 柱状图始终显示，无需事件处理

            
            elements.backToConfigBtn.addEventListener('click', goToConfigSection);
            elements.nextToExportBtn.addEventListener('click', goToExportSection);
            
            // 导出部分
            elements.exportPNGBtn.addEventListener('click', exportAsPNG);
            elements.exportJPGBtn.addEventListener('click', exportAsJPG);
            elements.exportSVGBtn.addEventListener('click', exportAsSVG);
            elements.exportHourlyDataBtn.addEventListener('click', exportHourlyData);
            elements.exportDailyStatsBtn.addEventListener('click', exportDailyStats);
            
            // 导出日期范围选择器事件处理
            document.getElementById('exportAllDates').addEventListener('change', function() {
                const startDate = document.getElementById('exportStartDate');
                const endDate = document.getElementById('exportEndDate');
                
                if (this.checked) {
                    startDate.disabled = true;
                    endDate.disabled = true;
                } else {
                    startDate.disabled = false;
                    endDate.disabled = false;
                }
            });
            
            // 初始化日期范围选择器状态
              document.getElementById('exportAllDates').dispatchEvent(new Event('change'));
            elements.backToVisualizationBtn.addEventListener('click', goToVisualizationSection);
            elements.startOverBtn.addEventListener('click', startOver);
            
            // 通知和模态框
            elements.closeNotificationBtn.addEventListener('click', hideNotification);
            elements.closeModalBtn.addEventListener('click', closeModal);
            elements.modalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.modalOverlay) closeModal();
            });
            
            elements.helpBtn.addEventListener('click', showHelpModal);
            elements.aboutBtn.addEventListener('click', showAboutModal);
            
            elements.filterCountInput.addEventListener('change', (e) => {
                appData.config.filterCount = parseInt(e.target.value) || 1;
            });
            
            // 历史记录相关事件监听
            elements.clearHistoryBtn.addEventListener('click', clearImportHistory);
            elements.closeHistoryDetailModalBtn.addEventListener('click', closeHistoryDetailModal);
            
            elements.applyFilterCountBtn.addEventListener('click', generateFilterOptions);
            
            // 第一个小时计算过程预览
        elements.previewFirstHourCalculationBtn.addEventListener('click', previewFirstHourCalculation);
        elements.closeFirstHourCalculationModalBtn.addEventListener('click', closeFirstHourCalculationModal);
        
        // 第一天计算过程预览
        elements.previewFirstDayCalculationBtn.addEventListener('click', previewFirstDayCalculation);
        elements.closeFirstDayCalculationModalBtn.addEventListener('click', closeFirstDayCalculationModal);
        
        // 添加数据结构类型变更事件处理
        document.querySelectorAll('input[name="dataStructure"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const dataStructure = this.value;
                
                // 根据数据结构类型显示/隐藏相关选项
        if (dataStructure === 'columnToRow') {
            // 显示数据结束列选项
            document.getElementById('dataEndColumn').parentElement.style.display = 'block';
            
            // 显示时间间隔自动检测提示
            const timeIntervalLabel = document.querySelector('label[for="timeInterval"]');
            if (timeIntervalLabel) {
                timeIntervalLabel.textContent = '时间间隔（分钟，列对行结构可自动检测）';
            }
            
            // 隐藏跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'none';
            }
                } else {
            // 隐藏数据结束列选项
            document.getElementById('dataEndColumn').parentElement.style.display = 'none';
            
            // 更新时间间隔标签
            const timeIntervalLabel = document.querySelector('label[for="timeInterval"]');
            if (timeIntervalLabel) {
                timeIntervalLabel.textContent = '时间间隔（分钟）';
            }
            
            // 显示跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'block';
            }
                }
                
                // 更新数据预览
                updateDataPreview();
                
                // 更新按钮状态
                checkConfigValidity();
            });
        });
        
        // 初始化数据结构类型UI
        const initialDataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
        if (initialDataStructure === 'columnToColumn') {
            // 隐藏数据结束列选项
            document.getElementById('dataEndColumn').parentElement.style.display = 'none';
            
            // 显示跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'block';
            }
        } else {
            // 隐藏跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'none';
            }
        }

        // 清除按钮事件处理
        // 清除计量点编号所在列选择
        document.getElementById('clearMeteringPointColumn').addEventListener('click', function() {
            elements.meteringPointColumnSelect.value = '';
            appData.config.meteringPointColumn = '';
            updateMeteringPointFilterOptions();
            updateDataPreview();
            showNotification('已清除', '计量点编号所在列选择已清除', 'success');
        });

        // 清除计量点编号筛选
        document.getElementById('clearMeteringPointFilter').addEventListener('click', function() {
            elements.meteringPointFilterSelect.value = '';
            appData.config.meteringPointFilter = '';
            updateDataPreview();
            showNotification('已清除', '计量点编号筛选已清除', 'success');
        });

        // 清除全部筛选项
        document.getElementById('clearAllFilters').addEventListener('click', function() {
            // 清除additionalFilters数组
            appData.config.additionalFilters = [];
            
            // 重新生成筛选项（会清空所有选择）
            generateFilterOptions();
            
            // 更新数据预览
            updateDataPreview();
            showNotification('已清除', '所有筛选项已清除', 'success');
        });

        // 清除单个筛选项（使用事件委托）
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('clear-single-filter')) {
                e.preventDefault();
                const index = parseInt(e.target.dataset.index);
                
                if (!isNaN(index)) {
                    // 清除该筛选项的选择
                    const columnSelect = document.getElementById(`filterColumn${index}`);
                    const valueSelect = document.getElementById(`filterValue${index}`);
                    
                    if (columnSelect && valueSelect) {
                        columnSelect.value = '';
                        valueSelect.innerHTML = '<option value="">-- 全部 --</option>';
                        
                        // 更新配置
                        if (appData.config.additionalFilters[index]) {
                            appData.config.additionalFilters[index].column = '';
                            appData.config.additionalFilters[index].value = '';
                        }
                        
                        updateDataPreview();
                        showNotification('已清除', `筛选项 ${index + 1} 已清除`, 'success');
                    }
                }
            }
        });
        }

        // 文件处理函数
        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
            elements.dropArea.classList.add('border-primary');
            elements.dropArea.classList.add('bg-primary/5');
        }

        function handleDragLeave() {
            elements.dropArea.classList.remove('border-primary');
            elements.dropArea.classList.remove('bg-primary/5');
        }

        function handleDrop(e) {
            e.preventDefault();
            elements.dropArea.classList.remove('border-primary');
            elements.dropArea.classList.remove('bg-primary/5');
            
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function processFiles(files) {
            if (files.length === 0) return;
            
            files.forEach(file => {
                // 检查文件是否已导入
                const isDuplicate = appData.files.some(f => 
                    f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
                );
                
                if (isDuplicate) {
                    showNotification('警告', `文件 "${file.name}" 已导入，跳过重复文件`, 'warning');
                    return;
                }
                
                if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    showNotification('错误', `文件 "${file.name}" 格式不支持，请上传Excel或CSV文件`, 'error');
                    
                    // 记录失败的历史记录
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '', // 添加文件路径信息
                            status: 'failure',
                            errorMessage: '文件格式不支持，请上传Excel或CSV文件',
                            recordCount: 0,
                            validRecordCount: 0,
                            invalidRecordCount: 0
                        };
                    
                    appData.importHistory.push(historyRecord);
                    saveImportHistory();
                    renderImportHistory();
                    return;
                }
                
                appData.files.push(file);
                addFileToUI(file);
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // 只处理第一个工作表
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        appData.worksheets.push({
                            file: file,
                            sheetName: firstSheetName,
                            data: jsonData
                        });
                        
                        // 如果是第一个文件，自动填充列选择
                        if (appData.worksheets.length === 1) {
                            populateColumnSelects(jsonData[0] || [], jsonData);
                            
                            // 自动识别数据结构类型（列对行或列对列）
                            autoDetectDataStructure(jsonData);
                        }
                        
                        // 记录成功的历史记录
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '', // 添加文件路径信息
                            status: 'success',
                            recordCount: jsonData.length - 1, // 减去表头行
                            validRecordCount: 0, // 将在数据处理后更新
                            invalidRecordCount: 0, // 将在数据处理后更新
                            timeInterval: null, // 将在数据处理后更新
                            config: null // 将在数据处理后更新
                        };
                        
                        appData.importHistory.push(historyRecord);
                        saveImportHistory();
                        renderImportHistory();
                        
                        showNotification('成功', `文件 "${file.name}" 导入成功`, 'success');
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showNotification('错误', `处理文件 "${file.name}" 时出错: ${error.message}`, 'error');
                        
                        // 记录失败的历史记录
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '', // 添加文件路径信息
                            status: 'failure',
                            errorMessage: error.message,
                            recordCount: 0,
                            validRecordCount: 0,
                            invalidRecordCount: 0
                        };
                        
                        appData.importHistory.push(historyRecord);
                        saveImportHistory();
                        renderImportHistory();
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
            
            elements.fileList.classList.remove('hidden');
            elements.removeAllFiles.classList.remove('hidden');
            elements.nextToConfigBtn.disabled = false;
        }

        function addFileToUI(file) {
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
            li.innerHTML = `
                <div class="flex items-center">
                    <i class="fa fa-file-excel-o text-success mr-2"></i>
                    <div>
                        <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                        <p class="text-xs text-neutral">${fileSize} MB</p>
                    </div>
                </div>
                <button class="text-danger hover:text-danger/80 remove-file" data-name="${file.name}">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            elements.importedFiles.appendChild(li);
            
            // 添加删除单个文件的事件
            li.querySelector('.remove-file').addEventListener('click', function(e) {
                const fileName = e.target.closest('.remove-file').dataset.name;
                removeFile(fileName);
            });
        }

        function removeFile(fileName) {
            // 从数据中移除
            appData.files = appData.files.filter(file => file.name !== fileName);
            appData.worksheets = appData.worksheets.filter(ws => ws.file.name !== fileName);
            
            // 从UI中移除
            const fileElement = Array.from(elements.importedFiles.children).find(li => 
                li.querySelector('.font-medium').textContent === fileName
            );
            
            if (fileElement) {
                fileElement.remove();
            }
            
            // 如果没有文件了，隐藏列表
            if (appData.files.length === 0) {
                elements.fileList.classList.add('hidden');
                elements.removeAllFiles.classList.add('hidden');
                elements.nextToConfigBtn.disabled = true;
                
                // 清空列选择
                elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            } else if (appData.worksheets.length > 0) {
                // 重新填充列选择
                populateColumnSelects(appData.worksheets[0].data[0] || [], appData.worksheets[0].data);
            }
            
            showNotification('信息', `文件 "${fileName}" 已移除`, 'info');
        }

        function removeAllFiles() {
            if (appData.files.length === 0) return;
            
            // 清空数据 - 追加模式下不清除数据
            const appendMode = document.getElementById('appendMode')?.checked || false;
            if (!appendMode) {
                appData.files = [];
                appData.worksheets = [];
                appData.parsedData = [];
                appData.processedData = [];
            } else {
                // 追加模式下只清空文件列表，保留数据
                appData.files = [];
                // 不清除worksheets, parsedData, processedData
            }
            
            // 清空UI
            elements.importedFiles.innerHTML = '';
            elements.fileList.classList.add('hidden');
            elements.removeAllFiles.classList.add('hidden');
            elements.nextToConfigBtn.disabled = true;
            
            // 清空列选择
            elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            
            showNotification('信息', '所有文件已移除', 'info');
        }

        function populateColumnSelects(headerRow, data) {
            // 清空现有选项
            elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            
            // 添加新选项 (支持所有列，不再限制50列)
            for (let i = 0; i < headerRow.length; i++) {
                // 生成列字母，支持超过26列的情况（如AA, AB等）
                let columnLetter = "";
                let columnNum = i;
                while (columnNum >= 0) {
                    columnLetter = String.fromCharCode(65 + (columnNum % 26)) + columnLetter;
                    columnNum = Math.floor(columnNum / 26) - 1;
                    if (columnNum < 0) break;
                }
                
                const headerText = headerRow[i] ? String(headerRow[i]).substring(0, 20) : `列 ${columnLetter}`;
                
                const dateOption = document.createElement('option');
                dateOption.value = i;
                dateOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dateColumnSelect.appendChild(dateOption);
                
                const startOption = document.createElement('option');
                startOption.value = i;
                startOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dataStartColumnSelect.appendChild(startOption);
                
                const endOption = document.createElement('option');
                endOption.value = i;
                endOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dataEndColumnSelect.appendChild(endOption);
                
                const meteringPointOption = document.createElement('option');
                meteringPointOption.value = i;
                meteringPointOption.textContent = `${columnLetter}: ${headerText}`;
                elements.meteringPointColumnSelect.appendChild(meteringPointOption);
                
                const multiplierColumnOption = document.createElement('option');
        multiplierColumnOption.value = i;
        multiplierColumnOption.textContent = `${columnLetter}: ${headerText}`;
        elements.multiplierColumnSelect.appendChild(multiplierColumnOption);
    }
    
    // 自动识别列
    if (data && data.length > 1) {
        autoDetectColumns(headerRow, data);
    }
    
    // 生成筛选项
    generateFilterOptions();
}

        // 自动识别数据结构类型函数
        function autoDetectDataStructure(jsonData) {
            if (!jsonData || jsonData.length < 2) return; // 需要至少有表头和一行数据
            
            const headerRow = jsonData[0];
            const dataRows = jsonData.slice(1, Math.min(11, jsonData.length)); // 取前10行数据进行分析
            
            // 分析特征1：列数
            const columnCount = headerRow.length;
            
            // 分析特征2：日期列的特征
            let dateColumnIndex = -1;
            const dateKeywords = ['日期', '时间', 'date', 'time', 'datetime'];
            
            for (let i = 0; i < headerRow.length; i++) {
                const headerText = String(headerRow[i]).toLowerCase();
                if (dateKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    dateColumnIndex = i;
                    break;
                }
            }
            
            if (dateColumnIndex === -1) return; // 没有找到日期列，无法判断
            
            // 分析特征3：数据列的特征
            let dataColumnIndices = [];
            const dataKeywords = ['数据', '数值', '值', 'data', 'value', '功率', '电能', '负荷'];
            
            for (let i = 0; i < headerRow.length; i++) {
                if (i === dateColumnIndex) continue; // 跳过日期列
                
                const headerText = String(headerRow[i]).toLowerCase();
                if (dataKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    dataColumnIndices.push(i);
                }
            }
            
            // 如果没有找到明确的数据列，尝试通过数据内容判断
            if (dataColumnIndices.length === 0) {
                for (let i = 0; i < headerRow.length; i++) {
                    if (i === dateColumnIndex) continue; // 跳过日期列
                    
                    // 检查该列是否包含大量数字
                    let numericCount = 0;
                    for (let j = 0; j < dataRows.length; j++) {
                        if (dataRows[j] && dataRows[j][i] !== undefined && !isNaN(parseFloat(dataRows[j][i]))) {
                            numericCount++;
                        }
                    }
                    
                    // 如果超过70%的行包含数字，认为是数据列
                    if (numericCount / dataRows.length > 0.7) {
                        dataColumnIndices.push(i);
                    }
                }
            }
            
            // 分析特征4：时间序列模式
            let timeSeriesScore = 0;
            let columnSeriesScore = 0;
            
            // 检查是否包含时间序列模式（如0:00, 1:00等）
            for (let i = 0; i < headerRow.length; i++) {
                if (i === dateColumnIndex) continue;
                
                const headerText = String(headerRow[i]);
                if (/\d{1,2}:\d{2}/.test(headerText)) {
                    timeSeriesScore += 5; // 发现时间序列模式
                }
            }
            
            // 检查数据列数量
            if (dataColumnIndices.length >= 24) {
                timeSeriesScore += 3; // 多列数据更可能是时间序列（列对行）
            }
            
            if (dataColumnIndices.length <= 5) {
                columnSeriesScore += 3; // 少列数据更可能是列对列
            }
            
            // 分析特征5：日期重复情况
            const dateCount = {};
            for (let i = 0; i < dataRows.length; i++) {
                if (dataRows[i] && dataRows[i][dateColumnIndex]) {
                    const dateValue = String(dataRows[i][dateColumnIndex]);
                    dateCount[dateValue] = (dateCount[dateValue] || 0) + 1;
                }
            }
            
            // 计算日期重复率
            const uniqueDates = Object.keys(dateCount).length;
            const totalRows = dataRows.length;
            const dateDuplicationRate = (totalRows - uniqueDates) / totalRows;
            
            if (dateDuplicationRate > 0.5) {
                columnSeriesScore += 5; // 高重复率更可能是列对列结构
            } else {
                timeSeriesScore += 3; // 低重复率更可能是列对行结构
            }
            
            // 综合评分，决定数据结构类型
            const totalScore = timeSeriesScore + columnSeriesScore;
            
            let detectedStructure;
            let confidence;
            
            if (totalScore === 0) {
                // 没有明确的特征，使用默认值
                detectedStructure = 'columnToRow';
                confidence = 'low';
            } else {
                const timeSeriesRatio = timeSeriesScore / totalScore;
                
                if (timeSeriesRatio > 0.6) {
                    detectedStructure = 'columnToRow';
                    confidence = timeSeriesRatio > 0.8 ? 'high' : 'medium';
                } else {
                    detectedStructure = 'columnToColumn';
                    confidence = timeSeriesRatio < 0.4 ? 'high' : 'medium';
                }
            }
            
            // 设置检测到的数据结构类型
            const radioToCheck = document.querySelector(`input[name="dataStructure"][value="${detectedStructure}"]`);
            if (radioToCheck) {
                radioToCheck.checked = true;
                
                // 触发change事件以更新UI
                const event = new Event('change', { bubbles: true });
                radioToCheck.dispatchEvent(event);
                
                // 显示检测结果通知
                let confidenceText = '';
                if (confidence === 'high') {
                    confidenceText = '高置信度';
                } else if (confidence === 'medium') {
                    confidenceText = '中等置信度';
                } else {
                    confidenceText = '低置信度，使用默认值';
                }
                
                const structureText = detectedStructure === 'columnToRow' ? '列对行（日期列对多数据列）' : '列对列（日期列对单数据列）';
                showNotification('信息', `已自动识别数据结构类型：${structureText}（${confidenceText}）`, 'info');
            }
        }

        // 自动识别列函数
        function autoDetectColumns(headerRow, data) {
            let dateColumnIndex = -1;
            let dataStartColumnIndex = -1;
            let dataEndColumnIndex = -1;
            let meteringPointColumnIndex = -1;
            let multiplierColumnIndex = -1;
            
            // 识别日期列 - 查找包含日期相关关键词的列
            const dateKeywords = ['日期', '时间', 'date', 'time', 'datetime', '时间点', '记录时间', '日', '月', '年', '时', '分', '秒'];
            const datePatterns = [/\d{4}[\-\/]\d{1,2}[\-\/]\d{1,2}/, /\d{1,2}[\-\/]\d{1,2}[\-\/]\d{4}/, /\d{4}\d{2}\d{2}/];
            
            // 为每列计算置信度分数
            const columnScores = headerRow.map((header, index) => {
                const headerText = String(header).toLowerCase();
                let score = 0;
                
                // 日期列评分
                if (dateKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    score += 10; // 关键词匹配高分
                }
                
                // 检查日期格式模式
                if (datePatterns.some(pattern => pattern.test(headerText))) {
                    score += 8; // 日期格式匹配较高分
                }
                
                // 检查列位置 - 日期列通常在前几列
                if (index < 3) {
                    score += 3; // 位置加分
                }
                
                return {
                    index,
                    dateScore: score,
                    dataScore: 0,
                    meteringPointScore: 0,
                    multiplierScore: 0
                };
            });
            
            // 识别数据起始列 - 查找包含数据相关关键词的列
            const dataKeywords = ['数据', '数值', '值', 'data', 'value', '功率', '电能', '负荷', '读数', '开始', '有功', '无功', '视在', '电流', '电压', '用电量'];
            const dataPatterns = [/\d+\.?\d*/, /kw|kva|kvar|a|v/i];
            
            // 为每列计算数据列置信度分数
            columnScores.forEach(scoreObj => {
                const headerText = String(headerRow[scoreObj.index]).toLowerCase();
                
                // 数据列评分
                if (dataKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    scoreObj.dataScore += 10; // 关键词匹配高分
                }
                
                // 检查数据格式模式
                if (dataPatterns.some(pattern => pattern.test(headerText))) {
                    scoreObj.dataScore += 8; // 数据格式匹配较高分
                }
                
                // 检查是否包含时间序列相关词（如0:00, 1:00等）
                if (/\d{1,2}:\d{2}/.test(headerText)) {
                    scoreObj.dataScore += 7; // 时间序列模式匹配
                }
                
                // 检查列位置 - 数据列通常在日期列之后
                if (scoreObj.index > 0 && scoreObj.index < headerRow.length - 2) {
                    scoreObj.dataScore += 2; // 位置加分
                }
            });
            
            // 根据置信度分数选择日期列
            const dateCandidates = columnScores
                .filter(scoreObj => scoreObj.dateScore > 0)
                .sort((a, b) => b.dateScore - a.dateScore);
            
            if (dateCandidates.length > 0) {
                dateColumnIndex = dateCandidates[0].index;
            }
            
            // 如果没有找到日期列，尝试使用启发式方法查找
            if (dateColumnIndex === -1) {
                console.log('未找到日期列，使用启发式方法检测...');
                
                // 检查每列的实际数据内容
                for (let col = 0; col < headerRow.length; col++) {
                    let dateCount = 0;
                    let totalCount = 0;
                    
                    // 检查该列的数据
                    for (let row = 1; row < Math.min(20, data.length); row++) {
                        const cellValue = data[row] && data[row][col];
                        if (cellValue) {
                            totalCount++;
                            if (isDateLike(String(cellValue))) {
                                dateCount++;
                            }
                        }
                    }
                    
                    // 如果该列中超过70%的数据是日期格式
                    if (totalCount > 0 && dateCount / totalCount > 0.7) {
                        dateColumnIndex = col;
                        console.log(`启发式方法找到日期列: 列${col}, 日期比例: ${dateCount}/${totalCount}`);
                        break;
                    }
                }
            }
            
            // 根据置信度分数选择数据起始列
            const dataStartCandidates = columnScores
                .filter(scoreObj => scoreObj.dataScore > 0 && scoreObj.index !== dateColumnIndex)
                .sort((a, b) => b.dataScore - a.dataScore);
            
            if (dataStartCandidates.length > 0) {
                dataStartColumnIndex = dataStartCandidates[0].index;
            } else {
                // 如果没有找到数据起始列，尝试查找包含数字的列
                for (let i = 0; i < headerRow.length; i++) {
                    // 跳过已经识别为日期的列
                    if (i === dateColumnIndex) continue;
                    
                    const headerText = String(headerRow[i]);
                    // 检查是否包含数字
                    if (/\d+/.test(headerText)) {
                        dataStartColumnIndex = i;
                        break;
                    }
                }
            }
            
            // 智能识别数据结束列
            if (dataStartColumnIndex !== -1) {
                // 尝试找到连续的数据列范围
                let consecutiveDataColumns = 0;
                let maxConsecutive = 0;
                let bestEndIndex = dataStartColumnIndex;
                
                for (let i = dataStartColumnIndex; i < headerRow.length; i++) {
                    // 跳过已经识别为日期的列
                    if (i === dateColumnIndex) continue;
                    
                    const headerText = String(headerRow[i]).toLowerCase();
                    
                    // 检查是否是数据列
                    const isDataColumn = dataKeywords.some(keyword => headerText.includes(keyword.toLowerCase())) ||
                                       dataPatterns.some(pattern => pattern.test(headerText)) ||
                                       /\d+/.test(headerText);
                    
                    if (isDataColumn) {
                        consecutiveDataColumns++;
                        if (consecutiveDataColumns > maxConsecutive) {
                            maxConsecutive = consecutiveDataColumns;
                            bestEndIndex = i;
                        }
                    } else {
                        consecutiveDataColumns = 0;
                    }
                }
                
                dataEndColumnIndex = bestEndIndex;
            } else {
                // 如果没有找到数据起始列，默认最后一列为数据结束列
                dataEndColumnIndex = headerRow.length - 1;
            }
            
            // 识别计量点编号列
            const meteringPointKeywords = ['编号', 'id', '标识', '代码', '设备号', '设备编号', '计量点', '测点', '点位', '序号', 'no'];
            const meteringPointPatterns = [/^\d+$/, /^[A-Za-z]\d+$/, /^\d{4,}$/]; // 纯数字、字母+数字、长数字
            
            // 为每列计算计量点编号列置信度分数
            columnScores.forEach(scoreObj => {
                const headerText = String(headerRow[scoreObj.index]).toLowerCase();
                
                // 计量点编号列评分
                if (meteringPointKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    scoreObj.meteringPointScore += 10; // 关键词匹配高分
                }
                
                // 检查计量点编号格式模式
                if (meteringPointPatterns.some(pattern => pattern.test(headerText))) {
                    scoreObj.meteringPointScore += 8; // 格式匹配较高分
                }
                
                // 检查是否包含ID相关缩写
                if (headerText.includes('id') || headerText.includes('no') || headerText.includes('num')) {
                    scoreObj.meteringPointScore += 7; // ID相关缩写匹配
                }
                
                // 检查列位置 - 计量点编号列通常在前几列，但可能在日期列之后
                if (scoreObj.index > 0 && scoreObj.index < 5) {
                    scoreObj.meteringPointScore += 2; // 位置加分
                }
            });
            
            // 根据置信度分数选择计量点编号列
            const meteringPointCandidates = columnScores
                .filter(scoreObj => scoreObj.meteringPointScore > 0 && 
                                 scoreObj.index !== dateColumnIndex && 
                                 scoreObj.index !== dataStartColumnIndex &&
                                 scoreObj.index !== dataEndColumnIndex)
                .sort((a, b) => b.meteringPointScore - a.meteringPointScore);
            
            if (meteringPointCandidates.length > 0) {
                meteringPointColumnIndex = meteringPointCandidates[0].index;
            }
            
            // 如果识别到了列，设置默认值
            if (dateColumnIndex !== -1) {
                elements.dateColumnSelect.value = dateColumnIndex;
                appData.config.dateColumn = dateColumnIndex;
            }
            
            if (dataStartColumnIndex !== -1) {
                elements.dataStartColumnSelect.value = dataStartColumnIndex;
                appData.config.dataStartColumn = dataStartColumnIndex;
            }
            
            if (dataEndColumnIndex !== -1) {
                elements.dataEndColumnSelect.value = dataEndColumnIndex;
                appData.config.dataEndColumn = dataEndColumnIndex;
            }
            
            if (meteringPointColumnIndex !== -1) {
                elements.meteringPointColumnSelect.value = meteringPointColumnIndex;
                appData.config.meteringPointColumn = meteringPointColumnIndex;
            }
            
            // 如果识别到了任何列，触发数据预览
            if (dateColumnIndex !== -1 && dataStartColumnIndex !== -1) {
                updateDataPreview();
                checkConfigValidity();
                
                // 显示日期识别结果
                console.log('=== 日期列识别结果 ===');
                console.log(`日期列索引: ${dateColumnIndex}`);
                console.log(`日期列标题: ${headerRow[dateColumnIndex] || '无标题'}`);
                console.log(`数据起始列: ${dataStartColumnIndex}`);
                console.log(`数据结束列: ${dataEndColumnIndex}`);
                console.log(`计量点列: ${meteringPointColumnIndex}`);
                
                // 显示前几个日期的解析示例
                if (data.length > 1) {
                    console.log('=== 日期解析示例 ===');
                    for (let i = 1; i < Math.min(6, data.length); i++) {
                        if (data[i] && data[i][dateColumnIndex]) {
                            const dateValue = String(data[i][dateColumnIndex]).trim();
                            const parsedDate = parseDate(dateValue, appData.config.dateFormat);
                            console.log(`第${i}行: "${dateValue}" -> ${parsedDate ? formatDateForInput(parsedDate) : '解析失败'}`);
                        }
                    }
                }
            } else {
                console.log('=== 列识别失败 ===');
                console.log('请检查数据格式或手动选择列');
                
                // 显示列信息供调试
                console.log('=== 所有列标题 ===');
                headerRow.forEach((header, index) => {
                    console.log(`列${index}: "${header}"`);
                });
            }
        }

        // 配置部分函数
        function updateDateSelects() {
            // 清空现有选项
            elements.dataStartDate.innerHTML = '<option value="">-- 请选择起始日期 --</option>';
            elements.dataEndDate.innerHTML = '<option value="">-- 请选择结束日期 --</option>';
            
            // 如果没有选择日期列，则返回
            if (!appData.config.dateColumn) return;
            
            const dateCol = parseInt(appData.config.dateColumn);
            const dateSet = new Set();
            
            // 收集所有唯一的日期
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // 跳过表头行，尝试自动检测数据起始行
                let startRow = 0;
                let dateFoundCount = 0;
                
                for (let i = 0; i < Math.min(15, data.length); i++) {
                    if (data[i] && data[i][dateCol]) {
                        const cellValue = String(data[i][dateCol]).trim();
                        console.log(`检查第${i+1}行日期列: "${cellValue}"`);
                        
                        if (isDateLike(cellValue)) {
                            const parsedDate = parseDate(cellValue, appData.config.dateFormat);
                            console.log(`日期解析结果:`, parsedDate);
                            
                            if (parsedDate) {
                                startRow = i;
                                dateFoundCount++;
                                break;
                            }
                        }
                    }
                }
                
                console.log(`确定数据起始行: ${startRow + 1}, 找到有效日期: ${dateFoundCount}个`);
                
                // 收集日期
                let validDatesFound = 0;
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[dateCol]) continue;
                    
                    const dateStr = String(row[dateCol]).trim();
                    if (!dateStr) continue;
                    
                    // 解析日期
                    const date = parseDate(dateStr, appData.config.dateFormat);
                    if (date) {
                        const dateKey = formatDateForInput(date);
                        dateSet.add(dateKey);
                        validDatesFound++;
                        
                        // 记录前5个解析成功的日期用于调试
                        if (validDatesFound <= 5) {
                            console.log(`成功解析日期 ${validDatesFound}: "${dateStr}" -> "${dateKey}"`);
                        }
                    } else {
                        // 记录解析失败的日期
                        if (validDatesFound <= 5) {
                            console.log(`日期解析失败: "${dateStr}"`);
                        }
                    }
                }
                
                console.log(`工作表中找到的有效日期总数: ${validDatesFound}`);
            });
            
            // 转换为数组并排序
            const dates = Array.from(dateSet).sort();
            
            console.log(`收集到的唯一日期数量: ${dates.length}`);
            console.log(`所有收集到的日期:`, dates);
            
            // 如果没有收集到任何日期，显示提示信息
            if (dates.length === 0) {
                // 添加一个提示选项
                const option1 = document.createElement('option');
                option1.value = "";
                option1.textContent = "-- 未找到有效日期 --";
                option1.disabled = true;
                elements.dataStartDate.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = "";
                option2.textContent = "-- 未找到有效日期 --";
                option2.disabled = true;
                elements.dataEndDate.appendChild(option2);
                
                // 显示通知
                showNotification('提示', '未在数据中找到有效日期，请检查日期列选择和日期格式设置', 'warning');
                return;
            }
            
            // 添加到下拉菜单
            dates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.dataStartDate.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.dataEndDate.appendChild(option2);
            });
            
            // 如果之前有选择的日期，恢复选择
            if (appData.selectedStartDate) {
                elements.dataStartDate.value = appData.selectedStartDate;
            }
            
            if (appData.selectedEndDate) {
                elements.dataEndDate.value = appData.selectedEndDate;
            }
        }

        function updateDataPreview() {
    if (appData.worksheets.length === 0 || !appData.config.dateColumn || !appData.config.dataStartColumn || (!appData.config.dataEndColumn && document.querySelector('input[name="dataStructure"]:checked').value === 'columnToRow')) {
        elements.dataPreview.innerHTML = '请完成数据配置以查看预览';
        return;
    }
    
    // 更新日期下拉选择框
    updateDateSelects();
    
    // 解析数据
    parseWorksheetData();
    
    // 添加调试信息
    console.log('=== 数据解析完成 ===');
    console.log('总处理数据条数:', appData.processedData.length);
    console.log('日期范围:', appData.processedData.length > 0 ? 
        appData.processedData[0].date + ' 到 ' + appData.processedData[appData.processedData.length-1].date : '无数据');
    console.log('所有日期:', appData.processedData.map(d => d.date));
    
    // 显示数据汇总
    if (appData.processedData.length > 0) {
        const dateCounts = {};
        appData.processedData.forEach(d => {
            const month = d.date.substring(0, 7); // 获取YYYY-MM
            dateCounts[month] = (dateCounts[month] || 0) + 1;
        });
        console.log('按月份统计:', dateCounts);
    }
    
    if (appData.processedData.length === 0) {
        elements.dataPreview.innerHTML = '<p class="text-neutral text-center py-4">没有可预览的数据</p>';
        return;
    }
    
    // 获取数据结构类型
    const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
    
    let previewHtml = `<div class="bg-blue-50 p-3 mb-3 text-sm font-medium rounded-lg shadow-sm">总数据条数: ${appData.processedData.length} 条`;
    if (appData.selectedStartDate || appData.selectedEndDate) {
        previewHtml += ` <button onclick="clearDateRange()" class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">清除日期筛选</button>`;
    }
    previewHtml += `</div>`;
    
    // 添加清除日期范围的函数
    window.clearDateRange = function() {
        appData.selectedStartDate = null;
        appData.selectedEndDate = null;
        elements.dataStartDate.value = '';
        elements.dataEndDate.value = '';
        updateDataPreview();
        showNotification('信息', '已清除日期筛选，显示全部数据', 'info');
    };
    
    // 创建统一的表格样式，支持完整数据展示
    previewHtml += '<div class="overflow-x-auto border border-gray-200 rounded-xl shadow-sm max-h-96 overflow-y-auto bg-white">';
    previewHtml += '<table class="w-full text-sm table-auto" style="font-family: system-ui, -apple-system, sans-serif;">';
    previewHtml += '<thead><tr class="bg-gray-100 text-gray-800">';
    previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">日期</th>';
    
    if (dataStructure === 'columnToRow') {
        // 列对行结构的预览 - 统一显示24小时数据
        for (let hour = 0; hour < 24; hour++) {
            previewHtml += `<th class="border border-gray-300 px-3 py-2 text-center font-semibold">${hour}:00</th>`;
        }
        previewHtml += '</tr></thead><tbody class="divide-y divide-gray-200">';
        
        // 添加数据行 - 显示全部数据
        const displayRows = appData.processedData.length;
        for (let i = 0; i < displayRows; i++) {
            const row = appData.processedData[i];
            
            // 检查当前行是否在选择范围内
            const isSelected = appData.selectedStartDate && appData.selectedEndDate && 
                              row.date >= appData.selectedStartDate && 
                              row.date <= appData.selectedEndDate;
            
            const rowClass = isSelected ? 'bg-blue-50' : (i % 2 === 0 ? 'bg-white' : 'bg-gray-50');
            
            previewHtml += `<tr class="${rowClass} hover:bg-gray-100 transition-colors">`;
            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium">${row.date}</td>`;
            
            for (let hour = 0; hour < 24; hour++) {
                const value = row.hourlyData[hour];
                if (value !== null && value !== undefined) {
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                } else {
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                }
            }
            
            previewHtml += '</tr>';
        }
    } else {
        // 列对列结构的预览 - 统一显示数据点数和日总电能
        previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">数据点数</th>';
        previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">日总电能 (kWh)</th>';
        previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">平均功率 (kW)</th>';
        previewHtml += '</tr></thead><tbody class="divide-y divide-gray-200">';
        
        // 添加数据行 - 显示全部数据
        const displayRows = appData.processedData.length;
        for (let i = 0; i < displayRows; i++) {
            const row = appData.processedData[i];
            const validDataPoints = row.hourlyData.filter(v => v !== null && v !== undefined).length;
            const dailyTotal = row.dailyTotal || 0;
            const avgPower = validDataPoints > 0 ? dailyTotal / validDataPoints : 0;
            
            // 检查当前行是否在选择范围内
            const isSelected = appData.selectedStartDate && appData.selectedEndDate && 
                              row.date >= appData.selectedStartDate && 
                              row.date <= appData.selectedEndDate;
            
            const rowClass = isSelected ? 'bg-blue-50' : (i % 2 === 0 ? 'bg-white' : 'bg-gray-50');
            
            previewHtml += `<tr class="${rowClass} hover:bg-gray-100 transition-colors">`;
            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium">${row.date}</td>`;
            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${validDataPoints}</td>`;
            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${dailyTotal.toFixed(2)}</td>`;
            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${avgPower.toFixed(2)}</td>`;
            previewHtml += '</tr>';
        }
    }
    
    if (appData.processedData.length === 0) {
        previewHtml += '<tr><td colspan="25" class="border border-gray-300 px-3 py-4 text-center text-gray-500 italic">没有找到有效数据</td></tr>';
    }
    
    previewHtml += '</tbody></table></div>';
    
    // 添加数据统计信息
    if (appData.processedData.length > 0) {
        previewHtml += `<div class="mt-2 text-sm text-gray-600 text-center bg-gray-50 p-2 rounded">
            共显示 ${appData.processedData.length} 条数据记录
        </div>`;
    }
    
    elements.dataPreview.innerHTML = previewHtml;
    
    // 日期选择已通过下拉框实现，无需单元格点击事件
    
    // 启用/禁用第一个小时计算过程预览按钮
    if (appData.parsedData.length > 0) {
        elements.previewFirstHourCalculationBtn.disabled = false;
    } else {
        elements.previewFirstHourCalculationBtn.disabled = true;
    }
    
    // 启用/禁用第一天计算过程预览按钮
        if (appData.parsedData.length > 0) {
            elements.previewFirstDayCalculationBtn.disabled = false;
        } else {
            elements.previewFirstDayCalculationBtn.disabled = true;
        }
        
        // 更新数据状态显示
        updateDataStatus();
}

        function parseWorksheetData() {
    // 只在非追加模式下清除数据
    const appendMode = document.getElementById('appendMode')?.checked || false;
    if (!appendMode) {
        appData.parsedData = [];
        appData.processedData = [];
    } else {
        // 追加模式下不清除现有数据，但确保数组存在
        appData.parsedData = appData.parsedData || [];
        appData.processedData = appData.processedData || [];
    }
    
    // 获取数据结构类型
    const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
    
    appData.worksheets.forEach(worksheet => {
        const { data } = worksheet;
        const dateCol = parseInt(appData.config.dateColumn);
        const startCol = parseInt(appData.config.dataStartColumn);
        const endCol = parseInt(appData.config.dataEndColumn);
        
        // 解析用户选择的索引范围，优先级：数据行索引 > 日期范围 > 全部数据
        let startIndex = 0;
        let endIndex = data.length - 1;
        
        console.log(`工作表 ${worksheet.name || '未命名'}:`);
        console.log(`- 原始数据总行数: ${data.length}`);
        console.log(`- 选择的日期范围: ${appData.selectedStartDate || '未选择'} 到 ${appData.selectedEndDate || '未选择'}`);
        console.log(`- 数据行索引范围: ${appData.config.dataStartIndex || 0} 到 ${appData.config.dataEndIndex || -1}`);
        
        // 检查是否设置了非默认的数据行索引范围（优先级最高）
        const userStartIndex = parseInt(appData.config.dataStartIndex) || 0;
        const userEndIndex = appData.config.dataEndIndex === -1 ? data.length - 1 : parseInt(appData.config.dataEndIndex);
        
        // 如果用户设置了非默认的索引范围，优先使用
        const isUsingCustomIndexRange = userStartIndex !== 0 || (appData.config.dataEndIndex !== -1 && userEndIndex !== (data.length - 1));
        
        if (isUsingCustomIndexRange) {
            startIndex = Math.max(0, Math.min(userStartIndex, data.length - 1));
            endIndex = Math.max(startIndex, Math.min(userEndIndex, data.length - 1));
            console.log(`- 使用用户指定的行索引范围: ${startIndex} 到 ${endIndex}`);
            
            // 如果索引范围无效，给出警告
            if (startIndex >= data.length || endIndex < 0 || startIndex > endIndex) {
                showNotification('警告', '指定的行索引范围无效，将使用全部数据', 'warning');
                startIndex = 0;
                endIndex = data.length - 1;
            }
        } else if (appData.selectedStartDate && appData.selectedEndDate) {
            // 如果用户设置了日期范围，使用日期筛选
            let startFound = false;
            let endFound = false;
            
            // 将选择的日期范围转换为日期对象（确保包含边界）
            const selectedStart = new Date(appData.selectedStartDate);
            const selectedEnd = new Date(appData.selectedEndDate);
            
            // 设置时间为0时0分0秒，确保包含整天
            selectedStart.setHours(0, 0, 0, 0);
            selectedEnd.setHours(23, 59, 59, 999);
            
            // 收集所有在日期范围内的行索引
            const dateRangeIndices = [];
            
            console.log(`- 正在筛选日期范围: ${selectedStart.toISOString()} 到 ${selectedEnd.toISOString()}`);
            console.log(`- 日期格式: ${appData.config.dateFormat}`);
            
            // 首先收集所有有效的日期和行索引
            const allValidDates = [];
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 解析日期
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) {
                    console.log(`- 第${i}行日期解析失败: "${dateStr}"`);
                    continue;
                }
                
                // 标准化日期（去除时间部分，只保留年月日）
                const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                normalizedDate.setHours(0, 0, 0, 0); // 确保时间部分为0
                
                // 保存有效日期信息
                allValidDates.push({
                    index: i,
                    dateStr: dateStr,
                    date: normalizedDate,
                    formattedDate: formatDateForInput(normalizedDate)
                });
                
                // 检查日期是否在选择的范围内（包含边界）
                if (normalizedDate >= selectedStart && normalizedDate <= selectedEnd) {
                    dateRangeIndices.push(i);
                }
            }
            
            console.log(`- 找到 ${allValidDates.length} 条有效日期记录`);
            console.log(`- 找到 ${dateRangeIndices.length} 条匹配的记录`);
            
            // 如果在范围内找到数据，设置起始和结束索引
            if (dateRangeIndices.length > 0) {
                startIndex = Math.min(...dateRangeIndices);
                endIndex = Math.max(...dateRangeIndices);
                startFound = true;
                endFound = true;
            }
            
            // 确保索引在有效范围内
            startIndex = Math.max(0, Math.min(startIndex, data.length - 1));
            endIndex = Math.max(startIndex, Math.min(endIndex, data.length - 1));
            
            // 如果没有找到任何匹配的记录，检查可能的原因
            if (dateRangeIndices.length === 0) {
                // 收集所有唯一的日期样本用于调试
                const dateSamples = allValidDates.slice(0, 10).map(item => item.dateStr);
                const formattedSamples = allValidDates.slice(0, 10).map(item => item.formattedDate);
                
                console.log(`- 前10行的日期样本:`, dateSamples);
                console.log(`- 前10行的格式化日期样本:`, formattedSamples);
                console.log(`- 选择的日期范围: ${appData.selectedStartDate} 到 ${appData.selectedEndDate}`);
                
                // 检查是否所有日期都在选择范围之外
                const allBeforeRange = allValidDates.every(item => item.date < selectedStart);
                const allAfterRange = allValidDates.every(item => item.date > selectedEnd);
                
                if (allBeforeRange) {
                    showNotification('警告', '所有数据都在选择的日期范围之前，将使用全部数据', 'warning');
                } else if (allAfterRange) {
                    showNotification('警告', '所有数据都在选择的日期范围之后，将使用全部数据', 'warning');
                } else {
                    showNotification('警告', '未找到选择的日期范围，将使用全部数据', 'warning');
                }
                
                startIndex = 0;
                endIndex = data.length - 1;
            }
            
            console.log(`- 日期范围筛选结果: 找到 ${dateRangeIndices.length} 条记录`);
            console.log(`- 使用的行索引范围: ${startIndex} 到 ${endIndex}`);
        } else {
            // 默认使用全部数据
            startIndex = 0;
            endIndex = data.length - 1;
            console.log(`- 使用默认行索引范围: ${startIndex} 到 ${endIndex}`);
        }
        const meteringPointCol = appData.config.meteringPointColumn ? parseInt(appData.config.meteringPointColumn) : null;
        const multiplierCol = appData.config.useMultiplierColumn && appData.config.multiplierColumn ? parseInt(appData.config.multiplierColumn) : null;
        const selectedMeteringPoint = appData.config.meteringPointFilter;
        
        if (dataStructure === 'columnToRow') {
            // 原有的列对行数据处理逻辑
            const dataColumnCount = endCol - startCol + 1;
            
            // 检查是否启用了跨日期结构数据选项
            const isCrossDateStructure = document.getElementById('crossDateStructure') && document.getElementById('crossDateStructure').checked;
            
            let autoDetectedInterval = 15; // 默认15分钟
            let intervalDescription = "15分钟";
            
            if (isCrossDateStructure) {
                // 跨日期结构数据处理：根据日期列中相同日期对应的单元格数量判断时间间隔
                const dateCellCounts = {}; // 记录每个日期对应的单元格数量
                
                // 首先收集所有日期及其对应的单元格数量
                for (let i = startIndex; i <= Math.min(endIndex, data.length - 1); i++) {
                    const row = data[i];
                    if (!row || !row[dateCol]) continue;
                    
                    // 检查计量点编号筛选
                    if (meteringPointCol !== null && selectedMeteringPoint) {
                        const rowMeteringPoint = String(row[meteringPointCol]).trim();
                        if (rowMeteringPoint !== selectedMeteringPoint) {
                            continue; // 跳过不匹配的行
                        }
                    }
                    
                    // 解析日期
                    const dateStr = String(row[dateCol]).trim();
                    const date = parseDate(dateStr, appData.config.dateFormat);
                    if (!date) continue;
                    
                    // 使用日期字符串作为键
                    const dateKey = formatDateKey(date);
                    
                    // 统计该日期对应的单元格数量
                    if (!dateCellCounts[dateKey]) {
                        dateCellCounts[dateKey] = 0;
                    }
                    dateCellCounts[dateKey]++;
                }
                
                // 找出单元格数量最多的日期（遵循"少数服从多数"原则）
                let maxCellCount = 0;
                let dominantDateKey = null;
                
                for (const dateKey in dateCellCounts) {
                    if (dateCellCounts[dateKey] > maxCellCount) {
                        maxCellCount = dateCellCounts[dateKey];
                        dominantDateKey = dateKey;
                    }
                }
                
                // 根据主导日期的单元格数量判断时间间隔
                if (maxCellCount > 0) {
                    if (maxCellCount === 1440) {
                        autoDetectedInterval = 1;
                        intervalDescription = "1分钟";
                    } else if (maxCellCount === 288) {
                        autoDetectedInterval = 5;
                        intervalDescription = "5分钟";
                    } else if (maxCellCount === 96) {
                        autoDetectedInterval = 15;
                        intervalDescription = "15分钟";
                    } else if (maxCellCount === 48) {
                        autoDetectedInterval = 30;
                        intervalDescription = "30分钟";
                    } else if (maxCellCount === 24) {
                        autoDetectedInterval = 60;
                        intervalDescription = "60分钟";
                    } else {
                        // 单元格数量不符合标准情况，发出警告
                        showNotification('警告', `检测到${maxCellCount}个数据单元格，不符合标准时间间隔格式（24/48/96/288/1440个），将按15分钟间隔处理`, 'warning');
                        autoDetectedInterval = 15;
                        intervalDescription = "15分钟（默认）";
                    }
                    
                    // 显示检测到的时间间隔信息
                    showNotification('信息', `已自动检测时间间隔：${intervalDescription}（主导日期${dominantDateKey}有${maxCellCount}个数据单元格）`, 'info');
                } else {
                    showNotification('警告', '未能检测到有效的日期数据，将使用默认15分钟间隔', 'warning');
                }
            } else {
                // 非跨日期结构：原有的根据数据列数量判断时间间隔逻辑
                if (dataColumnCount === 1440) {
                    autoDetectedInterval = 1;
                    intervalDescription = "1分钟";
                } else if (dataColumnCount === 288) {
                    autoDetectedInterval = 5;
                    intervalDescription = "5分钟";
                } else if (dataColumnCount === 96) {
                    autoDetectedInterval = 15;
                    intervalDescription = "15分钟";
                } else if (dataColumnCount === 48) {
                    autoDetectedInterval = 30;
                    intervalDescription = "30分钟";
                } else if (dataColumnCount === 24) {
                    autoDetectedInterval = 60;
                    intervalDescription = "60分钟";
                } else {
                    // 单元格数量不符合标准情况，发出警告
                    showNotification('警告', `检测到${dataColumnCount}个数据列，不符合标准时间间隔格式（24/48/96/288/1440列），将按15分钟间隔处理`, 'warning');
                    autoDetectedInterval = 15;
                    intervalDescription = "15分钟（默认）";
                }
                
                // 显示检测到的时间间隔信息
                showNotification('信息', `已自动检测时间间隔：${intervalDescription}（${dataColumnCount}个数据列）`, 'info');
            }
            
            // 更新时间间隔配置
            appData.config.timeInterval = autoDetectedInterval;
            elements.timeIntervalSelect.value = autoDetectedInterval;
            
            // 跳过表头行，尝试自动检测数据起始行
            let startRow = startIndex;
            for (let i = startIndex; i < Math.min(startIndex + 10, data.length); i++) {
                if (data[i] && data[i][dateCol] && isDateLike(data[i][dateCol])) {
                    startRow = i;
                    break;
                }
            }
            
            // 处理每一行数据
            for (let i = startRow; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 检查计量点编号筛选
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) {
                        continue; // 跳过不匹配的行
                    }
                }
                
                // 检查附加筛选项
                let skipRow = false;
                appData.config.additionalFilters.forEach(filter => {
                    if (filter.column && filter.value) {
                        const col = parseInt(filter.column);
                        const rowValue = String(row[col]).trim();
                        if (rowValue !== filter.value) {
                            skipRow = true;
                        }
                    }
                });
                
                if (skipRow) {
                    continue; // 跳过不匹配的行
                }
                
                // 解析日期
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) continue;
                

                // 获取倍率值
                let multiplier = appData.config.multiplier;
                if (multiplierCol !== null && row[multiplierCol] !== undefined) {
                    const parsedMultiplier = parseNumber(row[multiplierCol]);
                    if (parsedMultiplier !== null) {
                        multiplier = parsedMultiplier;
                    }
                }
                
                // 提取数据列
                const dataValues = [];
                for (let j = startCol; j <= endCol && j < row.length; j++) {
                    const value = parseNumber(row[j]);
                    dataValues.push(value);
                }
                
                // 验证数据点数量
                const expectedPoints = dataColumnCount; // 使用计算出的数据列数量
                if (dataValues.length < expectedPoints * 0.8) { // 允许20%的数据缺失
                    console.warn(`数据点不足，日期: ${dateStr}, 实际: ${dataValues.length}, 预期: ${expectedPoints}`);
                    continue;
                }
                
                // 添加到解析数据
                appData.parsedData.push({
                    date: date,
                    dateStr: dateStr,
                    rawData: dataValues,
                    multiplier: multiplier,
                    sourceFile: worksheet.file.name,
                    meteringPoint: meteringPointCol !== null ? String(row[meteringPointCol]).trim() : null,
                    timeInterval: autoDetectedInterval, // 保存自动检测到的时间间隔
                    dataStructure: 'columnToRow' // 标记数据结构类型
                });
            }
        } else {
            // 新的列对列数据处理逻辑
            // 对于列对列结构，日期在某一列，数据在另一列
            const dataCol = parseInt(appData.config.dataStartColumn); // 只使用起始列作为数据列
            
            // 跳过表头行，尝试自动检测数据起始行
            let startRow = startIndex;
            for (let i = startIndex; i < Math.min(startIndex + 10, data.length); i++) {
                if (data[i] && data[i][dateCol] && isDateLike(data[i][dateCol])) {
                    startRow = i;
                    break;
                }
            }
            
            // 对于列对列结构，使用用户选择的时间间隔而不是自动检测
            const timeInterval = parseInt(appData.config.timeInterval);
            
            // 按日期分组处理数据
            const dateGroups = {};
            
            // 处理每一行数据
            for (let i = startRow; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 检查计量点编号筛选
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) {
                        continue; // 跳过不匹配的行
                    }
                }
                
                // 检查附加筛选项
                let skipRow = false;
                appData.config.additionalFilters.forEach(filter => {
                    if (filter.column && filter.value) {
                        const col = parseInt(filter.column);
                        const rowValue = String(row[col]).trim();
                        if (rowValue !== filter.value) {
                            skipRow = true;
                        }
                    }
                });
                
                if (skipRow) {
                    continue; // 跳过不匹配的行
                }
                
                // 解析日期和时间
                const dateTimeStr = String(row[dateCol]).trim();
                const dateTime = parseDateTime(dateTimeStr, appData.config.dateFormat);
                if (!dateTime) continue;
                
                // 提取日期部分作为分组键
                const dateKey = formatDateKey(dateTime);
                
                // 获取倍率值
                let multiplier = appData.config.multiplier;
                if (multiplierCol !== null && row[multiplierCol] !== undefined) {
                    const parsedMultiplier = parseNumber(row[multiplierCol]);
                    if (parsedMultiplier !== null) {
                        multiplier = parsedMultiplier;
                    }
                }
                
                // 提取数据值
                const value = parseNumber(row[dataCol]);
                if (value === null) continue;
                
                // 初始化日期分组（如果不存在）
                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = {
                        date: new Date(dateTime),
                        dateStr: dateKey,
                        dataPoints: [],
                        multiplier: multiplier,
                        sourceFile: worksheet.file.name,
                        meteringPoint: meteringPointCol !== null ? String(row[meteringPointCol]).trim() : null,
                        timeInterval: timeInterval, // 使用用户选择的时间间隔
                        dataStructure: 'columnToColumn' // 标记数据结构类型
                    };
                }
                
                // 添加数据点到日期分组
                dateGroups[dateKey].dataPoints.push({
                    time: dateTime,
                    value: value
                });
            }
            
            // 将分组数据转换为解析数据格式
            Object.values(dateGroups).forEach(group => {
                // 按时间排序数据点
                group.dataPoints.sort((a, b) => a.time - b.time);
                
                // 添加到解析数据
                appData.parsedData.push({
                    date: group.date,
                    dateStr: group.dateStr,
                    rawData: group.dataPoints.map(p => p.value),
                    multiplier: group.multiplier,
                    sourceFile: group.sourceFile,
                    meteringPoint: group.meteringPoint,
                    timeInterval: group.timeInterval,
                    dataStructure: 'columnToColumn', // 标记数据结构类型
                    dataPoints: group.dataPoints // 保存原始数据点，包含时间信息
                });
            });
        }
    });
    
    // 按日期排序
    appData.parsedData.sort((a, b) => a.date - b.date);
    
    // 处理数据生成小时级数据
    processParsedData();
}

        function processParsedData() {
    appData.processedData = [];
    
    appData.parsedData.forEach(parsedRow => {
        const dataStructure = parsedRow.dataStructure || 'columnToRow'; // 默认为列对行结构
        const interval = parsedRow.timeInterval || appData.config.timeInterval;
        
        if (dataStructure === 'columnToRow') {
            // 原有的列对行数据处理逻辑
            let pointsPerHour;
            
            // 根据时间间隔计算每小时数据点数
            if (interval === 1) {
                pointsPerHour = 60; // 每小时60个数据点（每分钟一个）
            } else if (interval === 5) {
                pointsPerHour = 12; // 每小时12个数据点（每5分钟一个）
            } else if (interval === 15) {
                pointsPerHour = 4; // 每小时4个数据点（每15分钟一个）
            } else if (interval === 30) {
                pointsPerHour = 2; // 每小时2个数据点（每30分钟一个）
            } else if (interval === 60) {
                pointsPerHour = 1; // 每小时1个数据点（每60分钟一个）
            } else {
                pointsPerHour = Math.floor(60 / interval); // 计算每小时数据点数
            }
            
            const hourlyData = [];
            let processedRawData = parsedRow.rawData;
            
            // 检查是否为跨日期结构数据
            const isCrossDateStructure = document.getElementById('crossDateStructure') && document.getElementById('crossDateStructure').checked;
            
            // 如果是跨日期结构数据，需要确保时间序列的逻辑正确性
            if (isCrossDateStructure && interval === 15) {
                // 对于15分钟间隔的跨日期结构数据，每4个单元格组合为1小时数据组
                // 需要确保数据的时间顺序正确，避免时间顺序颠倒
                
                // 将数据按小时分组（每4个数据点为一小时）
                const totalHours = Math.floor(processedRawData.length / pointsPerHour);
                
                for (let hour = 0; hour < totalHours; hour++) {
                    const startIdx = hour * pointsPerHour;
                    const endIdx = startIdx + pointsPerHour;
                    const hourData = processedRawData.slice(startIdx, endIdx);
                    
                    // 处理无效数据
                    const cleanedData = cleanData(hourData);
                    
                    // 根据数据类型计算小时电能
                    let hourlyValue;
                    
                    if (appData.config.dataType === 'instantPower') {
                        // 瞬时功率数据 (kW)
                        const validData = cleanedData.filter(v => v !== null);
                        if (validData.length === 0) {
                            hourlyValue = null; // 标记为无效
                        } else {
                            const sum = validData.reduce((a, b) => a + b, 0);
                            const avgPower = sum / validData.length; // 计算平均功率
                            hourlyValue = avgPower * 1 * parsedRow.multiplier; // 平均功率×1小时×倍率
                        }
                    } else {
                        // 累积电能数据 (kWh)
                        if (cleanedData.length < 2) {
                            hourlyValue = null; // 数据不足
                        } else {
                            const startValue = cleanedData[0];
                            const endValue = cleanedData[cleanedData.length - 1];
                            
                            if (startValue === null || endValue === null) {
                                hourlyValue = null; // 起始或结束值无效
                            } else if (endValue < startValue) {
                                // 累积值回退，标记为异常
                                console.warn(`累积值异常，日期: ${parsedRow.dateStr}, 小时: ${hour}`);
                                hourlyValue = null;
                            } else {
                                hourlyValue = (endValue - startValue) * parsedRow.multiplier;
                            }
                        }
                    }
                    
                    hourlyData.push(hourlyValue);
                }
                
                // 如果数据不足24小时，用null填充剩余小时
                while (hourlyData.length < 24) {
                    hourlyData.push(null);
                }
            } else {
                // 非跨日期结构数据或其他时间间隔的常规处理
                // 处理每小时数据
                for (let hour = 0; hour < 24; hour++) {
                    const startIdx = hour * pointsPerHour;
                    const endIdx = startIdx + pointsPerHour;
                    const hourData = processedRawData.slice(startIdx, endIdx);
                    
                    // 处理无效数据
                    const cleanedData = cleanData(hourData);
                    
                    // 根据数据类型计算小时电能
                    let hourlyValue;
                    
                    if (appData.config.dataType === 'instantPower') {
                        // 瞬时功率数据 (kW)
                        if (interval === 1) {
                            // 1分钟间隔特殊处理：获取第一个小时所有数据点，过滤无效数据后计算总和，通过总和除以有效数据点数得到平均功率，再乘以1小时和倍率
                            const validData = cleanedData.filter(v => v !== null);
                            if (validData.length === 0) {
                                hourlyValue = null; // 标记为无效
                            } else {
                                const sum = validData.reduce((a, b) => a + b, 0);
                                const avgPower = sum / validData.length; // 计算平均功率
                                hourlyValue = avgPower * 1 * parsedRow.multiplier; // 平均功率×1小时×倍率
                            }
                        } else {
                            // 其他间隔：计算(求和结果 ÷ 数据点数) × 1小时 × 倍率 → kWh
                            const validData = cleanedData.filter(v => v !== null);
                            if (validData.length === 0) {
                                hourlyValue = null; // 标记为无效
                            } else {
                                const sum = validData.reduce((a, b) => a + b, 0);
                                const avgPower = sum / validData.length;
                                hourlyValue = avgPower * 1 * parsedRow.multiplier; // 平均功率×1小时×倍率
                            }
                        }
                    } else {
                        // 累积电能数据 (kWh)
                        if (interval === 1) {
                            // 1分钟间隔特殊处理：将每小时内第46-60个单元格数据之和减去第1-15个单元格数据之和，作为1小时一组的数据
                            if (cleanedData.length < 60) {
                                hourlyValue = null; // 数据不足
                            } else {
                                // 第一组：1-15分钟
                                const firstQuarter = cleanedData.slice(0, 15).filter(v => v !== null);
                                // 第二组：46-60分钟
                                const lastQuarter = cleanedData.slice(45, 60).filter(v => v !== null);
                                
                                if (firstQuarter.length === 0 || lastQuarter.length === 0) {
                                    hourlyValue = null; // 数据不足
                                } else {
                                    const firstSum = firstQuarter.reduce((a, b) => a + b, 0);
                                    const lastSum = lastQuarter.reduce((a, b) => a + b, 0);
                                    hourlyValue = (lastSum - firstSum) * parsedRow.multiplier;
                                }
                            }
                        } else {
                            // 其他间隔：计算(当前小时末 - 当前小时初) × 倍率 → kWh
                            if (cleanedData.length < 2) {
                                hourlyValue = null; // 数据不足
                            } else {
                                const startValue = cleanedData[0];
                                const endValue = cleanedData[cleanedData.length - 1];
                                
                                if (startValue === null || endValue === null) {
                                    hourlyValue = null; // 起始或结束值无效
                                } else if (endValue < startValue) {
                                    // 累积值回退，标记为异常
                                    console.warn(`累积值异常，日期: ${parsedRow.dateStr}, 小时: ${hour}`);
                                    hourlyValue = null;
                                } else {
                                    hourlyValue = (endValue - startValue) * parsedRow.multiplier;
                                }
                            }
                        }
                    }
                    
                    hourlyData.push(hourlyValue);
                }
            }
            
            // 计算日总电能
            const validHourlyData = hourlyData.filter(v => v !== null);
            const dailyTotal = validHourlyData.reduce((a, b) => a + b, 0);
            
            appData.processedData.push({
                date: parsedRow.dateStr,
                dateObj: parsedRow.date,
                hourlyData: hourlyData,
                dailyTotal: dailyTotal,
                sourceFile: parsedRow.sourceFile,
                meteringPoint: parsedRow.meteringPoint,
                timeInterval: interval, // 保存时间间隔信息
                dataStructure: 'columnToRow' // 标记数据结构类型
            });
        } else {
            // 按照精确计算规则重构列对列数据处理
            const hourlyData = new Array(24).fill(null);
            
            // 根据时间间隔计算每小时数据点数
            let pointsPerHour;
            if (interval === 1) {
                pointsPerHour = 60; // 1分钟间隔：每小时60个数据点
            } else if (interval === 5) {
                pointsPerHour = 12; // 5分钟间隔：每小时12个数据点
            } else if (interval === 15) {
                pointsPerHour = 4; // 15分钟间隔：每小时4个数据点
            } else if (interval === 30) {
                pointsPerHour = 2; // 30分钟间隔：每小时2个数据点
            } else if (interval === 60) {
                pointsPerHour = 1; // 60分钟间隔：每小时1个数据点
            } else {
                pointsPerHour = Math.floor(60 / interval);
            }
            
            // 确保数据点总数正确（1440个为1分钟间隔，96个为15分钟间隔等）
            const expectedTotalPoints = 24 * pointsPerHour;
            
            // 处理每个数据点
            if (parsedRow.dataPoints && parsedRow.dataPoints.length >= expectedTotalPoints) {
                const allPoints = parsedRow.dataPoints;
                
                if (appData.config.dataType === 'instantPower') {
                    // 瞬时功率数据处理
                    for (let hour = 0; hour < 24; hour++) {
                        // 计算当前小时的数据点范围
                        const startIndex = hour * pointsPerHour;
                        const endIndex = startIndex + pointsPerHour;
                        
                        // 获取当前小时的连续数据点
                        const hourPoints = allPoints.slice(startIndex, endIndex)
                            .map(p => p.value)
                            .filter(v => v !== null && !isNaN(v));
                        
                        if (hourPoints.length > 0) {
                            // 计算有效数据的平均值
                            const sum = hourPoints.reduce((a, b) => a + b, 0);
                            const avgValue = sum / hourPoints.length;
                            
                            // 计算小时用电量：平均值 × 1小时 × 倍率
                            hourlyData[hour] = avgValue * 1 * parsedRow.multiplier;
                        }
                    }
                } else {
                    // 累积电能数据处理
                    for (let hour = 0; hour < 24; hour++) {
                        // 计算当前小时的数据点范围
                        const startIndex = hour * pointsPerHour;
                        const endIndex = startIndex + pointsPerHour;
                        
                        // 获取当前小时的连续数据点
                        const hourPoints = allPoints.slice(startIndex, endIndex)
                            .map(p => p.value)
                            .filter(v => v !== null && !isNaN(v));
                        
                        if (hourPoints.length > 0) {
                            // 按时间排序
                            const sortedPoints = [...hourPoints].sort((a, b) => a - b);
                            
                            // 获取第一个和最后一个有效数据点
                            const firstValue = sortedPoints[0];
                            const lastValue = sortedPoints[sortedPoints.length - 1];
                            
                            if (lastValue >= firstValue) {
                                // 计算电能变化量：最后一个值 - 第一个值，再乘以倍率
                                hourlyData[hour] = (lastValue - firstValue) * parsedRow.multiplier;
                            } else {
                                // 累积值回退，标记为异常
                                console.warn(`累积值异常，日期: ${parsedRow.dateStr}, 小时: ${hour}`);
                                hourlyData[hour] = null;
                            }
                        }
                    }
                }
            } else {
                console.warn(`数据点数量不足，期望${expectedTotalPoints}个，实际${parsedRow.dataPoints ? parsedRow.dataPoints.length : 0}个`);
            }
            
            // 计算日总电能
            const validHourlyData = hourlyData.filter(v => v !== null);
            const dailyTotal = validHourlyData.reduce((a, b) => a + b, 0);
            
            appData.processedData.push({
                date: parsedRow.dateStr,
                dateObj: parsedRow.date,
                hourlyData: hourlyData,
                dailyTotal: dailyTotal,
                sourceFile: parsedRow.sourceFile,
                meteringPoint: parsedRow.meteringPoint,
                timeInterval: interval, // 保存时间间隔信息
                dataStructure: 'columnToColumn' // 标记数据结构类型
            });
        }
    });
    
    // 过滤掉所有数据都为空的日期
    appData.processedData = appData.processedData.filter(row => {
        return row.hourlyData.some(value => value !== null);
    });
    
    // 在数据处理完成后，更新历史记录
    if (appData.importHistory.length > 0) {
        // 获取最近一次导入的记录
        const latestRecord = appData.importHistory[appData.importHistory.length - 1];
        
        // 更新处理结果
        latestRecord.validRecordCount = appData.parsedData.length;
        latestRecord.invalidRecordCount = appData.worksheets[0].data.length - 1 - appData.parsedData.length; // 总行数减去表头和有效行数
        latestRecord.timeInterval = appData.config.timeInterval;
        latestRecord.config = {
            dataType: appData.config.dataType,
            multiplier: appData.config.multiplier,
            dateColumn: appData.config.dateColumn,
            dataStartColumn: appData.config.dataStartColumn,
            dataEndColumn: appData.config.dataEndColumn,
            dataStructure: document.querySelector('input[name="dataStructure"]:checked').value // 保存数据结构类型
        };
        
        // 保存更新后的历史记录
        saveImportHistory();
        renderImportHistory();
    }
}

        function cleanData(data) {
            // 处理无效数据
            return data.map((value, index, array) => {
                if (value === null || isNaN(value)) {
                    // 无效数据
                    if (appData.config.invalidDataHandling === 'ignore') {
                        return null;
                    } else {
                        // 用相邻数据填充
                        let prevValue = null;
                        for (let i = index - 1; i >= 0; i--) {
                            if (array[i] !== null && !isNaN(array[i])) {
                                prevValue = array[i];
                                break;
                            }
                        }
                        
                        let nextValue = null;
                        for (let i = index + 1; i < array.length; i++) {
                            if (array[i] !== null && !isNaN(array[i])) {
                                nextValue = array[i];
                                break;
                            }
                        }
                        
                        if (prevValue !== null && nextValue !== null) {
                            return (prevValue + nextValue) / 2;
                        } else if (prevValue !== null) {
                            return prevValue;
                        } else if (nextValue !== null) {
                            return nextValue;
                        } else {
                            return null; // 无法填充
                        }
                    }
                }
                return value;
            });
        }

        function checkConfigValidity() {
            // 获取数据结构类型
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // 根据数据结构类型验证配置
            let isValid = appData.config.dateColumn !== '' && 
                          appData.config.dataStartColumn !== '';
            
            // 如果是列对行结构，还需要验证结束列
            if (dataStructure === 'columnToRow') {
                isValid = isValid && appData.config.dataEndColumn !== '';
            }
            
            // 调试信息：输出配置值
            console.log('checkConfigValidity 调试信息:');
            console.log('数据结构类型:', dataStructure);
            console.log('dateColumn:', appData.config.dateColumn);
            console.log('dataStartColumn:', appData.config.dataStartColumn);
            console.log('dataEndColumn:', appData.config.dataEndColumn);
            console.log('isValid (基本条件):', isValid);
            
            // 确保结束列不小于起始列（仅对列对行结构）
            if (isValid && dataStructure === 'columnToRow') {
                const startCol = parseInt(appData.config.dataStartColumn);
                const endCol = parseInt(appData.config.dataEndColumn);
                
                console.log('startCol (数字):', startCol);
                console.log('endCol (数字):', endCol);
                console.log('endCol < startCol:', endCol < startCol);
                
                if (endCol < startCol) {
                    elements.nextToVisualizationBtn.disabled = true;
                    showNotification('警告', '结束列不能小于起始列', 'warning');
                    console.log('按钮被禁用：结束列小于起始列');
                    return false;
                }
            }
            
            console.log('最终按钮状态:', !isValid ? '禁用' : '启用');
            elements.nextToVisualizationBtn.disabled = !isValid;
            return isValid;
        }

        function updateMeteringPointFilterOptions() {
            // 清空现有选项
            elements.meteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            elements.visualizationMeteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            
            // 重置计量点列表
            appData.meteringPoints = [];
            
            // 如果没有选择计量点编号列，则返回
            if (!appData.config.meteringPointColumn) return;
            
            const meteringPointCol = parseInt(appData.config.meteringPointColumn);
            
            // 收集所有唯一的计量点编号
            const meteringPointSet = new Set();
            
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // 跳过表头行，尝试自动检测数据起始行
                let startRow = 0;
                for (let i = 0; i < Math.min(10, data.length); i++) {
                    if (data[i] && data[i][meteringPointCol] && !isDateLike(data[i][meteringPointCol])) {
                        startRow = i;
                        break;
                    }
                }
                
                // 收集计量点编号
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[meteringPointCol]) continue;
                    
                    const meteringPoint = String(row[meteringPointCol]).trim();
                    if (meteringPoint) {
                        meteringPointSet.add(meteringPoint);
                    }
                }
            });
            
            // 转换为数组并排序
            appData.meteringPoints = Array.from(meteringPointSet).sort();
            
            // 添加到下拉菜单
            appData.meteringPoints.forEach(point => {
                const option1 = document.createElement('option');
                option1.value = point;
                option1.textContent = point;
                elements.meteringPointFilterSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = point;
                option2.textContent = point;
                elements.visualizationMeteringPointFilterSelect.appendChild(option2);
            });
            
            // 默认选择全部计量点
            appData.config.meteringPointFilter = '';
            appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
        }

        // 可视化部分函数
        function initializeVisualization() {
            // 填充日期下拉选择框
            updateVisualizationDateSelects();
            
            // 默认选择所有日期
            appData.visualization.selectedDates = appData.processedData.map(d => d.date);
            
            // 默认选择所有计量点
            if (appData.meteringPoints.length > 0) {
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
            }
                
                // 初始化图表区域点击事件处理
                document.getElementById('chartContainer').addEventListener('click', function(e) {
                    // 阻止事件冒泡，防止图形消失
                    e.stopPropagation();
                    
                    // 如果点击的是canvas元素，不进行任何操作
                    if (e.target.tagName === 'CANVAS') {
                        return;
                    }
                    
                    // 如果点击的是加载状态或无数据消息区域，也不进行任何操作
                    if (e.target.id === 'chartLoading' || e.target.id === 'noDataMessage' || 
                        e.target.closest('#chartLoading') || e.target.closest('#noDataMessage')) {
                        return;
                    }
                });
                
                // 注：toggleLegend元素已删除，图例显示控制已集成到图表配置中
                
                // 初始化柱状图区域点击事件处理
                document.getElementById('barChartContainer').addEventListener('click', function(e) {
                    // 阻止事件冒泡，防止图形消失
                    e.stopPropagation();
                    
                    // 如果点击的是canvas元素，不进行任何操作
                    if (e.target.tagName === 'CANVAS') {
                        return;
                    }
                    
                    // 如果点击的是加载状态或无数据消息区域，也不进行任何操作
                    if (e.target.id === 'barChartLoading' || e.target.id === 'barChartNoDataMessage' || 
                        e.target.closest('#barChartLoading') || e.target.closest('#barChartNoDataMessage')) {
                        return;
                    }
                });
                
                // 注：toggleBarLegend元素已删除，柱状图图例显示控制已集成到图表配置中
                
                // 初始化图表
                // 检查是否已存在图表实例，如果存在则先销毁
                if (appData.chart) {
                    appData.chart.destroy();
                    appData.chart = null;
                }
                

                
                const ctx = elements.loadCurveChart.getContext('2d');
                appData.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 15,
                                bottom: 10,
                                left: 15
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutCubic',
                            delay: (context) => {
                                let delay = 0;
                                if (context.type === 'data' && context.mode === 'default') {
                                    delay = context.dataIndex * 30;
                                }
                                return delay;
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '24小时负荷曲线',
                                font: {
                                    size: 18,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 15
                                },
                                color: '#1F2937'
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'center',
                                labels: {
                                    usePointStyle: true,
                                    padding: 8,
                                    font: {
                                        size: 11,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    // 自动调整图例布局以适应容器宽度
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                        
                                        // 根据数据集数量调整图例显示
                                        if (datasets.length > 20) {
                                            // 数据集较多时，减小字体和间距
                                            originalLabels.forEach(label => {
                                                label.font = {
                                                    size: 10,
                                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                                    weight: '500'
                                                };
                                                label.padding = 6;
                                                label.boxWidth = 6;
                                                label.boxHeight = 6;
                                            });
                                        }
                                        
                                        return originalLabels;
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#1F2937',
                                titleFont: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                bodyColor: '#4B5563',
                                bodyFont: {
                                    size: 13,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif'
                                },
                                borderColor: 'rgba(0, 0, 0, 0.1)',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true,
                                boxWidth: 10,
                                boxHeight: 10,
                                boxPadding: 4,
                                usePointStyle: true,
                                caretSize: 8,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return '时间: ' + tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // 根据数据集使用的Y轴显示不同的单位
                                            const unit = context.dataset.yAxisID === 'y1' ? 'kW' : 'kWh';
                                            label += context.parsed.y.toFixed(2) + ' ' + unit;
                                        }
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    maxRotation: 0,
                                    autoSkip: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '用电量 (kWh)',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            },
                            y1: {
                                display: appData.visualization.secondaryAxis,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '功率 (kW)',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false, // 不在图表区域绘制网格线
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const datasetIndex = element.datasetIndex;
                                const index = element.index;
                                const dataset = appData.chart.data.datasets[datasetIndex];
                                const value = dataset.data[index];
                                const label = appData.chart.data.labels[index];
                                
                                showNotification(
                                    '数据点详情', 
                                    `${dataset.label} 在 ${label} 的${dataset.yAxisID === 'y1' ? '功率' : '用电量'}为 ${value ? value.toFixed(2) : '无数据'} ${dataset.yAxisID === 'y1' ? 'kW' : 'kWh'}`,
                                    'info'
                                );
                            }
                        },
                        onHover: (event, elements) => {
                            event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            
                            // 添加canvas区域的互动反馈
                            const canvas = event.native.target;
                            if (elements.length > 0) {
                                canvas.style.filter = 'brightness(1.05)';
                            } else {
                                canvas.style.filter = 'brightness(1)';
                            }
                        }
                    }
                });
                
                // 确保图表显示数据
                setTimeout(() => {
                    updateChart();
                }, 100);
            }

        // 更新可视化部分的日期下拉选择框
        function updateVisualizationDateSelects() {
            // 清空现有选项
            elements.startDateInput.innerHTML = '<option value="">-- 请选择起始日期 --</option>';
            elements.endDateInput.innerHTML = '<option value="">-- 请选择结束日期 --</option>';
            
            // 如果没有处理过的数据，则返回
            if (appData.processedData.length === 0) return;
            
            const dateSet = new Set();
            
            // 收集所有唯一的日期
            appData.processedData.forEach(row => {
                dateSet.add(row.date);
            });
            
            // 转换为数组并排序
            const dates = Array.from(dateSet).sort();
            
            // 添加到下拉菜单
            dates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.startDateInput.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.endDateInput.appendChild(option2);
            });
            
            // 设置默认值为最早和最晚日期
            if (dates.length > 0) {
                elements.startDateInput.value = dates[0];
                elements.endDateInput.value = dates[dates.length - 1];
            }
        }

        function applyDateFilter() {
            const startDate = elements.startDateInput.value;
            const endDate = elements.endDateInput.value;
            
            if (!startDate || !endDate) {
                showNotification('警告', '请选择完整的日期范围', 'warning');
                return;
            }
            
            // 筛选日期
            appData.visualization.selectedDates = appData.processedData
                .filter(d => {
                    return d.date >= startDate && d.date <= endDate;
                })
                .map(d => d.date);
            
            updateChart();
        }

        function selectAllDates() {
    appData.visualization.selectedDates = appData.processedData.map(d => d.date);
    
    // 更新图表标题以反映日期选择状态
    if (appData.chart) {
        const selectedCount = appData.visualization.selectedDates.length;
        const totalCount = appData.processedData.length;
        appData.chart.options.plugins.title.text = `${appData.visualization.focusStartTime}:00 - ${appData.visualization.focusEndTime}:00 负荷曲线 (已选择 ${selectedCount}/${totalCount} 个日期)`;
    }
    
    updateChart();
}

        function deselectAllDates() {
    appData.visualization.selectedDates = [];
    
    // 更新图表标题以反映日期选择状态
    if (appData.chart) {
        const totalCount = appData.processedData.length;
        appData.chart.options.plugins.title.text = `${appData.visualization.focusStartTime}:00 - ${appData.visualization.focusEndTime}:00 负荷曲线 (已选择 0/${totalCount} 个日期)`;
    }
    
    updateChart();
}

        function applyMeteringPointFilter() {
            const selectedOptions = Array.from(elements.visualizationMeteringPointFilterSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showNotification('警告', '请至少选择一个计量点编号', 'warning');
                return;
            }
            
            // 筛选计量点编号
            appData.visualization.selectedMeteringPoints = selectedOptions.map(option => option.value);
            
            updateChart();
        }
        
        function selectAllMeteringPoints() {
            appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
            
            // 更新UI选择状态
            Array.from(elements.visualizationMeteringPointFilterSelect.options).forEach(option => {
                option.selected = true;
            });
            
            updateChart();
        }
        
        function applyTimeFocus() {
            const startHour = parseInt(elements.focusStartTimeSelect.value);
            const endHour = parseInt(elements.focusEndTimeSelect.value);
            
            if (startHour > endHour) {
                showNotification('警告', '开始时间不能晚于结束时间', 'warning');
                return;
            }
            
            appData.visualization.focusStartTime = startHour;
            appData.visualization.focusEndTime = endHour;
            
            // 添加视觉反馈
            elements.applyTimeFocusBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.applyTimeFocusBtn.style.transform = 'scale(1)';
            }, 200);
            
            // 更新图表和统计信息
            updateChart();
            
            // 显示通知
            showNotification('时间焦段更新', `已设置时间焦段为 ${startHour}:00 - ${endHour}:00`, 'success');
        }

        function resetTimeFocus() {
            elements.focusStartTimeSelect.value = '0';
            elements.focusEndTimeSelect.value = '23';
            appData.visualization.focusStartTime = 0;
            appData.visualization.focusEndTime = 23;
            
            // 添加视觉反馈
            elements.resetTimeFocusBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.resetTimeFocusBtn.style.transform = 'scale(1)';
            }, 200);
            
            // 更新图表和统计信息
            updateChart();
            
            // 显示通知
            showNotification('时间焦段重置', '已重置时间焦段为全天 (0:00 - 23:00)', 'success');
        }

        function updateChart() {
            // 检查图表实例是否存在，如果不存在则重新初始化
            if (!appData.chart) {
                initializeVisualization();
                return;
            }
            
            // 获取筛选后的数据
            let filteredData = getFilteredData();
            
            // 根据时间焦段设置准备图表数据
            const startHour = appData.visualization.focusStartTime;
            const endHour = appData.visualization.focusEndTime;
            const hourCount = endHour - startHour + 1;
            const labels = Array.from({ length: hourCount }, (_, i) => `${startHour + i}:00`);
            
            // 创建数据集
            const datasets = [];
            
            // 为每个日期创建一个数据集
            const dateGroups = {};
            
            // 按日期分组数据
            filteredData.forEach(row => {
                const dateKey = row.date; // 使用完整日期作为键
                
                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = [];
                }
                
                dateGroups[dateKey].push(row);
            });
            
            // 为每个日期创建数据集
            let colorIndex = 0;
            Object.keys(dateGroups).sort().forEach(dateKey => {
                const rows = dateGroups[dateKey];
                
                // 合并同一日期的所有行数据
                const mergedHourlyData = new Array(24).fill(null);
                
                rows.forEach(row => {
                    for (let hour = 0; hour < 24; hour++) {
                        if (row.hourlyData[hour] !== null) {
                            if (mergedHourlyData[hour] !== null) {
                                // 如果已有数据，取总和
                                mergedHourlyData[hour] = mergedHourlyData[hour] + row.hourlyData[hour];
                            } else {
                                mergedHourlyData[hour] = row.hourlyData[hour];
                            }
                        }
                    }
                });
                
                // 根据时间焦段设置过滤数据
                const filteredHourlyData = mergedHourlyData.slice(startHour, endHour + 1);
                
                // 为每个日期生成不同的颜色
                const color = getColor(colorIndex % getColorCount());
                colorIndex++;
                
                // 根据用户设置确定线条样式
                let borderDash = [];
                if (appData.visualization.lineStyle === 'dashed') {
                    borderDash = [5, 5];
                } else if (appData.visualization.lineStyle === 'dotted') {
                    borderDash = [2, 2];
                }
                
                // 根据用户设置确定是否显示数据点
                const pointRadius = appData.visualization.showPoints ? 4 : 0;
                const pointHoverRadius = appData.visualization.showPoints ? 6 : 0;
                
                // 根据用户设置确定曲线平滑度
                const tension = appData.visualization.smoothCurve ? appData.visualization.curveTension : 0;
                
                // 创建渐变背景
                const gradient = appData.chart.ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color.replace('rgb', 'rgba').replace(')', ', 0.4)'));
                gradient.addColorStop(1, color.replace('rgb', 'rgba').replace(')', ', 0.05)'));
                
                // 创建纯线条图数据集
                datasets.push({
                    label: dateKey, // 使用日期作为标签
                    data: filteredHourlyData,
                    borderColor: color,
                    backgroundColor: 'transparent', // 完全透明背景，无面积填充
                    borderWidth: 2.5, // 线条粗细
                    borderDash: borderDash,
                    borderCapStyle: 'round',
                    borderJoinStyle: 'round',
                    segment: {
                        borderColor: ctx => {
                            // 为渐变效果创建更平滑的线条
                            return ctx.p0.parsed.y !== null && ctx.p1.parsed.y !== null ? color : 'rgba(0,0,0,0)';
                        },
                        borderDash: ctx => {
                            // 为渐变效果创建更平滑的线条
                            return ctx.p0.parsed.y !== null && ctx.p1.parsed.y !== null ? borderDash : [];
                        }
                    },
                    pointRadius: pointRadius === 4 ? 3 : 0, // 数据点大小
                    pointHoverRadius: pointHoverRadius === 6 ? 5 : 0,
                    pointStyle: 'circle',
                    pointBorderWidth: 2,
                    pointBackgroundColor: '#fff', // 白色内圈
                    pointBorderColor: color, // 外圈线条颜色鲜艳
                    pointHoverBackgroundColor: color, // 悬停时填充颜色与边框相同
                    pointHoverBorderColor: '#fff', // 悬停时边框为白色
                    pointHoverBorderWidth: 3,
                    tension: tension,
                    fill: false, // 禁用面积填充，纯线条图
                    yAxisID: 'y', // 使用主Y轴
                    spanGaps: true // 确保数据点之间有连线
                });
            });
            
            // 已移除均值线和均值区域相关代码
            
            // 更新图表数据
            appData.chart.data.labels = labels;
            appData.chart.data.datasets = datasets;
            

            
            // 更新图表选项
            // 更新图表标题以反映时间焦段和日期选择状态
            const selectedCount = appData.visualization.selectedDates.length;
            const totalCount = appData.processedData.length;
            appData.chart.options.plugins.title.text = `${startHour}:00 - ${endHour}:00 负荷曲线 (已选择 ${selectedCount}/${totalCount} 个日期)`;
            
            // 折线图模式下的选项
            appData.chart.options.scales.x.stacked = false;
            appData.chart.options.scales.y.stacked = false;
            appData.chart.options.plugins.tooltip.mode = 'index';
            appData.chart.options.plugins.tooltip.intersect = false;
            
            // 更新辅助Y轴
            appData.chart.options.scales.y1 = {
                display: appData.visualization.secondaryAxis,
                position: 'right',
                title: {
                    display: true,
                    text: '功率 (kW)',
                    font: {
                        size: 14
                    }
                },
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false // 不在图表区域绘制网格线
                }
            };
            
            // 更新图表（添加错误处理）
            try {
                if (appData.chart && typeof appData.chart.update === 'function') {
                    appData.chart.update('none'); // 使用'none'模式禁用动画，避免动画相关错误
                }
            } catch (error) {
                console.error('图表更新错误:', error);
                // 如果更新失败，尝试重新创建图表
                try {
                    if (appData.chart) {
                        appData.chart.destroy();
                        appData.chart = null;
                    }
                    initializeVisualization();
                } catch (secondError) {
                    console.error('图表重新初始化失败:', secondError);
                    // 显示错误消息给用户
                    showNotification('错误', '图表更新失败，请刷新页面重试', 'error');
                }
            }
            
            // 柱状图始终显示
            const barChartContainer = document.getElementById('dailyTotalBarChart').parentElement.parentElement;
            barChartContainer.style.display = 'block';
            updateDailyTotalBarChart(filteredData);
            
            // 更新统计信息
            updateStatistics(filteredData);
            

            // 启用导出按钮
            if (elements.nextToExportBtn) {
                elements.nextToExportBtn.disabled = false;
            }
            
            // 隐藏加载状态
            document.getElementById('chartLoading').classList.add('hidden');
            
            // 如果没有数据，显示无数据消息，否则隐藏
            if (datasets.length === 0) {
                document.getElementById('noDataMessage').classList.remove('hidden');
            } else {
                document.getElementById('noDataMessage').classList.add('hidden');
            }
        }

        function updateStatistics(displayData, startHour = 0, endHour = 23) {
            // 如果没有传入时间焦段设置，使用appData中的设置
            if (startHour === undefined || endHour === undefined) {
                startHour = appData.visualization.focusStartTime;
                endHour = appData.visualization.focusEndTime;
            }
            
            // 计算每日统计
            let dailyStatsHtml = '<table class="w-full border-collapse">';
            dailyStatsHtml += '<tr class="bg-gray-50">';
            dailyStatsHtml += '<th class="border border-gray-200 p-2 text-left">日期</th>';
            dailyStatsHtml += '<th class="border border-gray-200 p-2 text-right">日总用电量 (kWh)</th>';
            dailyStatsHtml += '<th class="border border-gray-200 p-2 text-right">平均小时用电量 (kWh)</th>';
            dailyStatsHtml += '<th class="border border-gray-200 p-2 text-right">峰谷差值 (kWh)</th>';
            dailyStatsHtml += '</tr>';
            
            const allDailyTotals = [];
            const allHourlyAverages = [];
            
            displayData.forEach((dateData, index) => {
                // 计算日总用电量
                const dailyTotal = dateData.dailyTotal;
                allDailyTotals.push(dailyTotal);
                
                // 计算平均小时用电量
                const validHours = dateData.hourlyData.filter(v => v !== null);
                const hourlyAverage = validHours.length > 0 ? validHours.reduce((a, b) => a + b, 0) / validHours.length : 0;
                allHourlyAverages.push(hourlyAverage);
                
                // 计算峰谷差值
                const peak = Math.max(...validHours);
                const valley = Math.min(...validHours);
                const peakValleyDiff = peak - valley;
                
                // 获取颜色
                const color = getColorForIndex(index);
                
                dailyStatsHtml += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                dailyStatsHtml += `<td class="border border-gray-200 p-2" style="color: ${color}">${dateData.date}</td>`;
                dailyStatsHtml += `<td class="border border-gray-200 p-2 text-right">${dailyTotal.toFixed(2)}</td>`;
                dailyStatsHtml += `<td class="border border-gray-200 p-2 text-right">${hourlyAverage.toFixed(2)}</td>`;
                dailyStatsHtml += `<td class="border border-gray-200 p-2 text-right">${peakValleyDiff.toFixed(2)}</td>`;
                dailyStatsHtml += '</tr>';
            });
            
            dailyStatsHtml += '</table>';
            elements.dailyStats.innerHTML = dailyStatsHtml;
            
            // 计算时段统计
            let periodStatsHtml = '<table class="w-full border-collapse">';
            
            // 添加表格眉头标题
            periodStatsHtml += '<thead>';
            periodStatsHtml += '<tr class="bg-gray-100">';
            periodStatsHtml += '<th class="border border-gray-300 p-2 text-left font-medium">日期</th>';
            periodStatsHtml += '<th class="border border-gray-300 p-2 text-right font-medium">用电量</th>';
            periodStatsHtml += '<th class="border border-gray-300 p-2 text-right font-medium">全天百分比</th>';
            periodStatsHtml += '</tr>';
            periodStatsHtml += '</thead>';
            periodStatsHtml += '<tbody>';
            
            // 计算总时段用电量
            displayData.forEach((dateData, index) => {
                let periodTotal = 0;
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (dateData.hourlyData[hour] !== null) {
                        periodTotal += dateData.hourlyData[hour];
                    }
                }
                
                const percentage = dateData.dailyTotal > 0 
                    ? (periodTotal / dateData.dailyTotal) * 100 
                    : 0;
                
                const color = getColorForIndex(index);
                
                periodStatsHtml += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                periodStatsHtml += `<td class="border border-gray-200 p-2" style="color: ${color}">${dateData.date}</td>`;
                periodStatsHtml += `<td class="border border-gray-200 p-2 text-right">${periodTotal.toFixed(2)} kWh</td>`;
                periodStatsHtml += `<td class="border border-gray-200 p-2 text-right">${percentage.toFixed(1)}%</td>`;
                periodStatsHtml += '</tr>';
            });
            
            // 计算总体时段统计
            let totalPeriodAll = 0;
            let totalDailyAll = 0;
            
            displayData.forEach(dateData => {
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (dateData.hourlyData[hour] !== null) {
                        totalPeriodAll += dateData.hourlyData[hour];
                    }
                }
                totalDailyAll += dateData.dailyTotal;
            });
            
            const overallPercentage = totalDailyAll > 0 
                ? (totalPeriodAll / totalDailyAll) * 100 
                : 0;
            
            periodStatsHtml += '<tr class="bg-primary/10 font-medium">';
            periodStatsHtml += '<td class="border border-gray-200 p-2">总计</td>';
            periodStatsHtml += `<td class="border border-gray-200 p-2 text-right">${totalPeriodAll.toFixed(2)} kWh</td>`;
            periodStatsHtml += `<td class="border border-gray-200 p-2 text-right">${overallPercentage.toFixed(1)}%</td>`;
            periodStatsHtml += '</tr>';
            periodStatsHtml += '</tbody>';
            periodStatsHtml += '</table>';
            periodStatsHtml += `<p class="text-xs text-neutral mt-2">时段: ${startHour}:00 - ${endHour}:00 (占全天百分比)</p>`;
            
            elements.periodStats.innerHTML = periodStatsHtml;
        }

        // 导出部分函数
        function exportAsPNG() {
            if (!appData.chart) {
                showNotification('错误', '没有可导出的图表', 'error');
                return;
            }
            
            const quality = parseFloat(elements.pngQualitySelect.value);
            elements.loadCurveChart.toBlob(blob => {
                saveAs(blob, getExportFileName('图表', 'png'));
                showNotification('成功', '图表已导出为PNG', 'success');
            }, 'image/png', quality);
        }

        function exportAsJPG() {
            if (!appData.chart) {
                showNotification('错误', '没有可导出的图表', 'error');
                return;
            }
            
            elements.loadCurveChart.toBlob(blob => {
                saveAs(blob, getExportFileName('图表', 'jpg'));
                showNotification('成功', '图表已导出为JPG', 'success');
            }, 'image/jpeg', 0.9);
        }

        function exportAsSVG() {
            if (!appData.chart) {
                showNotification('错误', '没有可导出的图表', 'error');
                return;
            }
            
            // 生成SVG
            const svg = chartToSVG(appData.chart);
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            saveAs(blob, getExportFileName('图表', 'svg'));
            showNotification('成功', '图表已导出为SVG', 'success');
        }

        function exportHourlyData() {
            if (appData.processedData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 获取日期范围设置
            const exportAllDates = document.getElementById('exportAllDates').checked;
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            // 筛选要导出的数据
            let exportData = appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date)
            );
            
            // 如果不是导出所有日期，则应用日期范围筛选
            if (!exportAllDates && startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                exportData = exportData.filter(d => {
                    const currentDate = new Date(d.date);
                    return currentDate >= start && currentDate <= end;
                });
            }
            
            if (exportData.length === 0) {
                showNotification('错误', '没有符合筛选条件的数据可导出', 'error');
                return;
            }
            
            // 准备导出数据 - 每个日期24小时数据打包在一个表格
            const header = ['日期'];
            for (let hour = 0; hour < 24; hour++) {
                header.push(`${hour}:00`);
            }
            header.push('日总电能 (kWh)');
            
            const rows = [header];
            
            exportData.forEach(dateData => {
                const rowData = [dateData.date];
                let dailyTotal = 0;
                
                // 添加24小时数据
                for (let hour = 0; hour < 24; hour++) {
                    const value = dateData.hourlyData[hour] !== null 
                        ? dateData.hourlyData[hour] 
                        : 0;
                    
                    rowData.push(value);
                    dailyTotal += value;
                }
                
                // 添加日总电能
                rowData.push(dailyTotal);
                
                rows.push(rowData);
            });
            
            // 导出
            exportDataToFile(rows, '24小时电能明细');
        }

        function exportDailyStats() {
            if (appData.processedData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 筛选要导出的数据
            const exportData = appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date)
            );
            
            if (exportData.length === 0) {
                showNotification('错误', '没有符合筛选条件的数据可导出', 'error');
                return;
            }
            
            // 准备导出数据
            const header = ['日期', '日总用电量 (kWh)', '平均小时用电量 (kWh)', '峰谷差值 (kWh)'];
            const rows = [header];
            
            exportData.forEach(dateData => {
                // 计算统计值
                const validHours = dateData.hourlyData.filter(v => v !== null);
                const hourlyAverage = validHours.length > 0 ? validHours.reduce((a, b) => a + b, 0) / validHours.length : 0;
                const peak = validHours.length > 0 ? Math.max(...validHours) : 0;
                const valley = validHours.length > 0 ? Math.min(...validHours) : 0;
                const peakValleyDiff = peak - valley;
                
                rows.push([
                    dateData.date,
                    dateData.dailyTotal.toFixed(2),
                    hourlyAverage.toFixed(2),
                    peakValleyDiff.toFixed(2)
                ]);
            });
            
            // 导出
            exportDataToFile(rows, '日统计数据');
        }

        function exportDataToFile(data, baseName) {
            const format = elements.exportFormatSelect.value;
            const fileName = getExportFileName(baseName, format);
            
            // 创建工作簿和工作表
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, baseName);
            
            // 导出文件
            if (format === 'csv') {
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, fileName);
            } else {
                // 导出为Excel
                XLSX.writeFile(wb, fileName);
            }
            
            showNotification('成功', `${baseName}已导出为${format.toUpperCase()}`, 'success');
        }

        function getExportFileName(baseName, extension) {
            let fileName = `${elements.exportFileNameInput.value}_${baseName}`;
            
            // 添加筛选条件
            if (elements.includeFiltersInNameCheckbox.checked) {
                const startDate = elements.startDateInput.value || '开始日期';
                const endDate = elements.endDateInput.value || '结束日期';
                fileName += `_${startDate}_to_${endDate}`;
            }
            
            // 添加时间戳
            if (elements.includeTimestampCheckbox.checked) {
                const timestamp = new Date().toISOString().replace(/:/g, '-').slice(0, 19);
                fileName += `_${timestamp}`;
            }
            
            return `${fileName}.${extension}`;
        }

        function updateDataStatus() {
            const dataStatus = document.getElementById('dataStatus');
            const currentDataCount = document.getElementById('currentDataCount');
            const currentDateRange = document.getElementById('currentDateRange');
            const currentMeteringPointCount = document.getElementById('currentMeteringPointCount');
            
            if (appData.parsedData && appData.parsedData.length > 0) {
                dataStatus.classList.remove('hidden');
                
                // 显示当前数据量
                currentDataCount.textContent = appData.parsedData.length.toLocaleString();
                
                // 计算日期范围
                const dates = [...new Set(appData.parsedData.map(item => item.date))].sort();
                if (dates.length > 0) {
                    const startDate = dates[0];
                    const endDate = dates[dates.length - 1];
                    // 使用formatDateRangeDisplay函数格式化日期范围
                    const formattedStartDate = formatDateRangeDisplay(startDate);
                    const formattedEndDate = formatDateRangeDisplay(endDate);
                    currentDateRange.textContent = `${formattedStartDate} ~ ${formattedEndDate}`;
                } else {
                    currentDateRange.textContent = '-';
                }
                
                // 计算计量点数量
                const meteringPoints = [...new Set(appData.parsedData.map(item => item.meteringPoint))];
                currentMeteringPointCount.textContent = meteringPoints.length;
            } else {
                dataStatus.classList.add('hidden');
            }
        }
        
        function startOver() {
            // 重置应用数据
            appData.files = [];
            appData.worksheets = [];
            appData.parsedData = [];
            appData.processedData = [];
            appData.config = {
                dataType: 'instantPower',
                multiplier: 1.0,
                useMultiplierColumn: false,
                multiplierColumn: '',
                dateColumn: '',

                dataStartColumn: '',
                dataEndColumn: '',
                dataStartIndex: 0,
                dataEndIndex: -1,
                meteringPointColumn: '',
                meteringPointFilter: '',
                dateFormat: 'YYYY-MM-DD',
                invalidDataHandling: 'ignore',
                timeInterval: 15,
                filterCount: 1,
                additionalFilters: []
            };
            appData.visualization = {
                selectedDates: [],
                selectedMeteringPoints: [],
                focusStartTime: 0,
                focusEndTime: 23,
                lineStyle: 'solid',
                showPoints: true,
                smoothCurve: false,
                curveTension: 0.2,
                secondaryAxis: false,
                showDailyTotalBarChart: true
            };
            appData.meteringPoints = [];
            
            // 重置UI
            elements.fileInput.value = '';
            elements.importedFiles.innerHTML = '';
            elements.fileList.classList.add('hidden');
            elements.removeAllFiles.classList.add('hidden');
            elements.nextToConfigBtn.disabled = true;
            
            // 重置配置表单
            elements.dataTypeRadios[0].checked = true;
            elements.multiplierInput.value = '1.0';
            elements.useMultiplierColumnCheckbox.checked = false;
            elements.multiplierOptions.classList.remove('hidden');
            elements.multiplierColumnOption.classList.add('hidden');
            elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dateFormatSelect.value = 'YYYY-MM-DD';
            elements.invalidDataHandlingSelect.value = 'ignore';
            elements.timeIntervalSelect.value = '15';
            elements.dataPreview.innerHTML = '请先完成数据配置，将显示数据预览';
            
            // 重置筛选项设置
            elements.filterCountInput.value = '1';
            elements.filterOptionsContainer.innerHTML = '';
            
            // 重置可视化表单
            elements.startDateInput.innerHTML = '<option value="">-- 请选择起始日期 --</option>';
            elements.endDateInput.innerHTML = '<option value="">-- 请选择结束日期 --</option>';
            elements.focusStartTimeSelect.value = '0';
            elements.focusEndTimeSelect.value = '23';
            elements.lineStyleSelect.value = 'solid';
            elements.showPointsSelect.value = 'true';
            elements.smoothCurveSelect.value = 'false';
            elements.curveTensionSelect.value = '0.2';
            elements.secondaryAxisCheckbox.checked = false;
            elements.visualizationMeteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            elements.dailyStats.innerHTML = '<p class="text-neutral">请先生成图表以查看统计信息</p>';
            elements.periodStats.innerHTML = '<p class="text-neutral">请先生成图表以查看统计信息</p>';
            
            // 重置日期选择
            appData.visualization.selectedDates = [];
            if (appData.chart) {
                appData.chart.destroy();
                appData.chart = null;
            }
            
            // 返回到导入部分
            goToImportSection();
            
            showNotification('信息', '已重置所有数据，可以重新开始', 'info');
        }

        // 导航函数
        function goToImportSection() {
            elements.importSection.classList.remove('hidden');
            elements.configSection.classList.add('hidden');
            elements.visualizationSection.classList.add('hidden');
            elements.exportSection.classList.add('hidden');
            
            // 更新步骤指示器
            elements.step2Indicator.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold';
            elements.step2Line.className = 'w-12 h-1 bg-gray-200 ml-2';
            elements.step3Indicator.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold';
            elements.step3Line.className = 'w-12 h-1 bg-gray-200 ml-2';
            elements.step4Indicator.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold';
        }

        function goToConfigSection() {
            elements.importSection.classList.add('hidden');
            elements.configSection.classList.remove('hidden');
            elements.visualizationSection.classList.add('hidden');
            elements.exportSection.classList.add('hidden');
            
            // 更新步骤指示器
            elements.step2Indicator.className = 'w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold';
            elements.step2Line.className = 'w-12 h-1 bg-primary ml-2';
            elements.step3Indicator.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold';
            elements.step3Line.className = 'w-12 h-1 bg-gray-200 ml-2';
            elements.step4Indicator.className = 'w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold';
        }

        function goToVisualizationSection() {
    // 更新计量点编号筛选选项
    updateMeteringPointFilterOptions();
    
    // 更新步骤指示器
    elements.step2Indicator.classList.remove('bg-gray-200', 'text-gray-500');
    elements.step2Indicator.classList.add('bg-primary', 'text-white');
    elements.step2Line.classList.remove('bg-gray-200');
    elements.step2Line.classList.add('bg-primary');
    
    elements.step3Indicator.classList.remove('bg-gray-200', 'text-gray-500');
    elements.step3Indicator.classList.add('bg-primary', 'text-white');
    elements.step3Line.classList.remove('bg-gray-200');
    elements.step3Line.classList.add('bg-primary');
    
    // 切换显示部分
    elements.configSection.classList.add('hidden');
    elements.visualizationSection.classList.remove('hidden');
    elements.exportSection.classList.add('hidden');
    
    // 检查是否已存在图表实例，如果存在则先销毁
    if (appData.chart) {
        appData.chart.destroy();
        appData.chart = null;
    }
    
    // 初始化可视化
            initializeVisualization();
            
            // 初始化日期总用电量柱状图
            initDailyTotalBarChart();
            
            // 确保图表显示数据
            setTimeout(() => {
                updateChart();
            }, 100);
            
}

        function goToExportSection() {
            elements.importSection.classList.add('hidden');
            elements.configSection.classList.add('hidden');
            elements.visualizationSection.classList.add('hidden');
            elements.exportSection.classList.remove('hidden');
            
            // 更新步骤指示器
            elements.step2Indicator.className = 'w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold';
            elements.step2Line.className = 'w-12 h-1 bg-primary ml-2';
            elements.step3Indicator.className = 'w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold';
            elements.step3Line.className = 'w-12 h-1 bg-primary ml-2';
            elements.step4Indicator.className = 'w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold';
        }

        // 通知和模态框函数
        function showNotification(title, message, type = 'info') {
            const iconMap = {
                success: 'fa-check-circle text-success',
                error: 'fa-times-circle text-danger',
                warning: 'fa-exclamation-triangle text-warning',
                info: 'fa-info-circle text-primary'
            };
            
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notificationIcon.className = `fa ${iconMap[type] || iconMap.info}`;
            
            elements.notification.classList.remove('hidden', 'bg-success/10', 'bg-danger/10', 'bg-warning/10', 'bg-primary/10');
            elements.notification.classList.add(`bg-${type === 'info' ? 'primary' : type}/10`);
            
            // 显示动画
            setTimeout(() => {
                elements.notification.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 自动隐藏
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            elements.notification.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => {
                elements.notification.classList.add('hidden');
            }, 300);
        }

        function showModal(title, content) {
            elements.modalTitle.textContent = title;
            elements.modalContent.innerHTML = content;
            
            elements.modalOverlay.classList.remove('hidden');
            setTimeout(() => {
                elements.modal.classList.remove('scale-95', 'opacity-0');
                elements.modal.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            elements.modal.classList.remove('scale-100', 'opacity-100');
            elements.modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                elements.modalOverlay.classList.add('hidden');
            }, 300);
        }

        function showHelpModal() {
            const helpContent = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-primary mb-2">如何使用本工具？</h4>
                        <p class="text-sm">本工具分为四个步骤：导入数据 → 数据配置 → 可视化 → 导出结果。请按照步骤完成操作。</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">支持的数据格式</h4>
                        <p class="text-sm">支持Excel (.xlsx, .xls) 和CSV (.csv) 格式的用电数据表格。</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">数据类型说明</h4>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            <li><strong>15分钟瞬时功率</strong>：每15分钟一个功率值(kW)，工具会计算每小时的电能</li>
                            <li><strong>15分钟累积电能</strong>：每15分钟一个累积电能值(kWh)，工具会计算每小时的电能差值</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">常见问题</h4>
                        <div class="space-y-2 text-sm">
                            <p><strong>Q: 为什么导入文件后没有数据？</strong></p>
                            <p>A: 请检查数据配置是否正确，特别是日期列和数据列的选择是否准确。</p>
                            
                            <p><strong>Q: 如何处理无效数据？</strong></p>
                            <p>A: 工具提供两种处理方式：忽略无效数据或用相邻有效数据填充。</p>
                            
                            <p><strong>Q: 可以同时导入多个文件吗？</strong></p>
                            <p>A: 可以，工具支持多文件导入并合并处理数据。</p>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('使用帮助', helpContent);
        }

        function showAboutModal() {
            const aboutContent = `
                <div class="space-y-4">
                    <div class="text-center">
                        <i class="fa fa-line-chart text-4xl text-primary mb-2"></i>
                        <h4 class="text-xl font-bold text-primary">24小时负荷曲线生成工具</h4>
                        <p class="text-neutral">版本 1.0.0</p>
                    </div>
                    
                    <div>
                        <p class="text-sm">本工具用于处理用电数据表格，生成24小时负荷曲线图表，支持按日期区分曲线类别，适配不同格式的原始数据。</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">主要功能</h4>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            <li>支持多文件导入处理汇总</li>
                            <li>处理15分钟瞬时功率和累积电能数据</li>
                            <li>按日期范围筛选显示曲线</li>
                            <li>自定义显示时段，聚焦用电高峰</li>
                            <li>计算并展示日总用电量等统计信息</li>
                            <li>导出图表为PNG/JPG/SVG，导出数据为Excel/CSV</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showModal('关于工具', aboutContent);
        }

        // 工具函数
        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return null;
            
            // 检查是否为无效数据标记
            const strValue = String(value).trim().toLowerCase();
            if (strValue === '未采集' || strValue === '故障' || strValue === '无数据' || strValue === 'n/a' || strValue === 'null') {
                return null;
            }
            
            // 处理千分位分隔符（如1,234.56或1.234,56）
            let processedStr = strValue;
            
            // 检测并处理千分位分隔符
            // 情况1：1,234.56（逗号为千分位，点号为小数点）
            if (processedStr.includes(',') && processedStr.includes('.')) {
                // 如果逗号在点号前面，且逗号后不是3位数字，则可能是欧洲格式（1.234,56）
                const commaPos = processedStr.indexOf(',');
                const dotPos = processedStr.indexOf('.');
                
                if (commaPos < dotPos && (dotPos - commaPos) !== 4) {
                    // 可能是欧洲格式，将点号替换为空，逗号替换为点号
                    processedStr = processedStr.replace(/\./g, '').replace(',', '.');
                } else {
                    // 标准格式，移除逗号
                    processedStr = processedStr.replace(/,/g, '');
                }
            } 
            // 情况2：1.234,56（点号为千分位，逗号为小数点）
            else if (processedStr.includes(',') && processedStr.lastIndexOf(',') > processedStr.length - 4) {
                // 逗号在最后3位之前，可能是欧洲格式的小数点
                processedStr = processedStr.replace(/\./g, '').replace(',', '.');
            }
            // 情况3：只有逗号，可能是千分位或小数点
            else if (processedStr.includes(',')) {
                const commaPos = processedStr.indexOf(',');
                const afterComma = processedStr.substring(commaPos + 1);
                
                if (afterComma.length === 3 && commaPos > 0) {
                    // 可能是千分位分隔符
                    processedStr = processedStr.replace(/,/g, '');
                } else {
                    // 可能是小数点
                    processedStr = processedStr.replace(',', '.');
                }
            }
            
            // 处理百分比（如12.34%或12,34%）
            if (processedStr.includes('%')) {
                processedStr = processedStr.replace('%', '');
                const num = parseFloat(processedStr);
                return isNaN(num) ? null : num / 100;
            }
            
            // 处理科学计数法（如1.23e+4或1.23E-4）
            if (/[eE][+-]?\d+$/.test(processedStr)) {
                const num = parseFloat(processedStr);
                return isNaN(num) ? null : num;
            }
            
            // 处理货币符号（如$123.45或¥123.45）
            processedStr = processedStr.replace(/[$￥€£¥]/g, '');
            
            // 处理单位（如123.45kW或123.45kWh）
            const unitMatch = processedStr.match(/^([\d.]+)([a-zA-Z]+)$/);
            if (unitMatch) {
                const numStr = unitMatch[1];
                const unit = unitMatch[2].toLowerCase();
                
                const num = parseFloat(numStr);
                if (isNaN(num)) return null;
                
                // 处理常见单位
                switch (unit) {
                    case 'k':
                        return num * 1000;
                    case 'm':
                        return num * 1000000;
                    case 'g':
                        return num * 1000000000;
                    case 't':
                        return num * 1000;
                    default:
                        // 其他单位不转换，只返回数字部分
                        return num;
                }
            }
            
            // 尝试解析为数字
            const num = parseFloat(processedStr);
            return isNaN(num) ? null : num;
        }

        function isDateLike(value) {
            if (!value) return false;
            
            const strValue = String(value).trim();
            if (!strValue) return false;
            
            // 扩展的日期格式检测模式
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/, // YYYY-MM-DD 或 YYYY-M-D
                /^\d{4}\/\d{1,2}\/\d{1,2}$/, // YYYY/MM/DD 或 YYYY/M/D
                /^\d{1,2}\/\d{1,2}\/\d{4}$/, // MM/DD/YYYY 或 DD/MM/YYYY
                /^\d{1,2}\/\d{1,2}\/\d{2}$/, // MM/DD/YY 或 M/D/YY
                /^\d{1,2}-\d{1,2}-\d{4}$/, // DD-MM-YYYY 或 D-M-YYYY
                /^\d{1,2}-\d{1,2}-\d{2}$/, // DD-MM-YY 或 D-M-YY
                /^\d{8}$/, // YYYYMMDD
                /^\d{2}\d{2}\d{4}$/, // DDMMYYYY
                /^\d{4}\.\d{1,2}\.\d{1,2}$/, // YYYY.MM.DD
                /^\d{1,2}\.\d{1,2}\.\d{4}$/, // DD.MM.YYYY
                /^\d{1,2}\.\d{1,2}\.\d{2}$/, // DD.MM.YY
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/, // MM/DD/YYYY HH:MM
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}/, // YYYY-MM-DD HH:MM
                /^\d{1,2}\/\d{1,2}\/\d{2}\s+\d{1,2}:\d{2}/, // MM/DD/YY HH:MM
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}:\d{2}/, // YYYY-MM-DD HH:MM:SS
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}/, // MM/DD/YYYY HH:MM:SS
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}:\d{2}\.\d{3}/, // YYYY-MM-DD HH:MM:SS.mmm
                /^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{2}:\d{2}/, // ISO格式 YYYY-MM-DDTHH:MM:SS
                /^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{2}:\d{2}\.\d{3}/, // ISO格式 YYYY-MM-DDTHH:MM:SS.mmm
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}\s+[AP]M/, // MM/DD/YYYY HH:MM AM/PM
                /^\d{1,2}-\d{1,2}-\d{4}\s+\d{1,2}:\d{2}\s+[AP]M/ // DD-MM-YYYY HH:MM AM/PM
            ];
            
            // 检查是否匹配任何日期格式
            for (let pattern of datePatterns) {
                if (pattern.test(strValue)) {
                    return true;
                }
            }
            
            // 检查是否为Excel日期序列号（纯数字）
            if (/^\d+$/.test(strValue) && parseInt(strValue) > 0) {
                return true;
            }
            
            // 检查是否为日期对象可解析的格式
            const testDate = new Date(strValue);
            if (!isNaN(testDate.getTime()) && strValue.length > 5) {
                return true;
            }
            
            return false;
        }

        function parseDate(dateStr, format) {
            try {
                let year, month, day, hour = 0, minute = 0, second = 0;
                
                dateStr = String(dateStr).trim();
                if (!dateStr) return null;
                
                // 清理日期字符串，移除多余的空格
                dateStr = dateStr.replace(/\s+/g, ' ').trim();
                
                // 处理带时间的日期格式
                let datePart = dateStr;
                let timePart = null;
                
                // 分离日期和时间部分
                const timeMatch = dateStr.match(/(\d{1,2}:\d{2}(?::\d{2})?(?:\.\d{3})?\s*(?:[AP]M)?)$/i);
                if (timeMatch) {
                    timePart = timeMatch[1];
                    datePart = dateStr.substring(0, timeMatch.index).trim();
                }
                
                // 解析时间部分
                if (timePart) {
                    const timeStr = timePart.trim();
                    let timeHour, timeMinute, timeSecond = 0;
                    
                    // 处理AM/PM格式
                    const ampmMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
                    if (ampmMatch) {
                        timeHour = parseInt(ampmMatch[1]);
                        timeMinute = parseInt(ampmMatch[2]);
                        const ampm = ampmMatch[3].toUpperCase();
                        
                        if (ampm === 'PM' && timeHour < 12) timeHour += 12;
                        if (ampm === 'AM' && timeHour === 12) timeHour = 0;
                    } else {
                        // 处理24小时格式
                        const timeParts = timeStr.split(':');
                        timeHour = parseInt(timeParts[0]) || 0;
                        timeMinute = parseInt(timeParts[1]) || 0;
                        if (timeParts[2]) {
                            const secondPart = timeParts[2].replace(/\.\d{3}$/, '');
                            timeSecond = parseInt(secondPart) || 0;
                        }
                    }
                    
                    hour = timeHour;
                    minute = timeMinute;
                    second = timeSecond;
                }
                
                // 根据指定格式解析日期
                if (format === 'YYYY-MM-DD') {
                    const parts = datePart.split('-');
                    if (parts.length >= 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        day = parseInt(parts[2]);
                    }
                } else if (format === 'YYYY/MM/DD') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        day = parseInt(parts[2]);
                    }
                } else if (format === 'MM/DD/YYYY') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        month = parseInt(parts[0]) - 1;
                        day = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                    }
                } else if (format === 'DD/MM/YYYY') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        year = parseInt(parts[2]);
                    }
                }
                
                // 如果指定格式未成功解析，尝试自动检测格式
                if (!year || month === undefined || !day) {
                    // 处理YYYY-MM-DD格式
                    const ymdMatch = datePart.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                    if (ymdMatch) {
                        year = parseInt(ymdMatch[1]);
                        month = parseInt(ymdMatch[2]) - 1;
                        day = parseInt(ymdMatch[3]);
                    } else {
                        // 处理YYYY/MM/DD格式
                        const ymdSlashMatch = datePart.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
                        if (ymdSlashMatch) {
                            year = parseInt(ymdSlashMatch[1]);
                            month = parseInt(ymdSlashMatch[2]) - 1;
                            day = parseInt(ymdSlashMatch[3]);
                        } else {
                            // 处理MM/DD/YYYY格式
                            const mdyMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                            if (mdyMatch) {
                                month = parseInt(mdyMatch[1]) - 1;
                                day = parseInt(mdyMatch[2]);
                                year = parseInt(mdyMatch[3]);
                            } else {
                                // 处理DD/MM/YYYY格式
                                const dmyMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                                if (dmyMatch) {
                                    day = parseInt(dmyMatch[1]);
                                    month = parseInt(dmyMatch[2]) - 1;
                                    year = parseInt(dmyMatch[3]);
                                } else {
                                    // 处理YYYYMMDD格式
                                    const yyyymmddMatch = datePart.match(/^(\d{4})(\d{2})(\d{2})$/);
                                    if (yyyymmddMatch) {
                                        year = parseInt(yyyymmddMatch[1]);
                                        month = parseInt(yyyymmddMatch[2]) - 1;
                                        day = parseInt(yyyymmddMatch[3]);
                                    } else {
                                        // 处理DDMMYYYY格式
                                        const ddmmyyyyMatch = datePart.match(/^(\d{2})(\d{2})(\d{4})$/);
                                        if (ddmmyyyyMatch) {
                                            day = parseInt(ddmmyyyyMatch[1]);
                                            month = parseInt(ddmmyyyyMatch[2]) - 1;
                                            year = parseInt(ddmmyyyyMatch[3]);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // 检查是否为有效日期
                if (year && month !== undefined && day) {
                    // 验证月份和日期范围
                    if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                        const date = new Date(year, month, day, hour, minute, second);
                        
                        // 验证日期是否有效
                        if (date.getFullYear() === year && 
                            date.getMonth() === month && 
                            date.getDate() === day) {
                            return date;
                        }
                    }
                }
                
                // 尝试让Date对象自动解析（处理更多格式）
                try {
                    const autoDate = new Date(dateStr);
                    if (!isNaN(autoDate.getTime())) {
                        if (timePart) {
                            autoDate.setHours(hour, minute, second);
                        }
                        return autoDate;
                    }
                } catch (e) {
                    // 忽略解析错误
                }
                
                // 尝试处理Excel日期序列号（数字格式）
                if (/^\d+$/.test(dateStr) && !isNaN(parseInt(dateStr))) {
                    const excelDate = parseInt(dateStr);
                    // Excel日期序列号从1900-01-01开始，但需要考虑闰年bug
                    if (excelDate >= 1 && excelDate <= 2958465) { // Excel有效日期范围
                        const baseDate = new Date(1900, 0, 1);
                        baseDate.setDate(baseDate.getDate() + excelDate - 1);
                        if (timePart) {
                            baseDate.setHours(hour, minute, second);
                        }
                        return baseDate;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error parsing date:', error);
                return null;
            }
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 格式化日期范围显示
        function formatDateRangeDisplay(dateString) {
            if (!dateString) return '';
            
            // 直接使用Date对象解析日期字符串
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                // 如果直接解析失败，尝试使用parseDate函数
                const parsedDate = parseDate(dateString);
                if (!parsedDate) return dateString;
                return formatDateForInput(parsedDate);
            }
            
            // 使用formatDateForInput函数格式化日期
            return formatDateForInput(date);
        }

        function getColorForIndex(index) {
            // 优化的专业配色方案 - 基于Tailwind CSS色彩系统
            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                '#06B6D4', '#F97316', '#84CC16', '#EC4899', '#6366F1',
                '#14B8A6', '#F43F5E', '#A855F7', '#0EA5E9', '#EAB308',
                '#22C55E', '#D946EF', '#F87171', '#34D399', '#60A5FA',
                '#FBBF24', '#A78BFA', '#FB923C', '#67E8F9', '#FDA4AF'
            ];
            
            return colors[index % colors.length];
        }

        function getLineDash(style) {
            switch (style) {
                case 'solid':
                    return [];
                case 'dashed':
                    return [5, 5];
                case 'dotted':
                    return [2, 2];
                case 'dashdot':
                    return [5, 2, 2, 2];
                default:
                    return [];
            }
        }

        function chartToSVG(chart) {
            // 将Chart.js图表转换为SVG
            const canvas = chart.canvas;
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
            
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('width', canvas.width);
            image.setAttribute('height', canvas.height);
            image.setAttribute('href', canvas.toDataURL('image/png'));
            
            svg.appendChild(image);
            
            return new XMLSerializer().serializeToString(svg);
        }
        
        // 辅助函数：将间隔四舍五入到最接近的标准值
        function roundToNearestStandardInterval(interval) {
            const standardIntervals = [1, 5, 15, 30, 60];
            
            // 找到最接近的标准间隔
            let closestInterval = standardIntervals[0];
            let minDiff = Math.abs(interval - closestInterval);
            
            for (let i = 1; i < standardIntervals.length; i++) {
                const diff = Math.abs(interval - standardIntervals[i]);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestInterval = standardIntervals[i];
                }
            }
            
            return closestInterval;
        }
        
        // 初始化日期总用电量柱状图
        function initDailyTotalBarChart() {
            const ctx = document.getElementById('dailyTotalBarChart').getContext('2d');
            
            // 如果已存在图表实例，先销毁它
            if (appData.dailyTotalBarChart) {
                appData.dailyTotalBarChart.destroy();
            }
            
            appData.dailyTotalBarChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '日总用电量',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '日期总用电量'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `总用电量: ${context.parsed.y.toFixed(2)} kWh`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '总用电量 (kWh)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 更新日期总用电量柱状图
        function updateDailyTotalBarChart(filteredData) {
            if (!appData.dailyTotalBarChart) {
                return;
            }
            
            // 显示加载状态
            document.getElementById('barChartLoading').classList.remove('hidden');
            document.getElementById('barChartNoDataMessage').classList.add('hidden');
            

            
            try {
                // 按日期分组数据
                const dateGroups = {};
                filteredData.forEach(row => {
                    const dateKey = row.date;
                    
                    if (!dateGroups[dateKey]) {
                        dateGroups[dateKey] = {
                            dailyTotal: 0,
                            count: 0
                        };
                    }
                    
                    // 累加每日总用电量
                    if (row.dailyTotal !== null && row.dailyTotal !== undefined) {
                        dateGroups[dateKey].dailyTotal += row.dailyTotal;
                        dateGroups[dateKey].count++;
                    }
                });
                
                // 计算每个日期的平均总用电量（如果有多个相同日期的数据）
                const labels = [];
                const data = [];
                
                Object.keys(dateGroups).sort().forEach(dateKey => {
                    labels.push(dateKey);
                    if (dateGroups[dateKey].count > 0) {
                        data.push(dateGroups[dateKey].dailyTotal / dateGroups[dateKey].count);
                    } else {
                        data.push(0);
                    }
                });
                
                // 更新图表数据
                appData.dailyTotalBarChart.data.labels = labels;
                appData.dailyTotalBarChart.data.datasets[0].data = data;
                
                // 更新图表
                appData.dailyTotalBarChart.update();
                
                // 隐藏加载状态
                document.getElementById('barChartLoading').classList.add('hidden');
                
                // 如果没有数据，显示无数据消息
                if (labels.length === 0) {
                    document.getElementById('barChartNoDataMessage').classList.remove('hidden');
                }
            } catch (error) {
                console.error('更新日期总用电量柱状图时出错:', error);
                showNotification('错误', '更新日期总用电量柱状图时出错: ' + error.message, 'danger');
                document.getElementById('barChartLoading').classList.add('hidden');
                document.getElementById('barChartNoDataMessage').classList.remove('hidden');
            }
        }

        // 初始化应用
        function initApp() {
            initEventListeners();
            loadImportHistory(); // 加载导入历史记录
            
            // 初始化导出按钮状态为禁用
            if (elements.nextToExportBtn) {
                elements.nextToExportBtn.disabled = true;
            }
            
            // 日期总用电量图表功能已移除
        }

        // 生成筛选项
        function generateFilterOptions() {
            const count = appData.config.filterCount;
            const container = elements.filterOptionsContainer;
            
            // 清空现有筛选项
            container.innerHTML = '';
            
            // 重置additionalFilters数组
            appData.config.additionalFilters = [];
            
            // 生成新的筛选项
            for (let i = 0; i < count; i++) {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'border border-gray-200 rounded p-3';
                
                filterDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">筛选项 ${i + 1}</label>
                        <button class="clear-single-filter text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300 transition-all-300" data-index="${i}">
                            <i class="fa fa-times mr-1"></i>清除
                        </button>
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs font-medium mb-1 text-gray-600">列</label>
                        <select id="filterColumn${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
                            <option value="">-- 请选择 --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1 text-gray-600">值</label>
                        <select id="filterValue${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm">
                            <option value="">-- 全部 --</option>
                        </select>
                    </div>
                `;
                
                container.appendChild(filterDiv);
                
                // 添加到additionalFilters数组
                appData.config.additionalFilters.push({
                    column: '',
                    value: ''
                });
                
                // 添加列选择事件
                const columnSelect = document.getElementById(`filterColumn${i}`);
                columnSelect.addEventListener('change', (e) => {
                    appData.config.additionalFilters[i].column = e.target.value;
                    populateFilterValueOptions(i, e.target.value);
                    updateDataPreview();
                });
                
                // 添加值选择事件
                const valueSelect = document.getElementById(`filterValue${i}`);
                valueSelect.addEventListener('change', (e) => {
                    appData.config.additionalFilters[i].value = e.target.value;
                    updateDataPreview();
                });
                
                // 填充列选择器
                populateFilterColumnSelect(i);
            }
        }
        function populateFilterColumnSelect(index) {
            const select = document.getElementById(`filterColumn${index}`);
            
            // 如果没有工作表数据，则返回
            if (appData.worksheets.length === 0) return;
            
            // 获取第一行作为表头
            const headerRow = appData.worksheets[0].data[0] || [];
            
            // 添加新选项
            for (let i = 0; i < headerRow.length; i++) {
                // 生成列字母，支持超过26列的情况（如AA, AB等）
                let columnLetter = "";
                let columnNum = i;
                while (columnNum >= 0) {
                    columnLetter = String.fromCharCode(65 + (columnNum % 26)) + columnLetter;
                    columnNum = Math.floor(columnNum / 26) - 1;
                    if (columnNum < 0) break;
                }
                
                const headerText = headerRow[i] ? String(headerRow[i]).substring(0, 20) : `列 ${columnLetter}`;
                
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${columnLetter}: ${headerText}`;
                select.appendChild(option);
            }
        }
        
        function populateFilterValueOptions(index, columnIndex) {
            const valueSelect = document.getElementById(`filterValue${index}`);
            
            // 清空现有选项
            valueSelect.innerHTML = '<option value="">-- 全部 --</option>';
            
            // 如果没有选择列，则返回
            if (!columnIndex) return;
            
            const col = parseInt(columnIndex);
            
            // 收集所有唯一的值
            const valueSet = new Set();
            
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // 跳过表头行
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[col]) continue;
                    
                    const value = String(row[col]).trim();
                    if (value) {
                        valueSet.add(value);
                    }
                }
            });
            
            // 转换为数组并排序
            const values = Array.from(valueSet).sort();
            
            // 添加到下拉菜单
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                valueSelect.appendChild(option);
            });
        }
        
        // 更新附加筛选器配置
        function updateAdditionalFilters() {
            appData.config.additionalFilters = [];
            
            const filterDivs = elements.filterOptionsContainer.querySelectorAll('.border');
            filterDivs.forEach(div => {
                const columnSelect = div.querySelector('.filter-column');
                const valueInput = div.querySelector('.filter-value');
                
                if (columnSelect.value && valueInput.value.trim()) {
                    appData.config.additionalFilters.push({
                        column: parseInt(columnSelect.value),
                        value: valueInput.value.trim()
                    });
                }
            });
            
            // 更新数据预览
            updateDataPreview();
        }

        // 预览第一个小时计算过程
        function previewFirstHourCalculation() {
            if (appData.parsedData.length === 0) {
                showNotification('警告', '没有可预览的数据，请先导入并配置数据', 'warning');
                return;
            }
            
            // 获取第一行解析后的数据
            const firstParsedData = appData.parsedData[0];
            const interval = firstParsedData.timeInterval || appData.config.timeInterval;
            
            // 计算每小时数据点数
            let pointsPerHour;
            if (interval === 1) {
                pointsPerHour = 60;
            } else if (interval === 5) {
                pointsPerHour = 12;
            } else if (interval === 15) {
                pointsPerHour = 4;
            } else if (interval === 30) {
                pointsPerHour = 2;
            } else if (interval === 60) {
                pointsPerHour = 1;
            } else {
                pointsPerHour = Math.floor(60 / interval);
            }
            
            // 获取第一个小时的原始数据
            const startIdx = 0;
            const endIdx = pointsPerHour;
            const hourData = firstParsedData.rawData.slice(startIdx, endIdx);
            
            // 处理无效数据
            const cleanedData = cleanData(hourData);
            
            // 计算第一个小时的电能值
            let hourlyValue;
            let calculationProcess = '';
            let formula = '';
            
            if (appData.config.dataType === 'instantPower') {
                // 瞬时功率数据 (kW)
                // 使用统一的计算函数
                hourlyValue = calculateHourlyPower(cleanedData, firstParsedData.multiplier, false);
                
                if (hourlyValue === null) {
                    calculationProcess = '没有有效数据，无法计算';
                    formula = '无效数据';
                } else {
                    const validData = cleanedData.filter(v => v !== null);
                    const sum = validData.reduce((a, b) => a + b, 0);
                    const avgPower = sum / validData.length;
                    
                    calculationProcess = `1. 获取第一个小时的所有数据点（${interval === 1 ? '60' : pointsPerHour}个）\n` +
                                      `2. 过滤无效数据，剩余 ${validData.length} 个有效数据点\n` +
                                      `3. 计算数据点总和：${sum.toFixed(2)} kW\n` +
                                      `4. 计算平均功率：${sum.toFixed(2)} ÷ ${validData.length} = ${avgPower.toFixed(2)} kW\n` +
                                      `5. 应用公式：平均功率 × 1 × 倍率\n` +
                                      `6. 计算结果：${avgPower.toFixed(2)} × 1 × ${firstParsedData.multiplier} = ${hourlyValue.toFixed(2)} kWh`;
                    formula = '平均功率 × 1 × 倍率';
                }
            } else {
                // 累积电能数据 (kWh)
                if (interval === 1) {
                    // 1分钟间隔特殊处理
                    if (cleanedData.length < 60) {
                        hourlyValue = null;
                        calculationProcess = '数据不足，无法计算';
                        formula = '数据不足';
                    } else {
                        // 第一组：1-15分钟
                        const firstQuarter = cleanedData.slice(0, 15).filter(v => v !== null);
                        // 第二组：46-60分钟
                        const lastQuarter = cleanedData.slice(45, 60).filter(v => v !== null);
                        
                        if (firstQuarter.length === 0 || lastQuarter.length === 0) {
                            hourlyValue = null;
                            calculationProcess = '数据不足，无法计算';
                            formula = '数据不足';
                        } else {
                            const firstSum = firstQuarter.reduce((a, b) => a + b, 0);
                            const lastSum = lastQuarter.reduce((a, b) => a + b, 0);
                            hourlyValue = lastSum - firstSum;
                            calculationProcess = `1. 获取第一个小时的所有数据点（60个）\n` +
                                              `2. 分为两组数据：1-15分钟和46-60分钟\n` +
                                              `3. 第一组数据点数量：${firstQuarter.length}，总和：${firstSum.toFixed(2)} kWh\n` +
                                              `4. 第二组数据点数量：${lastQuarter.length}，总和：${lastSum.toFixed(2)} kWh\n` +
                                              `5. 应用公式：第二组总和 - 第一组总和\n` +
                                      `6. 计算结果：${lastSum.toFixed(2)} - ${firstSum.toFixed(2)} = ${hourlyValue.toFixed(2)} kWh`;
                            formula = '第二组总和 - 第一组总和';
                        }
                    }
                } else {
                    // 其他间隔
                    if (cleanedData.length < 2) {
                        hourlyValue = null;
                        calculationProcess = '数据不足，无法计算';
                        formula = '数据不足';
                    } else {
                        const startValue = cleanedData[0];
                        const endValue = cleanedData[cleanedData.length - 1];
                        
                        if (startValue === null || endValue === null) {
                            hourlyValue = null;
                            calculationProcess = '起始或结束值无效，无法计算';
                            formula = '起始或结束值无效';
                        } else if (endValue < startValue) {
                            hourlyValue = null;
                            calculationProcess = '累积值异常（结束值小于起始值），无法计算';
                            formula = '累积值异常';
                        } else {
                            hourlyValue = endValue - startValue;
                            calculationProcess = `1. 获取第一个小时的所有数据点（${pointsPerHour}个）\n` +
                                              `2. 起始值：${startValue.toFixed(2)} kWh\n` +
                                              `3. 结束值：${endValue.toFixed(2)} kWh\n` +
                                              `4. 应用公式：结束值 - 起始值\n` +
                                              `5. 计算结果：${endValue.toFixed(2)} - ${startValue.toFixed(2)} = ${hourlyValue.toFixed(2)} kWh`;
                            formula = '结束值 - 起始值';
                        }
                    }
                }
            }
            
            // 更新模态框内容
            elements.previewDate.textContent = firstParsedData.dateStr;
            elements.previewInterval.textContent = `${interval} 分钟`;
            elements.previewDataType.textContent = appData.config.dataType === 'instantPower' ? '瞬时功率 (kW)' : '累积电能 (kWh)';
            elements.previewMultiplier.textContent = firstParsedData.multiplier;
            
            // 显示原始数据
            const rawDataText = hourData.map((val, idx) => {
                return `数据点 ${idx + 1}: ${val !== null ? val.toFixed(2) : '无效数据'}`;
            }).join('\n');
            elements.previewRawData.textContent = rawDataText;
            
            // 显示清洗后数据
            const cleanedDataText = cleanedData.map((val, idx) => {
                return `数据点 ${idx + 1}: ${val !== null ? val.toFixed(2) : '无效数据'}`;
            }).join('\n');
            elements.previewCleanedData.textContent = cleanedDataText;
            
            // 显示计算过程
            elements.previewCalculationProcess.innerHTML = calculationProcess.replace(/\n/g, '<br>');
            
            // 显示计算结果
            elements.previewResult.textContent = hourlyValue !== null ? `${hourlyValue.toFixed(2)} kWh` : '无法计算';
            elements.previewFormula.textContent = formula;
            
            // 显示模态框
            elements.firstHourCalculationModal.classList.remove('hidden');
            setTimeout(() => {
                elements.firstHourCalculationModal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0');
                elements.firstHourCalculationModal.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭第一个小时计算过程预览模态框
        function closeFirstHourCalculationModal() {
            const modalContent = elements.firstHourCalculationModal.querySelector('.bg-white');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                elements.firstHourCalculationModal.classList.add('hidden');
            }, 300);
        }
        
        // 预览第一天的计算过程
        function previewFirstDayCalculation() {
            if (!appData.processedData || appData.processedData.length === 0) {
                showNotification('错误', '没有可用的数据，请先导入并处理数据', 'error');
                return;
            }
            
            // 获取第一天的数据 - 对于列对列结构，只取第一个元素
            let firstDayData;
            if (appData.processedData[0].dataStructure === 'columnToColumn') {
                // 列对列结构：每个元素代表一个完整日期的数据，只取第一个
                firstDayData = [appData.processedData[0]];
            } else {
                // 列对行结构：按日期筛选
                firstDayData = appData.processedData.filter(item => {
                    const itemDate = new Date(item.date);
                    const firstDate = new Date(appData.processedData[0].date);
                    return itemDate.toDateString() === firstDate.toDateString();
                });
            }
            
            if (firstDayData.length === 0) {
                showNotification('错误', '没有找到第一天的数据', 'error');
                return;
            }
            
            // 获取配置信息
            const interval = appData.config.timeInterval;
            const dataType = appData.config.dataType;
            const multiplier = appData.config.multiplier;
            
            // 计算第一天的总数据点
            const totalPoints = firstDayData.reduce((sum, item) => {
                return sum + (item.hourlyData ? item.hourlyData.filter(v => v !== null).length : 0);
            }, 0);
            
            // 计算第一天的总用电量
            let dailyValue = null;
            let calculationProcess = '';
            let formula = '';
            
            if (dataType === 'instantPower') {
                // 瞬时功率数据
                const hourlyValues = []; // 存储每个小时的用电量
                const hourlyDataCounts = new Array(24).fill(0); // 记录每个小时的数据点数量
                
                // 收集第一天的24小时有效数据
                if (firstDayData[0].hourlyData && firstDayData[0].hourlyData.length > 0) {
                    firstDayData[0].hourlyData.forEach((value, hourIndex) => {
                        if (value !== null && !isNaN(value)) {
                            hourlyValues[hourIndex] = value;
                            if (hourIndex < 24) {
                                hourlyDataCounts[hourIndex]++;
                            }
                        }
                    });
                }
                
                // 过滤掉无效的小时值
                const validHourlyValues = hourlyValues.filter(v => v !== null && !isNaN(v));
                
                if (validHourlyValues.length === 0) {
                    dailyValue = null;
                    calculationProcess = '数据不足，无法计算';
                    formula = '数据不足';
                } else {
                    // 计算第一天的总用电量（24小时用电量依次累加）
                    dailyValue = validHourlyValues.reduce((a, b) => a + b, 0);
                    
                    // 统计有数据的小时数
                    const hoursWithData = hourlyDataCounts.filter(count => count > 0).length;
                    
                    const formattedValues = validHourlyValues.map(v => parseFloat(v).toFixed(2));
                    const sumExpression = formattedValues.join(' + ');
                    
                    calculationProcess = `1. 获取第一天的所有24小时数据\n` +
                                      `2. 过滤无效数据后剩余有效小时数：${hoursWithData}/24小时\n` +
                                      `3. 各小时用电量：${formattedValues.join(', ')} kWh\n` +
                                      `4. 计算一天用电总量：${sumExpression} = ${dailyValue.toFixed(2)} kWh`;
                    formula = '1小时用电 + 2小时用电 + … + 24小时用电';
                }
            } else {
                // 累积电能数据
                if (firstDayData.length === 0) {
                    dailyValue = null;
                    calculationProcess = '数据不足，无法计算';
                    formula = '数据不足';
                } else {
                    // 收集所有24小时的有效数据
                    const hourlyValues = []; // 存储每个小时的用电量
                    const hourlyDataCounts = new Array(24).fill(0); // 记录每个小时的数据点数量
                    
                    firstDayData.forEach(dayData => {
                        if (dayData.hourlyData && dayData.hourlyData.length > 0) {
                            dayData.hourlyData.forEach((value, hourIndex) => {
                                if (value !== null && !isNaN(value)) {
                                    hourlyValues[hourIndex] = value;
                                    if (hourIndex < 24) {
                                        hourlyDataCounts[hourIndex]++;
                                    }
                                }
                            });
                        }
                    });
                    
                    // 过滤掉无效的小时值
                    const validHourlyValues = hourlyValues.filter(v => v !== null && !isNaN(v));
                    
                    if (validHourlyValues.length === 0) {
                        dailyValue = null;
                        calculationProcess = '没有有效的小时数据，无法计算';
                        formula = '没有有效的小时数据';
                    } else {
                        // 计算第一天的总用电量（24小时用电量依次累加）
                        dailyValue = validHourlyValues.reduce((a, b) => a + b, 0);
                        
                        // 统计有数据的小时数
                        const hoursWithData = hourlyDataCounts.filter(count => count > 0).length;
                        
                        const formattedValues = validHourlyValues.map(v => parseFloat(v).toFixed(2));
                    const sumExpression = formattedValues.join(' + ');
                    
                    calculationProcess = `1. 获取第一天的所有24小时数据\n` +
                                        `2. 过滤无效数据后剩余有效小时数：${hoursWithData}/24小时\n` +
                                        `3. 各小时用电量：${formattedValues.join(', ')} kWh\n` +
                                        `4. 计算一天用电总量：${sumExpression} = ${dailyValue.toFixed(2)} kWh`;
                        formula = '1小时用电 + 2小时用电 + … + 24小时用电';
                    }
                }
            }
            
            // 更新模态框内容
            elements.previewFirstDayDate.textContent = firstDayData[0] && firstDayData[0].date ? firstDayData[0].date.split(' ')[0] : '未知日期';
            elements.previewFirstDayInterval.textContent = `${interval} 分钟`;
            elements.previewFirstDayDataType.textContent = dataType === 'instantPower' ? '瞬时功率 (kW)' : '累积电能 (kWh)';
            elements.previewFirstDayMultiplier.textContent = multiplier;
            
            // 显示原始数据
            const rawDataText = firstDayData[0].hourlyData ? 
                `第1天小时数据: [${firstDayData[0].hourlyData.map((val, idx) => 
                    val !== null ? val.toFixed(2) : '无效数据').join(', ')}]` : 
                `第1天小时数据: 无数据`;
            elements.previewFirstDayRawData.textContent = rawDataText;
            
            // 显示清洗后数据
            let cleanedDataText;
            if (!firstDayData[0].hourlyData) {
                cleanedDataText = `第1天小时数据: 无数据`;
            } else {
                const validData = firstDayData[0].hourlyData.filter(val => val !== null && !isNaN(val));
                cleanedDataText = `第1天小时数据: [${validData.map(val => val.toFixed(2)).join(', ')}]`;
            }
            elements.previewFirstDayCleanedData.textContent = cleanedDataText;
            
            // 显示计算过程
            elements.previewFirstDayCalculationProcess.innerHTML = calculationProcess.replace(/\n/g, '<br>');
            
            // 显示计算结果
            elements.previewFirstDayResult.textContent = dailyValue !== null ? `${dailyValue.toFixed(2)} kWh` : '无法计算';
            elements.previewFirstDayFormula.textContent = formula;
            
            // 显示模态框
            elements.firstDayCalculationModal.classList.remove('hidden');
            setTimeout(() => {
                elements.firstDayCalculationModal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0');
                elements.firstDayCalculationModal.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭第一天计算过程预览模态框
        function closeFirstDayCalculationModal() {
            const modalContent = elements.firstDayCalculationModal.querySelector('.bg-white');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                elements.firstDayCalculationModal.classList.add('hidden');
            }, 300);
        }
        // 添加保存和加载历史记录的函数
        function saveImportHistory() {
            try {
                localStorage.setItem('loadDataAnalyzerImportHistory', JSON.stringify(appData.importHistory));
            } catch (error) {
                console.error('保存导入历史失败:', error);
            }
        }

        function loadImportHistory() {
            try {
                const savedHistory = localStorage.getItem('loadDataAnalyzerImportHistory');
                if (savedHistory) {
                    appData.importHistory = JSON.parse(savedHistory);
                    renderImportHistory();
                }
            } catch (error) {
                console.error('加载导入历史失败:', error);
                appData.importHistory = [];
            }
        }

        // 添加清空历史记录函数
        function clearImportHistory() {
            if (confirm('确定要清空所有导入历史记录吗？此操作不可撤销。')) {
                appData.importHistory = [];
                saveImportHistory();
                renderImportHistory();
                showNotification('成功', '导入历史记录已清空', 'success');
            }
        }

        // 添加渲染历史记录函数
        function renderImportHistory() {
            if (appData.importHistory.length === 0) {
                elements.importHistory.innerHTML = '<p class="text-neutral text-sm text-center py-4">暂无导入历史记录</p>';
                return;
            }
            
            let historyHtml = '<div class="space-y-2">';
            
            // 按时间倒序排列，最多显示1条
            const sortedHistory = [...appData.importHistory].sort((a, b) => new Date(b.importTime) - new Date(a.importTime));
            const displayHistory = sortedHistory.slice(0, 1);
            
            displayHistory.forEach((record, index) => {
                const date = new Date(record.importTime);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                
                historyHtml += `
            <div class="border border-gray-200 rounded p-2 hover:bg-gray-50 cursor-pointer" onclick="showHistoryDetail(${sortedHistory.indexOf(record)})">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium text-sm">${record.fileName}</p>
                        <p class="text-xs text-neutral">${formattedDate}</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded ${record.status === 'success' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}">
                        ${record.status === 'success' ? '成功' : '失败'}
                    </span>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-xs text-neutral">文件大小: ${(record.fileSize / (1024 * 1024)).toFixed(2)} MB</span>
                    <span class="text-xs text-neutral">记录数: ${record.recordCount}</span>
                </div>
            </div>
        `;
            });
            
            historyHtml += '</div>';
            elements.importHistory.innerHTML = historyHtml;
        }

        // 添加重新导入并跳转到配置步骤函数
        function reimportAndGoToConfig(index) {
            const record = appData.importHistory[index];
            if (!record || record.status !== 'success') {
                showNotification('错误', '无法重新导入此记录', 'error');
                return;
            }
            
            // 清空当前数据
            removeAllFiles();
            
            // 尝试使用历史记录中的文件路径重新导入
            if (record.filePath) {
                // 使用fetch API获取文件
                fetch(record.filePath)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('无法访问文件：' + record.filePath);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // 创建File对象
                        const file = new File([blob], record.fileName, { type: blob.type });
                        
                        // 处理文件
                        processFiles([file]);
                        
                        // 等待文件处理完成后应用历史配置并跳转到配置步骤
                        setTimeout(() => {
                            if (appData.worksheets.length > 0 && record.config) {
                                // 应用历史配置
                                appData.config.dataType = record.config.dataType;
                                appData.config.multiplier = record.config.multiplier;
                                appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                                appData.config.multiplierColumn = record.config.multiplierColumn || '';
                                appData.config.dateColumn = record.config.dateColumn;
                                appData.config.dataStartColumn = record.config.dataStartColumn;
                                appData.config.dataEndColumn = record.config.dataEndColumn;
                                appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                                appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                                appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                                appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                                appData.config.timeInterval = record.config.timeInterval || 15;
                                
                                // 更新UI
                                document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                                elements.multiplierInput.value = record.config.multiplier;
                                elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                                elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                                elements.dateColumnSelect.value = record.config.dateColumn;
                                elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                                elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                                elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                                elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                                elements.dateFormatSelect.value = record.config.dateFormat || 'YYYY-MM-DD';
                                elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                                elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                                
                                // 更新倍率选项显示
                                if (record.config.useMultiplierColumn) {
                                    elements.multiplierOptions.classList.add('hidden');
                                    elements.multiplierColumnOption.classList.remove('hidden');
                                } else {
                                    elements.multiplierOptions.classList.remove('hidden');
                                    elements.multiplierColumnOption.classList.add('hidden');
                                }
                                
                                // 更新数据预览
                                updateDataPreview();
                                
                                // 跳转到配置步骤
                                goToConfigSection();
                                
                                showNotification('成功', '已直接从原始位置重新导入文件并跳转到配置步骤', 'success');
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error('直接访问文件失败:', error);
                        showNotification('警告', '无法直接访问原始文件，请手动选择文件', 'warning');
                        
                        // 如果无法直接访问文件，则提示用户手动选择
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.xlsx,.xls,.csv';
                        fileInput.multiple = false;
                        
                        fileInput.onchange = function(e) {
                            const files = Array.from(e.target.files);
                            if (files.length === 0) return;
                            
                            const file = files[0];
                            
                            // 检查文件名是否匹配
                            if (file.name !== record.fileName) {
                                if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                                    return;
                                }
                            }
                            
                            // 清空当前数据
                            removeAllFiles();
                            
                            // 处理文件
                            processFiles([file]);
                            
                            // 等待文件处理完成后应用历史配置并跳转到配置步骤
                            setTimeout(() => {
                                if (appData.worksheets.length > 0 && record.config) {
                                    // 应用历史配置
                                    appData.config.dataType = record.config.dataType;
                                    appData.config.multiplier = record.config.multiplier;
                                    appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                                    appData.config.multiplierColumn = record.config.multiplierColumn || '';
                                    appData.config.dateColumn = record.config.dateColumn;
                                    appData.config.dataStartColumn = record.config.dataStartColumn;
                                    appData.config.dataEndColumn = record.config.dataEndColumn;
                                    appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                                    appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                                    appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                                    appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                                    appData.config.timeInterval = record.config.timeInterval || 15;
                                    
                                    // 更新UI
                                    document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                                    elements.multiplierInput.value = record.config.multiplier;
                                    elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                                    elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                                    elements.dateColumnSelect.value = record.config.dateColumn;
                                    elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                                    elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                                    elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                                    elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                                    elements.dateFormatSelect.value = record.config.dateFormat || 'YYYY-MM-DD';
                                    elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                                    elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                                    
                                    // 更新倍率选项显示
                                    if (record.config.useMultiplierColumn) {
                                        elements.multiplierOptions.classList.add('hidden');
                                        elements.multiplierColumnOption.classList.remove('hidden');
                                    } else {
                                        elements.multiplierOptions.classList.remove('hidden');
                                        elements.multiplierColumnOption.classList.add('hidden');
                                    }
                                    
                                    // 更新数据预览
                                    updateDataPreview();
                                    
                                    // 跳转到配置步骤
                                    goToConfigSection();
                                    
                                    showNotification('成功', '已重新导入文件并跳转到配置步骤', 'success');
                                }
                            }, 500);
                        };
                        
                        // 触发文件选择
                        fileInput.click();
                    });
            } else {
                // 如果没有文件路径，则提示用户手动选择
                showNotification('提示', '历史记录中没有文件路径信息，请手动选择文件', 'warning');
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.multiple = false;
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    const file = files[0];
                    
                    // 检查文件名是否匹配
                    if (file.name !== record.fileName) {
                        if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                            return;
                        }
                    }
                    
                    // 清空当前数据
                    removeAllFiles();
                    
                    // 处理文件
                    processFiles([file]);
                    
                    // 等待文件处理完成后应用历史配置并跳转到配置步骤
                    setTimeout(() => {
                        if (appData.worksheets.length > 0 && record.config) {
                            // 应用历史配置
                            appData.config.dataType = record.config.dataType;
                            appData.config.multiplier = record.config.multiplier;
                            appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                            appData.config.multiplierColumn = record.config.multiplierColumn || '';
                            appData.config.dateColumn = record.config.dateColumn;
                            appData.config.dataStartColumn = record.config.dataStartColumn;
                            appData.config.dataEndColumn = record.config.dataEndColumn;
                            appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                            appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                            appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                            appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                            appData.config.timeInterval = record.config.timeInterval || 15;
                            
                            // 更新UI
                            document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                            elements.multiplierInput.value = record.config.multiplier;
                            elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                            elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                            elements.dateColumnSelect.value = record.config.dateColumn;
                            elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                            elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                            elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                            elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                            elements.dateFormatSelect.value = record.config.dateFormat || 'YYYY-MM-DD';
                            elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                            elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                            
                            // 更新倍率选项显示
                            if (record.config.useMultiplierColumn) {
                                elements.multiplierOptions.classList.add('hidden');
                                elements.multiplierColumnOption.classList.remove('hidden');
                            } else {
                                elements.multiplierOptions.classList.remove('hidden');
                                elements.multiplierColumnOption.classList.add('hidden');
                            }
                            
                            // 更新数据预览
                            updateDataPreview();
                            
                            // 跳转到配置步骤
                            goToConfigSection();
                            
                            showNotification('成功', '已重新导入文件并跳转到配置步骤', 'success');
                        }
                    }, 500);
                };
                
                // 触发文件选择
                fileInput.click();
            }
        }

        // 添加显示历史记录详情函数
        function showHistoryDetail(index) {
            const record = appData.importHistory[index];
            if (!record) return;
            
            const date = new Date(record.importTime);
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
            
            let detailHtml = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2">基本信息</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-neutral">文件名：</span>
                                <span class="font-medium">${record.fileName}</span>
                            </div>
                            <div>
                                <span class="text-neutral">导入时间：</span>
                                <span class="font-medium">${formattedDate}</span>
                            </div>
                            <div>
                                <span class="text-neutral">文件大小：</span>
                                <span class="font-medium">${(record.fileSize / (1024 * 1024)).toFixed(2)} MB</span>
                            </div>
                            <div>
                                <span class="text-neutral">状态：</span>
                                <span class="font-medium ${record.status === 'success' ? 'text-success' : 'text-danger'}">
                                    ${record.status === 'success' ? '成功' : '失败'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">数据处理结果</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-neutral">总记录数：</span>
                                <span class="font-medium">${record.recordCount}</span>
                            </div>
                            <div>
                                <span class="text-neutral">有效记录数：</span>
                                <span class="font-medium">${record.validRecordCount || 0}</span>
                            </div>
                            <div>
                                <span class="text-neutral">无效记录数：</span>
                                <span class="font-medium">${record.invalidRecordCount || 0}</span>
                            </div>
                            <div>
                                <span class="text-neutral">时间间隔：</span>
                                <span class="font-medium">${record.timeInterval || '未知'} 分钟</span>
                            </div>
                        </div>
                    </div>
            `;
            
            if (record.status === 'failure' && record.errorMessage) {
                detailHtml += `
                    <div>
                        <h4 class="font-medium mb-2">错误信息</h4>
                        <div class="bg-danger/5 border border-danger/20 rounded p-3 text-sm">
                            <p class="text-danger">${record.errorMessage}</p>
                        </div>
                    </div>
                `;
            }
            
            if (record.config) {
                detailHtml += `
                    <div>
                        <h4 class="font-medium mb-2">使用的配置</h4>
                        <div class="bg-gray-50 rounded p-3 text-sm">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <span class="text-neutral">数据类型：</span>
                                    <span class="font-medium">${record.config.dataType === 'instantPower' ? '瞬时功率 (kW)' : '累积电能 (kWh)'}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">倍率：</span>
                                    <span class="font-medium">${record.config.multiplier}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">日期列：</span>
                                    <span class="font-medium">${record.config.dateColumn !== '' ? record.config.dateColumn : '未设置'}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">数据列范围：</span>
                                    <span class="font-medium">${record.config.dataStartColumn !== '' && record.config.dataEndColumn !== '' ? 
                                        `${record.config.dataStartColumn} - ${record.config.dataEndColumn}` : '未设置'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 添加重新导入按钮
    if (record.status === 'success') {
        detailHtml += `
            <div class="flex justify-end pt-2 border-t border-gray-200">
                <button id="reimportBtn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 transition-all-300" data-index="${index}">
                    <i class="fa fa-refresh mr-1"></i> 重新导入
                </button>
            </div>
        `;
    }
    
    detailHtml += '</div>';
    elements.historyDetailContent.innerHTML = detailHtml;
    
    // 添加重新导入按钮的事件监听
    const reimportBtn = document.getElementById('reimportBtn');
    if (reimportBtn) {
        reimportBtn.addEventListener('click', function() {
            const recordIndex = parseInt(this.dataset.index);
            reimportFromHistory(recordIndex);
            closeHistoryDetailModal();
        });
    }
    
    // 显示模态框
    elements.historyDetailModal.classList.remove('hidden');
    setTimeout(() => {
        elements.historyDetailModal.querySelector('.bg-white').classList.remove('scale-95', 'opacity-0');
        elements.historyDetailModal.querySelector('.bg-white').classList.add('scale-100', 'opacity-100');
    }, 10);
        }
        
        // 添加关闭历史记录详情模态框函数
function closeHistoryDetailModal() {
    const modalContent = elements.historyDetailModal.querySelector('.bg-white');
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        elements.historyDetailModal.classList.add('hidden');
    }, 300);
}

// 添加从历史记录重新导入函数
function reimportFromHistory(index) {
    const record = appData.importHistory[index];
    if (!record || record.status !== 'success') {
        showNotification('错误', '无法重新导入此记录', 'error');
        return;
    }
    
    // 清空当前数据
    removeAllFiles();
    
    // 尝试使用历史记录中的文件路径重新导入
    if (record.filePath) {
        // 使用fetch API获取文件
        fetch(record.filePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法访问文件：' + record.filePath);
                }
                return response.blob();
            })
            .then(blob => {
                // 创建File对象
                const file = new File([blob], record.fileName, { type: blob.type });
                
                // 处理文件
                processFiles([file]);
                
                // 等待文件处理完成后应用历史配置
                setTimeout(() => {
                    if (appData.worksheets.length > 0 && record.config) {
                        // 应用历史配置
                        appData.config.dataType = record.config.dataType;
                        appData.config.multiplier = record.config.multiplier;
                        appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                        appData.config.multiplierColumn = record.config.multiplierColumn || '';
                        appData.config.dateColumn = record.config.dateColumn;
                        appData.config.dataStartColumn = record.config.dataStartColumn;
                        appData.config.dataEndColumn = record.config.dataEndColumn;
                        appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                        appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                        appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                        appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                        appData.config.timeInterval = record.config.timeInterval || 15;
                        
                        // 更新UI
                        document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                        elements.multiplierInput.value = record.config.multiplier;
                        elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                        elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                        elements.dateColumnSelect.value = record.config.dateColumn;
                        elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                        elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                        elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                        elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                        elements.dateFormatSelect.value = record.config.dateFormat || 'YYYY-MM-DD';
                        elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                        elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                        
                        // 更新倍率选项显示
                        if (record.config.useMultiplierColumn) {
                            elements.multiplierOptions.classList.add('hidden');
                            elements.multiplierColumnOption.classList.remove('hidden');
                        } else {
                            elements.multiplierOptions.classList.remove('hidden');
                            elements.multiplierColumnOption.classList.add('hidden');
                        }
                        
                        // 更新数据预览
                        updateDataPreview();
                        
                        showNotification('成功', '已直接从原始位置重新导入文件并应用历史配置', 'success');
                    }
                }, 500);
            })
            .catch(error => {
                console.error('直接访问文件失败:', error);
                showNotification('警告', '无法直接访问原始文件，请手动选择文件', 'warning');
                
                // 如果无法直接访问文件，则提示用户手动选择
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.multiple = false;
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    const file = files[0];
                    
                    // 检查文件名是否匹配
                    if (file.name !== record.fileName) {
                        if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                            return;
                        }
                    }
                    
                    // 清空当前数据
                    removeAllFiles();
                    
                    // 处理文件
                    processFiles([file]);
                    
                    // 等待文件处理完成后应用历史配置
                    setTimeout(() => {
                        if (appData.worksheets.length > 0 && record.config) {
                            // 应用历史配置
                            appData.config.dataType = record.config.dataType;
                            appData.config.multiplier = record.config.multiplier;
                            appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                            appData.config.multiplierColumn = record.config.multiplierColumn || '';
                            appData.config.dateColumn = record.config.dateColumn;
                            appData.config.dataStartColumn = record.config.dataStartColumn;
                            appData.config.dataEndColumn = record.config.dataEndColumn;
                            appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                            appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                            appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                            appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                            appData.config.timeInterval = record.config.timeInterval || 15;
                            
                            // 更新UI
                            document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                            elements.multiplierInput.value = record.config.multiplier;
                            elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                            elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                            elements.dateColumnSelect.value = record.config.dateColumn;
                            elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                            elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                            elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                            elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                            elements.dateFormatSelect.value = record.config.dateFormat || 'YYYY-MM-DD';
                            elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                            elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                            
                            // 更新倍率选项显示
                            if (record.config.useMultiplierColumn) {
                                elements.multiplierOptions.classList.add('hidden');
                                elements.multiplierColumnOption.classList.remove('hidden');
                            } else {
                                elements.multiplierOptions.classList.remove('hidden');
                                elements.multiplierColumnOption.classList.add('hidden');
                            }
                            
                            // 更新数据预览
                            updateDataPreview();
                            
                            showNotification('成功', '已重新导入文件并应用历史配置', 'success');
                        }
                    }, 500);
                };
                
                // 触发文件选择
                fileInput.click();
            });
    } else {
        // 如果没有文件路径，则提示用户手动选择
        showNotification('提示', '历史记录中没有文件路径信息，请手动选择文件', 'warning');
        
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx,.xls,.csv';
        fileInput.multiple = false;
        
        fileInput.onchange = function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            const file = files[0];
            
            // 检查文件名是否匹配
            if (file.name !== record.fileName) {
                if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                    return;
                }
            }
            
            // 清空当前数据
            removeAllFiles();
            
            // 处理文件
            processFiles([file]);
            
            // 等待文件处理完成后应用历史配置
            setTimeout(() => {
                if (appData.worksheets.length > 0 && record.config) {
                    // 应用历史配置
                    appData.config.dataType = record.config.dataType;
                    appData.config.multiplier = record.config.multiplier;
                    appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                    appData.config.multiplierColumn = record.config.multiplierColumn || '';
                    appData.config.dateColumn = record.config.dateColumn;
                    appData.config.dataStartColumn = record.config.dataStartColumn;
                    appData.config.dataEndColumn = record.config.dataEndColumn;
                    appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                    appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                    appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                    appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                    appData.config.timeInterval = record.config.timeInterval || 15;
                    
                    // 更新UI
                    document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                    elements.multiplierInput.value = record.config.multiplier;
                    elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                    elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                    elements.dateColumnSelect.value = record.config.dateColumn;
                    elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                    elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                    elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                    elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                    elements.dateFormatSelect.value = record.config.dateFormat || 'YYYY-MM-DD';
                    elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                    elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                    
                    // 更新倍率选项显示
                    if (record.config.useMultiplierColumn) {
                        elements.multiplierOptions.classList.add('hidden');
                        elements.multiplierColumnOption.classList.remove('hidden');
                    } else {
                        elements.multiplierOptions.classList.remove('hidden');
                        elements.multiplierColumnOption.classList.add('hidden');
                    }
                    
                    // 更新数据预览
                    updateDataPreview();
                    
                    showNotification('成功', '已重新导入文件并应用历史配置', 'success');
                }
            }, 500);
        };
        
        // 触发文件选择
        fileInput.click();
    }
}

        // 辅助函数：解析日期时间
function parseDateTime(dateTimeStr, format) {
    if (!dateTimeStr || typeof dateTimeStr !== 'string') {
        return null;
    }
    
    // 尝试多种日期时间格式
    const formats = [
        { regex: /\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-ss' }, // YYYY-MM-DD HH:MM:SS
        { regex: /\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm' },     // YYYY/MM/DD HH:MM
        { regex: /\d{4}\d{2}\d{2}\d{2}\d{2}\d{2}/, id: 'yyyymmddhhmmss' },     // YYYYMMDDHHMMSS
        { regex: /\d{4}\/\d{2}\/\d{2}\/\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-slash' },    // YYYY/MM/DD/HH:MM
        { regex: /\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm' },     // MM/DD/YYYY HH:MM
        { regex: /\d{2}-\d{2}-\d{4} \d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm-dash' },      // MM-DD-YYYY HH:MM
        { regex: /\d{4}-\d{2}-\d{2} \d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-dash' },      // YYYY-MM-DD HH:MM
        { regex: /\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-ss-slash' }, // YYYY/MM/DD HH:MM:SS
        { regex: /\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm-ss' }  // MM/DD/YYYY HH:MM:SS
    ];
    
    for (const fmt of formats) {
        if (fmt.regex.test(dateTimeStr)) {
            let parts;
            let date;
            
            // 根据匹配的格式解析日期时间
            if (fmt.id === 'yyyy-mm-dd-hh-mm-ss') {
                parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyymmddhhmmss') {
                if (dateTimeStr.length >= 14) {
                    const year = parseInt(dateTimeStr.substring(0, 4));
                    const month = parseInt(dateTimeStr.substring(4, 6)) - 1;
                    const day = parseInt(dateTimeStr.substring(6, 8));
                    const hour = parseInt(dateTimeStr.substring(8, 10));
                    const minute = parseInt(dateTimeStr.substring(10, 12));
                    const second = parseInt(dateTimeStr.substring(12, 14));
                    date = new Date(year, month, day, hour, minute, second);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-slash') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2})\/(\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm') {
                parts = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm-dash') {
                parts = dateTimeStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-dash') {
                parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-ss-slash') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm-ss') {
                parts = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            }
        }
    }
    
    // 如果没有匹配的格式，尝试使用Date对象解析
    const date = new Date(dateTimeStr);
    return isNaN(date.getTime()) ? null : date;
}

// 辅助函数：格式化日期键
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // 统一计算小时功率的函数
        function calculateHourlyPower(dataPoints, multiplier, timeInterval = 15, isDebug = false) {
            // 过滤无效数据
            const validData = dataPoints.filter(v => v !== null);
            
            if (validData.length === 0) {
                if (isDebug) {
                    console.log('计算小时功率调试信息：');
                    console.log('- 原始数据点数量:', dataPoints.length);
                    console.log('- 有效数据点数量: 0');
                    console.log('- 计算结果: null (无有效数据)');
                }
                return null;
            }
            
            // 根据时间间隔计算每小时应有的数据点数量
            const expectedPointsPerHour = 60 / timeInterval;
            
            // 计算总和
            const sum = validData.reduce((a, b) => a + b, 0);
            
            // 计算平均功率
            const avgPower = sum / validData.length;
            
            // 计算小时值：平均功率 × 1 × 倍率
            const hourlyValue = avgPower * 1 * multiplier;
            
            // 检查数据点数量是否匹配预期
            const isPointsCountValid = Math.abs(validData.length - expectedPointsPerHour) / expectedPointsPerHour <= 0.2; // 允许20%的误差
            
            if (isDebug) {
                console.log('计算小时功率调试信息：');
                console.log('- 原始数据点数量:', dataPoints.length);
                console.log('- 有效数据点数量:', validData.length);
                console.log('- 时间间隔:', timeInterval, '分钟');
                console.log('- 预期每小时数据点数量:', expectedPointsPerHour);
                console.log('- 数据点数量是否匹配:', isPointsCountValid ? '是' : '否');
                console.log('- 数据点总和:', sum.toFixed(2), 'kW');
                console.log('- 平均功率:', avgPower.toFixed(2), 'kW');
                console.log('- 倍率:', multiplier);
                console.log('- 计算结果:', hourlyValue.toFixed(2), 'kWh');
            }
            
            return hourlyValue;
        }
        
        // 辅助函数：获取筛选后的数据
        function getFilteredData() {
            return appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date) &&
                (appData.visualization.selectedMeteringPoints.length === 0 || 
                 appData.visualization.selectedMeteringPoints.includes(d.meteringPoint || ""))
            );
        }
        
        // 辅助函数：获取颜色
        function getColor(index) {
            const colors = [
                '#6366F1',   // 现代靛蓝色
                '#8B5CF6',   // 现代紫罗兰色
                '#EC4899',   // 现代粉红色
                '#10B981',   // 现代翠绿色
                '#F59E0B',   // 现代琥珀色
                '#EF4444',   // 现代红色
                '#06B6D4',   // 现代青色
                '#F97316',   // 现代橙色
                '#84CC16',   // 现代酸橙绿
                '#A855F7'    // 现代紫色
            ];
            
            return colors[index % colors.length];
        }
        
        // 辅助函数：获取颜色数量
        function getColorCount() {
            return 10; // 颜色数组中的颜色数量
        }



// 启动应用
document.addEventListener('DOMContentLoaded', initApp);

// 可折叠面板功能
document.addEventListener('DOMContentLoaded', function() {
    const togglePanels = document.querySelectorAll('.toggle-panel');
    
    togglePanels.forEach(panel => {
        panel.addEventListener('click', function() {
            const panelId = this.getAttribute('data-panel');
            const contentPanel = document.getElementById(`${panelId}-panel`);
            const icon = this.querySelector('.fa-chevron-down');
            
            if (contentPanel.style.display === 'none') {
                contentPanel.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                contentPanel.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        });
    });
});

        // 时段统计对比窗口功能
        let timeSlotComparisonDragging = false;
        let timeSlotComparisonDragOffset = { x: 0, y: 0 };
        let timeSlotComparisonMinimized = false;

        // 显示时段统计对比窗口
        window.showTimeSlotComparison = function() {
            const window = document.getElementById('timeSlotComparisonWindow');
            window.classList.remove('hidden');
            updateTimeSlotComparison();
            
            // 添加拖动事件监听
            setupTimeSlotComparisonDrag();
        }

        // 关闭时段统计对比窗口
        window.closeTimeSlotComparison = function() {
            const window = document.getElementById('timeSlotComparisonWindow');
            window.classList.add('hidden');
        }

        // 最小化/恢复时段统计对比窗口
        window.toggleTimeSlotComparisonMinimize = function() {
            const content = document.getElementById('timeSlotComparisonContent');
            const minimizeBtn = document.getElementById('minimizeTimeSlotComparison');
            
            if (timeSlotComparisonMinimized) {
                content.style.display = 'block';
                minimizeBtn.innerHTML = '<i class="fa fa-window-minimize"></i>';
                timeSlotComparisonMinimized = false;
            } else {
                content.style.display = 'none';
                minimizeBtn.innerHTML = '<i class="fa fa-window-maximize"></i>';
                timeSlotComparisonMinimized = true;
            }
        }

        // 设置拖动功能
        function setupTimeSlotComparisonDrag() {
            const header = document.getElementById('timeSlotComparisonHeader');
            const window = document.getElementById('timeSlotComparisonWindow');

            header.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                
                timeSlotComparisonDragging = true;
                const rect = window.getBoundingClientRect();
                timeSlotComparisonDragOffset.x = e.clientX - rect.left;
                timeSlotComparisonDragOffset.y = e.clientY - rect.top;
                
                document.addEventListener('mousemove', timeSlotComparisonMouseMove);
                document.addEventListener('mouseup', timeSlotComparisonMouseUp);
            });
        }

        function timeSlotComparisonMouseMove(e) {
            if (!timeSlotComparisonDragging) return;
            
            const window = document.getElementById('timeSlotComparisonWindow');
            const newX = e.clientX - timeSlotComparisonDragOffset.x;
            const newY = e.clientY - timeSlotComparisonDragOffset.y;
            
            // 确保窗口不超出屏幕边界
            const maxX = window.innerWidth - window.offsetWidth;
            const maxY = window.innerHeight - window.offsetHeight;
            
            window.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            window.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function timeSlotComparisonMouseUp() {
            timeSlotComparisonDragging = false;
            document.removeEventListener('mousemove', timeSlotComparisonMouseMove);
            document.removeEventListener('mouseup', timeSlotComparisonMouseUp);
        }

        // 更新时段统计对比数据
        window.updateTimeSlotComparison = function() {
            const startHour = parseInt(document.getElementById('timeSlotStart').value);
            const endHour = parseInt(document.getElementById('timeSlotEnd').value);
            
            if (startHour > endHour) {
                showNotification('提示', '开始时段不能大于结束时段', 'warning');
                return;
            }

            const filteredData = getFilteredData();
            if (filteredData.length === 0) {
                document.getElementById('timeSlotComparisonTableBody').innerHTML = '<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">暂无数据</td></tr>';
                return;
            }

            let totalPeriodEnergy = 0;
            let maxEnergy = 0;
            let minEnergy = Infinity;
            const periodData = [];

            // 计算每个日期在指定时段的用电量
            filteredData.forEach(row => {
                let periodEnergy = 0;
                let validHours = 0;
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (row.hourlyData[hour] !== null && row.hourlyData[hour] !== undefined) {
                        periodEnergy += row.hourlyData[hour];
                        validHours++;
                    }
                }
                
                if (validHours > 0) {
                    periodData.push({
                        date: row.date,
                        energy: periodEnergy,
                        totalEnergy: row.dailyTotal || 0
                    });
                    
                    totalPeriodEnergy += periodEnergy;
                    maxEnergy = Math.max(maxEnergy, periodEnergy);
                    minEnergy = Math.min(minEnergy, periodEnergy);
                }
            });

            // 更新表格
            const tbody = document.getElementById('timeSlotComparisonTableBody');
            tbody.innerHTML = '';

            periodData.forEach((item, index) => {
                const percentage = item.totalEnergy > 0 ? ((item.energy / item.totalEnergy) * 100).toFixed(1) : 0;
                const comparison = index > 0 ? 
                    ((item.energy - periodData[0].energy) / periodData[0].energy * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">${item.date}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${item.energy.toFixed(2)} kWh</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${percentage}%</td>
                    <td class="px-4 py-2 text-sm ${comparison >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${comparison >= 0 ? '+' : ''}${comparison}%
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 更新汇总信息
            const avgEnergy = periodData.length > 0 ? totalPeriodEnergy / periodData.length : 0;
            document.getElementById('timeSlotAvg').textContent = avgEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotMax').textContent = maxEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotMin').textContent = minEnergy === Infinity ? '0.00 kWh' : minEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotTotal').textContent = totalPeriodEnergy.toFixed(2) + ' kWh';
        }

        // 添加时段统计对比按钮到界面
        setTimeout(() => {
            const controlPanel = document.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200');
            if (controlPanel) {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.innerHTML = '<i class="fa fa-clock mr-1"></i> 时段统计';
                timeSlotBtn.className = 'bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary/90 ml-2';
                timeSlotBtn.onclick = showTimeSlotComparison;
                controlPanel.appendChild(timeSlotBtn);
            }

            // 添加事件监听
            document.getElementById('closeTimeSlotComparison').addEventListener('click', closeTimeSlotComparison);
            document.getElementById('minimizeTimeSlotComparison').addEventListener('click', toggleTimeSlotComparisonMinimize);
            document.getElementById('timeSlotStart').addEventListener('change', updateTimeSlotComparison);
            document.getElementById('timeSlotEnd').addEventListener('change', updateTimeSlotComparison);
        }, 1000);

        // 访问验证功能
        document.addEventListener('DOMContentLoaded', function() {
            // 加密验证系统（基础混淆）
            const _0x1a2b = ['\x46\x77\x6d\x31\x39\x39\x39', '\x4c\x4f\x41\x44\x32\x30\x32\x34', '\x73\x70\x6c\x69\x74', '\x72\x65\x76\x65\x72\x73\x65', '\x6a\x6f\x69\x6e', '']; 
            const _0xabc = _0x1a2b[0];
            
            // 多层验证函数
            function _0xdef(input) {
                if (!input) return false;
                const a = btoa(input);
                const b = a.split('').reverse().join('');
                const c = b.replace(/=/g, '');
                return c === 'OTkxOTltd0Y=' || input === atob('RndtMTk5OQ==');
            }
            
            const validInvitationCode = atob('RndtMTk5OQ=='); // 实际邀请码
            
            const accessForm = document.getElementById('accessForm');
            const invitationCodeInput = document.getElementById('invitationCode');
            const errorMessage = document.getElementById('errorMessage');
            const accessModal = document.getElementById('accessProtectionModal');

            // 检查本地存储（加密检查）
            const savedCode = localStorage.getItem('invitationCode');
            if (_0xdef(savedCode)) {
                accessModal.style.display = 'none';
                return;
            }

            // 验证表单提交（加密验证）
            accessForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const enteredCode = invitationCodeInput.value.trim();
                
                if (_0xdef(enteredCode)) {
                    // 保存到本地存储（7天有效期）
                    localStorage.setItem('invitationCode', validInvitationCode);
                    
                    // 隐藏验证遮罩
                    accessModal.style.transition = 'opacity 0.3s ease';
                    accessModal.style.opacity = '0';
                    setTimeout(() => {
                        accessModal.style.display = 'none';
                    }, 300);
                    
                    // 显示欢迎通知
                    showNotification('验证成功', '欢迎访问负荷曲线分析工具！', 'success');
                } else {
                    // 显示错误信息
                    errorMessage.textContent = '邀请码错误，请重试';
                    errorMessage.classList.remove('hidden');
                    invitationCodeInput.classList.add('border-red-500');
                    
                    // 清空输入框
                    invitationCodeInput.value = '';
                    invitationCodeInput.focus();
                }
            });

            // 输入框焦点事件
            invitationCodeInput.addEventListener('focus', function() {
                errorMessage.classList.add('hidden');
                this.classList.remove('border-red-500');
            });

            // 回车键提交
            invitationCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    accessForm.dispatchEvent(new Event('submit'));
                }
            });

            // 自动聚焦输入框
            invitationCodeInput.focus();
        });

        // 添加清除验证缓存的功能（可选）
        function clearAccessCache() {
            localStorage.removeItem('invitationCode');
            location.reload();
        }

        // 添加一个隐藏的管理功能（按Ctrl+Shift+A）
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                clearAccessCache();
            }
        });
    </script>
    
    <!-- 作者信息 -->
    <footer class="bg-white border-t border-gray-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">关于本工具</h3>
                    <p class="text-gray-600 text-sm">
                        <i class="fa fa-user mr-1"></i>
                        <strong>作者：冯伟明</strong>
                    </p>
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fa fa-weixin mr-1 text-green-500"></i>
                        微信联系方式：<strong>Call13345934750</strong>
                    </p>
                </div>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-md max-w-md mx-auto">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>重要提醒：</strong>该版本为初始版本，可能存在BUG，有问题请联系我
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-xs text-gray-500">
                    <p>© 2024 负荷曲线分析工具 - 专为电力数据分析设计</p>
                </div>
            </div>
        </div>
    </footer>
</body></html>
