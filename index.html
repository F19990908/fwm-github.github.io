<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24小时负荷曲线生成工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // ==================== 调试工具配置 ====================
        // 调试模式开关，设置为true可启用详细日志输出
        const DEBUG_MODE = true;
        
        // 警告级别配置
        const WARNING_LEVEL = {
            LOW: 1,      // 低级别警告，仅记录
            MEDIUM: 2,   // 中级别警告，记录并显示
            HIGH: 3      // 高级别警告，记录、显示并可能中断操作
        };
        
        // 当前警告级别阈值，高于此级别的警告将被显示
        const CURRENT_WARNING_THRESHOLD = WARNING_LEVEL.MEDIUM;
        
        /**
         * 调试日志函数
         * @param {string} message - 日志消息
         * @param {string} type - 日志类型（log, info, warn, error）
         * @param {any} data - 附加数据
         */
        function debugLog(message, type = 'log', data = null) {
            if (!DEBUG_MODE) return;
            
            const timestamp = new Date().toISOString();
            const prefix = `[DEBUG ${timestamp}]`;
            
            switch(type) {
                case 'info':
                    console.info(`${prefix} ${message}`, data || '');
                    break;
                case 'warn':
                    console.warn(`${prefix} ${message}`, data || '');
                    break;
                case 'error':
                    console.error(`${prefix} ${message}`, data || '');
                    break;
                default:
                    console.log(`${prefix} ${message}`, data || '');
            }
        }
        
        /**
         * 显示警告消息
         * @param {string} message - 警告消息
         * @param {number} level - 警告级别
         * @param {boolean} showToast - 是否显示提示框
         */
        function showWarning(message, level = WARNING_LEVEL.MEDIUM, showToast = true) {
            // 记录警告日志
            debugLog(`WARNING [Level ${level}]: ${message}`, 'warn');
            
            // 如果警告级别低于当前阈值，不显示提示
            if (level < CURRENT_WARNING_THRESHOLD) return;
            
            // 显示警告提示
            if (showToast) {
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all-300 ${
                    level >= WARNING_LEVEL.HIGH ? 'bg-red-100 border border-red-400 text-red-700' : 
                    level >= WARNING_LEVEL.MEDIUM ? 'bg-yellow-100 border border-yellow-400 text-yellow-700' : 
                    'bg-blue-100 border border-blue-400 text-blue-700'
                }`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa ${
                            level >= WARNING_LEVEL.HIGH ? 'fa-exclamation-circle' : 
                            level >= WARNING_LEVEL.MEDIUM ? 'fa-exclamation-triangle' : 
                            'fa-info-circle'
                        } mr-2"></i>
                        <span>${message}</span>
                        <button class="ml-4 text-lg" onclick="this.parentElement.parentElement.remove()" aria-label="关闭通知">×</button>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // 5秒后自动移除提示
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 5000);
            }
        }
        
        /**
         * 性能监控函数
         * @param {string} label - 性能监控标签
         * @param {Function} fn - 要执行的函数
         * @returns {any} 函数执行结果
         */
        function monitorPerformance(label, fn) {
            if (!DEBUG_MODE) return fn();
            
            const startTime = performance.now();
            debugLog(`开始性能监控: ${label}`, 'info');
            
            try {
                const result = fn();
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                debugLog(`性能监控完成: ${label}, 耗时: ${duration.toFixed(2)}ms`, 'info');
                
                // 如果执行时间超过阈值，显示警告
                if (duration > 1000) {
                    showWarning(`操作耗时较长: ${label} (${duration.toFixed(2)}ms)`, WARNING_LEVEL.MEDIUM);
                }
                
                return result;
            } catch (error) {
                const endTime = performance.now();
                const duration = endTime - startTime;
                debugLog(`性能监控出错: ${label}, 耗时: ${duration.toFixed(2)}ms, 错误: ${error.message}`, 'error', error);
                throw error;
            }
        }
        
        // ==================== Tailwind CSS 配置 ====================
        // Tailwind CSS 自定义配置
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 企业级专业配色方案
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            DEFAULT: '#0ea5e9'
                        },
                        secondary: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                            DEFAULT: '#14b8a6'
                        },
                        accent: {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7c3aed',
                            800: '#6b21a8',
                            900: '#581c87',
                            DEFAULT: '#a855f7'
                        },
                        neutral: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            DEFAULT: '#64748b'
                        },
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        light: '#f8fafc',
                        dark: '#0f172a'
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'monospace']
                    },
                    fontSize: {
                        'xs': ['0.75rem', { lineHeight: '1rem' }],
                        'sm': ['0.875rem', { lineHeight: '1.25rem' }],
                        'base': ['1rem', { lineHeight: '1.5rem' }],
                        'lg': ['1.125rem', { lineHeight: '1.75rem' }],
                        'xl': ['1.25rem', { lineHeight: '1.75rem' }],
                        '2xl': ['1.5rem', { lineHeight: '2rem' }],
                        '3xl': ['1.875rem', { lineHeight: '2.25rem' }],
                        '4xl': ['2.25rem', { lineHeight: '2.5rem' }]
                    },
                    spacing: {
                        '18': '4.5rem',
                        '88': '22rem',
                        '128': '32rem'
                    },
                    borderRadius: {
                        'xl': '0.75rem',
                        '2xl': '1rem',
                        '3xl': '1.5rem'
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'strong': '0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
            };
        }
    </script>
    <style type="text/tailwindcss">
        /* ==================== 现代化企业级样式系统 ==================== */
        
        @layer utilities {
            /* 性能优化工具类 */
            .content-auto {
                content-visibility: auto;
                contain-intrinsic-size: 0 500px;
            }
            
            .gpu-accelerated {
                transform: translateZ(0);
                will-change: transform;
            }
            
            /* 滚动条样式优化 */
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            
            .scrollbar-thin {
                scrollbar-width: thin;
                scrollbar-color: #cbd5e1 #f1f5f9;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 3px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            
            /* 现代化阴影系统 */
            .shadow-soft {
                box-shadow: 0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04);
            }
            
            .shadow-medium {
                box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            .shadow-strong {
                box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.05);
            }
            
            /* 渐变背景 */
            .bg-gradient-primary {
                background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            }
            
            .bg-gradient-secondary {
                background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            }
            
            .bg-gradient-accent {
                background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            }
            
            .bg-gradient-surface {
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            }
            
            /* 动画系统 */
            .transition-smooth {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .transition-fast {
                transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .transition-slow {
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            /* 图表专用动画 */
            .animate-fade-in {
                animation: fadeIn 0.4s ease-out;
            }
            
            .animate-slide-up {
                animation: slideUp 0.5s ease-out;
            }
            
            .animate-scale-in {
                animation: scaleIn 0.3s ease-out;
            }
            
            .animate-chart-load {
                animation: chartLoad 0.8s ease-out;
            }
            
            .animate-pulse-soft {
                animation: pulseSoft 2s ease-in-out infinite;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            @keyframes scaleIn {
                from { transform: scale(0.9); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            @keyframes chartLoad {
                0% { transform: scale(0.8) rotateY(-5deg); opacity: 0; }
                50% { transform: scale(1.02) rotateY(2deg); }
                100% { transform: scale(1) rotateY(0deg); opacity: 1; }
            }
            
            @keyframes pulseSoft {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            /* 悬停效果 */
            .hover-lift {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            .hover-lift:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
            }
            
            /* 玻璃态效果 */
            .glass {
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .glass-dark {
                background: rgba(15, 23, 42, 0.8);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
        
        /* ==================== 现代化图表容器样式 ==================== */
        
        #chartContainer, #barChartContainer {
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #chartContainer:hover, #barChartContainer:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        #chartContainer.loading {
            animation: pulseSoft 2s ease-in-out infinite;
        }
        
        #chartContainer canvas, #barChartContainer canvas {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0.5rem;
        }
        
        /* 图表加载状态 */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 1rem;
            border: 2px dashed #cbd5e1;
        }
        
        .chart-loading::before {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== 现代化数据表格样式 ==================== */
        
        #dataPreview {
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(226, 232, 240, 0.6);
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            position: relative;
        }
        
        #dataPreview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #10b981);
            border-radius: 1rem 1rem 0 0;
        }
        
        #dataPreview table {
            border-collapse: separate;
            border-spacing: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 100%;
            background: transparent;
        }
        
        #dataPreview th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 700;
            color: #1e293b;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            padding: 1.25rem 1rem;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        #dataPreview th:first-child {
            border-top-left-radius: 0.75rem;
        }
        
        #dataPreview th:last-child {
            border-top-right-radius: 0.75rem;
        }
        
        #dataPreview td {
            font-size: 0.875rem;
            line-height: 1.5rem;
            padding: 1rem;
            border-bottom: 1px solid rgba(241, 245, 249, 0.8);
            border-right: 1px solid rgba(241, 245, 249, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            font-weight: 500;
            position: relative;
        }
        
        #dataPreview td:last-child {
            border-right: none;
        }
        
        #dataPreview tbody tr {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        #dataPreview tbody tr::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }
        
        #dataPreview tbody tr:hover::before {
            width: 4px;
        }
        
        #dataPreview tbody tr:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(6, 182, 212, 0.03) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.08);
        }
        
        #dataPreview tbody tr:hover td {
            color: #1e293b;
            font-weight: 600;
        }
        
        #dataPreview tbody tr:nth-child(even) {
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.4) 0%, rgba(241, 245, 249, 0.2) 100%);
        }
        
        #dataPreview tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(6, 182, 212, 0.03) 100%);
        }
        
        #dataPreview .selected-row {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(6, 182, 212, 0.08) 100%) !important;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.15);
        }
        
        #dataPreview .selected-row td {
            color: #1e40af;
            font-weight: 600;
        }
        
        /* 数据预览表格响应式优化 */
        @media (max-width: 1024px) {
            #dataPreview {
                border-radius: 0.75rem;
            }
            
            #dataPreview th {
                font-size: 0.75rem;
                padding: 1rem 0.75rem;
                letter-spacing: 0.025em;
            }
            
            #dataPreview td {
                font-size: 0.8rem;
                padding: 0.875rem 0.75rem;
            }
        }
        
        @media (max-width: 768px) {
            #dataPreview {
                border-radius: 0.5rem;
                margin: 0 -0.5rem;
            }
            
            #dataPreview::before {
                height: 3px;
            }
            
            #dataPreview th {
                font-size: 0.7rem;
                padding: 0.875rem 0.5rem;
                letter-spacing: 0.02em;
            }
            
            #dataPreview td {
                font-size: 0.75rem;
                padding: 0.75rem 0.5rem;
            }
            
            #dataPreview tbody tr:hover {
                transform: none;
            }
        }
        
        @media (max-width: 480px) {
            #dataPreview th,
            #dataPreview td {
                padding: 0.625rem 0.375rem;
                font-size: 0.8rem;
            }
        }
        
        /* ==================== 可折叠面板样式 ==================== */
        
        /**
         * 可折叠面板样式
         * 禁用文本选择，提供更好的交互体验
         */
        .toggle-panel {
            user-select: none;
        }
        
        /**
         * 可折叠面板悬停效果
         */
        .toggle-panel:hover {
            background-color: #e5e7eb;
        }
        
        /**
         * 面板内容过渡动画
         */
        .panel-content {
            transition: all 0.3s ease;
        }
        
        /* ==================== 文字居中样式 ==================== */
        
        /**
         * 文字居中样式
         * 使用flexbox实现水平和垂直居中
         */
        .text-center-div {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ==================== 表头冻结样式 ==================== */
        
        /**
         * 表头冻结样式
         * 在滚动时保持表头可见
         */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* ==================== 卡片标题栏样式 ==================== */
        
        /**
         * 卡片标题栏样式
         * 提供统一的卡片标题外观和交互效果
         */
        .card-header {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 16px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        /**
         * 卡片标题栏悬停效果
         */
        .card-header:hover {
            background-color: #f3f4f6;
        }
        
        /**
         * 卡片内容样式
         */
        .card-content {
            padding: 20px;
        }
        
        /* ==================== 下拉箭头动画 ==================== */
        
        /**
         * 下拉箭头动画
         * 为折叠面板的箭头图标提供平滑的旋转动画
         */
        .fa-chevron-down {
            transition: transform 0.2s ease;
        }
        
        /* ==================== 响应式居中样式 ==================== */
        
        /**
         * 响应式居中
         * 在小屏幕设备上调整文字居中方式
         */
        @media (max-width: 768px) {
            .text-center-div {
                text-align: center;
                display: block;
            }
        }
        
        /* ==================== 现代化卡片组件样式 ==================== */
        
        .card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 1rem;
            box-shadow: 0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .card:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(59, 130, 246, 0.1);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .card-content {
            color: #64748b;
            line-height: 1.7;
            font-size: 0.95rem;
        }
        
        /* 特殊卡片变体 */
        .card-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-elevated {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        /* ==================== 现代化按钮组件样式 ==================== */
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px -8px rgba(14, 165, 233, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #075985 100%);
            box-shadow: 0 15px 35px -5px rgba(14, 165, 233, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px -5px rgba(14, 165, 233, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #475569;
            border: 1px solid rgba(203, 213, 225, 0.8);
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: rgba(14, 165, 233, 0.3);
            box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.1);
            color: #334155;
        }
        
        .btn-secondary:hover::before {
            left: 100%;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 50%, #be123c 100%);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px -8px rgba(244, 63, 94, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-danger::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e11d48 0%, #be123c 50%, #9f1239 100%);
            box-shadow: 0 15px 35px -5px rgba(244, 63, 94, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-danger:hover::before {
            left: 100%;
        }
        
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px -5px rgba(244, 63, 94, 0.4);
        }
        
        /* 按钮尺寸变体 */
        .btn-sm {
            padding: 0.625rem 1.5rem;
            font-size: 0.8rem;
            border-radius: 0.5rem;
        }
        
        .btn-lg {
            padding: 1rem 2.5rem;
            font-size: 1rem;
            border-radius: 1rem;
        }
        
        /* 按钮禁用状态 */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<!-- 
    ==================== HTML文档主体 ====================
    负荷曲线生成工具的主界面，包含访问验证、导航栏和主要内容区域
-->
<body class="bg-gray-50 font-sans text-dark">
    <!-- 
        ==================== 作者信息弹窗 ====================
        进入网页时显示的作者信息和欢迎提示
    -->
    <div id="authorInfoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 shadow-2xl animate-scale-in">
            <div class="text-center">
                <div class="w-20 h-20 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-lock text-white text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">负荷曲线分析工具</h2>
                <p class="text-lg text-gray-600 mb-6">专业电力数据分析平台</p>
                
                <!-- 密码验证区域 -->
                <div id="passwordSection" class="mb-6">
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-6 mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">🔐 访问验证</h3>
                        <p class="text-sm text-gray-600 mb-4">请输入访问密码以继续使用</p>
                        
                        <div class="space-y-4">
                            <div>
                                <input type="password" 
                                       id="accessPassword" 
                                       placeholder="请输入访问密码" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-center text-lg font-mono tracking-wider"
                                       maxlength="20">
                            </div>
                            
                            <button id="verifyPasswordBtn" 
                                    class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg hover:from-green-600 hover:to-blue-600 transition-all-300 font-medium text-lg">
                                <i class="fa fa-key mr-2"></i>验证密码
                            </button>
                            
                            <div id="passwordError" class="text-red-500 text-sm hidden">
                                <i class="fa fa-exclamation-circle mr-1"></i>
                                密码错误，请重试
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 作者信息区域（验证成功后显示） -->
                <div id="authorSection" class="hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3">👨‍💻 作者信息</h3>
                        <div class="space-y-2 text-left">
                            <p><i class="fa fa-user-circle text-primary mr-2"></i><strong>作者：</strong>冯伟明</p>
                            <p><i class="fa fa-phone text-secondary mr-2"></i><strong>微信：</strong>Call13345934750</p>
                            <p><i class="fa fa-comments text-green-500 mr-2"></i><strong>公众号：</strong>能源小鲨鱼</p>
                            <p><i class="fa fa-envelope text-accent mr-2"></i><strong>邮箱：</strong>1847461355@qq.com</p>
                        <p><i class="fa fa-calendar text-warning mr-2"></i><strong>版本：</strong>v1.0.0</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-6">
                        <h4 class="text-lg font-semibold text-yellow-800 mb-2">💡 使用提示</h4>
                        <ul class="text-sm text-yellow-700 space-y-1 text-left">
                            <li>• 支持Excel文件导入，支持.xlsx和.xls格式</li>
                            <li>• 可生成24小时负荷曲线图和柱状图</li>
                            <li>• 支持数据导出为Excel格式</li>
                            <li>• 如有问题请联系作者微信</li>
                        </ul>
                    </div>
                    
                    <button id="startUsingBtn" 
                            class="w-full bg-gradient-to-r from-primary to-secondary text-white py-3 rounded-lg hover:from-primary/90 hover:to-secondary/90 transition-all-300 font-medium text-lg">
                        <i class="fa fa-rocket mr-2"></i>开始使用
                    </button>
                    
                    <p class="text-xs text-gray-500 mt-4">
                        <i class="fa fa-heart text-red-500 mr-1"></i>
                        感谢您的信任与支持！
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 
        ==================== 顶部导航栏 ====================
        提供工具的主要导航功能，包括标题、帮助和关于按钮
        使用sticky定位确保在页面滚动时始终可见
    -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-slate-400 to-slate-500 rounded-full blur-sm opacity-20"></div>
                    <div class="relative bg-gradient-to-r from-slate-500 to-slate-600 p-3 rounded-full shadow-md">
                        <i class="fa fa-line-chart text-white text-xl"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-slate-700 to-slate-800 bg-clip-text text-transparent leading-tight">
                        24小时负荷曲线生成工具
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">专业电力数据分析平台</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="helpBtn" class="text-neutral hover:text-primary transition-all-300 flex items-center" aria-label="帮助" title="帮助">
                    <i class="fa fa-question-circle mr-1"></i>
                    <span class="hidden md:inline">帮助</span>
                </button>
                <button id="aboutBtn" class="text-neutral hover:text-primary transition-all-300 flex items-center" aria-label="关于" title="关于">
                    <i class="fa fa-info-circle mr-1"></i>
                    <span class="hidden md:inline">关于</span>
                </button>
            </div>
        </div>
    </header>

    <!-- 
        ==================== 使用说明面板 ====================
        提供工具的详细使用说明，包括快速开始指南和各功能模块介绍
        默认隐藏，通过点击导航栏的"帮助"按钮显示
    -->
    <div id="helpPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">📚 使用说明</h2>
                    <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700" aria-label="关闭帮助" title="关闭帮助">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6 space-y-6">
                    <!-- 快速开始指南 -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-blue-900 mb-3">
                            <i class="fa fa-rocket mr-2"></i>快速开始
                        </h3>
                        <ol class="list-decimal list-inside space-y-2 text-blue-800">
                            <li>点击左侧<strong>【数据导入】</strong>上传Excel文件</li>
                            <li>在<strong>【图表配置】</strong>中设置参数</li>
                            <li>查看生成的负荷曲线图表</li>
                            <li>点击<strong>【导出数据】</strong>保存结果</li>
                        </ol>
                    </div>



                    <!-- 
                        ==================== 功能说明 ====================
                        详细介绍工具的主要功能模块，包括图表功能和配置选项
                        使用网格布局展示功能分类，提高可读性
                    -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fa fa-cogs mr-2 text-purple-600"></i>功能说明
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">📊 图表功能</h4>
                                <ul class="text-sm space-y-1 text-gray-600">
                                    <li>• 24小时负荷曲线图</li>
                                    <li>• 柱状图对比显示</li>
                                    <li>• 鼠标悬停显示数值</li>
                                    <li>• 自动缩放和自适应</li>
                                </ul>
                            </div>
                            <div class="border rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">⚙️ 配置选项</h4>
                                <ul class="text-sm space-y-1 text-gray-600">
                                    <li>• 图表标题自定义</li>
                                    <li>• 颜色主题选择</li>
                                    <li>• 数据标签显示</li>
                                    <li>• 网格线开关</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 
                        ==================== 详细操作步骤 ====================
                        提供工具使用的详细步骤说明，包括数据导入、预览、配置和导出
                        使用左侧边框和颜色编码区分不同步骤，提高视觉引导
                    -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fa fa-list-ol mr-2 text-orange-600"></i>详细操作步骤
                        </h3>
                        <div class="space-y-4">
                            <div class="border-l-4 border-blue-500 pl-4">
                                <h4 class="font-semibold">1. 数据导入</h4>
                                <p class="text-sm text-gray-600">点击"选择文件"按钮，选择符合格式的Excel文件，系统会自动解析数据并显示预览。</p>
                            </div>
                            <div class="border-l-4 border-green-500 pl-4">
                                <h4 class="font-semibold">2. 数据预览</h4>
                                <p class="text-sm text-gray-600">在数据预览区域确认数据正确性，可查看前100条记录。</p>
                            </div>
                            <div class="border-l-4 border-purple-500 pl-4">
                                <h4 class="font-semibold">3. 图表配置</h4>
                                <p class="text-sm text-gray-600">设置图表标题、选择显示类型（曲线图/柱状图）、调整颜色主题。</p>
                            </div>
                            <div class="border-l-4 border-red-500 pl-4">
                                <h4 class="font-semibold">4. 结果导出</h4>
                                <p class="text-sm text-gray-600">点击"导出数据"按钮，可下载Excel格式的分析结果和图表。</p>
                            </div>
                        </div>
                    </div>

                    <!-- 
                        ==================== 常见问题 ====================
                        提供用户可能遇到的问题及解决方案
                        使用不同背景色区分问题类型，便于快速定位
                    -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">
                            <i class="fa fa-question-circle mr-2 text-red-600"></i>常见问题
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-red-50 border-l-4 border-red-400 p-3 rounded">
                                <h4 class="font-semibold text-red-800">Q: 文件上传失败怎么办？</h4>
                                <p class="text-sm text-red-700">A: 检查文件格式是否正确，确保Excel文件包含所需的列名。</p>
                            </div>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                                <h4 class="font-semibold text-yellow-800">Q: 图表显示异常？</h4>
                                <p class="text-sm text-yellow-700">A: 刷新页面重新加载，或检查数据是否包含空值或异常值。</p>
                            </div>
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
                                <h4 class="font-semibold text-blue-800">Q: 如何联系技术支持？</h4>
                                <p class="text-sm text-blue-700">A: 通过微信<strong>Call13345934750</strong>联系作者冯伟明。</p>
                            </div>
                        </div>
                    </div>

                    <!-- 
                        ==================== 版本信息 ====================
                        提供工具的版本信息、更新时间和联系方式
                        使用灰色背景突出显示版本信息
                    -->
                    <div class="bg-gray-100 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            <i class="fa fa-info-circle mr-2"></i>版本信息
                        </h3>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p><strong>当前版本：</strong>v1.0.0 (初始版本)</p>
                            <p><strong>更新时间：</strong>2025年9月</p>
                            <p><strong>功能状态：</strong>基础功能完整，可能存在BUG</p>
                            <p><strong>技术支持：</strong>冯伟明 (微信: Call13345934750)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 
        ==================== 主内容区域 ====================
        包含工具的主要功能区域，使用响应式布局确保在不同设备上的良好显示
        主要包括：步骤指示器、文件导入、数据配置、可视化和导出结果等功能模块
    -->
    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 
            ==================== 全新步骤导航 ====================
            现代化的步骤导航设计，使用卡片式布局和渐变色彩
            包含进度条、图标、文字说明，支持状态切换和动画效果
        -->
        <div class="mb-8 bg-gradient-to-r from-white to-gray-50 rounded-2xl p-6 shadow-xl border border-gray-200/50">
            
            <!-- 导航图标组 -->
            <div class="flex justify-center items-center gap-8">
                <!-- 导航1：导入数据 -->
                <div id="stepCard1" class="nav-icon-card active" data-step="1" onclick="scrollToSection('importSection')" title="点击跳转到数据导入">
                    <div class="nav-icon active">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <span class="nav-label">导入数据</span>
                    <div class="click-hint">点击跳转</div>
                </div>

                <!-- 导航2：数据配置 -->
                <div id="stepCard2" class="nav-icon-card" data-step="2" onclick="scrollToSection('configSection')" title="点击跳转到数据配置">
                    <div class="nav-icon">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <span class="nav-label">数据配置</span>
                    <div class="click-hint">点击跳转</div>
                </div>

                <!-- 导航3：可视化 -->
                <div id="stepCard3" class="nav-icon-card" data-step="3" onclick="scrollToSection('visualizationSection')" title="点击跳转到可视化">
                    <div class="nav-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span class="nav-label">可视化</span>
                    <div class="click-hint">点击跳转</div>
                </div>

                <!-- 导航4：导出结果 -->
                <div id="stepCard4" class="nav-icon-card" data-step="4" onclick="scrollToSection('exportSection')" title="点击跳转到导出结果">
                    <div class="nav-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <span class="nav-label">导出结果</span>
                    <div class="click-hint">点击跳转</div>
                </div>
            </div>
        </div>

        <!-- 导航图标样式 -->
        <style>
            /* 导航图标卡片样式 */
            .nav-icon-card {
                position: relative;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                border-radius: 0.75rem;
            }
            
            .nav-icon-card:hover {
                transform: translateY(-2px);
            }
            
            .nav-icon-card:hover .click-hint {
                opacity: 1;
                transform: translateY(0);
            }
            
            .nav-icon-card.active .nav-icon {
                background: linear-gradient(to bottom right, #3b82f6, #2563eb);
                color: white;
                box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.6);
            }
            
            .nav-icon-card.completed .nav-icon {
                background: linear-gradient(to bottom right, #10b981, #059669);
                color: white;
                box-shadow: 0 8px 25px -8px rgba(16, 185, 129, 0.6);
            }
            
            /* 导航图标样式 */
            .nav-icon {
                width: 3rem;
                height: 3rem;
                border-radius: 50%;
                background-color: #f3f4f6;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 0.5rem;
                transition: all 0.3s ease;
                color: #6b7280;
            }
            
            .nav-icon:hover {
                background-color: #e5e7eb;
                transform: scale(1.1);
            }
            
            .nav-icon i {
                font-size: 1.25rem;
            }
            
            /* 导航标签样式 */
            .nav-label {
                font-size: 0.875rem;
                font-weight: 600;
                color: #374151;
                text-align: center;
                margin-bottom: 0.25rem;
            }
            
            .nav-icon-card.active .nav-label {
                color: #1d4ed8;
            }
            
            .nav-icon-card.completed .nav-label {
                color: #059669;
            }
            
            /* 点击提示样式 */
            .click-hint {
                font-size: 0.75rem;
                color: #9ca3af;
                opacity: 0;
                transform: translateY(5px);
                transition: all 0.3s ease;
                text-align: center;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 0.375rem;
                position: absolute;
                bottom: -2rem;
                white-space: nowrap;
                z-index: 10;
            }
            
            .click-hint::before {
                content: '';
                position: absolute;
                top: -4px;
                left: 50%;
                transform: translateX(-50%);
                border-left: 4px solid transparent;
                border-right: 4px solid transparent;
                border-bottom: 4px solid rgba(0, 0, 0, 0.8);
            }
            
            /* 响应式设计 */
            @media (max-width: 640px) {
                .nav-icon-card {
                    padding: 0.75rem;
                }
                
                .nav-icon {
                    width: 2.5rem;
                    height: 2.5rem;
                }
                
                .nav-icon i {
                    font-size: 1rem;
                }
                
                .nav-label {
                    font-size: 0.75rem;
                }
            }
        </style>

        <!-- 
            ==================== 第一部分：文件导入 ====================
            提供数据导入功能，支持Excel文件上传和预览
            使用卡片式布局，包含标题、描述和文件上传控件
        -->
        <section id="importSection" class="mb-6">
            <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-100/50 hover:shadow-xl transition-all-300">
                <!-- 标题区域 -->
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center shadow-lg mr-4">
                        <i class="fa fa-upload text-white text-base"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">数据导入</h2>
                        <p class="text-sm text-gray-600 mt-1">智能识别Excel格式，一键导入并自动分析</p>
                    </div>
                </div>

                <!-- 主内容区域 - 网格布局 -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 左侧：文件上传区域 -->
                    <div class="lg:col-span-2">
                        <div class="bg-gradient-to-br from-gray-50 to-blue-50/30 rounded-xl p-6 border border-gray-200/50 h-full flex flex-col">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                                <i class="fa fa-cloud-upload-alt text-primary mr-2"></i>
                                文件上传
                            </h3>
                            
                            <!-- 拖拽上传区域 -->
                            <div id="dropArea" class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary hover:bg-white/50 transition-all-300 cursor-pointer group flex-1 flex flex-col justify-center">
                                <div class="absolute inset-0 bg-gradient-to-br from-primary/5 to-blue-500/5 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="relative z-10">
                                    <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-primary/20 to-blue-100 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                        <i class="fa fa-file-upload text-4xl text-primary"></i>
                                    </div>
                                    <h4 class="text-xl font-semibold text-gray-700 mb-2">拖拽文件到此处</h4>
                                    <p class="text-gray-500 mb-4">或 <span class="text-primary font-semibold">点击选择文件</span></p>
                                    <div class="flex items-center justify-center space-x-4 text-sm text-gray-400">
                                        <span class="flex items-center">
                                            <i class="fa fa-file-excel text-green-600 mr-1"></i>
                                            Excel (.xlsx, .xls)
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fa fa-file-csv text-blue-600 mr-1"></i>
                                            CSV (.csv)
                                        </span>
                                    </div>
                                    <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv" multiple="" aria-label="选择Excel或CSV文件上传">
                                </div>
                            </div>

                            <!-- 上传进度 -->
                            <div id="uploadProgress" class="hidden mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700">上传进度</span>
                                    <span id="progressText" class="text-sm text-gray-500">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="progressBar" class="bg-gradient-to-r from-primary to-blue-600 h-2 rounded-full transition-all-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧：数据概览区域 -->
                    <div class="flex flex-col space-y-3 h-full">
                        <!-- 文件统计 -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50/50 rounded-xl p-3 border border-gray-200/50">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                <i class="fa fa-chart-bar text-green-600 mr-2"></i>
                                数据概览
                            </h4>
                            <div id="dataStats" class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">文件数量</span>
                                    <span id="fileCount" class="text-sm font-semibold text-gray-800">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">时间范围</span>
                                    <span id="timeRange" class="text-sm font-semibold text-gray-800">-</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">计量点</span>
                                    <span id="meteringPoints" class="text-sm font-semibold text-gray-800">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- 文件列表 - 固定展开 -->
                        <div id="fileList" class="block">
                            <div class="bg-white rounded-xl border border-gray-200/50 p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-700">已导入文件</h4>
                                    <button id="removeAllFiles" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 hidden">
                                        <i class="fa fa-trash mr-1"></i>清空
                                    </button>
                                </div>
                                <ul id="importedFiles" class="space-y-1 text-sm max-h-40 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"></ul>
                            </div>
                        </div>

                        <!-- 导入历史 -->
                        <div class="bg-white rounded-xl border border-gray-200/50 flex flex-col flex-1">
                            <div class="p-3 flex-1 flex flex-col">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-700">导入历史</h4>
                                    <span class="text-xs text-gray-500">
                                        <i class="fa fa-history mr-1"></i>最近记录
                                    </span>
                                </div>
                                <div id="importHistory" class="text-xs text-gray-500 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 flex-1">
                                    <div id="historyList">
                                        <p class="text-center py-2">暂无历史记录</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作区域 -->
                <div class="flex items-center justify-between mt-6 pt-4 border-t border-gray-100">
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">状态:</span>
                        <span id="importStatus" class="text-sm font-medium text-gray-700">等待文件上传</span>
                    </div>

                </div>
            </div>
        </section>

        <!-- 
            ==================== 第二部分：数据配置 ====================
            提供数据类型、结构、日期和列的配置选项
            使用可折叠面板组织配置项，提高界面整洁度
        -->
        <section id="configSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-100 hover:shadow-xl transition-all-300">

                
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fa fa-cogs text-primary mr-3"></i>数据配置
                </h2>
                
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                    <!-- 左侧配置 -->
                    <div class="space-y-6">
                        <!-- 
                            ==================== 数据类型配置 ====================
                            选择数据类型（瞬时功率或累积电能），影响后续分析计算方式
                            使用蓝色主题和步骤标记，提供详细说明和提示
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="dataType">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-database mr-2 text-primary"></i>数据类型
                                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">步骤1</span>
                                </h3>
                                <div class="flex items-center space-x-2">
                                    <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                                </div>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="dataType-panel">
                                <div class="bg-blue-50 p-2 rounded-lg">
                                    <p class="text-xs text-blue-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        选择正确的数据类型将影响后续的分析计算方式
                                    </p>
                                </div>
                                <div>
                                    <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200">
                                        <input type="radio" name="dataType" value="instantPower" class="form-radio text-primary w-4 h-4" checked>
                                        <div class="ml-3">
                                            <span class="text-xs font-medium text-gray-700">瞬时功率</span>
                                            <p class="text-xs text-gray-500 mt-1">实时功率值，如P(t)表示t时刻的功率</p>
                                        </div>
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-200">
                                        <input type="radio" name="dataType" value="cumulativeEnergy" class="form-radio text-primary w-4 h-4">
                                        <div class="ml-3">
                                            <span class="text-xs font-medium text-gray-700">累积电能</span>
                                            <p class="text-xs text-gray-500 mt-1">累计用电量，如E(t)表示t时刻的总电能</p>
                                        </div>
                                    </label>
                                </div>
                                <div class="bg-blue-50 p-2 rounded-lg">
                                    <p class="text-xs text-blue-700">
                                        <i class="fa fa-lightbulb mr-1"></i>
                                        系统会根据数据类型自动选择合适的处理算法
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== 数据结构配置 ====================
                            选择数据结构（列对行或列对列），根据Excel文件格式确定
                            使用绿色主题和步骤标记，提供详细说明和提示
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="dataStructure">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-table mr-2 text-primary"></i>数据结构
                                    <span class="ml-2 px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">步骤2</span>
                                </h3>
                                <div class="flex items-center space-x-2">
                                    <i class="fa fa-question-circle text-gray-400 hover:text-green-500 cursor-help text-xs" 
                                       title="列对行：日期在一列，数据在多列（每列代表一个时间点）&#10;列对列：日期在一列，数据在另一列（每行代表一个时间点）"></i>
                                    <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                                </div>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="dataStructure-panel">
                                <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                                    <input type="radio" name="dataStructure" value="columnToRow" class="form-radio text-primary w-4 h-4" checked>
                                    <div class="ml-3">
                                        <span class="text-xs font-medium text-gray-700">列对行（日期列对多数据列）</span>
                                        <p class="text-xs text-gray-500 mt-1">适合：日期列 + 多个时间点数据列</p>
                                    </div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer group w-full p-3 rounded-lg hover:bg-green-50 transition-colors border border-transparent hover:border-green-200">
                                    <input type="radio" name="dataStructure" value="columnToColumn" class="form-radio text-primary w-4 h-4">
                                    <div class="ml-3">
                                        <span class="text-xs font-medium text-gray-700">列对列（日期列对单数据列）</span>
                                        <p class="text-xs text-gray-500 mt-1">适合：日期列 + 单个数据列</p>
                                    </div>
                                </label>
                                <div class="p-2 bg-green-50 rounded-md">
                                    <p class="text-xs text-green-700">
                                        <i class="fa fa-lightbulb mr-1"></i>
                                        根据您的Excel文件格式选择合适的数据结构
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- 
                            ==================== 日期配置 ====================
                            选择包含日期的列，系统自动识别日期格式
                            使用紫色主题和步骤标记，提供详细说明和提示
                        -->
                        <div class="bg-white rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="date">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-calendar mr-2 text-primary"></i>日期配置
                                    <span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">步骤3</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="date-panel">
                                <div class="bg-purple-50 p-2 rounded-lg">
                                    <p class="text-xs text-purple-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        选择包含日期的列，系统将自动识别日期格式
                                    </p>
                                </div>
                                <div>
                                    <label for="dateColumn" class="block text-sm font-semibold text-gray-700 mb-2">
                                        日期所在列 
                                        <span class="text-xs text-gray-500 ml-1">(通常为A列或第一列)</span>
                                    </label>
                                    <select id="dateColumn" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="日期列" title="选择日期列">
                                        <option value="">-- 请选择日期列 --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== 列配置 ====================
                            选择包含实际数据的列范围，系统将提取这些列的数值进行分析
                            使用橙色主题和步骤标记，提供详细说明和提示
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="columns">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-columns mr-2 text-primary"></i>用电配置
                                    <span class="ml-2 px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">步骤4</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="columns-panel">
                                <div class="bg-orange-50 p-2 rounded-lg">
                                    <p class="text-xs text-orange-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        选择包含实际数据的列范围，系统将提取这些列的数值进行分析
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-800 mb-2">
                                        数据起始列
                                        <span class="text-sm text-gray-600 ml-1">(数据开始的第一列)</span>
                                    </label>
                                    <select id="dataStartColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="数据起始列" title="选择数据起始列">
                                        <option value="">-- 请选择起始列 --</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-gray-800 mb-2">
                                        数据结束列
                                        <span class="text-sm text-gray-600 ml-1">(数据结束的最后列)</span>
                                    </label>
                                    <select id="dataEndColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="数据结束列" title="选择数据结束列">
                                        <option value="">-- 请选择结束列 --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fa fa-lightbulb mr-1"></i>
                                        系统将提取从起始列到结束列的所有数据，包括中间的所有列
                                    </p>
                                </div>
                                
                                <!-- 
                                    ==================== 倍率设置 ====================
                                    提供固定倍率和倍率列两种方式，用于调整数据计算结果
                                    使用复选框切换两种模式，满足不同数据格式需求
                                -->
                                <div class="border-t pt-3">
                                    <label class="block text-sm font-bold text-gray-800 mb-2">倍率设置</label>
                                    <div class="space-y-3">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" id="useMultiplierColumn" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                            <label for="useMultiplierColumn" class="text-base font-medium text-gray-700">使用倍率列</label>
                                        </div>
                                        
                                        <!-- 固定倍率选项 -->
                                        <div id="multiplierOptions" class="space-y-2">
                                            <label class="block text-sm font-semibold text-gray-700">固定倍率值</label>
                                            <input type="number" id="multiplier" value="1.0" step="0.01" min="0.01" 
                                                   class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-base" aria-label="固定倍率值" title="输入固定倍率值，所有计算结果将乘以该倍率后展示">
                                            <p class="text-xs text-gray-500">所有计算结果将乘以该倍率后展示</p>
                                        </div>
                                        
                                        <!-- 倍率列选项 -->
                                        <div id="multiplierColumnOption" class="hidden space-y-2">
                                            <label for="multiplierColumn" class="block text-base font-bold text-gray-800">倍率列</label>
                                            <select id="multiplierColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="倍率列" title="选择倍率列">
                                                <option value="">-- 请选择倍率列 --</option>
                                            </select>
                                            <p class="text-xs text-gray-500">计算结果将乘以该列对应的数值</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== 高级设置 ====================
                            提供跨日期结构数据和追加模式等高级选项
                            使用靛蓝色主题和步骤标记，满足特殊数据处理需求
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="advanced">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-sliders mr-2 text-primary"></i>高级设置
                                    <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">步骤5</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="advanced-panel">
                                <!-- 跨日期结构数据选项 -->
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="crossDateStructure" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="ml-1 text-sm font-medium text-gray-700">跨日期结构数据</span>
                                    </label>
                                    <p class="text-sm text-gray-500 mt-1">启用后，将根据日期列中相同日期对应的单元格数量判断时间间隔</p>
                                </div>
                                
                                <!-- 追加模式选项 -->
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="appendMode" class="form-checkbox text-primary rounded focus:ring-2 focus:ring-primary">
                                        <span class="ml-1 text-sm font-medium text-gray-700">追加模式（保留已导入的数据）</span>
                                    </label>
                                    <p class="text-sm text-gray-500 mt-1">启用后，新导入的数据将追加到现有数据中，不会清除之前的数据</p>
                                </div>
                            </div>
                        </div>
                        

                        
                        
                        
                        <!-- 
                            ==================== 筛选配置 ====================
                            提供计量点编号筛选和高级筛选项设置功能
                            使用红色主题和步骤标记，满足数据筛选需求
                        -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="filter">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-filter mr-2 text-primary"></i>筛选配置
                                    <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">步骤6</span>
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 text-sm transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-4 space-y-3 panel-content" id="filter-panel">
                                <!-- 筛选配置说明 -->
                                <div class="bg-red-50 p-2 rounded-lg">
                                    <p class="text-xs text-red-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        可选步骤：根据计量点编号或其他条件筛选数据，如果不需要筛选可跳过
                                    </p>
                                </div>
                                
                                <!-- 计量点编号所在列选择 -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="meteringPointColumn" class="block text-sm font-semibold text-gray-800">
                                            计量点编号所在列
                                            <span class="text-xs text-gray-600 ml-1">(可选)</span>
                                        </label>
                                        <input type="button" id="clearMeteringPointColumn" value="×" class="w-6 h-6 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all-300 cursor-pointer flex items-center justify-center" aria-label="清除计量点列选择" title="清除计量点列选择">
                                    </div>
                                    <select id="meteringPointColumn" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="计量点列" title="选择计量点列">
                                        <option value="">-- 请选择计量点列 --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">选择包含计量点编号信息的列，用于按计量点筛选数据</p>
                                </div>
                                
                                <!-- 计量点编号筛选 -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="meteringPointFilter" class="block text-sm font-semibold text-gray-800">
                                            计量点编号筛选
                                            <span class="text-xs text-gray-600 ml-1">(可选)</span>
                                        </label>
                                        <input type="button" id="clearMeteringPointFilter" value="×" class="w-6 h-6 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all-300 cursor-pointer flex items-center justify-center" aria-label="清除计量点筛选" title="清除计量点筛选">
                                    </div>
                                    <select id="meteringPointFilter" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="计量点筛选" title="选择计量点筛选">
                                        <option value="">-- 全部计量点 --</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">选择要处理的计量点编号，仅处理与所选计量点编号匹配的数据</p>
                                </div>
                                
                                <!-- 高级筛选项设置 -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="block text-sm font-semibold text-gray-800">高级筛选项设置</label>
                                        <input type="button" id="clearAllFilters" value="×" class="w-6 h-6 text-xs bg-gray-200 text-gray-600 rounded-full hover:bg-gray-300 transition-all-300 cursor-pointer flex items-center justify-center" aria-label="清除所有筛选项" title="清除所有筛选项">
                                    </div>
                                    <div class="flex items-center space-x-2 mb-2">
                                        <label for="filterCount" class="text-xs font-medium text-gray-600">筛选项数量：</label>
                                        <input type="number" id="filterCount" value="1" min="1" max="5" class="w-16 px-3 py-2 border border-gray-200 rounded-lg text-xs bg-white" aria-label="筛选项数量" title="筛选项数量">
                                        <input type="button" id="applyFilterCount" value="✓" class="w-6 h-6 text-xs bg-primary text-white rounded-full hover:bg-primary/90 cursor-pointer flex items-center justify-center" aria-label="应用筛选项数量" title="应用筛选项数量">
                                    </div>
                                    <div id="filterOptionsContainer" class="space-y-2">
                                        <!-- 筛选项将动态生成 -->
                                    </div>
                                </div>
                                
                                <!-- 完成提示 -->
                                <div class="bg-green-50 p-2 rounded-lg">
                                    <p class="text-xs text-green-700">
                                        <i class="fa fa-check-circle mr-1"></i>
                                        完成以上步骤后，点击"下一步：可视化"按钮开始数据分析和可视化
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== 右侧配置 ====================
                        包含数据索引范围、处理配置和数据预览等配置选项
                        使用可折叠面板组织配置项，提高界面整洁度
                    -->
                    <div>
                        <div class="bg-white rounded-xl border border-gray-100 shadow-md hover:shadow-lg transition-all-300">
                            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="settings">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-cog mr-2 text-primary"></i>处理设置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="settings-panel">

                                
                                <!-- 
                                    ==================== 数据索引范围 ====================
                                    设置数据的起始和结束日期，用于限定分析范围
                                    使用蓝色提示框说明功能，提供清除选择按钮
                                -->
                                <div class="border-t pt-4">
                                    <div class="bg-white rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-all-300">
                                        <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="dataIndexRange">
                                            <h4 class="text-sm font-semibold text-gray-800 flex items-center">
                                            <i class="fa fa-calendar mr-2 text-teal-600"></i>数据索引范围
                                        </h4>
                                            <i class="fa fa-chevron-down text-gray-500 text-xs transform transition-transform duration-200"></i>
                                        </div>
                                        <div class="p-4 space-y-3 panel-content" id="dataIndexRange-panel">
                                            <div class="grid grid-cols-2 gap-3">
                                                <!-- 起始日期选择 -->
                                                <div>
                                                    <label for="dataStartDate" class="block text-sm font-semibold text-gray-700 mb-1">
                                                        起始日期
                                                        <span class="text-sm text-gray-600 ml-1">(从哪天开始)</span>
                                                    </label>
                                                    <select id="dataStartDate" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm bg-white" aria-label="数据开始日期" title="选择数据开始日期">
                                                        <option value="">-- 请选择起始日期 --</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">选择数据的起始日期</p>
                                                </div>
                                                
                                                <!-- 结束日期选择 -->
                                                <div>
                                                    <label for="dataEndDate" class="block text-sm font-semibold text-gray-700 mb-1">
                                                        结束日期
                                                        <span class="text-sm text-gray-600 ml-1">(到哪天结束)</span>
                                                    </label>
                                                    <select id="dataEndDate" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm bg-white" aria-label="数据结束日期" title="选择数据结束日期">
                                                        <option value="">-- 请选择结束日期 --</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-1">选择数据的结束日期</p>
                                                </div>
                                            </div>
                                            
                                            <!-- 功能提示 -->
                                            <div class="bg-blue-50 p-2 rounded-lg">
                                                <p class="text-xs text-blue-700">
                                                    <i class="fa fa-lightbulb mr-1"></i>
                                                    提示：选择起始和结束日期后，系统将自动根据这两个日期所确定的行范围进行索引定位。如果选择为空，将分析所有数据
                                                </p>
                                            </div>
                                            
                                            <!-- 清除选择按钮 -->
                                            <button id="clearDateSelection" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-300 transition-all-300 mt-2" aria-label="清除日期选择" title="清除日期选择">
                                                <i class="fa fa-times mr-1"></i>清除选择
                                            </button>
                                        </div>
                                    </div>
                                </div>
                        
                        <!-- 
                            ==================== 处理配置 ====================
                            设置无效数据处理方式和时间间隔参数
                            使用灰色背景面板区分于其他配置项
                        -->
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl cursor-pointer flex items-center justify-between toggle-panel" data-panel="config">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-cogs mr-2 text-primary"></i>处理配置
                                </h3>
                                <i class="fa fa-chevron-down text-gray-500 transform transition-transform duration-200"></i>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="config-panel">
                                <!-- 无效数据处理方式 -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">无效数据处理方式</label>
                                    <select id="invalidDataHandling" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="无效数据处理方式" title="选择无效数据处理方式">
                                        <option value="ignore">忽略该点</option>
                                        <option value="fill">用相邻有效数据填充</option>
                                    </select>
                                </div>
                                
                                <!-- 时间间隔设置 -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">时间间隔（分钟）</label>
                                    <select id="timeInterval" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white text-sm" aria-label="时间间隔" title="选择时间间隔">
                                        <option value="1">1分钟</option>
                                        <option value="5">5分钟</option>
                                        <option value="15" selected="">15分钟</option>
                                        <option value="30">30分钟</option>
                                        <option value="60">60分钟</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 
                            ==================== 数据预览 ====================
                            显示配置后的数据预览和计算过程预览
                            提供第一个小时和第一天计算过程预览按钮
                        -->
                        <div class="bg-gray-50 rounded-xl border border-gray-200">
                            <div class="bg-gray-100 px-5 py-3 rounded-t-xl flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                                    <i class="fa fa-eye mr-2 text-primary"></i>数据预览
                                </h3>
                            </div>
                            <div class="p-5 space-y-4 panel-content" id="preview-panel">
                                <!-- 数据预览区域 -->
                                <div id="dataPreview" class="border border-gray-200 rounded-lg shadow-sm bg-white min-h-32 overflow-hidden">
                                    <p class="text-gray-500 text-center py-12 text-sm">请先完成数据配置，将显示数据预览</p>
                                </div>
                                
                                <!-- 计算过程预览按钮 -->
                                <div class="space-y-2">
                                    <button id="previewFirstHourCalculation" class="w-full bg-secondary text-white px-4 py-2.5 rounded-lg hover:bg-secondary/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled aria-label="预览第一个小时计算过程" title="预览第一个小时计算过程">
                                        <i class="fa fa-calculator mr-2"></i>预览第一个小时计算过程
                                    </button>
                                    <button id="previewFirstDayCalculation" class="w-full bg-accent text-white px-4 py-2.5 rounded-lg hover:bg-accent/90 transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled aria-label="预览第一天计算过程" title="预览第一天计算过程">
                                        <i class="fa fa-calendar-day mr-2"></i>预览第一天计算过程
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                




            </div>
        </section>

        <!-- 
            ==================== 第三部分：可视化 ====================
            提供负荷曲线可视化功能，包括日期范围筛选和时段聚焦
            使用响应式网格布局，适应不同屏幕尺寸
        -->
        <section id="visualizationSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-6 md:p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all-300">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
                    <i class="fa fa-bar-chart text-primary mr-3 text-2xl"></i>负荷曲线可视化
                </h2>
                
                <!-- 
                    ==================== 现代化设置面板区域 ====================
                    重新设计的设置面板，使用渐变色主题和现代化UI
                    提供日期范围筛选、时段聚焦、曲线样式设置、计量点编号筛选
                -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- 
                        ==================== 日期范围筛选 ====================
                        蓝色主题的日期范围筛选面板，现代化设计
                    -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl shadow-xl border border-blue-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-calendar-alt text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-blue-900">日期范围筛选</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="startDate" class="block text-sm font-semibold text-blue-800 mb-2">开始日期</label>
                                <select id="startDate" 
                                        class="w-full px-4 py-3 border border-blue-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="开始日期" title="选择开始日期">
                                    <option value="">-- 请选择起始日期 --</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="endDate" class="block text-sm font-semibold text-blue-800 mb-2">结束日期</label>
                                <select id="endDate" 
                                        class="w-full px-4 py-3 border border-blue-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="结束日期" title="选择结束日期">
                                    <option value="">-- 请选择结束日期 --</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="applyDateFilter" 
                                        class="bg-blue-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="应用日期筛选" title="应用日期筛选">
                                    <i class="fas fa-check"></i>
                                    <span class="text-sm font-medium">应用</span>
                                </button>
                                <button id="selectAllDates" 
                                        class="bg-gray-500 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-gray-600 active:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="全选日期" title="全选日期">
                                    <i class="fas fa-check-square"></i>
                                    <span class="text-sm font-medium">全选</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== 时段聚焦 ====================
                        紫色主题的时段聚焦面板，现代化设计
                    -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl shadow-xl border border-purple-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-clock text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-purple-900">时段聚焦</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="focusStartTime" class="block text-sm font-semibold text-purple-800 mb-2">开始时间</label>
                                <select id="focusStartTime" 
                                        class="w-full px-4 py-3 border border-purple-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="开始时间" title="选择开始时间">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6">06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="focusEndTime" class="block text-sm font-semibold text-purple-800 mb-2">结束时间</label>
                                <select id="focusEndTime" 
                                        class="w-full px-4 py-3 border border-purple-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="结束时间" title="选择结束时间">
                                    <option value="0">00:00</option>
                                    <option value="1">01:00</option>
                                    <option value="2">02:00</option>
                                    <option value="3">03:00</option>
                                    <option value="4">04:00</option>
                                    <option value="5">05:00</option>
                                    <option value="6">06:00</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23" selected="">23:00</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button id="applyTimeFocus" 
                                        class="bg-purple-600 text-white font-bold py-2.5 px-3 rounded-xl hover:bg-purple-700 active:bg-purple-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-1" 
                                        aria-label="应用时间段" title="应用时间段">
                                    <i class="fas fa-check"></i>
                                    <span class="text-xs">应用</span>
                                </button>
                                <button id="resetTimeFocus" 
                                        class="bg-gray-500 text-white font-bold py-2.5 px-3 rounded-xl hover:bg-gray-600 active:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-1" 
                                        aria-label="重置为全天" title="重置为全天">
                                    <i class="fas fa-refresh"></i>
                                    <span class="text-xs">全天</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== 曲线样式设置 ====================
                        绿色主题的曲线样式设置面板，现代化设计
                    -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-xl border border-green-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-palette text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-green-900">曲线样式设置</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="lineStyle" class="block text-xs font-semibold text-green-800 mb-1">线条样式</label>
                                    <select id="lineStyle" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="线条样式" title="选择线条样式">
                                        <option value="solid">实线</option>
                                        <option value="dashed">虚线</option>
                                        <option value="dotted">点线</option>
                                        <option value="dashdot">点划线</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="showPoints" class="block text-xs font-semibold text-green-800 mb-1">数据点</label>
                                    <select id="showPoints" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="显示数据点" title="选择是否显示数据点">
                                        <option value="true">显示</option>
                                        <option value="false">隐藏</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="smoothCurve" class="block text-xs font-semibold text-green-800 mb-1">平滑曲线</label>
                                    <select id="smoothCurve" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="平滑曲线" title="选择是否平滑曲线">
                                        <option value="false">关闭</option>
                                        <option value="true" selected>开启</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="curveTension" class="block text-xs font-semibold text-green-800 mb-1">平滑度</label>
                                    <select id="curveTension" 
                                            class="w-full px-3 py-2.5 border border-green-300 rounded-xl text-xs font-medium text-gray-700 focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" 
                                            aria-label="曲线张力" title="选择曲线张力">
                                        <option value="0.1">低</option>
                                        <option value="0.2" selected>中</option>
                                        <option value="0.4">高</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-green-200/50 rounded-xl p-3">
                                <label for="secondaryAxis" class="inline-flex items-center text-xs font-semibold text-green-800 cursor-pointer">
                                    <input type="checkbox" id="secondaryAxis" 
                                           class="form-checkbox text-green-600 rounded-lg w-4 h-4 focus:ring-2 focus:ring-green-500 mr-2 transition-all duration-200">
                                    <span>辅助Y轴(kW)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 
                        ==================== 计量点编号筛选 ====================
                        橙色主题的计量点筛选面板，现代化设计
                    -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl shadow-xl border border-orange-200 hover:shadow-2xl transition-all duration-300 p-6">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center mr-3">
                                <i class="fas fa-filter text-white text-lg"></i>
                            </div>
                            <label class="text-lg font-bold text-orange-900">计量点编号筛选</label>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="visualizationMeteringPointFilter" class="block text-sm font-semibold text-orange-800 mb-2">选择计量点</label>
                                <select id="visualizationMeteringPointFilter" 
                                        class="w-full px-4 py-3 border border-orange-300 rounded-xl text-sm font-medium text-gray-700 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white shadow-sm transition-all duration-200" 
                                        aria-label="计量点筛选" title="选择计量点筛选">
                                    <option value="">-- 全部计量点 --</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="applyMeteringPointFilter" 
                                        class="bg-orange-600 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-orange-700 active:bg-orange-800 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="应用计量点筛选" title="应用计量点筛选">
                                    <i class="fas fa-check"></i>
                                    <span class="font-medium">应用</span>
                                </button>
                                <button id="selectAllMeteringPoints" 
                                        class="bg-gray-500 text-white font-bold py-2.5 px-6 rounded-xl hover:bg-gray-600 active:bg-gray-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2" 
                                        aria-label="全选计量点" title="全选计量点">
                                    <i class="fas fa-check-square"></i>
                                    <span class="font-medium">全选</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 图表区域 -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-chart-line text-primary mr-3"></i>
                            24小时负荷曲线
                        </h3>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center text-sm font-medium text-gray-700">
                                <input type="checkbox" id="toggleCurveLegend" class="form-checkbox text-blue-600 mr-2 rounded">
                                显示图例
                            </label>

                            <button id="toggleSummaryMode" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 active:bg-indigo-800 transition-all">
                                汇总曲线
                            </button>
                        </div>
                    </div>
                    
                    <!-- 重新设计的24小时负荷曲线图表容器 -->
                    <div class="relative h-[500px] md:h-[600px] lg:h-[700px] bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden" id="chartContainer">
                        <canvas id="loadCurveChart" class="w-full h-full rounded-2xl cursor-crosshair"></canvas>
                        
                        <!-- 图例容器 -->
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm rounded-lg p-3 shadow-lg border border-gray-200" id="curveLegendContainer" style="display: none;">
                        </div>
                        
                        <!-- 加载状态 -->
                        <div id="chartLoading" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-circle-notch fa-spin text-4xl text-primary mb-4"></i>
                                <p class="text-gray-600 font-medium">正在生成24小时负荷曲线...</p>
                            </div>
                        </div>
                        
                        <!-- 无数据提示 -->
                        <div id="noDataMessage" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-chart-line text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600 font-medium">暂无24小时负荷数据</p>
                                <p class="text-sm text-gray-500 mt-2">请检查数据导入和筛选条件</p>
                            </div>
                        </div>
                        
                        <!-- 24小时数据提示框 -->
                        <div id="chartTooltip" class="absolute bg-gray-900/95 backdrop-blur-sm text-white px-5 py-4 rounded-xl shadow-2xl text-sm hidden z-20 pointer-events-none border border-gray-600 max-w-xs">
                            <div class="font-bold text-lg mb-2" id="tooltipTitle"></div>
                            <div class="text-sm text-gray-200" id="tooltipValue"></div>
                            <div class="text-xs text-blue-300 mt-2" id="tooltipTime"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 日期总用电量柱状图区域 -->
                <div class="mb-8" id="dailyTotalBarChartSection">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-bar text-primary mr-3"></i>
                        日期总用电量柱状图
                        <div class="ml-4 flex items-center space-x-2" id="barChartAggregationControls">
                            <button id="barChartAggregationDailyBtn" class="px-3 py-1.5 text-sm rounded-lg bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 transition">按日</button>
                            <button id="barChartAggregationMonthlyBtn" class="px-3 py-1.5 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400 transition">按月</button>
                        </div>
                    </h3>
                    
                    <div class="relative h-[400px] md:h-[500px] lg:h-[500px] bg-white rounded-2xl border border-gray-200 shadow-lg overflow-hidden" id="dailyTotalBarChartContainer">
                        <canvas id="dailyTotalBarChart" class="w-full h-full rounded-2xl cursor-pointer"></canvas>
                        
                        <div id="barChartLoading" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-circle-notch fa-spin text-4xl text-primary mb-4"></i>
                                <p class="text-gray-600 font-medium">正在生成柱状图...</p>
                            </div>
                        </div>
                        
                        <div id="barChartNoDataMessage" class="absolute inset-0 bg-white/95 backdrop-blur-md flex items-center justify-center rounded-2xl hidden">
                            <div class="text-center">
                                <i class="fas fa-chart-bar text-4xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600 font-medium">暂无数据显示</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-line text-primary mr-3"></i>
                        统计信息
                    </h3>
                    
                    <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
                        <div class="mb-4">
                            <h4 class="text-lg font-bold text-gray-800 flex items-center">
                                <i class="fas fa-chart-bar text-primary mr-2"></i>
                                数据统计分析
                            </h4>
                        </div>
                        
                        <!-- 统一统计内容区域 -->
                        <div id="unifiedStats" class="bg-gray-50 rounded-lg p-4">
                            <div class="text-center py-8">
                                <i class="fas fa-chart-bar text-3xl text-gray-300 mb-3"></i>
                                <p class="text-gray-600">请先生成图表以查看详细统计信息</p>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </section>

        <!-- 
            ==================== 第四部分：导出 ====================
            提供数据处理结果的导出功能
            使用白色背景卡片和阴影效果增强视觉体验
        -->
        <section id="exportSection" class="mb-8 hidden">
            <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-100 hover:shadow-2xl transition-all-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-download text-primary mr-3"></i>
                    结果导出
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-image text-primary mr-2"></i>
                            图表导出
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <button id="exportPNG" class="flex-1 bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="导出为PNG" title="导出为PNG">
                                    <i class="fas fa-file-image mr-2"></i>导出为PNG
                                </button>
                                <select id="pngQuality" class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-28 bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="PNG质量" title="选择PNG质量">
                                    <option value="0.7">质量: 70%</option>
                                    <option value="0.8">质量: 80%</option>
                                    <option value="0.9" selected="">质量: 90%</option>
                                    <option value="1.0">质量: 100%</option>
                                </select>
                            </div>
                            <button id="exportJPG" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="导出为JPG" title="导出为JPG">
                                <i class="fas fa-file-image mr-2"></i>导出为JPG
                            </button>
                            <button id="exportSVG" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="导出为SVG" title="导出为SVG">
                                <i class="fas fa-file-image mr-2"></i>导出为SVG
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-table text-primary mr-2"></i>
                            数据导出
                        </h3>
                        <div class="space-y-4">
                            <button id="exportHourlyData" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="导出24小时电能明细" title="导出24小时电能明细">
                                <i class="fas fa-file-excel mr-2"></i>导出24小时电能明细
                            </button>
                            <button id="exportDailyStats" class="w-full bg-primary text-white px-4 py-3 rounded-lg hover:bg-primary/90 transition-all-300 flex items-center justify-center font-medium" aria-label="导出日统计数据" title="导出日统计数据">
                                <i class="fas fa-file-excel mr-2"></i>导出日统计数据
                            </button>
                            <button id="exportPVsystData" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-600/90 transition-all-300 flex items-center justify-center font-medium" aria-label="导出PVsyst月度重排数据" title="导出PVsyst月度重排数据">
                        <i class="fas fa-solar-panel mr-2"></i>导出PVsyst月度重排数据
                    </button>
                    <div class="text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded">
                        <i class="fa fa-info-circle mr-1"></i>
                        PVsyst月度重排8760小时数据：CSV文件，按月份从1月到12月重新排列，去除年份影响，缺失数据自动补全，格式DD/MM/YY hh:mm
                    </div>
                            <div class="mt-2">
                                <label for="exportFormat" class="block text-sm font-semibold text-gray-700 mb-2">导出格式</label>
                                <select id="exportFormat" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="导出格式" title="选择导出格式">
                                    <option value="xlsx">Excel (.xlsx)</option>
                                    <option value="csv">CSV (.csv)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-8 mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-cog text-primary mr-2"></i>
                        导出设置
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="exportFileName" class="block text-sm font-semibold text-gray-700 mb-2">文件名前缀</label>
                            <input type="text" id="exportFileName" value="负荷曲线数据" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="导出文件名" title="导出文件名" placeholder="请输入导出文件名">
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="includeTimestamp" class="inline-flex items-center text-sm">
                                <input type="checkbox" id="includeTimestamp" class="form-checkbox text-primary rounded" checked="">
                                <span class="ml-2 font-medium text-gray-700">文件名包含时间戳</span>
                            </label>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <label for="includeFiltersInName" class="inline-flex items-center text-sm">
                                <input type="checkbox" id="includeFiltersInName" class="form-checkbox text-primary rounded">
                                <span class="ml-2 font-medium text-gray-700">包含筛选条件</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 日期范围选择器 -->
                    <div class="mt-6 bg-gray-50 rounded-xl p-6 border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-calendar-range text-primary mr-2"></i>
                            24小时数据导出日期范围
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="exportStartDate" class="block text-sm font-semibold text-gray-700 mb-2">开始日期</label>
                                <input type="date" id="exportStartDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="导出开始日期" title="导出开始日期">
                            </div>
                            <div>
                                <label for="exportEndDate" class="block text-sm font-semibold text-gray-700 mb-2">结束日期</label>
                                <input type="date" id="exportEndDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-primary/50 focus:border-primary" aria-label="导出结束日期" title="导出结束日期">
                            </div>
                            <div>
                                <label for="exportAllDates" class="inline-flex items-center text-sm mt-8">
                                    <input type="checkbox" id="exportAllDates" class="form-checkbox text-primary rounded" checked="">
                                    <span class="ml-2 font-medium text-gray-700">导出所有日期</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </section>
    </main>

    <!-- 通知组件 -->
    <div id="notification" class="fixed bottom-4 right-4 px-4 py-3 rounded shadow-lg transform translate-y-20 opacity-0 transition-all-300 flex items-center max-w-sm hidden">
        <i id="notificationIcon" class="mr-2 text-xl"></i>
        <div>
            <h3 id="notificationTitle" class="font-medium"></h3>
            <p id="notificationMessage" class="text-sm text-gray-600"></p>
        </div>
        <button id="closeNotification" class="ml-4 text-gray-400 hover:text-gray-600" aria-label="关闭通知" title="关闭通知">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- 模态框 -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div id="modal" class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-semibold"></h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600" aria-label="关闭模态框" title="关闭模态框">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="p-5">
                <!-- 模态框内容将通过JS填充 -->
            </div>
        </div>
    </div>

    <!-- 第一个小时计算过程预览模态框 -->
    <div id="firstHourCalculationModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">第一个小时计算过程预览</h3>
                <button id="closeFirstHourCalculationModal" class="text-gray-400 hover:text-gray-600" aria-label="关闭第一个小时计算预览" title="关闭第一个小时计算预览">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">基本信息</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-neutral">日期：</span>
                            <span id="previewDate" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">时间间隔：</span>
                            <span id="previewInterval" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">数据类型：</span>
                            <span id="previewDataType" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">倍率：</span>
                            <span id="previewMultiplier" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">原始数据（第一个小时）</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewRawData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">清洗后数据</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewCleanedData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">计算过程</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50">
                        <div id="previewCalculationProcess" class="text-sm">-</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">计算结果</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border border-gray-200 rounded p-3 bg-primary/5">
                            <div class="text-neutral text-sm">第一个小时电能值</div>
                            <div id="previewResult" class="text-xl font-bold text-primary">-</div>
                        </div>
                        <div class="border border-gray-200 rounded p-3 bg-secondary/5">
                            <div class="text-neutral text-sm">计算公式</div>
                            <div id="previewFormula" class="text-sm font-medium text-secondary">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第一天计算过程预览模态框 -->
    <div id="firstDayCalculationModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">第一天计算过程预览</h3>
                <button id="closeFirstDayCalculationModal" class="text-gray-400 hover:text-gray-600" aria-label="关闭第一天计算预览" title="关闭第一天计算预览">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="mb-4">
                    <h4 class="font-medium mb-2">基本信息</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-neutral">日期：</span>
                            <span id="previewFirstDayDate" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">时间间隔：</span>
                            <span id="previewFirstDayInterval" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">数据类型：</span>
                            <span id="previewFirstDayDataType" class="font-medium">-</span>
                        </div>
                        <div>
                            <span class="text-neutral">倍率：</span>
                            <span id="previewFirstDayMultiplier" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">原始数据（第一天）</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewFirstDayRawData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">清洗后数据</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50 max-h-40 overflow-y-auto">
                        <pre id="previewFirstDayCleanedData" class="text-xs whitespace-pre-wrap">-</pre>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">计算过程</h4>
                    <div class="border border-gray-200 rounded p-3 bg-gray-50">
                        <div id="previewFirstDayCalculationProcess" class="text-sm">-</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-medium mb-2">计算结果</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="border border-gray-200 rounded p-3 bg-primary/5">
                            <div class="text-neutral text-sm">第一天总电能值</div>
                            <div id="previewFirstDayResult" class="text-xl font-bold text-primary">-</div>
                        </div>
                        <div class="border border-gray-200 rounded p-3 bg-secondary/5">
                            <div class="text-neutral text-sm">计算公式</div>
                            <div id="previewFirstDayFormula" class="text-sm font-medium text-secondary">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史记录详情模态框 -->
    <div id="historyDetailModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all-300 scale-95 opacity-0">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">导入历史详情</h3>
                <button id="closeHistoryDetailModal" class="text-gray-400 hover:text-gray-600" aria-label="关闭导入历史详情" title="关闭导入历史详情">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="historyDetailContent" class="p-5">
                <!-- 历史记录详情将通过JS填充 -->
            </div>
        </div>
    </div>

    <!-- 时段统计对比表格 - 固定UI大小版本 -->
    <div id="timeSlotComparisonWindow" class="hidden">
        <div class="bg-white rounded-lg shadow-xl border border-gray-200 w-full max-w-4xl mx-auto">
            <!-- 标题栏 -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 rounded-t-lg flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">时段统计对比</h3>
                <button id="closeTimeSlotComparison" class="text-gray-500 hover:text-gray-700" title="关闭" aria-label="关闭时间段比较">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <!-- 内容区域 -->
            <div id="timeSlotComparisonContent" class="p-6">
                <!-- 时段选择 -->
                <div class="mb-6 grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">开始时段</label>
                        <select id="timeSlotStart" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="开始时段">
                            <option value="0">00:00</option>
                            <option value="1">01:00</option>
                            <option value="2">02:00</option>
                            <option value="3">03:00</option>
                            <option value="4">04:00</option>
                            <option value="5">05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23">23:00</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">结束时段</label>
                        <select id="timeSlotEnd" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" aria-label="结束时段">
                            <option value="0">00:00</option>
                            <option value="1">01:00</option>
                            <option value="2">02:00</option>
                            <option value="3">03:00</option>
                            <option value="4">04:00</option>
                            <option value="5">05:00</option>
                            <option value="6">06:00</option>
                            <option value="7">07:00</option>
                            <option value="8">08:00</option>
                            <option value="9">09:00</option>
                            <option value="10">10:00</option>
                            <option value="11">11:00</option>
                            <option value="12">12:00</option>
                            <option value="13">13:00</option>
                            <option value="14">14:00</option>
                            <option value="15">15:00</option>
                            <option value="16">16:00</option>
                            <option value="17">17:00</option>
                            <option value="18">18:00</option>
                            <option value="19">19:00</option>
                            <option value="20">20:00</option>
                            <option value="21">21:00</option>
                            <option value="22">22:00</option>
                            <option value="23" selected>23:00</option>
                        </select>
                    </div>
                </div>

                <!-- 统计表格 -->
                <div class="bg-gray-50 rounded-lg p-4 max-h-80 overflow-y-auto text-sm">
                    <table class="w-full border-collapse whitespace-nowrap text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 p-2 text-center font-medium">日期</th>
                                <th class="border border-gray-200 p-2 text-center font-medium">时段用电量 (kWh)</th>
                                <th class="border border-gray-200 p-2 text-center font-medium">全天百分比</th>
                                <th class="border border-gray-200 p-2 text-center font-medium">对比</th>
                            </tr>
                        </thead>
                        <tbody id="timeSlotComparisonTableBody">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>

                <!-- 统计汇总 -->
                <div id="timeSlotSummary" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="text-base font-semibold text-blue-900 mb-4">📊 时段统计汇总</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-blue-700 font-medium text-xs uppercase tracking-wide">平均用电量</div>
                            <div id="timeSlotAvg" class="text-xl font-bold text-blue-900 mt-1">-</div>
                        </div>
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-green-700 font-medium text-xs uppercase tracking-wide">最大用电量</div>
                            <div id="timeSlotMax" class="text-xl font-bold text-green-900 mt-1">-</div>
                        </div>
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-orange-700 font-medium text-xs uppercase tracking-wide">最小用电量</div>
                            <div id="timeSlotMin" class="text-xl font-bold text-orange-900 mt-1">-</div>
                        </div>
                        <div class="bg-white p-3 rounded-md border border-blue-100">
                            <div class="text-purple-700 font-medium text-xs uppercase tracking-wide">总用电量</div>
                            <div id="timeSlotTotal" class="text-xl font-bold text-purple-900 mt-1">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局数据存储
        const appData = {
            files: [],
            worksheets: [],
            parsedData: [],
            processedData: [],
            config: {
                dataType: 'instantPower',
                multiplier: 1.0,
                useMultiplierColumn: false,
                multiplierColumn: '',
                dateColumn: '',
                useDateRange: false,
                dataStartColumn: '',
                dataEndColumn: '',
                dataStartIndex: 0,
                dataEndIndex: -1,
                meteringPointColumn: '',
                meteringPointFilter: '',
                dateFormat: 'YYYY-MM-DD',
                invalidDataHandling: 'ignore',
                timeInterval: 15,
                filterCount: 1,
                additionalFilters: []
            },
            visualization: {
        selectedDates: [],
        selectedMeteringPoints: [],
        focusStartTime: 0,
        focusEndTime: 23,
        lineStyle: 'solid',
        showPoints: false,
        secondaryAxis: false,
        smoothCurve: true,
        curveTension: 0.2,
        showDailyTotalBarChart: true,
        barChartAggregation: 'daily' // 'daily' or 'monthly'
    },
            // 日期选择相关
            dateSelectionMode: null, // 'start', 'end', or null
            selectedStartDate: null, // YYYY-MM-DD格式
            selectedEndDate: null,   // YYYY-MM-DD格式
            chart: null,
            dailyTotalBarChart: null, // 存储日期总用电量图表引用
            meteringPoints: [], // 存储所有计量点编号
            importHistory: [], // 存储导入历史记录
            // 内存管理配置
            memoryManagement: {
                maxDataRows: 100000, // 单个文件最大行数限制
                maxTotalMemoryMB: 200, // 总内存使用限制（MB）
                currentMemoryUsageMB: 0, // 当前内存使用量估算
                enableGarbageCollection: true // 是否启用垃圾回收优化
            }
        };

        // DOM 元素
        const elements = {
            // 步骤指示器

            
            // 导入部分
            dropArea: document.getElementById('dropArea'),
            fileInput: document.getElementById('fileInput'),
            fileList: document.getElementById('fileList'),
            importedFiles: document.getElementById('importedFiles'),
            removeAllFiles: document.getElementById('removeAllFiles'),

            uploadProgress: document.getElementById('uploadProgress'),
            uploadProgressBar: document.getElementById('progressBar'),
        uploadProgressText: document.getElementById('progressText'),
            importStatus: document.getElementById('importStatus'),
            fileListContent: document.getElementById('fileListContent'),
            historyList: document.getElementById('historyList'),
            
            // 配置部分
            dataTypeRadios: document.querySelectorAll('input[name="dataType"]'),
            multiplierInput: document.getElementById('multiplier'),
            useMultiplierColumnCheckbox: document.getElementById('useMultiplierColumn'),
            multiplierOptions: document.getElementById('multiplierOptions'),
            multiplierColumnOption: document.getElementById('multiplierColumnOption'),
            multiplierColumnSelect: document.getElementById('multiplierColumn'),

            dataStartDate: document.getElementById('dataStartDate'),
            dataEndDate: document.getElementById('dataEndDate'),
            clearDateSelectionBtn: document.getElementById('clearDateSelection'),
            dateColumnSelect: document.getElementById('dateColumn'),
            dataStartColumnSelect: document.getElementById('dataStartColumn'),
            dataEndColumnSelect: document.getElementById('dataEndColumn'),
            meteringPointColumnSelect: document.getElementById('meteringPointColumn'),
            meteringPointFilterSelect: document.getElementById('meteringPointFilter'),

            invalidDataHandlingSelect: document.getElementById('invalidDataHandling'),
            timeIntervalSelect: document.getElementById('timeInterval'),
            dataPreview: document.getElementById('dataPreview'),
            previewFirstHourCalculationBtn: document.getElementById('previewFirstHourCalculation'),
            firstHourCalculationModal: document.getElementById('firstHourCalculationModal'),
            closeFirstHourCalculationModalBtn: document.getElementById('closeFirstHourCalculationModal'),
            previewFirstDayCalculationBtn: document.getElementById('previewFirstDayCalculation'),
            previewDate: document.getElementById('previewDate'),
            previewInterval: document.getElementById('previewInterval'),
            previewDataType: document.getElementById('previewDataType'),
            previewMultiplier: document.getElementById('previewMultiplier'),
            previewRawData: document.getElementById('previewRawData'),
            previewCleanedData: document.getElementById('previewCleanedData'),
            previewCalculationProcess: document.getElementById('previewCalculationProcess'),
            previewResult: document.getElementById('previewResult'),
            previewFormula: document.getElementById('previewFormula'),
            
            // 第一天计算过程相关
            firstDayCalculationModal: document.getElementById('firstDayCalculationModal'),
            closeFirstDayCalculationModalBtn: document.getElementById('closeFirstDayCalculationModal'),
            previewFirstDayDate: document.getElementById('previewFirstDayDate'),
            previewFirstDayInterval: document.getElementById('previewFirstDayInterval'),
            previewFirstDayDataType: document.getElementById('previewFirstDayDataType'),
            previewFirstDayMultiplier: document.getElementById('previewFirstDayMultiplier'),
            previewFirstDayRawData: document.getElementById('previewFirstDayRawData'),
            previewFirstDayCleanedData: document.getElementById('previewFirstDayCleanedData'),
            previewFirstDayCalculationProcess: document.getElementById('previewFirstDayCalculationProcess'),
            previewFirstDayResult: document.getElementById('previewFirstDayResult'),
            previewFirstDayFormula: document.getElementById('previewFirstDayFormula'),

            
            // 可视化部分
            startDateInput: document.getElementById('startDate'),
            endDateInput: document.getElementById('endDate'),
            applyDateFilterBtn: document.getElementById('applyDateFilter'),
            selectAllDatesBtn: document.getElementById('selectAllDates'),

            focusStartTimeSelect: document.getElementById('focusStartTime'),
            focusEndTimeSelect: document.getElementById('focusEndTime'),
            applyTimeFocusBtn: document.getElementById('applyTimeFocus'),
            resetTimeFocusBtn: document.getElementById('resetTimeFocus'),
            visualizationMeteringPointFilterSelect: document.getElementById('visualizationMeteringPointFilter'),
            applyMeteringPointFilterBtn: document.getElementById('applyMeteringPointFilter'),
            selectAllMeteringPointsBtn: document.getElementById('selectAllMeteringPoints'),
            lineStyleSelect: document.getElementById('lineStyle'),
            showPointsSelect: document.getElementById('showPoints'),
            smoothCurveSelect: document.getElementById('smoothCurve'),
            curveTensionSelect: document.getElementById('curveTension'),
            secondaryAxisCheckbox: document.getElementById('secondaryAxis'),
            loadCurveChart: document.getElementById('loadCurveChart'),
            chartLoading: document.getElementById('chartLoading'),
            noDataMessage: document.getElementById('noDataMessage'),
            dailyStats: document.getElementById('dailyStats'),
            periodStats: document.getElementById('periodStats'),

            // 聚合切换按钮
            barChartAggregationDailyBtn: document.getElementById('barChartAggregationDailyBtn'),
            barChartAggregationMonthlyBtn: document.getElementById('barChartAggregationMonthlyBtn'),
            
            // 导出部分
            exportPNGBtn: document.getElementById('exportPNG'),
            pngQualitySelect: document.getElementById('pngQuality'),
            exportJPGBtn: document.getElementById('exportJPG'),
            exportSVGBtn: document.getElementById('exportSVG'),
            exportHourlyDataBtn: document.getElementById('exportHourlyData'),
            exportDailyStatsBtn: document.getElementById('exportDailyStats'),
            exportFormatSelect: document.getElementById('exportFormat'),
            exportFileNameInput: document.getElementById('exportFileName'),
            includeTimestampCheckbox: document.getElementById('includeTimestamp'),
            includeFiltersInNameCheckbox: document.getElementById('includeFiltersInName'),

            startOverBtn: document.getElementById('startOverBtn'),
            
            // 通知和模态框
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notificationIcon'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            closeNotificationBtn: document.getElementById('closeNotification'),
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModalBtn: document.getElementById('closeModal'),
            helpBtn: document.getElementById('helpBtn'),
            aboutBtn: document.getElementById('aboutBtn'),
            
            //  sections
            importSection: document.getElementById('importSection'),
            configSection: document.getElementById('configSection'),
            visualizationSection: document.getElementById('visualizationSection'),
            exportSection: document.getElementById('exportSection'),
            
            // 历史记录相关
            importHistory: document.getElementById('importHistory'),
            historyDetailModal: document.getElementById('historyDetailModal'),
            closeHistoryDetailModalBtn: document.getElementById('closeHistoryDetailModal'),
            historyDetailContent: document.getElementById('historyDetailContent'),
            filterCountInput: document.getElementById('filterCount'),
        applyFilterCountBtn: document.getElementById('applyFilterCount'),
        filterOptionsContainer: document.getElementById('filterOptionsContainer'),
        

        };

        // 初始化事件监听
        function initEventListeners() {
            // 导入部分
            elements.dropArea.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelection);
            elements.dropArea.addEventListener('dragover', handleDragOver);
            elements.dropArea.addEventListener('dragleave', handleDragLeave);
            elements.dropArea.addEventListener('drop', handleDrop);
            elements.removeAllFiles.addEventListener('click', removeAllFiles);

            
            // 配置部分
            elements.dataTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    appData.config.dataType = e.target.value;
                    if (appData.originalData) {
                        reprocessDataWithConfig();
                    } else {
                        updateDataPreview();
                    }
                });
            });
            
            elements.multiplierInput.addEventListener('change', (e) => {
                appData.config.multiplier = parseFloat(e.target.value) || 1.0;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            console.log('Chart实例创建完成:', !!appData.dailyTotalBarChart);
            console.log('=== 初始化柱状图结束 ===');
            
            elements.useMultiplierColumnCheckbox.addEventListener('change', (e) => {
                appData.config.useMultiplierColumn = e.target.checked;
                if (e.target.checked) {
                    if (elements.multiplierOptions && elements.multiplierOptions.parentNode) {
                        elements.multiplierOptions.classList.add('hidden');
                    }
                    if (elements.multiplierColumnOption && elements.multiplierColumnOption.parentNode) {
                        elements.multiplierColumnOption.classList.remove('hidden');
                    }
                } else {
                    if (elements.multiplierOptions && elements.multiplierOptions.parentNode) {
                        elements.multiplierOptions.classList.remove('hidden');
                    }
                    if (elements.multiplierColumnOption && elements.multiplierColumnOption.parentNode) {
                        elements.multiplierColumnOption.classList.add('hidden');
                    }
                }
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            // 柱状图聚合切换
            if (elements.barChartAggregationDailyBtn && elements.barChartAggregationMonthlyBtn) {
                const applyAggregationActive = () => {
                    const isMonthly = appData?.visualization?.barChartAggregation === 'monthly';
                    elements.barChartAggregationDailyBtn.classList.toggle('bg-blue-600', !isMonthly);
                    elements.barChartAggregationDailyBtn.classList.toggle('text-white', !isMonthly);
                    elements.barChartAggregationDailyBtn.classList.toggle('bg-gray-200', isMonthly);
                    elements.barChartAggregationDailyBtn.classList.toggle('text-gray-700', isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('bg-blue-600', isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('text-white', isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('bg-gray-200', !isMonthly);
                    elements.barChartAggregationMonthlyBtn.classList.toggle('text-gray-700', !isMonthly);
                };
                applyAggregationActive();
                
                elements.barChartAggregationDailyBtn.addEventListener('click', () => {
                    if (appData.visualization.barChartAggregation !== 'daily') {
                        appData.visualization.barChartAggregation = 'daily';
                        applyAggregationActive();
                        updateDailyTotalBarChart(getFilteredData());
                        showNotification('显示模式', '柱状图已切换为按日聚合', 'success');
                    }
                });
                elements.barChartAggregationMonthlyBtn.addEventListener('click', () => {
                    if (appData.visualization.barChartAggregation !== 'monthly') {
                        appData.visualization.barChartAggregation = 'monthly';
                        applyAggregationActive();
                        updateDailyTotalBarChart(getFilteredData());
                        showNotification('显示模式', '柱状图已切换为按月聚合', 'success');
                    }
                });
            }

            elements.multiplierColumnSelect.addEventListener('change', (e) => {
                appData.config.multiplierColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            elements.dateColumnSelect.addEventListener('change', (e) => {
                appData.config.dateColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
                checkConfigValidity();
            });
            
            elements.dataStartColumnSelect.addEventListener('change', (e) => {
                appData.config.dataStartColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
                checkConfigValidity();
            });
            
            elements.dataEndColumnSelect.addEventListener('change', (e) => {
                appData.config.dataEndColumn = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
                checkConfigValidity();
            });
            
            elements.meteringPointColumnSelect.addEventListener('change', (e) => {
                appData.config.meteringPointColumn = e.target.value;
                updateMeteringPointFilterOptions();
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            
            elements.meteringPointFilterSelect.addEventListener('change', (e) => {
                appData.config.meteringPointFilter = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                } else {
                    updateDataPreview();
                }
            });
            

            
            elements.invalidDataHandlingSelect.addEventListener('change', (e) => {
                appData.config.invalidDataHandling = e.target.value;
                if (appData.originalData) {
                    reprocessDataWithConfig();
                }
            });
            
            elements.timeIntervalSelect.addEventListener('change', (e) => {
        appData.config.timeInterval = parseInt(e.target.value);
        if (appData.originalData) {
            reprocessDataWithConfig();
        } else {
            updateDataPreview();
        }
        checkConfigValidity();
    });
    

    // 数据索引范围日期选择
    elements.dataStartDate.addEventListener('change', function() {
        appData.selectedStartDate = this.value;
        if (appData.selectedStartDate && appData.selectedEndDate) {
            // 确保开始日期不晚于结束日期
            if (new Date(appData.selectedStartDate) > new Date(appData.selectedEndDate)) {
                showNotification('开始日期不能晚于结束日期', 'warning');
                this.value = appData.selectedStartDate;
                return;
            }
            // 重新处理数据以反映日期范围选择
            if (appData.originalData) {
                reprocessDataWithConfig();
            } else {
                updateDataPreview();
            }
            // 显示通知
            showNotification('信息', `已选择日期范围: ${appData.selectedStartDate} 至 ${appData.selectedEndDate}`, 'success');
        }
    });

    elements.dataEndDate.addEventListener('change', function() {
        appData.selectedEndDate = this.value;
        if (appData.selectedStartDate && appData.selectedEndDate) {
            // 确保开始日期不晚于结束日期
            if (new Date(appData.selectedStartDate) > new Date(appData.selectedEndDate)) {
                showNotification('结束日期不能早于开始日期', 'warning');
                this.value = appData.selectedEndDate;
                return;
            }
            // 重新处理数据以反映日期范围选择
            if (appData.originalData) {
                reprocessDataWithConfig();
            } else {
                updateDataPreview();
            }
            // 显示通知
            showNotification('信息', `已选择日期范围: ${appData.selectedStartDate} 至 ${appData.selectedEndDate}`, 'success');
        }
    });

            elements.clearDateSelectionBtn.addEventListener('click', function() {
                appData.selectedStartDate = null;
                appData.selectedEndDate = null;
                elements.dataStartDate.value = '';
                elements.dataEndDate.value = '';
                
                // 清除数据行索引范围
                const dataStartIndexInput = document.getElementById('dataStartIndex');
                const dataEndIndexInput = document.getElementById('dataEndIndex');
                if (dataStartIndexInput) dataStartIndexInput.value = 0;
                if (dataEndIndexInput) dataEndIndexInput.value = -1;
                appData.config.dataStartIndex = 0;
                appData.config.dataEndIndex = -1;
                
                // 更新数据预览以清除选择范围的高亮
                updateDataPreview();
                
                showNotification('已清除日期选择', 'success');
            });
            

            
            // 绑定数据行索引范围事件监听器
            
            
            // 可视化部分
            elements.applyDateFilterBtn.addEventListener('click', applyDateFilter);
            elements.selectAllDatesBtn.addEventListener('click', selectAllDates);

            elements.applyMeteringPointFilterBtn.addEventListener('click', applyMeteringPointFilter);
            elements.selectAllMeteringPointsBtn.addEventListener('click', selectAllMeteringPoints);
            elements.applyTimeFocusBtn.addEventListener('click', applyTimeFocus);
            elements.resetTimeFocusBtn.addEventListener('click', resetTimeFocus);
            // 时段聚焦改为手动应用模式，避免频繁刷新
            elements.focusStartTimeSelect.addEventListener('change', (e) => {
                appData.visualization.focusStartTime = parseInt(e.target.value);
                // 添加视觉反馈并更新图表和统计
                e.target.style.borderColor = '#a855f7';
                setTimeout(() => {
                    e.target.style.borderColor = '';
                }, 1000);
                updateChart();
            });
            elements.focusEndTimeSelect.addEventListener('change', (e) => {
                appData.visualization.focusEndTime = parseInt(e.target.value);
                // 添加视觉反馈并更新图表和统计
                e.target.style.borderColor = '#a855f7';
                setTimeout(() => {
                    e.target.style.borderColor = '';
                }, 1000);
                updateChart();
            });
            elements.lineStyleSelect.addEventListener('change', (e) => {
                appData.visualization.lineStyle = e.target.value;
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `线条样式已更改为${e.target.options[e.target.selectedIndex].text}`, 'success');
            });
            
            elements.showPointsSelect.addEventListener('change', (e) => {
                appData.visualization.showPoints = e.target.value === 'true';
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `数据点显示已${e.target.value === 'true' ? '开启' : '关闭'}`, 'success');
            });
            
            elements.smoothCurveSelect.addEventListener('change', (e) => {
                appData.visualization.smoothCurve = e.target.value === 'true';
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `曲线平滑已${e.target.value === 'true' ? '开启' : '关闭'}`, 'success');
            });
            
            elements.curveTensionSelect.addEventListener('change', (e) => {
                appData.visualization.curveTension = parseFloat(e.target.value);
                // 添加视觉反馈
                e.target.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `曲线平滑度已设置为${e.target.options[e.target.selectedIndex].text}`, 'success');
            });
            
            elements.secondaryAxisCheckbox.addEventListener('change', (e) => {
                appData.visualization.secondaryAxis = e.target.checked;
                // 添加视觉反馈
                e.target.parentElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.parentElement.style.transform = 'scale(1)';
                }, 200);
                updateChart();
                showNotification('样式更新', `辅助Y轴已${e.target.checked ? '开启' : '关闭'}`, 'success');
            });
            
            // 曲线图图例显示开关事件
            document.getElementById('toggleCurveLegend').addEventListener('change', (e) => {
                const isVisible = e.target.checked;
                const legendContainer = document.getElementById('curveLegendContainer');
                
                // 更新图例容器显示状态
                if (legendContainer) {
                    legendContainer.style.display = isVisible ? 'block' : 'none';
                }
                
                // 更新图表图例显示状态
                if (appData.chart) {
                    appData.chart.options.plugins.legend.display = isVisible;
                    appData.chart.update();
                }
                
                // 添加视觉反馈
                e.target.parentElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    e.target.parentElement.style.transform = 'scale(1)';
                }, 200);
                
                showNotification('样式更新', `曲线图例已${isVisible ? '开启' : '关闭'}`, 'success');
            });
            
            // 新增：汇总模式切换按钮
            const summaryBtn = document.getElementById('toggleSummaryMode');
            if (summaryBtn) {
                summaryBtn.addEventListener('click', () => {
                    appData.visualization.summaryMode = !appData.visualization.summaryMode;
                    // 更新按钮文案/样式
                    summaryBtn.textContent = appData.visualization.summaryMode ? '返回明细' : '汇总曲线';
                    summaryBtn.classList.toggle('bg-indigo-600', !appData.visualization.summaryMode);
                    summaryBtn.classList.toggle('bg-gray-600', appData.visualization.summaryMode);
                    // 刷新图表
                    updateChart();
                    // 汇总模式下隐藏分页控件
                    if (appData.visualization.summaryMode) {
                        hidePaginationControls();
                    }
                });
            }

            // 柱状图始终显示，无需事件处理

            

            
            // 导出部分
            elements.exportPNGBtn.addEventListener('click', exportAsPNG);
            elements.exportJPGBtn.addEventListener('click', exportAsJPG);
            elements.exportSVGBtn.addEventListener('click', exportAsSVG);
            elements.exportHourlyDataBtn.addEventListener('click', exportHourlyData);
            elements.exportDailyStatsBtn.addEventListener('click', exportDailyStats);
            document.getElementById('exportPVsystData').addEventListener('click', exportPVsystData);
            
            // 导出日期范围选择器事件处理
            document.getElementById('exportAllDates').addEventListener('change', function() {
                const startDate = document.getElementById('exportStartDate');
                const endDate = document.getElementById('exportEndDate');
                
                if (this.checked) {
                    startDate.disabled = true;
                    endDate.disabled = true;
                } else {
                    startDate.disabled = false;
                    endDate.disabled = false;
                }
            });
            
            // 初始化日期范围选择器状态
              document.getElementById('exportAllDates').dispatchEvent(new Event('change'));

            if (elements.startOverBtn) {
                elements.startOverBtn.addEventListener('click', startOver);
            }
            
            // 通知和模态框
            elements.closeNotificationBtn.addEventListener('click', hideNotification);
            elements.closeModalBtn.addEventListener('click', closeModal);
            elements.modalOverlay.addEventListener('click', (e) => {
                if (e.target === elements.modalOverlay) closeModal();
            });
            

            elements.aboutBtn.addEventListener('click', showAboutModal);
            
            elements.filterCountInput.addEventListener('change', (e) => {
                appData.config.filterCount = parseInt(e.target.value) || 1;
            });
        
        // 导入历史现在固定展开，无需切换功能
        
            console.log('Chart实例创建完成:', !!appData.dailyTotalBarChart);
            console.log('=== 初始化柱状图结束 ===');
        
        // 事件监听器绑定
        if (elements.closeHistoryDetailModalBtn) {
            elements.closeHistoryDetailModalBtn.addEventListener('click', closeHistoryDetailModal);
        }
        
        if (elements.applyFilterCountBtn) {
            elements.applyFilterCountBtn.addEventListener('click', generateFilterOptions);
        }
        
        // 第一个小时计算过程预览
        if (elements.previewFirstHourCalculationBtn) {
            elements.previewFirstHourCalculationBtn.addEventListener('click', previewFirstHourCalculation);
        }
        if (elements.closeFirstHourCalculationModalBtn) {
            elements.closeFirstHourCalculationModalBtn.addEventListener('click', closeFirstHourCalculationModal);
        }
        
        // 第一天计算过程预览
        if (elements.previewFirstDayCalculationBtn) {
            elements.previewFirstDayCalculationBtn.addEventListener('click', previewFirstDayCalculation);
        }
        if (elements.closeFirstDayCalculationModalBtn) {
            elements.closeFirstDayCalculationModalBtn.addEventListener('click', closeFirstDayCalculationModal);
        }
        
        // 添加数据结构类型变更事件处理
        document.querySelectorAll('input[name="dataStructure"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const dataStructure = this.value;
                
                // 根据数据结构类型显示/隐藏相关选项
        if (dataStructure === 'columnToRow') {
            // 显示数据结束列选项
            document.getElementById('dataEndColumn').parentElement.style.display = 'block';
            
            // 显示时间间隔自动检测提示
            const timeIntervalLabel = document.querySelector('label[for="timeInterval"]');
            if (timeIntervalLabel) {
                timeIntervalLabel.textContent = '时间间隔（分钟，列对行结构可自动检测）';
            }
            
            // 隐藏跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'none';
            }
                } else {
            // 隐藏数据结束列选项
            document.getElementById('dataEndColumn').parentElement.style.display = 'none';
            
            // 更新时间间隔标签
            const timeIntervalLabel = document.querySelector('label[for="timeInterval"]');
            if (timeIntervalLabel) {
                timeIntervalLabel.textContent = '时间间隔（分钟）';
            }
            
            // 显示跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'block';
            }
                }
                
                // 更新数据预览
                updateDataPreview();
                
                // 更新按钮状态
                checkConfigValidity();
            });
        });
        
        // 初始化数据结构类型UI
        const initialDataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
        if (initialDataStructure === 'columnToColumn') {
            // 隐藏数据结束列选项
            document.getElementById('dataEndColumn').parentElement.style.display = 'none';
            
            // 显示跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'block';
            }
        } else {
            // 隐藏跨日期结构数据选项
            const crossDateContainer = document.getElementById('crossDateStructureContainer');
            if (crossDateContainer) {
                crossDateContainer.style.display = 'none';
            }
        }

        // 清除按钮事件处理
        // 清除计量点编号所在列选择
        document.getElementById('clearMeteringPointColumn').addEventListener('click', function() {
            elements.meteringPointColumnSelect.value = '';
            appData.config.meteringPointColumn = '';
            updateMeteringPointFilterOptions();
            updateDataPreview();
            showNotification('已清除', '计量点编号所在列选择已清除', 'success');
        });

        // 清除计量点编号筛选
        document.getElementById('clearMeteringPointFilter').addEventListener('click', function() {
            elements.meteringPointFilterSelect.value = '';
            appData.config.meteringPointFilter = '';
            updateDataPreview();
            showNotification('已清除', '计量点编号筛选已清除', 'success');
        });

        // 清除全部筛选项
        document.getElementById('clearAllFilters').addEventListener('click', function() {
            // 清除additionalFilters数组
            appData.config.additionalFilters = [];
            
            // 重新生成筛选项（会清空所有选择）
            generateFilterOptions();
            
            // 更新数据预览
            updateDataPreview();
            showNotification('已清除', '所有筛选项已清除', 'success');
        });

        // 清除单个筛选项（使用事件委托）
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('clear-single-filter')) {
                e.preventDefault();
                const index = parseInt(e.target.dataset.index);
                
                if (!isNaN(index)) {
                    // 清除该筛选项的选择
                    const columnSelect = document.getElementById(`filterColumn${index}`);
                    const valueSelect = document.getElementById(`filterValue${index}`);
                    
                    if (columnSelect && valueSelect) {
                        columnSelect.value = '';
                        valueSelect.innerHTML = '<option value="">-- 全部 --</option>';
                        
                        // 更新配置
                        if (appData.config.additionalFilters[index]) {
                            appData.config.additionalFilters[index].column = '';
                            appData.config.additionalFilters[index].value = '';
                        }
                        
                        updateDataPreview();
                        showNotification('已清除', `筛选项 ${index + 1} 已清除`, 'success');
                    }
                }
            }
        });
        }

        // 文件处理辅助函数
        function estimateMemoryUsage(jsonData) {
            // 估算数据的内存使用量（MB）
            const rowCount = jsonData.length;
            const avgColumnsPerRow = jsonData[0] ? jsonData[0].length : 0;
            const avgBytesPerCell = 20; // 估算每个单元格平均字节数
            const estimatedBytes = rowCount * avgColumnsPerRow * avgBytesPerCell;
            return estimatedBytes / (1024 * 1024); // 转换为MB
        }
        
        function checkMemoryLimits(file, jsonData) {
            const rowCount = jsonData.length;
            const estimatedMB = estimateMemoryUsage(jsonData);
            
            // 检查单个文件行数限制
            if (rowCount > appData.memoryManagement.maxDataRows) {
                const proceed = confirm(
                    `文件 "${file.name}" 包含 ${rowCount} 行数据，超过建议的 ${appData.memoryManagement.maxDataRows} 行限制。\n\n` +
                    `大量数据可能导致浏览器响应缓慢或崩溃。\n\n是否仍要继续处理？`
                );
                if (!proceed) {
                    return false;
                }
            }
            
            // 检查总内存使用限制
            const newTotalMemory = appData.memoryManagement.currentMemoryUsageMB + estimatedMB;
            if (newTotalMemory > appData.memoryManagement.maxTotalMemoryMB) {
                const proceed = confirm(
                    `添加此文件将使总内存使用量达到约 ${newTotalMemory.toFixed(1)}MB，超过 ${appData.memoryManagement.maxTotalMemoryMB}MB 限制。\n\n` +
                    `建议先清理现有数据或减少数据量。\n\n是否仍要继续？`
                );
                if (!proceed) {
                    return false;
                }
            }
            
            // 更新内存使用量
            appData.memoryManagement.currentMemoryUsageMB += estimatedMB;
            return true;
        }
        
        function optimizeMemoryUsage() {
            if (appData.memoryManagement.enableGarbageCollection) {
                // 强制垃圾回收（如果浏览器支持）
                if (window.gc && typeof window.gc === 'function') {
                    try {
                        window.gc();
                    } catch (e) {
                        // 忽略错误，某些浏览器不支持手动GC
                    }
                }
                
                // 清理不必要的引用
                setTimeout(() => {
                    // 延迟执行，让浏览器有机会进行垃圾回收
                    if (appData.memoryManagement.currentMemoryUsageMB > appData.memoryManagement.maxTotalMemoryMB * 0.8) {
                        showNotification('提示', '内存使用量较高，建议清理部分数据以提升性能', 'warning');
                    }
                }, 1000);
            }
        }
        
        function completeFileProcessing(file, jsonData, processedCount, totalFiles) {
            // 记录成功的历史记录
            const historyRecord = {
                importTime: new Date().toISOString(),
                fileName: file.name,
                fileSize: file.size,
                filePath: file.path || '',
                status: 'success',
                recordCount: jsonData.length - 1,
                validRecordCount: 0,
                invalidRecordCount: 0,
                timeInterval: null,
                config: null
            };
            
            appData.importHistory.push(historyRecord);
            saveImportHistory();
            renderImportHistory();
            
            processedCount++;
            updateUploadProgress(processedCount, totalFiles);
            
            showNotification('成功', `文件 "${file.name}" 导入成功`, 'success');
            
            // 更新状态
            const importStatusElement = document.getElementById('importStatus');
            if (importStatusElement && importStatusElement.parentNode) {
                importStatusElement.textContent = '文件导入完成';
            }

            // 导入完成后自动刷新数据预览（无需手动下拉选择）
            setTimeout(() => {
                try {
                    updateDataPreview();
                } catch (err) {
                    console.error('自动刷新数据预览失败:', err);
                }
            }, 0);
        }
        
        function handleFileProcessingError(file, error, processedCount, totalFiles) {
            console.error('Error processing file:', error);
            showNotification('错误', `处理文件 "${file.name}" 时出错: ${error.message}`, 'error');
            
            // 记录失败的历史记录
            const historyRecord = {
                importTime: new Date().toISOString(),
                fileName: file.name,
                fileSize: file.size,
                filePath: file.path || '',
                status: 'failure',
                errorMessage: error.message,
                recordCount: 0,
                validRecordCount: 0,
                invalidRecordCount: 0
            };
            
            appData.importHistory.push(historyRecord);
            saveImportHistory();
            renderImportHistory();
            
            processedCount++;
            updateUploadProgress(processedCount, totalFiles);
        }

        // 文件处理函数
        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (elements.dropArea && elements.dropArea.parentNode) {
                if (elements.dropArea && elements.dropArea.parentNode) {
                elements.dropArea.classList.add('border-primary');
                elements.dropArea.classList.add('bg-primary/5');
            }
            }
        }

        function handleDragLeave() {
            if (elements.dropArea && elements.dropArea.parentNode) {
                if (elements.dropArea && elements.dropArea.parentNode) {
                if (elements.dropArea && elements.dropArea.parentNode) {
                elements.dropArea.classList.remove('border-primary');
                elements.dropArea.classList.remove('bg-primary/5');
            }
            }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            if (elements.dropArea && elements.dropArea.parentNode) {
                elements.dropArea.classList.remove('border-primary');
                elements.dropArea.classList.remove('bg-primary/5');
            }
            
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function processFiles(files) {
            if (files.length === 0) return;
            
            // 在非追加模式下，导入新文件前先清空现有数据与配置
            const appendModeAtImport = document.getElementById('appendMode')?.checked || false;
            if (!appendModeAtImport) {
                removeAllFiles();
            }
            
            // 显示上传进度
            if (elements.uploadProgress && elements.uploadProgress.parentNode) {
                if (elements.uploadProgress && elements.uploadProgress.parentNode) {
                elements.uploadProgress.classList.remove('hidden');
            }
            }
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            files.forEach((file, index) => {
                // 检查文件是否已导入
                const isDuplicate = appData.files.some(f => 
                    f.name === file.name && f.size === file.size && f.lastModified === file.lastModified
                );
                
                if (isDuplicate) {
                    showNotification('警告', `文件 "${file.name}" 已导入，跳过重复文件`, 'warning');
                    processedCount++;
                    updateUploadProgress(processedCount, totalFiles);
                    return;
                }
                
                // 检查文件大小限制（50MB）
                const maxFileSize = 50 * 1024 * 1024; // 50MB in bytes
                if (file.size > maxFileSize) {
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    showNotification('警告', `文件 "${file.name}" 过大 (${fileSizeMB}MB)，建议文件大小不超过50MB。大文件可能导致浏览器响应缓慢或崩溃。`, 'warning');
                    
                    // 询问用户是否继续处理
                    if (!confirm(`文件 "${file.name}" 大小为 ${fileSizeMB}MB，超过建议的50MB限制。\n\n继续处理可能导致浏览器响应缓慢或崩溃。\n\n是否仍要继续导入此文件？`)) {
                        // 记录用户取消的历史记录
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '',
                            status: 'cancelled',
                            errorMessage: `用户取消导入大文件 (${fileSizeMB}MB)`,
                            recordCount: 0,
                            validRecordCount: 0,
                            invalidRecordCount: 0
                        };
                        
                        appData.importHistory.push(historyRecord);
                        saveImportHistory();
                        renderImportHistory();
                        processedCount++;
                        updateUploadProgress(processedCount, totalFiles);
                        return;
                    }
                }
                
                if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    showNotification('错误', `文件 "${file.name}" 格式不支持，请上传Excel或CSV文件`, 'error');
                    
                    // 记录失败的历史记录
                    const historyRecord = {
                        importTime: new Date().toISOString(),
                        fileName: file.name,
                        fileSize: file.size,
                        filePath: file.path || '',
                        status: 'failure',
                        errorMessage: '文件格式不支持，请上传Excel或CSV文件',
                        recordCount: 0,
                        validRecordCount: 0,
                        invalidRecordCount: 0
                    };
                    
                    appData.importHistory.push(historyRecord);
                    saveImportHistory();
                    renderImportHistory();
                    processedCount++;
                    updateUploadProgress(processedCount, totalFiles);
                    return;
                }
                
                appData.files.push(file);
                addFileToUI(file);
                
                const reader = new FileReader();
                
                // 添加文件读取错误处理
                reader.onerror = function(e) {
                    console.error('FileReader error:', e);
                    const errorMessage = e.target.error ? e.target.error.message : '文件读取失败';
                    showNotification('错误', `读取文件 "${file.name}" 时出错: ${errorMessage}`, 'error');
                    
                    // 记录失败的历史记录
                    const historyRecord = {
                        importTime: new Date().toISOString(),
                        fileName: file.name,
                        fileSize: file.size,
                        filePath: file.path || '',
                        status: 'failure',
                        errorMessage: `文件读取失败: ${errorMessage}`,
                        recordCount: 0,
                        validRecordCount: 0,
                        invalidRecordCount: 0
                    };
                    
                    appData.importHistory.push(historyRecord);
                    saveImportHistory();
                    renderImportHistory();
                    
                    processedCount++;
                    updateUploadProgress(processedCount, totalFiles);
                };
                
                reader.onload = function(e) {
                    try {
                        // 显示处理进度（对于大文件）
                        const fileSizeMB = file.size / (1024 * 1024);
                        if (fileSizeMB > 10) { // 对于超过10MB的文件显示处理提示
                            showNotification('信息', `正在处理大文件 "${file.name}" (${fileSizeMB.toFixed(2)}MB)，请稍候...`, 'info');
                        }
                        
                        let jsonData;
                        let firstSheetName;
                        
                        if (file.name.endsWith('.csv')) {
                            // CSV文件处理
                            const csvData = e.target.result;
                            const workbook = XLSX.read(csvData, { type: 'string' });
                            firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        } else {
                            // Excel文件处理 - 对大文件使用更保守的选项
                            const data = new Uint8Array(e.target.result);
                            const readOptions = fileSizeMB > 20 ? 
                                { type: 'array', cellDates: false, cellNF: false, cellStyles: false } : 
                                { type: 'array' };
                            const workbook = XLSX.read(data, readOptions);
                            firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        }
                        
                        // 检查内存限制
                        if (!checkMemoryLimits(file, jsonData)) {
                            // 用户取消处理大数据文件
                            const historyRecord = {
                                importTime: new Date().toISOString(),
                                fileName: file.name,
                                fileSize: file.size,
                                filePath: file.path || '',
                                status: 'cancelled',
                                errorMessage: '用户取消处理大数据文件（内存限制）',
                                recordCount: jsonData.length - 1,
                                validRecordCount: 0,
                                invalidRecordCount: 0
                            };
                            
                            appData.importHistory.push(historyRecord);
                            saveImportHistory();
                            renderImportHistory();
                            processedCount++;
                            updateUploadProgress(processedCount, totalFiles);
                            return;
                        }
                        
                        // 对于大数据集，分批处理以避免UI阻塞
                        if (jsonData.length > 10000) {
                            showNotification('信息', `文件包含 ${jsonData.length} 行数据，正在优化处理...`, 'info');
                            
                            // 使用setTimeout分批处理，避免阻塞UI
                            setTimeout(() => {
                                try {
                                    appData.worksheets.push({
                                        file: file,
                                        sheetName: firstSheetName,
                                        data: jsonData
                                    });
                                    
                                    // 更新统计信息
                                    updateDataStats();
                                    
                                    // 非追加模式或首个文件时，自动填充列选择并识别数据结构
                                    const appendModeDetect1 = document.getElementById('appendMode')?.checked || false;
                                    if (!appendModeDetect1 || appData.worksheets.length === 1) {
                                        populateColumnSelects(jsonData[0] || [], jsonData);
                                        autoDetectDataStructure(jsonData);
                                        // 自动识别完成后，尝试刷新预览（若配置已充分）
                                        setTimeout(() => { try { updateDataPreview(); } catch(e){} }, 0);
                                    }
                                    
                                    completeFileProcessing(file, jsonData, processedCount, totalFiles);
                                    
                                    // 优化内存使用
                                    optimizeMemoryUsage();
                                } catch (error) {
                                    handleFileProcessingError(file, error, processedCount, totalFiles);
                                }
                            }, 100);
                        } else {
                            appData.worksheets.push({
                                file: file,
                                sheetName: firstSheetName,
                                data: jsonData
                            });
                            
                            // 更新统计信息
                            updateDataStats();
                            
                            // 非追加模式或首个文件时，自动填充列选择并识别数据结构（与大数据分支一致）
                            const appendModeDetect2 = document.getElementById('appendMode')?.checked || false;
                            if (!appendModeDetect2 || appData.worksheets.length === 1) {
                                populateColumnSelects(jsonData[0] || [], jsonData);
                                autoDetectDataStructure(jsonData);
                                // 自动识别完成后，尝试刷新预览（若配置已充分）
                                setTimeout(() => { try { updateDataPreview(); } catch(e){} }, 0);
                            }
                            
                            completeFileProcessing(file, jsonData, processedCount, totalFiles);
                            
                            // 优化内存使用
                            optimizeMemoryUsage();
                        }
                        
                        // 记录成功的历史记录
                        const historyRecord = {
                            importTime: new Date().toISOString(),
                            fileName: file.name,
                            fileSize: file.size,
                            filePath: file.path || '',
                            status: 'success',
                            recordCount: jsonData.length - 1,
                            validRecordCount: 0,
                            invalidRecordCount: 0,
                            timeInterval: null,
                            config: null
                        };
                        
                        appData.importHistory.push(historyRecord);
                        saveImportHistory();
                        renderImportHistory();
                        
                        processedCount++;
                        updateUploadProgress(processedCount, totalFiles);
                        
                        showNotification('成功', `文件 "${file.name}" 导入成功`, 'success');
                        
                        // 更新状态
                        const importStatusElement = document.getElementById('importStatus');
                        if (importStatusElement && importStatusElement.parentNode) {
                            importStatusElement.textContent = '文件导入完成';
                        }
                        
                    } catch (error) {
                        handleFileProcessingError(file, error, processedCount, totalFiles);
                    }
                };
                
                if (file.name.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
            
            // 更新状态
            const importStatusElement = document.getElementById('importStatus');
            if (importStatusElement && importStatusElement.parentNode) {
                importStatusElement.textContent = '正在处理文件...';
            }
            
            // 文件列表现在固定展开，无需控制显示/隐藏
            if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                elements.removeAllFiles.classList.remove('hidden');
            }
            
        }

        function addFileToUI(file) {
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
            li.innerHTML = `
                <div class="flex items-center">
                    <i class="fa fa-file-excel-o text-success mr-2"></i>
                    <div>
                        <p class="font-medium text-sm truncate max-w-xs">${file.name}</p>
                        <p class="text-xs text-neutral">${fileSize} MB</p>
                    </div>
                </div>
                <button class="text-danger hover:text-danger/80 remove-file" data-name="${file.name}" aria-label="删除文件 ${file.name}" title="删除文件 ${file.name}">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            elements.importedFiles.appendChild(li);
            
            // 添加删除单个文件的事件
            li.querySelector('.remove-file').addEventListener('click', function(e) {
                const fileName = e.target.closest('.remove-file').dataset.name;
                removeFile(fileName);
            });
        }

        function removeFile(fileName) {
            // 从数据中移除
            appData.files = appData.files.filter(file => file.name !== fileName);
            appData.worksheets = appData.worksheets.filter(ws => ws.file.name !== fileName);
            
            // 从UI中移除
            const fileElement = Array.from(elements.importedFiles.children).find(li => 
                li.querySelector('.font-medium').textContent === fileName
            );
            
            if (fileElement) {
                fileElement.remove();
            }
            
            // 如果没有文件了，保持列表展开但隐藏清空按钮
            if (appData.files.length === 0) {
                // 文件列表现在固定展开，无需隐藏
                if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                    elements.removeAllFiles.classList.add('hidden');
                }

                const appendMode = document.getElementById('appendMode')?.checked || false;
                if (!appendMode) {
                    // 非追加模式：彻底重置数据与配置
                    appData.worksheets = [];
                    appData.parsedData = [];
                    appData.processedData = [];

                    appData.config = appData.config || {};
                    appData.config.dateColumn = '';
                    appData.config.dataStartColumn = '';
                    appData.config.dataEndColumn = '';
                    appData.config.meteringPointColumn = '';
                    appData.config.multiplierColumn = '';
                    appData.config.dataStructure = '';

                    // 清空列选择（含计量点、多倍率列）
                    elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                    elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                    elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                    elements.meteringPointColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                    elements.multiplierColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
                } else {
                    // 追加模式：保留数据与配置，不清空列选择
                }
            } else if (appData.worksheets.length > 0) {
                // 重新填充列选择
                populateColumnSelects(appData.worksheets[0].data[0] || [], appData.worksheets[0].data);
            }
            
            showNotification('信息', `文件 "${fileName}" 已移除`, 'info');
        }

        function removeAllFiles() {
            if (appData.files.length === 0) return;
            
            // 清空数据 - 追加模式下不清除数据
            const appendMode = document.getElementById('appendMode')?.checked || false;
            if (!appendMode) {
                appData.files = [];
                appData.worksheets = [];
                appData.parsedData = [];
                appData.processedData = [];
                
                // 同步重置配置
                appData.config = appData.config || {};
                appData.config.dateColumn = '';
                appData.config.dataStartColumn = '';
                appData.config.dataEndColumn = '';
                appData.config.meteringPointColumn = '';
                appData.config.multiplierColumn = '';
                appData.config.dataStructure = '';
            } else {
                // 追加模式下只清空文件列表，保留数据
                appData.files = [];
                // 不清除worksheets, parsedData, processedData, config
            }
            
            // 清空UI
            elements.importedFiles.innerHTML = '';
            // 文件列表现在固定展开，无需隐藏
            if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                elements.removeAllFiles.classList.add('hidden');
            }

            // 清空列选择（含计量点、多倍率列）
            elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            
            // 重置筛选、预览与概览
            if (!appendMode) {
                updateDataStats();
                updateDataOverview();
                updateDataPreview();
            }
            
            showNotification('信息', '所有文件已移除', 'info');
        }

        function populateColumnSelects(headerRow, data) {
            // 清空现有选项
            elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            
            // 添加新选项 (支持所有列，不再限制50列)
            for (let i = 0; i < headerRow.length; i++) {
                // 生成列字母，支持超过26列的情况（如AA, AB等）
                let columnLetter = "";
                let columnNum = i;
                while (columnNum >= 0) {
                    columnLetter = String.fromCharCode(65 + (columnNum % 26)) + columnLetter;
                    columnNum = Math.floor(columnNum / 26) - 1;
                    if (columnNum < 0) break;
                }
                
                const headerText = headerRow[i] ? String(headerRow[i]).substring(0, 20) : `列 ${columnLetter}`;
                
                const dateOption = document.createElement('option');
                dateOption.value = i;
                dateOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dateColumnSelect.appendChild(dateOption);
                
                const startOption = document.createElement('option');
                startOption.value = i;
                startOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dataStartColumnSelect.appendChild(startOption);
                
                const endOption = document.createElement('option');
                endOption.value = i;
                endOption.textContent = `${columnLetter}: ${headerText}`;
                elements.dataEndColumnSelect.appendChild(endOption);
                
                const meteringPointOption = document.createElement('option');
                meteringPointOption.value = i;
                meteringPointOption.textContent = `${columnLetter}: ${headerText}`;
                elements.meteringPointColumnSelect.appendChild(meteringPointOption);
                
                const multiplierColumnOption = document.createElement('option');
        multiplierColumnOption.value = i;
        multiplierColumnOption.textContent = `${columnLetter}: ${headerText}`;
        elements.multiplierColumnSelect.appendChild(multiplierColumnOption);
    }
    
    // 自动识别列
    if (data && data.length > 1) {
        autoDetectColumns(headerRow, data);
    }
    
    // 生成筛选项
    generateFilterOptions();
}

        // 自动识别数据结构类型函数
        function autoDetectDataStructure(jsonData) {
            if (!jsonData || jsonData.length < 2) return; // 需要至少有表头和一行数据
            
            const headerRow = jsonData[0];
            const dataRows = jsonData.slice(1, Math.min(11, jsonData.length)); // 取前10行数据进行分析
            
            // 分析特征1：列数
            const columnCount = headerRow.length;
            
            // 分析特征2：日期列的特征
            let dateColumnIndex = -1;
            const dateKeywords = ['日期', '时间', 'date', 'time', 'datetime'];
            
            for (let i = 0; i < headerRow.length; i++) {
                const headerText = String(headerRow[i]).toLowerCase();
                if (dateKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    dateColumnIndex = i;
                    break;
                }
            }
            
            if (dateColumnIndex === -1) return; // 没有找到日期列，无法判断
            
            // 分析特征3：数据列的特征
            let dataColumnIndices = [];
            const dataKeywords = ['数据', '数值', '值', 'data', 'value', '功率', '电能', '负荷'];
            
            for (let i = 0; i < headerRow.length; i++) {
                if (i === dateColumnIndex) continue; // 跳过日期列
                
                const headerText = String(headerRow[i]).toLowerCase();
                if (dataKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    dataColumnIndices.push(i);
                }
            }
            
            // 如果没有找到明确的数据列，尝试通过数据内容判断
            if (dataColumnIndices.length === 0) {
                for (let i = 0; i < headerRow.length; i++) {
                    if (i === dateColumnIndex) continue; // 跳过日期列
                    
                    // 检查该列是否包含大量数字
                    let numericCount = 0;
                    for (let j = 0; j < dataRows.length; j++) {
                        if (dataRows[j] && dataRows[j][i] !== undefined && !isNaN(parseFloat(dataRows[j][i]))) {
                            numericCount++;
                        }
                    }
                    
                    // 如果超过70%的行包含数字，认为是数据列
                    if (numericCount / dataRows.length > 0.7) {
                        dataColumnIndices.push(i);
                    }
                }
            }
            
            // 分析特征4：时间序列模式
            let timeSeriesScore = 0;
            let columnSeriesScore = 0;
            
            // 检查是否包含时间序列模式（如0:00, 1:00等）
            for (let i = 0; i < headerRow.length; i++) {
                if (i === dateColumnIndex) continue;
                
                const headerText = String(headerRow[i]);
                if (/\d{1,2}:\d{2}/.test(headerText)) {
                    timeSeriesScore += 5; // 发现时间序列模式
                }
            }
            
            // 检查数据列数量
            if (dataColumnIndices.length >= 24) {
                timeSeriesScore += 3; // 多列数据更可能是时间序列（列对行）
            }
            
            if (dataColumnIndices.length <= 5) {
                columnSeriesScore += 3; // 少列数据更可能是列对列
            }
            
            // 分析特征5：日期重复情况
            const dateCount = {};
            for (let i = 0; i < dataRows.length; i++) {
                if (dataRows[i] && dataRows[i][dateColumnIndex]) {
                    const dateValue = String(dataRows[i][dateColumnIndex]);
                    dateCount[dateValue] = (dateCount[dateValue] || 0) + 1;
                }
            }
            
            // 计算日期重复率
            const uniqueDates = Object.keys(dateCount).length;
            const totalRows = dataRows.length;
            const dateDuplicationRate = (totalRows - uniqueDates) / totalRows;
            
            if (dateDuplicationRate > 0.5) {
                columnSeriesScore += 5; // 高重复率更可能是列对列结构
            } else {
                timeSeriesScore += 3; // 低重复率更可能是列对行结构
            }
            
            // 综合评分，决定数据结构类型
            const totalScore = timeSeriesScore + columnSeriesScore;
            
            let detectedStructure;
            let confidence;
            
            if (totalScore === 0) {
                // 没有明确的特征，使用默认值
                detectedStructure = 'columnToRow';
                confidence = 'low';
            } else {
                const timeSeriesRatio = timeSeriesScore / totalScore;
                
                if (timeSeriesRatio > 0.6) {
                    detectedStructure = 'columnToRow';
                    confidence = timeSeriesRatio > 0.8 ? 'high' : 'medium';
                } else {
                    detectedStructure = 'columnToColumn';
                    confidence = timeSeriesRatio < 0.4 ? 'high' : 'medium';
                }
            }
            
            // 设置检测到的数据结构类型
            const radioToCheck = document.querySelector(`input[name="dataStructure"][value="${detectedStructure}"]`);
            if (radioToCheck) {
                radioToCheck.checked = true;
                
                // 触发change事件以更新UI
                const event = new Event('change', { bubbles: true });
                radioToCheck.dispatchEvent(event);
                
                // 显示检测结果通知
                let confidenceText = '';
                if (confidence === 'high') {
                    confidenceText = '高置信度';
                } else if (confidence === 'medium') {
                    confidenceText = '中等置信度';
                } else {
                    confidenceText = '低置信度，使用默认值';
                }
                
                const structureText = detectedStructure === 'columnToRow' ? '列对行（日期列对多数据列）' : '列对列（日期列对单数据列）';
                showNotification('信息', `已自动识别数据结构类型：${structureText}（${confidenceText}）`, 'info');
            }
        }

        // 自动识别列函数
        function autoDetectColumns(headerRow, data) {
            let dateColumnIndex = -1;
            let dataStartColumnIndex = -1;
            let dataEndColumnIndex = -1;
            let meteringPointColumnIndex = -1;
            let multiplierColumnIndex = -1;
            
            // 识别日期列 - 查找包含日期相关关键词的列
            const dateKeywords = ['日期', '时间', 'date', 'time', 'datetime', '时间点', '记录时间', '日', '月', '年', '时', '分', '秒'];
            const datePatterns = [/\d{4}[\-\/]\d{1,2}[\-\/]\d{1,2}/, /\d{1,2}[\-\/]\d{1,2}[\-\/]\d{4}/, /\d{4}\d{2}\d{2}/];
            
            // 为每列计算置信度分数
            const columnScores = headerRow.map((header, index) => {
                const headerText = String(header).toLowerCase();
                let score = 0;
                
                // 日期列评分
                if (dateKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    score += 10; // 关键词匹配高分
                }
                
                // 检查日期格式模式
                if (datePatterns.some(pattern => pattern.test(headerText))) {
                    score += 8; // 日期格式匹配较高分
                }
                
                // 检查列位置 - 日期列通常在前几列
                if (index < 3) {
                    score += 3; // 位置加分
                }
                
                return {
                    index,
                    dateScore: score,
                    dataScore: 0,
                    meteringPointScore: 0,
                    multiplierScore: 0
                };
            });
            
            // 增强的数据起始列识别 - 智能识别功率和电能列
            const powerKeywords = ['功率', 'power', 'p', 'kw', '有功', '无功', '视在', '瞬时', '实时'];
            const energyKeywords = ['电能', '电量', 'energy', 'kwh', '累积', '总量', '用电量', '耗电量'];
            const generalDataKeywords = ['数据', '数值', '值', 'data', 'value', '负荷', '读数', '开始', '电流', '电压'];
            
            // 增强的数据格式模式
            const powerPatterns = [/kw(?!h)/i, /功率/i, /\bp\b/i, /有功|无功|视在/i];
            const energyPatterns = [/kwh/i, /电能|电量/i, /累积|总量/i, /用电量|耗电量/i];
            const numericPatterns = [/\d+\.?\d*/, /\d{1,2}:\d{2}/, /[0-9]+/];
            const unitPatterns = [/kw|kva|kvar|a|v|kwh/i];
            
            // 为每列计算增强的数据列置信度分数
            columnScores.forEach(scoreObj => {
                const headerText = String(headerRow[scoreObj.index]).toLowerCase().trim();
                const originalText = String(headerRow[scoreObj.index]).trim();
                
                // 功率列专项识别（最高优先级）
                let powerScore = 0;
                powerKeywords.forEach(keyword => {
                    if (headerText.includes(keyword.toLowerCase())) {
                        powerScore += keyword === 'kw' ? 15 : 12; // kW单位最高分
                    }
                });
                
                // 电能列专项识别（最高优先级）
                let energyScore = 0;
                energyKeywords.forEach(keyword => {
                    if (headerText.includes(keyword.toLowerCase())) {
                        energyScore += keyword === 'kwh' ? 15 : 12; // kWh单位最高分
                    }
                });
                
                // 通用数据列识别
                let generalScore = 0;
                generalDataKeywords.forEach(keyword => {
                    if (headerText.includes(keyword.toLowerCase())) {
                        generalScore += 8;
                    }
                });
                
                // 模式匹配加分
                if (powerPatterns.some(pattern => pattern.test(originalText))) {
                    powerScore += 10;
                }
                if (energyPatterns.some(pattern => pattern.test(originalText))) {
                    energyScore += 10;
                }
                if (numericPatterns.some(pattern => pattern.test(headerText))) {
                    generalScore += 6;
                }
                if (unitPatterns.some(pattern => pattern.test(headerText))) {
                    generalScore += 8;
                }
                
                // 时间序列模式识别（如0:00, 1:00等）
                if (/\d{1,2}:\d{2}/.test(headerText)) {
                    generalScore += 7;
                }
                
                // 位置权重 - 数据列通常在日期列之后
                let positionBonus = 0;
                if (scoreObj.index > 0 && scoreObj.index < headerRow.length - 2) {
                    positionBonus = 2;
                }
                
                // 计算最终数据列分数（取最高分类型）
                const maxTypeScore = Math.max(powerScore, energyScore, generalScore);
                scoreObj.dataScore += maxTypeScore + positionBonus;
                
                // 记录列类型信息用于后续处理
                scoreObj.columnType = powerScore > energyScore && powerScore > generalScore ? 'power' :
                                    energyScore > powerScore && energyScore > generalScore ? 'energy' : 'general';
                scoreObj.typeScore = maxTypeScore;
            });
            
            // 根据置信度分数选择日期列
            const dateCandidates = columnScores
                .filter(scoreObj => scoreObj.dateScore > 0)
                .sort((a, b) => b.dateScore - a.dateScore);
            
            if (dateCandidates.length > 0) {
                dateColumnIndex = dateCandidates[0].index;
            }
            
            // 如果没有找到日期列，尝试使用启发式方法查找
            if (dateColumnIndex === -1) {
                console.log('未找到日期列，使用启发式方法检测...');
                
                // 检查每列的实际数据内容
                for (let col = 0; col < headerRow.length; col++) {
                    let dateCount = 0;
                    let totalCount = 0;
                    
                    // 检查该列的数据
                    for (let row = 1; row < Math.min(20, data.length); row++) {
                        const cellValue = data[row] && data[row][col];
                        if (cellValue) {
                            totalCount++;
                            if (isDateLike(String(cellValue))) {
                                dateCount++;
                            }
                        }
                    }
                    
                    // 如果该列中超过70%的数据是日期格式
                    if (totalCount > 0 && dateCount / totalCount > 0.7) {
                        dateColumnIndex = col;
                        console.log(`启发式方法找到日期列: 列${col}, 日期比例: ${dateCount}/${totalCount}`);
                        break;
                    }
                }
            }
            
            // 智能选择数据起始列 - 优先功率/电能列
            const dataStartCandidates = columnScores
                .filter(scoreObj => scoreObj.dataScore > 0 && scoreObj.index !== dateColumnIndex)
                .sort((a, b) => {
                    // 优先级排序：功率列 > 电能列 > 通用数据列
                    const aPriority = a.columnType === 'power' ? 3 : a.columnType === 'energy' ? 2 : 1;
                    const bPriority = b.columnType === 'power' ? 3 : b.columnType === 'energy' ? 2 : 1;
                    
                    if (aPriority !== bPriority) {
                        return bPriority - aPriority; // 优先级高的在前
                    }
                    return b.dataScore - a.dataScore; // 同优先级按分数排序
                });
            
            if (dataStartCandidates.length > 0) {
                dataStartColumnIndex = dataStartCandidates[0].index;
                console.log(`智能识别数据起始列: 列${dataStartColumnIndex}, 类型: ${dataStartCandidates[0].columnType}, 分数: ${dataStartCandidates[0].dataScore}`);
            } else {
                // 如果没有找到数据起始列，尝试查找包含数字的列
                for (let i = 0; i < headerRow.length; i++) {
                    // 跳过已经识别为日期的列
                    if (i === dateColumnIndex) continue;
                    
                    const headerText = String(headerRow[i]);
                    // 检查是否包含数字
                    if (/\d+/.test(headerText)) {
                        dataStartColumnIndex = i;
                        console.log(`备用方法找到数据起始列: 列${i}`);
                        break;
                    }
                }
            }
            
            // 智能识别数据结束列 - 基于增强的列类型识别
            if (dataStartColumnIndex !== -1) {
                // 获取所有有效的数据列（功率、电能、通用数据列）
                const validDataColumns = columnScores
                    .filter(scoreObj => scoreObj.dataScore > 0 && 
                                      scoreObj.index !== dateColumnIndex &&
                                      scoreObj.index >= dataStartColumnIndex)
                    .sort((a, b) => a.index - b.index); // 按列索引排序
                
                if (validDataColumns.length > 0) {
                    // 找到最后一个连续的数据列
                    let lastConsecutiveIndex = dataStartColumnIndex;
                    
                    for (let i = 0; i < validDataColumns.length; i++) {
                        const currentCol = validDataColumns[i];
                        
                        // 检查是否与前一列连续（允许跳过1-2列的间隔）
                        if (i === 0 || currentCol.index - validDataColumns[i-1].index <= 3) {
                            lastConsecutiveIndex = currentCol.index;
                        } else {
                            break; // 遇到较大间隔，停止
                        }
                    }
                    
                    dataEndColumnIndex = lastConsecutiveIndex;
                    console.log(`智能识别数据结束列: 列${dataEndColumnIndex}, 数据列范围: ${dataStartColumnIndex}-${dataEndColumnIndex}`);
                } else {
                    // 备用方法：查找连续的数字列
                    let consecutiveDataColumns = 0;
                    let maxConsecutive = 0;
                    let bestEndIndex = dataStartColumnIndex;
                    
                    for (let i = dataStartColumnIndex; i < headerRow.length; i++) {
                        if (i === dateColumnIndex) continue;
                        
                        const headerText = String(headerRow[i]).toLowerCase();
                        const isDataColumn = /\d+/.test(headerText) || 
                                           powerKeywords.some(kw => headerText.includes(kw)) ||
                                           energyKeywords.some(kw => headerText.includes(kw)) ||
                                           generalDataKeywords.some(kw => headerText.includes(kw));
                        
                        if (isDataColumn) {
                            consecutiveDataColumns++;
                            if (consecutiveDataColumns > maxConsecutive) {
                                maxConsecutive = consecutiveDataColumns;
                                bestEndIndex = i;
                            }
                        } else {
                            consecutiveDataColumns = 0;
                        }
                    }
                    
                    dataEndColumnIndex = bestEndIndex;
                    console.log(`备用方法识别数据结束列: 列${dataEndColumnIndex}`);
                }
            } else {
                // 如果没有找到数据起始列，默认最后一列为数据结束列
                dataEndColumnIndex = headerRow.length - 1;
                console.log(`默认数据结束列: 列${dataEndColumnIndex}`);
            }
            
            // 识别计量点编号列
            const meteringPointKeywords = ['编号', 'id', '标识', '代码', '设备号', '设备编号', '计量点', '测点', '点位', '序号', 'no'];
            const meteringPointPatterns = [/^\d+$/, /^[A-Za-z]\d+$/, /^\d{4,}$/]; // 纯数字、字母+数字、长数字
            
            // 为每列计算计量点编号列置信度分数
            columnScores.forEach(scoreObj => {
                const headerText = String(headerRow[scoreObj.index]).toLowerCase();
                
                // 计量点编号列评分
                if (meteringPointKeywords.some(keyword => headerText.includes(keyword.toLowerCase()))) {
                    scoreObj.meteringPointScore += 10; // 关键词匹配高分
                }
                
                // 检查计量点编号格式模式
                if (meteringPointPatterns.some(pattern => pattern.test(headerText))) {
                    scoreObj.meteringPointScore += 8; // 格式匹配较高分
                }
                
                // 检查是否包含ID相关缩写
                if (headerText.includes('id') || headerText.includes('no') || headerText.includes('num')) {
                    scoreObj.meteringPointScore += 7; // ID相关缩写匹配
                }
                
                // 检查列位置 - 计量点编号列通常在前几列，但可能在日期列之后
                if (scoreObj.index > 0 && scoreObj.index < 5) {
                    scoreObj.meteringPointScore += 2; // 位置加分
                }
            });
            
            // 根据置信度分数选择计量点编号列
            const meteringPointCandidates = columnScores
                .filter(scoreObj => scoreObj.meteringPointScore > 0 && 
                                 scoreObj.index !== dateColumnIndex && 
                                 scoreObj.index !== dataStartColumnIndex &&
                                 scoreObj.index !== dataEndColumnIndex)
                .sort((a, b) => b.meteringPointScore - a.meteringPointScore);
            
            if (meteringPointCandidates.length > 0) {
                meteringPointColumnIndex = meteringPointCandidates[0].index;
            }
            
            // 如果识别到了列，设置默认值
            if (dateColumnIndex !== -1) {
                elements.dateColumnSelect.value = dateColumnIndex;
                appData.config.dateColumn = dateColumnIndex;
            }
            
            if (dataStartColumnIndex !== -1) {
                elements.dataStartColumnSelect.value = dataStartColumnIndex;
                appData.config.dataStartColumn = dataStartColumnIndex;
            }
            
            if (dataEndColumnIndex !== -1) {
                elements.dataEndColumnSelect.value = dataEndColumnIndex;
                appData.config.dataEndColumn = dataEndColumnIndex;
            }
            
            if (meteringPointColumnIndex !== -1) {
                elements.meteringPointColumnSelect.value = meteringPointColumnIndex;
                appData.config.meteringPointColumn = meteringPointColumnIndex;
            }
            
            // 如果识别到了任何列，触发数据预览
            if (dateColumnIndex !== -1 && dataStartColumnIndex !== -1) {
                updateDataPreview();
                checkConfigValidity();
                
                // 显示详细识别结果
                console.log('=== 智能列识别结果 ===');
                console.log(`日期列索引: ${dateColumnIndex}`);
                console.log(`日期列标题: ${headerRow[dateColumnIndex] || '无标题'}`);
                
                // 显示数据列识别详情
                const selectedDataColumn = columnScores.find(score => score.index === dataStartColumnIndex);
                if (selectedDataColumn) {
                    console.log(`数据起始列索引: ${dataStartColumnIndex}`);
                    console.log(`数据起始列标题: ${headerRow[dataStartColumnIndex] || '无标题'}`);
                    console.log(`识别类型: ${selectedDataColumn.columnType} (功率/电能/通用)`);
                    console.log(`置信度分数: ${selectedDataColumn.dataScore}`);
                }
                
                // 显示所有候选数据列的详细信息
                const allDataCandidates = columnScores
                    .filter(score => score.dataScore > 0 && score.index !== dateColumnIndex)
                    .sort((a, b) => b.dataScore - a.dataScore);
                
                if (allDataCandidates.length > 1) {
                    console.log('=== 其他数据列候选 ===');
                    allDataCandidates.slice(1, 4).forEach((candidate, index) => {
                        console.log(`候选${index + 1}: 列${candidate.index} "${headerRow[candidate.index]}" (${candidate.columnType}, 分数:${candidate.dataScore})`);
                    });
                }
                console.log(`数据起始列: ${dataStartColumnIndex}`);
                console.log(`数据结束列: ${dataEndColumnIndex}`);
                console.log(`计量点列: ${meteringPointColumnIndex}`);
                
                // 显示前几个日期的解析示例
                if (data.length > 1) {
                    console.log('=== 日期解析示例 ===');
                    for (let i = 1; i < Math.min(6, data.length); i++) {
                        if (data[i] && data[i][dateColumnIndex]) {
                            const dateValue = String(data[i][dateColumnIndex]).trim();
                            const parsedDate = parseDate(dateValue, appData.config.dateFormat);
                            console.log(`第${i}行: "${dateValue}" -> ${parsedDate ? formatDateForInput(parsedDate) : '解析失败'}`);
                        }
                    }
                }
            } else {
                console.log('=== 列识别失败 ===');
                console.log('请检查数据格式或手动选择列');
                
                // 显示列信息供调试
                console.log('=== 所有列标题 ===');
                headerRow.forEach((header, index) => {
                    console.log(`列${index}: "${header}"`);
                });
            }
        }

        // 配置部分函数
        function updateDateSelects() {
            // 清空现有选项
            elements.dataStartDate.innerHTML = '<option value="">-- 请选择起始日期 --</option>';
            elements.dataEndDate.innerHTML = '<option value="">-- 请选择结束日期 --</option>';
            
            // 如果没有选择日期列，则返回（注意：列索引0也是有效的）
            if (appData.config.dateColumn === undefined || appData.config.dateColumn === null || appData.config.dateColumn === '') return;
            
            const dateCol = parseInt(appData.config.dateColumn);
            const dateSet = new Set();
            
            // 收集所有唯一的日期
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // 跳过表头行，尝试自动检测数据起始行
                let startRow = 0;
                let dateFoundCount = 0;
                
                for (let i = 0; i < Math.min(15, data.length); i++) {
                    if (data[i] && data[i][dateCol]) {
                        const cellValue = String(data[i][dateCol]).trim();
                        console.log(`检查第${i+1}行日期列: "${cellValue}"`);
                        
                        if (isDateLike(cellValue)) {
                            const parsedDate = parseDate(cellValue, appData.config.dateFormat);
                            console.log(`日期解析结果:`, parsedDate);
                            
                            if (parsedDate) {
                                startRow = i;
                                dateFoundCount++;
                                break;
                            }
                        }
                    }
                }
                
                console.log(`确定数据起始行: ${startRow + 1}, 找到有效日期: ${dateFoundCount}个`);
                
                // 收集日期
                let validDatesFound = 0;
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[dateCol]) continue;
                    
                    const dateStr = String(row[dateCol]).trim();
                    if (!dateStr) continue;
                    
                    // 解析日期
                    const date = parseDate(dateStr, appData.config.dateFormat);
                    if (date) {
                        const dateKey = formatDateForInput(date);
                        dateSet.add(dateKey);
                        validDatesFound++;
                        
                        // 记录前5个解析成功的日期用于调试
                        if (validDatesFound <= 5) {
                            console.log(`成功解析日期 ${validDatesFound}: "${dateStr}" -> "${dateKey}"`);
                        }
                    } else {
                        // 记录解析失败的日期
                        if (validDatesFound <= 5) {
                            console.log(`日期解析失败: "${dateStr}"`);
                        }
                    }
                }
                
                console.log(`工作表中找到的有效日期总数: ${validDatesFound}`);
            });
            
            // 转换为数组并排序
            const dates = Array.from(dateSet).sort();
            
            console.log(`收集到的唯一日期数量: ${dates.length}`);
            console.log(`所有收集到的日期:`, dates);
            
            // 如果没有收集到任何日期，显示提示信息
            if (dates.length === 0) {
                // 添加一个提示选项
                const option1 = document.createElement('option');
                option1.value = "";
                option1.textContent = "-- 未找到有效日期 --";
                option1.disabled = true;
                elements.dataStartDate.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = "";
                option2.textContent = "-- 未找到有效日期 --";
                option2.disabled = true;
                elements.dataEndDate.appendChild(option2);
                
                // 显示通知
                showNotification('提示', '未在数据中找到有效日期，请检查日期列选择和日期格式设置', 'warning');
                return;
            }
            
            // 添加到下拉菜单
            dates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.dataStartDate.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.dataEndDate.appendChild(option2);
            });
            
            // 如果之前有选择的日期，恢复选择
            if (appData.selectedStartDate) {
                elements.dataStartDate.value = appData.selectedStartDate;
            }
            
            if (appData.selectedEndDate) {
                elements.dataEndDate.value = appData.selectedEndDate;
            }
        }

        // 重新设计的数据预览函数
        function updateDataPreview() {
            console.log('=== 开始数据预览更新 ===');
            
            // 防抖/防重入：避免大数据下多次触发导致阻塞
            if (appData.__isUpdatingPreview) {
                console.log('数据预览更新进行中，本次调用已忽略');
                return;
            }
            
            // 检查基础配置
            if (!validateDataConfiguration()) {
                renderWaitingState();
                return;
            }
            
            // 先展示加载提示，避免长时间空白
            if (elements.dataPreview && elements.dataPreview.parentNode) {
                elements.dataPreview.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 px-6">
                        <div class="w-12 h-12 mb-3 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                        <div class="text-sm text-slate-600">正在生成数据预览，请稍候...</div>
                    </div>`;
            }
            
            // 更新日期选择器
            updateDateSelects();
            
            // 异步调度重型解析与渲染，释放UI线程
            appData.__isUpdatingPreview = true;
            setTimeout(() => {
                try {
                    // 解析工作表数据
                    parseWorksheetData();
                    
                    // 检查解析后的数据
                    if (appData.processedData.length === 0) {
                        renderNoDataState();
                        return;
                    }
                    
                    // 渲染数据预览界面
                    renderDataPreview();
                    
                    // 更新按钮状态
                    updatePreviewButtons();
                    
                    console.log('=== 数据预览更新完成 ===');
                } finally {
                    appData.__isUpdatingPreview = false;
                }
            }, 0);
        }
        
        // 验证数据配置
        function validateDataConfiguration() {
            const hasWorksheets = Array.isArray(appData.worksheets) && appData.worksheets.length > 0;
            const hasDateColumn = appData.config.dateColumn !== undefined && appData.config.dateColumn !== null && appData.config.dateColumn !== '';
            const hasDataStartColumn = appData.config.dataStartColumn !== undefined && appData.config.dataStartColumn !== null && appData.config.dataStartColumn !== '';
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked')?.value;
            
            // 对于列对行结构，需要数据结束列；对于列对列结构，不需要
            let hasRequiredColumns = true;
            if (dataStructure === 'columnToRow') {
                hasRequiredColumns = (appData.config.dataEndColumn !== undefined && appData.config.dataEndColumn !== null && appData.config.dataEndColumn !== '');
            }
            
            console.log('验证配置状态:');
            console.log('- 工作表:', hasWorksheets);
            console.log('- 日期列:', hasDateColumn);
            console.log('- 数据开始列:', hasDataStartColumn);
            console.log('- 数据结构:', dataStructure);
            console.log('- 必需列配置:', hasRequiredColumns);
            
            return hasWorksheets && hasDateColumn && hasDataStartColumn && hasRequiredColumns;
        }
        
        // 渲染等待配置状态
        function renderWaitingState() {
            elements.dataPreview.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-8">
                    <div class="w-20 h-20 mb-6 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl flex items-center justify-center shadow-lg">
                        <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3">等待数据配置</h3>
                    <p class="text-sm text-slate-600 text-center max-w-lg leading-relaxed mb-6">
                        请完成以下步骤以开始数据预览：<br>
                        1. 导入Excel文件<br>
                        2. 配置日期列和数据开始列<br>
                        3. 如选择"列对行"结构，还需配置数据结束列
                    </p>
                    <div class="flex space-x-2">
                        <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-3 h-3 bg-indigo-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
        }
        
        // 渲染无数据状态
        function renderNoDataState() {
            elements.dataPreview.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-8">
                    <div class="w-20 h-20 mb-6 bg-gradient-to-br from-amber-100 to-orange-100 rounded-2xl flex items-center justify-center shadow-lg">
                        <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-3">暂无有效数据</h3>
                    <p class="text-sm text-slate-600 text-center max-w-lg leading-relaxed">
                        当前配置下没有找到可预览的数据。<br>
                        请检查数据源文件或调整配置参数。
                    </p>
                </div>
            `;
        }
        
        // 渲染数据预览界面
        function renderDataPreview() {
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // 构建预览HTML
            let previewHtml = buildDataSummaryHeader();
            previewHtml += buildDataTable(dataStructure);
            previewHtml += buildDataStatistics();
            
            elements.dataPreview.innerHTML = previewHtml;
            
            // 添加交互功能
            attachDataPreviewEvents();
        }
        
        // 构建数据汇总头部
        function buildDataSummaryHeader() {
            const totalRecords = appData.processedData.length;
            const dateRange = getDataDateRange();
            
            let headerHtml = `
                <div class="bg-gradient-to-r from-emerald-50 via-blue-50 to-purple-50 p-6 mb-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                            <h3 class="text-lg font-bold text-slate-800">数据预览</h3>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-slate-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <span>总计 <span class="font-bold text-blue-600">${totalRecords}</span> 条记录</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white/70 backdrop-blur-sm p-4 rounded-xl border border-slate-200">
                            <div class="text-sm text-slate-600 mb-1">数据范围</div>
                            <div class="font-semibold text-slate-800">${dateRange}</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm p-4 rounded-xl border border-slate-200">
                            <div class="text-sm text-slate-600 mb-1">数据结构</div>
                            <div class="font-semibold text-slate-800">${getDataStructureLabel()}</div>
                        </div>
                        <div class="bg-white/70 backdrop-blur-sm p-4 rounded-xl border border-slate-200">
                            <div class="text-sm text-slate-600 mb-1">筛选状态</div>
                            <div class="font-semibold text-slate-800">${getFilterStatus()}</div>
                        </div>
                    </div>`;
            
            // 添加清除筛选按钮
            if (appData.selectedStartDate || appData.selectedEndDate) {
                headerHtml += `
                    <div class="mt-4 flex justify-end">
                        <button onclick="clearDateRange()" class="px-4 py-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-sm font-medium rounded-xl hover:from-red-600 hover:to-pink-600 transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105 flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>清除日期筛选</span>
                        </button>
                    </div>`;
            }
            
            headerHtml += `</div>`;
            return headerHtml;
        }
        
        // 构建数据表格
         function buildDataTable(dataStructure) {
             let tableHtml = `<div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden mb-6">`;
             tableHtml += `<div class="max-h-96 overflow-auto">`;
             
             if (dataStructure === 'columnToRow') {
                 tableHtml += buildHourlyDataTable();
             } else {
                 tableHtml += buildSummaryDataTable();
             }
             
             tableHtml += `</div></div>`;
             return tableHtml;
         }
         
         // 构建24小时数据表格
         function buildHourlyDataTable() {
             let tableHtml = `<div class="grid" style="grid-template-columns: 120px repeat(24, 80px) 120px; min-width: fit-content;">`;
             
             // 表头
             tableHtml += `<div class=\"bg-slate-100 border-b border-r border-slate-200 px-3 py-3 text-center font-semibold text-slate-800 sticky top-0 z-10 text-sm shadow-sm\">日期</div>`;
             for (let hour = 0; hour < 24; hour++) {
                tableHtml += `<div class=\"bg-slate-100 border-b border-r border-slate-200 px-2 py-3 text-center font-semibold text-slate-800 sticky top-0 z-10 text-sm shadow-sm\">${hour}:00</div>`;
            }
             tableHtml += `<div class=\"bg-slate-100 border-b border-r border-slate-200 px-3 py-3 text-center font-semibold text-slate-800 sticky top-0 z-10 text-sm shadow-sm\">日总电能 (kWh)</div>`;
             
             // 仅预览前100条，避免大数据渲染阻塞
             const previewLimit = 100;
             const rows = appData.processedData.slice(0, previewLimit);
             
             // 数据行
             rows.forEach((row, index) => {
                 const isSelected = appData.selectedStartDate && appData.selectedEndDate && 
                                   row.date >= appData.selectedStartDate && 
                                   row.date <= appData.selectedEndDate;
                 const rowBgClass = isSelected ? 'bg-blue-50' : (index % 2 === 0 ? 'bg-white' : 'bg-slate-50');
                 
                 // 日期列
                 tableHtml += `<div class=\"${rowBgClass} border-b border-r border-slate-200 px-3 py-3 text-center font-medium hover:bg-slate-100 transition-colors cursor-pointer\" data-date=\"${row.date}\">${row.date}</div>`;
                 
                 // 24小时数据列
                 let dayTotal = 0;
                 for (let hour = 0; hour < 24; hour++) {
                     const value = row.hourlyData[hour];
                     const displayValue = (value !== null && value !== undefined) ? value.toFixed(2) : '-';
                     const textClass = (value !== null && value !== undefined) ? 'text-slate-900' : 'text-slate-400';
                     const bgClass = (value !== null && value !== undefined) ? 
                         (value > 0 ? 'hover:bg-green-50' : 'hover:bg-slate-100') : 'hover:bg-slate-100';
                     tableHtml += `<div class=\"${rowBgClass} border-b border-r border-slate-200 px-2 py-3 text-center ${textClass} ${bgClass} transition-colors text-sm\">${displayValue}</div>`;
                     if (value !== null && value !== undefined) {
                         dayTotal += value;
                     }
                 }
                 
                 // 日总电能列
                 tableHtml += `<div class=\"${rowBgClass} border-b border-r border-slate-200 px-3 py-3 text-center font-semibold text-blue-600 hover:bg-blue-50 transition-colors text-sm\">${dayTotal.toFixed(2)}</div>`;
             });
             
             tableHtml += `</div>`;
             
             // 大数据提示
             if (appData.processedData.length > previewLimit) {
                tableHtml += `<div class=\"px-4 py-2 text-xs text-slate-500 bg-slate-50 border border-t-0 border-slate-200 rounded-b-2xl\">为保证性能，预览仅显示前 ${previewLimit} 条记录（实际共 ${appData.processedData.length} 条）。</div>`;
             }
             return tableHtml;
         }
         
         // 构建汇总数据表格
         function buildSummaryDataTable() {
             // 统一使用24小时详细数据表格，而不是汇总表格
             return buildHourlyDataTable();
         }
         
         // 构建数据统计信息
          function buildDataStatistics() {
              if (appData.processedData.length === 0) return '';
              
              const totalRecords = appData.processedData.length;
              const validDataCount = appData.processedData.reduce((sum, row) => {
                  return sum + row.hourlyData.filter(v => v !== null && v !== undefined).length;
              }, 0);
              const totalEnergy = appData.processedData.reduce((sum, row) => sum + (row.dailyTotal || 0), 0);
              const avgDailyEnergy = totalEnergy / totalRecords;
              
              return `
                  <div class="bg-gradient-to-r from-slate-50 to-gray-50 p-6 rounded-2xl border border-slate-200 shadow-sm">
                      <div class="flex items-center justify-center mb-4">
                          <svg class="w-5 h-5 text-slate-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                          </svg>
                          <h4 class="text-lg font-bold text-slate-800">数据统计</h4>
                      </div>
                      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div class="text-center">
                              <div class="text-2xl font-bold text-blue-600">${totalRecords}</div>
                              <div class="text-sm text-slate-600">总天数</div>
                          </div>
                          <div class="text-center">
                              <div class="text-2xl font-bold text-green-600">${validDataCount}</div>
                              <div class="text-sm text-slate-600">有效数据点</div>
                          </div>
                          <div class="text-center">
                              <div class="text-2xl font-bold text-purple-600">${totalEnergy.toFixed(1)}</div>
                              <div class="text-sm text-slate-600">总电能 (kWh)</div>
                          </div>
                          <div class="text-center">
                              <div class="text-2xl font-bold text-orange-600">${avgDailyEnergy.toFixed(1)}</div>
                              <div class="text-sm text-slate-600">日均电能 (kWh)</div>
                          </div>
                      </div>
                  </div>
              `;
          }
          
          // 获取数据日期范围
          function getDataDateRange() {
              if (appData.processedData.length === 0) return '无数据';
              const firstDate = appData.processedData[0].date;
              const lastDate = appData.processedData[appData.processedData.length - 1].date;
              return firstDate === lastDate ? firstDate : `${firstDate} ~ ${lastDate}`;
          }
          
          // 获取数据结构标签
          function getDataStructureLabel() {
              const dataStructure = document.querySelector('input[name="dataStructure"]:checked')?.value;
              return dataStructure === 'columnToRow' ? '列对行 (24小时)' : '列对列 (汇总)';
          }
          
          // 获取筛选状态
          function getFilterStatus() {
              if (appData.selectedStartDate && appData.selectedEndDate) {
                  return `已筛选 (${appData.selectedStartDate} ~ ${appData.selectedEndDate})`;
              } else if (appData.selectedStartDate) {
                  return `起始日期: ${appData.selectedStartDate}`;
              } else if (appData.selectedEndDate) {
                  return `结束日期: ${appData.selectedEndDate}`;
              }
              return '无筛选';
          }
          
          // 添加数据预览交互事件
          function attachDataPreviewEvents() {
              // 日期点击事件 - 可以扩展为选择日期范围
              const dateCells = document.querySelectorAll('[data-date]');
              dateCells.forEach(cell => {
                  cell.addEventListener('click', function() {
                      const date = this.getAttribute('data-date');
                      console.log('点击日期:', date);
                      // 可以在这里添加日期选择逻辑
                  });
              });
          }
          
          // 清除日期范围筛选
          window.clearDateRange = function() {
              appData.selectedStartDate = null;
              appData.selectedEndDate = null;
              elements.dataStartDate.value = '';
              elements.dataEndDate.value = '';
              updateDataPreview();
              showNotification('信息', '已清除日期筛选，显示全部数据', 'info');
          };
          
          // 更新按钮状态
          function updatePreviewButtons() {
              if (appData.parsedData.length > 0) {
                  elements.previewFirstHourCalculationBtn.disabled = false;
                  elements.previewFirstDayCalculationBtn.disabled = false;
              } else {
                  elements.previewFirstHourCalculationBtn.disabled = true;
                  elements.previewFirstDayCalculationBtn.disabled = true;
              }
          }
        
          // 更新数据状态显示
          updateDataOverview();

      function parseWorksheetData() {
    // 只在非追加模式下清除数据
    const appendMode = document.getElementById('appendMode')?.checked || false;
    if (!appendMode) {
        appData.parsedData = [];
        appData.processedData = [];
    } else {
        // 追加模式下不清除现有数据，但确保数组存在
        appData.parsedData = appData.parsedData || [];
        appData.processedData = appData.processedData || [];
    }
    
    // 获取数据结构类型
    const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
    
    appData.worksheets.forEach(worksheet => {
        const { data } = worksheet;
        const dateCol = parseInt(appData.config.dateColumn);
        const startCol = parseInt(appData.config.dataStartColumn);
        const endCol = parseInt(appData.config.dataEndColumn);
        
        // 解析用户选择的索引范围，优先级：数据行索引 > 日期范围 > 全部数据
        let startIndex = 0;
        let endIndex = data.length - 1;
        
        console.log(`工作表 ${worksheet.name || '未命名'}:`);
        console.log(`- 原始数据总行数: ${data.length}`);
        console.log(`- 选择的日期范围: ${appData.selectedStartDate || '未选择'} 到 ${appData.selectedEndDate || '未选择'}`);
        console.log(`- 数据行索引范围: ${appData.config.dataStartIndex || 0} 到 ${appData.config.dataEndIndex || -1}`);
        
        // 检查是否设置了非默认的数据行索引范围（优先级最高）
        const userStartIndex = parseInt(appData.config.dataStartIndex) || 0;
        const userEndIndex = appData.config.dataEndIndex === -1 ? data.length - 1 : parseInt(appData.config.dataEndIndex);
        
        // 如果用户设置了非默认的索引范围，优先使用
        const isUsingCustomIndexRange = userStartIndex !== 0 || (appData.config.dataEndIndex !== -1 && userEndIndex !== (data.length - 1));
        
        if (isUsingCustomIndexRange) {
            startIndex = Math.max(0, Math.min(userStartIndex, data.length - 1));
            endIndex = Math.max(startIndex, Math.min(userEndIndex, data.length - 1));
            console.log(`- 使用用户指定的行索引范围: ${startIndex} 到 ${endIndex}`);
            
            // 如果索引范围无效，给出警告
            if (startIndex >= data.length || endIndex < 0 || startIndex > endIndex) {
                showNotification('警告', '指定的行索引范围无效，将使用全部数据', 'warning');
                startIndex = 0;
                endIndex = data.length - 1;
            }
        } else if (appData.selectedStartDate && appData.selectedEndDate) {
            // 如果用户设置了日期范围，使用日期筛选
            let startFound = false;
            let endFound = false;
            
            // 将选择的日期范围转换为日期对象（确保包含边界）
            const selectedStart = new Date(appData.selectedStartDate);
            const selectedEnd = new Date(appData.selectedEndDate);
            
            // 设置时间为0时0分0秒，确保包含整天
            selectedStart.setHours(0, 0, 0, 0);
            selectedEnd.setHours(23, 59, 59, 999);
            
            // 收集所有在日期范围内的行索引
            const dateRangeIndices = [];
            
            console.log(`- 正在筛选日期范围: ${selectedStart.toISOString()} 到 ${selectedEnd.toISOString()}`);
            console.log(`- 日期格式: ${appData.config.dateFormat}`);
            
            // 首先收集所有有效的日期和行索引
            const allValidDates = [];
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 解析日期
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) {
                    console.log(`- 第${i}行日期解析失败: "${dateStr}"`);
                    continue;
                }
                
                // 标准化日期（去除时间部分，只保留年月日）
                const normalizedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                normalizedDate.setHours(0, 0, 0, 0); // 确保时间部分为0
                
                // 保存有效日期信息
                allValidDates.push({
                    index: i,
                    dateStr: dateStr,
                    date: normalizedDate,
                    formattedDate: formatDateForInput(normalizedDate)
                });
                
                // 检查日期是否在选择的范围内（包含边界）
                if (normalizedDate >= selectedStart && normalizedDate <= selectedEnd) {
                    dateRangeIndices.push(i);
                }
            }
            
            console.log(`- 找到 ${allValidDates.length} 条有效日期记录`);
            console.log(`- 找到 ${dateRangeIndices.length} 条匹配的记录`);
            
            // 如果在范围内找到数据，设置起始和结束索引
            if (dateRangeIndices.length > 0) {
                startIndex = Math.min(...dateRangeIndices);
                endIndex = Math.max(...dateRangeIndices);
                startFound = true;
                endFound = true;
            }
            
            // 确保索引在有效范围内
            startIndex = Math.max(0, Math.min(startIndex, data.length - 1));
            endIndex = Math.max(startIndex, Math.min(endIndex, data.length - 1));
            
            // 如果没有找到任何匹配的记录，检查可能的原因
            if (dateRangeIndices.length === 0) {
                // 收集所有唯一的日期样本用于调试
                const dateSamples = allValidDates.slice(0, 10).map(item => item.dateStr);
                const formattedSamples = allValidDates.slice(0, 10).map(item => item.formattedDate);
                
                console.log(`- 前10行的日期样本:`, dateSamples);
                console.log(`- 前10行的格式化日期样本:`, formattedSamples);
                console.log(`- 选择的日期范围: ${appData.selectedStartDate} 到 ${appData.selectedEndDate}`);
                
                // 检查是否所有日期都在选择范围之外
                const allBeforeRange = allValidDates.every(item => item.date < selectedStart);
                const allAfterRange = allValidDates.every(item => item.date > selectedEnd);
                
                if (allBeforeRange) {
                    showNotification('警告', '所有数据都在选择的日期范围之前，将使用全部数据', 'warning');
                } else if (allAfterRange) {
                    showNotification('警告', '所有数据都在选择的日期范围之后，将使用全部数据', 'warning');
                } else {
                    showNotification('警告', '未找到选择的日期范围，将使用全部数据', 'warning');
                }
                
                startIndex = 0;
                endIndex = data.length - 1;
            }
            
            console.log(`- 日期范围筛选结果: 找到 ${dateRangeIndices.length} 条记录`);
            console.log(`- 使用的行索引范围: ${startIndex} 到 ${endIndex}`);
        } else {
            // 默认使用全部数据
            startIndex = 0;
            endIndex = data.length - 1;
            console.log(`- 使用默认行索引范围: ${startIndex} 到 ${endIndex}`);
        }
        const meteringPointCol = appData.config.meteringPointColumn ? parseInt(appData.config.meteringPointColumn) : null;
        const multiplierCol = appData.config.useMultiplierColumn && appData.config.multiplierColumn ? parseInt(appData.config.multiplierColumn) : null;
        const selectedMeteringPoint = appData.config.meteringPointFilter;
        
        if (dataStructure === 'columnToRow') {
            // 原有的列对行数据处理逻辑
            const dataColumnCount = endCol - startCol + 1;
            
            // 检查是否启用了跨日期结构数据选项
            const isCrossDateStructure = document.getElementById('crossDateStructure') && document.getElementById('crossDateStructure').checked;
            
            // 增强的智能时间间隔检测
            const detectionResult = detectTimeIntervalIntelligently(data, startIndex, endIndex, dateCol, meteringPointCol, selectedMeteringPoint, isCrossDateStructure, dataColumnCount);
            
            let autoDetectedInterval = detectionResult.interval;
            let intervalDescription = detectionResult.description;
            
            // 显示增强的检测结果通知
            showEnhancedIntervalNotification(detectionResult);
            
            // 如果有候选间隔，显示候选信息
            if (detectionResult.candidates && detectionResult.candidates.length > 0) {
                const candidateInfo = detectionResult.candidates
                    .map(c => `${c.description}(${Math.round(c.confidence * 100)}%)`)
                    .join('、');
                setTimeout(() => {
                    showNotification('🔍 其他候选间隔', `检测到的其他可能间隔：${candidateInfo}\n如果主要检测结果不准确，可手动选择这些候选间隔`, 'info');
                }, 2500);
            }
            
            // 更新时间间隔配置
            appData.config.timeInterval = autoDetectedInterval;
            elements.timeIntervalSelect.value = autoDetectedInterval;
            
            // 跳过表头行，尝试自动检测数据起始行
            let startRow = startIndex;
            for (let i = startIndex; i < Math.min(startIndex + 10, data.length); i++) {
                if (data[i] && data[i][dateCol] && isDateLike(data[i][dateCol])) {
                    startRow = i;
                    break;
                }
            }
            
            // 处理每一行数据
            for (let i = startRow; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 检查计量点编号筛选
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) {
                        continue; // 跳过不匹配的行
                    }
                }
                
                // 检查附加筛选项
                let skipRow = false;
                appData.config.additionalFilters.forEach(filter => {
                    if (filter.column && filter.value) {
                        const col = parseInt(filter.column);
                        const rowValue = String(row[col]).trim();
                        if (rowValue !== filter.value) {
                            skipRow = true;
                        }
                    }
                });
                
                if (skipRow) {
                    continue; // 跳过不匹配的行
                }
                
                // 解析日期
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) continue;
                

                // 获取倍率值
                let multiplier = appData.config.multiplier;
                if (multiplierCol !== null && row[multiplierCol] !== undefined) {
                    const parsedMultiplier = parseNumber(row[multiplierCol]);
                    if (parsedMultiplier !== null) {
                        multiplier = parsedMultiplier;
                    }
                }
                
                // 提取数据列
                const dataValues = [];
                for (let j = startCol; j <= endCol && j < row.length; j++) {
                    const value = parseNumber(row[j]);
                    dataValues.push(value);
                }
                
                // 验证数据点数量
                const expectedPoints = dataColumnCount; // 使用计算出的数据列数量
                if (dataValues.length < expectedPoints * 0.8) { // 允许20%的数据缺失
                    console.warn(`数据点不足，日期: ${dateStr}, 实际: ${dataValues.length}, 预期: ${expectedPoints}`);
                    continue;
                }
                
                // 添加到解析数据
                appData.parsedData.push({
                    date: date,
                    dateStr: dateStr,
                    rawData: dataValues,
                    multiplier: multiplier,
                    sourceFile: worksheet.file.name,
                    meteringPoint: meteringPointCol !== null ? String(row[meteringPointCol]).trim() : null,
                    timeInterval: autoDetectedInterval, // 保存自动检测到的时间间隔
                    dataStructure: 'columnToRow' // 标记数据结构类型
                });
            }
        } else {
            // 新的列对列数据处理逻辑
            // 对于列对列结构，日期在某一列，数据在另一列
            const dataCol = parseInt(appData.config.dataStartColumn); // 只使用起始列作为数据列
            
            // 跳过表头行，尝试自动检测数据起始行
            let startRow = startIndex;
            for (let i = startIndex; i < Math.min(startIndex + 10, data.length); i++) {
                if (data[i] && data[i][dateCol] && isDateLike(data[i][dateCol])) {
                    startRow = i;
                    break;
                }
            }
            
            // 对于列对列结构，使用用户选择的时间间隔而不是自动检测
            const timeInterval = parseInt(appData.config.timeInterval);
            
            // 按日期分组处理数据
            const dateGroups = {};
            
            // 处理每一行数据
            for (let i = startRow; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 检查计量点编号筛选
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) {
                        continue; // 跳过不匹配的行
                    }
                }
                
                // 检查附加筛选项
                let skipRow = false;
                appData.config.additionalFilters.forEach(filter => {
                    if (filter.column && filter.value) {
                        const col = parseInt(filter.column);
                        const rowValue = String(row[col]).trim();
                        if (rowValue !== filter.value) {
                            skipRow = true;
                        }
                    }
                });
                
                if (skipRow) {
                    continue; // 跳过不匹配的行
                }
                
                // 解析日期和时间
                const dateTimeStr = String(row[dateCol]).trim();
                const dateTime = parseDateTime(dateTimeStr, appData.config.dateFormat);
                if (!dateTime) continue;
                
                // 提取日期部分作为分组键
                const dateKey = formatDateKey(dateTime);
                
                // 获取倍率值
                let multiplier = appData.config.multiplier;
                if (multiplierCol !== null && row[multiplierCol] !== undefined) {
                    const parsedMultiplier = parseNumber(row[multiplierCol]);
                    if (parsedMultiplier !== null) {
                        multiplier = parsedMultiplier;
                    }
                }
                
                // 提取数据值
                const value = parseNumber(row[dataCol]);
                if (value === null) continue;
                
                // 初始化日期分组（如果不存在）
                if (!dateGroups[dateKey]) {
                    dateGroups[dateKey] = {
                        date: new Date(dateTime),
                        dateStr: dateKey,
                        dataPoints: [],
                        multiplier: multiplier,
                        sourceFile: worksheet.file.name,
                        meteringPoint: meteringPointCol !== null ? String(row[meteringPointCol]).trim() : null,
                        timeInterval: timeInterval, // 使用用户选择的时间间隔
                        dataStructure: 'columnToColumn' // 标记数据结构类型
                    };
                }
                
                // 添加数据点到日期分组
                dateGroups[dateKey].dataPoints.push({
                    time: dateTime,
                    value: value
                });
            }
            
            // 将分组数据转换为解析数据格式
            Object.values(dateGroups).forEach(group => {
                // 按时间排序数据点
                group.dataPoints.sort((a, b) => a.time - b.time);
                
                // 添加到解析数据
                appData.parsedData.push({
                    date: group.date,
                    dateStr: group.dateStr,
                    rawData: group.dataPoints.map(p => p.value),
                    multiplier: group.multiplier,
                    sourceFile: group.sourceFile,
                    meteringPoint: group.meteringPoint,
                    timeInterval: group.timeInterval,
                    dataStructure: 'columnToColumn', // 标记数据结构类型
                    dataPoints: group.dataPoints // 保存原始数据点，包含时间信息
                });
            });
        }
    });
    
    // 按日期排序
    appData.parsedData.sort((a, b) => a.date - b.date);
    
    // 处理数据生成小时级数据
    processParsedData();
}

        function processParsedData() {
    appData.processedData = [];
    
    appData.parsedData.forEach(parsedRow => {
        const dataStructure = parsedRow.dataStructure || 'columnToRow'; // 默认为列对行结构
        const interval = parsedRow.timeInterval || appData.config.timeInterval;
        
        if (dataStructure === 'columnToRow') {
            // 原有的列对行数据处理逻辑
            let pointsPerHour;
            
            // 根据时间间隔计算每小时数据点数
            if (interval === 1) {
                pointsPerHour = 60; // 每小时60个数据点（每分钟一个）
            } else if (interval === 5) {
                pointsPerHour = 12; // 每小时12个数据点（每5分钟一个）
            } else if (interval === 15) {
                pointsPerHour = 4; // 每小时4个数据点（每15分钟一个）
            } else if (interval === 30) {
                pointsPerHour = 2; // 每小时2个数据点（每30分钟一个）
            } else if (interval === 60) {
                pointsPerHour = 1; // 每小时1个数据点（每60分钟一个）
            } else {
                pointsPerHour = Math.floor(60 / interval); // 计算每小时数据点数
            }
            
            const hourlyData = [];
            let processedRawData = parsedRow.rawData;
            
            // 检查是否为跨日期结构数据
            const isCrossDateStructure = document.getElementById('crossDateStructure') && document.getElementById('crossDateStructure').checked;
            
            // 如果是跨日期结构数据，需要确保时间序列的逻辑正确性
            if (isCrossDateStructure && interval === 15) {
                // 对于15分钟间隔的跨日期结构数据，每4个单元格组合为1小时数据组
                // 需要确保数据的时间顺序正确，避免时间顺序颠倒
                
                // 将数据按小时分组（每4个数据点为一小时）
                const totalHours = Math.floor(processedRawData.length / pointsPerHour);
                
                for (let hour = 0; hour < totalHours; hour++) {
                    const startIdx = hour * pointsPerHour;
                    const endIdx = startIdx + pointsPerHour;
                    const hourData = processedRawData.slice(startIdx, endIdx);
                    
                    // 处理无效数据
                    const fillMethod = appData.config.invalidDataHandling === 'ignore' ? 'ignore' : 'interpolate';
                    const cleanedData = DataUtils.cleanData(hourData, { fillMethod });
                    
                    // 根据数据类型计算小时电能
                    let hourlyValue;
                    
                    if (appData.config.dataType === 'instantPower') {
                        // 瞬时功率数据 (kW)
                        const validData = cleanedData.filter(v => v !== null);
                        if (validData.length === 0) {
                            hourlyValue = null; // 标记为无效
                        } else {
                            const sum = validData.reduce((a, b) => a + b, 0);
                            const avgPower = sum / validData.length; // 计算平均功率
                            hourlyValue = avgPower * 1 * parsedRow.multiplier; // 平均功率×1小时×倍率
                        }
                    } else {
                        // 累积电能数据 (kWh)
                        if (cleanedData.length < 2) {
                            hourlyValue = null; // 数据不足
                        } else {
                            const startValue = cleanedData[0];
                            const endValue = cleanedData[cleanedData.length - 1];
                            
                            if (startValue === null || endValue === null) {
                                hourlyValue = null; // 起始或结束值无效
                            } else if (endValue < startValue) {
                                // 累积值回退，标记为异常
                                console.warn(`累积值异常，日期: ${parsedRow.dateStr}, 小时: ${hour}`);
                                hourlyValue = null;
                            } else {
                                hourlyValue = (endValue - startValue) * parsedRow.multiplier;
                            }
                        }
                    }
                    
                    hourlyData.push(hourlyValue);
                }
                
                // 如果数据不足24小时，用null填充剩余小时
                while (hourlyData.length < 24) {
                    hourlyData.push(null);
                }
            } else {
                // 非跨日期结构数据或其他时间间隔的常规处理
                // 处理每小时数据
                for (let hour = 0; hour < 24; hour++) {
                    const startIdx = hour * pointsPerHour;
                    const endIdx = startIdx + pointsPerHour;
                    const hourData = processedRawData.slice(startIdx, endIdx);
                    
                    // 处理无效数据
                    const fillMethod = appData.config.invalidDataHandling === 'ignore' ? 'ignore' : 'interpolate';
                    const cleanedData = DataUtils.cleanData(hourData, { fillMethod });
                    
                    // 根据数据类型计算小时电能
                    let hourlyValue;
                    
                    if (appData.config.dataType === 'instantPower') {
                        // 瞬时功率数据 (kW)
                        if (interval === 1) {
                            // 1分钟间隔特殊处理：获取第一个小时所有数据点，过滤无效数据后计算总和，通过总和除以有效数据点数得到平均功率，再乘以1小时和倍率
                            const validData = cleanedData.filter(v => v !== null);
                            if (validData.length === 0) {
                                hourlyValue = null; // 标记为无效
                            } else {
                                const sum = validData.reduce((a, b) => a + b, 0);
                                const avgPower = sum / validData.length; // 计算平均功率
                                hourlyValue = avgPower * 1 * parsedRow.multiplier; // 平均功率×1小时×倍率
                            }
                        } else {
                            // 其他间隔：计算(求和结果 ÷ 数据点数) × 1小时 × 倍率 → kWh
                            const validData = cleanedData.filter(v => v !== null);
                            if (validData.length === 0) {
                                hourlyValue = null; // 标记为无效
                            } else {
                                const sum = validData.reduce((a, b) => a + b, 0);
                                const avgPower = sum / validData.length;
                                hourlyValue = avgPower * 1 * parsedRow.multiplier; // 平均功率×1小时×倍率
                            }
                        }
                    } else {
                        // 累积电能数据 (kWh)
                        if (interval === 1) {
                            // 1分钟间隔特殊处理：将每小时内第46-60个单元格数据之和减去第1-15个单元格数据之和，作为1小时一组的数据
                            if (cleanedData.length < 60) {
                                hourlyValue = null; // 数据不足
                            } else {
                                // 第一组：1-15分钟
                                const firstQuarter = cleanedData.slice(0, 15).filter(v => v !== null);
                                // 第二组：46-60分钟
                                const lastQuarter = cleanedData.slice(45, 60).filter(v => v !== null);
                                
                                if (firstQuarter.length === 0 || lastQuarter.length === 0) {
                                    hourlyValue = null; // 数据不足
                                } else {
                                    const firstSum = firstQuarter.reduce((a, b) => a + b, 0);
                                    const lastSum = lastQuarter.reduce((a, b) => a + b, 0);
                                    hourlyValue = (lastSum - firstSum) * parsedRow.multiplier;
                                }
                            }
                        } else {
                            // 其他间隔：计算(当前小时末 - 当前小时初) × 倍率 → kWh
                            if (cleanedData.length < 2) {
                                hourlyValue = null; // 数据不足
                            } else {
                                const startValue = cleanedData[0];
                                const endValue = cleanedData[cleanedData.length - 1];
                                
                                if (startValue === null || endValue === null) {
                                    hourlyValue = null; // 起始或结束值无效
                                } else if (endValue < startValue) {
                                    // 累积值回退，标记为异常
                                    console.warn(`累积值异常，日期: ${parsedRow.dateStr}, 小时: ${hour}`);
                                    hourlyValue = null;
                                } else {
                                    hourlyValue = (endValue - startValue) * parsedRow.multiplier;
                                }
                            }
                        }
                    }
                    
                    hourlyData.push(hourlyValue);
                }
            }
            
            // 计算日总电能
            const validHourlyData = hourlyData.filter(v => v !== null);
            const dailyTotal = validHourlyData.reduce((a, b) => a + b, 0);
            
            console.log(`=== 日总电能计算调试 (${parsedRow.dateStr}) ===`);
            console.log('有效小时数据点数:', validHourlyData.length);
            console.log('有效小时数据样本:', validHourlyData.slice(0, 5));
            console.log('计算得到的dailyTotal:', dailyTotal);
            
            // 确保日期格式统一为 YYYY-MM-DD
            let formattedDate = parsedRow.dateStr;
            if (typeof parsedRow.dateStr === 'string') {
                const dateStr = parsedRow.dateStr;
                if (dateStr.length === 8 && !dateStr.includes('-')) {
                    // 格式：20240901 -> 2024-09-01
                    formattedDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                } else if (dateStr.length === 10 && dateStr.includes('/')) {
                    // 格式：2024/09/01 -> 2024-09-01
                    formattedDate = dateStr.replace(/\//g, '-');
                } else {
                    formattedDate = dateStr;
                }
            }
            
            appData.processedData.push({
                date: formattedDate,
                dateObj: parsedRow.date,
                hourlyData: hourlyData,
                dailyTotal: dailyTotal,
                sourceFile: parsedRow.sourceFile,
                meteringPoint: (parsedRow.meteringPoint === undefined || parsedRow.meteringPoint === null || String(parsedRow.meteringPoint).trim() === '') ? '默认计量点' : String(parsedRow.meteringPoint).trim(),
                timeInterval: interval, // 保存时间间隔信息
                dataStructure: 'columnToRow' // 标记数据结构类型
            });
        } else {
            // 按照精确计算规则重构列对列数据处理
            const hourlyData = new Array(24).fill(null);
            
            // 根据时间间隔计算每小时数据点数
            let pointsPerHour;
            if (interval === 1) {
                pointsPerHour = 60; // 1分钟间隔：每小时60个数据点
            } else if (interval === 5) {
                pointsPerHour = 12; // 5分钟间隔：每小时12个数据点
            } else if (interval === 15) {
                pointsPerHour = 4; // 15分钟间隔：每小时4个数据点
            } else if (interval === 30) {
                pointsPerHour = 2; // 30分钟间隔：每小时2个数据点
            } else if (interval === 60) {
                pointsPerHour = 1; // 60分钟间隔：每小时1个数据点
            } else {
                pointsPerHour = Math.floor(60 / interval);
            }
            
            // 确保数据点总数正确（1440个为1分钟间隔，96个为15分钟间隔等）
            const expectedTotalPoints = 24 * pointsPerHour;
            
            // 处理每个数据点
            if (parsedRow.dataPoints && parsedRow.dataPoints.length >= expectedTotalPoints) {
                const allPoints = parsedRow.dataPoints;
                
                if (appData.config.dataType === 'instantPower') {
                    // 瞬时功率数据处理
                    for (let hour = 0; hour < 24; hour++) {
                        // 计算当前小时的数据点范围
                        const startIndex = hour * pointsPerHour;
                        const endIndex = startIndex + pointsPerHour;
                        
                        // 获取当前小时的连续数据点
                        const hourPoints = allPoints.slice(startIndex, endIndex)
                            .map(p => p.value)
                            .filter(v => v !== null && !isNaN(v));
                        
                        if (hourPoints.length > 0) {
                            // 计算有效数据的平均值
                            const sum = hourPoints.reduce((a, b) => a + b, 0);
                            const avgValue = sum / hourPoints.length;
                            
                            // 计算小时用电量：平均值 × 1小时 × 倍率
                            hourlyData[hour] = avgValue * 1 * parsedRow.multiplier;
                        }
                    }
                } else {
                    // 累积电能数据处理
                    for (let hour = 0; hour < 24; hour++) {
                        // 计算当前小时的数据点范围
                        const startIndex = hour * pointsPerHour;
                        const endIndex = startIndex + pointsPerHour;
                        
                        // 获取当前小时的连续数据点
                        const hourPoints = allPoints.slice(startIndex, endIndex)
                            .map(p => p.value)
                            .filter(v => v !== null && !isNaN(v));
                        
                        if (hourPoints.length > 0) {
                            // 获取当前小时内按时间顺序的第一个和最后一个有效数据点
                            // 注意：这里不应该按数值大小排序，而应该按时间顺序
                            const hourPointsWithTime = allPoints.slice(startIndex, endIndex)
                                .filter(p => p.value !== null && !isNaN(p.value));
                            
                            if (hourPointsWithTime.length >= 2) {
                                // 按时间排序（确保时间顺序正确）
                                hourPointsWithTime.sort((a, b) => a.time - b.time);
                                
                                const firstValue = hourPointsWithTime[0].value;
                                const lastValue = hourPointsWithTime[hourPointsWithTime.length - 1].value;
                                
                                if (lastValue >= firstValue) {
                                    // 计算电能变化量：最后一个值 - 第一个值，再乘以倍率
                                    hourlyData[hour] = (lastValue - firstValue) * parsedRow.multiplier;
                                } else {
                                    // 累积值回退，标记为异常
                                    console.warn(`累积值异常，日期: ${parsedRow.dateStr}, 小时: ${hour}`);
                                    hourlyData[hour] = null;
                                }
                            } else if (hourPointsWithTime.length === 1) {
                                // 只有一个数据点，无法计算差值
                                hourlyData[hour] = null;
                            }
                        }
                    }
                }
            } else {
                console.warn(`数据点数量不足，期望${expectedTotalPoints}个，实际${parsedRow.dataPoints ? parsedRow.dataPoints.length : 0}个`);
            }
            
            // 计算日总电能
            const validHourlyData = hourlyData.filter(v => v !== null);
            const dailyTotal = validHourlyData.reduce((a, b) => a + b, 0);
            
            console.log(`=== 日总电能计算调试 (${parsedRow.dateStr}) ===`);
            console.log('有效小时数据点数:', validHourlyData.length);
            console.log('有效小时数据样本:', validHourlyData.slice(0, 5));
            console.log('计算得到的dailyTotal:', dailyTotal);
            
            // 确保日期格式统一为 YYYY-MM-DD
            let formattedDate = parsedRow.dateStr;
            if (typeof parsedRow.dateStr === 'string') {
                const dateStr = parsedRow.dateStr;
                if (dateStr.length === 8 && !dateStr.includes('-')) {
                    // 格式：20240901 -> 2024-09-01
                    formattedDate = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                } else if (dateStr.length === 10 && dateStr.includes('/')) {
                    // 格式：2024/09/01 -> 2024-09-01
                    formattedDate = dateStr.replace(/\//g, '-');
                } else {
                    formattedDate = dateStr;
                }
            }
            
            appData.processedData.push({
                date: formattedDate,
                dateObj: parsedRow.date,
                hourlyData: hourlyData,
                dailyTotal: dailyTotal,
                sourceFile: parsedRow.sourceFile,
                meteringPoint: (parsedRow.meteringPoint === undefined || parsedRow.meteringPoint === null || String(parsedRow.meteringPoint).trim() === '') ? '默认计量点' : String(parsedRow.meteringPoint).trim(),
                timeInterval: interval, // 保存时间间隔信息
                dataStructure: 'columnToColumn' // 标记数据结构类型
            });
        }
    });
    
    // 过滤掉所有数据都为空的日期
    appData.processedData = appData.processedData.filter(row => {
        return row.hourlyData.some(value => value !== null);
    });
    
    // 在数据处理完成后，更新历史记录
    if (appData.importHistory.length > 0) {
        // 获取最近一次导入的记录
        const latestRecord = appData.importHistory[appData.importHistory.length - 1];
        
        // 更新处理结果
        latestRecord.validRecordCount = appData.parsedData.length;
        latestRecord.invalidRecordCount = appData.worksheets[0].data.length - 1 - appData.parsedData.length; // 总行数减去表头和有效行数
        latestRecord.timeInterval = appData.config.timeInterval;
        latestRecord.config = {
            dataType: appData.config.dataType,
            multiplier: appData.config.multiplier,
            dateColumn: appData.config.dateColumn,
            dataStartColumn: appData.config.dataStartColumn,
            dataEndColumn: appData.config.dataEndColumn,
            dataStructure: document.querySelector('input[name="dataStructure"]:checked').value // 保存数据结构类型
        };
        
        // 保存更新后的历史记录
        saveImportHistory();
        renderImportHistory();
    }
    
    // 更新数据概览统计信息
    updateDataOverview();
    
    // 初始化可视化界面
    initializeVisualization();
}

        /**
         * 使用新的配置重新处理原始数据
         * 这个函数会在第二步配置发生变化时调用，确保第三步可视化使用最新的配置
         */
        function reprocessDataWithConfig() {
            console.log('使用新配置重新处理数据...');
            
            // 检查是否有原始数据
            if (!appData.worksheets || appData.worksheets.length === 0) {
                console.warn('没有原始数据可供重新处理');
                return;
            }
            
            try {
                // 清除缓存，确保使用新配置
                if (CacheManager && typeof CacheManager.clear === 'function') {
                    CacheManager.clear();
                }
                
                // 重新解析工作表数据（使用新配置）
                parseWorksheetData();
                
                // 重新处理解析后的数据
                processParsedData();
                
                // 更新计量点筛选选项
                updateMeteringPointFilterOptions();
                
                // 更新日期选择器
                updateVisualizationDateSelects();
                
                // 重置可视化筛选为新数据的全选，避免旧选择与新数据不匹配导致无数据
                appData.visualization.selectedDates = appData.processedData.map(d => d.date);
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                if (elements.visualizationMeteringPointFilterSelect) {
                    Array.from(elements.visualizationMeteringPointFilterSelect.options).forEach(opt => opt.selected = true);
                }
                
                console.log('数据重新处理完成，共处理数据点:', appData.processedData.length);
                
                // 更新数据概览统计信息
                updateDataOverview();
                
                // 如果当前在可视化步骤，自动刷新图表
                if (!elements.visualizationSection.classList.contains('hidden')) {
                    setTimeout(() => {
                        updateChart();
                        const filteredData = getFilteredData();
                        if (appData.dailyTotalBarChart) {
                            updateDailyTotalBarChart(filteredData);
                        }
                    }, 100);
                }
                
            } catch (error) {
                console.error('重新处理数据时出错:', error);
                showNotification('错误', '重新处理数据失败: ' + error.message, 'error');
            }
        }

        function checkConfigValidity() {
            // 获取数据结构类型
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // 根据数据结构类型验证配置
            let isValid = appData.config.dateColumn !== '' && 
                          appData.config.dataStartColumn !== '';
            
            // 如果是列对行结构，还需要验证结束列
            if (dataStructure === 'columnToRow') {
                isValid = isValid && appData.config.dataEndColumn !== '';
            }
            
            // 调试信息：输出配置值
            console.log('checkConfigValidity 调试信息:');
            console.log('数据结构类型:', dataStructure);
            console.log('dateColumn:', appData.config.dateColumn);
            console.log('dataStartColumn:', appData.config.dataStartColumn);
            console.log('dataEndColumn:', appData.config.dataEndColumn);
            console.log('isValid (基本条件):', isValid);
            
            // 智能检测和修正配置
            if (appData.worksheets && appData.worksheets.length > 0) {
                const worksheet = appData.worksheets[0];
                const detectedStructure = smartDetectDataStructure(worksheet.data);
                
                console.log('智能检测到的数据结构:', detectedStructure);
                console.log('当前选择的数据结构:', dataStructure);
                
                // 如果检测到的结构与选择的不同，给出提示
                if (detectedStructure !== dataStructure) {
                    console.warn(`数据结构可能不匹配！检测到: ${detectedStructure}, 当前选择: ${dataStructure}`);
                    showNotification('提示', `检测到数据可能是${detectedStructure === 'columnToColumn' ? '列对列' : '列对行'}结构，请检查配置`, 'warning');
                }
                
                // 自动修正配置（针对columnToColumn结构的CSV文件）
                if (detectedStructure === 'columnToColumn' && dataStructure === 'columnToRow') {
                    console.log('自动切换到columnToColumn结构');
                    document.querySelector('input[name="dataStructure"][value="columnToColumn"]').checked = true;
                    // 触发配置更新
                    setTimeout(() => {
                        checkConfigValidity();
                    }, 100);
                    return false;
                }
            }
            
            // 确保结束列不小于起始列（仅对列对行结构）
            if (isValid && dataStructure === 'columnToRow') {
                const startCol = parseInt(appData.config.dataStartColumn);
                const endCol = parseInt(appData.config.dataEndColumn);
                
                console.log('startCol (数字):', startCol);
                console.log('endCol (数字):', endCol);
                console.log('endCol < startCol:', endCol < startCol);
                
                if (endCol < startCol) {
                    showNotification('警告', '结束列不能小于起始列', 'warning');
                    console.log('按钮被禁用：结束列小于起始列');
                    return false;
                }
            }
            
            console.log('最终按钮状态:', !isValid ? '禁用' : '启用');

            return isValid;
        }
        
        // 智能检测数据结构
        function smartDetectDataStructure(data) {
            if (!data || data.length < 2) return 'columnToColumn';
            
            // 检查第一行是否包含时间列标题
            const firstRow = data[0] || [];
            let timeColumnCount = 0;
            
            for (let col = 0; col < Math.min(firstRow.length, 30); col++) {
                const cellValue = firstRow[col];
                if (cellValue) {
                    const headerValue = cellValue.toString().toLowerCase();
                    if (headerValue.includes('时间') || headerValue.includes('time') || 
                        headerValue.includes('hour') || headerValue.includes('小时') ||
                        /^\d{1,2}[:：]\d{2}/.test(headerValue) || /^\d{1,2}[点时]/.test(headerValue) ||
                        /^[0-9]{1,2}$/.test(headerValue.trim()) || // 纯数字小时
                        headerValue.match(/^(0?[0-9]|1[0-9]|2[0-3])$/)) { // 0-23小时格式
                        timeColumnCount++;
                    }
                }
            }
            
            // 检查是否有日期列
            let dateColumnFound = false;
            for (let col = 0; col < Math.min(5, firstRow.length); col++) {
                let dateCount = 0;
                const sampleSize = Math.min(10, data.length - 1);
                
                for (let row = 1; row <= sampleSize; row++) {
                    if (data[row] && data[row][col]) {
                        const cellValue = data[row][col].toString();
                        if (isValidDateString(cellValue)) {
                            dateCount++;
                        }
                    }
                }
                
                if (dateCount >= sampleSize * 0.7) {
                    dateColumnFound = true;
                    break;
                }
            }
            
            // 决策逻辑
            if (dateColumnFound) {
                return 'columnToColumn'; // 有日期列，通常是columnToColumn
            } else if (timeColumnCount >= 12) {
                return 'columnToRow'; // 有大量时间列，通常是columnToRow
            }
            
            return 'columnToColumn'; // 默认
        }
        
        // 验证日期字符串
        function isValidDateString(dateStr) {
            if (!dateStr) return false;
            
            const str = dateStr.toString().trim();
            
            // 检查各种日期格式
            const datePatterns = [
                /^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/, // YYYY-MM-DD 或 YYYY/MM/DD
                /^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/, // MM-DD-YYYY 或 MM/DD/YYYY
                /^\d{4}\d{2}\d{2}$/, // YYYYMMDD
                /^\d{4}年\d{1,2}月\d{1,2}日?$/, // 中文日期格式
                /^\d{1,2}月\d{1,2}日$/ // 简化中文日期
            ];
            
            // 检查是否匹配任何日期模式
            for (const pattern of datePatterns) {
                if (pattern.test(str)) {
                    // 尝试解析为日期对象验证有效性
                    const date = new Date(str);
                    if (!isNaN(date.getTime())) {
                        return true;
                    }
                }
            }
            
            // 尝试直接解析
            const date = new Date(str);
            return !isNaN(date.getTime()) && date.getFullYear() > 1900 && date.getFullYear() < 2100;
        }

        function updateMeteringPointFilterOptions() {
            // 清空现有选项
            elements.meteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            elements.visualizationMeteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            
            // 重置计量点列表
            appData.meteringPoints = [];
            
            // 如果没有选择计量点编号列，则返回
            if (!appData.config.meteringPointColumn) return;
            
            const meteringPointCol = parseInt(appData.config.meteringPointColumn);
            
            // 收集所有唯一的计量点编号
            const meteringPointSet = new Set();
            
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // 跳过表头行，尝试自动检测数据起始行
                let startRow = 0;
                for (let i = 0; i < Math.min(10, data.length); i++) {
                    if (data[i] && data[i][meteringPointCol] && !isDateLike(data[i][meteringPointCol])) {
                        startRow = i;
                        break;
                    }
                }
                
                // 收集计量点编号
                for (let i = startRow; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[meteringPointCol]) continue;
                    
                    const meteringPoint = String(row[meteringPointCol]).trim();
                    if (meteringPoint) {
                        meteringPointSet.add(meteringPoint);
                    }
                }
            });
            
            // 如果数据中存在空/缺失计量点，为其添加统一占位『默认计量点』
            if ([...meteringPointSet].some(v => v === undefined || v === null || String(v).trim() === '')) {
                meteringPointSet.add('默认计量点');
            }
            // 转换为数组并排序
            appData.meteringPoints = Array.from(meteringPointSet).sort();
            
            // 添加到下拉菜单
            appData.meteringPoints.forEach(point => {
                const option1 = document.createElement('option');
                option1.value = point;
                option1.textContent = point;
                elements.meteringPointFilterSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = point;
                option2.textContent = point;
                elements.visualizationMeteringPointFilterSelect.appendChild(option2);
            });
            
            // 默认选择全部计量点
            appData.config.meteringPointFilter = '';
            appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
        }

        // 可视化部分函数
        function initializeVisualization() {
            // 填充日期下拉选择框
            updateVisualizationDateSelects();
            
            // 默认选择所有日期
            appData.visualization.selectedDates = appData.processedData.map(d => d.date);
            console.log('初始化选择所有日期:', appData.visualization.selectedDates.length, '个日期');
            
            // 默认选择所有计量点
            if (appData.meteringPoints.length > 0) {
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                console.log('初始化选择所有计量点:', appData.visualization.selectedMeteringPoints.length, '个计量点');
            } else {
                console.log('没有找到计量点，自动收集所有计量点');
                // 如果没有预设的计量点，从数据中收集所有唯一的计量点
                const allMeteringPoints = [...new Set(appData.processedData.map(d => {
                    const raw = d.meteringPoint;
                    const v = (raw === undefined || raw === null || String(raw).trim() === '') ? '默认计量点' : String(raw).trim();
                    return v;
                }))];
                appData.visualization.selectedMeteringPoints = allMeteringPoints;
                appData.meteringPoints = allMeteringPoints;
                console.log('自动收集计量点:', allMeteringPoints);
            }
                
                // 初始化图表区域点击事件处理
                document.getElementById('chartContainer').addEventListener('click', function(e) {
                    // 阻止事件冒泡，防止图形消失
                    e.stopPropagation();
                    
                    // 如果点击的是canvas元素，不进行任何操作
                    if (e.target.tagName === 'CANVAS') {
                        return;
                    }
                    
                    // 如果点击的是加载状态或无数据消息区域，也不进行任何操作
                    if (e.target.id === 'chartLoading' || e.target.id === 'noDataMessage' || 
                        e.target.closest('#chartLoading') || e.target.closest('#noDataMessage')) {
                        return;
                    }
                });
                
                // 注：toggleLegend元素已删除，图例显示控制已集成到图表配置中
                
                // 初始化柱状图区域点击事件处理
                document.getElementById('dailyTotalBarChartContainer').addEventListener('click', function(e) {
                    // 阻止事件冒泡，防止图形消失
                    e.stopPropagation();
                    
                    // 如果点击的是canvas元素，不进行任何操作
                    if (e.target.tagName === 'CANVAS') {
                        return;
                    }
                    
                    // 如果点击的是加载状态或无数据消息区域，也不进行任何操作
                    if (e.target.id === 'barChartLoading' || e.target.id === 'barChartNoDataMessage' || 
                        e.target.closest('#barChartLoading') || e.target.closest('#barChartNoDataMessage')) {
                        return;
                    }
                });
                
                // 注：toggleBarLegend元素已删除，柱状图图例显示控制已集成到图表配置中
                
                // 初始化图表
                // 检查是否已存在图表实例，如果存在则先销毁
                if (appData.chart) {
                    appData.chart.destroy();
                    appData.chart = null;
                }
                

                
                const ctx = elements.loadCurveChart.getContext('2d');
                appData.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 15,
                                bottom: 10,
                                left: 15
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutCubic',
                            delay: (context) => {
                                let delay = 0;
                                if (context.type === 'data' && context.mode === 'default') {
                                    delay = context.dataIndex * 30;
                                }
                                return delay;
                            }
                        },
                        plugins: {
                            title: {
                                display: false,
                                text: '24小时负荷曲线',
                                font: {
                                    size: 18,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 15
                                },
                                color: '#1F2937'
                            },
                            legend: {
                                display: false,
                                position: 'top',
                                align: 'center',
                                labels: {
                                    usePointStyle: true,
                                    padding: 8,
                                    font: {
                                        size: 11,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    boxWidth: 12,
                                    boxHeight: 12,
                                    // 自动调整图例布局以适应容器宽度
                                    generateLabels: function(chart) {
                                        const datasets = chart.data.datasets;
                                        const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                        
                                        // 根据数据集数量调整图例显示
                                        if (datasets.length > 20) {
                                            // 数据集较多时，减小字体和间距
                                            originalLabels.forEach(label => {
                                                label.font = {
                                                    size: 10,
                                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                                    weight: '500'
                                                };
                                                label.padding = 6;
                                                label.boxWidth = 6;
                                                label.boxHeight = 6;
                                            });
                                        }
                                        
                                        return originalLabels;
                                    }
                                },
                                // 使用默认的legend点击行为(仅显示/隐藏dataset)
                                onClick: Chart.defaults.plugins.legend.onClick
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#1F2937',
                                titleFont: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                bodyColor: '#4B5563',
                                bodyFont: {
                                    size: 13,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif'
                                },
                                borderColor: 'rgba(0, 0, 0, 0.1)',
                                borderWidth: 1,
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: true,
                                boxWidth: 10,
                                boxHeight: 10,
                                boxPadding: 4,
                                usePointStyle: true,
                                caretSize: 8,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return '时间: ' + tooltipItems[0].label;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // 根据数据集使用的Y轴显示不同的单位
                                            const unit = context.dataset.yAxisID === 'y1' ? 'kW' : 'kWh';
                                            label += context.parsed.y.toFixed(2) + ' ' + unit;
                                        }
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '时间',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    maxRotation: 0,
                                    autoSkip: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '用电量 (kWh)',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            },
                            y1: {
                                display: appData.visualization.secondaryAxis,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '功率 (kW)',
                                    font: {
                                        size: 14,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '600'
                                    },
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false, // 不在图表区域绘制网格线
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        size: 12,
                                        family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                        weight: '500'
                                    },
                                    padding: 8,
                                    callback: function(value) {
                                        return value.toFixed(1);
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const datasetIndex = element.datasetIndex;
                                const index = element.index;
                                const dataset = appData.chart.data.datasets[datasetIndex];
                                const value = dataset.data[index];
                                const label = appData.chart.data.labels[index];
                                
                                showNotification(
                                    '数据点详情', 
                                    `${dataset.label} 在 ${label} 的${dataset.yAxisID === 'y1' ? '功率' : '用电量'}为 ${value ? value.toFixed(2) : '无数据'} ${dataset.yAxisID === 'y1' ? 'kW' : 'kWh'}`,
                                    'info'
                                );
                            }
                        },
                        onHover: (event, elements) => {
                            event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            
                            // 添加canvas区域的互动反馈
                            const canvas = event.native.target;
                            if (elements.length > 0) {
                                canvas.style.filter = 'brightness(1.05)';
                            } else {
                                canvas.style.filter = 'brightness(1)';
                            }
                        }
                    }
                });
                
                // 确保图表显示数据
                setTimeout(() => {
                    updateChart();
                }, 100);
            }

        // 更新可视化部分的日期下拉选择框
        function updateVisualizationDateSelects() {
            // 清空现有选项
            elements.startDateInput.innerHTML = '<option value="">-- 请选择起始日期 --</option>';
            elements.endDateInput.innerHTML = '<option value="">-- 请选择结束日期 --</option>';
            
            // 如果没有处理过的数据，则返回
            if (appData.processedData.length === 0) return;
            
            const dateSet = new Set();
            
            // 收集所有唯一的日期
            appData.processedData.forEach(row => {
                dateSet.add(row.date);
            });
            
            // 转换为数组并排序
            const dates = Array.from(dateSet).sort();
            
            // 添加到下拉菜单
            dates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.startDateInput.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.endDateInput.appendChild(option2);
            });
            
            // 设置默认值为最早和最晚日期
            if (dates.length > 0) {
                elements.startDateInput.value = dates[0];
                elements.endDateInput.value = dates[dates.length - 1];
            }
        }

        function applyDateFilter() {
            const startDate = elements.startDateInput.value;
            const endDate = elements.endDateInput.value;
            
            if (!startDate || !endDate) {
                showNotification('警告', '请选择完整的日期范围', 'warning');
                return;
            }
            
            // 筛选日期
            appData.visualization.selectedDates = appData.processedData
                .filter(d => {
                    return d.date >= startDate && d.date <= endDate;
                })
                .map(d => d.date);
            
            updateChart();
        }

        function selectAllDates() {
    appData.visualization.selectedDates = appData.processedData.map(d => d.date);
    
    // 更新图表标题以反映日期选择状态
    if (appData.chart) {
        const selectedCount = appData.visualization.selectedDates.length;
        const totalCount = appData.processedData.length;
        appData.chart.options.plugins.title.text = `${appData.visualization.focusStartTime}:00 - ${appData.visualization.focusEndTime}:00 负荷曲线 (已选择 ${selectedCount}/${totalCount} 个日期)`;
    }
    
    updateChart();
}



        function applyMeteringPointFilter() {
            const selectedOptions = Array.from(elements.visualizationMeteringPointFilterSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                showNotification('警告', '请至少选择一个计量点编号', 'warning');
                return;
            }
            
            // 筛选计量点编号
            appData.visualization.selectedMeteringPoints = selectedOptions.map(option => option.value);
            
            updateChart();
        }
        
        function selectAllMeteringPoints() {
            appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
            
            // 更新UI选择状态
            Array.from(elements.visualizationMeteringPointFilterSelect.options).forEach(option => {
                option.selected = true;
            });
            
            updateChart();
        }
        
        function applyTimeFocus() {
            const startHour = parseInt(elements.focusStartTimeSelect.value);
            const endHour = parseInt(elements.focusEndTimeSelect.value);
            
            if (startHour > endHour) {
                showNotification('警告', '开始时间不能晚于结束时间', 'warning');
                return;
            }
            
            appData.visualization.focusStartTime = startHour;
            appData.visualization.focusEndTime = endHour;
            
            // 添加视觉反馈
            elements.applyTimeFocusBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.applyTimeFocusBtn.style.transform = 'scale(1)';
            }, 200);
            
            // 更新图表和统计信息
            updateChart();
            
            // 显示通知
            showNotification('时间焦段更新', `已设置时间焦段为 ${startHour}:00 - ${endHour}:00`, 'success');
        }

        function resetTimeFocus() {
            elements.focusStartTimeSelect.value = '0';
            elements.focusEndTimeSelect.value = '23';
            appData.visualization.focusStartTime = 0;
            appData.visualization.focusEndTime = 23;
            
            // 添加视觉反馈
            elements.resetTimeFocusBtn.style.transform = 'scale(1.05)';
            setTimeout(() => {
                elements.resetTimeFocusBtn.style.transform = 'scale(1)';
            }, 200);
            
            // 更新图表和统计信息
            updateChart();
            
            // 显示通知
            showNotification('时间焦段重置', '已重置时间焦段为全天 (0:00 - 23:00)', 'success');
        }

        // 图表性能优化配置
        const CHART_PERFORMANCE = {
            maxDataPoints: 500,       // 最大显示数据点数（支持显示更多曲线）
            pageSize: 100,           // 每页数据量（增加每页显示数量）
            animationDuration: 300,   // 动画持续时间
            enableVirtualization: true // 启用虚拟化
        };
        
        // 数据分页管理
        const chartPagination = {
            currentPage: 0,
            totalPages: 0,
            pageSize: CHART_PERFORMANCE.pageSize,
            totalItems: 0
        };
        
        // 重新设计的24小时负荷数据更新函数
        function updateChart() {
            console.log('=== 开始更新24小时负荷数据 ===');
            
            // 检查图表实例是否存在，如果不存在则重新初始化
            if (!appData.chart) {
                initializeVisualization();
                return;
            }
            
            // 如果图表Canvas已被替换或不在文档中，重新初始化
            if (!appData.chart.canvas || !document.body.contains(appData.chart.canvas)) {
                try { appData.chart.destroy(); } catch (e) {}
                appData.chart = null;
                initializeVisualization();
                return;
            }
            
            // 显示加载状态
            const chartLoadingElement = document.getElementById('chartLoading');
            const noDataMessageElement = document.getElementById('noDataMessage');
            if (chartLoadingElement && chartLoadingElement.parentNode) {
                chartLoadingElement.classList.remove('hidden');
            }
            if (noDataMessageElement && noDataMessageElement.parentNode) {
                noDataMessageElement.classList.add('hidden');
            }
            
            // 使用 requestAnimationFrame 优化渲染性能
            requestAnimationFrame(() => {
                try {
                    // 获取筛选后的数据
                    let filteredData = getFilteredData();
                    console.log('筛选后的数据条数:', filteredData.length);
                    
                    if (filteredData.length === 0) {
                        console.warn('没有符合条件的数据');
                        const chartLoadingEl = document.getElementById('chartLoading');
                        const noDataMessageEl = document.getElementById('noDataMessage');
                        if (chartLoadingEl && chartLoadingEl.parentNode) {
                            chartLoadingEl.classList.add('hidden');
                        }
                        if (noDataMessageEl && noDataMessageEl.parentNode) {
                            noDataMessageEl.classList.remove('hidden');
                        }
                        return;
                    }

                    // 更新分页信息并切片（如有必要）
                    chartPagination.totalItems = filteredData.length;
                    chartPagination.totalPages = Math.ceil(filteredData.length / chartPagination.pageSize);
                    if (filteredData.length > CHART_PERFORMANCE.maxDataPoints) {
                        const startIndex = chartPagination.currentPage * chartPagination.pageSize;
                        const endIndex = Math.min(startIndex + chartPagination.pageSize, filteredData.length);
                        filteredData = filteredData.slice(startIndex, endIndex);
                        showPaginationControls();
                    } else {
                        hidePaginationControls();
                    }
                    
                    // 按日期和计量点分组数据
                    const groupedData = groupDataByDateAndMeteringPoint(filteredData);
                    console.log('按日期分组的数据:', Object.keys(groupedData).length, '个日期');
                    
                    // 根据时间焦段设置准备图表数据
                    const startHour = appData.visualization.focusStartTime;
                    const endHour = appData.visualization.focusEndTime;
                    const hourCount = endHour - startHour + 1;
                    const labels = Array.from({ length: hourCount }, (_, i) => `${startHour + i}:00`);
                    
                    // 创建数据集（根据模式与时段聚焦过滤数据）
                    const datasets = appData.visualization.summaryMode
                        ? createSummaryDatasets(filteredData, startHour, endHour)
                        : createOptimizedDatasets(filteredData, startHour, endHour);
                    
                    // 更新图表数据和选项
                    updateChartDataAndOptions(labels, datasets, filteredData, startHour, endHour);
                    
                    // 更新统计信息
                    const displayData = Object.values(groupedData).map(data => ({
                        date: data.date,
                        meteringPoint: data.meteringPoint,
                        hourlyData: data.hourlyData,
                        dailyTotal: data.hourlyData.reduce((sum, val) => sum + (val || 0), 0)
                    }));
                    updateStatistics(displayData, startHour, endHour);
                    
                    console.log('=== 24小时负荷数据更新完成 ===');
                } catch (error) {
                    console.error('24小时负荷曲线更新错误:', error);
                    handleChartError(error);
                }
            });
        }
        
        function updateChartWithPagination() {
            // 获取筛选后的数据
            let filteredData = getFilteredData();
            
            // 更新分页信息
            chartPagination.totalItems = filteredData.length;
            chartPagination.totalPages = Math.ceil(filteredData.length / chartPagination.pageSize);
            
            // 如果数据量超过最大显示限制，启用分页
            if (filteredData.length > CHART_PERFORMANCE.maxDataPoints) {
                const startIndex = chartPagination.currentPage * chartPagination.pageSize;
                const endIndex = Math.min(startIndex + chartPagination.pageSize, filteredData.length);
                filteredData = filteredData.slice(startIndex, endIndex);
                
                // 显示分页控件
                showPaginationControls();
            } else {
                // 隐藏分页控件
                hidePaginationControls();
            }
            
            // 根据时间焦段设置准备图表数据
            const startHour = appData.visualization.focusStartTime;
            const endHour = appData.visualization.focusEndTime;
            const hourCount = endHour - startHour + 1;
            const labels = Array.from({ length: hourCount }, (_, i) => `${startHour + i}:00`);
            
            // 创建数据集
            const datasets = appData.visualization.summaryMode
                ? createSummaryDatasets(filteredData, startHour, endHour)
                : createOptimizedDatasets(filteredData, startHour, endHour);
            
            // 更新图表数据和选项
            updateChartDataAndOptions(labels, datasets, filteredData, startHour, endHour);
        }
        
        // 优化的数据集创建函数
        function createOptimizedDatasets(filteredData, startHour, endHour) {
            console.log('=== createOptimizedDatasets 调试信息 ===');
            console.log('输入数据总数:', filteredData.length);
            
            const datasets = [];
            
            // 使用 DataUtils 按日期分组数据
            const dateGroupsMap = DataUtils.groupBy(filteredData, row => row.date);
            console.log('分组后的日期数量:', dateGroupsMap.size);
            console.log('分组的日期:', Array.from(dateGroupsMap.keys()));
             
            // 为每个日期创建数据集（优化版本）
            let colorIndex = 0;
            const sortedDates = Array.from(dateGroupsMap.keys()).sort();
            
            sortedDates.forEach(dateKey => {
                const rows = dateGroupsMap.get(dateKey);
                
                // 合并同一日期的所有行数据
                const mergedHourlyData = new Array(24).fill(null);
                
                rows.forEach(row => {
                    for (let hour = 0; hour < 24; hour++) {
                        if (row.hourlyData[hour] !== null) {
                            if (mergedHourlyData[hour] !== null) {
                                // 如果已有数据，取总和
                                mergedHourlyData[hour] = mergedHourlyData[hour] + row.hourlyData[hour];
                            } else {
                                mergedHourlyData[hour] = row.hourlyData[hour];
                            }
                        }
                    }
                });
                
                // 根据时间焦段设置过滤数据
                const filteredHourlyData = mergedHourlyData.slice(startHour, endHour + 1);
                
                // 为每个日期生成不同的颜色
                const color = getColor(colorIndex % getColorCount());
                colorIndex++;
                
                // 根据用户设置确定线条样式
                let borderDash = [];
                if (appData.visualization.lineStyle === 'dashed') {
                    borderDash = [5, 5];
                } else if (appData.visualization.lineStyle === 'dotted') {
                    borderDash = [2, 2];
                }
                
                // 根据用户设置确定是否显示数据点
                const pointRadius = appData.visualization.showPoints ? 4 : 0;
                const pointHoverRadius = 6;
                
                // 根据用户设置确定曲线平滑度
                const tension = appData.visualization.smoothCurve ? appData.visualization.curveTension : 0;
                
                // 创建渐变背景
                const gradient = appData.chart.ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, color.replace('rgb', 'rgba').replace(')', ', 0.4)'));
                gradient.addColorStop(1, color.replace('rgb', 'rgba').replace(')', ', 0.05)'));
                
                // 创建优化的数据集配置
                const datasetConfig = createDatasetConfig(dateKey, filteredHourlyData, color, borderDash, pointRadius, pointHoverRadius, tension);
                datasets.push(datasetConfig);
            });
             
            return datasets;
        }
        
        // 新增：汇总模式数据集（最高/最低 + 四季度平均 + 1~12月月平均）
        function createSummaryDatasets(filteredData, startHour, endHour) {
            // 按“天”聚合，同时记录每小时是否有数据（作为是否计入该小时分母的依据）
            const dayMap = new Map();
            for (const row of filteredData) {
                const dateObj = row.dateObj || parseDate(row.date, appData.config.dateFormat);
                if (!dateObj || isNaN(dateObj)) continue;
                const dateKey = formatDateForInput(dateObj);
                if (!dayMap.has(dateKey)) {
                    dayMap.set(dateKey, {
                        dateObj,
                        hourly: Array(24).fill(0),  // 当天每小时总量（若同一日期有多条记录则累加）
                        hrCount: Array(24).fill(0), // 当天每小时是否有数据：>0 表示该天该小时有数据
                        dailyTotal: 0
                    });
                }
                const agg = dayMap.get(dateKey);
                for (let h = 0; h < 24; h++) {
                    const v = row.hourlyData[h];
                    if (v != null && !isNaN(v)) {
                        agg.hourly[h] += v;
                        agg.hrCount[h] += 1; // 标记该天该小时有数据
                        agg.dailyTotal += v;
                    }
                }
            }
            if (dayMap.size === 0) return [];
            const days = Array.from(dayMap.values());

            // 最高/最低用电日（以当天24小时总量为判定）
            let maxDay = days[0];
            let minDay = days[0];
            for (const d of days) {
                if (d.dailyTotal > maxDay.dailyTotal) maxDay = d;
                if (d.dailyTotal < minDay.dailyTotal) minDay = d;
            }
            const maxDaySeries = maxDay.hourly.slice(startHour, endHour + 1);
            const minDaySeries = minDay.hourly.slice(startHour, endHour + 1);

            // 季度与月份分桶（按“天”作为单位）
            const quarterBuckets = [[], [], [], []]; // 每个元素是 day 对象
            const monthBuckets = Array.from({ length: 12 }, () => []);
            for (const d of days) {
                const m = d.dateObj.getMonth() + 1; // 1~12
                const q = m <= 3 ? 0 : m <= 6 ? 1 : m <= 9 ? 2 : 3;
                quarterBuckets[q].push(d);
                monthBuckets[m - 1].push(d);
            }

            // 平均函数：以“有数据的天数”为分母（hrCount[h] > 0 视为该天该小时有数据）
            function avgSeries(dayList) {
                const len = endHour - startHour + 1;
                if (dayList.length === 0) return Array(len).fill(null);
                const sum = Array(24).fill(0);
                const cntDays = Array(24).fill(0);
                for (const d of dayList) {
                    for (let h = 0; h < 24; h++) {
                        if (d.hrCount[h] > 0) { // 该天该小时有数据
                            sum[h] += d.hourly[h];
                            cntDays[h] += 1; // 分母按“天数”计数
                        }
                    }
                }
                const avg = sum.map((v, i) => (cntDays[i] > 0 ? v / cntDays[i] : null));
                return avg.slice(startHour, endHour + 1);
            }

            // 四季度平均
            const q1Series = avgSeries(quarterBuckets[0]);
            const q2Series = avgSeries(quarterBuckets[1]);
            const q3Series = avgSeries(quarterBuckets[2]);
            const q4Series = avgSeries(quarterBuckets[3]);

            // 1~12月平均
            const monthSeries = monthBuckets.map(list => avgSeries(list));

            function makeDataset(label, data, color, dash = []) {
                // 让汇总曲线联动样式设置：线型与数据点
                let computedDash = [];
                if (appData.visualization.lineStyle === 'dashed') {
                    computedDash = [5, 5];
                } else if (appData.visualization.lineStyle === 'dotted') {
                    computedDash = [2, 2];
                } else {
                    // UI 选择 solid 时，保留传入的 dash（如季度/月份平均使用虚线的默认样式）
                    computedDash = dash;
                }
                const showPoints = !!appData.visualization.showPoints;
                const pr = showPoints ? 4 : 0;
                return {
                    label,
                    data,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 3,
                    borderDash: computedDash,
                    pointRadius: pr,
                    pointHoverRadius: 6,
                    pointStyle: 'circle',
                    pointBackgroundColor: color,
                    pointBorderColor: color,
                    pointBorderWidth: 2,
                    tension: appData.visualization.smoothCurve ? appData.visualization.curveTension : 0,
                    fill: false,
                    yAxisID: 'y',
                    spanGaps: true
                };
            }

            // 调色板（12个月份 + 季度）
            const monthColors = [
                'rgb(244, 63, 94)',   // 1月
                'rgb(249, 115, 22)',  // 2月
                'rgb(234, 179, 8)',   // 3月
                'rgb(132, 204, 22)',  // 4月
                'rgb(16, 185, 129)',  // 5月
                'rgb(14, 165, 233)',  // 6月
                'rgb(59, 130, 246)',  // 7月
                'rgb(99, 102, 241)',  // 8月
                'rgb(168, 85, 247)',  // 9月
                'rgb(236, 72, 153)',  // 10月
                'rgb(125, 211, 252)', // 11月
                'rgb(107, 114, 128)'  // 12月
            ];

            const datasets = [];
            // 最高/最低用电日
            datasets.push(makeDataset(`最高用电日 (${formatDateForInput(maxDay.dateObj)})`, maxDaySeries, 'rgb(220, 38, 38)'));
            datasets.push(makeDataset(`最低用电日 (${formatDateForInput(minDay.dateObj)})`, minDaySeries, 'rgb(37, 99, 235)'));
            // 季度平均
            datasets.push(makeDataset('Q1平均(1-3月)', q1Series, 'rgb(16, 185, 129)', [6, 4]));
            datasets.push(makeDataset('Q2平均(4-6月)', q2Series, 'rgb(234, 179, 8)', [6, 4]));
            datasets.push(makeDataset('Q3平均(7-9月)', q3Series, 'rgb(168, 85, 247)', [6, 4]));
            datasets.push(makeDataset('Q4平均(10-12月)', q4Series, 'rgb(79, 70, 229)', [6, 4]));
            // 月平均（1~12月），默认用更短的虚线以便与季度区分
            for (let m = 1; m <= 12; m++) {
                datasets.push(
                    makeDataset(`${m}月平均`, monthSeries[m - 1], monthColors[m - 1], [4, 2])
                );
            }
            return datasets;
        }
        
        // 创建数据集配置
        function createDatasetConfig(dateKey, filteredHourlyData, color, borderDash, pointRadius, pointHoverRadius, tension) {
            return {
                label: dateKey,
                data: filteredHourlyData,
                borderColor: color,
                backgroundColor: 'transparent',
                borderWidth: 3,
                borderDash: borderDash,
                borderCapStyle: 'round',
                borderJoinStyle: 'round',
                segment: {
                    borderColor: ctx => {
                        return ctx.p0.parsed.y !== null && ctx.p1.parsed.y !== null ? color : 'rgba(0,0,0,0)';
                    },
                    borderDash: ctx => {
                        return ctx.p0.parsed.y !== null && ctx.p1.parsed.y !== null ? borderDash : [];
                    }
                },
                pointRadius: pointRadius,
                pointHoverRadius: pointHoverRadius,
                pointStyle: 'circle',
                pointBorderWidth: 2,
                pointBackgroundColor: color,
                pointBorderColor: color,
                pointHoverBackgroundColor: color,
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 0,
                tension: tension,
                fill: false,
                yAxisID: 'y',
                spanGaps: true
            };
        }
        
        // 更新图表数据和选项
        function updateChartDataAndOptions(labels, datasets, filteredData, startHour, endHour) {
            // 更新图表数据
            appData.chart.data.labels = labels;
            appData.chart.data.datasets = datasets;
            

            
            // 更新图表选项
            // 更新图表标题以反映时间焦段和日期选择状态
            const selectedCount = appData.visualization.selectedDates.length;
            const totalCount = appData.processedData.length;
            if (appData.visualization.summaryMode) {
                appData.chart.options.plugins.title.text = `${startHour}:00 - ${endHour}:00 汇总曲线（最高/最低 + 季度平均 + 月平均）`;
            } else {
                appData.chart.options.plugins.title.text = `${startHour}:00 - ${endHour}:00 负荷曲线 (已选择 ${selectedCount}/${totalCount} 个日期)`;
            }
            
            // 折线图模式下的选项
            appData.chart.options.scales.x.stacked = false;
            appData.chart.options.scales.y.stacked = false;
            appData.chart.options.plugins.tooltip.mode = 'index';
            appData.chart.options.plugins.tooltip.intersect = false;
            
            // 更新辅助Y轴
            appData.chart.options.scales.y1 = {
                display: appData.visualization.secondaryAxis,
                position: 'right',
                title: {
                    display: true,
                    text: '功率 (kW)',
                    font: {
                        size: 14
                    }
                },
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false // 不在图表区域绘制网格线
                }
            };
            
            // 使用优化的更新方式
            updateChartWithAnimation();
            
            // 汇总模式下隐藏分页控件
            if (appData.visualization.summaryMode) {
                hidePaginationControls();
            }
            
            // 更新统计信息 - 使用正确的数据格式
            updateStatistics(filteredData, startHour, endHour);
            

            
            // 隐藏加载状态
            const chartLoadingFinalElement = document.getElementById('chartLoading');
            if (chartLoadingFinalElement && chartLoadingFinalElement.parentNode) {
                chartLoadingFinalElement.classList.add('hidden');
            }
            
            // 显示数据状态
            updateDataStatus(datasets.length);
        }
        
        // 优化的图表更新函数
        function updateChartWithAnimation() {
            try {
                if (appData.chart && typeof appData.chart.update === 'function') {
                    // 使用平滑动画更新
                    appData.chart.update({
                        duration: CHART_PERFORMANCE.animationDuration,
                        easing: 'easeInOutQuart'
                    });
                }
            } catch (error) {
                console.error('图表更新错误:', error);
                handleChartError(error);
            }
        }
        
        // 图表错误处理
        function handleChartError(error) {
            try {
                if (appData.chart) {
                    appData.chart.destroy();
                    appData.chart = null;
                }
                initializeVisualization();
            } catch (secondError) {
                console.error('图表重新初始化失败:', secondError);
                showNotification('错误', '图表更新失败，请刷新页面重试', 'error');
            }
        }
        
        // 分页控件管理
        function showPaginationControls() {
            let paginationContainer = document.getElementById('chartPagination');
            if (!paginationContainer) {
                paginationContainer = createPaginationContainer();
            }
            
            updatePaginationControls();
            if (paginationContainer && paginationContainer.parentNode) {
                paginationContainer.classList.remove('hidden');
            }
        }
        
        function hidePaginationControls() {
            const paginationContainer = document.getElementById('chartPagination');
            if (paginationContainer && paginationContainer.parentNode) {
                paginationContainer.classList.add('hidden');
            }
        }
        
        function createPaginationContainer() {
            const container = document.createElement('div');
            container.id = 'chartPagination';
            container.className = 'flex items-center justify-between mt-4 p-4 bg-gray-50 rounded-lg';
            
            container.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">显示第 <span id="currentPageInfo">1</span> 页，共 <span id="totalPagesInfo">1</span> 页</span>
                    <span class="text-sm text-gray-500">（共 <span id="totalItemsInfo">0</span> 条数据）</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="prevPageBtn" class="btn-secondary btn-sm" onclick="changePage(-1)">
                        <i class="fa fa-chevron-left"></i> 上一页
                    </button>
                    <button id="nextPageBtn" class="btn-secondary btn-sm" onclick="changePage(1)">
                        下一页 <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            `;
            
            // 插入到图表容器后面
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.parentNode.insertBefore(container, chartContainer.nextSibling);
            }
            
            return container;
        }
        
        function updatePaginationControls() {
            // 检查元素是否存在，避免null错误
            const currentPageInfo = document.getElementById('currentPageInfo');
            const totalPagesInfo = document.getElementById('totalPagesInfo');
            const totalItemsInfo = document.getElementById('totalItemsInfo');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            
            if (currentPageInfo && currentPageInfo.parentNode) currentPageInfo.textContent = chartPagination.currentPage + 1;
            if (totalPagesInfo && totalPagesInfo.parentNode) totalPagesInfo.textContent = chartPagination.totalPages;
            if (totalItemsInfo && totalItemsInfo.parentNode) totalItemsInfo.textContent = chartPagination.totalItems;
            
            if (prevPageBtn) prevPageBtn.disabled = chartPagination.currentPage === 0;
            if (nextPageBtn) nextPageBtn.disabled = chartPagination.currentPage >= chartPagination.totalPages - 1;
        }
        
        // 分页切换函数（支持相对/绝对跳转）
        function changePage(directionOrPage, isAbsolute = false) {
            let newPage;
            if (isAbsolute) {
                newPage = directionOrPage;
            } else {
                newPage = chartPagination.currentPage + directionOrPage;
            }
            if (newPage >= 0 && newPage < chartPagination.totalPages) {
                chartPagination.currentPage = newPage;
                updateChart();
            }
        }
        
        // 数据状态更新
        function updateDataStatus(datasetCount) {
            // 柱状图始终显示（增加空值保护）
            const barCanvas = document.getElementById('dailyTotalBarChart');
            if (barCanvas && barCanvas.parentElement && barCanvas.parentElement.parentElement) {
                const barChartContainer = barCanvas.parentElement.parentElement;
                barChartContainer.style.display = 'block';
            }
            updateDailyTotalBarChart(getFilteredData());
            
            // 如果没有数据，显示无数据消息，否则隐藏
            const noDataMsgElement = document.getElementById('noDataMessage');
            if (datasetCount === 0) {
                if (noDataMsgElement && noDataMsgElement.parentNode) {
                    noDataMsgElement.classList.remove('hidden');
                }
            } else {
                if (noDataMsgElement && noDataMsgElement.parentNode) {
                    noDataMsgElement.classList.add('hidden');
                }
            }
        }

        function updateStatistics(displayData, startHour, endHour) {
            // 如果没有传入时间焦段设置，使用appData中的设置（注意0值是有效的）
            if (typeof startHour !== 'number' || typeof endHour !== 'number') {
                startHour = appData.visualization.focusStartTime;
                endHour = appData.visualization.focusEndTime;
            }
            

            
            // 计算时段统计
            function generatePeriodStats() {
                let html = '<div class="max-h-96 overflow-y-auto">';
                
                // 时段分析汇总
                let totalPeriodAll = 0;
                let totalDailyAll = 0;
                let periodHours = endHour - startHour + 1;

                // 新增：跟踪时段用电量的最大/最小日
                let maxPeriodTotal = -Infinity;
                let maxPeriodDate = '';
                let minPeriodTotal = Infinity;
                let minPeriodDate = '';
                
                displayData.forEach(dateData => {
                    let periodTotal = 0;
                    for (let hour = startHour; hour <= endHour; hour++) {
                        if (dateData.hourlyData[hour] !== null) {
                            periodTotal += dateData.hourlyData[hour];
                        }
                    }
                    totalPeriodAll += periodTotal;
                    totalDailyAll += dateData.dailyTotal;

                    // 记录最大/最小日
                    if (periodTotal > maxPeriodTotal) {
                        maxPeriodTotal = periodTotal;
                        maxPeriodDate = dateData.date;
                    }
                    if (periodTotal < minPeriodTotal) {
                        minPeriodTotal = periodTotal;
                        minPeriodDate = dateData.date;
                    }
                });
                
                const overallPeriodPercentage = totalDailyAll > 0 ? (totalPeriodAll / totalDailyAll) * 100 : 0;
                const denom = displayData.length * periodHours;
                const avgHourlyInPeriod = denom > 0 ? (totalPeriodAll / denom) : 0;
                
                // 时段分析卡片
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
                html += '<div class="bg-blue-50 p-3 rounded-lg border border-blue-200">';
                html += '<div class="text-blue-700 text-sm font-medium">时段总用电</div>';
                html += `<div class="text-blue-900 text-lg font-bold">${totalPeriodAll.toFixed(2)} kWh</div>`;
                html += '</div>';
                
                html += '<div class="bg-green-50 p-3 rounded-lg border border-green-200">';
                html += '<div class="text-green-700 text-sm font-medium">占全天比例</div>';
                html += `<div class="text-green-900 text-lg font-bold">${overallPeriodPercentage.toFixed(1)}%</div>`;
                html += '</div>';
                
                html += '<div class="bg-purple-50 p-3 rounded-lg border border-purple-200">';
                html += '<div class="text-purple-700 text-sm font-medium">时段平均小时用电</div>';
                html += `<div class="text-purple-900 text-lg font-bold">${avgHourlyInPeriod.toFixed(2)} kWh</div>`;
                html += '</div>';
                
                html += '<div class="bg-orange-50 p-3 rounded-lg border border-orange-200">';
                html += '<div class="text-orange-700 text-sm font-medium">用电量最大日</div>';
                html += `<div class="text-orange-900 text-lg font-bold">${maxPeriodDate || '-'}：${isFinite(maxPeriodTotal) ? maxPeriodTotal.toFixed(2) : '0.00'} kWh</div>`;
                html += '</div>';

                html += '<div class="bg-amber-50 p-3 rounded-lg border border-amber-200">';
                html += '<div class="text-amber-700 text-sm font-medium">用电量最小日</div>';
                html += `<div class="text-amber-900 text-lg font-bold">${minPeriodDate || '-'}：${isFinite(minPeriodTotal) ? minPeriodTotal.toFixed(2) : '0.00'} kWh</div>`;
                html += '</div>';
                html += '</div>';
                
                // 详细时段统计表格
                html += '<table class="w-full border-collapse whitespace-nowrap">';
                html += '<thead>';
                html += '<tr class="bg-gray-50">';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">日期</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">时段用电量 (kWh)</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">占全天比例</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">时段平均小时 (kWh)</th>';
                html += '<th class="border border-gray-200 p-2 text-center font-medium">日总用电量 (kWh)</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';
                
                displayData.forEach((dateData, index) => {
                    let periodTotal = 0;
                    let validHours = 0;
                    
                    for (let hour = startHour; hour <= endHour; hour++) {
                        if (dateData.hourlyData[hour] !== null && dateData.hourlyData[hour] !== undefined) {
                            periodTotal += dateData.hourlyData[hour];
                            validHours++;
                        }
                    }
                    
                    const dailyPercentage = dateData.dailyTotal > 0 ? (periodTotal / dateData.dailyTotal) * 100 : 0;
                    const hourlyAverage = validHours > 0 ? periodTotal / validHours : 0;
                    
                    const color = getColorForIndex(index);
                    
                    html += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}">`;
                    html += `<td class="border border-gray-200 p-2 text-center" style="color: ${color}">${dateData.date}</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center font-medium">${periodTotal.toFixed(2)}</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center">`;
                    html += `<span class="${dailyPercentage > 50 ? 'text-red-600 font-bold' : dailyPercentage > 30 ? 'text-orange-600' : 'text-green-600'}">${dailyPercentage.toFixed(1)}%</span>`;
                    html += `</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center">${hourlyAverage.toFixed(2)}</td>`;
                    html += `<td class="border border-gray-200 p-2 text-center">${dateData.dailyTotal.toFixed(2)}</td>`;
                    html += '</tr>';
                });
                
                html += '<tr class="bg-blue-50 font-medium">';
                html += '<td class="border border-gray-200 p-2 text-center">总计/平均</td>';
                html += `<td class="border border-gray-200 p-2 text-center">${totalPeriodAll.toFixed(2)}</td>`;
                html += `<td class="border border-gray-200 p-2 text-center">${overallPeriodPercentage.toFixed(1)}%</td>`;
                html += `<td class="border border-gray-200 p-2 text-center">${avgHourlyInPeriod.toFixed(2)}</td>`;
                html += `<td class="border border-gray-200 p-2 text-center">${totalDailyAll.toFixed(2)}</td>`;
                html += '</tr>';
                html += '</tbody>';
                html += '</table>';
                
                // 时段分析说明
                html += '<div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-700">';
                html += '<div class="font-medium mb-2">📊 时段分析说明：</div>';
                html += '<ul class="list-disc list-inside space-y-1">';
                html += `<li>分析时段：${startHour}:00 - ${endHour}:00（共${periodHours}小时）</li>`;
                html += `<li>数据天数：${displayData.length}天</li>`;
                html += `<li>时段总用电：${totalPeriodAll.toFixed(2)} kWh，占全天${overallPeriodPercentage.toFixed(1)}%</li>`;
                html += `<li>用电量最大日：${maxPeriodDate || '-'}（${isFinite(maxPeriodTotal) ? maxPeriodTotal.toFixed(2) : '0.00'} kWh）</li>`;
                html += `<li>用电量最小日：${minPeriodDate || '-'}（${isFinite(minPeriodTotal) ? minPeriodTotal.toFixed(2) : '0.00'} kWh）</li>`;
                html += '</ul>';
                html += '</div>';
                
                html += '</div>';
                return html;
            }
            
            // 直接显示时段统计（包含日期和时段分析）
            const unifiedHtml = generatePeriodStats();
            
            const unifiedStats = document.getElementById('unifiedStats');
            if (unifiedStats) {
                unifiedStats.innerHTML = unifiedHtml;
            }
        }

        // 导出部分函数
        function exportAsPNG() {
            if (!appData.chart) {
                showNotification('错误', '没有可导出的图表', 'error');
                return;
            }
            
            const quality = parseFloat(elements.pngQualitySelect.value);
            elements.loadCurveChart.toBlob(blob => {
                saveAs(blob, getExportFileName('图表', 'png'));
                showNotification('成功', '图表已导出为PNG', 'success');
            }, 'image/png', quality);
        }

        function exportAsJPG() {
            if (!appData.chart) {
                showNotification('错误', '没有可导出的图表', 'error');
                return;
            }
            
            elements.loadCurveChart.toBlob(blob => {
                saveAs(blob, getExportFileName('图表', 'jpg'));
                showNotification('成功', '图表已导出为JPG', 'success');
            }, 'image/jpeg', 0.9);
        }

        function exportAsSVG() {
            if (!appData.chart) {
                showNotification('错误', '没有可导出的图表', 'error');
                return;
            }
            
            // 生成SVG
            const svg = chartToSVG(appData.chart);
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            saveAs(blob, getExportFileName('图表', 'svg'));
            showNotification('成功', '图表已导出为SVG', 'success');
        }

        function exportHourlyData() {
            if (appData.processedData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 获取日期范围设置
            const exportAllDates = document.getElementById('exportAllDates').checked;
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            
            // 筛选要导出的数据
            let exportData = appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date)
            );
            
            // 如果不是导出所有日期，则应用日期范围筛选
            if (!exportAllDates && startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                exportData = exportData.filter(d => {
                    const currentDate = new Date(d.date);
                    return currentDate >= start && currentDate <= end;
                });
            }
            
            if (exportData.length === 0) {
                showNotification('错误', '没有符合筛选条件的数据可导出', 'error');
                return;
            }
            
            // 准备导出数据 - 每个日期24小时数据打包在一个表格
            const header = ['日期'];
            for (let hour = 0; hour < 24; hour++) {
                header.push(`${hour}:00`);
            }
            header.push('日总电能 (kWh)');
            
            const rows = [header];
            
            exportData.forEach(dateData => {
                const rowData = [dateData.date];
                let dailyTotal = 0;
                
                // 添加24小时数据
                for (let hour = 0; hour < 24; hour++) {
                    const value = dateData.hourlyData[hour] !== null 
                        ? dateData.hourlyData[hour] 
                        : 0;
                    
                    rowData.push(value);
                    dailyTotal += value;
                }
                
                // 添加日总电能
                rowData.push(dailyTotal);
                
                rows.push(rowData);
            });
            
            // 导出
            exportDataToFile(rows, '24小时电能明细');
        }

        function exportDailyStats() {
            if (appData.processedData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 筛选要导出的数据
            const exportData = appData.processedData.filter(d => 
                appData.visualization.selectedDates.includes(d.date)
            );
            
            if (exportData.length === 0) {
                showNotification('错误', '没有符合筛选条件的数据可导出', 'error');
                return;
            }
            
            // 准备导出数据
            const header = ['日期', '日总用电量 (kWh)', '平均小时用电量 (kWh)', '峰谷差值 (kWh)'];
            const rows = [header];
            
            exportData.forEach(dateData => {
                // 计算统计值
                const validHours = dateData.hourlyData.filter(v => v !== null);
                const hourlyAverage = validHours.length > 0 ? validHours.reduce((a, b) => a + b, 0) / validHours.length : 0;
                const peak = validHours.length > 0 ? Math.max(...validHours) : 0;
                const valley = validHours.length > 0 ? Math.min(...validHours) : 0;
                const peakValleyDiff = peak - valley;
                
                rows.push([
                    dateData.date,
                    dateData.dailyTotal.toFixed(2),
                    hourlyAverage.toFixed(2),
                    peakValleyDiff.toFixed(2)
                ]);
            });
            
            // 导出
            exportDataToFile(rows, '日统计数据');
        }

        function exportPVsystData() {
            if (appData.processedData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }

            // 始终使用所有处理后的数据
            let exportData = [...appData.processedData];
            console.log('=== PVSyst数据导出（按月份重新排列）===');
            console.log('原始数据条数:', exportData.length);

            // 检查所有日期的有效性
            console.log('检查所有日期的有效性...');
            let validDataCount = 0;
            
            exportData.forEach((row, index) => {
                let dateObj = null;
                
                // 尝试多种方式获取有效日期
                if (row.dateObj && !isNaN(row.dateObj.getTime())) {
                    dateObj = row.dateObj;
                } else if (row.date) {
                    // 增强的日期解析
                    dateObj = parseDate(row.date, appData.config.dateFormat);
                    if (!dateObj) {
                        // 尝试自动检测格式
                        dateObj = parseDate(row.date, 'auto');
                    }
                }
                
                if (!dateObj || isNaN(dateObj.getTime())) {
                    console.error(`无效日期在第${index}行: "${row.date}"`);
                    // 标记为无效
                    row._invalidDate = true;
                } else {
                    console.log(`有效日期在第${index}行: "${row.date}" -> ${dateObj.toISOString()}`);
                    // 确保dateObj存在
                    row.dateObj = dateObj;
                    validDataCount++;
                }
            });
            
            console.log(`有效数据: ${validDataCount}/${exportData.length}`);

            if (exportData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }

            // 创建基于真实日期的数据映射
            const realDateDataMap = new Map();
            
            if (exportData.length === 0) {
                showNotification('错误', '没有可导出的数据', 'error');
                return;
            }
            
            // 过滤掉无效日期的数据
            const validExportData = exportData.filter(dateData => !dateData._invalidDate);

            if (validExportData.length === 0) {
                showNotification('错误', '所有数据的日期格式都无效，无法导出', 'error');
                return;
            }
            
            const sortedExportData = [...validExportData].sort((a, b) => {
                return a.dateObj - b.dateObj;
            });

            // 构建真实日期的数据映射
            sortedExportData.forEach(dateData => {
                // 使用本地日期格式，避免UTC偏移
                const dateKey = formatDateForInput(dateData.dateObj); // YYYY-MM-DD格式
                
                if (dateData.hourlyData && Array.isArray(dateData.hourlyData) && dateData.hourlyData.length === 24) {
                    realDateDataMap.set(dateKey, dateData.hourlyData);
                } else {
                    realDateDataMap.set(dateKey, Array(24).fill(0));
                }
            });

            // 确定数据的实际年份范围
            const allRealDates = [...realDateDataMap.keys()].sort();
            let startRealDate, endRealDate;
            
            if (allRealDates.length > 0) {
                startRealDate = new Date(allRealDates[0]);
                endRealDate = new Date(allRealDates[allRealDates.length - 1]);
                console.log('实际数据日期范围:', formatDateForInput(startRealDate), '到', formatDateForInput(endRealDate));
            } else {
                console.log('警告：没有可用的实际数据');
                showNotification('警告', '没有可用的实际数据，将使用零值填充', 'warning');
            }
            console.log('实际数据天数:', realDateDataMap.size);

            // 创建月份顺序的日期映射（1月1日到12月31日）
            const monthOrderDateMap = new Map();
            
            // 如果没有实际数据，创建一个默认的零值数据集
            if (realDateDataMap.size === 0) {
                console.log('创建默认零值数据集');
                for (let targetMonth = 1; targetMonth <= 12; targetMonth++) {
                    const daysInMonth = new Date(2000, targetMonth, 0).getDate();
                    for (let targetDay = 1; targetDay <= daysInMonth; targetDay++) {
                        const monthDayKey = `${String(targetMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;
                        monthOrderDateMap.set(monthDayKey, {
                            data: Array(24).fill(0),
                            source: '零值填充'
                        });
                    }
                }
            } else {
                // 按月份从1月到12月的顺序处理
                for (let targetMonth = 1; targetMonth <= 12; targetMonth++) {
                    const daysInMonth = new Date(2000, targetMonth, 0).getDate();
                    
                    for (let targetDay = 1; targetDay <= daysInMonth; targetDay++) {
                        const monthDayKey = `${String(targetMonth).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;
                        
                        // 查找对应的真实数据
                        let matchedData = null;
                        let dataSource = '';
                        
                        // 优先查找同月同日的数据
                        for (const [realDate, data] of realDateDataMap) {
                            const realDateObj = new Date(realDate);
                            if (isNaN(realDateObj.getTime())) continue;
                            
                            if (realDateObj.getMonth() + 1 === targetMonth && realDateObj.getDate() === targetDay) {
                                matchedData = [...data];
                                dataSource = `实际数据-${realDate}`;
                                break;
                            }
                        }
                        
                        // 如果没有找到完全匹配的，使用最接近的数据
                        if (!matchedData) {
                            // 查找相邻年份的同月同日数据
                            const nearbyData = findNearestMonthDayData(targetMonth, targetDay, realDateDataMap);
                            if (nearbyData) {
                                matchedData = [...nearbyData.data];
                                dataSource = nearbyData.source;
                            } else {
                                // 使用前一天的数据，或查找相近月份的数据
                                const fallbackData = findFallbackData(targetMonth, targetDay, monthOrderDateMap, realDateDataMap);
                                matchedData = [...fallbackData.data];
                                dataSource = fallbackData.source;
                            }
                        }
                        
                        monthOrderDateMap.set(monthDayKey, {
                            data: matchedData,
                            source: dataSource
                        });
                    }
                }
            }

            // 生成CSV内容
            let csvContent = '';
            csvContent += '# 自定义负载曲线 - 按月份重新排列\n';
            csvContent += '# 生成时间: ' + new Date().toISOString() + '\n';
            csvContent += '# 数据来源: 负荷数据处理工具\n';
            csvContent += '# 说明: 按月份从低到高排列，去除年份影响\n';
            csvContent += '# 规则: 按月份和日匹配，缺失数据用最近有效数据补全\n';
            csvContent += '# 格式: DD/MM/YY hh:mm，年份固定为99\n';
            csvContent += '\n';
            csvContent += 'Date;P Load\n';
            csvContent += ';kW\n';

            // 按月份顺序生成8760小时数据
            let dataUsageStats = {
                actual: 0,
                fallback: 0,
                details: []
            };

            for (let month = 1; month <= 12; month++) {
                const daysInMonth = new Date(2000, month, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const monthDayKey = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayData = monthOrderDateMap.get(monthDayKey);
                    
                    if (dayData.source.startsWith('实际数据')) {
                        dataUsageStats.actual++;
                    } else {
                        dataUsageStats.fallback++;
                    }
                    
                    dataUsageStats.details.push({
                        monthDay: monthDayKey,
                        source: dayData.source,
                        total: dayData.data.reduce((a, b) => a + b, 0)
                    });

                    // 为每个小时生成数据行
                    for (let hour = 0; hour < 24; hour++) {
                        const value = dayData.data[hour] || 0;
                        const dayStr = String(day).padStart(2, '0');
                        const monthStr = String(month).padStart(2, '0');
                        const hourStr = String(hour).padStart(2, '0');
                        const dateTimeStr = `${dayStr}/${monthStr}/99 ${hourStr}:00`;
                        
                        csvContent += `${dateTimeStr};${value.toFixed(3)}\n`;
                    }
                }
            }

            // 输出统计信息
            console.log('=== 数据重新排列完成 ===');
            console.log('实际使用数据天数:', dataUsageStats.actual);
            console.log('补全数据天数:', dataUsageStats.fallback);
            console.log('总天数:', dataUsageStats.actual + dataUsageStats.fallback);
            console.log('数据覆盖率:', ((dataUsageStats.actual / (dataUsageStats.actual + dataUsageStats.fallback)) * 100).toFixed(1) + '%');

            // 导出CSV文件
            const fileName = getExportFileName('PVsyst月度重排8760小时数据', 'csv');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, fileName);

            showNotification('成功', 'PVsyst月度重排8760小时数据已导出', 'success');
        }


        function exportDataToFile(data, baseName) {
            const format = elements.exportFormatSelect.value;
            const fileName = getExportFileName(baseName, format);
            
            // 创建工作簿和工作表
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, baseName);
            
            // 导出文件
            if (format === 'csv') {
                const csv = XLSX.utils.sheet_to_csv(ws);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, fileName);
            } else {
                // 导出为Excel
                XLSX.writeFile(wb, fileName);
            }
            
            showNotification('成功', `${baseName}已导出为${format.toUpperCase()}`, 'success');
        }

        function getExportFileName(baseName, extension) {
            let fileName = `${elements.exportFileNameInput.value}_${baseName}`;
            
            // 添加筛选条件
            if (elements.includeFiltersInNameCheckbox.checked) {
                const startDate = elements.startDateInput.value || '开始日期';
                const endDate = elements.endDateInput.value || '结束日期';
                fileName += `_${startDate}_to_${endDate}`;
            }
            
            // 添加时间戳
            if (elements.includeTimestampCheckbox.checked) {
                const timestamp = new Date().toISOString().replace(/:/g, '-').slice(0, 19);
                fileName += `_${timestamp}`;
            }
            
            return `${fileName}.${extension}`;
        }

        function findNearbyData(month, day, dataMap) {
    // 寻找相近月份的数据
    const searchOrder = [
        [month, day],       // 当前月份
        [month-1, day],     // 前一个月
        [month+1, day],     // 后一个月
        [month, day-1],     // 前一天
        [month, day+1],     // 后一天
        [month-2, day],     // 前两个月
        [month+2, day]      // 后两个月
    ];
    
    for (const [m, d] of searchOrder) {
        if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
            const key = `${m}-${d}`;
            if (dataMap.has(key)) {
                return key;
            }
        }
    }
    
    // 如果找不到相近日期，尝试基于季节查找数据
    // 根据月份确定季节
    let season;
    if (month >= 3 && month <= 5) {
        season = 'spring'; // 春季
    } else if (month >= 6 && month <= 8) {
        season = 'summer'; // 夏季
    } else if (month >= 9 && month <= 11) {
        season = 'autumn'; // 秋季
    } else {
        season = 'winter'; // 冬季
    }
    
    // 根据季节查找对应月份的数据
    let seasonMonths = [];
    switch(season) {
        case 'spring':
            seasonMonths = [3, 4, 5];
            break;
        case 'summer':
            seasonMonths = [6, 7, 8];
            break;
        case 'autumn':
            seasonMonths = [9, 10, 11];
            break;
        case 'winter':
            seasonMonths = [12, 1, 2];
            break;
    }
    
    // 在同季节中查找数据
    for (const m of seasonMonths) {
        // 优先查找月中数据（15号左右）
        for (const d of [15, 14, 16, 13, 17, 12, 18, 11, 19, 10, 20]) {
            if (d <= new Date(2000, m, 0).getDate()) { // 确保日期有效
                const key = `${m}-${d}`;
                if (dataMap.has(key)) {
                    return key;
                }
            }
        }
    }
    
    // 如果还是找不到，查找任何可用的数据
    const allKeys = [...dataMap.keys()];
    if (allKeys.length > 0) {
        // 优先选择同季节的数据
        const seasonKeys = allKeys.filter(key => {
            const keyMonth = parseInt(key.split('-')[0]);
            return seasonMonths.includes(keyMonth);
        });
        
        if (seasonKeys.length > 0) {
            // 随机选择一个同季节的数据，避免总是使用同一个
            const randomIndex = Math.floor(Math.random() * seasonKeys.length);
            return seasonKeys[randomIndex];
        } else {
            // 如果没有同季节的数据，随机选择一个可用数据
            const randomIndex = Math.floor(Math.random() * allKeys.length);
            return allKeys[randomIndex];
        }
    }
    
    return null;
}

        function findNearestMonthDayData(targetMonth, targetDay, realDateDataMap) {
            // 查找最接近的月日数据
            if (!realDateDataMap || realDateDataMap.size === 0) {
                return null;
            }
            
            let bestMatch = null;
            let minDistance = Infinity;
            
            for (const [realDate, data] of realDateDataMap) {
                const realDateObj = new Date(realDate);
                if (isNaN(realDateObj.getTime())) {
                    console.warn('无效的日期在findNearestMonthDayData中:', realDate);
                    continue;
                }
                
                const realMonth = realDateObj.getMonth() + 1;
                const realDay = realDateObj.getDate();
                
                // 计算月日差异
                const monthDiff = Math.abs(realMonth - targetMonth);
                const dayDiff = Math.abs(realDay - targetDay);
                
                // 考虑月份循环（12月到1月只算1个月差异）
                const adjustedMonthDiff = Math.min(monthDiff, 12 - monthDiff);
                
                // 计算综合距离
                const distance = adjustedMonthDiff * 31 + dayDiff;
                
                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatch = { data, source: `最近匹配-${realDate}` };
                }
            }
            
            return bestMatch;
        }

        function findFallbackData(targetMonth, targetDay, monthOrderDateMap, realDateDataMap) {
            // 查找回退数据
            
            // 1. 尝试使用前一天的数据
            if (targetDay > 1) {
                const prevDayKey = `${String(targetMonth).padStart(2, '0')}-${String(targetDay - 1).padStart(2, '0')}`;
                const prevData = monthOrderDateMap.get(prevDayKey);
                if (prevData) {
                    return {
                        data: [...prevData.data],
                        source: `前一天数据-${prevDayKey}`
                    };
                }
            }
            
            // 2. 尝试使用同月的其他日数据
            if (realDateDataMap && realDateDataMap.size > 0) {
                const nearestMonthDay = findNearestMonthDayData(targetMonth, targetDay, realDateDataMap);
                if (nearestMonthDay) {
                    return nearestMonthDay;
                }
            }
            
            // 3. 使用任意可用数据
            if (realDateDataMap && realDateDataMap.size > 0) {
                const anyData = [...realDateDataMap.values()][0];
                if (anyData) {
                    return {
                        data: [...anyData],
                        source: '默认数据'
                    };
                }
            }
            
            // 4. 返回零值
            return {
                data: Array(24).fill(0),
                source: '零值填充'
            };
        }

        function updateDataOverview() {
            const dataStatus = document.getElementById('dataStatus');
            const currentDataCount = document.getElementById('currentDataCount');
            const currentDateRange = document.getElementById('currentDateRange');
            const currentMeteringPointCount = document.getElementById('currentMeteringPointCount');
            
            if (appData.parsedData && appData.parsedData.length > 0) {
                if (dataStatus && dataStatus.parentNode) {
                    dataStatus.classList.remove('hidden');
                }
                
                // 显示当前数据量
                if (currentDataCount && currentDataCount.parentNode) {
                    currentDataCount.textContent = appData.parsedData.length.toLocaleString();
                }
                
                // 计算日期范围
                const dates = [...new Set(appData.parsedData.map(item => item.date))].sort();
                if (dates.length > 0) {
                    const startDate = dates[0];
                    const endDate = dates[dates.length - 1];
                    // 使用formatDateRangeDisplay函数格式化日期范围
                    const formattedStartDate = formatDateRangeDisplay(startDate);
                    const formattedEndDate = formatDateRangeDisplay(endDate);
                    if (currentDateRange && currentDateRange.parentNode) {
                        currentDateRange.textContent = `${formattedStartDate} ~ ${formattedEndDate}`;
                    }
                } else {
                    if (currentDateRange && currentDateRange.parentNode) {
                        currentDateRange.textContent = '-';
                    }
                }
                
                // 计算计量点数量
                const uniqueMeteringPoints = [...new Set(appData.parsedData.map(item => item.meteringPoint))];
                if (currentMeteringPointCount && currentMeteringPointCount.parentNode) {
                    currentMeteringPointCount.textContent = uniqueMeteringPoints.length;
                }
            } else {
                if (dataStatus && dataStatus.parentNode) {
                    dataStatus.classList.add('hidden');
                }
            }
        }
        
        function startOver() {
            // 重置应用数据
            appData.files = [];
            appData.worksheets = [];
            appData.parsedData = [];
            appData.processedData = [];
            appData.config = {
                dataType: 'instantPower',
                multiplier: 1.0,
                useMultiplierColumn: false,
                multiplierColumn: '',
                dateColumn: '',

                dataStartColumn: '',
                dataEndColumn: '',
                dataStartIndex: 0,
                dataEndIndex: -1,
                meteringPointColumn: '',
                meteringPointFilter: '',
                dateFormat: 'YYYY-MM-DD',
                invalidDataHandling: 'ignore',
                timeInterval: 15,
                filterCount: 1,
                additionalFilters: []
            };
            appData.visualization = {
                selectedDates: [],
                selectedMeteringPoints: [],
                focusStartTime: 0,
                focusEndTime: 23,
                lineStyle: 'solid',
                showPoints: false,
                smoothCurve: true,
                curveTension: 0.4,
                secondaryAxis: false,
                showDailyTotalBarChart: true,
                // 新增：汇总模式（最高/最低 + 季度平均）
                summaryMode: false
            };
            appData.meteringPoints = [];
            
            // 重置UI
            elements.fileInput.value = '';
            elements.importedFiles.innerHTML = '';
            // 文件列表现在固定展开，无需隐藏
            if (elements.removeAllFiles && elements.removeAllFiles.parentNode) {
                elements.removeAllFiles.classList.add('hidden');
            }

            
            // 重置配置表单
            elements.dataTypeRadios[0].checked = true;
            elements.multiplierInput.value = '1.0';
            elements.useMultiplierColumnCheckbox.checked = false;
            if (elements.multiplierOptions && elements.multiplierOptions.parentNode) {
                elements.multiplierOptions.classList.remove('hidden');
            }
            if (elements.multiplierColumnOption && elements.multiplierColumnOption.parentNode) {
                elements.multiplierColumnOption.classList.add('hidden');
            }
            elements.dateColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataStartColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.dataEndColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';
            elements.meteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            elements.multiplierColumnSelect.innerHTML = '<option value="">-- 请选择 --</option>';

            elements.invalidDataHandlingSelect.value = 'ignore';
            elements.timeIntervalSelect.value = '15';
            elements.dataPreview.innerHTML = '请先完成数据配置，将显示数据预览';
            
            // 重置筛选项设置
            elements.filterCountInput.value = '1';
            elements.filterOptionsContainer.innerHTML = '';
            
            // 重置可视化表单
            elements.startDateInput.innerHTML = '<option value="">-- 请选择起始日期 --</option>';
            elements.endDateInput.innerHTML = '<option value="">-- 请选择结束日期 --</option>';
            elements.focusStartTimeSelect.value = '0';
            elements.focusEndTimeSelect.value = '23';
            elements.lineStyleSelect.value = 'solid';
            elements.showPointsSelect.value = 'false';
            elements.smoothCurveSelect.value = 'true';
            elements.curveTensionSelect.value = '0.4';
            elements.secondaryAxisCheckbox.checked = false;
            elements.visualizationMeteringPointFilterSelect.innerHTML = '<option value="">-- 全部计量点 --</option>';
            elements.dailyStats.innerHTML = '<p class="text-neutral">请先生成图表以查看统计信息</p>';
            elements.periodStats.innerHTML = '<p class="text-neutral">请先生成图表以查看统计信息</p>';
            
            // 重置日期选择
            appData.visualization.selectedDates = [];
            if (appData.chart) {
                appData.chart.destroy();
                appData.chart = null;
            }
            
            // 返回到导入部分
            goToImportSection();
            
            showNotification('信息', '已重置所有数据，可以重新开始', 'info');
        }

        // 导航函数
        function goToImportSection() {
            if (elements.importSection && elements.importSection.parentNode) {
                elements.importSection.classList.remove('hidden');
            }
            if (elements.configSection && elements.configSection.parentNode) {
                elements.configSection.classList.add('hidden');
            }
            if (elements.visualizationSection && elements.visualizationSection.parentNode) {
                elements.visualizationSection.classList.add('hidden');
            }
            if (elements.exportSection && elements.exportSection.parentNode) {
                elements.exportSection.classList.add('hidden');
            }
            
            // 更新步骤指示器（添加安全检查）
            if (elements.step2Indicator) {
                elements.step2Indicator.className = 'w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:bg-gray-400';
            }
            if (elements.step2Line) {
                elements.step2Line.className = 'w-8 h-0.5 bg-gray-300 rounded-full';
            }
            if (elements.step3Indicator) {
                elements.step3Indicator.className = 'w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:bg-gray-400';
            }
            if (elements.step3Line) {
                elements.step3Line.className = 'w-8 h-0.5 bg-gray-300 rounded-full';
            }
            if (elements.step4Indicator) {
                elements.step4Indicator.className = 'w-12 h-12 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-semibold text-sm shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:bg-gray-400';
            }
        }

        function goToConfigSection() {
            if (elements.importSection && elements.importSection.parentNode) {
                elements.importSection.classList.add('hidden');
            }
            if (elements.configSection && elements.configSection.parentNode) {
                elements.configSection.classList.remove('hidden');
            }
            if (elements.visualizationSection && elements.visualizationSection.parentNode) {
                elements.visualizationSection.classList.add('hidden');
            }
            if (elements.exportSection && elements.exportSection.parentNode) {
                elements.exportSection.classList.add('hidden');
            }
            
            // 更新步骤导航状态
            updateStepNavigation('configSection');
            
            // 标记第一步为已完成
            completeStep(1);
            
            // 自动触发数据解析和预览更新
            console.log('进入配置步骤，自动触发数据解析...');
            setTimeout(() => {
                if (appData.worksheets && appData.worksheets.length > 0) {
                    try {
                        // 解析工作表数据
                        parseWorksheetData();
                        
                        // 处理解析后的数据
                        processParsedData();
                        
                        // 更新计量点筛选选项
                        updateMeteringPointFilterOptions();
                        
                        // 更新数据预览
                        updateDataPreview();
                        
                        console.log('数据解析和预览更新完成，共处理数据点:', appData.processedData.length);
                        
                        // 显示成功通知
                        if (appData.processedData.length > 0) {
                            showNotification('成功', `数据解析完成，共处理 ${appData.processedData.length} 条记录`, 'success');
                        } else {
                            showNotification('信息', '数据解析完成，但未找到有效数据', 'warning');
                        }
                        
                    } catch (error) {
                        console.error('数据解析出错:', error);
                        showNotification('错误', '数据解析失败: ' + error.message, 'error');
                    }
                } else {
                    console.log('没有工作表数据可供解析');
                }
            }, 100);
        }

        function goToVisualizationSection() {
    console.log('进入可视化步骤，使用最新配置重新处理数据...');
    
    // 使用最新配置重新处理数据，确保第三步可视化使用第二步的最新配置
    reprocessDataWithConfig();
    
    // 更新计量点编号筛选选项（reprocessDataWithConfig已调用，但再调用一次确保最新）
    updateMeteringPointFilterOptions();
    
    // 更新步骤导航状态
    updateStepNavigation('visualizationSection');
    
    // 标记第二步为已完成
    completeStep(2);
    
    // 切换显示部分
    if (elements.configSection && elements.configSection.parentNode) {
        elements.configSection.classList.add('hidden');
    }
    if (elements.visualizationSection && elements.visualizationSection.parentNode) {
        elements.visualizationSection.classList.remove('hidden');
    }
    if (elements.exportSection && elements.exportSection.parentNode) {
        elements.exportSection.classList.add('hidden');
    }
    
    // 检查是否已存在图表实例，如果存在则先销毁
    if (appData.chart) {
        appData.chart.destroy();
        appData.chart = null;
    }
    
    // 初始化可视化
            initializeVisualization();
            
            // 初始化日期总用电量柱状图
            initDailyTotalBarChart();
            
            // 确保图表显示数据（reprocessDataWithConfig已包含此逻辑，但再调用一次确保）
            setTimeout(() => {
                updateChart();
                
                // 添加调试信息检查数据状态
                console.log('=== 页面初始化完成后的数据状态 ===');
                console.log('processedData长度:', appData.processedData.length);
                console.log('柱状图实例存在:', !!appData.dailyTotalBarChart);
                
                if (appData.processedData.length > 0) {
                    console.log('第一条数据:', appData.processedData[0]);
                    console.log('第一条数据dailyTotal:', appData.processedData[0].dailyTotal);
                    console.log('第一条数据类型:', typeof appData.processedData[0].dailyTotal);
                    
                    // 验证数据格式并准备柱状图数据
                    const chartData = appData.processedData.map(item => ({
                        date: String(item.date || '').replace(/-/g, ''),
                        dailyTotal: Number(item.dailyTotal) || 0,
                        hourlyData: item.hourlyData || []
                    })).filter(item => item.dailyTotal > 0);
                    
                    console.log('格式化后的图表数据:', chartData);
                    
                    if (chartData.length > 0 && appData.dailyTotalBarChart) {
                        console.log('使用实际数据更新柱状图...');
                        updateDailyTotalBarChart(chartData);
                    } else {
                        console.log('数据格式有问题或柱状图未初始化');
                    }
                } else {
                    console.log('没有数据，创建测试数据来验证柱状图功能...');
                    // 创建测试数据
                    const testData = [
                        { date: '2024-09-01', dailyTotal: 2354.28, hourlyData: Array(24).fill(0).map((_, i) => 98) },
                        { date: '2024-09-02', dailyTotal: 2213.70, hourlyData: Array(24).fill(0).map((_, i) => 92) },
                        { date: '2024-09-03', dailyTotal: 2079.54, hourlyData: Array(24).fill(0).map((_, i) => 87) },
                        { date: '2024-09-04', dailyTotal: 2171.19, hourlyData: Array(24).fill(0).map((_, i) => 90) },
                        { date: '2024-09-05', dailyTotal: 2188.41, hourlyData: Array(24).fill(0).map((_, i) => 91) }
                    ];
                    console.log('测试数据:', testData);
                    
                    // 测试柱状图更新
                    if (appData.dailyTotalBarChart) {
                        console.log('使用测试数据更新柱状图...');
                        updateDailyTotalBarChart(testData);
                    }
                }
                console.log('===============================');
            }, 500);
            
}

        function goToExportSection() {
            if (elements.importSection && elements.importSection.parentNode) {
                elements.importSection.classList.add('hidden');
            }
            if (elements.configSection && elements.configSection.parentNode) {
                elements.configSection.classList.add('hidden');
            }
            if (elements.visualizationSection && elements.visualizationSection.parentNode) {
                elements.visualizationSection.classList.add('hidden');
            }
            if (elements.exportSection && elements.exportSection.parentNode) {
                elements.exportSection.classList.remove('hidden');
            }
            
            // 更新步骤导航状态
            updateStepNavigation('exportSection');
            
            // 标记第三步为已完成
            completeStep(3);
        }

        // 通知和模态框函数
        function showNotification(title, message, type = 'info') {
            const iconMap = {
                success: 'fa-check-circle text-success',
                error: 'fa-times-circle text-danger',
                warning: 'fa-exclamation-triangle text-warning',
                info: 'fa-info-circle text-primary'
            };
            
            // 防御性检查所有通知相关元素
            if (!elements.notification || !elements.notificationTitle || !elements.notificationMessage || !elements.notificationIcon) {
                console.warn('通知元素不存在，无法显示通知:', title, message);
                return;
            }
            
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notificationIcon.className = `fa ${iconMap[type] || iconMap.info}`;
            
            if (elements.notification && elements.notification.parentNode) {
                elements.notification.classList.remove('hidden', 'bg-success/10', 'bg-danger/10', 'bg-warning/10', 'bg-primary/10');
                elements.notification.classList.add(`bg-${type === 'info' ? 'primary' : type}/10`);
            }
            
            // 显示动画
            setTimeout(() => {
                if (elements.notification && elements.notification.parentNode) {
                    elements.notification.classList.remove('translate-y-20', 'opacity-0');
                }
            }, 10);
            
            // 自动隐藏
            setTimeout(hideNotification, 5000);
        }

        function hideNotification() {
            if (!elements.notification || !elements.notification.parentNode) {
                return;
            }
            
            elements.notification.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => {
                if (elements.notification && elements.notification.parentNode) {
                    elements.notification.classList.add('hidden');
                }
            }, 300);
        }
        
        // 增强的时间间隔检测结果通知显示
        function showEnhancedIntervalNotification(detectionResult) {
            const confidence = Math.round(detectionResult.confidence * 100);
            let title, message, type;
            
            // 根据置信度和检测方法确定通知类型和内容
            if (detectionResult.confidence >= 0.9) {
                title = '🎯 高精度检测';
                type = 'success';
                message = `${detectionResult.message}\n检测方法：${detectionResult.method}\n置信度：${confidence}%（非常可靠）`;
            } else if (detectionResult.confidence >= 0.8) {
                title = '✅ 检测成功';
                type = 'success';
                message = `${detectionResult.message}\n检测方法：${detectionResult.method}\n置信度：${confidence}%（可靠）`;
            } else if (detectionResult.confidence >= 0.6) {
                title = '⚠️ 检测结果';
                type = 'warning';
                message = `${detectionResult.message}\n检测方法：${detectionResult.method}\n置信度：${confidence}%（建议手动确认）`;
            } else if (detectionResult.confidence >= 0.4) {
                title = '❓ 低置信度检测';
                type = 'warning';
                message = `${detectionResult.message}\n检测方法：${detectionResult.method}\n置信度：${confidence}%（建议手动设置）`;
            } else {
                title = '🔧 使用默认值';
                type = 'info';
                message = `${detectionResult.message}\n检测方法：${detectionResult.method}\n置信度：${confidence}%（请手动设置正确的时间间隔）`;
            }
            
            // 添加详细信息（如果有）
            if (detectionResult.details) {
                message += `\n详细信息：${detectionResult.details}`;
            }
            
            showNotification(title, message, type);
        }

        function showModal(title, content) {
            if (elements.modalTitle) {
                elements.modalTitle.textContent = title;
            }
            if (elements.modalContent) {
                elements.modalContent.innerHTML = content;
            }
            
            if (elements.modalOverlay && elements.modalOverlay.parentNode) {
                elements.modalOverlay.classList.remove('hidden');
            }
            setTimeout(() => {
                if (elements.modal && elements.modal.parentNode) {
                    elements.modal.classList.remove('scale-95', 'opacity-0');
                    elements.modal.classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        function closeModal() {
            if (elements.modal && elements.modal.parentNode) {
                elements.modal.classList.remove('scale-100', 'opacity-100');
                elements.modal.classList.add('scale-95', 'opacity-0');
            }
            setTimeout(() => {
                if (elements.modalOverlay && elements.modalOverlay.parentNode) {
                    elements.modalOverlay.classList.add('hidden');
                }
            }, 300);
        }

        function showHelpModal() {
            const helpContent = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-primary mb-2">如何使用本工具？</h4>
                        <p class="text-sm">本工具分为四个步骤：导入数据 → 数据配置 → 可视化 → 导出结果。请按照步骤完成操作。</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">支持的数据格式</h4>
                        <p class="text-sm">支持Excel (.xlsx, .xls) 和CSV (.csv) 格式的用电数据表格。</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">数据类型说明</h4>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            <li><strong>15分钟瞬时功率</strong>：每15分钟一个功率值(kW)，工具会计算每小时的电能</li>
                            <li><strong>15分钟累积电能</strong>：每15分钟一个累积电能值(kWh)，工具会计算每小时的电能差值</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-primary mb-2">常见问题</h4>
                        <div class="space-y-2 text-sm">
                            <p><strong>Q: 为什么导入文件后没有数据？</strong></p>
                            <p>A: 请检查数据配置是否正确，特别是日期列和数据列的选择是否准确。</p>
                            
                            <p><strong>Q: 如何处理无效数据？</strong></p>
                            <p>A: 工具提供两种处理方式：忽略无效数据或用相邻有效数据填充。</p>
                            
                            <p><strong>Q: 可以同时导入多个文件吗？</strong></p>
                            <p>A: 可以，工具支持多文件导入并合并处理数据。</p>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('使用帮助', helpContent);
        }

        function showAboutModal() {
            const aboutContent = `
                <div class="space-y-4">
                    <div class="text-center">
                        <i class="fa fa-line-chart text-4xl text-primary mb-2"></i>
                        <h4 class="text-xl font-bold text-primary">24小时负荷曲线生成工具</h4>
                        <p class="text-neutral">版本 1.0.0</p>
                    </div>
                    
                    <div>
                        <p class="text-sm">本工具用于处理用电数据表格，生成24小时负荷曲线图表，支持按日期区分曲线类别，适配不同格式的原始数据。</p>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">主要功能</h4>
                        <ul class="list-disc pl-5 text-sm space-y-1">
                            <li>支持多文件导入处理汇总</li>
                            <li>处理15分钟瞬时功率和累积电能数据</li>
                            <li>按日期范围筛选显示曲线</li>
                            <li>自定义显示时段，聚焦用电高峰</li>
                            <li>计算并展示日总用电量等统计信息</li>
                            <li>导出图表为PNG/JPG/SVG，导出数据为Excel/CSV</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showModal('关于工具', aboutContent);
        }

        // 工具函数
        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return null;
            
            // 检查是否为无效数据标记
            const strValue = String(value).trim().toLowerCase();
            if (strValue === '未采集' || strValue === '故障' || strValue === '无数据' || strValue === 'n/a' || strValue === 'null') {
                return null;
            }
            
            // 处理千分位分隔符（如1,234.56或1.234,56）
            let processedStr = strValue;
            
            // 检测并处理千分位分隔符
            // 情况1：1,234.56（逗号为千分位，点号为小数点）
            if (processedStr.includes(',') && processedStr.includes('.')) {
                // 如果逗号在点号前面，且逗号后不是3位数字，则可能是欧洲格式（1.234,56）
                const commaPos = processedStr.indexOf(',');
                const dotPos = processedStr.indexOf('.');
                
                if (commaPos < dotPos && (dotPos - commaPos) !== 4) {
                    // 可能是欧洲格式，将点号替换为空，逗号替换为点号
                    processedStr = processedStr.replace(/\./g, '').replace(',', '.');
                } else {
                    // 标准格式，移除逗号
                    processedStr = processedStr.replace(/,/g, '');
                }
            } 
            // 情况2：1.234,56（点号为千分位，逗号为小数点）
            else if (processedStr.includes(',') && processedStr.lastIndexOf(',') > processedStr.length - 4) {
                // 逗号在最后3位之前，可能是欧洲格式的小数点
                processedStr = processedStr.replace(/\./g, '').replace(',', '.');
            }
            // 情况3：只有逗号，可能是千分位或小数点
            else if (processedStr.includes(',')) {
                const commaPos = processedStr.indexOf(',');
                const afterComma = processedStr.substring(commaPos + 1);
                
                if (afterComma.length === 3 && commaPos > 0) {
                    // 可能是千分位分隔符
                    processedStr = processedStr.replace(/,/g, '');
                } else {
                    // 可能是小数点
                    processedStr = processedStr.replace(',', '.');
                }
            }
            
            // 处理百分比（如12.34%或12,34%）
            if (processedStr.includes('%')) {
                processedStr = processedStr.replace('%', '');
                const num = parseFloat(processedStr);
                return isNaN(num) ? null : num / 100;
            }
            
            // 处理科学计数法（如1.23e+4或1.23E-4）
            if (/[eE][+-]?\d+$/.test(processedStr)) {
                const num = parseFloat(processedStr);
                return isNaN(num) ? null : num;
            }
            
            // 处理货币符号（如$123.45或¥123.45）
            processedStr = processedStr.replace(/[$￥€£¥]/g, '');
            
            // 处理单位（如123.45kW或123.45kWh）
            const unitMatch = processedStr.match(/^([\d.]+)([a-zA-Z]+)$/);
            if (unitMatch) {
                const numStr = unitMatch[1];
                const unit = unitMatch[2].toLowerCase();
                
                const num = parseFloat(numStr);
                if (isNaN(num)) return null;
                
                // 处理常见单位
                switch (unit) {
                    case 'k':
                        return num * 1000;
                    case 'm':
                        return num * 1000000;
                    case 'g':
                        return num * 1000000000;
                    case 't':
                        return num * 1000;
                    default:
                        // 其他单位不转换，只返回数字部分
                        return num;
                }
            }
            
            // 尝试解析为数字
            const num = parseFloat(processedStr);
            return isNaN(num) ? null : num;
        }

        function isDateLike(value) {
            if (!value) return false;
            
            const strValue = String(value).trim();
            if (!strValue) return false;
            
            // 扩展的日期格式检测模式
            const datePatterns = [
                /^\d{4}-\d{1,2}-\d{1,2}$/, // YYYY-MM-DD 或 YYYY-M-D
                /^\d{4}\/\d{1,2}\/\d{1,2}$/, // YYYY/MM/DD 或 YYYY/M/D
                /^\d{1,2}\/\d{1,2}\/\d{4}$/, // MM/DD/YYYY 或 DD/MM/YYYY
                /^\d{1,2}\/\d{1,2}\/\d{2}$/, // MM/DD/YY 或 M/D/YY
                /^\d{1,2}-\d{1,2}-\d{4}$/, // DD-MM-YYYY 或 D-M-YYYY
                /^\d{1,2}-\d{1,2}-\d{2}$/, // DD-MM-YY 或 D-M-YY
                /^\d{8}$/, // YYYYMMDD
                /^\d{2}\d{2}\d{4}$/, // DDMMYYYY
                /^\d{4}\.\d{1,2}\.\d{1,2}$/, // YYYY.MM.DD
                /^\d{1,2}\.\d{1,2}\.\d{4}$/, // DD.MM.YYYY
                /^\d{1,2}\.\d{1,2}\.\d{2}$/, // DD.MM.YY
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/, // MM/DD/YYYY HH:MM
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}/, // YYYY-MM-DD HH:MM
                /^\d{1,2}\/\d{1,2}\/\d{2}\s+\d{1,2}:\d{2}/, // MM/DD/YY HH:MM
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}:\d{2}/, // YYYY-MM-DD HH:MM:SS
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}/, // MM/DD/YYYY HH:MM:SS
                /^\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{2}:\d{2}\.\d{3}/, // YYYY-MM-DD HH:MM:SS.mmm
                /^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{2}:\d{2}/, // ISO格式 YYYY-MM-DDTHH:MM:SS
                /^\d{4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{2}:\d{2}\.\d{3}/, // ISO格式 YYYY-MM-DDTHH:MM:SS.mmm
                /^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}\s+[AP]M/, // MM/DD/YYYY HH:MM AM/PM
                /^\d{1,2}-\d{1,2}-\d{4}\s+\d{1,2}:\d{2}\s+[AP]M/ // DD-MM-YYYY HH:MM AM/PM
            ];
            
            // 检查是否匹配任何日期格式
            for (let pattern of datePatterns) {
                if (pattern.test(strValue)) {
                    return true;
                }
            }
            
            // 检查是否为Excel日期序列号（纯数字）
            if (/^\d+$/.test(strValue) && parseInt(strValue) > 0) {
                return true;
            }
            
            // 检查是否为日期对象可解析的格式
            const testDate = new Date(strValue);
            if (!isNaN(testDate.getTime()) && strValue.length > 5) {
                return true;
            }
            
            return false;
        }

        function parseDate(dateStr, format) {
            try {
                let year, month, day, hour = 0, minute = 0, second = 0;
                
                dateStr = String(dateStr).trim();
                if (!dateStr) return null;
                
                // 清理日期字符串，移除多余的空格
                dateStr = dateStr.replace(/\s+/g, ' ').trim();
                
                // 处理带时间的日期格式
                let datePart = dateStr;
                let timePart = null;
                
                // 分离日期和时间部分
                const timeMatch = dateStr.match(/(\d{1,2}:\d{2}(?::\d{2})?(?:\.\d{3})?\s*(?:[AP]M)?)$/i);
                if (timeMatch) {
                    timePart = timeMatch[1];
                    datePart = dateStr.substring(0, timeMatch.index).trim();
                }
                
                // 解析时间部分
                if (timePart) {
                    const timeStr = timePart.trim();
                    let timeHour, timeMinute, timeSecond = 0;
                    
                    // 处理AM/PM格式
                    const ampmMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
                    if (ampmMatch) {
                        timeHour = parseInt(ampmMatch[1]);
                        timeMinute = parseInt(ampmMatch[2]);
                        const ampm = ampmMatch[3].toUpperCase();
                        
                        if (ampm === 'PM' && timeHour < 12) timeHour += 12;
                        if (ampm === 'AM' && timeHour === 12) timeHour = 0;
                    } else {
                        // 处理24小时格式
                        const timeParts = timeStr.split(':');
                        timeHour = parseInt(timeParts[0]) || 0;
                        timeMinute = parseInt(timeParts[1]) || 0;
                        if (timeParts[2]) {
                            const secondPart = timeParts[2].replace(/\.\d{3}$/, '');
                            timeSecond = parseInt(secondPart) || 0;
                        }
                    }
                    
                    hour = timeHour;
                    minute = timeMinute;
                    second = timeSecond;
                }
                
                // 根据指定格式解析日期
                if (format === 'YYYY-MM-DD') {
                    const parts = datePart.split('-');
                    if (parts.length >= 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        day = parseInt(parts[2]);
                    }
                } else if (format === 'YYYY/MM/DD') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        year = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        day = parseInt(parts[2]);
                    }
                } else if (format === 'MM/DD/YYYY') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        month = parseInt(parts[0]) - 1;
                        day = parseInt(parts[1]);
                        year = parseInt(parts[2]);
                    }
                } else if (format === 'DD/MM/YYYY') {
                    const parts = datePart.split('/');
                    if (parts.length >= 3) {
                        day = parseInt(parts[0]);
                        month = parseInt(parts[1]) - 1;
                        year = parseInt(parts[2]);
                    }
                }
                
                // 如果指定格式未成功解析，尝试自动检测格式
                if (!year || month === undefined || !day) {
                    // 处理YYYY-MM-DD格式
                    const ymdMatch = datePart.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
                    if (ymdMatch) {
                        year = parseInt(ymdMatch[1]);
                        month = parseInt(ymdMatch[2]) - 1;
                        day = parseInt(ymdMatch[3]);
                    } else {
                        // 处理YYYY/MM/DD格式
                        const ymdSlashMatch = datePart.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
                        if (ymdSlashMatch) {
                            year = parseInt(ymdSlashMatch[1]);
                            month = parseInt(ymdSlashMatch[2]) - 1;
                            day = parseInt(ymdSlashMatch[3]);
                        } else {
                            // 处理MM/DD/YYYY格式
                            const mdyMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                            if (mdyMatch) {
                                month = parseInt(mdyMatch[1]) - 1;
                                day = parseInt(mdyMatch[2]);
                                year = parseInt(mdyMatch[3]);
                            } else {
                                // 处理DD/MM/YYYY格式
                                const dmyMatch = datePart.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                                if (dmyMatch) {
                                    day = parseInt(dmyMatch[1]);
                                    month = parseInt(dmyMatch[2]) - 1;
                                    year = parseInt(dmyMatch[3]);
                                } else {
                                    // 处理YYYYMMDD格式
                                    const yyyymmddMatch = datePart.match(/^(\d{4})(\d{2})(\d{2})$/);
                                    if (yyyymmddMatch) {
                                        year = parseInt(yyyymmddMatch[1]);
                                        month = parseInt(yyyymmddMatch[2]) - 1;
                                        day = parseInt(yyyymmddMatch[3]);
                                    } else {
                                        // 处理DDMMYYYY格式
                                        const ddmmyyyyMatch = datePart.match(/^(\d{2})(\d{2})(\d{4})$/);
                                        if (ddmmyyyyMatch) {
                                            day = parseInt(ddmmyyyyMatch[1]);
                                            month = parseInt(ddmmyyyyMatch[2]) - 1;
                                            year = parseInt(ddmmyyyyMatch[3]);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // 检查是否为有效日期
                if (year && month !== undefined && day) {
                    // 验证月份和日期范围
                    if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                        const date = new Date(year, month, day, hour, minute, second);
                        
                        // 验证日期是否有效
                        if (date.getFullYear() === year && 
                            date.getMonth() === month && 
                            date.getDate() === day) {
                            return date;
                        }
                    }
                }
                
                // 尝试让Date对象自动解析（处理更多格式）
                try {
                    const autoDate = new Date(dateStr);
                    if (!isNaN(autoDate.getTime())) {
                        if (timePart) {
                            autoDate.setHours(hour, minute, second);
                        }
                        return autoDate;
                    }
                } catch (e) {
                    // 忽略解析错误
                }
                
                // 尝试处理Excel日期序列号（数字格式）
                if (/^\d+$/.test(dateStr) && !isNaN(parseInt(dateStr))) {
                    const excelDate = parseInt(dateStr);
                    // Excel日期序列号从1900-01-01开始，但需要考虑闰年bug
                    if (excelDate >= 1 && excelDate <= 2958465) { // Excel有效日期范围
                        const baseDate = new Date(1900, 0, 1);
                        baseDate.setDate(baseDate.getDate() + excelDate - 1);
                        if (timePart) {
                            baseDate.setHours(hour, minute, second);
                        }
                        return baseDate;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error parsing date:', error);
                return null;
            }
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 格式化日期范围显示
        function formatDateRangeDisplay(dateString) {
            if (!dateString) return '';
            
            // 直接使用Date对象解析日期字符串
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                // 如果直接解析失败，尝试使用parseDate函数
                const parsedDate = parseDate(dateString);
                if (!parsedDate) return dateString;
                return formatDateForInput(parsedDate);
            }
            
            // 使用formatDateForInput函数格式化日期
            return formatDateForInput(date);
        }

        function getColorForIndex(index) {
            // 优化的专业配色方案 - 基于Tailwind CSS色彩系统
            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                '#06B6D4', '#F97316', '#84CC16', '#EC4899', '#6366F1',
                '#14B8A6', '#F43F5E', '#A855F7', '#0EA5E9', '#EAB308',
                '#22C55E', '#D946EF', '#F87171', '#34D399', '#60A5FA',
                '#FBBF24', '#A78BFA', '#FB923C', '#67E8F9', '#FDA4AF'
            ];
            
            return colors[index % colors.length];
        }

        function getLineDash(style) {
            switch (style) {
                case 'solid':
                    return [];
                case 'dashed':
                    return [5, 5];
                case 'dotted':
                    return [2, 2];
                case 'dashdot':
                    return [5, 2, 2, 2];
                default:
                    return [];
            }
        }

        function chartToSVG(chart) {
            // 将Chart.js图表转换为SVG
            const canvas = chart.canvas;
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvas.width);
            svg.setAttribute('height', canvas.height);
            svg.setAttribute('viewBox', `0 0 ${canvas.width} ${canvas.height}`);
            
            const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
            image.setAttribute('width', canvas.width);
            image.setAttribute('height', canvas.height);
            image.setAttribute('href', canvas.toDataURL('image/png'));
            
            svg.appendChild(image);
            
            return new XMLSerializer().serializeToString(svg);
        }
        
        // 辅助函数：将间隔四舍五入到最接近的标准值
        function roundToNearestStandardInterval(interval) {
            const standardIntervals = [1, 5, 15, 30, 60];
            
            // 找到最接近的标准间隔
            let closestInterval = standardIntervals[0];
            let minDiff = Math.abs(interval - closestInterval);
            
            for (let i = 1; i < standardIntervals.length; i++) {
                const diff = Math.abs(interval - standardIntervals[i]);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestInterval = standardIntervals[i];
                }
            }
            
            return closestInterval;
        }
        
        // 时间戳间隔分析函数
        function analyzeTimestampIntervals(timestamps, dateKey) {
            if (!timestamps || timestamps.length < 3) return null;
            
            // 排序时间戳
            const sortedTimestamps = [...timestamps].sort((a, b) => a - b);
            const intervals = [];
            const intervalCounts = {};
            
            // 计算所有相邻时间戳的间隔
            for (let i = 1; i < sortedTimestamps.length; i++) {
                const intervalMs = sortedTimestamps[i] - sortedTimestamps[i-1];
                const intervalMinutes = intervalMs / (1000 * 60);
                
                // 过滤合理的间隔（1分钟到2小时）
                if (intervalMinutes >= 1 && intervalMinutes <= 120) {
                    intervals.push(intervalMinutes);
                    
                    // 统计间隔频次（四舍五入到最近的整数）
                    const roundedInterval = Math.round(intervalMinutes);
                    intervalCounts[roundedInterval] = (intervalCounts[roundedInterval] || 0) + 1;
                }
            }
            
            if (intervals.length === 0) return null;
            
            // 找到最频繁的间隔
            let mostFrequentInterval = null;
            let maxCount = 0;
            for (const [interval, count] of Object.entries(intervalCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    mostFrequentInterval = parseInt(interval);
                }
            }
            
            // 计算统计信息
            const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const medianInterval = intervals.sort((a, b) => a - b)[Math.floor(intervals.length / 2)];
            const stdDev = Math.sqrt(intervals.reduce((sum, val) => sum + Math.pow(val - avgInterval, 2), 0) / intervals.length);
            
            // 计算一致性分数
            const consistencyScore = maxCount / intervals.length;
            const variabilityScore = 1 - Math.min(stdDev / avgInterval, 1);
            
            // 选择最佳间隔（优先考虑最频繁的，然后是中位数）
            let detectedInterval = mostFrequentInterval;
            if (consistencyScore < 0.6) {
                detectedInterval = Math.round(medianInterval);
            }
            
            const closestStandard = roundToNearestStandardInterval(detectedInterval);
            
            // 计算置信度
            let confidence = 0.5;
            if (consistencyScore >= 0.8 && variabilityScore >= 0.8) {
                confidence = 0.95;
            } else if (consistencyScore >= 0.6 && variabilityScore >= 0.6) {
                confidence = 0.85;
            } else if (consistencyScore >= 0.4 || variabilityScore >= 0.4) {
                confidence = 0.7;
            }
            
            // 如果检测到的间隔与标准间隔完全匹配，提高置信度
            if (detectedInterval === closestStandard) {
                confidence = Math.min(0.98, confidence + 0.1);
            }
            
            return {
                interval: closestStandard,
                description: `${closestStandard}分钟`,
                confidence: confidence,
                method: '时间戳间隔分析',
                details: `${dateKey}日期分析${intervals.length}个间隔，平均${avgInterval.toFixed(1)}分钟，最频繁${mostFrequentInterval}分钟（${maxCount}次），一致性${(consistencyScore*100).toFixed(1)}%`
            };
        }
        
        // 跨日期时间戳模式分析函数
        function analyzeCrossDateTimestampPattern(timeStampAnalysis) {
            const dateKeys = Object.keys(timeStampAnalysis);
            if (dateKeys.length < 2) return null;
            
            const allIntervalResults = [];
            const intervalFrequency = {};
            
            // 分析每个日期的时间戳模式
            for (const dateKey of dateKeys) {
                const timestamps = timeStampAnalysis[dateKey];
                if (timestamps.length < 3) continue;
                
                const result = analyzeTimestampIntervals(timestamps, dateKey);
                if (result && result.confidence >= 0.6) {
                    allIntervalResults.push(result);
                    intervalFrequency[result.interval] = (intervalFrequency[result.interval] || 0) + 1;
                }
            }
            
            if (allIntervalResults.length === 0) return null;
            
            // 找到最一致的间隔
            let mostConsistentInterval = null;
            let maxFrequency = 0;
            for (const [interval, frequency] of Object.entries(intervalFrequency)) {
                if (frequency > maxFrequency) {
                    maxFrequency = frequency;
                    mostConsistentInterval = parseInt(interval);
                }
            }
            
            // 计算跨日期一致性
            const consistencyRatio = maxFrequency / allIntervalResults.length;
            const avgConfidence = allIntervalResults
                .filter(r => r.interval === mostConsistentInterval)
                .reduce((sum, r) => sum + r.confidence, 0) / maxFrequency;
            
            // 计算最终置信度
            let finalConfidence = avgConfidence * consistencyRatio;
            if (consistencyRatio >= 0.8) {
                finalConfidence = Math.min(0.95, finalConfidence + 0.1);
            }
            
            return {
                interval: mostConsistentInterval,
                description: `${mostConsistentInterval}分钟`,
                confidence: finalConfidence,
                method: '跨日期模式分析',
                details: `分析${dateKeys.length}个日期，${maxFrequency}个日期检测到${mostConsistentInterval}分钟间隔，一致性${(consistencyRatio*100).toFixed(1)}%`
            };
        }
        
        // 增强的智能时间间隔检测函数 - 多维度综合分析
        function detectTimeIntervalIntelligently(data, startIndex, endIndex, dateCol, meteringPointCol, selectedMeteringPoint, isCrossDateStructure, dataColumnCount) {
            const standardIntervals = [
                { interval: 1, points: 1440, description: '1分钟', tolerance: 0.01, weight: 1.0 },
                { interval: 5, points: 288, description: '5分钟', tolerance: 0.02, weight: 1.0 },
                { interval: 15, points: 96, description: '15分钟', tolerance: 0.01, weight: 1.0 }, // 96行数据精确匹配15分钟
                { interval: 30, points: 48, description: '30分钟', tolerance: 0.02, weight: 0.8 },
                { interval: 60, points: 24, description: '60分钟', tolerance: 0.05, weight: 1.0 }
            ];
            
            let detectionResults = [];
            let analysisLog = [];
            
            // 数据预处理
            const processedData = [];
            const dateCellCounts = {};
            const timestamps = [];
            
            for (let i = startIndex; i <= Math.min(endIndex, data.length - 1); i++) {
                const row = data[i];
                if (!row || !row[dateCol]) continue;
                
                // 检查计量点编号筛选
                if (meteringPointCol !== null && selectedMeteringPoint) {
                    const rowMeteringPoint = String(row[meteringPointCol]).trim();
                    if (rowMeteringPoint !== selectedMeteringPoint) continue;
                }
                
                // 解析日期
                const dateStr = String(row[dateCol]).trim();
                const date = parseDate(dateStr, appData.config.dateFormat);
                if (!date) continue;
                
                const dateKey = formatDateKey(date);
                const timestamp = date.getTime();
                
                processedData.push({
                    date: dateKey,
                    timestamp: timestamp,
                    rawData: row
                });
                
                dateCellCounts[dateKey] = (dateCellCounts[dateKey] || 0) + 1;
                timestamps.push(timestamp);
            }
            
            // 96行数据特殊处理 - 直接识别为15分钟间隔
            const totalRows = processedData.length;
            const uniqueDates = Object.keys(dateCellCounts).length;
            const avgPerDay = totalRows / Math.max(1, uniqueDates);
            
            if (Math.abs(avgPerDay - 96) <= 1) {
                return {
                    interval: 15,
                    description: '15分钟（96行数据精确匹配）',
                    confidence: 0.98,
                    method: '96行数据精确匹配',
                    message: '检测到96行数据，精确识别为15分钟间隔'
                };
            }
            
            if (processedData.length === 0) {
                return {
                    interval: 15,
                    description: '15分钟（默认）',
                    confidence: 0.3,
                    method: '默认值',
                    message: '数据为空，使用默认15分钟间隔'
                };
            }
            
            // 方法1: 基于单元格数量的分析（跨日期结构）
            if (isCrossDateStructure) {
                const counts = Object.values(dateCellCounts);
                const uniqueDates = Object.keys(dateCellCounts).length;
                
                if (counts.length > 0) {
                    const stats = calculateEnhancedStatistics(counts);
                    
                    standardIntervals.forEach(standard => {
                        const scores = calculateEnhancedCellCountScores(stats, standard, uniqueDates);
                        if (scores.totalScore > 0.5) {
                            detectionResults.push({
                                interval: standard.interval,
                                description: standard.description,
                                confidence: scores.totalScore,
                                method: '单元格数量分析',
                                details: `平均${stats.mean.toFixed(1)}个/天，${uniqueDates}个日期`
                            });
                        }
                    });
                }
                
                // 方法2: 基于时间戳间隔分析
                if (timestamps.length >= 3) {
                    const sortedTimestamps = [...timestamps].sort((a, b) => a - b);
                    const intervals = [];
                    
                    for (let i = 1; i < sortedTimestamps.length; i++) {
                        const interval = (sortedTimestamps[i] - sortedTimestamps[i-1]) / (1000 * 60);
                        if (interval >= 0.5 && interval <= 120) {
                            intervals.push(interval);
                        }
                    }
                    
                    if (intervals.length > 0) {
                        const stats = calculateEnhancedStatistics(intervals);
                        const filtered = filterOutliers(intervals);
                        
                        standardIntervals.forEach(standard => {
                            const scores = calculateEnhancedTimestampScores(stats, filtered, standard);
                            if (scores.totalScore > 0.5) {
                                detectionResults.push({
                                    interval: standard.interval,
                                    description: standard.description,
                                    confidence: scores.totalScore,
                                    method: '时间戳间隔分析',
                                    details: `平均${stats.mean.toFixed(1)}分钟，变异系数${stats.cv.toFixed(3)}`
                                });
                            }
                        });
                    }
                }
                
            } else {
                // 非跨日期结构：基于数据列数量的检测
                if (dataColumnCount > 0) {
                    standardIntervals.forEach(standard => {
                        const tolerance = Math.max(1, Math.floor(standard.points * 0.05));
                        const diff = Math.abs(dataColumnCount - standard.points);
                        
                        if (diff <= tolerance) {
                            const score = 1.0 - (diff / standard.points);
                            detectionResults.push({
                                interval: standard.interval,
                                description: standard.description,
                                confidence: Math.max(0.6, score),
                                method: '数据列数量分析',
                                details: `检测到${dataColumnCount}个数据列`
                            });
                        }
                    });
                }
            }
            
            // 方法3: 基于统计一致性的分析
            const consistencyResult = analyzeStatisticalConsistency(processedData, standardIntervals);
            if (consistencyResult) {
                detectionResults.push(consistencyResult);
            }
            
            // 综合评估和选择
            return synthesizeEnhancedResults(detectionResults);
        }
        
        // 增强统计计算函数
        function calculateEnhancedStatistics(arr) {
            if (!arr || arr.length === 0) return null;
            
            const sorted = [...arr].sort((a, b) => a - b);
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const median = sorted.length % 2 === 0 ? 
                (sorted[Math.floor(sorted.length/2) - 1] + sorted[Math.floor(sorted.length/2)]) / 2 : 
                sorted[Math.floor(sorted.length/2)];
            
            const counts = {};
            arr.forEach(val => {
                const key = Math.round(val);
                counts[key] = (counts[key] || 0) + 1;
            });
            
            const mode = parseInt(Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b));
            const stdDev = Math.sqrt(arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length);
            const cv = stdDev / mean;
            
            return { mean, median, mode, stdDev, cv, min: sorted[0], max: sorted[sorted.length - 1] };
        }
        
        // 计算单元格数量评分
        function calculateEnhancedCellCountScores(stats, standard, uniqueDates) {
            const tolerance = Math.max(1, Math.floor(standard.points * standard.tolerance));
            const exactScore = stats.mean === standard.points ? 1.0 : 0;
            const closeScore = Math.max(0, 1 - Math.abs(stats.mean - standard.points) / standard.points);
            const consistencyScore = Math.max(0, 1 - stats.cv);
            const dateFactor = Math.min(1, uniqueDates / 3); // 至少3天数据
            
            return {
                exact: exactScore,
                close: closeScore,
                consistency: consistencyScore,
                dateFactor: dateFactor,
                totalScore: (exactScore * 0.3 + closeScore * 0.4 + consistencyScore * 0.2 + dateFactor * 0.1)
            };
        }
        
        // 计算时间戳评分
        function calculateEnhancedTimestampScores(stats, filtered, standard) {
            const tolerance = standard.interval * standard.tolerance;
            const modeScore = Math.max(0, 1 - Math.abs(stats.mode - standard.interval) / standard.interval);
            const meanScore = Math.max(0, 1 - Math.abs(stats.mean - standard.interval) / standard.interval);
            const consistencyScore = Math.max(0, 1 - stats.cv);
            const outlierFactor = filtered.length / (filtered.length + 1); // 考虑异常值过滤
            
            return {
                mode: modeScore,
                mean: meanScore,
                consistency: consistencyScore,
                outlier: outlierFactor,
                totalScore: (modeScore * 0.4 + meanScore * 0.3 + consistencyScore * 0.2 + outlierFactor * 0.1)
            };
        }
        
        // 异常值过滤
        function filterOutliers(arr) {
            if (!arr || arr.length < 4) return arr;
            
            const sorted = [...arr].sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            
            return sorted.filter(val => val >= lowerBound && val <= upperBound);
        }
        
        // 统计一致性分析
        function analyzeStatisticalConsistency(data, standardIntervals) {
            if (!data || data.length < 10) return null;
            
            const timestamps = data.map(d => d.timestamp).sort((a, b) => a - b);
            const intervals = [];
            
            for (let i = 1; i < timestamps.length; i++) {
                const interval = (timestamps[i] - timestamps[i-1]) / (1000 * 60);
                intervals.push(interval);
            }
            
            if (intervals.length === 0) return null;
            
            const stats = calculateEnhancedStatistics(intervals);
            const standardIntervalsList = standardIntervals.map(s => s.interval);
            
            // 计算与标准间隔的匹配度
            let bestMatch = null;
            let bestScore = 0;
            
            standardIntervals.forEach(standard => {
                const matches = intervals.filter(i => Math.abs(i - standard.interval) <= standard.interval * 0.1);
                const matchRate = matches.length / intervals.length;
                
                if (matchRate > 0.6) { // 60%以上匹配
                    const score = matchRate * (1 - stats.cv);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = {
                            interval: standard.interval,
                            description: standard.description,
                            confidence: score,
                            method: '统计一致性分析',
                            details: `匹配率${(matchRate*100).toFixed(1)}%，一致性${((1-stats.cv)*100).toFixed(1)}%`
                        };
                    }
                }
            });
            
            return bestMatch;
        }
        
        // 综合结果评估
        function synthesizeEnhancedResults(results) {
            if (!results || results.length === 0) {
                return {
                    interval: 15,
                    description: '15分钟（默认）',
                    confidence: 0.3,
                    method: '默认值',
                    message: '未能检测到明确的时间间隔模式，使用默认15分钟间隔'
                };
            }
            
            // 按置信度排序
            results.sort((a, b) => b.confidence - a.confidence);
            
            // 检查一致性
            const intervals = results.map(r => r.interval);
            const uniqueIntervals = [...new Set(intervals)];
            
            let bestResult = results[0];
            
            // 如果多个方法指向同一间隔，提高置信度
            const supportingMethods = results.filter(r => r.interval === bestResult.interval);
            if (supportingMethods.length > 1) {
                const avgConfidence = supportingMethods.reduce((sum, r) => sum + r.confidence, 0) / supportingMethods.length;
                bestResult.confidence = Math.min(0.99, avgConfidence + 0.1);
                bestResult.message = `通过${supportingMethods.length}种方法一致检测到：${bestResult.description}`;
            } else {
                bestResult.message = `${bestResult.method}检测到：${bestResult.description}，${bestResult.details}`;
            }
            
            // 生成候选方案
            const candidates = results
                .filter(r => r.interval !== bestResult.interval && r.confidence >= 0.4)
                .slice(0, 3)
                .map(r => ({
                    interval: r.interval,
                    confidence: r.confidence,
                    method: r.method
                }));
            
            bestResult.candidates = candidates;
            
            return bestResult;
        }

        // 初始化日期总用电量柱状图
        function initDailyTotalBarChart() {
            console.log('=== 创建每日总用电量柱状图 ===');
            
            // 检查Chart.js是否加载
            if (typeof Chart === 'undefined') {
                console.error('Chart.js库未加载！等待500ms后重试...');
                setTimeout(initDailyTotalBarChart, 500);
                return;
            }
            
            const canvasElement = document.getElementById('dailyTotalBarChart');
            if (!canvasElement) {
                console.error('找不到dailyTotalBarChart canvas元素');
                return;
            }
            
            // 确保canvas元素可见且有尺寸（若为0则强制设置容器尺寸并继续）
            if (canvasElement.offsetWidth === 0 || canvasElement.offsetHeight === 0) {
                console.warn('Canvas元素尺寸为0，尝试强制设置容器尺寸并继续初始化...');
                const barChartContainer = document.getElementById('dailyTotalBarChartContainer');
                if (barChartContainer) {
                    barChartContainer.style.display = 'block';
                    if (!barChartContainer.style.height) {
                        barChartContainer.style.height = '500px';
                    }
                }
                if (!canvasElement.style.height) {
                    canvasElement.style.height = '400px';
                }
                // 不再直接return，继续创建图表，由Chart.js自适应
            }
            
            const ctx = canvasElement.getContext('2d');
            if (!ctx) {
                console.error('无法获取canvas 2D上下文');
                return;
            }
            
            // 如果已存在图表实例，先销毁它
            if (appData.dailyTotalBarChart) {
                console.log('销毁现有图表实例');
                try {
                    appData.dailyTotalBarChart.destroy();
                } catch (e) {
                    console.warn('销毁图表实例时出错:', e);
                }
                appData.dailyTotalBarChart = null;
            }
            
            // 创建渐变色
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');
            gradient.addColorStop(1, 'rgba(147, 197, 253, 0.4)');
            
            // 创建柱状图
            appData.dailyTotalBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '日总用电量',
                        data: [],
                        backgroundColor: gradient,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                        hoverBackgroundColor: 'rgba(59, 130, 246, 0.9)',
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            right: 30,
                            bottom: 20,
                            left: 20
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '每日总用电量统计',
                            font: {
                                size: 22,
                                family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                weight: '600'
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            },
                            color: '#1F2937'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            titleColor: '#1F2937',
                            titleFont: {
                                size: 16,
                                weight: '600'
                            },
                            bodyColor: '#4B5563',
                            bodyFont: {
                                size: 14,
                                family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif'
                            },
                            borderColor: 'rgba(0, 0, 0, 0.15)',
                            borderWidth: 1,
                            padding: 15,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return '日期: ' + tooltipItems[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `总用电量: ${value.toFixed(2)} kWh`;
                                },
                                afterLabel: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                                    return `占比: ${percentage}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日期',
                                font: {
                                    size: 16,
                                    weight: '500'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 13
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '总用电量 (kWh)',
                                font: {
                                    size: 16,
                                    weight: '500'
                                }
                            },
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 13
                                },
                                callback: function(value) {
                                    return value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            console.log('每日总用电量柱状图创建完成');
        } // 结束 initEventListeners 函数
        
        // 更新日期总用电量柱状图（支持按日/按月聚合）
        function updateDailyTotalBarChart(filteredData) {
            console.log('=== 更新每日/每月总用电量柱状图 ===', {
                接收数据量: filteredData ? filteredData.length : 0,
                数据样本: filteredData ? filteredData.slice(0, 2) : '无数据',
                柱状图实例: !!appData.dailyTotalBarChart,
                聚合方式: appData?.visualization?.barChartAggregation || 'daily'
            });
            
            if (!appData.dailyTotalBarChart) {
                console.error('柱状图实例不存在，尝试重新初始化...');
                initDailyTotalBarChart();
                
                // 延迟重试，最多重试3次
                let retryCount = 0;
                const retryInit = () => {
                    retryCount++;
                    if (retryCount <= 3 && !appData.dailyTotalBarChart) {
                        console.log(`重试初始化柱状图，第${retryCount}次...`);
                        initDailyTotalBarChart();
                        setTimeout(retryInit, 200);
                    } else if (appData.dailyTotalBarChart) {
                        updateDailyTotalBarChart(filteredData);
                    } else {
                        console.error('柱状图初始化失败，请检查Chart.js和canvas元素');
                    }
                };
                setTimeout(retryInit, 100);
                return;
            }
            
            // 显示加载状态
            const loadingEl = document.getElementById('barChartLoading');
            const noDataEl = document.getElementById('barChartNoDataMessage');
            
            if (loadingEl && loadingEl.parentNode) loadingEl.classList.remove('hidden');
            if (noDataEl && noDataEl.parentNode) noDataEl.classList.add('hidden');
            
            try {
                // 数据验证和过滤
                if (!filteredData || !Array.isArray(filteredData)) {
                    console.warn('数据格式无效:', typeof filteredData);
                    throw new Error('数据格式不正确');
                }
                
                if (filteredData.length === 0) {
                    console.warn('无数据可显示');
                    appData.dailyTotalBarChart.data.labels = [];
                    appData.dailyTotalBarChart.data.datasets[0].data = [];
                    appData.dailyTotalBarChart.update('none');
                    if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
                    return;
                }
                
                // 验证并清理数据
                const validData = filteredData.filter(row => 
                    row && 
                    typeof row === 'object' && 
                    row.date && 
                    typeof row.dailyTotal === 'number' && 
                    !isNaN(row.dailyTotal) && 
                    row.dailyTotal >= 0
                );
                
                console.log('数据验证结果:', {
                    原始数据量: filteredData.length,
                    有效数据量: validData.length,
                    样本数据: validData.slice(0, 3)
                });
                
                if (validData.length === 0) {
                    console.warn('无有效数据可显示');
                    appData.dailyTotalBarChart.data.labels = [];
                    appData.dailyTotalBarChart.data.datasets[0].data = [];
                    appData.dailyTotalBarChart.update('none');
                    if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
                    return;
                }
                
                // 读取聚合方式：daily 或 monthly
                const aggregation = (appData?.visualization?.barChartAggregation === 'monthly') ? 'monthly' : 'daily';
                
                // 按聚合方式分组并累加总用电量
                const groupMap = new Map();
                validData.forEach(row => {
                    if (!row.date || typeof row.dailyTotal !== 'number') return;
                    let dateStr = String(row.date);
                    // 标准化为 YYYY-MM-DD
                    if (dateStr.length === 8 && !dateStr.includes('-')) {
                        dateStr = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                    }
                    let key;
                    if (aggregation === 'monthly') {
                        // 提取 YYYY-MM 作为月份键
                        if (dateStr.length >= 7 && dateStr.includes('-')) {
                            key = dateStr.slice(0, 7);
                        } else {
                            // 回退：尝试用 Date 解析并格式化
                            const d = new Date(dateStr);
                            if (!isNaN(d.getTime())) {
                                const y = d.getFullYear();
                                const m = String(d.getMonth() + 1).padStart(2, '0');
                                key = `${y}-${m}`;
                            } else {
                                // 无法解析则原样使用（可能会导致排序以字符串比较）
                                key = dateStr;
                            }
                        }
                    } else {
                        // 每日
                        key = dateStr;
                    }
                    const cur = groupMap.get(key) || 0;
                    groupMap.set(key, cur + row.dailyTotal);
                });
                
                // 排序（尽量按时间顺序）
                const sortedEntries = Array.from(groupMap.entries()).sort((a, b) => {
                    try {
                        const keyA = a[0];
                        const keyB = b[0];
                        // 对于月份，补全为该月第一天以便比较
                        const dateA = new Date(aggregation === 'monthly' ? `${keyA}-01` : keyA);
                        const dateB = new Date(aggregation === 'monthly' ? `${keyB}-01` : keyB);
                        if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) {
                            return keyA.localeCompare(keyB);
                        }
                        return dateA - dateB;
                    } catch (e) {
                        return a[0].localeCompare(b[0]);
                    }
                });
                
                const labels = sortedEntries.map(([k]) => k);
                const data = sortedEntries.map(([, v]) => v);
                
                console.log('图表数据准备完成:', {
                    维度: aggregation === 'monthly' ? '月份' : '日期',
                    维度数量: labels.length,
                    范围: labels.length > 0 ? `${labels[0]} 至 ${labels[labels.length-1]}` : '无',
                    数据样本: data.slice(0, 5),
                    数据总和: data.reduce((a, b) => a + b, 0)
                });
                
                if (labels.length === 0) {
                    console.warn('无有效数据');
                    if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
                    return;
                }
                
                // 更新图表标题/坐标轴/提示框
                const rangeText = labels.length > 0 ? `${labels[0]} 至 ${labels[labels.length - 1]}` : '无';
                const titlePrefix = aggregation === 'monthly' ? '每月总用电量' : '每日总用电量';
                appData.dailyTotalBarChart.options.plugins.title.text = `${titlePrefix} (${rangeText})`;
                // X轴标题
                if (appData.dailyTotalBarChart.options.scales && appData.dailyTotalBarChart.options.scales.x && appData.dailyTotalBarChart.options.scales.x.title) {
                    appData.dailyTotalBarChart.options.scales.x.title.text = aggregation === 'monthly' ? '月份' : '日期';
                }
                // Tooltip 标题
                if (appData.dailyTotalBarChart.options.plugins && appData.dailyTotalBarChart.options.plugins.tooltip && appData.dailyTotalBarChart.options.plugins.tooltip.callbacks) {
                    appData.dailyTotalBarChart.options.plugins.tooltip.callbacks.title = function(tooltipItems) {
                        const dim = aggregation === 'monthly' ? '月份' : '日期';
                        return `${dim}: ${tooltipItems[0].label}`;
                    };
                }
                
                // 更新图表数据
                appData.dailyTotalBarChart.data.labels = labels;
                appData.dailyTotalBarChart.data.datasets[0].data = data;
                
                // 使用动画更新
                appData.dailyTotalBarChart.update('normal');
                
            } catch (error) {
                console.error('更新柱状图时出错:', error);
                if (noDataEl && noDataEl.parentNode) noDataEl.classList.remove('hidden');
            } finally {
                if (loadingEl && loadingEl.parentNode) loadingEl.classList.add('hidden');
            }
        }

        // 初始化月份总用电量柱状图





        // 初始化应用
        function initApp() {
            initEventListeners();
            loadImportHistory(); // 加载导入历史记录
            
            // 初始化导出按钮状态为禁用

            
            // 初始化步骤导航
            initializeStepNavigation();
            
            // 初始化日期总用电量柱状图
            initDailyTotalBarChart();
            
            // 初始化24小时负荷曲线图表（即使没有数据也显示XY轴）
            initEmptyChart();
        }
        
        // 初始化空图表，显示XY轴
        function initEmptyChart() {
            if (appData.chart) {
                appData.chart.destroy();
            }
            
            const ctx = elements.loadCurveChart.getContext('2d');
            appData.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                    datasets: [{
                        label: '示例数据',
                        data: [],
                        borderColor: 'rgba(59, 130, 246, 0.3)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 1,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 15,
                            bottom: 10,
                            left: 15
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '24小时负荷曲线',
                            font: {
                                size: 18,
                                family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                weight: '600'
                            },
                            padding: {
                                top: 10,
                                bottom: 15
                            },
                            color: '#1F2937'
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '时间',
                                font: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1,
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '500'
                                },
                                padding: 8,
                                maxRotation: 0,
                                autoSkip: false
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '用电量 (kWh)',
                                font: {
                                    size: 14,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '600'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                lineWidth: 1,
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    family: '"Helvetica Neue", "Helvetica", "Arial", sans-serif',
                                    weight: '500'
                                },
                                padding: 8,
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });
            
            // 隐藏加载状态
            const chartLoadingElement = document.getElementById('chartLoading');
            if (chartLoadingElement && chartLoadingElement.parentNode) {
                chartLoadingElement.classList.add('hidden');
            }
        }

        // 初始化步骤导航
        function initializeStepNavigation() {
            // 默认激活第一个步骤
            updateStepNavigation('importSection');
            
            // 监听滚动事件，根据当前视图区域更新步骤状态
            window.addEventListener('scroll', debounce(() => {
                updateActiveStepBasedOnScroll();
            }, 100));
        }

        // 根据滚动位置更新激活步骤
        function updateActiveStepBasedOnScroll() {
            const sections = [
                { id: 'importSection', threshold: 0.5 },
                { id: 'configSection', threshold: 0.5 },
                { id: 'visualizationSection', threshold: 0.5 },
                { id: 'exportSection', threshold: 0.5 }
            ];
            
            const scrollPosition = window.scrollY + window.innerHeight / 2;
            
            for (let section of sections) {
                const element = document.getElementById(section.id);
                if (element) {
                    const rect = element.getBoundingClientRect();
                    const elementTop = rect.top + window.scrollY;
                    const elementBottom = elementTop + rect.height;
                    
                    if (scrollPosition >= elementTop && scrollPosition <= elementBottom) {
                        updateStepNavigation(section.id);
                        break;
                    }
                }
            }
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 生成筛选项
        function generateFilterOptions() {
            const count = appData.config.filterCount;
            const container = elements.filterOptionsContainer;
            
            // 清空现有筛选项
            container.innerHTML = '';
            
            // 重置additionalFilters数组
            appData.config.additionalFilters = [];
            
            // 生成新的筛选项
            for (let i = 0; i < count; i++) {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'border border-gray-200 rounded p-3';
                
                filterDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">筛选项 ${i + 1}</label>
                        <button class="clear-single-filter text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300 transition-all-300" data-index="${i}">
                            <i class="fa fa-times mr-1"></i>清除
                        </button>
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs font-medium mb-1 text-gray-600">列</label>
                        <select id="filterColumn${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm" aria-label="筛选列" title="选择筛选列">
                            <option value="">-- 请选择 --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1 text-gray-600">值</label>
                        <select id="filterValue${i}" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary text-sm" aria-label="筛选值" title="选择筛选值">
                            <option value="">-- 全部 --</option>
                        </select>
                    </div>
                `;
                
                container.appendChild(filterDiv);
                
                // 添加到additionalFilters数组
                appData.config.additionalFilters.push({
                    column: '',
                    value: ''
                });
                
                // 添加列选择事件
                const columnSelect = document.getElementById(`filterColumn${i}`);
                columnSelect.addEventListener('change', (e) => {
                    appData.config.additionalFilters[i].column = e.target.value;
                    populateFilterValueOptions(i, e.target.value);
                    updateDataPreview();
                });
                
                // 添加值选择事件
                const valueSelect = document.getElementById(`filterValue${i}`);
                valueSelect.addEventListener('change', (e) => {
                    appData.config.additionalFilters[i].value = e.target.value;
                    updateDataPreview();
                });
                
                // 填充列选择器
                populateFilterColumnSelect(i);
            }
        }
        function populateFilterColumnSelect(index) {
            const select = document.getElementById(`filterColumn${index}`);
            
            // 如果没有工作表数据，则返回
            if (appData.worksheets.length === 0) return;
            
            // 获取第一行作为表头
            const headerRow = appData.worksheets[0].data[0] || [];
            
            // 添加新选项
            for (let i = 0; i < headerRow.length; i++) {
                // 生成列字母，支持超过26列的情况（如AA, AB等）
                let columnLetter = "";
                let columnNum = i;
                while (columnNum >= 0) {
                    columnLetter = String.fromCharCode(65 + (columnNum % 26)) + columnLetter;
                    columnNum = Math.floor(columnNum / 26) - 1;
                    if (columnNum < 0) break;
                }
                
                const headerText = headerRow[i] ? String(headerRow[i]).substring(0, 20) : `列 ${columnLetter}`;
                
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${columnLetter}: ${headerText}`;
                select.appendChild(option);
            }
        }
        
        function populateFilterValueOptions(index, columnIndex) {
            const valueSelect = document.getElementById(`filterValue${index}`);
            
            // 清空现有选项
            valueSelect.innerHTML = '<option value="">-- 全部 --</option>';
            
            // 如果没有选择列，则返回
            if (!columnIndex) return;
            
            const col = parseInt(columnIndex);
            
            // 收集所有唯一的值
            const valueSet = new Set();
            
            appData.worksheets.forEach(worksheet => {
                const { data } = worksheet;
                
                // 跳过表头行
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[col]) continue;
                    
                    const value = String(row[col]).trim();
                    if (value) {
                        valueSet.add(value);
                    }
                }
            });
            
            // 转换为数组并排序
            const values = Array.from(valueSet).sort();
            
            // 添加到下拉菜单
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                valueSelect.appendChild(option);
            });
        }
        
        // 更新附加筛选器配置
        function updateAdditionalFilters() {
            appData.config.additionalFilters = [];
            
            const filterDivs = elements.filterOptionsContainer.querySelectorAll('.border');
            filterDivs.forEach(div => {
                const columnSelect = div.querySelector('.filter-column');
                const valueInput = div.querySelector('.filter-value');
                
                if (columnSelect.value && valueInput.value.trim()) {
                    appData.config.additionalFilters.push({
                        column: parseInt(columnSelect.value),
                        value: valueInput.value.trim()
                    });
                }
            });
            
            // 更新数据预览
            updateDataPreview();
        }

        // 预览第一个小时计算过程
        function previewFirstHourCalculation() {
            if (appData.parsedData.length === 0) {
                showNotification('警告', '没有可预览的数据，请先导入并配置数据', 'warning');
                return;
            }
            
            // 获取第一行解析后的数据
            const firstParsedData = appData.parsedData[0];
            const interval = firstParsedData.timeInterval || appData.config.timeInterval;
            
            // 计算每小时数据点数
            let pointsPerHour;
            if (interval === 1) {
                pointsPerHour = 60;
            } else if (interval === 5) {
                pointsPerHour = 12;
            } else if (interval === 15) {
                pointsPerHour = 4;
            } else if (interval === 30) {
                pointsPerHour = 2;
            } else if (interval === 60) {
                pointsPerHour = 1;
            } else {
                pointsPerHour = Math.floor(60 / interval);
            }
            
            // 获取第一个小时的原始数据
            const startIdx = 0;
            const endIdx = pointsPerHour;
            const hourData = firstParsedData.rawData.slice(startIdx, endIdx);
            
            // 处理无效数据
            const fillMethod = appData.config.invalidDataHandling === 'ignore' ? 'ignore' : 'interpolate';
            const cleanedData = DataUtils.cleanData(hourData, { fillMethod });
            
            // 计算第一个小时的电能值
            let hourlyValue;
            let calculationProcess = '';
            let formula = '';
            
            if (appData.config.dataType === 'instantPower') {
                // 瞬时功率数据 (kW)
                // 使用统一的计算函数
                hourlyValue = calculateHourlyPower(cleanedData, firstParsedData.multiplier, false);
                
                if (hourlyValue === null) {
                    calculationProcess = '没有有效数据，无法计算';
                    formula = '无效数据';
                } else {
                    const validData = cleanedData.filter(v => v !== null);
                    const sum = validData.reduce((a, b) => a + b, 0);
                    const avgPower = sum / validData.length;
                    
                    calculationProcess = `1. 获取第一个小时的所有数据点（${interval === 1 ? '60' : pointsPerHour}个）\n` +
                                      `2. 过滤无效数据，剩余 ${validData.length} 个有效数据点\n` +
                                      `3. 计算数据点总和：${sum.toFixed(2)} kW\n` +
                                      `4. 计算平均功率：${sum.toFixed(2)} ÷ ${validData.length} = ${avgPower.toFixed(2)} kW\n` +
                                      `5. 应用公式：平均功率 × 1 × 倍率\n` +
                                      `6. 计算结果：${avgPower.toFixed(2)} × 1 × ${firstParsedData.multiplier} = ${hourlyValue.toFixed(2)} kWh`;
                    formula = '平均功率 × 1 × 倍率';
                }
            } else {
                // 累积电能数据 (kWh)
                if (interval === 1) {
                    // 1分钟间隔特殊处理
                    if (cleanedData.length < 60) {
                        hourlyValue = null;
                        calculationProcess = '数据不足，无法计算';
                        formula = '数据不足';
                    } else {
                        // 第一组：1-15分钟
                        const firstQuarter = cleanedData.slice(0, 15).filter(v => v !== null);
                        // 第二组：46-60分钟
                        const lastQuarter = cleanedData.slice(45, 60).filter(v => v !== null);
                        
                        if (firstQuarter.length === 0 || lastQuarter.length === 0) {
                            hourlyValue = null;
                            calculationProcess = '数据不足，无法计算';
                            formula = '数据不足';
                        } else {
                            const firstSum = firstQuarter.reduce((a, b) => a + b, 0);
                            const lastSum = lastQuarter.reduce((a, b) => a + b, 0);
                            hourlyValue = lastSum - firstSum;
                            calculationProcess = `1. 获取第一个小时的所有数据点（60个）\n` +
                                              `2. 分为两组数据：1-15分钟和46-60分钟\n` +
                                              `3. 第一组数据点数量：${firstQuarter.length}，总和：${firstSum.toFixed(2)} kWh\n` +
                                              `4. 第二组数据点数量：${lastQuarter.length}，总和：${lastSum.toFixed(2)} kWh\n` +
                                              `5. 应用公式：第二组总和 - 第一组总和\n` +
                                      `6. 计算结果：${lastSum.toFixed(2)} - ${firstSum.toFixed(2)} = ${hourlyValue.toFixed(2)} kWh`;
                            formula = '第二组总和 - 第一组总和';
                        }
                    }
                } else {
                    // 其他间隔
                    if (cleanedData.length < 2) {
                        hourlyValue = null;
                        calculationProcess = '数据不足，无法计算';
                        formula = '数据不足';
                    } else {
                        const startValue = cleanedData[0];
                        const endValue = cleanedData[cleanedData.length - 1];
                        
                        if (startValue === null || endValue === null) {
                            hourlyValue = null;
                            calculationProcess = '起始或结束值无效，无法计算';
                            formula = '起始或结束值无效';
                        } else if (endValue < startValue) {
                            hourlyValue = null;
                            calculationProcess = '累积值异常（结束值小于起始值），无法计算';
                            formula = '累积值异常';
                        } else {
                            hourlyValue = endValue - startValue;
                            calculationProcess = `1. 获取第一个小时的所有数据点（${pointsPerHour}个）\n` +
                                              `2. 起始值：${startValue.toFixed(2)} kWh\n` +
                                              `3. 结束值：${endValue.toFixed(2)} kWh\n` +
                                              `4. 应用公式：结束值 - 起始值\n` +
                                              `5. 计算结果：${endValue.toFixed(2)} - ${startValue.toFixed(2)} = ${hourlyValue.toFixed(2)} kWh`;
                            formula = '结束值 - 起始值';
                        }
                    }
                }
            }
            
            // 更新模态框内容
            if (elements.previewDate && elements.previewDate.parentNode) {
                elements.previewDate.textContent = firstParsedData.dateStr;
            }
            if (elements.previewInterval && elements.previewInterval.parentNode) {
                elements.previewInterval.textContent = `${interval} 分钟`;
            }
            if (elements.previewDataType && elements.previewDataType.parentNode) {
                elements.previewDataType.textContent = appData.config.dataType === 'instantPower' ? '瞬时功率' : '累积电能';
            }
            if (elements.previewMultiplier && elements.previewMultiplier.parentNode) {
                elements.previewMultiplier.textContent = firstParsedData.multiplier;
            }
            
            // 显示原始数据
            const rawDataText = hourData.map((val, idx) => {
                return `数据点 ${idx + 1}: ${val !== null ? val.toFixed(2) : '无效数据'}`;
            }).join('\n');
            if (elements.previewRawData && elements.previewRawData.parentNode) {
                elements.previewRawData.textContent = rawDataText;
            }
            
            // 显示清洗后数据
            const cleanedDataText = cleanedData.map((val, idx) => {
                return `数据点 ${idx + 1}: ${val !== null ? val.toFixed(2) : '无效数据'}`;
            }).join('\n');
            if (elements.previewCleanedData && elements.previewCleanedData.parentNode) {
                elements.previewCleanedData.textContent = cleanedDataText;
            }
            
            // 显示计算过程
            elements.previewCalculationProcess.innerHTML = calculationProcess.replace(/\n/g, '<br>');
            
            // 显示计算结果
            if (elements.previewResult && elements.previewResult.parentNode) {
                elements.previewResult.textContent = hourlyValue !== null ? `${hourlyValue.toFixed(2)} kWh` : '无法计算';
            }
            if (elements.previewFormula && elements.previewFormula.parentNode) {
                elements.previewFormula.textContent = formula;
            }
            
            // 显示模态框
            if (elements.firstHourCalculationModal && elements.firstHourCalculationModal.parentNode) {
                elements.firstHourCalculationModal.classList.remove('hidden');
            }
            setTimeout(() => {
                if (elements.firstHourCalculationModal && elements.firstHourCalculationModal.parentNode) {
                    const modalContent = elements.firstHourCalculationModal.querySelector('.bg-white');
                    if (modalContent) {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }
                }
            }, 10);
        }
        
        // 关闭第一个小时计算过程预览模态框
        function closeFirstHourCalculationModal() {
            if (elements.firstHourCalculationModal && elements.firstHourCalculationModal.parentNode) {
                const modalContent = elements.firstHourCalculationModal.querySelector('.bg-white');
                if (modalContent) {
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                
                setTimeout(() => {
                    elements.firstHourCalculationModal.classList.add('hidden');
                }, 300);
            }
        }
        
        // 预览第一天的计算过程
        function previewFirstDayCalculation() {
            if (!appData.processedData || appData.processedData.length === 0) {
                showNotification('错误', '没有可用的数据，请先导入并处理数据', 'error');
                return;
            }
            
            // 获取第一天的数据 - 对于列对列结构，只取第一个元素
            let firstDayData;
            if (appData.processedData[0].dataStructure === 'columnToColumn') {
                // 列对列结构：每个元素代表一个完整日期的数据，只取第一个
                firstDayData = [appData.processedData[0]];
            } else {
                // 列对行结构：按日期筛选
                const firstDate = appData.processedData[0].dateObj || parseDate(appData.processedData[0].date);
                firstDayData = appData.processedData.filter(item => {
                    const itemDate = item.dateObj || parseDate(item.date);
                    return itemDate && firstDate && itemDate.toDateString() === firstDate.toDateString();
                });
            }
            
            if (firstDayData.length === 0) {
                showNotification('错误', '没有找到第一天的数据', 'error');
                return;
            }
            
            // 获取配置信息
            const interval = appData.config.timeInterval;
            const dataType = appData.config.dataType;
            const multiplier = appData.config.multiplier;
            
            // 计算第一天的总数据点
            const totalPoints = firstDayData.reduce((sum, item) => {
                return sum + (item.hourlyData ? item.hourlyData.filter(v => v !== null).length : 0);
            }, 0);
            
            // 计算第一天的总用电量
            let dailyValue = null;
            let calculationProcess = '';
            let formula = '';
            
            if (dataType === 'instantPower') {
                // 瞬时功率数据
                const hourlyValues = []; // 存储每个小时的用电量
                const hourlyDataCounts = new Array(24).fill(0); // 记录每个小时的数据点数量
                
                // 收集第一天的24小时有效数据
                if (firstDayData[0].hourlyData && firstDayData[0].hourlyData.length > 0) {
                    firstDayData[0].hourlyData.forEach((value, hourIndex) => {
                        if (value !== null && !isNaN(value)) {
                            hourlyValues[hourIndex] = value;
                            if (hourIndex < 24) {
                                hourlyDataCounts[hourIndex]++;
                            }
                        }
                    });
                }
                
                // 过滤掉无效的小时值
                const validHourlyValues = hourlyValues.filter(v => v !== null && !isNaN(v));
                
                if (validHourlyValues.length === 0) {
                    dailyValue = null;
                    calculationProcess = '数据不足，无法计算';
                    formula = '数据不足';
                } else {
                    // 计算第一天的总用电量（24小时用电量依次累加）
                    dailyValue = validHourlyValues.reduce((a, b) => a + b, 0);
                    
                    // 统计有数据的小时数
                    const hoursWithData = hourlyDataCounts.filter(count => count > 0).length;
                    
                    const formattedValues = validHourlyValues.map(v => parseFloat(v).toFixed(2));
                    const sumExpression = formattedValues.join(' + ');
                    
                    calculationProcess = `1. 获取第一天的所有24小时数据\n` +
                                      `2. 过滤无效数据后剩余有效小时数：${hoursWithData}/24小时\n` +
                                      `3. 各小时用电量：${formattedValues.join(', ')} kWh\n` +
                                      `4. 计算一天用电总量：${sumExpression} = ${dailyValue.toFixed(2)} kWh`;
                    formula = '1小时用电 + 2小时用电 + … + 24小时用电';
                }
            } else {
                // 累积电能数据
                if (firstDayData.length === 0) {
                    dailyValue = null;
                    calculationProcess = '数据不足，无法计算';
                    formula = '数据不足';
                } else {
                    // 收集所有24小时的有效数据
                    const hourlyValues = []; // 存储每个小时的用电量
                    const hourlyDataCounts = new Array(24).fill(0); // 记录每个小时的数据点数量
                    
                    firstDayData.forEach(dayData => {
                        if (dayData.hourlyData && dayData.hourlyData.length > 0) {
                            dayData.hourlyData.forEach((value, hourIndex) => {
                                if (value !== null && !isNaN(value)) {
                                    hourlyValues[hourIndex] = value;
                                    if (hourIndex < 24) {
                                        hourlyDataCounts[hourIndex]++;
                                    }
                                }
                            });
                        }
                    });
                    
                    // 过滤掉无效的小时值
                    const validHourlyValues = hourlyValues.filter(v => v !== null && !isNaN(v));
                    
                    if (validHourlyValues.length === 0) {
                        dailyValue = null;
                        calculationProcess = '没有有效的小时数据，无法计算';
                        formula = '没有有效的小时数据';
                    } else {
                        // 计算第一天的总用电量（24小时用电量依次累加）
                        dailyValue = validHourlyValues.reduce((a, b) => a + b, 0);
                        
                        // 统计有数据的小时数
                        const hoursWithData = hourlyDataCounts.filter(count => count > 0).length;
                        
                        const formattedValues = validHourlyValues.map(v => parseFloat(v).toFixed(2));
                    const sumExpression = formattedValues.join(' + ');
                    
                    calculationProcess = `1. 获取第一天的所有24小时数据\n` +
                                        `2. 过滤无效数据后剩余有效小时数：${hoursWithData}/24小时\n` +
                                        `3. 各小时用电量：${formattedValues.join(', ')} kWh\n` +
                                        `4. 计算一天用电总量：${sumExpression} = ${dailyValue.toFixed(2)} kWh`;
                        formula = '1小时用电 + 2小时用电 + … + 24小时用电';
                    }
                }
            }
            
            // 更新模态框内容
            if (elements.previewFirstDayDate && elements.previewFirstDayDate.parentNode) {
                elements.previewFirstDayDate.textContent = firstDayData[0] && firstDayData[0].date ? firstDayData[0].date.split(' ')[0] : '未知日期';
            }
            if (elements.previewFirstDayInterval && elements.previewFirstDayInterval.parentNode) {
                elements.previewFirstDayInterval.textContent = `${interval} 分钟`;
            }
            if (elements.previewFirstDayDataType && elements.previewFirstDayDataType.parentNode) {
                elements.previewFirstDayDataType.textContent = dataType === 'instantPower' ? '瞬时功率' : '累积电能';
            }
            if (elements.previewFirstDayMultiplier && elements.previewFirstDayMultiplier.parentNode) {
                elements.previewFirstDayMultiplier.textContent = multiplier;
            }
            
            // 显示原始数据
            const rawDataText = firstDayData[0].hourlyData ? 
                `第1天小时数据: [${firstDayData[0].hourlyData.map((val, idx) => 
                    val !== null ? val.toFixed(2) : '无效数据').join(', ')}]` : 
                `第1天小时数据: 无数据`;
            if (elements.previewFirstDayRawData && elements.previewFirstDayRawData.parentNode) {
                elements.previewFirstDayRawData.textContent = rawDataText;
            }
            
            // 显示清洗后数据
            let cleanedDataText;
            if (!firstDayData[0].hourlyData) {
                cleanedDataText = `第1天小时数据: 无数据`;
            } else {
                const validData = firstDayData[0].hourlyData.filter(val => val !== null && !isNaN(val));
                cleanedDataText = `第1天小时数据: [${validData.map(val => val.toFixed(2)).join(', ')}]`;
            }
            if (elements.previewFirstDayCleanedData && elements.previewFirstDayCleanedData.parentNode) {
                elements.previewFirstDayCleanedData.textContent = cleanedDataText;
            }
            
            // 显示计算过程
            if (elements.previewFirstDayCalculationProcess && elements.previewFirstDayCalculationProcess.parentNode) {
                elements.previewFirstDayCalculationProcess.innerHTML = calculationProcess.replace(/\n/g, '<br>');
            }
            
            // 显示计算结果
            if (elements.previewFirstDayResult && elements.previewFirstDayResult.parentNode) {
                elements.previewFirstDayResult.textContent = dailyValue !== null ? `${dailyValue.toFixed(2)} kWh` : '无法计算';
            }
            if (elements.previewFirstDayFormula && elements.previewFirstDayFormula.parentNode) {
                elements.previewFirstDayFormula.textContent = formula;
            }
            
            // 显示模态框
            if (elements.firstDayCalculationModal && elements.firstDayCalculationModal.parentNode) {
                elements.firstDayCalculationModal.classList.remove('hidden');
            }
            setTimeout(() => {
                if (elements.firstDayCalculationModal && elements.firstDayCalculationModal.parentNode) {
                    const modalContent = elements.firstDayCalculationModal.querySelector('.bg-white');
                    if (modalContent) {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }
                }
            }, 10);
        }
        
        // 关闭第一天计算过程预览模态框
        function closeFirstDayCalculationModal() {
            if (elements.firstDayCalculationModal && elements.firstDayCalculationModal.parentNode) {
                const modalContent = elements.firstDayCalculationModal.querySelector('.bg-white');
                if (modalContent) {
                    modalContent.classList.remove('scale-100', 'opacity-100');
                    modalContent.classList.add('scale-95', 'opacity-0');
                }
                
                setTimeout(() => {
                    elements.firstDayCalculationModal.classList.add('hidden');
                }, 300);
            }
        }
        // 添加保存和加载历史记录的函数
        function saveImportHistory() {
            try {
                localStorage.setItem('loadDataAnalyzerImportHistory', JSON.stringify(appData.importHistory));
            } catch (error) {
                console.error('保存导入历史失败:', error);
            }
        }

        function loadImportHistory() {
            try {
                const savedHistory = localStorage.getItem('loadDataAnalyzerImportHistory');
                if (savedHistory) {
                    appData.importHistory = JSON.parse(savedHistory);
                    renderImportHistory();
                }
            } catch (error) {
                console.error('加载导入历史失败:', error);
                appData.importHistory = [];
            }
        }

        // 添加清空历史记录函数
        function clearImportHistory() {
            if (confirm('确定要清空所有导入历史记录吗？此操作不可撤销。')) {
                appData.importHistory = [];
                saveImportHistory();
                renderImportHistory();
                showNotification('成功', '导入历史记录已清空', 'success');
            }
        }

        // 添加渲染历史记录函数
        function updateDataStats() {
            const totalFiles = appData.files.length;
            const totalRecords = appData.worksheets.reduce((sum, ws) => sum + (ws.data.length - 1), 0);
            
            const totalFilesElement = document.getElementById('totalFiles');
            const totalRecordsElement = document.getElementById('totalRecords');
            if (totalFilesElement && totalFilesElement.parentNode) {
                totalFilesElement.textContent = totalFiles;
            }
            if (totalRecordsElement && totalRecordsElement.parentNode) {
                totalRecordsElement.textContent = totalRecords;
            }
            
            // 更新数据概览统计信息
            updateDataOverview();
            
            // 更新文件列表显示
            renderFileList();
        }
        
        // 更新数据概览div中的统计信息
        function updateDataOverview() {
            const fileCountElement = document.getElementById('fileCount');
            const timeRangeElement = document.getElementById('timeRange');
            const meteringPointsElement = document.getElementById('meteringPoints');
            
            // 更新文件数量
            if (fileCountElement && fileCountElement.parentNode) {
                fileCountElement.textContent = appData.files.length;
            }
            
            // 更新时间范围
            if (timeRangeElement && timeRangeElement.parentNode) {
                if (appData.processedData.length > 0) {
                    const dates = appData.processedData.map(d => d.date).sort();
                    const startDate = dates[0];
                    const endDate = dates[dates.length - 1];
                    if (startDate === endDate) {
                        timeRangeElement.textContent = startDate;
                    } else {
                        timeRangeElement.textContent = `${startDate} 至 ${endDate}`;
                    }
                } else {
                    timeRangeElement.textContent = '-';
                }
            }
            
            // 更新计量点数量
            if (meteringPointsElement && meteringPointsElement.parentNode) {
                const uniqueMeteringPoints = new Set(appData.processedData.map(d => d.meteringPoint || '默认计量点'));
                meteringPointsElement.textContent = uniqueMeteringPoints.size;
            }
        }
        
        function renderFileList() {
            const fileListElement = document.getElementById('fileListContent');
            if (!fileListElement) return;
            
            fileListElement.innerHTML = '';
            
            if (appData.files.length === 0) {
                fileListElement.innerHTML = '<div class="text-center py-4 text-gray-500">暂无导入的文件</div>';
                return;
            }
            
            appData.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2';
                
                const worksheet = appData.worksheets.find(ws => ws.file === file);
                const recordCount = worksheet ? worksheet.data.length - 1 : 0;
                
                fileItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${file.name}</div>
                            <div class="text-xs text-gray-500">${recordCount} 条记录</div>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800 text-sm">
                        删除
                    </button>
                `;
                
                fileListElement.appendChild(fileItem);
            });
        }
        
        function updateUploadProgress(processed, total) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // 确保进度不超过100%
            const actualProcessed = Math.min(processed, total);
            const percentage = Math.round((actualProcessed / total) * 100);
            
            if (progressBar && progressBar.parentNode) {
                progressBar.style.width = `${percentage}%`;
            }
            if (progressText && progressText.parentNode) {
                progressText.textContent = `${percentage}% (${actualProcessed}/${total})`;
            }
            
            if (processed >= total) {
                setTimeout(() => {
                    if (elements.uploadProgress && elements.uploadProgress.parentNode) {
                        elements.uploadProgress.classList.add('hidden');
                    }
                }, 1000);
            }
        }
        
        function renderImportHistory() {
            const historyList = document.getElementById('historyList');
            
            if (!historyList) return;
            
            historyList.innerHTML = '';
            
            if (appData.importHistory.length === 0) {
                historyList.innerHTML = '<div class="text-center py-4 text-gray-500 text-sm">暂无导入历史记录</div>';
                // 导入历史现在固定展开，无需隐藏
                return;
            }
            
            // 导入历史固定展开，直接显示记录
            
            const sortedHistory = [...appData.importHistory].sort((a, b) => new Date(b.importTime) - new Date(a.importTime));
            const displayHistory = sortedHistory.slice(0, 2); // 只显示最近的两条记录
            
            displayHistory.forEach((record, index) => {
                const date = new Date(record.importTime);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2';
                
                const statusClass = record.status === 'success' ? 'text-green-600' : 'text-red-600';
                const statusIcon = record.status === 'success' ? '✓' : '✗';
                
                historyItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <span class="text-xs font-bold ${statusClass}">${statusIcon}</span>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${record.fileName}</div>
                            <div class="text-xs text-gray-500">${formattedDate}</div>
                            ${record.status === 'success' ? 
                                `<div class="text-xs text-green-600">${record.recordCount} 条记录</div>` : 
                                `<div class="text-xs text-red-600">${record.errorMessage}</div>`
                            }
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        // 添加重新导入并跳转到配置步骤函数
        function reimportAndGoToConfig(index) {
            const record = appData.importHistory[index];
            if (!record || record.status !== 'success') {
                showNotification('错误', '无法重新导入此记录', 'error');
                return;
            }
            
            // 清空当前数据
            removeAllFiles();
            
            // 尝试使用历史记录中的文件路径重新导入
            if (record.filePath) {
                // 使用fetch API获取文件
                fetch(record.filePath)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('无法访问文件：' + record.filePath);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // 创建File对象
                        const file = new File([blob], record.fileName, { type: blob.type });
                        
                        // 处理文件
                        processFiles([file]);
                        
                        // 等待文件处理完成后应用历史配置并跳转到配置步骤
                        setTimeout(() => {
                            if (appData.worksheets.length > 0 && record.config) {
                                // 应用历史配置
                                appData.config.dataType = record.config.dataType;
                                appData.config.multiplier = record.config.multiplier;
                                appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                                appData.config.multiplierColumn = record.config.multiplierColumn || '';
                                appData.config.dateColumn = record.config.dateColumn;
                                appData.config.dataStartColumn = record.config.dataStartColumn;
                                appData.config.dataEndColumn = record.config.dataEndColumn;
                                appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                                appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                                appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                                appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                                appData.config.timeInterval = record.config.timeInterval || 15;
                                
                                // 更新UI
                                document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                                elements.multiplierInput.value = record.config.multiplier;
                                elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                                elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                                elements.dateColumnSelect.value = record.config.dateColumn;
                                elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                                elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                                elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                                elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';

                                elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                                elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                                
                                // 更新倍率选项显示
                                if (record.config.useMultiplierColumn) {
                                    elements.multiplierOptions.classList.add('hidden');
                                    elements.multiplierColumnOption.classList.remove('hidden');
                                } else {
                                    elements.multiplierOptions.classList.remove('hidden');
                                    elements.multiplierColumnOption.classList.add('hidden');
                                }
                                
                                // 更新数据预览
                                updateDataPreview();
                                
                                // 跳转到配置步骤
                                goToConfigSection();
                                
                                showNotification('成功', '已直接从原始位置重新导入文件并跳转到配置步骤', 'success');
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error('直接访问文件失败:', error);
                        showNotification('警告', '无法直接访问原始文件，请手动选择文件', 'warning');
                        
                        // 如果无法直接访问文件，则提示用户手动选择
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.xlsx,.xls,.csv';
                        fileInput.multiple = false;
                        
                        fileInput.onchange = function(e) {
                            const files = Array.from(e.target.files);
                            if (files.length === 0) return;
                            
                            const file = files[0];
                            
                            // 检查文件名是否匹配
                            if (file.name !== record.fileName) {
                                if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                                    return;
                                }
                            }
                            
                            // 清空当前数据
                            removeAllFiles();
                            
                            // 处理文件
                            processFiles([file]);
                            
                            // 等待文件处理完成后应用历史配置并跳转到配置步骤
                            setTimeout(() => {
                                if (appData.worksheets.length > 0 && record.config) {
                                    // 应用历史配置
                                    appData.config.dataType = record.config.dataType;
                                    appData.config.multiplier = record.config.multiplier;
                                    appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                                    appData.config.multiplierColumn = record.config.multiplierColumn || '';
                                    appData.config.dateColumn = record.config.dateColumn;
                                    appData.config.dataStartColumn = record.config.dataStartColumn;
                                    appData.config.dataEndColumn = record.config.dataEndColumn;
                                    appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                                    appData.config.meteringPointFilter = record.config.meteringPointFilter || '';

                                    appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                                    appData.config.timeInterval = record.config.timeInterval || 15;
                                    
                                    // 更新UI
                                    document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                                    elements.multiplierInput.value = record.config.multiplier;
                                    elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                                    elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                                    elements.dateColumnSelect.value = record.config.dateColumn;
                                    elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                                    elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                                    elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                                    elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
    
                                    elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                                    elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                                    
                                    // 更新倍率选项显示
                                    if (record.config.useMultiplierColumn) {
                                        elements.multiplierOptions.classList.add('hidden');
                                        elements.multiplierColumnOption.classList.remove('hidden');
                                    } else {
                                        elements.multiplierOptions.classList.remove('hidden');
                                        elements.multiplierColumnOption.classList.add('hidden');
                                    }
                                    
                                    // 更新数据预览
                                    updateDataPreview();
                                    
                                    // 跳转到配置步骤
                                    goToConfigSection();
                                    
                                    showNotification('成功', '已重新导入文件并跳转到配置步骤', 'success');
                                }
                            }, 500);
                        };
                        
                        // 触发文件选择
                        fileInput.click();
                    });
            } else {
                // 如果没有文件路径，则提示用户手动选择
                showNotification('提示', '历史记录中没有文件路径信息，请手动选择文件', 'warning');
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.multiple = false;
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    const file = files[0];
                    
                    // 检查文件名是否匹配
                    if (file.name !== record.fileName) {
                        if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                            return;
                        }
                    }
                    
                    // 清空当前数据
                    removeAllFiles();
                    
                    // 处理文件
                    processFiles([file]);
                    
                    // 等待文件处理完成后应用历史配置并跳转到配置步骤
                    setTimeout(() => {
                        if (appData.worksheets.length > 0 && record.config) {
                            // 应用历史配置
                            appData.config.dataType = record.config.dataType;
                            appData.config.multiplier = record.config.multiplier;
                            appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                            appData.config.multiplierColumn = record.config.multiplierColumn || '';
                            appData.config.dateColumn = record.config.dateColumn;
                            appData.config.dataStartColumn = record.config.dataStartColumn;
                            appData.config.dataEndColumn = record.config.dataEndColumn;
                            appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                            appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                            appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                            appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                            appData.config.timeInterval = record.config.timeInterval || 15;
                            
                            // 更新UI
                            document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                            elements.multiplierInput.value = record.config.multiplier;
                            elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                            elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                            elements.dateColumnSelect.value = record.config.dateColumn;
                            elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                            elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                            elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                            elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                            
                            elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                            elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                            
                            // 更新倍率选项显示
                            if (record.config.useMultiplierColumn) {
                                elements.multiplierOptions.classList.add('hidden');
                                elements.multiplierColumnOption.classList.remove('hidden');
                            } else {
                                elements.multiplierOptions.classList.remove('hidden');
                                elements.multiplierColumnOption.classList.add('hidden');
                            }
                            
                            // 更新数据预览
                            updateDataPreview();
                            
                            // 跳转到配置步骤
                            goToConfigSection();
                            
                            showNotification('成功', '已重新导入文件并跳转到配置步骤', 'success');
                        }
                    }, 500);
                };
                
                // 触发文件选择
                fileInput.click();
            }
        }

        // 添加显示历史记录详情函数
        function showHistoryDetail(index) {
            const record = appData.importHistory[index];
            if (!record) return;
            
            const date = new Date(record.importTime);
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
            
            let detailHtml = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium mb-2">基本信息</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-neutral">文件名：</span>
                                <span class="font-medium">${record.fileName}</span>
                            </div>
                            <div>
                                <span class="text-neutral">导入时间：</span>
                                <span class="font-medium">${formattedDate}</span>
                            </div>
                            <div>
                                <span class="text-neutral">文件大小：</span>
                                <span class="font-medium">${(record.fileSize / (1024 * 1024)).toFixed(2)} MB</span>
                            </div>
                            <div>
                                <span class="text-neutral">状态：</span>
                                <span class="font-medium ${record.status === 'success' ? 'text-success' : 'text-danger'}">
                                    ${record.status === 'success' ? '成功' : '失败'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">数据处理结果</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-neutral">总记录数：</span>
                                <span class="font-medium">${record.recordCount}</span>
                            </div>
                            <div>
                                <span class="text-neutral">有效记录数：</span>
                                <span class="font-medium">${record.validRecordCount || 0}</span>
                            </div>
                            <div>
                                <span class="text-neutral">无效记录数：</span>
                                <span class="font-medium">${record.invalidRecordCount || 0}</span>
                            </div>
                            <div>
                                <span class="text-neutral">时间间隔：</span>
                                <span class="font-medium">${record.timeInterval || '未知'} 分钟</span>
                            </div>
                        </div>
                    </div>
            `;
            
            if (record.status === 'failure' && record.errorMessage) {
                detailHtml += `
                    <div>
                        <h4 class="font-medium mb-2">错误信息</h4>
                        <div class="bg-danger/5 border border-danger/20 rounded p-3 text-sm">
                            <p class="text-danger">${record.errorMessage}</p>
                        </div>
                    </div>
                `;
            }
            
            if (record.config) {
                detailHtml += `
                    <div>
                        <h4 class="font-medium mb-2">使用的配置</h4>
                        <div class="bg-gray-50 rounded p-3 text-sm">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <span class="text-neutral">数据类型：</span>
                                    <span class="font-medium">${record.config.dataType === 'instantPower' ? '瞬时功率' : '累积电能'}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">倍率：</span>
                                    <span class="font-medium">${record.config.multiplier}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">日期列：</span>
                                    <span class="font-medium">${record.config.dateColumn !== '' ? record.config.dateColumn : '未设置'}</span>
                                </div>
                                <div>
                                    <span class="text-neutral">数据列范围：</span>
                                    <span class="font-medium">${record.config.dataStartColumn !== '' && record.config.dataEndColumn !== '' ? 
                                        `${record.config.dataStartColumn} - ${record.config.dataEndColumn}` : '未设置'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 添加重新导入按钮
    if (record.status === 'success') {
        detailHtml += `
            <div class="flex justify-end pt-2 border-t border-gray-200">
                <button id="reimportBtn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 transition-all-300" data-index="${index}">
                    <i class="fa fa-refresh mr-1"></i> 重新导入
                </button>
            </div>
        `;
    }
    
    detailHtml += '</div>';
    elements.historyDetailContent.innerHTML = detailHtml;
    
    // 添加重新导入按钮的事件监听
    const reimportBtn = document.getElementById('reimportBtn');
    if (reimportBtn) {
        reimportBtn.addEventListener('click', function() {
            const recordIndex = parseInt(this.dataset.index);
            reimportFromHistory(recordIndex);
            closeHistoryDetailModal();
        });
    }
    
    // 显示模态框
    if (elements.historyDetailModal && elements.historyDetailModal.parentNode) {
        elements.historyDetailModal.classList.remove('hidden');
    }
    setTimeout(() => {
        if (elements.historyDetailModal && elements.historyDetailModal.parentNode) {
            const modalContent = elements.historyDetailModal.querySelector('.bg-white');
            if (modalContent) {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }
        }
    }, 10);
        }
        
        // 添加关闭历史记录详情模态框函数
function closeHistoryDetailModal() {
    if (elements.historyDetailModal && elements.historyDetailModal.parentNode) {
        const modalContent = elements.historyDetailModal.querySelector('.bg-white');
        if (modalContent) {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
        }
    
        setTimeout(() => {
            elements.historyDetailModal.classList.add('hidden');
        }, 300);
    }
}

// 添加从历史记录重新导入函数
function reimportFromHistory(index) {
    const record = appData.importHistory[index];
    if (!record || record.status !== 'success') {
        showNotification('错误', '无法重新导入此记录', 'error');
        return;
    }
    
    // 清空当前数据
    removeAllFiles();
    
    // 尝试使用历史记录中的文件路径重新导入
    if (record.filePath) {
        // 使用fetch API获取文件
        fetch(record.filePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法访问文件：' + record.filePath);
                }
                return response.blob();
            })
            .then(blob => {
                // 创建File对象
                const file = new File([blob], record.fileName, { type: blob.type });
                
                // 处理文件
                processFiles([file]);
                
                // 等待文件处理完成后应用历史配置
                setTimeout(() => {
                    if (appData.worksheets.length > 0 && record.config) {
                        // 应用历史配置
                        appData.config.dataType = record.config.dataType;
                        appData.config.multiplier = record.config.multiplier;
                        appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                        appData.config.multiplierColumn = record.config.multiplierColumn || '';
                        appData.config.dateColumn = record.config.dateColumn;
                        appData.config.dataStartColumn = record.config.dataStartColumn;
                        appData.config.dataEndColumn = record.config.dataEndColumn;
                        appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                        appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                        appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                        appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                        appData.config.timeInterval = record.config.timeInterval || 15;
                        
                        // 更新UI
                        document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                        elements.multiplierInput.value = record.config.multiplier;
                        elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                        elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                        elements.dateColumnSelect.value = record.config.dateColumn;
                        elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                        elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                        elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                        elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                        
                        elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                        elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                        
                        // 更新倍率选项显示
                        if (record.config.useMultiplierColumn) {
                            elements.multiplierOptions.classList.add('hidden');
                            elements.multiplierColumnOption.classList.remove('hidden');
                        } else {
                            elements.multiplierOptions.classList.remove('hidden');
                            elements.multiplierColumnOption.classList.add('hidden');
                        }
                        
                        // 更新数据预览
                        updateDataPreview();
                        
                        showNotification('成功', '已直接从原始位置重新导入文件并应用历史配置', 'success');
                    }
                }, 500);
            })
            .catch(error => {
                console.error('直接访问文件失败:', error);
                showNotification('警告', '无法直接访问原始文件，请手动选择文件', 'warning');
                
                // 如果无法直接访问文件，则提示用户手动选择
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls,.csv';
                fileInput.multiple = false;
                
                fileInput.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;
                    
                    const file = files[0];
                    
                    // 检查文件名是否匹配
                    if (file.name !== record.fileName) {
                        if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                            return;
                        }
                    }
                    
                    // 清空当前数据
                    removeAllFiles();
                    
                    // 处理文件
                    processFiles([file]);
                    
                    // 等待文件处理完成后应用历史配置
                    setTimeout(() => {
                        if (appData.worksheets.length > 0 && record.config) {
                            // 应用历史配置
                            appData.config.dataType = record.config.dataType;
                            appData.config.multiplier = record.config.multiplier;
                            appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                            appData.config.multiplierColumn = record.config.multiplierColumn || '';
                            appData.config.dateColumn = record.config.dateColumn;
                            appData.config.dataStartColumn = record.config.dataStartColumn;
                            appData.config.dataEndColumn = record.config.dataEndColumn;
                            appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                            appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                            appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                            appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                            appData.config.timeInterval = record.config.timeInterval || 15;
                            
                            // 更新UI
                            document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                            elements.multiplierInput.value = record.config.multiplier;
                            elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                            elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                            elements.dateColumnSelect.value = record.config.dateColumn;
                            elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                            elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                            elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                            elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';

                            elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                            elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                            
                            // 更新倍率选项显示
                            if (record.config.useMultiplierColumn) {
                                elements.multiplierOptions.classList.add('hidden');
                                elements.multiplierColumnOption.classList.remove('hidden');
                            } else {
                                elements.multiplierOptions.classList.remove('hidden');
                                elements.multiplierColumnOption.classList.add('hidden');
                            }
                            
                            // 更新数据预览
                            updateDataPreview();
                            
                            showNotification('成功', '已重新导入文件并应用历史配置', 'success');
                        }
                    }, 500);
                };
                
                // 触发文件选择
                fileInput.click();
            });
    } else {
        // 如果没有文件路径，则提示用户手动选择
        showNotification('提示', '历史记录中没有文件路径信息，请手动选择文件', 'warning');
        
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx,.xls,.csv';
        fileInput.multiple = false;
        
        fileInput.onchange = function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            const file = files[0];
            
            // 检查文件名是否匹配
            if (file.name !== record.fileName) {
                if (!confirm(`选择的文件 "${file.name}" 与历史记录中的文件 "${record.fileName}" 不匹配，是否继续？`)) {
                    return;
                }
            }
            
            // 清空当前数据
            removeAllFiles();
            
            // 处理文件
            processFiles([file]);
            
            // 等待文件处理完成后应用历史配置
            setTimeout(() => {
                if (appData.worksheets.length > 0 && record.config) {
                    // 应用历史配置
                    appData.config.dataType = record.config.dataType;
                    appData.config.multiplier = record.config.multiplier;
                    appData.config.useMultiplierColumn = record.config.useMultiplierColumn || false;
                    appData.config.multiplierColumn = record.config.multiplierColumn || '';
                    appData.config.dateColumn = record.config.dateColumn;
                    appData.config.dataStartColumn = record.config.dataStartColumn;
                    appData.config.dataEndColumn = record.config.dataEndColumn;
                    appData.config.meteringPointColumn = record.config.meteringPointColumn || '';
                    appData.config.meteringPointFilter = record.config.meteringPointFilter || '';
                    appData.config.dateFormat = record.config.dateFormat || 'YYYY-MM-DD';
                    appData.config.invalidDataHandling = record.config.invalidDataHandling || 'ignore';
                    appData.config.timeInterval = record.config.timeInterval || 15;
                    
                    // 更新UI
                    document.querySelector(`input[name="dataType"][value="${record.config.dataType}"]`).checked = true;
                    elements.multiplierInput.value = record.config.multiplier;
                    elements.useMultiplierColumnCheckbox.checked = record.config.useMultiplierColumn || false;
                    elements.multiplierColumnSelect.value = record.config.multiplierColumn || '';
                    elements.dateColumnSelect.value = record.config.dateColumn;
                    elements.dataStartColumnSelect.value = record.config.dataStartColumn;
                    elements.dataEndColumnSelect.value = record.config.dataEndColumn;
                    elements.meteringPointColumnSelect.value = record.config.meteringPointColumn || '';
                    elements.meteringPointFilterSelect.value = record.config.meteringPointFilter || '';
                    
                    elements.invalidDataHandlingSelect.value = record.config.invalidDataHandling || 'ignore';
                    elements.timeIntervalSelect.value = record.config.timeInterval || 15;
                    
                    // 更新倍率选项显示
                    if (record.config.useMultiplierColumn) {
                        elements.multiplierOptions.classList.add('hidden');
                        elements.multiplierColumnOption.classList.remove('hidden');
                    } else {
                        elements.multiplierOptions.classList.remove('hidden');
                        elements.multiplierColumnOption.classList.add('hidden');
                    }
                    
                    // 更新数据预览
                    updateDataPreview();
                    
                    showNotification('成功', '已重新导入文件并应用历史配置', 'success');
                }
            }, 500);
        };
        
        // 触发文件选择
        fileInput.click();
    }
}

        // 辅助函数：解析日期时间
function parseDateTime(dateTimeStr, format) {
    if (!dateTimeStr || typeof dateTimeStr !== 'string') {
        return null;
    }
    
    // 尝试多种日期时间格式
    const formats = [
        { regex: /\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-ss' }, // YYYY-MM-DD HH:MM:SS
        { regex: /\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm' },     // YYYY/MM/DD HH:MM
        { regex: /\d{4}\d{2}\d{2}\d{2}\d{2}\d{2}/, id: 'yyyymmddhhmmss' },     // YYYYMMDDHHMMSS
        { regex: /\d{4}\/\d{2}\/\d{2}\/\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-slash' },    // YYYY/MM/DD/HH:MM
        { regex: /\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm' },     // MM/DD/YYYY HH:MM
        { regex: /\d{2}-\d{2}-\d{4} \d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm-dash' },      // MM-DD-YYYY HH:MM
        { regex: /\d{4}-\d{2}-\d{2} \d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-dash' },      // YYYY-MM-DD HH:MM
        { regex: /\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}/, id: 'yyyy-mm-dd-hh-mm-ss-slash' }, // YYYY/MM/DD HH:MM:SS
        { regex: /\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}/, id: 'mm-dd-yyyy-hh-mm-ss' }  // MM/DD/YYYY HH:MM:SS
    ];
    
    for (const fmt of formats) {
        if (fmt.regex.test(dateTimeStr)) {
            let parts;
            let date;
            
            // 根据匹配的格式解析日期时间
            if (fmt.id === 'yyyy-mm-dd-hh-mm-ss') {
                parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyymmddhhmmss') {
                if (dateTimeStr.length >= 14) {
                    const year = parseInt(dateTimeStr.substring(0, 4));
                    const month = parseInt(dateTimeStr.substring(4, 6)) - 1;
                    const day = parseInt(dateTimeStr.substring(6, 8));
                    const hour = parseInt(dateTimeStr.substring(8, 10));
                    const minute = parseInt(dateTimeStr.substring(10, 12));
                    const second = parseInt(dateTimeStr.substring(12, 14));
                    date = new Date(year, month, day, hour, minute, second);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-slash') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2})\/(\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm') {
                parts = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm-dash') {
                parts = dateTimeStr.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-dash') {
                parts = dateTimeStr.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);
                if (parts && parts.length >= 6) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'yyyy-mm-dd-hh-mm-ss-slash') {
                parts = dateTimeStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            } else if (fmt.id === 'mm-dd-yyyy-hh-mm-ss') {
                parts = dateTimeStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
                if (parts && parts.length >= 7) {
                    date = new Date(parts[3], parts[1] - 1, parts[2], parts[4], parts[5], parts[6]);
                    if (!isNaN(date.getTime())) return date;
                }
            }
        }
    }
    
    // 如果没有匹配的格式，尝试使用Date对象解析
    const date = new Date(dateTimeStr);
    return isNaN(date.getTime()) ? null : date;
}

// 辅助函数：格式化日期键
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // 统一计算小时功率的函数
        function calculateHourlyPower(dataPoints, multiplier, timeInterval = 15, isDebug = false) {
            // 过滤无效数据
            const validData = dataPoints.filter(v => v !== null);
            
            if (validData.length === 0) {
                if (isDebug) {
                    console.log('计算小时功率调试信息：');
                    console.log('- 原始数据点数量:', dataPoints.length);
                    console.log('- 有效数据点数量: 0');
                    console.log('- 计算结果: null (无有效数据)');
                }
                return null;
            }
            
            // 根据时间间隔计算每小时应有的数据点数量
            const expectedPointsPerHour = 60 / timeInterval;
            
            // 计算总和
            const sum = validData.reduce((a, b) => a + b, 0);
            
            // 计算平均功率
            const avgPower = sum / validData.length;
            
            // 计算小时值：平均功率 × 1 × 倍率
            const hourlyValue = avgPower * 1 * multiplier;
            
            // 检查数据点数量是否匹配预期
            const isPointsCountValid = Math.abs(validData.length - expectedPointsPerHour) / expectedPointsPerHour <= 0.2; // 允许20%的误差
            
            if (isDebug) {
                console.log('计算小时功率调试信息：');
                console.log('- 原始数据点数量:', dataPoints.length);
                console.log('- 有效数据点数量:', validData.length);
                console.log('- 时间间隔:', timeInterval, '分钟');
                console.log('- 预期每小时数据点数量:', expectedPointsPerHour);
                console.log('- 数据点数量是否匹配:', isPointsCountValid ? '是' : '否');
                console.log('- 数据点总和:', sum.toFixed(2), 'kW');
                console.log('- 平均功率:', avgPower.toFixed(2), 'kW');
                console.log('- 倍率:', multiplier);
                console.log('- 计算结果:', hourlyValue.toFixed(2), 'kWh');
            }
            
            return hourlyValue;
        }
        
        // 辅助函数：获取筛选后的数据
        function getFilteredData() {
            console.log('=== getFilteredData 调试信息 ===');
            console.log('原始数据总数:', appData.processedData.length);
            console.log('选中日期:', appData.visualization.selectedDates);
            console.log('选中计量点:', appData.visualization.selectedMeteringPoints);
            
            // 如果没有选择任何日期，默认选择所有日期
            if (appData.visualization.selectedDates.length === 0 && appData.processedData.length > 0) {
                appData.visualization.selectedDates = appData.processedData.map(d => d.date);
                console.log('自动选择所有日期:', appData.visualization.selectedDates);
            }
            
            // 如果没有选择任何计量点，默认选择所有计量点
            if (appData.visualization.selectedMeteringPoints.length === 0 && appData.meteringPoints.length > 0) {
                appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                console.log('自动选择所有计量点:', appData.visualization.selectedMeteringPoints);
            }
            
            // 当已选择集合与新数据可用集合无交集时，自动回退为全选
            const availableDateSet = new Set(appData.processedData.map(d => d.date));
            if (appData.visualization.selectedDates.length > 0) {
                const hasDateOverlap = appData.visualization.selectedDates.some(d => availableDateSet.has(d));
                if (!hasDateOverlap && appData.processedData.length > 0) {
                    appData.visualization.selectedDates = appData.processedData.map(d => d.date);
                    console.log('检测到选择的日期与新数据不重叠，已自动重置为全选日期');
                }
            }
            const availableMPSet = new Set(appData.meteringPoints);
            if (appData.visualization.selectedMeteringPoints.length > 0) {
                const hasMPOverlap = appData.visualization.selectedMeteringPoints.some(mp => availableMPSet.has(mp));
                if (!hasMPOverlap && appData.meteringPoints.length > 0) {
                    appData.visualization.selectedMeteringPoints = [...appData.meteringPoints];
                    console.log('检测到选择的计量点与新数据不重叠，已自动重置为全部计量点');
                }
            }
            
            const filteredData = DataUtils.filterData(appData.processedData, {
                dates: appData.visualization.selectedDates,
                meteringPoints: appData.visualization.selectedMeteringPoints.length > 0 ? 
                    appData.visualization.selectedMeteringPoints : null
            });
            
            console.log('筛选后数据总数:', filteredData.length);
            console.log('筛选后数据日期:', filteredData.map(d => d.date));
            console.log('筛选后数据计量点:', [...new Set(filteredData.map(d => d.meteringPoint))]);
            if (filteredData.length > 0) {
                console.log('第一条数据结构:', Object.keys(filteredData[0]));
                console.log('第一条数据的dailyTotal:', filteredData[0].dailyTotal);
            }
            console.log('===============================');
            
            return filteredData;
        }
        
        // 性能优化配置
        const PERFORMANCE_CONFIG = {
            BATCH_SIZE: 1000,           // 批处理大小
            CACHE_ENABLED: true,        // 启用缓存
            WORKER_ENABLED: false,      // Web Worker支持（暂时禁用）
            DEBOUNCE_DELAY: 300         // 防抖延迟
        };
        
        // 缓存管理器
        const CacheManager = {
            cache: new Map(),
            
            get: function(key) {
                return this.cache.get(key);
            },
            
            set: function(key, value, ttl = 300000) { // 默认5分钟TTL
                const item = {
                    value,
                    timestamp: Date.now(),
                    ttl
                };
                this.cache.set(key, item);
                
                // 清理过期缓存
                this.cleanup();
            },
            
            has: function(key) {
                const item = this.cache.get(key);
                if (!item) return false;
                
                if (Date.now() - item.timestamp > item.ttl) {
                    this.cache.delete(key);
                    return false;
                }
                return true;
            },
            
            cleanup: function() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now - item.timestamp > item.ttl) {
                        this.cache.delete(key);
                    }
                }
            },
            
            clear: function() {
                this.cache.clear();
            }
        };
        
        // 数据处理工具类
        const DataUtils = {
            // 通用数据过滤器
            filterData: function(data, filters = {}) {
                return data.filter(item => {
                    // 日期过滤
                    if (filters.dates && filters.dates.length > 0) {
                        if (!filters.dates.includes(item.date)) return false;
                    }
                    
                    // 计量点过滤
                    if (filters.meteringPoints && filters.meteringPoints.length > 0) {
                        // 与下拉选项和分组逻辑保持一致：将空值统一映射为『默认计量点』
                        const rawMp = item.meteringPoint;
                        const mpValue = (rawMp === undefined || rawMp === null || String(rawMp).trim() === '')
                            ? '默认计量点'
                            : String(rawMp).trim();
                        if (!filters.meteringPoints.includes(mpValue)) return false;
                    }
                    
                    // 自定义过滤器
                    if (filters.custom && typeof filters.custom === 'function') {
                        if (!filters.custom(item)) return false;
                    }
                    
                    return true;
                });
            },
            
            // 数据分组工具
            groupBy: function(data, keyFn) {
                const groups = new Map();
                data.forEach(item => {
                    const key = keyFn(item);
                    if (!groups.has(key)) {
                        groups.set(key, []);
                    }
                    groups.get(key).push(item);
                });
                return groups;
            },
            
            // 数据聚合工具
            aggregate: function(data, aggregateFn) {
                if (!data || data.length === 0) return null;
                return aggregateFn(data);
            },
            
            // 数据清洗工具
            cleanData: function(data, options = {}) {
                const { fillMethod = 'ignore' } = options;
                
                return data.map((value, index, array) => {
                    if (value === null || value === undefined || value === '' || isNaN(value)) {
                        if (fillMethod === 'ignore') {
                            return null;
                        } else if (fillMethod === 'interpolate') {
                            // 用相邻数据填充
                            let prevValue = null;
                            for (let i = index - 1; i >= 0; i--) {
                                if (array[i] !== null && !isNaN(array[i])) {
                                    prevValue = parseFloat(array[i]);
                                    break;
                                }
                            }
                            
                            let nextValue = null;
                            for (let i = index + 1; i < array.length; i++) {
                                if (array[i] !== null && !isNaN(array[i])) {
                                    nextValue = parseFloat(array[i]);
                                    break;
                                }
                            }
                            
                            if (prevValue !== null && nextValue !== null) {
                                return (prevValue + nextValue) / 2;
                            } else if (prevValue !== null) {
                                return prevValue;
                            } else if (nextValue !== null) {
                                return nextValue;
                            } else {
                                return null;
                            }
                        }
                        return null;
                    }
                    return parseFloat(value);
                });
            },
            
            // 数据验证工具
            validateData: function(data, rules = {}) {
                const errors = [];
                
                if (rules.required && (!data || data.length === 0)) {
                    errors.push('数据不能为空');
                }
                
                if (rules.minLength && data.length < rules.minLength) {
                    errors.push(`数据长度不能少于${rules.minLength}`);
                }
                
                if (rules.maxLength && data.length > rules.maxLength) {
                    errors.push(`数据长度不能超过${rules.maxLength}`);
                }
                
                return { isValid: errors.length === 0, errors };
            },
            
            // 批处理工具
            processBatch: function(data, processFn, batchSize = PERFORMANCE_CONFIG.BATCH_SIZE) {
                const results = [];
                
                for (let i = 0; i < data.length; i += batchSize) {
                    const batch = data.slice(i, i + batchSize);
                    const batchResult = processFn(batch);
                    
                    if (Array.isArray(batchResult)) {
                        results.push(...batchResult);
                    } else {
                        results.push(batchResult);
                    }
                    
                    // 让出控制权，避免阻塞UI
                    if (i + batchSize < data.length) {
                        setTimeout(() => {}, 0);
                    }
                }
                
                return results;
            },
            
            // 缓存装饰器
            withCache: function(fn, keyGenerator) {
                return function(...args) {
                    if (!PERFORMANCE_CONFIG.CACHE_ENABLED) {
                        return fn.apply(this, args);
                    }
                    
                    const cacheKey = keyGenerator ? keyGenerator(...args) : JSON.stringify(args);
                    
                    if (CacheManager.has(cacheKey)) {
                        return CacheManager.get(cacheKey).value;
                    }
                    
                    const result = fn.apply(this, args);
                    CacheManager.set(cacheKey, result);
                    
                    return result;
                };
            },
            
            // 防抖工具
            debounce: function(fn, delay = PERFORMANCE_CONFIG.DEBOUNCE_DELAY) {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => fn.apply(this, args), delay);
                };
            },
            
            // 优化的forEach（支持早期退出）
            fastForEach: function(array, callback, breakCondition) {
                for (let i = 0; i < array.length; i++) {
                    const result = callback(array[i], i, array);
                    if (breakCondition && breakCondition(result, i)) {
                        break;
                    }
                }
            },
            
            // 内存友好的大数组处理
            processLargeArray: function(array, processFn, options = {}) {
                const { 
                    batchSize = PERFORMANCE_CONFIG.BATCH_SIZE,
                    onProgress = null,
                    onComplete = null 
                } = options;
                
                let processedCount = 0;
                const totalCount = array.length;
                const results = [];
                
                const processBatch = (startIndex) => {
                    const endIndex = Math.min(startIndex + batchSize, totalCount);
                    const batch = array.slice(startIndex, endIndex);
                    
                    const batchResults = batch.map(processFn);
                    results.push(...batchResults);
                    
                    processedCount += batch.length;
                    
                    if (onProgress) {
                        onProgress(processedCount, totalCount);
                    }
                    
                    if (endIndex < totalCount) {
                        // 使用 requestAnimationFrame 或 setTimeout 来避免阻塞
                        if (window.requestAnimationFrame) {
                            requestAnimationFrame(() => processBatch(endIndex));
                        } else {
                            setTimeout(() => processBatch(endIndex), 0);
                        }
                    } else if (onComplete) {
                        onComplete(results);
                    }
                };
                
                processBatch(0);
                return results;
            }
        };
        
        // 辅助函数：获取颜色
        function getColor(index) {
            const colors = [
                '#6366F1',   // 现代靛蓝色
                '#8B5CF6',   // 现代紫罗兰色
                '#EC4899',   // 现代粉红色
                '#10B981',   // 现代翠绿色
                '#F59E0B',   // 现代琥珀色
                '#EF4444',   // 现代红色
                '#06B6D4',   // 现代青色
                '#F97316',   // 现代橙色
                '#84CC16',   // 现代酸橙绿
                '#A855F7'    // 现代紫色
            ];
            
            return colors[index % colors.length];
        }
        
        // 辅助函数：获取颜色数量
        function getColorCount() {
            return 10; // 颜色数组中的颜色数量
        }



// 启动应用
document.addEventListener('DOMContentLoaded', initApp);

// 可折叠面板功能
document.addEventListener('DOMContentLoaded', function() {
    const togglePanels = document.querySelectorAll('.toggle-panel');
    
    togglePanels.forEach(panel => {
        panel.addEventListener('click', function() {
            const panelId = this.getAttribute('data-panel');
            if (panelId === 'preview') return; // 预览卡片固定显示，忽略折叠
            const contentPanel = document.getElementById(`${panelId}-panel`);
            const icon = this.querySelector('.fa-chevron-down');
            
            if (contentPanel.style.display === 'none') {
                contentPanel.style.display = 'block';
                if (icon) icon.style.transform = 'rotate(0deg)';
            } else {
                contentPanel.style.display = 'none';
                if (icon) icon.style.transform = 'rotate(-90deg)';
            }
        });
    });
    
    // 根据指定要求设置卡片默认状态
    togglePanels.forEach(panel => {
        const panelId = panel.getAttribute('data-panel');
        const contentPanel = document.getElementById(`${panelId}-panel`);
        const icon = panel.querySelector('.fa-chevron-down');
        
        // 设置面板默认状态 - 仅预览卡片默认打开
                    const openPanels = ['preview'];
                    const closePanels = ['dataType', 'dataStructure', 'date', 'columns', 'advanced', 'filter', 'settings', 'config'];
        
        if (openPanels.includes(panelId)) {
            contentPanel.style.display = 'block';
            if (panelId !== 'preview' && icon) icon.style.transform = 'rotate(0deg)';
        } else {
            contentPanel.style.display = 'none';
            if (icon) icon.style.transform = 'rotate(-90deg)';
        }
    });
});

        // 时段统计对比窗口功能
        let timeSlotComparisonDragging = false;
        let timeSlotComparisonDragOffset = { x: 0, y: 0 };
        let timeSlotComparisonMinimized = false;

        // 显示时段统计对比窗口
        window.showTimeSlotComparison = function() {
            const window = document.getElementById('timeSlotComparisonWindow');
            if (window && window.parentNode) {
                window.classList.remove('hidden');
            }
            updateTimeSlotComparison();
            
            // 添加拖动事件监听
            setupTimeSlotComparisonDrag();
        }

        // 关闭时段统计对比窗口
        window.closeTimeSlotComparison = function() {
            const window = document.getElementById('timeSlotComparisonWindow');
            if (window && window.parentNode) {
                window.classList.add('hidden');
            }
        }

        // 最小化/恢复时段统计对比窗口
        window.toggleTimeSlotComparisonMinimize = function() {
            const content = document.getElementById('timeSlotComparisonContent');
            const minimizeBtn = document.getElementById('minimizeTimeSlotComparison');
            
            if (timeSlotComparisonMinimized) {
                content.style.display = 'block';
                minimizeBtn.innerHTML = '<i class="fa fa-window-minimize"></i>';
                timeSlotComparisonMinimized = false;
            } else {
                content.style.display = 'none';
                minimizeBtn.innerHTML = '<i class="fa fa-window-maximize"></i>';
                timeSlotComparisonMinimized = true;
            }
        }

        // 设置拖动功能
        function setupTimeSlotComparisonDrag() {
            const header = document.getElementById('timeSlotComparisonHeader');
            const window = document.getElementById('timeSlotComparisonWindow');

            header.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'I') return;
                
                timeSlotComparisonDragging = true;
                const rect = window.getBoundingClientRect();
                timeSlotComparisonDragOffset.x = e.clientX - rect.left;
                timeSlotComparisonDragOffset.y = e.clientY - rect.top;
                
                document.addEventListener('mousemove', timeSlotComparisonMouseMove);
                document.addEventListener('mouseup', timeSlotComparisonMouseUp);
            });
        }

        function timeSlotComparisonMouseMove(e) {
            if (!timeSlotComparisonDragging) return;
            
            const window = document.getElementById('timeSlotComparisonWindow');
            const newX = e.clientX - timeSlotComparisonDragOffset.x;
            const newY = e.clientY - timeSlotComparisonDragOffset.y;
            
            // 确保窗口不超出屏幕边界
            const maxX = window.innerWidth - window.offsetWidth;
            const maxY = window.innerHeight - window.offsetHeight;
            
            window.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
            window.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
        }

        function timeSlotComparisonMouseUp() {
            timeSlotComparisonDragging = false;
            document.removeEventListener('mousemove', timeSlotComparisonMouseMove);
            document.removeEventListener('mouseup', timeSlotComparisonMouseUp);
        }

        // 更新时段统计对比数据
        window.updateTimeSlotComparison = function() {
            const startHour = parseInt(document.getElementById('timeSlotStart').value);
            const endHour = parseInt(document.getElementById('timeSlotEnd').value);
            
            if (startHour > endHour) {
                showNotification('提示', '开始时段不能大于结束时段', 'warning');
                return;
            }

            const filteredData = getFilteredData();
            if (filteredData.length === 0) {
                document.getElementById('timeSlotComparisonTableBody').innerHTML = '<tr><td colspan="6" class="border border-gray-200 p-2 text-center text-gray-500 text-sm">暂无数据</td></tr>';
                return;
            }

            // 定义颜色数组
            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4', '#F97316', '#84CC16',
                '#EC4899', '#6366F1', '#14B8A6', '#F43F5E', '#A855F7', '#0EA5E9', '#EAB308', '#22C55E',
                '#D946EF', '#F87171', '#34D399', '#60A5FA', '#FBBF24', '#A78BFA', '#FB923C', '#67E8F9', '#FDA4AF'
            ];

            let totalPeriodEnergy = 0;
            let maxEnergy = 0;
            let minEnergy = Infinity;
            const periodData = [];
            let periodHours = endHour - startHour + 1;

            // 计算每个日期在指定时段的用电量
            filteredData.forEach(row => {
                let periodEnergy = 0;
                let validHours = 0;
                
                for (let hour = startHour; hour <= endHour; hour++) {
                    if (row.hourlyData[hour] !== null && row.hourlyData[hour] !== undefined) {
                        periodEnergy += row.hourlyData[hour];
                        validHours++;
                    }
                }
                
                if (validHours > 0) {
                    periodData.push({
                        date: row.date,
                        energy: periodEnergy,
                        totalEnergy: row.dailyTotal || 0,
                        hourlyAverage: validHours > 0 ? periodEnergy / validHours : 0
                    });
                    
                    totalPeriodEnergy += periodEnergy;
                    maxEnergy = Math.max(maxEnergy, periodEnergy);
                    minEnergy = Math.min(minEnergy, periodEnergy);
                }
            });

            // 计算汇总统计
            const avgEnergy = periodData.length > 0 ? totalPeriodEnergy / periodData.length : 0;
            const totalDailyEnergy = periodData.reduce((sum, item) => sum + item.totalEnergy, 0);
            const overallPercentage = totalDailyEnergy > 0 ? (totalPeriodEnergy / totalDailyEnergy) * 100 : 0;
            const avgHourlyOverall = totalDailyEnergy > 0 ? totalDailyEnergy / (periodData.length * 24) : 0;
            const avgHourlyInPeriod = totalPeriodEnergy > 0 ? totalPeriodEnergy / (periodData.length * periodHours) : 0;

            // 更新汇总卡片
            document.getElementById('timeSlotTotal').textContent = totalPeriodEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotAvg').textContent = avgEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotMax').textContent = maxEnergy.toFixed(2) + ' kWh';
            document.getElementById('timeSlotMin').textContent = minEnergy === Infinity ? '0.00 kWh' : minEnergy.toFixed(2) + ' kWh';

            // 添加新的汇总信息
            const summaryHtml = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                        <div class="text-green-700 text-sm font-medium">占全天比例</div>
                        <div class="text-green-900 text-lg font-bold">${overallPercentage.toFixed(1)}%</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <div class="text-purple-700 text-sm font-medium">时段平均小时</div>
                        <div class="text-purple-900 text-lg font-bold">${avgHourlyInPeriod.toFixed(2)} kWh</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
                        <div class="text-orange-700 text-sm font-medium">用电量最大日</div>
                        <div class="text-orange-900 text-lg font-bold">${(periodData.sort((a,b)=>b.energy-a.energy)[0]?.date) || '-'}：${(periodData.length?Math.max(...periodData.map(p=>p.energy)).toFixed(2):'0.00')} kWh</div>
                    </div>
                    <div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                        <div class="text-amber-700 text-sm font-medium">用电量最小日</div>
                        <div class="text-amber-900 text-lg font-bold">${(periodData.sort((a,b)=>a.energy-b.energy)[0]?.date) || '-'}：${(periodData.length?Math.min(...periodData.map(p=>p.energy)).toFixed(2):'0.00')} kWh</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <div class="text-blue-700 text-sm font-medium">分析天数</div>
                        <div class="text-blue-900 text-lg font-bold">${periodData.length}天</div>
                    </div>
                </div>
            `;
            
            const timeSlotSummary = document.getElementById('timeSlotSummary');
            const existingSummary = timeSlotSummary.querySelector('.grid');
            if (existingSummary) existingSummary.remove();
            timeSlotSummary.insertAdjacentHTML('beforeend', summaryHtml);

            // 更新表格 - 添加更多列
            const tbody = document.getElementById('timeSlotComparisonTableBody');
            tbody.innerHTML = '';

            periodData.forEach((item, index) => {
                const dailyPercentage = item.totalEnergy > 0 ? ((item.energy / item.totalEnergy) * 100).toFixed(1) : 0;
                const comparison = index > 0 ? 
                    ((item.energy - periodData[0].energy) / periodData[0].energy * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-200 p-2 text-center" style="color: ${colors[index % colors.length]}">${item.date}</td>
                    <td class="border border-gray-200 p-2 text-center">${item.energy.toFixed(2)}</td>
                    <td class="border border-gray-200 p-2 text-center">${dailyPercentage}%</td>
                    <td class="border border-gray-200 p-2 text-center">${item.hourlyAverage.toFixed(2)}</td>
                    <td class="border border-gray-200 p-2 text-center">${item.totalEnergy.toFixed(2)}</td>
                    <td class="border border-gray-200 p-2 text-center font-semibold ${comparison >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${comparison >= 0 ? '+' : ''}${comparison}%
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 更新表格标题
            const thead = document.querySelector('#timeSlotComparisonTable thead tr');
            if (thead) {
                thead.innerHTML = `
                    <th class="border border-gray-200 p-2 text-center font-medium">日期</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">时段用电量 (kWh)</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">占全天比例</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">时段平均小时 (kWh)</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">日总用电量 (kWh)</th>
                    <th class="border border-gray-200 p-2 text-center font-medium">对比首日 (%)</th>
                `;
            }
        }

        // 添加时段统计对比按钮到界面
        setTimeout(() => {
            const controlPanel = document.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200');
            if (controlPanel) {
                const timeSlotBtn = document.createElement('button');
                timeSlotBtn.innerHTML = '<i class="fa fa-clock mr-1"></i> 时段统计';
                timeSlotBtn.className = 'bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary/90 ml-2';
                timeSlotBtn.onclick = showTimeSlotComparison;
                controlPanel.appendChild(timeSlotBtn);
            }

            // 添加事件监听
            document.getElementById('closeTimeSlotComparison').addEventListener('click', closeTimeSlotComparison);
            document.getElementById('timeSlotStart').addEventListener('change', updateTimeSlotComparison);
            document.getElementById('timeSlotEnd').addEventListener('change', updateTimeSlotComparison);
        }, 1000);

        // 作者信息弹窗功能
        document.addEventListener('DOMContentLoaded', function() {
            const authorModal = document.getElementById('authorInfoModal');
            const startBtn = document.getElementById('startUsingBtn');
            const passwordSection = document.getElementById('passwordSection');
            const authorSection = document.getElementById('authorSection');
            const passwordInput = document.getElementById('accessPassword');
            const verifyBtn = document.getElementById('verifyPasswordBtn');
            const passwordError = document.getElementById('passwordError');
            
            // 验证系统（多重加密保护）
            const _0x1a2b = ['102', '119', '109', '49', '57', '57', '57'];
            const _0x3c4d = _0x1a2b.map(x => String.fromCharCode(parseInt(x)));
            const _0x5e6f = btoa(_0x3c4d.join(''));
            const _0x7g8h = _0x5e6f.split('').reverse().join('');
            const ACCESS_PASSWORD = atob(_0x7g8h.split('').reverse().join(''));
            
            // 检查是否已验证密码
            const isPasswordVerified = sessionStorage.getItem('passwordVerified');
            const hasVisited = sessionStorage.getItem('hasVisited');
            
            if (!hasVisited || !isPasswordVerified) {
                // 首次访问或未验证密码，显示作者信息弹窗
                setTimeout(() => {
                    authorModal.style.display = 'flex';
                    // 如果已验证密码，直接显示作者信息
                    if (isPasswordVerified) {
                        showAuthorInfo();
                    }
                }, 500);
            } else {
                // 已访问过且已验证，直接隐藏弹窗
                authorModal.style.display = 'none';
            }
            
            // 密码验证函数
            function verifyPassword() {
                const inputPassword = passwordInput.value.trim();
                
                if (inputPassword === ACCESS_PASSWORD) {
                    // 密码正确
                    sessionStorage.setItem('passwordVerified', 'true');
                    passwordError.classList.add('hidden');
                    showAuthorInfo();
                    
                    // 显示成功提示
                    showNotification('验证成功', '密码验证成功，欢迎使用！', 'success');
                } else {
                    // 密码错误
                    passwordError.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                    
                    // 添加错误动画
                    passwordInput.classList.add('animate-pulse');
                    setTimeout(() => {
                        passwordInput.classList.remove('animate-pulse');
                    }, 1000);
                }
            }
            
            // 显示作者信息
            function showAuthorInfo() {
                passwordSection.classList.add('hidden');
                authorSection.classList.remove('hidden');
                
                // 更新图标
                const icon = authorModal.querySelector('.fa-lock');
                if (icon) {
                    icon.className = 'fa fa-user text-white text-3xl';
                }
            }
            
            // 密码验证按钮点击事件
            verifyBtn.addEventListener('click', verifyPassword);
            
            // 密码输入框回车事件
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
            
            // 点击开始使用按钮
            startBtn.addEventListener('click', function() {
                // 标记为已访问
                sessionStorage.setItem('hasVisited', 'true');
                
                // 隐藏弹窗动画
                authorModal.style.transition = 'opacity 0.3s ease';
                authorModal.style.opacity = '0';
                setTimeout(() => {
                    authorModal.style.display = 'none';
                }, 300);
                
                // 显示欢迎通知
                showNotification('欢迎使用', '欢迎使用负荷曲线分析工具！', 'success');
            });
            
            // ESC键关闭弹窗（仅在已验证密码后生效）
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && authorModal.style.display === 'flex' && !authorSection.classList.contains('hidden')) {
                    sessionStorage.setItem('hasVisited', 'true');
                    authorModal.style.display = 'none';
                }
            });
            
            // 点击背景关闭弹窗（仅在已验证密码后生效）
            authorModal.addEventListener('click', function(e) {
                if (e.target === authorModal && !authorSection.classList.contains('hidden')) {
                    sessionStorage.setItem('hasVisited', 'true');
                    authorModal.style.display = 'none';
                }
            });
        });

        // 移除清除验证缓存的功能，因为不再需要
        // 注释掉原有的清除缓存功能
        /*
        function clearAccessCache() {
            localStorage.removeItem('invitationCode');
            location.reload();
        }

        // 添加一个隐藏的管理功能（按Ctrl+Shift+A）
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                clearAccessCache();
            }
        });
        */
    </script>
    


    <!-- 使用说明面板交互 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const helpBtn = document.getElementById('helpBtn');
            const helpPanel = document.getElementById('helpPanel');
            const closeHelpBtn = document.getElementById('closeHelpBtn');
            const aboutBtn = document.getElementById('aboutBtn');

            // 打开使用说明面板
            helpBtn.addEventListener('click', function() {
                if (helpPanel && helpPanel.parentNode) {
                    helpPanel.classList.remove('hidden');
                }
                document.body.style.overflow = 'hidden'; // 防止背景滚动
            });

            // 关闭使用说明面板
            function closeHelpPanel() {
                if (helpPanel && helpPanel.parentNode) {
                    helpPanel.classList.add('hidden');
                }
                document.body.style.overflow = ''; // 恢复背景滚动
            }

            closeHelpBtn.addEventListener('click', closeHelpPanel);
            
            // 点击背景关闭面板
            helpPanel.addEventListener('click', function(e) {
                if (e.target === helpPanel) {
                    closeHelpPanel();
                }
            });

            // ESC键关闭面板
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !helpPanel.classList.contains('hidden')) {
                    closeHelpPanel();
                }
            });

            // 关于按钮点击事件
            aboutBtn.addEventListener('click', function() {
                showAboutModal();
            });

            // 添加键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+H 打开帮助
                if (e.ctrlKey && e.shiftKey && e.key === 'H') {
                    e.preventDefault();
                    if (helpPanel && helpPanel.parentNode) {
                        helpPanel.classList.remove('hidden');
                    }
                    document.body.style.overflow = 'hidden';
                }
            });

            // 添加平滑滚动效果
            const helpContent = helpPanel.querySelector('.max-h-screen');
            if (helpContent) {
                helpContent.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                });
            }
        });
    </script>
    
    <!-- 作者信息 -->
    <footer class="bg-white border-t border-gray-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">关于本工具</h3>
                    <p class="text-gray-600 text-sm">
                        <i class="fa fa-user mr-1"></i>
                        <strong>作者：冯伟明</strong>
                    </p>
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fa fa-weixin mr-1 text-green-500"></i>
                        微信联系方式：<strong>Call13345934750</strong>
                    </p>
                    <p class="text-gray-600 text-sm mt-1">
                        <i class="fa fa-comments mr-1 text-green-500"></i>
                        <strong>公众号：</strong>能源小鲨鱼
                    </p>
                </div>
                
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-md max-w-md mx-auto">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fa fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>重要提醒：</strong>该版本为初始版本，可能存在BUG，有问题请联系我
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 text-xs text-gray-500">
                    <p>© 2025 负荷曲线分析工具 - 专为电力数据分析设计</p>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- 原始数据与PVsyst数据对比预览功能 -->
    <script>
        // 平滑滚动跳转函数
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                // 先显示目标section，隐藏其他section
                const allSections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
                allSections.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) {
                        if (id === sectionId) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    }
                });
                
                // 如果跳转到可视化区域，触发图表更新
                if (sectionId === 'visualizationSection') {
                    // 延迟执行图表更新，确保DOM已完全渲染
                    setTimeout(() => {
                        console.log('跳转到可视化区域，触发图表更新');
                        
                        // 确保有数据时再更新图表
                        if (appData.processedData && appData.processedData.length > 0) {
                            // 更新折线图
                            if (typeof updateChart === 'function') {
                                updateChart();
                            }
                            
                            // 更新柱状图
                            if (typeof updateDailyTotalBarChart === 'function') {
                                updateDailyTotalBarChart(getFilteredData());
                            }
                            
                            // 确保柱状图容器可见
                            const barChartContainer = document.getElementById('dailyTotalBarChartContainer');
                            if (barChartContainer) {
                                barChartContainer.style.display = 'block';
                            }
                        } else {
                            console.warn('没有可显示的数据');
                        }
                    }, 200);
                }
                
                // 等待DOM更新后再计算位置
                setTimeout(() => {
                    // 计算滚动位置，考虑固定导航栏的偏移
                    const offset = 80; // 导航栏高度 + 一些间距
                    const elementPosition = element.offsetTop - offset;
                    
                    // 平滑滚动到目标位置
                    window.scrollTo({
                        top: elementPosition,
                        behavior: 'smooth'
                    });
                    
                    // 添加高亮效果
                    element.style.transition = 'all 0.3s ease';
                    element.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.5)';
                    element.style.transform = 'scale(1.02)';
                    
                    // 2秒后移除高亮效果
                    setTimeout(() => {
                        element.style.boxShadow = '';
                        element.style.transform = 'scale(1)';
                    }, 2000);
                }, 50);
            }
            
            // 更新步骤导航状态（延迟执行，避免与滚动监听冲突）
            setTimeout(() => {
                updateStepNavigation(sectionId);
            }, 150);
        }

        // 更新步骤导航状态
        function updateStepNavigation(activeSection) {
            const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
            const currentIndex = sections.indexOf(activeSection);
            
            // 更新所有步骤卡片状态
            sections.forEach((section, index) => {
                const card = document.getElementById(`stepCard${index + 1}`);
                if (!card) return; // 如果卡片不存在，跳过
                
                const icon = card.querySelector('.nav-icon');
                const label = card.querySelector('.nav-label');
                
                if (!icon || !label) return; // 如果子元素不存在，跳过
                
                if (index === currentIndex) {
                    // 当前激活步骤
                    card.className = 'nav-icon-card active';
                    icon.className = 'nav-icon active';
                } else {
                    // 其他所有步骤都保持默认状态
                    card.className = 'nav-icon-card';
                    icon.className = 'nav-icon';
                }
            });
        }

        // 标记步骤为完成
        function completeStep(stepNumber) {
            const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
            if (stepNumber > 0 && stepNumber <= sections.length) {
                updateStepNavigation(sections[stepNumber - 1]);
            }
        }

        // 原始数据与PVsyst数据对比预览函数
        function updateComparisonPreview() {
            if (appData.processedData.length === 0) {
                elements.dataPreview.innerHTML = '<p class="text-neutral text-center py-4">没有可对比的数据，请先完成数据配置</p>';
                return;
            }
            
            // 解析数据
            parseWorksheetData();
            
            if (appData.processedData.length === 0) {
                elements.dataPreview.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 px-8">
                <div class="w-16 h-16 mb-6 bg-gradient-to-br from-amber-100 to-orange-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">暂无数据</h3>
                <p class="text-sm text-slate-500 text-center max-w-md leading-relaxed">当前配置下没有找到可预览的数据，请检查数据源或调整配置参数</p>
            </div>
        `;
                return;
            }
            
            // 获取数据结构类型
            const dataStructure = document.querySelector('input[name="dataStructure"]:checked').value;
            
            // 创建基于月和日的数据映射（忽略年份，年份固定为99）
            const dateDataMap = new Map();
            
            // 按日期排序，确保数据按时间顺序处理
            const sortedExportData = [...appData.processedData].sort((a, b) => {
                const dateA = a.dateObj || parseDate(a.date);
                const dateB = b.dateObj || parseDate(b.date);
                return (dateA ? dateA.getTime() : 0) - (dateB ? dateB.getTime() : 0);
            });
            
            // 使用排序后的数据构建映射，确保按时间顺序处理
            sortedExportData.forEach(dateData => {
                const date = dateData.dateObj || parseDate(dateData.date);
                if (!date) return;
                const monthDayKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // 确保hourlyData是24个元素的数组
                if (dateData.hourlyData && Array.isArray(dateData.hourlyData) && dateData.hourlyData.length === 24) {
                    dateDataMap.set(monthDayKey, dateData.hourlyData);
                } else {
                    dateDataMap.set(monthDayKey, Array(24).fill(0));
                }
            });
            
            // 生成对比预览表格
            let previewHtml = `<div class="bg-purple-50 p-3 mb-3 text-sm font-medium rounded-lg shadow-sm">原始数据与PVsyst数据对比预览</div>`;
            
            // 创建统一的表格样式，支持完整数据展示
            previewHtml += '<div class="overflow-x-auto border border-gray-200 rounded-xl shadow-sm max-h-96 overflow-y-auto bg-white">';
            previewHtml += '<table class="w-full text-sm table-fixed" style="font-family: system-ui, -apple-system, sans-serif;">';
            previewHtml += '<thead><tr class="bg-gray-100 text-gray-800">';
            previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold" style="width: 120px;">日期</th>';
            previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">数据类型</th>';
            
            // 统一显示24小时数据（列对行和列对列结构都显示24小时）
            for (let hour = 0; hour < 24; hour++) {
                previewHtml += `<th class="border border-gray-300 px-3 py-2 text-center font-semibold">${hour}:00</th>`;
            }
            previewHtml += '<th class="border border-gray-300 px-3 py-2 text-center font-semibold">日总电能 (kWh)</th>';
            previewHtml += '</tr></thead><tbody class="divide-y divide-gray-200">';
            
            // 添加数据行 - 显示原始数据和PVsyst数据的对比
            const displayRows = Math.min(appData.processedData.length, 5); // 限制显示5天的数据对比
            
            for (let i = 0; i < displayRows; i++) {
                const row = appData.processedData[i];
                const date = row.dateObj || parseDate(row.date);
                if (!date) return;
                const monthDayKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                // 原始数据行
                previewHtml += `<tr class="bg-white hover:bg-gray-100 transition-colors">`;
                previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium" rowspan="2">${row.date}</td>`;
                previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium text-blue-600">原始数据</td>`;
                
                let originalDayTotal = 0;
                for (let hour = 0; hour < 24; hour++) {
                        const value = row.hourlyData[hour];
                        if (value !== null && value !== undefined) {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                            originalDayTotal += value;
                        } else {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                        }
                    }
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-semibold text-blue-600">${originalDayTotal.toFixed(2)}</td>`;
                    previewHtml += '</tr>';
                    
                    // PVsyst数据行
                    previewHtml += `<tr class="bg-gray-50 hover:bg-gray-100 transition-colors">`;
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium text-purple-600">PVsyst数据</td>`;
                    
                    // 获取PVsyst数据
                    if (dateDataMap.has(monthDayKey)) {
                        pvsystData = [...dateDataMap.get(monthDayKey)];
                    } else {
                        // 如果没有匹配的数据，使用findNearbyData函数查找相近数据
                        const nearbyKey = findNearbyData(date.getMonth() + 1, date.getDate(), dateDataMap);
                        if (nearbyKey && dateDataMap.has(nearbyKey)) {
                            const originalData = dateDataMap.get(nearbyKey);
                            const variationFactor = 0.05; // 5%的变化范围
                            pvsystData = originalData.map(value => {
                                // 添加随机变化，但保持数据的基本模式
                                const variation = 1 + (Math.random() - 0.5) * 2 * variationFactor;
                                return value * variation;
                            });
                        } else {
                            // 如果找不到相近数据，使用原始数据
                            pvsystData = [...row.hourlyData];
                        }
                    }
                    
                    let pvsystDayTotal = 0;
                    for (let hour = 0; hour < 24; hour++) {
                        const value = pvsystData[hour];
                        if (value !== null && value !== undefined) {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                            pvsystDayTotal += value;
                        } else {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                        }
                    }
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-semibold text-purple-600">${pvsystDayTotal.toFixed(2)}</td>`;
                    previewHtml += '</tr>';
                    
                    // PVsyst数据行
                    previewHtml += `<tr class="bg-gray-50 hover:bg-gray-100 transition-colors">`;
                    previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center font-medium text-purple-600">PVsyst数据</td>`;
                    
                    // 获取PVsyst数据
                    let pvsystData;
                    if (dateDataMap.has(monthDayKey)) {
                        pvsystData = [...dateDataMap.get(monthDayKey)];
                    } else {
                        // 如果没有匹配的数据，使用findNearbyData函数查找相近数据
                        const nearbyKey = findNearbyData(date.getMonth() + 1, date.getDate(), dateDataMap);
                        if (nearbyKey && dateDataMap.has(nearbyKey)) {
                            const originalData = dateDataMap.get(nearbyKey);
                            const variationFactor = 0.05; // 5%的变化范围
                            pvsystData = originalData.map(value => {
                                // 添加随机变化，但保持数据的基本模式
                                const variation = 1 + (Math.random() - 0.5) * 2 * variationFactor;
                                return value * variation;
                            });
                        } else {
                            // 如果找不到相近数据，使用原始数据
                            pvsystData = [...row.hourlyData];
                        }
                    }
                    
                    for (let hour = 0; hour < 24; hour++) {
                        const value = pvsystData[hour];
                        if (value !== null && value !== undefined) {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center">${value.toFixed(2)}</td>`;
                        } else {
                            previewHtml += `<td class="border border-gray-300 px-3 py-2 text-center text-gray-400">-</td>`;
                        }
                    }
                    
                    previewHtml += '</tr>';
                }
            
            previewHtml += '</tbody></table></div>';
            
            // 添加数据统计信息
            previewHtml += `<div class="mt-2 text-sm text-gray-600 text-center bg-gray-50 p-2 rounded">
                显示前 ${Math.min(appData.processedData.length, 5)} 天的原始数据与PVsyst数据对比
            </div>`;
            
            elements.dataPreview.innerHTML = previewHtml;
        }
        
        // 24小时数据处理函数
        // 按日期和计量点分组数据
        function groupDataByDateAndMeteringPoint(data) {
            const groups = {};
            
            data.forEach(row => {
                const date = row.date;
                const meteringPoint = (row.meteringPoint === undefined || row.meteringPoint === null || String(row.meteringPoint).trim() === '') ? '默认计量点' : String(row.meteringPoint).trim();
                const key = `${date}_${meteringPoint}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        date: date,
                        meteringPoint: meteringPoint,
                        hourlyData: new Array(24).fill(null),
                        totalEnergy: 0
                    };
                }
                
                // 合并该日期该计量点的24小时数据
                for (let hour = 0; hour < 24; hour++) {
                    if (row.hourlyData[hour] !== null && row.hourlyData[hour] !== undefined) {
                        if (groups[key].hourlyData[hour] === null) {
                            groups[key].hourlyData[hour] = 0;
                        }
                        groups[key].hourlyData[hour] += row.hourlyData[hour];
                        groups[key].totalEnergy += row.hourlyData[hour];
                    }
                }
            });
            
            return groups;
        }
        
        // 创建24小时完整数据集
        function create24HourDatasets(groupedData) {
            const datasets = [];
            let colorIndex = 0;
            
            // 按日期排序
            const sortedKeys = Object.keys(groupedData).sort();
            
            sortedKeys.forEach(key => {
                const data = groupedData[key];
                const color = getColor(colorIndex % getColorCount());
                colorIndex++;
                
                // 确保24小时数据完整
                const complete24HourData = [];
                for (let hour = 0; hour < 24; hour++) {
                    complete24HourData.push(data.hourlyData[hour] || 0);
                }
                
                const dataset = {
                    label: `${data.date} (${data.meteringPoint})`,
                    data: complete24HourData,
                    borderColor: color,
                    backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.1)'),
                    borderWidth: appData.visualization.lineStyle === 'thick' ? 3 : appData.visualization.lineStyle === 'thin' ? 1 : 2,
                    borderDash: appData.visualization.lineStyle === 'dashed' ? [10, 5] : 
                               appData.visualization.lineStyle === 'dotted' ? [2, 2] : 
                               appData.visualization.lineStyle === 'dashdot' ? [10, 5, 2, 5] : [],
                    pointRadius: appData.visualization.showPoints ? 3 : 0,
                    pointHoverRadius: appData.visualization.showPoints ? 5 : 0,
                    tension: appData.visualization.smoothCurve ? appData.visualization.curveTension : 0,
                    fill: false,
                    spanGaps: true
                };
                
                datasets.push(dataset);
            });
            
            return datasets;
        }
        
        // 使用24小时数据集更新图表
        function updateChartWith24HourDatasets(datasets) {
            if (!appData.chart) {
                // 如果图表不存在，创建一个新的图表
                initEmptyChart();
            }
            
            // 24小时时间标签
            const hourLabels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
            
            // 更新图表数据
            appData.chart.data.labels = hourLabels;
            appData.chart.data.datasets = datasets;
            
            // 更新图表标题
            const selectedDates = appData.visualization.selectedDates;
            const selectedMeteringPoints = appData.visualization.selectedMeteringPoints;
            appData.chart.options.plugins.title.text = 
                `24小时负荷曲线 - ${selectedDates.length}个日期 × ${selectedMeteringPoints.length}个计量点`;
            
            // 更新图表配置 - 确保XY轴始终显示
            appData.chart.options.scales.x.display = true;
            appData.chart.options.scales.y.display = true;
            appData.chart.options.scales.x.title = {
                display: true,
                text: '时间 (小时)',
                font: { size: 14, weight: 'bold' }
            };
            appData.chart.options.scales.y.title = {
                display: true,
                text: '用电量 (kWh)',
                font: { size: 14, weight: 'bold' }
            };
            
            // 使用动画更新图表
            updateChartWithAnimation();
            
            // 隐藏加载状态
            const chartLoadingElement = document.getElementById('chartLoading');
            if (chartLoadingElement && chartLoadingElement.parentNode) {
                chartLoadingElement.classList.add('hidden');
            }
        }

        // 添加页面状态监听功能
        function initPageStateListener() {
            function checkCurrentSection() {
                const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
                let currentSection = null;
                
                // 检查哪个section当前显示（没有hidden类）
                for (const sectionId of sections) {
                    const section = document.getElementById(sectionId);
                    if (section && !section.classList.contains('hidden')) {
                        currentSection = sectionId;
                        break;
                    }
                }
                
                // 更新导航状态
                if (currentSection) {
                    updateStepNavigation(currentSection);
                }
            }
            
            // 使用MutationObserver监听DOM变化
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        // 当class属性变化时，检查当前显示的section
                        checkCurrentSection();
                    }
                });
            });
            
            // 监听所有section的class变化
            const sections = ['importSection', 'configSection', 'visualizationSection', 'exportSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    observer.observe(section, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }
            });
            
            // 初始检查
            checkCurrentSection();
        }
        
        // 页面加载完成后初始化页面状态监听
        document.addEventListener('DOMContentLoaded', function() {
            initPageStateListener();
            

        });

    </script>
</body></html>
